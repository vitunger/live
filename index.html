<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vit:bikes Partnerportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Open Sans', sans-serif;
        }
        
        /* vit:bikes Corporate Colors */
        :root {
            --vit-orange: #EF7D00;
            --vit-gray: #626062;
            --vit-black: #000000;
            --vit-white: #FFFFFF;
        }
        
        .bg-vit-orange { background-color: var(--vit-orange); }
        .bg-vit-gray { background-color: var(--vit-gray); }
        .text-vit-orange { color: var(--vit-orange); }
        .text-vit-gray { color: var(--vit-gray); }
        .border-vit-orange { border-color: var(--vit-orange); }
        .hover\:bg-vit-orange:hover { background-color: var(--vit-orange); }
        
        /* Corporate Font Styles */
        .h1-headline {
            font-weight: 700;
            font-size: 26px;
            line-height: 32px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--vit-black);
        }
        
        .h2-headline {
            font-weight: 400;
            font-size: 12px;
            line-height: 18px;
            text-transform: uppercase;
            position: relative;
            padding-bottom: 8px;
            display: inline-block;
        }
        
        .h2-headline::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -3mm;
            width: 15.5mm;
            height: 0.5pt;
            background-color: var(--vit-orange);
        }
        
        /* Gradient Backgrounds */
        .vit-gradient {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }
        
        /* Subtiler vit-Hintergrund fÃ¼r Main Content */
        .vit-background {
            position: relative;
        }
        
        .vit-background::before {
            content: '';
            position: fixed;
            top: 0;
            left: 256px; /* Sidebar width */
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            z-index: -1;
        }
        
        /* Card Styles */
        .vit-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .vit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 125, 0, 0.2);
        }
        
        /* vit-Logo Watermark auf Cards */
        .vit-card-watermark::before {
            content: 'vit';
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 120px;
            font-weight: 900;
            color: rgba(239, 125, 0, 0.03);
            pointer-events: none;
            font-style: italic;
        }
        
        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
        }
        
        .sidebar-item {
            transition: all 0.2s;
        }
        
        .sidebar-item:hover {
            background-color: rgba(239, 125, 0, 0.1);
            border-left: 3px solid var(--vit-orange);
        }
        
        .sidebar-item.active {
            background-color: rgba(239, 125, 0, 0.15);
            border-left: 3px solid var(--vit-orange);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new { 
            background-color: rgba(239, 125, 0, 0.15); 
            color: var(--vit-orange);
            border: 1px solid var(--vit-orange);
        }
        .status-inprogress { 
            background-color: var(--vit-orange); 
            color: white; 
        }
        .status-done { 
            background-color: var(--vit-gray); 
            color: white; 
        }
        
        /* Chat Styles */
        .chat-message {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .chat-message.sent {
            background-color: var(--vit-orange);
            color: white;
            margin-left: 20%;
        }
        
        .chat-message.received {
            background-color: #F3F4F6;
            margin-right: 20%;
        }
        
        /* Forum Styles */
        .forum-post {
            border-left: 3px solid var(--vit-orange);
            padding-left: 15px;
        }
        
        /* Corporate Bullets - Orangene Kreise */
        .vit-list {
            list-style: none;
            padding-left: 0;
        }
        
        .vit-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
        }
        
        .vit-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 7px;
            width: 8px;
            height: 8px;
            background-color: var(--vit-orange);
            border-radius: 50%;
        }
        
        /* Hide class for view switching - MUST override Tailwind */
        /* Premium Feature Locks */
        .premium-feature {
            position: relative;
        }
        
        .premium-feature.locked::after {
            content: 'ðŸ”’ Nur fÃ¼r vit:bikes Partner';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--vit-gray);
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #EF7D00 0%, #FF9500 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .beta-badge {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
            vertical-align: middle;
            display: inline-block;
            line-height: 14px;
        }
        .beta-badge-tab {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 0px 5px;
            border-radius: 6px;
            font-size: 7px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 3px;
            vertical-align: middle;
        }
        
        .locked-menu-item {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .locked-menu-item::after {
            content: 'ðŸ”’';
            margin-left: auto;
            font-size: 12px;
        }

        /* === MOBILE RESPONSIVE === */
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
        }
        #sidebarOverlay.active { display: block; }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px !important;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .topnav-desktop { display: none !important; }
            .topnav-mobile { display: flex !important; }
            .main-content-area {
                margin-left: 0 !important;
                padding: 16px !important;
            }
        }
        @media (min-width: 769px) {
            .topnav-mobile { display: none !important; }
            .topnav-desktop { display: flex !important; }
            #sidebarOverlay { display: none !important; }
        }

        /* Tab navigation scroll on mobile */
        nav.-mb-px {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        nav.-mb-px::-webkit-scrollbar { display: none; }

        /* Headline responsive */
        @media (max-width: 768px) {
            .h1-headline { font-size: 1.25rem !important; }
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center vit-background relative" style="display:flex;">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-block mb-6">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAABGCAYAAAAq7+rZAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAA+V0lEQVR42u19d3wc1bX/99w7M1ukVbeMsTGYjkwJGAh5KbIJNXSbFb05weQFCIGQnrDatJc8Elp+gcQPCOaBk2jpGDDwAha9iW4RwBBsZMtWb6stc+89vz9mRl7bkrUGkwDR+XwGCXl25s7sPd97zveUSy9cUHLXfttkj+vLaE0ESSBjyBYvrwulDl442MBNkNQAA4CxlYUTEJSEOe+zk3c476D0ZZWOmVcRyseIDABDH/S6hqErI0K+2hF6dP7VdYe/EG8xlIIO7ndjvOTUg3cyC6vtbEQzEwg0zvU46oA7hpz+G14t3funS3vaDECNCVBjI/hX88pnHL+9fmBa2fAuyhgQQPiIxRihK0uEfPQfzrKD/yd9MDMREQwmZEI+hIhFK0JnvtEdfrkySpIBTWBhkdJzdsjEm79R8itqgOYE5EcFBlccW73/9+r7n9i3dvic2pLhMiJNAH9ghWIGOxLozFj8/Jrwj1rQ4qYAJBIQAHD4PuU7HDhN3zC9JFeiDI0LBgAgAG1LKf7e4/w6ubSnzTRBEsCNM0FE4EOmqmt3n5zZ1TXG/DPAgAGOWAZrh6T7xJropQBxquGjv++E/BsAwu+W9gz8sSXS8E5/eKDUJqEYRhsjBzNaHTRFfe/W06suoCTUHxfA3ooTmgDgtAOryg7fKX3PjIrs1N5ho1xFviHywYwRAmBApsSR8u/d9g1fS/U+zU2QDSnoxpkgSsJ8e3+VnDnJDfdlWZEY3woxBqY0RPLv3fabh11ffTUnIKgBhuOQ1AC9+OSyhr0m5Q4fSGslsPWBc4wXqMMhKVu7Qtdcdl9XS/CME9N5Qj40IDxaD+uax7reXvqGfVJf3uaI5WmkYpJK5/XhO6Svui5eduh5C+E2xbfShG/yrIOvfSZ7WV2tmtI3DFcIWKAP55VoJo7ZoJWDVs8NrTU/4QRE43JwUxxSNED/8YSa/fbbxj01nWEjqLhnsQQ4YyS9tDZ8KbAyi1Z/Ja4Dz5o1JXrg1OwvJSnW7FkgHzkWMEzUgXy3x1pz87OVP+cEBBomXIUJ2UqAMKcZihOwLrh3YGlzW/ibUtrSArQgppzLVGbnxSE7uHecf1DlXg0p6A8LCk1xSMRhrjm6evfdq/WFmazSAKyt8TAENtKS4s1OK7moeeVazAQlkzDxuGdzHDB1+OrqqGvlmRk0vltiGDoWJvl6p/3g6Yv7lnATJKWg2Qe0/9pv8NKdqvVOQzkYQR89IDAAAWJBNrV2R36w6JWVfZgJoo+A35mQf0+RAJBshnlhAexDb8w98/npsW3rttEHZHOshITMKTJTS014eiW+3Dq4y02XL+vMAxDNzR9sEjY1QtCeML88lBftXJPffSgP3hrKZBi6LAzxVpfzxueuq/sax9uJktA+KarvPrOs4XPTc99O5zzydNzrARwWQE/eyd3xdsm8R9/KdNYBoi4Omn0+WD1VPuPInfO3OkJZypAg+idwBwxdESb5amf42fo/Dn4zeLaJaTwhW81CCH7ZfyEUN0Eeuegz5z++0nmiIkqWVkIJguwd1nrPybldrzp05S1EHpmGD0Cejfjdp8WO2nmS+cpghnWxpvu4pj0JZFyHHnkv/EOgxR0xGpaDT997ckldjXu5YMWGixs3MXQkLMXb3aFrfnRPT6v5awEXQeCjdnL/e1rMLcm4zP8UMDDChCWZ3pyFp1Y6lxCBU6mJCTwhHxEgAODG5WDmZv2z/4vNe6MzvKIiBEtp1kSQvUOsPjM5f9z9Z5dcRw3QLyzYYjOfUAfG5MklddXqmqhUrAwVrUiGwcxQox2GkYuFIZd32ksuuKvv7o1N+7MOSl8yoyo/fSjPeQLMWNcZuZ5BvjQEsarXbvvzG9v9LPDTA0C7+eTYZ3eflD9hMGPyBDAzF47FfHClH3tsjmUoEnLsl9ZGf3n+3b1PmRMniMQJ2fqygVInkzAzWyEffnddx21/n3z82Xuap2sj2ZK0IgPB1kDaVQfPoK+nTq14ff+Ffb9/NAFrThKqmBs9moCkJFTTqelL994mv+PAsFFCFAcqhsGltiTbYmvEXaYCx1rCau931EPvhC9lThMa1xOJ/xOvmbX/NkM/lZZBZYRCG3x2M9iV1Tae7Sj5/rXNrUO/r/XCjFwHPuOAbasP2LavqbKCJWeEJMHrx0GA0QKDOYMtJkgZpixEQlgQAAHMWP+ghHVDdvbp9vCvDvmf3p9yEwW5IRMyIR8dIABAQwraU/R1y3etip186A7mvpDIq7wh0oA0bl7N2YGu+sNJtX+fk+z4G8e91XhzN0kkIGYDJvGVSdscNL3vW3lXGwNIUSQYlDiC3uq2O3tzaIYxqpBEI4KOOSRf7Qw/edmD3W/+pNGzCprikAwAxuzZ1mf9+bV2NoJ4s7ckAgsCT4pavc932o+e8r/dd/j5Ejrh50187yhnWvcwPffU2/Jx1iQCxRcEMkYyQLvuOzU7y1VsUCQ3wkwmYlvirX75St8wL1caQhAbgFARoZ6ebOide94seeDyR9e86ScgTVgGE/KRyJhrJSdgURLqobMrLpqz/dBVw1mlDMEyBqYkDLEmHe69/a3aWd+5d9U/muKbN18D8qv5/NJFX5qaObN3WBfFHRhDpixE9M5A+I2z/lJ12DNtbas3v8iuZ9yb4pDxOhAVacGMQeIR0ZaRp0/+Z+TRg6ZmZw9keVzykgBoJl0ZJvliZ+j+WVcfeBzQrDbLwUy4CRPyz7QQRiZrEuqFBbD3X9h39dNfj+1x0Dbp83p9Mz+dhZ4ey1cePaPz3jt32+1zp9z25mChMhZKYLr/4ivlc+qqsmeks0YXk8DDAGzJPKxt0bwycuEzbW2r37oQoV2+CIXlowKZoaRnRjNAH0ZxOAEr1QoeYyWmDTI3Z4LRDgvfhHvP/NJz/mNarigwCKwfxwK1Ddj5W54tvYioWb12GZyZM6ELn3GZdxhKToDBhPyLLITCyU/Jerz0jRcf+cyk4S92D2stJSQbqMpSaT3bHnngoOuGjuME2J+wPIp1YFq+GX5mv9r8gb1Z1oK4GGXRlVGSz7WVpD577VBDYLEUocyCkjCLT6s8av9p+c8NZI0BGTGmxx0Y9UZwqQO8Oxjt/8ofu35LIC7GNGCAkACdv6wueskB77w5vSw/JZ1npiLcBWaoioi0Hny37OdH3ND7k2KfcUIm5J9uIQRzthEwzM38zS/uPO+i/dY8v31ZZvv+HBtLkNWX1u5nt8kc+cBZ0asoOXy+Z1HA3dhVuOes6Bl71eYO7M+ZolwFZnDEBq0ZsIYeX21/mxnU2Dg+iZbw1fukmZXb7b9NJrVLdT6CPIoLkBoGSiy0v5n/NUBsio3xN0FQA3Tz11f+ZKcqd9ve4eJCqYZhykIQb/daK3/7vPMrTkBgwgKYkH+xjDtxm5vBM1shv7O0Z6g8VNKyczXOqggbzmtBAKRyWe1cjc8euGP56jk3ZF/44wLYS1pgGKAUQMNyesUpew7dU2mraN4AxcTsGTCxkJQvrI0mT1vcf99swDqnCGVZ1gRBF8Bcday8+oCpuQP6Bzmb1YysYrO5I+OyCllkWtfYKz577R5x5namPcfnDjgBgfPBFc9X7fGlGblFAoqMQRFJSgQBYYRlyQfeLr3oike6Xpg9G3JG80TkYEL+tVIUCx5EHn72WN/jz7Q5p2ktpS1YgwGXSWpl9EGTs3+4OV5+8HkL4b51IUK4Gk5DCvrbB3b/YPdKt3YwR4YYYjw73DBMzBGytUu+99+P1P6WExBzigCDpjikOAn6qqPLDthnSv6M4ZzRLDhMBGu8QwrIjJF2a0fk20CLiwYIFJMO7CcpfX5H9Zsppa6dVygqSckwdFkE8qV1zlNnN/X8lZsg50xYBxPySQEEAJiT9GoeTr5t4C93rwhdFbWFBcAlEA0rUIXMiS9Nz6e+dVD5frv+Djm6CLmfHlGz7x7V6ptDGW2IWbABoAmG/TA7b0RjMEES2GWJVzoilyxdsSLnFxONq5zxOMCcEJ/fUf92UkTJnC7OU2ADXRYh2doZur/hL733BUlN437OT1L6U0P58XWTMl8ZzBhVDJHIABzJ6Ehb5tH3wt8iQs7POJyoR5iQjz2HsKGhm4T2iK+hS6acUbrTwTvkjuka1soSbA3kyEyJuFXfOJAfPHKX2EIDI3euHDy3wnZDwy5YCvZZOga01/GACSBmkJ8IbUC6MkKyZY3z0Km39t9ZbK7+CFcx/6p5e9eoLw5koSX8PIRxuIqQDXQO2dkn3w2NJDUV8yq8H3XO57Z755dh4fKgF6IshoVUJSFhvdRhX/fDJd3Pb0ly14RMyMfGQhiZzkloZuDE/609o2VNaHl1iCylSQuCGMgYnhbN1xwyI/PDw2fkvje1JF81nAdLIuKC4kJiwGuK5BMGBjAG7AhDawft/GMrSy9h9uoQilhxCcvBx+5WHdutMnuFoLwxhoqoZSQA0BFHyFfXOtddfH/PG8saIYPQ5TgAJCgFfcfZq769a6XeYyAHU2yYMeKQeKfH6bv15dJGTkAsS07wBhPyyQUEEMCpBog+erd/4bM48e0+p7vMEsJoGItAwy64L61V77BWwy5YkG8ZsA8ABdOf/L8RA6ShSxwh3umxrrjk3nXLkfLCh+MOyK9X+PaczLd2rdLTB3PMJMz4IT8DEw0J8VaX1fH/nqJfcAJidhF+fCIBgTjMqfvX7rjfNup7ea0NQKLIl20sIcXrneHEH55e17EMEElMAMKEfIIBAfBIxsu+BGvh60N/v/+d6Ik9eUdFJLHRYMlERGQRyCKAjClIyw+KJHm9deApJ5moTeKtTnvtja9N+2WxTT8C5fzZMZNn7Fqpv59xtSn2mUgwC1jixY6yH97198HuYvsKBNWOZ38m88vty9zyjAsjiumtYGBiYZKt65zlxy/a6Trm4sjSCZmQjz0gAECy2WurdvGD3cue7pTnQljSImgzsup77QoJBGbAMPnAELRM9HXIAwYGWeLVLuf7Nz715uCWKufh2w/+eptYLppVzKJIlr88RPLVDuv5U27pvLFYriLIulzYEDto1jbZeDqrNYjH5WEYgCXBQ65ES4d9EdDi+j0QJ4jECfl0AAIAnLcQLidgzb11cNGylfY1pY5tkfEIMmYGDIGMp6HEDGbCBhYDEwyTrghDvtFlPR6/deDmoolEn+W/6fiyw3avUvHBLIpLegLgCEJXzkHzu9FvE6jovgJe56W4PHAburIqrETeFBnJYOhYWMg3e52mc/7a/7dHE7AmSpcn5FMHCMD6yMNRf01f9Hy7dX9FWFhGQcF4azwzvI7qxivpJR8I2BAMg20BdGds3bqu5CKiopWTEAeAWfa+27tXlDoudLGeuCFdEhby5Q578SX3dT1uimxQGgDVX0554Jy62sxBvTloWSyRaIHWDdmDT7WHvsMMWjbBG0zIpxUQMBJ5YLrkmWknv9QZfrc8JCylYEYaKPsxRmLyrQZAMABNOuZI2doduuHU27teCroSFaGcghqgU6evuGDPGjVzIFN8MVHUAb3fb/Xf917Vpcygxi2IZMRn7Vg+a6r7U9aKyRTT8YAgQDrsCPFqh7jqW6neVcsaIZMTkYUJ+RQDwkjk4ak33xy85XU5d3U61FPqEGlNxrMOuAAYvF+1gYlaJFb1W513v1P6o6KJREBgOfiS+ik1+07O/DjvusYw1kcyNv+w2raEeKvXarzqwVXtxSrnMq+5izl/v3U/2rlKTUm7bEhwcZEMR8i3u0Pv/eClil8Vm3U5IRPyiQYEwIs8cBzyyuf6Xnnk/dDJg65NIQHWLBgswIbAI8AAEIOlkKK1K3LZFc3tXcuWQRRFJDZ5+yscsePAr3cq01VDeTAYAsZzQ5hHv0iwv8LrHc6Kry+ccl2xyskJiNmN0L84Ypu63Se53xzOGkNFvDcGIASzhqTn2qM/amlpH8bMCSJxQv5NAAEAKAX9wgLY8+/tefjx1aFvOZaUNhvNxncXWIANYLTQMUeIN7rtV45cvPf1HIec01w8y584pOqgPWvUOems0ZIhvXwG9gohDMDBUaB6lgBntU2vrCv51gqsyKWKTIkO6hWO3GXgvyaXuqG8YVNUgRZDl4VJvtYhnzh9cffiiQ7JE/JvBwgAsL8feTjxjr6rH2+P/DEWkZZhozhYullAEmMgb9NTbaHvAM0qtX5R3azEm8CMhJg9PfP7bSKKctrXzIJPCgOQ9gABPjBoDR2LCLm8077/jL903VfsTkdBJKPp9ElH7FadP9ZvfDJ+mJEJIQl0DFv62feci4iAiQ7JE/JvCQiAH3logjx08aHnv7DOaa6MSsswFBjQhlW5I+TrXfZt//lAz8NbpJwEc9PxV5964BS9X39WawGWI0URG3EIQRakMeCwBNYOWNmn3g8XnRKNIKJYV+fsOWnwSkcaGFPch4ihoiEpX1xn3Xzhkv4XiyVLJ2RCPpWAgJGW7imTeGpy/PXO8JrqsLSYkS+32Vo56GQeeidaNMsPv4X73nvvXXLglPwvLK1YG7FBfcRYwCAMdNSS8vWO0DUX39P9ZrH1Co8mvKrHO/Zb9d3da9TuQzlTVCRDMzjiQLzTY/fdvbzs+5yAaGyY4A0m5JMh1kd14aCl+9IVKzo/O6XmmJij75wSwfQeZbvNbeEf/eLptSv3aYBMbkGY8c74u4ndK9X0niw0CZaeF0Ign6UkFG4czTAMU+II+W6v8/7CV6xfFtuVKOETiYkHqqbtPzV9aU4pw4CgopALxpJCvtguf/aHp9d1XHcxZBIT1sGE/HtbCAC8yEMiAZF8vOvF/3yict9l7c5Rf3qnbM+zl3RdmUhAFGNGB/UKicMn77DvZH1BOu8VEwkjIFh4NcyMTSMMLCCYmCDpjR7xvVRLb/8yFBfJmA0IIvCX98v9YrsKtzzrwhSbEl0WJvF6l/Vqw62XXuVzEBM5BxPyiRH6Z9wkkYAojPcHjVCL8j18dv6xM0ru+MLU/Am9Ga2FoPW9DoSX/Who/QYuXv0E6YooyVe7nKf2vXb4Cxz3SpbHu19THPKkFPTlR1d+4ax9hx8PU14rZjnei2LP3NIsbHn3iuicM27tXzZee/oJmZB/Kwuh0H1ggJrikIktAIMmn+W/8Zjqg/es1if0Z7RmFpINMGIO+PkHZAjEAmQEYAgWGXQOW/zCmtjFBHCRJD8F9QqH7JC7vDqk4JriXhIzdGlEyNe7nNvOuLV/WbFk6YRMyL8FhzCKKcLYQgWJ+6C1f2328lKpMJAXXlJAkNzkxxy9v/nOABkwky6LSPni+9aic+9a91yxOQCPJiCpAequ05eeuUeNe1DfsLdTtEFwrzFdBQ7boNWDVvrJf9iXMqPYzktbVTgxOnaNBcCJBETjFpz/Yb7+eDy+ydjq6uo4mUxu1XvF4/FRid9UKqWLGdMY5064DP9qCXYpujde+p+HT3evHcgWbONOI74BgjohEh5CGAZHbeaOYWfg6idozyuOz7Q3+lbKOCY/IQH66sPVJT/67FDr1Ji77VDeQAiIkd5oYvSto5mhK6KWfOjd0E8Pvz6dmGiLNiETFsLW5BwAgTrwJbOm1OxaMfhzV7FhCEFgsM8VeMULXl8FAoGN8TGCjSNt+WpP6GdXvtK/+tjjYSWLUM5lCcg5SahHv5r//o7lalrvMCspYMFgg9YNFOQt+39jA1MSJvF2j/WP3zxX+t+cSP9L9ldgZrrn3G3qyjBo5/2/OQDe7i/BglTnaxgl0nHrWdW7b1+iwn15F7Z//gA75r6X+95Y2LJ+f40PueDwMcccM7m2tvZAYwyztzkl27ZNSqm2G2+88aXgvK3xHhoaGr5UUVFR7rousx+XJiLV3t7+yNKlS3PBvY444oiympqaesvyVICIWAhBruv233zzzY9NAMLHSBqbQNQAfe+89OW7xFRVd5Y0EQvmAAB89fRzkxkMkIDRMOVhFq91WW+e9+foHzjeL6nIegU0Qv/0yao9dq1IX5rJac3kpUQT+b0d4GVAkl/JHTSGJQIbluLvndZ3Hn51XRo/hqR/YnlzMMSzj/9M+WW7DT4xOZKrGPbhr8QBplfqNiAxA0iOKKjw6832qszctWtVfrf+HEMAcCygPU2405q6K7D67Y3J4C2V+vp62dzcrCKRyCG1tbW35HI5EBGMMYhGoxgYGLgdwImJREImk0n1YQGRiDgWiy2sqanZLZvNgoggpUQ2m0UsFttm6dKl64IxxWKxHSdNmnSPlBLMDGZGKBTC0NDQmwB235ogNQEIH0Ka4pBogLn6CzWz9q0ePnswp7XgICGICvKOyOMOyIw48pLAGWWJdwasC9rRPpzyNqIptl7BPPm13G+3LXGd7gy0FN42r54hwus5BPazIIm8LtFRyJfanWXHLkrf/q+oV2j0J+665V2lvIsJ2aTZITAR2AZEzEYOaOWNQAQAIURah0hxWMCAQQ6BbGhow1vVlRRCuK7raq21hvedKNd1LSJKb3UfmGjQv5cBQMYYEkIMSrlJE26tlNIBGAAwrusKIhr8d3YZxMdtQHGfgDxoev4324QZORUQhh5pKAx7vRQQkIsCxMLz40OQrb323Sc29f9fsV2JgnqFxfHKI/asVkf2ZVgLkNwARvyGLoV/YwaHCOhI2/qJtuglRPwvrVfIuMpSGlIzSDNIG5BhkMtEATu7CRkKgmaQMt5njAF9FKaNb7rL4GBmCUASkfiI5vTIPQp+3/DZjRl1TB9Hnfi3BYSASLzpKzWn1FXp2b15owWE9Kokhd9lyQMCYq8JgjAAG+KQIGpLO7lH28sv3YKuRCP7K+wzKXt5CSnWmoj91vDMXqFSITAEnaBg2JSEIN/qsa+76J7im7t8ZF8kEQOs2EDBqxtRbKAIUEiN7W8EVhAjeN5P/Jw2zEFp2wa/T8gnDBAITTDzd9st9pmq/K8taGazcbZwUEJNXjUje24eMetSW4pXupzf//ChthVIFef7BvUK95/6/vm7las9B3JGC0AIv7uTpyDs36twdSGOWCTe6bF6/vaqSHwc6hWUYeFYIhoNC6vcEXaZI5xwWFhay5qxLAT2szzJ+PtkBPtlfLIlatu2sDyRtm0LACWu69KEun+COISmOAQR9B3Hd+wzI6a2G8yDBRkxemSUAJZeCwQYU+4Y8Vaf3Xb9c/yzLem8NLsR+heP107eo3LgJ/m8MsxCCgS8gcdYeFmQ3t+CHd4F2FiWJV9bF25MPjPQ03jJ2PUKiTFyAxobPT9/SwAzkdj0ZTQCSCZB5ZPEuhfXhn/Q1itDWSUgCByWoB7X6kVdXbBnFhoTEI2NQGPjZUDPr9aTMryeRiuxQf64RSLh3yc5Ujq2VV2JeDwue3p6ZDweH/Xafq7CuP2wiLzwkxDiLKVUzHW9IIkfRdCVlZW9AFBbW7tVniEej8uOjo5RQaa2tpZTqZQpgr+iRCJBra2t44JVETkbI9caa1ybk9mzZ5tkMmk+NoCwvM57ea90hXr2qdaY5OQ4qwmbqyHwnUDWcOTyLvn9u1f296G1OJa/sckjEh88afjKHUpMZVdGaClG6ImR3g1MAZXpf7sMHQuTfL1DvnbCXw6/lhMpsbl6hbEslWRyfYSgWP1JJjc9N+n/XNLSPrykBb8aYxQjMIokOJn0/nbKRaFRQaw3rXN/SG64rU7yo/naXT8JaPyU8qYmGY/HTaD4Y8nChQtfGE+xtgaQEdEHdg8TiYSYOXMmNTQ0aB/sPjQ4pVKpD3Wt5ubmj5eFkEzCeLn/a1tnVlUljtteJ12jFW9mjIahK8JSvtRtPTXvnoHFAQdRhDUiRQP0dUdVHbjPpPQpA1nWAkJ6JKUZiSqsz4pcnwRlETCUs7G8p+QCQkqnWiHH8lHPqkd4OxHbflJF2Qib7ljE0hmm1b1S0f2da4vlOY7YuSp29N5OpZSWyiuP2HAs4urIMFxVOnza4lX9lx8zefuaKDgLIOwfHXlLXXTn6tUAOFFfXjF1WmmpI4nfbnedvOqNsab14Vv2mt/uUGHtcPUJU5XlMAkjjHSG6bm3geuf62nbWu6hz+5PbmhoOMC2bem67gbfmxCCpZRERL233HLLqoaGhnzh5N+MctRFo9EyrTUXEJq6pKTk5YULF37o3IpEIiGIyMybN+8wAKVe4MQTKSWUUqa8vNx0d3c/ft999/Vio/BlPB6XyWRSA8DRRx8dra6unm6MKXVdNyA6NxHbtuE/w2sbP0MikRD+9eT8+fP3UEptOzAwUFr0F0HEjuNQOp1+f8mSJc9/rMKOQV9GSvX89G8N5bvM3han9wwrRUTWaHyYIxhdOYuf6rAu2YJ6BcQBNAD4/JT8r6tDGn3ZoLbZT3ICef51gAN+abUxpMuiJJ9b6/z19Kaux8YKM3pZEeDhzmnR4+r7HpsR6yzLqpG9bWFL5sFJltvdX/Gl//dk3yubi/cHpd+XfM699sBp6fhQzuSJR96HDoWE/VwXTgOOuPfw7R9/YUo4H815lV4ckRDdSvzjxbO232/RopXZY/bSF+1a1v39gaxRc6oRKpHaTrsE4Q0XWhMqQ4ou3K/zIQI0KGgFB7ln1H7k+udw1NYIrRKRzOfzEEIcOWXKlCM3yxAaoy688ML3lFJLVq1a9ZtUKrV6NFAI8hDKysoWV1VV7RPkPAgh4LpuTgixPYB1y5YtEx+UZEwkElYymVRnn332BbW1tb9TSgXP430ZWiMajaKnp+eFTCZziK+svLHynnnmmXvHYrGLpJSHMvNUIYQY531BKeXm8/ntAbQHzxqAy/z5808rLS39ARHNlFKipqamyJ2HvTGXlJSgra3tQQBHfPxCLCkYZogvN1Wc+0S7fKkiIizNrDdWOQPWsZCQr3eKWy9+uOdZsyWdl1LQfzmh6sydY3r2QI60IJKeY8DeTPH7Pwb7SXh9ID2ffNWgM3z/6pLvb665CwFsErBSrW090FhSXaLCJVY+XObkw+WhfDgs3NBOFarsiBnuPJ8HEGMEAUg0QJ/6hfLKXapyR5aKvBOzVWlZKB8udfLhydF8yWDWpJ99u2fpETuvKCuROloRcsMxOx+J2floeSgfLpNuZAf/etWOFrFQPlxq5aPVobxtiSC5i0doBAGD8lDeLgt54y2189GYo8I1EcWjWVqJeliFR1N8/CYyo8c6Rj+klJbjODuXl5d/a+edd37xzDPPPDKVSumxahZ8U579nwYAW5aVs237Q5nmvvKps846a1ZFRcVvXddVWmultdZKKa2UykspeXBw8K2BgYHDUqlUf8Hzkf95s2DBgu9UVVU9X1paOt+yrO2k9GirzRzGfw85y7J4Yzfh3HPPvbimpuYWx3FmAoBSyvhjKkqYOaeUUkKI9MctyjCiTI2NgKCV2euWh498u99aWe6Q0GY9qhsWXCqZ3hmQ/betdL5bLMvPfueleN2k0s9U5f5LaMNGeztTezaA8JvBFsTiQJ6aMJmIlKJt0Plp8sF1740XyUi1+pzIGvv6riGLwcR5JTivBbtGsusyT4uaEwHYaITGKOzpsoS3pf3J092jp5SaqoEcKWWI81qw1sIlYWH1oP3nZDOGapxseVaRyGliVwujjNB5LVgZMQKSrpJGuzDKCJVVwmj2cjyCPA9vyz0gp4TJucLklDDKCKVdmKza1HdvSEEnm6EKjy0JvbInIyFCFIQJ/WQhYmZ2XdcMDw+7lmXVVlVVLTnzzDMPS6VSOpFIiM24JMF+gcHvH4ozqKur40MOOaS8tLT0r5ZlOUop4bvckplJCGFprQf6+/vnLl68uDcAAADU1NQkfOW9rqqq6r8B2JlMxtfHETHMrDc+ABT+HhCAMpVK6a997WszS0pKrnBdV+fzee0DYvBOZDFHQU4Ifaw4hNH5hI510yKVp5y7J56aGnXNkAu2CEQw2rIs67Ue++cLW7raTymFlUTx9QpL52V/skvM3bY3S0oIWJ7yk99siUayEr26CYYxZMocI1p7Qqt++GjF1ZzoF+M1PmlIQTODiHqf+ez08Mu7V4h9+3JshLcJtBzKgbcppT2uP7Z8T6L+l0brnTDbB5XpFeYUGxqaQQIeqyYIVvewUC+ti9wApKlfCS28ZAIaqfxkJmYQ3vNniNCWdCAclx1bADlFUOytClyASFHL33OCCNqwkA7gSGMXjq0esA4/ovKwGEyJ6wdhbKF12kh+sjP64JKW9uGhoaHNKqKUkizLkqOFQ7XWMMbogskqXNfVtm2L8vLyppNOOmmvxsbGNgBia1dMbhoRapTJZFItWLDg+tLS0p0ymYwSQgS6w0IIQ0TWwMDAGTfffPPywLXwV3LR0NCgzz333Mbq6uqvZzIZl5kt3w1mAMayLCmlHNPMJyLk8/lyITzHdrfddqPm5mZYlnVpKBRCJpPhQrfacRwZuDPjiTHGEkLAGO/7/VgCQqBQj9bDmtPc+/T2FTWnnLIz/zkqlclpzleFRej1HvnGvLunXMOJXrFF9QqPVe9WV5m7aCgHw2AJAwQeHI1sG0EjVBCTgCDFLltieXfo0uaVK7PYDJG4UUxQAlDtafvm3SvNvhLKABB+joOujRprn1oVB/BSvG5DC8HvG6F/dujkGdVO38HpPLEAhL9O6zKHxPIe+6kLl3S9SAB0Pm88E8jfFQvBhrtAT8Qzl98bDKdDhLWDWVaGyS4PqUkx2wgPFDxIcFlgZb/sBHvvlAm6LEvyvX5nAMiPjK99ypSKI2f03Tuz2hXDrgeitmB0DNto6za7AXhrxx0z1NIyumXgFxL1pNPplUREzCMpUSSlJCnlzpFIpCSXy3mJ4kQB96Ci0Wh5RUXFVUQ0b6wS5kJw4Q+RbRUo9znnnHN+RUXFiZlMRhGRVXBNHQqFrO7u7ktvuOGGexcsWGAnk0m30Kz/2te+dnBZWVkik8koHwyIvdWCHMeRmUymi5nfANDnX5c3IlhhjMkxc9aPpKhZs2bZUsrZfnhVBJ+zLIt6e3t/FQqFbjfGkG3bm52nruvCsiwYY/o+1oAAAHOaobxS4q6/VIerZhw2Db8sC+vQyrSTe3KddQGhNZ8qVjlbvTDj06flfz21RId6MkIFLdWNCcqaeST/IHAXGKzLo5Z8bl3osZPv7EltEanmA9Wdy63bd4q5/1UbQcjVFJCLQrmMcseciFkLEmhcqApje42ASALmwCnpk7eN6lB/BkoQLL8fFJSW9HZ/6AbAC2Bk/OF7KdbBBrsAGcLvlu6rgBX48g1TrgCs302Bze3IiFcXvNsyOWx2HcyzYSKyBVNnxuaL/q/20IfeLlsB5AQQ8t9tvwb6EeR4hGxbl1m6x2hVyX67KgZIGDKO3HASGmOgtUbAyDOztm3byufzSxYuXHjWaK/upJNO2q6iouIHkUjkP5VSQQ0EAFjpdFo7jnPCqaeeOmvx4sUtPp9gNr6XDyIwxiCfz49KqBWChtYahStrIW9QWlp6RTab1VprGazkxhgVjUat7u7uG2644Ybf+uARRAGorq6O4/G4Y1nW/zPGsFKKAvATQjAz6/7+/u93dHQsuuuuu7qLjXIkk0mz/fbbb8fM27quC2YmZtaO48h0Ov3I9ddf/4MPqnMfa0AAgDlJKM+c7vmv3325ctletbTLfSutZy9/qvtNBoi2gEi85cjYkbuXm+P6c0ZvELngwgwhjz/wvnSGIwlr05Z5fg19i7Bl+ysQwB6A9L5/9l6xpTvG3ON6XGh4QCSG8mQmRXmXxdNv/yIRHtnAbWiERjIhtg3/+jSjAcMkBPz9KW3IlQNy3Y1Plt7L3ENBghMHz8IYCSNuuDq25gHk1/rWjyPCrtd8ijZg93aYpIfw9qtporFTmcsBKENSayGVB3IQYFJqU7s3ULRA2ZgZSikYYwQz08KFC60FCxaojczk9wF8Y/78+YOxWOy7uVxuBBSYmSORCIXD4a8CaKmrqxu5Z3AfpdQIIIxmIeTzeSilRsCAmYOVOFA8am1txVFHHVXpOE4TACeXyxnyBMYYHQ6HrZ6ensdvvPHGrzc1NcmGhgZdoLgymUyq+fPnx0Oh0B7Dw8NaCCGDlZyIRG9v7/xbb711UaDo4yUopVIpHZwTCoVqmNlxXZcDrsVxHGitn1ywYIE9ZcoU2draOm6Yta6ujltbWylIfPrYA8KIP56AoGTv0wCeLjCpi6tXqAMDdc7uVe9fExEGA4po9BbKfhEVBWnLRpeGST62Ri666G/9L32gkJsPIG91yz/VVVvHE9T6dgoGpiKkxYzy/KkAHonHvfObvD0o9O0Nv993comZOZQ3LCCEl6YNHZGW9f6QTN23alVvqgEOAluePTdhlDSGDf7HmCAjakPlJb+SU+W1BYBOZIjUhtbXhpqloUixEhrs4yeBYaS7KcGrlNpgRS5Yxbm+vp7PO+883ngl9PmBH82fP/+IUCi0t+u6hogEM4tsNgtmPrS+vt5KJpOqsbGRAgshuFchIEgpx7UQCkGrvb1dplIp94wzzlgYDod3DFwF/x7GcRw5NDT0j/fff/9EZtb+/QufwfjXPkcpxcYYNsaAmY3jOGJwcPDZW2+9ddHFF18caWtr0wBMXV3d2PzXsmWjjp9Hckg4ALl9brrpJhcYv59FPB6Xra2tVBjC/UQAAuC19WqKQ07qAC2bDVNsnf6j9ZCUhLpz7roL965WO/flWIvx9lfwVlkTtQW90y+7/rKi5rucGPhA9QqUgiYCfvxK+UP7Tsq07VxB04ZcNoJYGIYcdg2qQu4x8R13LBcN7/YDoIBP2LZk+JwaR6M3A01kLMOATZBr0mRaVlv/AwDLOwqa17Ln/oz8Jeg9GV8PTB4JFsyo9dvfiWALLAOIvGcs1G2yy0WBghtDYGtSJGzgKJ+7EEBWSwyRbW08cQtdho0BYnRiOWl8UFDZbPY3tm3fbLzlWwAQvgswo7y8fCcAb6ZSKeHdSo/qMmQymU18540BocBCoIULF7qnnHLKN0pKSk4cGhoaAQNmZiklcrnc0ODg4HEPP/xwR0NDwwZ5EYFZf+yxx25rjPlcNpuloOLSjyYIrfViALjyyiszWzKfgkzLdDrdFgqFMlLKsM+/WJlMhqWUR5922mnfaGtruxmAWr169Qbfn+M4nM/nacWKFblgzMF4P1GAEFgKAIDmIgkhQMxeBv2NAydtU1eRuSyvjPFyhooLNllSype7ShpvefXdjv/d7YPvr2Aug0XJldm16dI/11Xzd5A3hr1xUNZlPbWUa0/cu+vw1Lto+uMCWCIJ99C9J5dUO/3zMi6B2RszM+nSMMu3BuRj332k71VOQDQWAKPPHKx3ARgYpfK3YLknMIuRHbmZvX1zx3GDPIXSOrtqSP7W1XY0p8ECgCRQT87WEcvtBIDKdyM8FiBs/P9jgQIA6uvre1hKmZZSlhhj2I86aCmljEaj0wG8uXz5cioEmo0BYayknMIVVggBpZQEwCeccMIBoVDo6mw2q40x0rc02E+dFv39/afecccdr9XX11upVEpttJoLAMa27T2klNHAsvHvI3K5HFzXPWbevHnTPM5QmM0uT0Tkum5+3bp1v04mk4M+WbnmtNNOW2bb9pG5XC4gOomIKBQK/X677bb7iTHGnTp1KkYD9YMOOqgLwMuu696UTCYf979a/kQBwhaHi+LefHj8FP3TnWO6rCdDPjE3HhRAl4UgWrutV+L3dP7B5yA+cGirwQ8fPtvh3LRbtb4kZhmpzUi7eI4I5l3K1UkAmhZMAZ0H4Pzd0odtW8JTci40+f0ZJBg5I7AmHf49MIxly7BB1h2x1316ZLMavyv15sqfiQkjGQZjbZ29aSIRWtrbhw+9FZdu7sQ3S0t5NA4hYM6DAqTNYSkAuv/++ztPPvnk94UQuyulAkAAEcF13cqNCczROITRQnoBIBRaCFrrXH19fWk4HF7MzJavzMH9jJRS9vX1/ejOO++8tzC8OEaEYwffPTIFOT9Ca41IJHKIEOKQYuaPECKwcK4FMBgUL6XT6Z8Q0eFEREqpEdBxXddYlrVN0A1qtDAmEU0XQuwnpZx/4okn3njbbbctSCQSn15AaIpDihT0lV+u/dwusexXB3MckHnjihSMQeXQY2us7wLQRXdeGpMMCjiQntav7FDavG2le3BPjrUASwZkOg8qC4sjvnHApG3Q2LkOSWDbGJ8RERoZw97uMswm4kCuGrTarli7172MZqJm6EQBSWCYvZzDEVbR/8+GLsMGyLdBEwTmLXrMRxOwZm/s63pEsC680Ae1EDbUXT1cuPL78X8MDg5W+z7/mBYCMwdVj5uQikHWcEGUIVNVVfVHx3F2zmazhWnz2rZtOTg4+Pidd975y3g87hREFMYadM1Yz6mUKrZPAwshSCmVdl3XAEBzc7P2rYSWY4455oKKiopr/Wuq4HmNMWoMkBIF4GSIiGKx2Py5c+emk8nkNz+13WHidV6tzv61+Wuqwq7IaxSV3W2YdVmI5Mtd4p6LHu15iLfWZiszPcVtz4gbc5CedeBNWMpr6GmlHD1ihjqOCPhV/dRpkxxz2JALgEh4bB+ZkCXRmZG3Njc3Z5EYDaQosDELjs3aop7bUHg+gNwWRIBoo8PvNs0br8TGmE2OLcgPkMwc2eg6pLVGaWlpGwBMmTIlKGYa9V7pdHrUHIXCc/zrEzP/zQ/nFf67zOfzOhQK7X/UUUedlkql8vX19ZvloowxarSxFD5/sYfWmjaOOMTjcXnvvfde19PTc7bWutO2bcuyLMv/6Yx2CCEs/96CmS1jjEin08pxnAuPPfbYL30qAeHReliUhLn9xJqGWdX5/QdyRgsxfpo2MzhkEa0asjJLVzuXMIMa67ZSD4AGGAJw11tySVu/7A5LIdkIJhYAC1hgTIuq0wHwZ6elT5hWwiWuIk0QxEbCJiHXDlrq0faSRX6ewiarC/mNXchvK+cdYyNCcA4KfxpC6OPzVQoAfPDBB9cQ0XbGGNB621/4Sty9NW9IRGV33XXXjcPDw78LhUIWM6sCBRfMHCktLb3xyCOP/Hxzc7Maq6YCAKSUa4IU7E3i/ZYlHMexbNu2HMfZ3GHbtm0JIcr8Zi8bgEIikRD33Xffop6enj0zmczZxphLcrnct13X/bbrut/O5/OX5vP5S4eHh38wNDS00HXd1/3rcMEqQkIItizrkk+dy8AAYRn06ftMLtmjdPg3DONzLcWZplFbWE+00+W/earznctTkMmt1FK9ICeh/6w9YrftVGbOy7isAbbAJNI55pqwOejkfau3nRzKHU/GeAlGnluvSi2SKwathy/7v7VvcByjdpMeqUsoiDKwxmY4BOF5CUGreT/SYPjjsV9HfX29aG5uNuXl5V9yHKfUL5GWBURbJpvN/qMwzPeh5w8z+6z7t+bNm7dnJBKZ49cJSCIirbWxLMuJxWJ3fvnLXz4olUq9u3H1ZdCExRjztlKKsWHNkLYsS+ZyuZuEEA/7/7bZOeZzAdq27Z6Nw7/JZNL49+8AsKgYa2vevHnXhkKhBQUJX0JrTUT0hU8fh+B3Xrp3rtu4S4Wa2juM8cOM8KJvpQ7kG71y5WXP7PprTrSIrb1Ra5DU9GZfyQ27lQ2dZyMrjBEggJSGqXZc6+QdnGvLbDUrm2cE3aYFmHLaor/3hP4EgJZ1jKGw7DWgFUHbeL9OYUwOwRgI5pHzhd9DsixkuQxQYxGW2OzZ43MI42GlX/OwUep2goLYuxDiOxu5F0ZKKZRSbzz44INrAVBjYyMnk1uljQsnk0nDzDR79uxTa2pqXnAcZ2pA2hGR0Fpr27YnVVVV3VVfX/8fTU1NaQoy2byVO8iabNVar7Usa4rWOiD9WEoJY8yrt99+++KtM69SGgCN58LU1taKVCqVHxgY+ElFRcXpQoiIH7Ikn1St/lQBQpD/n/jCNnV7VA5dnMkaU2xnX0FgDSle7ra+39LeMlx0vcKWeA0jBU+7vfTyWS2v7lEh9h7IGSO8MYqca/D5ydnjBBnkzIiOmxIb8u1+ueaK5637iMBzmkdfUUzgF/sByKBx6mihQwYhzxYxj2QRkathJoW02KViYDsC3n3rQjizX/XuNVrux5xmqGJDwJuJWPDRRx+tW1paeKOQIwMwxx9/fCIcDh9QYB2MEG1a63sA8KxZs2xg6+6UNXv2bNnc3Lz2iCOOONG27WYppTTGBDVgMp/Pq1AotFd1dXWKiL4Sj8dFQds09lft4blz5y61LOucIIfCz0GAEGIegCvPOuus8HvvvYfa2lpThOK7GwHtBiDa3Nw8njVr6uvrrZ6enqGysrIhKWXUD+Oud2U+TYDQ6Of/z54yPG9GqabuLIwErPGWKmbWFWGSLZ1i2Zn39f6l2M5LH3CQEmhWa4bLb6qrsK4gVkFOQtCPwDD7u1R5CQLGklJ0ZK0bW9rbhzkBi8bYicojoPzcgoIgwsbWgTYgIuaMa7IEwDD5dqvgMsvwrFp9eWXljofu+rt3+9fPtg2vccTOO4e+ukf3j6vDbmlOgwFB5ZbO9mlH/emV0DWpFWs7x6t2ZGZZV1fnLFmyxKqrqxt5prKyMlleXj69tLT0AsdxLtioloGJSOTz+Uwmk1kEAEcfffRW/66am5t1fX29tXTp0meOPvro88vLy//HGOMCsH2uwcrlcqqkpOSIuXPn/r9UKnV+fX291dzcvMF3k8lkrrVt+5yCgibhuq4JhUKfP/bYY3+0aNGiX3xIQN2i85ubm82xxx67l2VZVcaYIKTKvjvU8+lyGfx4f9ewXGtYC0Faj1cKzwBsSVibsUzzutC3CYP4KLdXCBKJXlxr/2X3MvWzaodK8pqYaGSnSrE+C5hgCSPXDFn5x9c6Y5KJBe6h55IW5iGANnUZ/CpMS3KrIPoMgQy86KbszxHvXaUPeOKY7he73apFXWnRJmwh3xqwnv/uw2teDuot+rLZkr1q9I93q9RwFUCkYQlGx7CLeyrELQA6d8xkqGX0gVp+DsJxdXV1bwUdgAqIPWLmbUOhkOXn6ssCEFGhUMgeGhpa+OCDD74XdA0KUpe3MiioWbNm2UuWLLn++OOP3zcWi32jMBQZgEI0Gv3GMcccs+ree+/99axZs+yWlhY3iAKkUqkXjj/++P+NxWJnBJ8lIqGUMiUlJT+fO3fu3kqp24jo7eHh4U2AXgjBfkTFaK3fKgScQw45pHzSpEn24OD4e8sopchxHNsYc6DjOFcKISzfDQqSvIRS6plPFSBQCoYTENvdUHLLpBif/aXJ5j86M9CSxk7XM4AudUg+uda68XuPdL34Ue++lASMd4+u9sO2q3hgeqk5MZ8xGvAn2YZgpWO2lK398pFkc+eKscjELZVl/s/3eq2n96nk08DuSAKnIFA6b8yMsvyOu0hKZhUhFhV4cm3kxwBe3rHSMyYsIRiGO4cyXJnxaxlsYhrMGWOzGNd8933WEiFEyajfizHYyE0AMyvbtu1sNvuPnp6exsKU249KWlpalK/Y35w7d25dJBKZvdG4pOu6KhaL/eorX/nKP+6///6mwFJIpVImkUiIJ5544mLLsr7oOM4OrusGgCK01iYSiTQwc4NSKuidOFrkA1rrjJRyRwBrAxIzGo3+GcDnI5GI5s2kpBYkZ0nLskp8gChspsLMTLlc7g+ftrAjNyaB1avbMle9HD329V5rVWWIpdmkBduI6WxitsGKftl7x8vOD/9Z+yss+73H6bf243/TiiDGaCUswRjWhPcGrGuxmWDBlsqcpMdl3PRq2eK3B8R7FWFh6YJiGCKIdJ5Nf9YopXRW510VotzwpjONLb+E3AJgEcFiwNJm9E2yNz6YmZVSZrTDJ7uEf55hZte2bcsY05PP5+c2Nzf3bcZsDlKMCw9sbkwF529yjl8/YAYHB0/K5XJrpFcpFcwpMsYIY4yOxWI3HX744Z8rCEdya2sr/e1vf+seGBg40XXdQdu2LWZ2/c5Q5Lqu9l0iFkJglIOFEJBSjgZ8NVLKMiKqlFKWjXUIIYKfJcH7DVKxAeTD4bCVyWTuWrJkyb2fujyEJGD+eiLkXX9f0337ivBxbRlnqDIEaRjKcBBlIzYGJiwNhAzJF3vCl97wj451aAUl/wm7/MxphiYC//zNmgffH6KVUZtJAC4BmgBNBE2AW2KB3k/Ld65YssNSZtDmEqSkIJZgRQQtvOsYArQY/Xk41QBx36pVvUvejc5fOWTna8NsS2+3FkMM4+9yTcwQfrfSTZTc2zLHu5cIxj7K/YIc+yB0VyhiDCk8x7ZtEQ6HbaXUu9ls9rC777775YIWZZvyw+vvNfL7GCvniBSMbROd8EN74uGHH+5Ip9MNWmsjhJDB6iuEEMYYKaWMlJWV3X344YfvEOQIBK7DQw891DIwMDBbKfX3SCRiW5YlEPTnWx+WHLO34hhrhjbeltquKVIKnhdSSgqHw87Q0FDL2rVrv5pIJMSnMjGpIQXdFIdMPtX58pKV9nFrMs7qirCwIhbIEoyINFQWJjHMDh54z/npqfd03dj0URKJoyikuQzWihUrcqsG6LaQbQkQ2ZYkaUmSliBJRLZjW2J12v5TC1pc3+8fmz1wbFeziEiSUkqyhCTLkiSzRpaOZlo0pKATCYjvPbbu0UVvhf7jtb7I/6WN41pCCmkJYUkhLCkkBDmShGzvp8mFn+8HkDVWqSW9BkdCCEtKIaUQlrUpcaOMMVlmHjbGZIs9mDlrjBlwXfeV4eHhH61Zs2b/u+66q2WcVuzBZ4eZOWOMyQLIFDYoDXxzZs4X3GvY/5kbK7RXX19vPfDAA08ODw+fT0TDAEaeB0DOdd20ZVmVJSUlqcMOO6yqsbGRAVAACg8++OCLbW1tB6bT6aRSagUzmwD7hBBjHUIIQczsjLoOeBewRZFSCAjGmLaBgYHfrFixov6ZZ57pSSaTn95ahgAUGlLdj7w+a8p/nLmL+71JkexheU07OpLX9eXFy8+0yWsuau5eyn648p9symgAeGJV+Ld92m0VxnBhQpAgsGFBb3ZH7wJ6MNb4kr6Z2z9k+p5bbZ21ImTsPHn5SI4ADenwINBkRrKONlj5PM6Fkl0tP3sCh1531NR9plp9M4e1CAGAYRAxTMQR4qXu0MsAcO8UbxxVM2YMPtex/Ow3+0w0b8ASXrf6tJa6x8g1AJDyG3Rks9kHAewNgDdOwR0T4KRkx3HQ09Pj3n///auCsRfsQ7Dxah8kA53EzCEArJSiUCgEfxXtKQzNua77diaT2cdxnPW9ACwL2WxWYYyt4Jubm5V//z/MnTv3oVAoJHO59fjh9zc04XA4bIzR/pgoABT/s4MAGmfNmvXfU6dOrQuHw7GAU9ksP0akg2cI8hyIaIExplJrzVLKLSJVM5lMfmBgYHmB60UA+P8DLVWJAvl5vmIAAAAASUVORK5CYII=" width="260" height="70" alt="vit:bikes" style="display:block;">
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Partner Portal</h1>
                <p class="text-sm text-gray-500 mt-1">Melden Sie sich mit Ihren Zugangsdaten an</p>
            </div>
            <div class="vit-card p-8">
                <form onsubmit="handleLogin(event); return false;" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">E-Mail</label>
                        <input type="email" id="loginEmail" value="" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@standort.de" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Passwort</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div id="loginError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-2"></div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center text-sm text-gray-600"><input type="checkbox" checked class="mr-2 rounded"> Angemeldet bleiben</label>
                        <a href="#" onclick="showPasswordReset()" class="text-sm text-vit-orange hover:underline">Passwort vergessen?</a>
                    </div>
                    <button type="submit" class="w-full py-3 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">Anmelden</button>
                </form>
                <!-- Registration Link -->
                <div class="mt-5 pt-4 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-500 mb-3">Noch kein Konto?</p>
                    <button onclick="showRegistration()" class="w-full py-2.5 bg-gray-100 text-gray-700 rounded-lg font-semibold text-sm hover:bg-gray-200 transition">Registrieren</button>
                </div>
                
            </div>
        </div>
        <p class="text-center text-xs text-gray-400 absolute bottom-4 left-0 right-0">&copy; 2026 vit:bikes GmbH &middot; Partner Portal v6.0</p>
    </div>

    <!-- Pending-Screen: Warteseite nach Selbstregistrierung -->
    <div id="pendingScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang wird gepr&uuml;ft</h2>
        <p class="text-gray-500 mb-6">
          Danke f&uuml;r deine Registrierung! Dein Zugang wird vom HQ-Team gepr&uuml;ft und freigeschaltet.
          Du wirst benachrichtigt, sobald es soweit ist.
        </p>
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-400">Eingeloggt als</p>
          <p class="text-sm font-medium text-gray-700" id="pendingEmail"></p>
        </div>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Gesperrt-Screen -->
    <div id="blockedScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang gesperrt</h2>
        <p class="text-gray-500 mb-6">
          Dein Zugang wurde deaktiviert. Bitte wende dich an das HQ-Team.
        </p>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Top Navigation -->
        <nav class="bg-white shadow-md">
            <div class="flex justify-between items-center px-4 md:px-6 py-3 md:py-4">
                <!-- Left: Hamburger (mobile) + Logo + Location -->
                <div class="flex items-center space-x-3">
                    <!-- Hamburger Menu Button (mobile only) -->
                    <button onclick="toggleMobileSidebar()" class="topnav-mobile p-2 rounded-lg hover:bg-gray-100" style="display:none;">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-2">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAAAmCAYAAAAWR3O2AAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAAdSElEQVR42u1ceZhUxbX/naq79TI9MwzbAIILagLuxF2DGmNQMSLQE+OKG+AWd1/2njZ5Ji9uMfiMGcFIcMu0srjEGGNg9BkxChIDgyAKAwgywMz03n3vrTrvj+6GHkDUPDV530d9X33dc/tW3Zp7fnXO7yz30sob7cf3q3fPLSjSm7Lma2Of2++UZc3tCk3QBDB20zgGgWZw4sLavY8dkp9ZY6rjAC0Apl2drxk6bIE+zBqrnn6//oirWzdnbzkpOODao/zX+oe8YXmfIQgEAMxQEQdyfcp8/aFn9/9q87J2L3FR/V4nDsksjNjeQNcHqHzuJ2maoeqDQi7ZaP3q8GmF67gVkpqgsKd9qiYeXBWe3JE033QMLYbVesc/OWb1A9QEhRjkx4wltIOIouIrA/NPDKn1TmRW9FFgAQBBYJCkjVnzB9ckNmeIwBccor87tI+/d8FnJaoAIAjI+wJrUtb34+3tLhH40H7Znw6MeI1FH/rTgIUZOmiCOtOic/GHdT9lBiEKvUf8/wRg7nh6a/rljvC4LVmz01Naf6nBveS1q4I/ojh8jsH4qIHzY5CUgFpy9bNX7NPHO6onyx4RxO52eMSBXJcULx19Xz7BAP3psvCXh9V5V2ULWgHbAaoZfiQAuS5ltI5+IPsXAPjLlPDxgyPqwlQOiuhjwbxjU7YhxAcZ6weXJT7cvKAZkmj32nNP+wjAzI/BmJTo+uC1DuvcbNHgfFH5h/Rzb3v5yvA4isOfvwvQxGIQJwF62rhBDY0RL17wWFcLvLKrwdAAdElg4FTBUCs2mbcQAAJ4eH3xjjpHGZ6GFiUBagAqYEJ0Z2XuvZ7grcwlTbJvpHhXwFCaAS12o1vKKFDluTQDqi5M5upuY/ER0255iKOQJ8fh7xH9PwmYk8uaZNxj2fkrupypBqQB7ftfri889tQFdYeeHIffGu0NhuaRIIpDn7DXltv616j+BQ+6WrtoBgctEpYhhCGEIJAM2sJYnzZazpiVe0vHIF6eEvr23vV8Zs4V5EhhWlIIWwphCiENKcX6tP2TsQ/1dBCB/3pV6Jph9froTJGEKYSptPhIsAiAwxZJQ5SuLYWUG3usxcs3Rb7NHGeM2KNZ/i+NqgisQXH47dcG7vxSn8JNRcXc7ZnvP/f+gKOmPLm+60c/hojHoStE949X1I84tjG1WJIyfAZReS6toSMOiTU95vw1PebPwL4vmDQJpmfX1r1x53Gb8hSHnj6+bthhjW7Dhh4PwiiNlT7YNAHHMPUJ03NLYrHSNZ+eVHvE4GAxnC6wzHnkDa7FD0YOLIxJF3qbJwK0EFK8lzRv6UziDctkEbRlz1HTznwbSCgG6OOI/J72SQEDEGKQFCf//eut5/aqcc8AMdZlrL/se/ex3+DWNkYTNFohqAnqnRutFw9s8E7tzrMSZaExgy0DXPCM3Jz3ag+8/ImtG3Z10ecvrTnw0MEq3JH0vLA0yav84AEFw5TH/TK5mLBryT57Vb+BJzR0LTeEqvXUdk+p5AWRfHezNfuAe4oTdvwnf1wG3x6Rf0aAqXCTZgC/XDIsMnHfDW/2Dfj72gbRsi6j5eD73Clrb0Bg2D3Iv3xl4KyjBhWfzrs7kVVVHyT5j0329w+5t/CzldfCXvJhiS/sWw8xqhFqxlsNA08fkVo+IKQirip5QwDgayAUAFZtNt96em2/428csb5IZQGX12VQHO67N5nPDW/wzujOYTtQATYJXFCGu2B1aOSEccmORX+GeL8bOjoCTHEw9miWzx4wANAahWxKQLVGQwePHuouDJu+ZZnSWLrZvuHwB7K/BGJi7c23Lx8Q8vfPeMxSlrgLM3TIAm3KGu9PXzj4oOaTOlzEwRUTUIl7LL3BmjGyv3tpTxbeNnPCgBTQDIG/rXWOPvXh3OLKOqrHvnxVZMxRA7PPFz2luAqozPDrgsJY9IH986/8d/57e2IsnyPp3fFAUwJqfgxGUyL7jzc22pMUG0bRU97QiHvP368K3PXud34+d4DjH5DNMwuG0ApgXfJ6QJI+SJs3xds6Chi5nS+0RiFFE1Tb5NojhoT1pEweCgSjfH2hAR12yFifMmae+nBuMbduBwsAwjLw5FGjzGHh3F2SFOsdvLGACbkhJdY90xn+T45BoGmP6fnCAAMAFc9p7GOZxNIPzVhASFNq3zu4oXjj3hHvrEwRTCABDZAGtA8VsSDX9YgXjrk/P2/HHR6NlpAzLJK7O2L7wisBrMI92DEhNmVkclGH8SOOQTQv224+uBWC4tCXHPPOtUNr9Yh0EZp6u/BsSkkdKft78cTmTDVQ97QvCDAAUAncHTczd9vKreasWkuY3RkUUnkoAMRMAAuwJrYE0JMzvPZN1s0EIJGokmYZPG9eE4gOqVOjk4Xt3KNCfQImifVJ66cXzsltxEhQvIq7YBm4NTqw396R4o8KvtbVa9YMVetAdiTFq8fdn3mMo3tM0b8MMACAOBS3Qt7w0uArVvcYb9RZ5LAikCawLpkirUmHLSE3puV9Zz2SXfqXGIxt3KNsTm76+oDQwJB/h9Kaq3mTZugaC6Kj21j5wxcGTeMYBFWZk0q8Z+Sgnp8OrFF1eQ+8LdcEwBBAxpX6g4x5HYE4sUee/1rAEMBYBn5h1arii2uDEz/MGJ1BCak90qQJrKBDArQxJT/823rnNo5BnNRctcPL5uS8A3tuHRzxh+VcqOoAnyCwhqD1WfOGP65aVcRIbPOmK7znhcuDhw2u9S5L57lXcBAMv8YRckNGzjzx17lFujfv2dP+JRqmZJq0jkJOebZ77dJuc3zeM3yLiLUPhiY2hRAbk+YPLpmX7FkAiEqOhmMQiELPGF+7715BdXMmx5oVSeZqc0JyTY/xxxPuz/3ho3jP8Drv7oitpM/gat5jGxCbsyL5PxtqfsgMquY9e9q/EDAAQAkojsH4xmOZV9u7zKm2ISQxFWsk0fvdxuJRD93y8E45mpEgIvCoAYU7+wV00PXAxEzwAe2DDYC689J9Nxm+kRm0S95zdficobXq5NQOvIcAFbCEWJcyfnb5E1s3ILEnKPdvBZgKCX5zMswTH8nMeHuLdW+fsHBcLUVHKnAdIa4TO8RyqAnqTxfWjd43os7pybMikNxWYaOgakwSH/TI+8bO6Fq+oLkq5lLhPYcMCA0IF+5i1qy5N+8JWZBru+Wqn7/R91c78p497fNtxqc5+Sst8DkGQfHM9UsvDa3tceWmrz/e/T/MIKIqc1KKG4t9wz+/O0AaSZ8gqGRTmEmHTIhNablx+abgbRwrCsS3j10QK2mqxd9J3jikVu3Tk4MvaPs6BYEZQqxLGzclFq7P40ZIYA9g/mWR3k86iLcHzqi6tmR+DMbJcfgLLw5eNmqANz1V1IoEJIjLLBqqNiDkok7niqNbMtOruUssBtHcDJ57bv2Q4/fLLA9ZXsD1Qb3yRQHI97qtF4bf6Y75v0R0q2t9qATY7dyrrHkT7eBPQaQpFottM5vxePwTl1DEYjGjalxlLf/0fP92gNl2w9vBVHVDywlMammvrxnbN9teZ+vGvAITQZBgMKAiDsu1GWPxfvedfRRHE6AENHZIH6y4zp51QF/3gq48Kymr8kUC2tNSL+oMHPa1BzLL0Vxyu/fs+39Tk7Qjp9npYDmT/ebFxVhjiAZtzZMvBAxoBjNBCEbelXgvad0IJCqJS67mPQsurTm2MZg7P5VjJRiSt/n3UKEAGcs6jf8+9TeZdv4aJMU/tXYhADz30oaakX2yV9jCN3K+wJqkM33MjFQXALxxdeikvft4R2kAq7daK465PzNvRy26g3YQ8XhcX3TRRftFIpErtNZg5nT//v3viMfj7g4Keae1jBkzxh46dOitlmWFtNZQSk37zW9+80H1fACyUspfTJs2rbib+f69AbMLjSOoCerpsQ1fGhrIXpPKaV0iumW3hqHqTZIreownTpuVadvJjS7NQoND9r1BQ1OqSCBiQJfzRRaJD5Ny82sf2HGOFcU/U5Mbi4HicXA2TwP7Bf27ah0feU9ASZ4DoAsAIpY3sW+ddzUAbMnIPwGYhwQEsGtwtre3l2p5pDwgEon8BzMjl8sVN2/efC8A9+PW5Pu+Y1nW98PhsKO1Ri6Xmw3gA8uyhlfmy2azfqFQ+BWA4v9bDfNRO/iAhuIv6i0yuwtCSQGBEtllRxB15im3rMv+LnOe0NwrXySpCeqNy0MX7VOjj0zmK4VR23LdbEuSH6asH16RSHUNj8E4meAzQM2x7Wb1o1zrqvMEM/j+c7RBlYJQ3QtQQvdQVmXZ1wxozalYDALdEIzdP0VBRG4+n/e5FGjaHAqFKBaLifb2dhoxYgSXecguyyyYWRARiLYzBCFEr/ls295pXDQa7VUJmUgk9I7zMzM1NzfvRD12sRaKxWJU2QC7aolEQn8mgGmNlszDC9HawxpD3lk9BdaCykG6kpLQYRvy3c3GnRNn93RwYrs5qbjR947pExkUSN/ueZqhBEFoaAIAUhGHZEe38ffDf33mDI4lRMUcEsCIf7x6rjpPx+PAtHFO5+qu3H1hk4SrpepIh3qANOJx6HOv0xoahtCAUCUQxj+BF8bMRERG+bv8xS9+kSUivSshJxKJbSS7vr4+D+DaYrEY0FpDa722rHlQmY+IDGbelQDV7tbT3NxM5TXwx5BuEY/HdRlEn7+GiSagmUGzTnM2bKnx1wwOYu9kEVoKiJIbTaIjJTqe7on8F8eyvcoPKm70okn5Hw5yMHhrQfhCsgEtSnWfxCh6Ah1p8wYgodC+PYA36/xg435hRxQVqCsPTHi0a8MOLjYB4PvPrK0/Yl8ZyiTBfojFCiPYOXXO0FsPGeBRzvPokbffzr5yZW29b8iQ9jJ9WFUUG4X/fFGfwQPrWLZv9PJNiczmbSAvt6ZdC8ucMmXKYRdeeGEeAAKBACul/CVLlnQkEgmvIqCy0L2xY8fONk1TAEA+n0+WQcK78cYoHo/r888//0giEsVikcPhsCWEaJ8xY0ZXNBqVRKQA8NSpU/trrfsUi0VorUkIwcFgkFzX7ZoxY8amylpGjx7tDB8+/IBsNhvYJVAMA93d3Ss/E8AQwNwMcdGLmzqfGls7ITiYXw2b2sz7YCKwFCTWpY3vxp/dmGsOQFJZqOX6YDWvvd/wYTWpq1OF0tMHrEt+tAarPiGSK7vlkyc9lJ1fMV2V+uMDw3zlIX1Tt6QKXAz0E9ZLkwIXnPJwfg6iEJSA4lIRL52yT+H5wSF1qA6Cky6tXrXWako0rV0YlsopaOLLTq7tP0QWL2kM+vFUno2sWzI+/QPu1xscb1mdDWkNkH8A8K2dXPnWVo2yKSEi+L6viaivbduv27ZdbWL4xBNPXHPkkUf+PB6PPzR69Gijra3NHzNmTM3QoUNXOo5Tr7WG53lHAniTiHYZVJ08ebKMx+Pe1KlTf1RTU3NboVCA4zjI5XLvJZPJ4yoa7Pzzzx/S0NBwpxDiNK112LbtCsh927YNKeWvANwUj8f11KlTT3Qc5yFm3i8UClG1aaw0KSWEEFHxmZGXODRHISc8m1y8ZKt5EUhIg9iNWBBrUvTKV1tTT3C09CzTdsZY8j4OCGfv7GMg6GrBxIKgAa3BJhFtzcrcB6nAzcwl01UJ+AJAOmM8mnVhmkJHwqYKDA765xHAiJbNJIFfvDR42MCQf7SvlBVxdMBXYl7iH7WbLOKwLZVhCzb9DYIdUhE7rMMBgx1fEZQmhAwt+wdUrR3WYcfQDQCAZaBrTxjY7ztH9x/wnaP7D4geu5ezCz6DYDBoVHogEDCIyBRC7F9XVzdjypQp17S1tflVYPIrHEZKuVuz0NLS4l166aVfC4VCt/m+75mmqTzP6yoUCmMeeeSRzhEjRvCUKVP27tev36vBYPBbRFTvOI4ZCoWMUChkOI7jhMNhQwhRUwZgrWmaj9u2PZyIyLIsGIaxyw5AfKakt5Jzongy8cq3Ij8+YRBu25onrE4Z1xOA6vRBBTzzm2pPHRIsnr2tmJwAkACDVY1FxpLN5j1fe6yng8dt5z1UfnqB4ukV717jLBhWw6ckc6xrLT6lNTqkDzWt7+LJMAGowY46L2IAPQWorozkTUmn5fTGrON6YF8QfB/cr8G112fst5jVE0XXP6RfUI1gBjoz5vqcopf7ZIRcn6bFgIe7XxsSueqwzkU1pq6XgvitTufcxEL8Qei8UXaBSSmVS6VSj2mt/TII+kspz2FmXSgU2HGcuydNmvTCww8//K5t26LMXVAeX23atnXf9yUAuuSSS/qGQqFZutRYCCFzudy3Z8yYsWry5MnmggUL+KCDDnrcNM2huVzOBSBd150DYBURMTMrrbVQSr1eBvfxlmUNLhQKipm7s9nsNVLKzRXzVV6HNgwDUspln7WXVCm8EhRP/eTN8yLvdXvoOn1OcjEDRNVllwBGjRplDg0vv9skoMACxACIwWAdMiE7kmLDiyudnXgPACwABAP8t4yYtXeYvqYVu/0cqj+grutMALPQCHXtmOF2SHQ05YrgGkOYa1LilWNnJtf8drzxJWgwaRLQpAwhI4fdn5oHYN7SK+yf7BXWIxhAd8F49fDpufOrr+vm0lxn6Ei97YcNkgiBTQDwiwqu61YA0/PAAw9cUT3u8ssvb7Jt+wmllOc4jmUYxhQAN+fzeeF5HoioF2AKhQJs2wYzQ2tNZS+JDcOYJYRozOfzBcdxnO7u7usffvjhP1188cVOS0tL4bLLLvuWaZrHpNNpT0opi8VidPr06XM+Sl5a6709z9MAZD6fX/Dggw/+/ot0q7ebJwYRpR6rkMRql3R+DJLi8Bd++90rh4b54O7qbDQTwMSSINYlze/+x1+3pm8dvJ33VNpJcSgC+J7V5rxBQa+r1qI61hpBQ58PYBbFoV+ftOGkfg4PzXvsWSTNLQWjhVGkh3wW4PKMDLAP5hgERoJW/BmOLh83CRa3QgKQSECVAF+LQqFARQCeEMiVt0BR+bBctyJgMXny5NrGxsbsxo0bqWxKWi+++OILHccZm81mWSl1cllgynVdqmiSCn/wfR/FYrGiYeQDDzzQc8EFF9xsmuY3UqlUMRgMOt3d3b+eOXPmvbFYzGhvb/cAQCl1Xj6fZ621mc/n/z5z5sw5Y8aMsXeUUT6fp7a2tkKhUOiRUgrP8xQzn3DBBRec4nne+oqGKfdNjz76aCoWi4nPBTAlVQeePxrG5v690wcxlB6znTluUMOQUE+s4HOvsktmqFobcnVS/vWrv0/P2on3VBPtVkhqSvactn9g9qCQf3mywKpG6NHzorX7nJ1Irq631CQLBA/C2JShDbNXOPOORZbvL5JiTaj0CsgBoP0KwVACDIZmMDVBcWvJ3ALA4sa1qSN7QidulNKwTBOrk7WrgQyKBV9ZxVJcTSkF13X9cv6HRo8eLWOxmFi5cuUfpJRjPc8jpVTj5MmTzYULF/p9+/bdZnqEKN2KYrEIy7JKWV2lUk1NTROI6PZ0Ou0JIayenp5n169f/51oNCrLHpcum58vMzMppbTWevi55567suxxVTassm1bZrPZ3wG4PZ1Ov6CU2mjbdqPv+wOJ6CXDMNxymEADYCnllqampvvj8fjPPjfAAMDJbTunD5pbQdQEtfiC9E8Hhbjvlnwp6rKNjQsg7RG/l7JvImSxu7LLSg3N5qzx0OCQulyz1v0D7OwbccdMHjVqesj4x5npotYRW4h1WfnYHX/dmgYAJYjB2PawUrG3jq76vstrqgSyb28/kiqZKq3Z87xtgjdNc6dA2cSJE7NSSvi+D9/3xYoVKyQAVEwSM0MptU3DeJ5XAaCntb4agFksFouWZVE6nX66ra3Nnzx5sgmU7vMxxxxjua4bqsxpGEbItu39d+RFpmlCKbUPAMydO3frWWedFdVa/15KObgMWqtMxqGUgud5QxzHuX38+PHFzxUwH5U+eKGp/qC9QsXLk0XuVbLJDL/WIWNpl/jdGXO6Fn5cNrqp5DoTUfr11ZOdt/sHcIjWQFDizPMPfLdrYIBqegpSdeeFvzYZ+C2Qr1qMAOlS723UDUD7AEr5Ly4VovfyM5dGYVkDS8fuLB6hW1oWeTuSVGaWlUhsOp2WZaGOqATgiGhrW1tb4aijjopUj91RuOXPoO/7UwuFwp8Nwxjiuq4fDAannX322e+0tLS8UnHRFy5cWJg4cWI3Mw8qu/hdvu//A+j1IJ9SSklmXlL2ksyWlpZXTzvttEP69OkzipnJ930qa6mBUsobpJQjXdeFEOLWLxQwADB69GhjaHDRPXW2NsrcpfICIbYlxIc5Si1LOt9jzlJz8ydIsjVDAvCTBXPW0JB7R6qgdIAwekgAB+eLWkUMyNUZmn9Goqu9Er9BuVaCyr23giEqHWNILmXDJfXWNQclqnNEi3e5Nx599NFU1d/q7LPPrhNCXKiUUmXOsKS8i43dRWLLoAnMnTt35bhx475lGMYr5fNtx3GePOuss4555plnVkejUSuRSLjMvEgIMYKZhe/7HU8++eRJH+eml0HTBeDFHX8fN27cCtM0/+r7vhJCDDC+UO0Sh5434e8HDQ6pUyvpg+qbGrTIWNYjfnbe01s3NDbDiH+C13I0lw3H8qTx+wGOd5sjhWMThUO2Duc9UoYgbM6ZLUAey9rL2swFmAm63FGo8oIUFwmkMy64r6W++vyEuhOnvln7RigU0u3t7e4NxwwJNO2b/GGNUEHLEGrx5tDD5z63aSkpVa2qrGg0eorWuiCEEFrrOiL6gWEYg3zfLwohbAAPlSOoH5/aIPLHjRvXMHfu3NfGjRt3fTgcnlYsFoumafYPBALzvvnNbx7f2dmZB0DMPIOZL9Jau4ZhHDphwoSrt2zZ8pvquM+uQPNRv0kpD6rElrTW+S9Ow8RLnsivXhdrNmblW/tF+PCtBfiSYCiGilgs16Tk6gc2NPySY5leVXi7nbYcMKRE97oVk0Iv9q3B2J4iXFeDHEnGxozcOHtL4BlCCu1VGWdm0syCwaLXdXK++BtBCKXZtQUaDq13X1pyxtYNa3PJBw9tx3/uX+PVNAbUd4fVsABpvJ8rvAZgqZRMRKSUUhpAvRDipQqBNQwDzAzP87xgMGhns9nZTz311EsA4LquKmfCVXVKoPxZWZsKhUKVlMJ948ePPzwUCl1aKBRylmUdrJR6tK2t7Ztlovry+PHjf1tTU3NJoVBQhmHc169fv6snTJjQVZnLNE3pum5i9uzZ944dO/ZLwWDwTi6psh1DvAEiOsH3fc+2bTOfzz8vvii8EMDNAK77Y1fqlU7jnM68XN/gwADAIQPSY0mrM9a1M9s6Cmj/dE8vLugs1fNtKtJvDUkibMEOGLDCQRIZJX5314ubsjoGY1n53TDSYAqZZNSYJAMGbCFYVIKJv3v3gOeXd8tn+gTIsiRQa2uzrlYNC1veUAAIl1y6gqsYvmJQ6aVJ0JpN0zSlaZqmZVlCSolKJyIIIWCappnL5Z4lootjsZgoEwoCUFceK5nZKLvbZtWxOtd1KR6P62g0Kt95550r8/n8wkAgEFRKIRKJnDVhwoRHTj/9dCsajcpcLndlNpt9XJYaAoHAl8Ph8PHhcPj4UCj01ZqamuMNwzisfJ3GYDB4ZjAYHFv+rO6nlP4dyywUCss8z7v+C+Uw8Th06SH7no6nzqkbe2QD3S+FPqLgo/O9HuP2rye6nyubrk9VGHVyW6nE8qq/B/4cOiL7eFhSWDG0zBGtSdszgDQ1A7q5GRyPA1qK5LqMmNMl2SgwqWTeSQNpYAT4wcQir2XRiIlLLv7g2oj0jst5oFqXREdSLgaA96RXGFmQc/M+aoQgZPK8HgBYYpXneXcppZh5+3v+KhpDCKFc131j9uzZT1UyAgAQDoeLAP7Ldd1w2TvaUOYuq4vF4t3l8dlgMFisqsFx999//297nne11pozmQybphk0TXNQIpFYU67DOW/ChAlPSim/7vu+WUW2tVJKMPNLZcCszefz03eMMlelLYTWek1nZ+ev29ratvwv6K+zJV8FcMkAAAAASUVORK5CYII=" width="140" height="38" alt="vit:bikes" class="hidden md:block">
                        <div class="w-8 h-8 bg-vit-orange rounded flex items-center justify-center md:hidden">
                            <span class="text-white font-bold text-lg">V</span>
                        </div>
                    </div>
                    <span class="text-gray-400 topnav-desktop">|</span>
                    <div class="topnav-desktop">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-semibold text-gray-700" id="locationDisplay">Standort</span>
                            <span id="premiumBadge" class="hidden"></span>
                        </div>
                        <span class="text-xs text-gray-500" id="userRoleDisplay">Partnerportal</span>
                    </div>
                    <!-- Mobile: compact location -->
                    <div class="topnav-mobile" style="display:none;">
                        <div>
                            <span class="text-xs font-semibold text-gray-700" id="locationDisplayMobile">Standort</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 md:space-x-6">
                    <!-- Language Switcher -->
                    <div class="flex items-center space-x-1">
                        <button onclick="switchLang('de')" class="lang-flag text-lg hover:scale-125 transition-transform" title="Deutsch" data-lang="de">ðŸ‡©ðŸ‡ª</button>
                        <button onclick="switchLang('en')" class="lang-flag text-lg hover:scale-125 transition-transform opacity-40" title="English" data-lang="en">ðŸ‡¬ðŸ‡§</button>
                        <button onclick="switchLang('nl')" class="lang-flag text-lg hover:scale-125 transition-transform opacity-40" title="Nederlands" data-lang="nl">ðŸ‡³ðŸ‡±</button>
                    </div>

                    <button onclick="showView('notifications'); return false;" class="relative">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <span class="absolute -top-1 -right-1 bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </button>
                    
                    <div class="flex items-center space-x-3 topnav-desktop">
                        <img src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                        <div>
                            <div class="text-sm font-semibold text-gray-800" data-user-name>Demo User</div>
                            <div class="text-xs text-gray-500" id="userRoleText">Rolle</div>
                        </div>
                    </div>
                    
                    <button onclick="handleLogout()" class="text-gray-600 hover:text-vit-orange topnav-desktop">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex" style="height: calc(100vh - 3.5rem); overflow: hidden;">
            <!-- Sidebar Overlay (mobile) -->
            <div id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
            <!-- Sidebar -->
            <aside id="sidebarNav" class="sidebar w-64 text-white overflow-y-auto flex-shrink-0">
                <div class="p-4 pt-5">
                        <!-- HQ/Standort Toggle entfernt - Umschaltung erfolgt automatisch per Rolle -->
                        <div id="hqToggleSection" class="hidden"></div>

                        <!-- Partner-level quick access (hidden in HQ mode) -->
                        <div id="partnerQuickNav">
                        <!-- Startseite -->
                        <button onclick="showView('home'); loadDashboardWidgets();" data-module="startseite" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            <span data-i18n="nav_home">Startseite</span>
                        </button>

                        <!-- Kalender -->
                        <button onclick="showView('kalender')" data-module="kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span data-i18n="nav_calendar">Kalender</span>
                        </button>

                        <!-- Aufgaben -->
                        <button onclick="showView('todo')" data-module="aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            <span data-i18n="nav_todo">Aufgaben</span>
                            <span class="ml-auto bg-red-500 text-white text-[10px] rounded-full px-1.5 py-0.5 font-bold" id="todoSidebarBadge">5</span>
                        </button>

                        <!-- Kommunikation -->
                        <button onclick="showView('kommunikation')" data-module="kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            <span data-i18n="nav_communication">Kommunikation</span>
                        </button>

                        <hr class="border-gray-600 my-3">
                        </div>

                        <!-- Dashboards - nur fÃ¼r INHABER (jetzt in Allgemein integriert) -->
                        <div id="ownerDashboards" class="hidden">
                            <button onclick="showView('dashboards')" data-module="dashboards" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span data-i18n="nav_dashboards">Dashboards</span>
                            </button>
                        </div>

                        <!-- Fachbereiche - nur Partner-Modus -->
                        <div id="commonTools">
                            <!-- Allgemein -->
                            <button onclick="showView('allgemein')" data-module="allgemein" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                <span data-i18n="nav_general">Allgemein</span>
                            </button>

                            <!-- Verkauf -->
                            <button onclick="showView('verkauf')" data-module="verkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                <span data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <!-- Einkauf -->
                            <button onclick="showView('einkauf')" data-module="einkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                <span data-i18n="nav_purchasing">Einkauf</span>
                            </button>

                            <!-- Marketing -->
                            <button onclick="showView('marketing')" data-module="marketing" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                                <span data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <!-- Controlling -->
                            <button onclick="showView('controlling')" data-module="controlling" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span data-i18n="nav_controlling">Controlling</span>
                            </button>
                        </div>

                        <!-- Tools - alle Standort-Rollen -->
                        <div id="partnerToolsNav">
                        <hr class="border-gray-600 my-3">

                        <button onclick="showView('wissen')" data-module="wissen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            <span>Wissen</span>
                        </button>
                        <button onclick="showView('support')" data-module="support" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span>Support</span>
                        </button>
                        <button onclick="showView('ideenboard')" data-module="ideenboard" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                            <span>Ideenboard</span>
                        </button>
                        <button onclick="showView('shop')" data-module="shop" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                            <span>Werbemittel-Shop</span>
                        </button>
                        <button onclick="showView('aktenschrank')" data-module="aktenschrank" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                            <span>Aktenschrank</span>
                        </button>
                        </div>

                        <div id="onboardingNavSection">
                        <hr class="border-gray-600 my-3">
                        <button onclick="showView('onboarding')" data-module="onboarding" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                            <span data-i18n="nav_onboarding">Onboarding</span>
                        </button>
                        </div>

                        <!-- Mitarbeiter - nur GeschÃ¤ftsleitung -->
                        <div id="mitarbeiterNavSection">
                        <button onclick="showView('mitarbeiter')" data-module="mitarbeiter" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span>Mitarbeiter</span>
                        </button>
                        </div>

                        <!-- HQ-specific items (hidden by default) -->
                        <div id="hqMenu" class="space-y-2 hidden">
                            <!-- HQ Top-Level -->
                            <button onclick="showView('hqCockpit')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_cockpit">Netzwerk-Cockpit</span>
                            </button>

                            <button onclick="showView('hqKommando')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_command">Kommandozentrale</span>
                            </button>

                            <button onclick="showView('hqAktionen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <span data-i18n="nav_hq_actions">Handlungsbedarf</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('kalender')" data-module="kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <span data-i18n="nav_calendar">Kalender</span>
                            </button>
                            <button onclick="showView('todo')" data-module="aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                <span data-i18n="nav_todo">Aufgaben</span>
                            </button>
                            <button onclick="showView('kommunikation')" data-module="kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                <span data-i18n="nav_communication">Kommunikation</span>
                            </button>

                            <hr class="border-gray-600 my-4">
                            <div class="mb-2">
                                <span class="text-xs text-gray-400 uppercase font-semibold px-3" data-i18n="nav_hq_control">HQ Steuerung</span>
                            </div>

                            <button onclick="showView('hqStandorte')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span data-i18n="nav_hq_locations">Standorte</span>
                            </button>

                            <button onclick="showView('hqFinanzen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_finance">Finanzen</span>
                            </button>

                            <button onclick="showView('hqMarketing')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                                </svg>
                                <span data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <button onclick="showView('hqEinkauf')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/>
                                </svg>
                                <span data-i18n="nav_purchasing">Einkauf</span>
                            </button>

                            <button onclick="showView('hqVerkauf')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                <span data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <button onclick="showView('hqAuswertung')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span data-i18n="nav_hq_analytics">Nutzung Portal</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqWissen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                <span data-i18n="nav_knowledge">Wissen</span>
                            </button>

                            <button onclick="showView('hqSupport')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                <span data-i18n="nav_support">Support</span>
                            </button>

                            <button onclick="showView('hqIdeen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                <span data-i18n="nav_ideaboard">Ideenboard</span>
                            </button>

                            <button onclick="showView('hqShop')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                                <span data-i18n="nav_shop">Werbemittel-Shop</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqEinstellungen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span>Einstellungen</span>
                            </button>

                            <button onclick="showView('hqModulStatus')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                <span>Modul-Ãœbersicht</span>
                            </button>
                        </div>
                    </nav>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content-area flex-1 overflow-y-auto p-4 md:p-8 vit-background" style="min-height: 0;">
                <!-- Startseite View (fÃ¼r ALLE) -->
                <div id="homeView" class="view" style="display: block;">
                    <!-- Header mit Willkommen + Dashboard anpassen -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800"><span id="welcomeText" data-i18n="welcome">Willkommen zurÃ¼ck!</span> ðŸ‘‹</h1>
                            <p class="text-gray-600" id="welcomeDate"></p>
                        </div>
                        <button onclick="toggleDashboardEdit()" class="flex items-center space-x-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-vit-orange hover:text-vit-orange transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="font-semibold" id="dashboardEditButton">Dashboard anpassen</span>
                        </button>
                    </div>

                    <!-- FESTER BEREICH (immer sichtbar) -->
                    <div class="mb-8">
                        <!-- Schnellzugriff Aktionen -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <button onclick="showView('verkauf')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-vit-orange p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Neuer Lead</p>
                            </button>
                            
                            <button onclick="showView('verkauf'); showVerkaufTab('pipeline')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-blue-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Angebot erstellen</p>
                            </button>
                            
                            <button onclick="showView('support')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-green-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Support anfragen</p>
                            </button>
                            
                            <button onclick="showView('wissen')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-purple-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Wissen</p>
                            </button>
                        </div>

                        <!-- Kern-Metrik: Umsatz -->
                        <div class="vit-card p-6" id="dashUmsatzCard">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ & ERGEBNIS</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Letzte BWA</p>
                                    <p class="text-3xl font-bold text-gray-800" id="dashUmsatzWert">â€”</p>
                                    <p class="text-xs text-gray-500 mt-1" id="dashUmsatzLabel">Lade Daten...</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Rohertrag</p>
                                    <p class="text-3xl font-bold text-gray-800" id="dashRohertragWert">â€”</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" id="dashRohertragBar" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs text-blue-600 font-semibold" id="dashRohertragPct">â€”</span>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Gesamtkosten</p>
                                    <p class="text-3xl font-bold text-gray-800" id="dashKostenWert">â€”</p>
                                    <p class="text-xs text-gray-500 mt-1" id="dashKostenLabel"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Ergebnis</p>
                                    <p class="text-3xl font-bold text-green-600" id="dashErgebnisWert">â€”</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" id="dashErgebnisBar" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs font-semibold" id="dashErgebnisPct">â€”</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WIDGET-BEREICH (anpassbar) -->
                    <div class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Meine Widgets</h2>
                    </div>

                    <div id="widgetContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Widget 1: Verkaufs-Pipeline -->
                        <div class="dashboard-widget vit-card p-6" data-widget="pipeline">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“ˆ Meine Pipeline</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Offene Leads</span>
                                    <span class="font-bold text-blue-600">23</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Heute Termine</span>
                                    <span class="font-bold text-purple-600">8</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Angebote offen</span>
                                    <span class="font-bold text-orange-600">5</span>
                                </div>
                            </div>
                            <button onclick="showView('verkauf')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zur Pipeline
                            </button>
                        </div>

                        <!-- Widget 2: Verkaufserfolg KW -->
                        <div class="dashboard-widget vit-card p-6" data-widget="success">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ’° Verkaufserfolg <span id="dashKwLabel">KW</span></h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="mb-3">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm text-gray-600">Verkaufsquote</span>
                                    <span class="text-2xl font-bold text-green-600">42%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 42%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <p class="text-gray-500">VerkÃ¤ufe</p>
                                    <p class="font-bold text-gray-800">5</p>
                                </div>
                                <div>
                                    <p class="text-gray-500">Beratungen</p>
                                    <p class="font-bold text-gray-800">12</p>
                                </div>
                            </div>
                        </div>

                        <!-- Widget 3: Termine Heute -->
                        <div class="dashboard-widget vit-card p-6" data-widget="termine">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“… Termine Heute</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <p class="text-sm font-semibold text-gray-800">10:00 - Familie Schmidt</p>
                                    <p class="text-xs text-gray-600">E-Bike Beratung</p>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <p class="text-sm font-semibold text-gray-800">14:30 - Herr MÃ¼ller</p>
                                    <p class="text-xs text-gray-600">Probefahrt Lastenrad</p>
                                </div>
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <p class="text-sm font-semibold text-gray-800">16:00 - Frau Weber</p>
                                    <p class="text-xs text-gray-600">Abholung</p>
                                </div>
                            </div>
                        </div>

                        <!-- Widget 4: Offene Aufgaben -->
                        <div class="dashboard-widget vit-card p-6" data-widget="aufgaben">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">âœ… Offene Aufgaben</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded border-gray-300">
                                    <span class="text-sm text-gray-700">Google My Business optimieren</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded border-gray-300">
                                    <span class="text-sm text-gray-700">Angebot Herr Schmidt nachfassen</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" class="rounded border-gray-300">
                                    <span class="text-sm text-gray-700">Onboarding-Schulung abschlieÃŸen</span>
                                </div>
                            </div>
                            <button onclick="showView('onboarding')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Alle Aufgaben
                            </button>
                        </div>

                        <!-- Widget 5: Marketing Kampagnen -->
                        <div class="dashboard-widget vit-card p-6" data-widget="marketing">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“¢ Aktive Kampagnen</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange">
                                    <p class="text-sm font-semibold text-gray-800">ðŸš€ FrÃ¼hjahrs-Aktion</p>
                                    <p class="text-xs text-gray-600">LÃ¤uft noch 12 Tage</p>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                    <p class="text-sm font-semibold text-gray-800">ðŸŽ¯ E-Bike Wochen</p>
                                    <p class="text-xs text-gray-600">Startet in 5 Tagen</p>
                                </div>
                            </div>
                            <button onclick="showView('marketing')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Marketing
                            </button>
                        </div>

                        <!-- Widget 6: Team Performance -->
                        <div class="dashboard-widget vit-card p-6" data-widget="team">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ† Top VerkÃ¤ufer</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-2xl">ðŸ¥‡</span>
                                        <span class="text-sm font-semibold text-gray-800">Sarah</span>
                                    </div>
                                    <span class="text-sm text-gray-600">12 VerkÃ¤ufe</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-2xl">ðŸ¥ˆ</span>
                                        <span class="text-sm font-semibold text-gray-800">Michael</span>
                                    </div>
                                    <span class="text-sm text-gray-600">10 VerkÃ¤ufe</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-2xl">ðŸ¥‰</span>
                                        <span class="text-sm font-semibold text-gray-800">Benny</span>
                                    </div>
                                    <span class="text-sm text-gray-600">8 VerkÃ¤ufe</span>
                                </div>
                            </div>
                        </div>

                        <!-- Widget 7: Controlling -->
                        <div class="dashboard-widget vit-card p-6" data-widget="controlling">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“Š Budget-Status</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Marketing</span>
                                        <span class="text-sm font-semibold">75%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 75%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Personal</span>
                                        <span class="text-sm font-semibold">92%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-orange-500 h-2 rounded-full" style="width: 92%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Lager</span>
                                        <span class="text-sm font-semibold">58%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 58%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Widget 8: Support Tickets -->
                        <div class="dashboard-widget vit-card p-6" data-widget="support">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸŽ¯ Support Tickets</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="text-center py-4">
                                <p class="text-4xl font-bold text-green-600">2</p>
                                <p class="text-sm text-gray-600 mt-1">Offene Tickets</p>
                                <div class="mt-3 space-y-2">
                                    <div class="text-xs text-left p-2 bg-yellow-50 rounded">
                                        <p class="font-semibold">Kassensystem Frage</p>
                                        <p class="text-gray-600">Offen seit 2 Tagen</p>
                                    </div>
                                </div>
                            </div>
                            <button onclick="showView('support')" class="mt-2 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Support
                            </button>
                        </div>

                        <!-- Widget 9: Wissens-Updates -->
                        <div class="dashboard-widget vit-card p-6" data-widget="wissen">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“š Neue Inhalte</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <div class="p-2 bg-purple-50 rounded">
                                    <p class="text-sm font-semibold text-gray-800">ðŸŽ“ Neue Schulung</p>
                                    <p class="text-xs text-gray-600">E-Bike Antriebstechnik 2026</p>
                                </div>
                                <div class="p-2 bg-blue-50 rounded">
                                    <p class="text-sm font-semibold text-gray-800">ðŸ“„ Produktinfo</p>
                                    <p class="text-xs text-gray-600">Haibike 2026 Katalog</p>
                                </div>
                            </div>
                            <button onclick="showView('allgemein');showAllgemeinTab('wissen')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Wissen
                            </button>
                        </div>

                        <!-- Widget 10: Nachrichten HQ -->
                        <div class="dashboard-widget vit-card p-6" data-widget="nachrichten">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“¬ Nachrichten HQ</h3>
                                <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange">
                                    <p class="text-sm font-semibold text-gray-800">ðŸš€ FrÃ¼hjahrs-Kampagne live!</p>
                                    <p class="text-xs text-gray-600">vor 2 Stunden</p>
                                </div>
                                <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                    <p class="text-sm font-semibold text-gray-800">ðŸ“š Neue Schulung verfÃ¼gbar</p>
                                    <p class="text-xs text-gray-600">gestern</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Widget hinzufÃ¼gen Panel (versteckt bis Edit-Modus) -->
                    <div id="widgetAddPanel" class="hidden mt-6 vit-card p-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Widget hinzufÃ¼gen</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="addWidget('pipeline')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Pipeline
                            </button>
                            <button onclick="addWidget('success')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Verkaufserfolg
                            </button>
                            <button onclick="addWidget('termine')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Termine
                            </button>
                            <button onclick="addWidget('aufgaben')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Aufgaben
                            </button>
                            <button onclick="addWidget('marketing')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Marketing
                            </button>
                            <button onclick="addWidget('team')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Team
                            </button>
                            <button onclick="addWidget('controlling')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Controlling
                            </button>
                            <button onclick="addWidget('support')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Support
                            </button>
                            <button onclick="addWidget('wissen')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Wissen
                            </button>
                            <button onclick="addWidget('nachrichten')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Nachrichten
                            </button>
                        </div>
                    </div>
                </div> <!-- END homeView -->

                <!-- CRM View -->
                <div id="verkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_sales">VERKAUF</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showVerkaufTab('woche')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="woche">Wochenansicht</button>
                            <button onclick="showVerkaufTab('pipeline')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="pipeline">Pipeline</button>
                            <button onclick="showVerkaufTab('auswertung')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="auswertung">Auswertung</button>
                            <button onclick="showVerkaufTab('vkWissen')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="vkWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Wochenansicht ===== -->
                    <div id="vkTabWoche" class="vk-tab-content">
                        <!-- Week Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <button onclick="changeWeek(-1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â—€</button>
                                <h2 class="text-lg font-semibold text-gray-800" id="weekTitle">KW 7 Â· 10.02. - 15.02.2026</h2>
                                <button onclick="changeWeek(1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â–¶</button>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="openVerkaufEntryModal()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Eintragen</button>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">Monatsziel</p>
                                    <p class="font-bold text-gray-800">77.734 â‚¬</p>
                                </div>
                                <select id="weekSellerFilter" onchange="renderWeekViewFromDb()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="all">Alle Verkaeufer</option>
                                    <option value="Sandra">Sandra</option>
                                    <option value="Thomas">Thomas</option>
                                    <option value="Dirk">Dirk</option>
                                    <option value="Max">Max</option>
                                </select>
                            </div>
                        </div>

                        <!-- Week Summary KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Plan Termine</p><p class="text-2xl font-bold text-gray-800" id="wkPlan">25</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Beratungen IST</p><p class="text-2xl font-bold text-blue-600" id="wkGesamt">4</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Verkauft</p><p class="text-2xl font-bold text-green-600" id="wkVerkauft">1</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Umsatz KW</p><p class="text-2xl font-bold text-vit-orange" id="wkUmsatz">17.056 â‚¬</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">VK-Quote</p><p class="text-2xl font-bold" id="wkQuote">25%</p></div>
                        </div>

                        <!-- Seller Tables -->
                        <div id="weekSellerTables" class="space-y-6"></div>
                    </div>

                    <!-- ===== TAB 2: Pipeline ===== -->
                    <div id="vkTabPipeline" class="vk-tab-content" style="display:none;">
                        <!-- Pipeline Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <select id="pipelineFilter" onchange="renderPipeline()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="all">Alle Verkaeufer</option>
                                    <option value="Sandra">Sandra</option>
                                    <option value="Dirk">Dirk</option>
                                    <option value="Thomas">Thomas</option>
                                    <option value="Max">Max</option>
                                </select>
                            </div>
                            <button onclick="showNewLeadModal()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm hover:opacity-90">+ Neuer Lead</button>
                        </div>

                        <!-- Kanban Board -->
                        <div class="flex space-x-4 overflow-x-auto pb-4" id="kanbanBoard">
                            <!-- Columns rendered by JS -->
                        </div>

                        <!-- New Lead Modal -->
                        <div id="newLeadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">Neuer Lead</h3>
                                    <button onclick="document.getElementById('newLeadModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                                </div>
                                <div class="space-y-3">
                                    <input id="leadName" type="text" placeholder="Kundenname" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <select id="leadType" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option>E-Bike Trekking</option><option>E-Bike City</option><option>E-Bike MTB</option>
                                        <option>E-Bike Cargo</option><option>Rennrad</option><option>MTB</option>
                                        <option>Kinder</option><option>Zubehoer</option><option>Werkstatt</option>
                                    </select>
                                    <select id="leadSeller" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option>Sandra</option><option>Thomas</option><option>Dirk</option><option>Max</option>
                                    </select>
                                    <input id="leadValue" type="number" placeholder="Geschaetzter Wert (â‚¬)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <textarea id="leadNotes" placeholder="Notizen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="2"></textarea>
                                    <button onclick="addNewLead()" class="w-full bg-vit-orange text-white py-2 rounded-lg font-semibold hover:opacity-90">Lead anlegen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 3: Auswertung ===== -->
                    <div id="vkTabAuswertung" class="vk-tab-content" style="display:none;">
                        <!-- Year KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Jahresumsatz Plan</p><p class="text-2xl font-bold text-gray-800" id="ausJahresPlan">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz IST (YTD)</p><p class="text-2xl font-bold text-vit-orange" id="ausUmsatzYTD">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Verkaeufe gesamt</p><p class="text-2xl font-bold text-green-600" id="ausVerkauft">0</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">VK-Quote YTD</p><p class="text-2xl font-bold text-blue-600" id="ausQuote">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Ã˜ Verkaufspreis</p><p class="text-2xl font-bold text-purple-600" id="ausAvgPreis">â€”</p></div>
                        </div>

                        <!-- Umsatz-Verlauf Chart -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz-Verlauf 2026</h2>
                            <div id="ausChartContainer" class="w-full" style="height:200px;position:relative;"></div>
                        </div>

                        <!-- Monthly Overview Table -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Monatsuebersicht 2026</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50">
                                        <th class="text-left py-2.5 px-3 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Beratungen</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Verkauft</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">VK-Quote</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Umsatz</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Ã˜ Preis</th>
                                    </tr></thead>
                                    <tbody id="jahresTabelle"><tr><td colspan="6" class="text-center py-6 text-gray-400">Lade Daten...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Top Sellers -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Verkaeufer-Ranking 2026</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="ausRanking">
                                <p class="text-sm text-gray-400 col-span-4 text-center py-4">Noch keine Daten erfasst.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="vkTabVkWissen" class="vk-tab-content" style="display:none;"></div>
                </div>

                <!-- MARKETING View -->
                <!-- ===== DASHBOARDS VIEW (Finanzen, Marketing PRO, Team als Tabs) ===== -->
                <div id="dashboardsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_dashboards">DASHBOARDS</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showDashboardTab('finanzen')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="finanzen">Finanzen</button>
                            <button onclick="showDashboardTab('leadreporting')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="leadreporting">Marketing <span class="premium-badge ml-1 text-[8px] px-1.5 py-0.5">PRO</span></button>
                            <button onclick="showDashboardTab('team')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="team">Team</button>
                        </nav>
                    </div>

                    <!-- Tab: Finanzen (initially visible, content injected from old financesView) -->
                    <div id="dashTabFinanzen" class="dash-tab-content"></div>

                    <!-- Tab: Lead Reporting / Marketing PRO -->
                    <div id="dashTabLeadreporting" class="dash-tab-content" style="display:none;"></div>

                    <!-- Tab: Team -->
                    <div id="dashTabTeam" class="dash-tab-content" style="display:none;"></div>
                </div>

                <div id="leadReportingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_leadreporting">LEAD REPORTING</h1>
                    
                    <!-- Header with filters -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">â— Live-Daten</span>
                            <span class="text-sm text-gray-600">167 Leads in 2026</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <option>Jahr (YTD)</option>
                                <option>Q1</option>
                                <option>Q2</option>
                            </select>
                        </div>
                    </div>

                    <!-- 4 KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Jahresziel</span>
                                <span class="text-vit-orange text-xl">ðŸŽ¯</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">3,602.5</div>
                            <div class="text-xs text-gray-500 mt-1">Leads gesamt</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ziel YTD (2 Mon.)</span>
                                <span class="text-blue-500 text-xl">ðŸ“ˆ</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">422.7</div>
                            <div class="text-xs text-gray-500 mt-1">Soll bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ist YTD</span>
                                <span class="text-red-500 text-xl">âš ï¸</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">167.0</div>
                            <div class="text-xs text-gray-500 mt-1">Erreicht bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Performance</span>
                                <span class="text-purple-500 text-xl">%</span>
                            </div>
                            <div class="text-3xl font-bold text-red-500">40%</div>
                            <div class="text-xs text-gray-500 mt-1">Zielerreichung</div>
                        </div>
                    </div>

                    <!-- Monthly Chart -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Monatliche Uebersicht</h2>
                        <div class="flex items-center space-x-4 mb-4">
                            <div id="monthlyChart" style="width:100%; height:280px; position:relative;">
                                <div class="flex items-end justify-between h-64 px-2" id="chartBars"></div>
                                <div class="flex justify-between px-2 mt-2 text-xs text-gray-500" id="chartLabels"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-center space-x-6 text-sm text-gray-500">
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-gray-300 rounded inline-block"></span><span>Soll</span></span>
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-vit-orange rounded inline-block"></span><span>Ist</span></span>
                        </div>
                    </div>

                    <!-- Detail Table -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Detailansicht</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-2 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Soll</th>
                                        <th class="text-right py-3 px-2 font-semibold text-green-600">Termine</th>
                                        <th class="text-right py-3 px-2 font-semibold text-purple-600">â‚¬/Termin</th>
                                        <th class="text-right py-3 px-2 font-semibold text-blue-600">SV (x0.25)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-orange-600">SV (Roh)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-800">Gesamt</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Differenz</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Performance</th>
                                        <th class="text-center py-3 px-2 font-semibold text-gray-600">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="detailTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Marketing View (HauptmenÃ¼) -->
                <div id="marketingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_marketing">MARKETING</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showMarketingTab('kampagnen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="kampagnen">
                                Kampagnen
                            </button>
                            <button onclick="showMarketingTab('social')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="social">
                                Social Media
                            </button>
                            <button onclick="showMarketingTab('content')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="content">
                                Content Library
                            </button>
                            <button onclick="showMarketingTab('analytics')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="analytics">
                                Analytics
                            </button>
                            <button onclick="showMarketingTab('mktStrategie')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktStrategie">
                                ðŸ“‹ Strategie
                            </button>
                            <button onclick="showMarketingTab('mktWissen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktWissen">
                                ðŸ“š Wissen
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Contents -->
                    <div id="marketingTabKampagnen" class="marketing-tab-content">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Aktuelle Kampagnen</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                                    <div>
                                        <h3 class="font-semibold text-gray-800">Fruehjahrs-Aktion 2026</h3>
                                        <p class="text-sm text-gray-600">E-Bike Fruehlings-Angebote mit 15% Rabatt</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Aktiv</span>
                                        <p class="text-xs text-gray-500 mt-1">Noch 12 Tage</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div>
                                        <h3 class="font-semibold text-gray-800">E-Bike Wochen</h3>
                                        <p class="text-sm text-gray-600">Testtage und Probefahrt-Events</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Geplant</span>
                                        <p class="text-xs text-gray-500 mt-1">Startet in 5 Tagen</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <div>
                                        <h3 class="font-semibold text-gray-800">Winter-Werkstatt-Aktion</h3>
                                        <p class="text-sm text-gray-600">Inspektion + Wintercheck zum Sonderpreis</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600">Beendet</span>
                                        <p class="text-xs text-gray-500 mt-1">31. Jan beendet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="marketingTabSocial" class="marketing-tab-content" style="display:none;">

                        <!-- Motivation Header -->
                        <div class="vit-card p-5 mb-6 bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800" data-i18n="lh_title">ðŸŽ¬ Local Hero â€“ Content Strategie</h2>
                                    <p class="text-sm text-gray-600 mt-1">Dreh ein kurzes Video, lade es hoch â€“ wir machen den Rest! Schnitt, Untertitel &amp; Posting Ã¼bernimmt das HQ.</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-vit-orange" id="smScoreNumber">4</div>
                                    <div class="text-[10px] text-gray-500 uppercase" data-i18n="lbl_videos_shot">Videos gedreht</div>
                                </div>
                            </div>
                            <!-- Progress -->
                            <div class="mt-3 flex items-center space-x-3">
                                <div class="flex-1 bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-vit-orange to-yellow-400 h-3 rounded-full transition-all" id="smProgressBar" style="width:8%"></div>
                                </div>
                                <span class="text-xs font-bold text-gray-600" id="smProgressText">4 / 50 Themen</span>
                            </div>
                            <div class="flex items-center space-x-4 mt-3">
                                <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-semibold" data-i18n="lbl_streak">ðŸ”¥ Streak: 2 Wochen</span>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold" data-i18n="lbl_rank">ðŸ† Rang 5 von 21</span>
                                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-semibold" data-i18n="lbl_next_badge">â­ Naechstes Badge: 5 Videos</span>
                            </div>
                        </div>

                        <!-- Sub-Navigation Pills -->
                        <div class="flex space-x-2 mb-5 flex-wrap gap-y-2">
                            <button onclick="switchSmSub('kanaele')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-vit-orange text-white" data-smsub="kanaele" data-i18n="sm_channels">ðŸ“± Unsere Kanaele</button>
                            <button onclick="switchSmSub('themen')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="themen" data-i18n="sm_topics">ðŸŽ¬ Themen-Auftraege</button>
                            <button onclick="switchSmSub('upload')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="upload" data-i18n="sm_upload">ðŸ“¤ Video hochladen</button>
                            <button onclick="switchSmSub('ranking')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ranking" data-i18n="sm_ranking">ðŸ“Š Netzwerk-Ranking</button>
                            <button onclick="switchSmSub('ablauf')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ablauf" data-i18n="sm_howto">â„¹ï¸ So funktioniert's</button>
                        </div>

                        <!-- SUB: Unsere KanÃ¤le -->
                        <div id="smSubKanaele" class="sm-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                                <!-- Instagram -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Instagram</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">10.2k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">847</p><p class="text-[10px] text-gray-500" data-i18n="ch_posts">Beitraege</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">4.2%</p><p class="text-[10px] text-gray-500" data-i18n="ch_engagement">Engagement</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="flex-1 py-2 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                                <!-- YouTube -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-red-600 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">YouTube</h3>
                                            <p class="text-xs text-gray-500">vit:bikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">156</p><p class="text-[10px] text-gray-500" data-i18n="ch_subscribers">Abonnenten</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">48</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">12.4k</p><p class="text-[10px] text-gray-500" data-i18n="ch_views">Aufrufe</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-semibold text-center hover:bg-red-700 transition">Zum Kanal â†’</a>
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Abonnieren</a>
                                    </div>
                                </div>

                                <!-- TikTok -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-black flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 0 0-.79-.05A6.34 6.34 0 0 0 3.15 15.2a6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.34-6.34V8.73a8.19 8.19 0 0 0 4.76 1.52V6.79a4.82 4.82 0 0 1-1-.1z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">TikTok</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">2.8k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">124</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">89k</p><p class="text-[10px] text-gray-500" data-i18n="ch_likes">Likes</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-black text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- SUB 1: Themen-AuftrÃ¤ge -->
                        <div id="smSubThemen" class="sm-sub-content" style="display:none;">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex space-x-2">
                                    <button onclick="filterSmThemen('all')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-smf="all" data-i18n="filter_all">Alle</button>
                                    <button onclick="filterSmThemen('neu')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="neu" data-i18n="filter_new">ðŸ†• Neu fuer dich</button>
                                    <button onclick="filterSmThemen('done')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="done" data-i18n="filter_done">âœ… Erledigt</button>
                                </div>
                                <input type="text" id="smThemenSearch" placeholder="Thema suchen..." data-i18n-placeholder="search_topic" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs w-48" oninput="filterSmThemen(currentSmFilter)">
                            </div>
                            <div id="smThemenList" class="space-y-2"></div>
                        </div>

                        <!-- SUB 2: Upload -->
                        <div id="smSubUpload" class="sm-sub-content" style="display:none;">
                            <div class="max-w-xl mx-auto">
                                <div class="vit-card p-6">
                                    <div class="text-center mb-5">
                                        <div class="text-4xl mb-2">ðŸ“¤</div>
                                        <h3 class="text-lg font-bold text-gray-800" data-i18n="upl_title">Video hochladen</h3>
                                        <p class="text-sm text-gray-500">Waehle ein Thema, lade dein Video hoch â€“ fertig! Wir kuemmern uns um Schnitt, Untertitel und Posting.</p>
                                    </div>

                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Content-Thema waehlen</label>
                                            <select id="smUploadThema" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm">
                                                <option value="">Thema waehlen...</option>
                                            </select>
                                            <p class="text-[10px] text-gray-400 mt-1">Oder trage 0000 ein, wenn es ein eigener Vorschlag ist</p>
                                        </div>

                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Dein Video</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-vit-orange transition cursor-pointer" onclick="this.querySelector('input')||this.insertAdjacentHTML('beforeend','<input type=file class=hidden onchange=handleFileUpload(this)>');var fi=this.querySelector('input');if(fi)fi.click()">
                                                <div class="text-4xl mb-2">â˜ï¸</div>
                                                <p class="text-sm text-gray-600">Video hierhin ziehen</p>
                                                <p class="text-xs text-gray-400 mt-1">oder klicken zum Auswaehlen</p>
                                                <p class="text-[10px] text-gray-300 mt-2">MP4, MOV Â· Max. 2 GB</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Kurzer Kommentar <span class="font-normal text-gray-400">(optional)</span></label>
                                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="2" placeholder="z.B. 'Haben das im Laden gedreht, Lichtsituation war schwierig'"></textarea>
                                        </div>

                                        <button class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold hover:opacity-90 transition text-sm" onclick="alert('ðŸŽ‰ Video eingereicht! Das HQ meldet sich wenn es fertig geschnitten ist.')">
                                            ðŸš€ Video einreichen
                                        </button>
                                        <p class="text-[10px] text-gray-400 text-center">Das HQ schneidet euer Video, packt Untertitel drauf und postet es als Collab-Post auf eurem Profil.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB 3: Ranking -->
                        <div id="smSubRanking" class="sm-sub-content" style="display:none;">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="vit-card p-6">
                                    <h3 class="font-bold text-gray-800 mb-4" data-i18n="rank_title">ðŸ† Content-Ranking â€“ Wer dreht am meisten?</h3>
                                    <div id="smRankingList" class="space-y-2"></div>
                                </div>
                                <div>
                                    <div class="vit-card p-6 mb-4">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_badges">ðŸŽ–ï¸ Badges</h3>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŒ±</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_first">Erster Upload</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŽ¬</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_3">3 Videos</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                                                <div class="text-2xl">â­</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_5">5 Videos</p>
                                                <p class="text-[10px] text-orange-600" data-i18n="badge_almost">Noch 1!</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ”¥</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_10">10 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ’Ž</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_25">25 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ‘‘</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_50">50 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="vit-card p-6">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_stats">ðŸ“Š Netzwerk-Statistik</h3>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">34</p><p class="text-[10px] text-gray-500" data-i18n="rank_total_vids">Videos gesamt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">25</p><p class="text-[10px] text-gray-500" data-i18n="rank_topics_covered">Themen abgedeckt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">10</p><p class="text-[10px] text-gray-500" data-i18n="rank_active">Aktive Standorte</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold text-red-500">13</p><p class="text-[10px] text-gray-500" data-i18n="rank_no_video">Noch ohne Video</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB 4: Ablauf -->
                        <div id="smSubAblauf" class="sm-sub-content" style="display:none;">
                            <div class="vit-card p-6 mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="howto_title">So funktioniert Local Hero â€“ in 3 Schritten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                                        <div class="w-10 h-10 bg-vit-orange text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">1. Inspiration</p>
                                        <p class="text-[10px] text-gray-500">Wir stellen Thema + Beispielvideo bereit</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">DU</div>
                                        <p class="text-xs font-bold text-gray-700">2. Drehen & Upload</p>
                                        <p class="text-[10px] text-gray-500">1-3 Min. Video mit dem Handy drehen und hier hochladen</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">3. Schnitt & Posting</p>
                                        <p class="text-[10px] text-gray-500">Wir schneiden, packen Untertitel drauf und posten als Collab</p>
                                    </div>
                                </div>
                            </div>

                            <div class="vit-card p-6 mb-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_tips">ðŸ’¡ Tipps fuer gute Videos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ“±</span><div><p class="text-sm font-semibold">Hochformat</p><p class="text-xs text-gray-500">9:16 Format (wie Instagram Story/Reel)</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ”Š</span><div><p class="text-sm font-semibold">Laut & deutlich sprechen</p><p class="text-xs text-gray-500">Wir packen Untertitel drauf â€“ aber guter Ton hilft</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ’¡</span><div><p class="text-sm font-semibold">Gutes Licht</p><p class="text-xs text-gray-500">Am besten Tageslicht oder Laden-Beleuchtung</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">â±ï¸</span><div><p class="text-sm font-semibold">Max. 1-3 Minuten</p><p class="text-xs text-gray-500">Kurz und knackig â€“ lieber zu kurz als zu lang</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸŽ¯</span><div><p class="text-sm font-semibold">Hook-Hauptteil-Outro</p><p class="text-xs text-gray-500">Aufbau steht bei jedem Thema dabei</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ¤·</span><div><p class="text-sm font-semibold">Nicht perfekt sein</p><p class="text-xs text-gray-500">Authentisch > perfekt. Einfach drauflos!</p></div></div>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_links">ðŸ”— Hilfreiche Links</h3>
                                <div class="space-y-2">
                                    <a href="https://fahrrad.vitbikes.de/inspiration/" target="_blank" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸŽ¥</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Beispielvideos & Inspiration</p><p class="text-[10px] text-gray-400">fahrrad.vitbikes.de/inspiration</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸ“‹</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Reel-Template (MAKE IT REEL)</p><p class="text-[10px] text-gray-400">Hook â€“ Hauptteil â€“ Outro Vorlage</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div id="marketingTabContent" class="marketing-tab-content" style="display:none;">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Content Library</h2>
                            <div class="space-y-3">
                                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-2xl">ðŸ–¼ï¸</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-800">Logo & Brand Assets</h3>
                                        <p class="text-xs text-gray-500">Logos, Farben, Schriftarten</p>
                                    </div>
                                    <button class="px-3 py-1 text-sm text-vit-orange border border-vit-orange rounded hover:bg-vit-orange hover:text-white transition">Download</button>
                                </div>
                                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-2xl">ðŸ“„</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-800">Flyer-Vorlagen</h3>
                                        <p class="text-xs text-gray-500">Aktionsflyer, Eroeffnungsflyer</p>
                                    </div>
                                    <button class="px-3 py-1 text-sm text-vit-orange border border-vit-orange rounded hover:bg-vit-orange hover:text-white transition">Download</button>
                                </div>
                                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-2xl">ðŸ“‹</span>
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-800">Social Media Templates</h3>
                                        <p class="text-xs text-gray-500">Instagram Posts, Facebook Banner</p>
                                    </div>
                                    <button class="px-3 py-1 text-sm text-vit-orange border border-vit-orange rounded hover:bg-vit-orange hover:text-white transition">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="marketingTabAnalytics" class="marketing-tab-content" style="display:none;">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Marketing Analytics</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="p-4 bg-orange-50 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Website-Besucher</p>
                                    <p class="text-2xl font-bold text-vit-orange">2,458</p>
                                    <p class="text-xs text-green-600">+12% vs. Vormonat</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Google-Bewertungen</p>
                                    <p class="text-2xl font-bold text-blue-600">4.7 â˜…</p>
                                    <p class="text-xs text-gray-500">89 Bewertungen</p>
                                </div>
                                <div class="p-4 bg-green-50 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Conversion Rate</p>
                                    <p class="text-2xl font-bold text-green-600">3.2%</p>
                                    <p class="text-xs text-green-600">+0.4% vs. Vormonat</p>
                                </div>
                                <div class="p-4 bg-purple-50 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Kosten/Lead</p>
                                    <p class="text-2xl font-bold text-purple-600">146 â‚¬</p>
                                    <p class="text-xs text-red-600">+8% vs. Vormonat</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Marketing Strategie -->
                    <div id="marketingTabMktStrategie" class="marketing-tab-content" style="display:none;">
                        <div class="vit-card p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">Marketing-Strategie 2026</h2>
                                    <p class="text-sm text-gray-500">Jahresgespraech vom 23.12.2025 Â· Ansprechpartner vit:bikes: Michael Stenzel</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Vereinbart &amp; Unterschrieben</span>
                            </div>
                        </div>

                        <!-- Vereinbarung 2026 -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“</span> Vereinbarung 2026</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Budget / Monat</p><p class="text-2xl font-bold text-vit-orange">1.500 â‚¬</p><p class="text-xs text-gray-400">flexibel anpassbar zum Monatsanfang</p></div>
                                <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Mediamix</p><p class="text-lg font-bold text-blue-600">Meta + Google</p><p class="text-xs text-gray-400">+ Framen, Audio, Events (optional)</p></div>
                                <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Content-Unterstuetzung</p><p class="text-lg font-bold text-green-600">Ads + Organisch</p><p class="text-xs text-gray-400">durch vit:bikes Content-Team</p></div>
                            </div>
                            <p class="text-sm text-gray-600">Zusaetzlich: Lokale OOH-Werbemittel, Individuelle Ads, Influencer-Kooperationen</p>
                        </div>

                        <!-- Performance 2025 -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“Š</span> Performance 2025</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Standortsuche</p><p class="text-xl font-bold text-gray-800">4.275</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Terminbuchungen</p><p class="text-xl font-bold text-vit-orange">40</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Store Visits</p><p class="text-xl font-bold text-green-600">108</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Impressionen</p><p class="text-xl font-bold text-gray-800">1.248.800</p><p class="text-xs text-red-500">Google Ads</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Klicks</p><p class="text-xl font-bold text-gray-800">8.924</p><p class="text-xs text-red-500">Google Ads</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Kosten Gesamt</p><p class="text-xl font-bold text-red-600">7.184 â‚¬</p><p class="text-xs text-red-500">Google Ads</p></div>
                            </div>
                        </div>

                        <!-- Grafrath vs Netzwerk Durchschnitt -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-6">
                                <h3 class="font-semibold text-gray-800 mb-3">âŒ€ Grafrath</h3>
                                <table class="w-full text-sm"><tbody>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Budget/Monat</td><td class="py-2 text-right font-semibold">863,86 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPC</td><td class="py-2 text-right font-semibold">103,50 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPT (Cost per Termin)</td><td class="py-2 text-right font-semibold">205,92 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Termine / Monat</td><td class="py-2 text-right font-semibold">4,88</td></tr>
                                    <tr><td class="py-2 text-gray-500">Store Visits / Monat</td><td class="py-2 text-right font-semibold">16,38</td></tr>
                                </tbody></table>
                            </div>
                            <div class="vit-card p-6 border-l-4 border-vit-orange">
                                <h3 class="font-semibold text-vit-orange mb-3">âŒ€ vit:bikes Netzwerk</h3>
                                <table class="w-full text-sm"><tbody>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Budget/Monat</td><td class="py-2 text-right font-semibold">1.436 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPC</td><td class="py-2 text-right font-semibold">104,32 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPT (Cost per Termin)</td><td class="py-2 text-right font-semibold text-green-600">163,15 â‚¬ âœ“</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Termine / Monat</td><td class="py-2 text-right font-semibold text-green-600">9 âœ“</td></tr>
                                    <tr><td class="py-2 text-gray-500">Store Visits / Monat</td><td class="py-2 text-right font-semibold text-green-600">22 âœ“</td></tr>
                                </tbody></table>
                            </div>
                        </div>

                        <!-- Zielerreichung -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center"><span class="w-8 h-8 bg-green-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸŽ¯</span> Zielerreichung 2025</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg bg-yellow-50"><p class="text-sm text-gray-600 mb-1">Terminziel-Erreichung</p><div class="flex items-center"><div class="flex-1 bg-gray-200 rounded-full h-4 mr-3"><div class="bg-yellow-500 h-4 rounded-full" style="width:56%"></div></div><span class="text-sm font-bold text-yellow-600">56%</span></div></div>
                                <div class="p-4 rounded-lg bg-green-50"><p class="text-sm text-gray-600 mb-1">Storevisit-Ziel-Erreichung</p><div class="flex items-center"><div class="flex-1 bg-gray-200 rounded-full h-4 mr-3"><div class="bg-green-500 h-4 rounded-full" style="width:100%"></div></div><span class="text-sm font-bold text-green-600">103%</span></div></div>
                            </div>
                        </div>

                        <!-- Basic Checkliste -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-purple-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">âœ…</span> Basic Checkliste</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Aussendarstellung</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Individuelle Ads (Paid)</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Organische Stories</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Events 2025</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Google My Business</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Influencer-Kooperationen</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Landingpage</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Etermin + Setting</span></div>
                            </div>
                        </div>

                        <!-- Skalierungspotentiale -->
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸš€</span> Skalierungspotentiale</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange"><span class="font-bold text-vit-orange">1</span><div><p class="font-semibold text-sm">Individuelle Ads</p><p class="text-xs text-gray-500">Bessere Performance &amp; Authentizitaet durch lokalen Content</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">2</span><div><p class="font-semibold text-sm">Organische Platzierung</p><p class="text-xs text-gray-500">YouTube, Meta &amp; TikTok Kanaele nutzen</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">3</span><div><p class="font-semibold text-sm">Haendlerprofil schaerfen</p><p class="text-xs text-gray-500">Expertise, Marken, Kategorien klarer kommunizieren</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange"><span class="font-bold text-vit-orange">4</span><div><p class="font-semibold text-sm">Lokale Events</p><p class="text-xs text-gray-500">Steigern Identitaet, staerken Kundenbindung, erreichen Neukunden</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">5</span><div><p class="font-semibold text-sm">Marketingmix ausbauen</p><p class="text-xs text-gray-500">Mediale Kommunikation erweitern</p></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="marketingTabMktWissen" class="marketing-tab-content" style="display:none;"></div>
                </div>
                <div id="einkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_purchasing">EINKAUF</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showEinkaufTab('lieferanten')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="lieferanten">Lieferanten</button>
                            <button onclick="showEinkaufTab('auswertung')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="auswertung">Auswertung</button>
                            <button onclick="showEinkaufTab('ekStrategie')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekStrategie">ðŸ“‹ Strategie</button>
                            <button onclick="showEinkaufTab('ekWissen')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Lieferanten ===== -->
                    <div id="ekTabLieferanten" class="ek-tab-content">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
                            <div class="relative flex-1 max-w-md">
                                <input type="text" id="liefSearch" onkeyup="filterLieferanten()" placeholder="Lieferant oder Marke suchen..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                                <span class="text-xs text-gray-400 font-semibold mr-1">Typ:</span>
                                <button onclick="toggleLiefFilter('typ','all')" class="lief-typ-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-typ="all">Alle</button>
                                <button onclick="toggleLiefFilter('typ','fahrrad')" class="lief-typ-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-typ="fahrrad">Fahrrad</button>
                                <button onclick="toggleLiefFilter('typ','teile')" class="lief-typ-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-typ="teile">Teile / Komponenten</button>
                                <span class="text-gray-300 mx-1">|</span>
                                <span class="text-xs text-gray-400 font-semibold mr-1">Status:</span>
                                <button onclick="toggleLiefFilter('status','all')" class="lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-st="all">Alle</button>
                                <button onclick="toggleLiefFilter('status','aktiv')" class="lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-st="aktiv">Aktiv</button>
                                <button onclick="toggleLiefFilter('status','neu')" class="lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-st="neu">Neu</button>
                                <button onclick="toggleLiefFilter('status','inaktiv')" class="lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-st="inaktiv">Inaktiv</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="lieferantenGrid"></div>
                    </div>

                    <!-- ===== TAB 2: Auswertung ===== -->
                    <div id="ekTabAuswertung" class="ek-tab-content" style="display:none;">
                        <!-- KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Einkaufsvolumen YTD</p><p class="text-2xl font-bold text-gray-800">33.580 â‚¬</p><p class="text-xs text-gray-400">Jan 2026</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Ã˜ Rohertragsmarge</p><p class="text-2xl font-bold text-green-600">38.9%</p><p class="text-xs text-green-600">+1.6 Pp vs. VJ</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Raeder auf Lager</p><p class="text-2xl font-bold text-gray-800">47</p><p class="text-xs text-gray-400">Lagerwert: 189.400 â‚¬</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Lagerumschlag</p><p class="text-2xl font-bold text-blue-600">4.2x</p><p class="text-xs text-green-600">Ziel: 4.0x</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Offene Bestellungen</p><p class="text-2xl font-bold text-vit-orange">12</p><p class="text-xs text-gray-400">Wert: 58.200 â‚¬</p></div>
                        </div>

                        <!-- Marge pro Marke -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-6">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Rohertragsmarge pro Marke</h2>
                                <div class="space-y-3" id="ekMargenList"></div>
                            </div>
                            <div class="vit-card p-6">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Top & Flop Modelle (YTD)</h2>
                                <div class="mb-4">
                                    <h3 class="text-xs font-semibold text-green-600 uppercase tracking-wider mb-2">Top 5 â€“ Meistverkauft</h3>
                                    <div class="space-y-2" id="ekTopModelle"></div>
                                </div>
                                <div>
                                    <h3 class="text-xs font-semibold text-red-600 uppercase tracking-wider mb-2">Flop â€“ Ladenhueter (> 90 Tage auf Lager)</h3>
                                    <div class="space-y-2" id="ekFlopModelle"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Einkauf nach Kategorie -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Einkaufsvolumen nach Kategorie (Jan 2026)</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-3 font-semibold text-gray-600">Kategorie</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Einkauf</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Verkauf</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Marge</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Stueck</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Ã˜ EK/Stueck</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Anteil</th></tr></thead>
                                    <tbody>
                                        <tr class="border-b"><td class="py-2.5 px-3 font-semibold">E-Bikes</td><td class="text-right py-2.5 px-3">24.821</td><td class="text-right py-2.5 px-3">47.380</td><td class="text-right py-2.5 px-3 text-green-600 font-semibold">47.6%</td><td class="text-right py-2.5 px-3">11</td><td class="text-right py-2.5 px-3">2.256</td><td class="text-right py-2.5 px-3 text-gray-500">73.9%</td></tr>
                                        <tr class="border-b"><td class="py-2.5 px-3 font-semibold">Teile &amp; Zubehoer</td><td class="text-right py-2.5 px-3">5.515</td><td class="text-right py-2.5 px-3">6.052</td><td class="text-right py-2.5 px-3 text-orange-600 font-semibold">8.9%</td><td class="text-right py-2.5 px-3">â€”</td><td class="text-right py-2.5 px-3">â€”</td><td class="text-right py-2.5 px-3 text-gray-500">16.4%</td></tr>
                                        <tr class="border-b"><td class="py-2.5 px-3 font-semibold">Werkstatt-Material</td><td class="text-right py-2.5 px-3">3.244</td><td class="text-right py-2.5 px-3">3.534</td><td class="text-right py-2.5 px-3 text-orange-600 font-semibold">8.2%</td><td class="text-right py-2.5 px-3">â€”</td><td class="text-right py-2.5 px-3">â€”</td><td class="text-right py-2.5 px-3 text-gray-500">9.7%</td></tr>
                                        <tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT</td><td class="text-right py-3 px-3 font-bold">33.580</td><td class="text-right py-3 px-3 font-bold">54.938</td><td class="text-right py-3 px-3 text-green-600 font-bold">38.9%</td><td class="text-right py-3 px-3 font-bold">â€”</td><td class="text-right py-3 px-3 font-bold">â€”</td><td class="text-right py-3 px-3 font-bold">100%</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 3: Einkauf Strategie ===== -->
                    <div id="ekTabEkStrategie" class="ek-tab-content" style="display:none;">
                        <div class="vit-card p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">Einkaufsstrategie 2026</h2>
                                    <p class="text-sm text-gray-500">Erstellt am 15.09.2025 Â· Ansprechpartner vit:bikes: Florian Meier</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Vereinbart &amp; Unterschrieben</span>
                            </div>
                            <p class="text-sm text-gray-600">Unterschrieben von: Florian Meier, Sandra Engelmann, Sascha Matthies</p>
                        </div>

                        <!-- Ziele -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸŽ¯</span> Strategische Ziele</h3>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center space-x-2 text-sm"><span class="text-green-600 font-bold">âœ“</span><span>Sortiment 2026 definieren &amp; Rohertrag optimieren</span></div>
                                <div class="flex items-center space-x-2 text-sm"><span class="text-green-600 font-bold">âœ“</span><span>Vororder 2026 sichern</span></div>
                                <div class="flex items-center space-x-2 text-sm"><span class="text-green-600 font-bold">âœ“</span><span>Verkaufsbereitschaft aller Bike-Kategorien sicherstellen</span></div>
                                <div class="flex items-center space-x-2 text-sm"><span class="text-green-600 font-bold">âœ“</span><span>Rabatte minimieren, Dreingaben statt Preisnachlaesse</span></div>
                            </div>
                        </div>

                        <!-- Status Quo -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“¦</span> Status Quo (Stand 15.09.2025)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Bike-Bestand</p><p class="text-2xl font-bold text-blue-600">156</p><p class="text-xs text-gray-400">25 MTB Â· 131 Trekking/City</p></div>
                                <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Gesamt-Umsatz (netto)</p><p class="text-2xl font-bold text-green-600">995.897 â‚¬</p><p class="text-xs text-gray-400">262 Bikes, âŒ€ 4.508 â‚¬ DB</p></div>
                                <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Ã˜ Nachlass</p><p class="text-2xl font-bold text-vit-orange">8,70%</p><p class="text-xs text-red-500">Ziel: unter 5%</p></div>
                            </div>
                        </div>

                        <!-- Sortiment 2026 Marken -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-green-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸš²</span> Sortiment 2026 â€“ Zielmarken</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200"><p class="font-semibold text-sm">Kalkhoff</p><p class="text-xs text-gray-500">VO: 80 Bikes Â· Top-Volumen</p><p class="text-xs text-green-600">Rabatt durch 7er an Upway erhoet</p></div>
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200"><p class="font-semibold text-sm">Haibike</p><p class="text-xs text-gray-500">Blockorder 30-50 eMTBs geplant</p><p class="text-xs text-yellow-600">âš  Konditionen wackeln</p></div>
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200"><p class="font-semibold text-sm">Orbea</p><p class="text-xs text-gray-500">Hoechster DB1 im Sortiment</p><p class="text-xs text-green-600">Umsatz steigern!</p></div>
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200"><p class="font-semibold text-sm">Simplon</p><p class="text-xs text-gray-500">VO: 10 Bikes (Gravel, MTB)</p><p class="text-xs text-green-600">Hoechster brutto-VK</p></div>
                                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200"><p class="font-semibold text-sm">Velo de Ville</p><p class="text-xs text-gray-500">VO: 8 Bikes Â· NEU im Sortiment</p><p class="text-xs text-blue-600">Alternative zu Kalkhoff/Haibike Trekking</p></div>
                                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200"><p class="font-semibold text-sm">Steppenwolf</p><p class="text-xs text-gray-500">VO: 5 Bikes Â· Lieferung ab Juli</p><p class="text-xs text-blue-600">Sportives DJI Sortiment</p></div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                                <p class="text-sm font-semibold text-red-700 mb-1">Abverkauf / Ausgelistet:</p>
                                <p class="text-xs text-gray-600">Stevens (letzte 3 abverkaufen) Â· HNF Nicolai Â· Raymon Â· Husqvarna â€“ Lagerbereinigung 2025 fast abgeschlossen</p>
                            </div>
                        </div>

                        <!-- Haibike Blockorder Detail -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-red-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“Š</span> Haibike Verkaufszahlen (09/24â€“09/25)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm"><thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-2">Modell</th><th class="text-right py-2 px-2">Menge</th><th class="text-right py-2 px-2">Umsatz (netto)</th><th class="text-right py-2 px-2">âŒ€ Stueckpreis</th></tr></thead><tbody>
                                    <tr class="border-b bg-orange-50"><td class="py-1.5 px-2 font-semibold">ALLMTN 3</td><td class="py-1.5 px-2 text-right font-bold">12</td><td class="py-1.5 px-2 text-right">52.427 â‚¬</td><td class="py-1.5 px-2 text-right">4.369 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-1.5 px-2">ALLMTN 6</td><td class="py-1.5 px-2 text-right">2</td><td class="py-1.5 px-2 text-right">30.247 â‚¬</td><td class="py-1.5 px-2 text-right">15.124 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-1.5 px-2">ADVENTR 10</td><td class="py-1.5 px-2 text-right">5</td><td class="py-1.5 px-2 text-right">23.945 â‚¬</td><td class="py-1.5 px-2 text-right">4.789 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-1.5 px-2">ADVENTR 9</td><td class="py-1.5 px-2 text-right">3</td><td class="py-1.5 px-2 text-right">21.004 â‚¬</td><td class="py-1.5 px-2 text-right">7.001 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-1.5 px-2">ALLTRACK 7 29</td><td class="py-1.5 px-2 text-right">5</td><td class="py-1.5 px-2 text-right">16.803 â‚¬</td><td class="py-1.5 px-2 text-right">3.361 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-1.5 px-2">Weitere 10 Modelle</td><td class="py-1.5 px-2 text-right">18</td><td class="py-1.5 px-2 text-right">79.987 â‚¬</td><td class="py-1.5 px-2 text-right text-gray-400">div.</td></tr>
                                    <tr class="border-t-2 border-gray-300 font-bold bg-gray-50"><td class="py-2 px-2">GESAMT</td><td class="py-2 px-2 text-right">45</td><td class="py-2 px-2 text-right">224.413 â‚¬</td><td class="py-2 px-2 text-right">4.987 â‚¬</td></tr>
                                </tbody></table>
                            </div>
                        </div>

                        <!-- ToDos -->
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-purple-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“Œ</span> Fortlaufende Massnahmen 2026</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange"><div><p class="font-semibold text-sm">Orbea &amp; Simplon pushen</p><p class="text-xs text-gray-500">Bewusst in Beratung anbieten. Verkaeufermotivation: zum Anzuenden muss der Verkaeufer brennen!</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><div><p class="font-semibold text-sm">Rabatte minimieren</p><p class="text-xs text-gray-500">Woechentlich/monatlich auswerten. Tipp: 100 â‚¬ Sqlab Sattel als Dreingabe statt 100 â‚¬ Rabatt (nur 50 â‚¬ netto Rohertrags-Verlust)</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><div><p class="font-semibold text-sm">Haibike Blockorder sichern</p><p class="text-xs text-gray-500">30-50 eMTBs (AllMtn, AllTrack, Adventr) mit Bosch, Liefertermine ab Maerz 2026, Valuta+Skonto bei Fruehlieferung</p></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="ekTabEkWissen" class="ek-tab-content" style="display:none;"></div>
                </div>

                <div id="controllingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_controlling">CONTROLLING</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showControllingTab('bwa')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="bwa">BWAs</button>
                            <button onclick="showControllingTab('benchmark')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="benchmark">Benchmarks</button>
                            <button onclick="showControllingTab('planist')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="planist">Plan / Ist</button>
                            <button onclick="showControllingTab('liquiditaet')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="liquiditaet">Liquiditaet</button>
                            <button onclick="showControllingTab('ctrlWissen')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ctrlWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: BWAs ===== -->
                    <div id="ctrlTabBwa" class="ctrl-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left: BWA Ablage -->
                            <div class="lg:col-span-1">
                                <div class="vit-card p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800">BWA Ablage</h2>
                                        <button onclick="openBwaUploadModal()" class="px-3 py-1.5 bg-vit-orange text-white text-sm rounded-lg hover:opacity-90">+ Erfassen</button>
                                    </div>
                                    <div id="bwaFileList" class="space-y-2">
                                        <p class="text-sm text-gray-400 text-center py-4">Wird geladen...</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Right: BWA Anzeige -->
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6" id="bwaDisplay">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800" id="bwaTitle">BWA auswaehlen</h2>
                                        <div class="flex space-x-2">
                                            <button onclick="editSelectedBwa()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" id="bwaEditBtn" style="display:none">âœï¸ Bearbeiten</button>
                                            <button onclick="deleteBwa()" class="px-3 py-1.5 text-sm border border-red-300 text-red-500 rounded-lg hover:bg-red-50" id="bwaDeleteBtn" style="display:none">ðŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <!-- KPI Summary -->
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="bwaKpiGrid">
                                        <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Umsatz</p><p class="text-xl font-bold text-gray-800" id="bwaKpiUmsatz">â€”</p><p class="text-xs text-gray-400" id="bwaKpiUmsatzVj">&nbsp;</p></div>
                                        <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Rohertrag</p><p class="text-xl font-bold text-gray-800" id="bwaKpiRohertrag">â€”</p><p class="text-xs text-gray-400" id="bwaKpiMarge">&nbsp;</p></div>
                                        <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Gesamtkosten</p><p class="text-xl font-bold text-gray-800" id="bwaKpiKosten">â€”</p><p class="text-xs text-gray-400" id="bwaKpiKostenVj">&nbsp;</p></div>
                                        <div class="p-4 bg-purple-50 rounded-lg text-center"><p class="text-xs text-gray-500">Ergebnis</p><p class="text-xl font-bold text-gray-800" id="bwaKpiErgebnis">â€”</p><p class="text-xs text-gray-400" id="bwaKpiErgebnisMarge">&nbsp;</p></div>
                                    </div>
                                    <!-- BWA Table -->
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm" id="bwaDetailTable">
                                            <thead><tr class="bg-gray-50"><th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th><th class="text-right py-2 px-3 font-semibold text-gray-600">IST</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Plan</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2 px-3 font-semibold text-gray-600">VJ</th></tr></thead>
                                            <tbody id="bwaDetailBody"><tr><td colspan="5" class="text-center py-8 text-gray-400">Waehle links eine BWA aus oder erfasse neue Daten.</td></tr></tbody>
                                        </table>
                                    </div>
                                    <!-- 12-Monats-Verlauf -->
                                    <div class="mt-6 pt-4 border-t border-gray-200" id="bwaTrendSection" style="display:none">
                                        <h3 class="font-semibold text-gray-800 mb-3">ðŸ“ˆ 12-Monats-Verlauf</h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3" id="bwaTrendCards"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Benchmarks ===== -->
                    <div id="ctrlTabBenchmark" class="ctrl-tab-content" style="display:none;">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-2">Standort-Vergleich</h2>
                            <p class="text-sm text-gray-500 mb-6">Dein Standort vs. Netzwerk-Durchschnitt (Februar 2026)</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / mÂ²</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">428 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">382 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:85%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+12% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Rohertragsmarge</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">36.7%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">34.2%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+2.5 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / Mitarbeiter</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-orange-500">28.560 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">30.100 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-orange-400 h-2.5 rounded-full" style="width:65%"></div></div>
                                    <p class="text-xs text-orange-600 mt-1 font-semibold">-5% unter Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Personalkostenquote</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-red-500">19.9%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">18.5%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-red-400 h-2.5 rounded-full" style="width:72%"></div></div>
                                    <p class="text-xs text-red-600 mt-1 font-semibold">+1.4 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Lagerumschlag</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">4.2x</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">3.8x</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:82%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+11% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Werkstatt-Auslastung</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">78%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">72%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+6 Pp ueber Durchschnitt</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 3: Plan / Ist (dynamisch) ===== -->
                    <div id="ctrlTabPlanist" class="ctrl-tab-content" style="display:none;">
                        <div id="planIstContent">
                            <!-- Filled dynamically by renderPlanIst() -->
                            <div class="text-center py-12 text-gray-400">
                                <div class="w-8 h-8 border-2 border-vit-orange border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p class="text-sm">Lade Plan-Daten...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 4: Liquiditaet ===== -->
                    <div id="ctrlTabLiquiditaet" class="ctrl-tab-content" style="display:none;">
                        <!-- KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Kontostand aktuell</p><p class="text-2xl font-bold text-green-600">47.820 â‚¬</p><p class="text-xs text-gray-500">Stand: 14.02.2026</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Offene Forderungen</p><p class="text-2xl font-bold text-blue-600">23.400 â‚¬</p><p class="text-xs text-gray-500">14 Rechnungen</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Offene Verbindlichkeiten</p><p class="text-2xl font-bold text-red-600">38.200 â‚¬</p><p class="text-xs text-gray-500">8 Rechnungen</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Freie Liquiditaet</p><p class="text-2xl font-bold text-gray-800">33.020 â‚¬</p><p class="text-xs text-gray-500">Konto + Ford. - Verbindl.</p></div>
                        </div>
                        <!-- Cash Flow Prognose -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Cash-Flow Prognose (naechste 8 Wochen)</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="text-left py-2 px-3 font-semibold text-gray-600">Woche</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Einnahmen</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Ausgaben</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Saldo</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Kontostand</th></tr></thead>
                                    <tbody>
                                        <tr class="border-b bg-blue-50"><td class="py-2 px-3 font-semibold">KW 8 (aktuell)</td><td class="text-right py-2 px-3 text-green-600">+18.500</td><td class="text-right py-2 px-3 text-red-600">-12.300</td><td class="text-right py-2 px-3 font-semibold text-green-600">+6.200</td><td class="text-right py-2 px-3 font-bold">47.820</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 9</td><td class="text-right py-2 px-3 text-green-600">+22.000</td><td class="text-right py-2 px-3 text-red-600">-28.400</td><td class="text-right py-2 px-3 text-red-600">-6.400</td><td class="text-right py-2 px-3 font-semibold">41.420</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 10</td><td class="text-right py-2 px-3 text-green-600">+19.800</td><td class="text-right py-2 px-3 text-red-600">-15.200</td><td class="text-right py-2 px-3 text-green-600">+4.600</td><td class="text-right py-2 px-3 font-semibold">46.020</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 11</td><td class="text-right py-2 px-3 text-green-600">+24.500</td><td class="text-right py-2 px-3 text-red-600">-18.900</td><td class="text-right py-2 px-3 text-green-600">+5.600</td><td class="text-right py-2 px-3 font-semibold">51.620</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 12</td><td class="text-right py-2 px-3 text-green-600">+21.200</td><td class="text-right py-2 px-3 text-red-600">-34.500</td><td class="text-right py-2 px-3 text-red-600">-13.300</td><td class="text-right py-2 px-3 font-semibold text-orange-600">38.320</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 13</td><td class="text-right py-2 px-3 text-green-600">+26.800</td><td class="text-right py-2 px-3 text-red-600">-16.400</td><td class="text-right py-2 px-3 text-green-600">+10.400</td><td class="text-right py-2 px-3 font-semibold">48.720</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 14</td><td class="text-right py-2 px-3 text-green-600">+28.100</td><td class="text-right py-2 px-3 text-red-600">-19.800</td><td class="text-right py-2 px-3 text-green-600">+8.300</td><td class="text-right py-2 px-3 font-semibold">57.020</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 15</td><td class="text-right py-2 px-3 text-green-600">+31.500</td><td class="text-right py-2 px-3 text-red-600">-22.100</td><td class="text-right py-2 px-3 text-green-600">+9.400</td><td class="text-right py-2 px-3 font-semibold text-green-600">66.420</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Alerts -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Liquiditaets-Hinweise</h2>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <span class="text-yellow-500 text-xl mt-0.5">âš¡</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">KW 9: Gehaltszahlung + Lieferantenrechnung</p><p class="text-xs text-gray-600">Erwartete Ausgaben von 28.400 â‚¬ - Kontostand sinkt auf ca. 41.420 â‚¬</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                    <span class="text-orange-500 text-xl mt-0.5">ðŸ“‹</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">KW 12: Vororder Fruehjahr faellig</p><p class="text-xs text-gray-600">Grosse Lieferantenrechnung erwartet (34.500 â‚¬) - rechtzeitig Liquiditaet sichern</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <span class="text-green-500 text-xl mt-0.5">ðŸ“ˆ</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">Positiver Trend ab KW 13</p><p class="text-xs text-gray-600">Fruehjahrsgeschaeft startet - steigende Einnahmen erwartet</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="ctrlTabCtrlWissen" class="ctrl-tab-content" style="display:none;"></div>
                </div>


                <div id="aktenschrankView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_filingcab">AKTENSCHRANK</h1>

                    <!-- Search & Upload Bar -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="relative flex-1 max-w-md">
                                <input type="text" id="aktenSearch" onkeyup="filterAkten()" placeholder="Dokument suchen..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                        </div>
                        <button onclick="document.getElementById('aktenUploadModal').classList.remove('hidden')" class="px-4 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Dokument hochladen</button>
                    </div>

                    <!-- Folder Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8" id="aktenFolders">

                        <!-- 1. Vertraege & Recht -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('vertraege')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-blue-100 rounded-xl group-hover:bg-blue-200 transition">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-blue-100 text-blue-700 rounded-full px-2 py-0.5">8</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Vertraege &amp; Recht</h3>
                            <p class="text-xs text-gray-500">Miet-, Franchise-, Arbeitsvertraege, Versicherungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 15.01.2026</p>
                        </div>

                        <!-- 2. Finanzen & Buchhaltung -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('finanzen')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-green-100 rounded-xl group-hover:bg-green-200 transition">
                                    <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-green-100 text-green-700 rounded-full px-2 py-0.5">14</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Finanzen &amp; Buchhaltung</h3>
                            <p class="text-xs text-gray-500">BWAs, Jahresabschluesse, Steuerbescheide, Rechnungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 05.02.2026</p>
                        </div>

                        <!-- 3. Personal & HR -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('personal')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-purple-100 rounded-xl group-hover:bg-purple-200 transition">
                                    <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-purple-100 text-purple-700 rounded-full px-2 py-0.5">11</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Personal &amp; HR</h3>
                            <p class="text-xs text-gray-500">Arbeitsvertraege, Lohn, Urlaub, Fortbildungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 31.01.2026</p>
                        </div>

                        <!-- 4. Standort & Betrieb -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('standort')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-orange-100 rounded-xl group-hover:bg-orange-200 transition">
                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-orange-100 text-orange-700 rounded-full px-2 py-0.5">6</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Standort &amp; Betrieb</h3>
                            <p class="text-xs text-gray-500">Grundrisse, Genehmigungen, Inventar, Wartung</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 10.12.2025</p>
                        </div>

                        <!-- 5. Marketing & Branding -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('marketing')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-pink-100 rounded-xl group-hover:bg-pink-200 transition">
                                    <svg class="w-7 h-7 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-4 12v4m-4-4v4m8-12V8a4 4 0 00-8 0v4m-2 0h12a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-pink-100 text-pink-700 rounded-full px-2 py-0.5">9</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Marketing &amp; Branding</h3>
                            <p class="text-xs text-gray-500">Brand Guidelines, Vorlagen, Druckdaten, Fotos</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 03.02.2026</p>
                        </div>

                        <!-- 6. Lieferanten & Einkauf -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('lieferanten')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-cyan-100 rounded-xl group-hover:bg-cyan-200 transition">
                                    <svg class="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-cyan-100 text-cyan-700 rounded-full px-2 py-0.5">7</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Lieferanten &amp; Einkauf</h3>
                            <p class="text-xs text-gray-500">Rahmenvertraege, Preislisten, Konditionen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 20.01.2026</p>
                        </div>

                        <!-- 7. Diverses -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('diverses')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-gray-100 rounded-xl group-hover:bg-gray-200 transition">
                                    <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">3</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Diverses</h3>
                            <p class="text-xs text-gray-500">Sonstiges, Notizen, Protokolle, Temporaeres</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 08.02.2026</p>
                        </div>

                    </div>

                    <!-- Folder Detail View (hidden by default) -->
                    <div id="aktenFolderDetail" class="hidden">
                        <div class="flex items-center space-x-3 mb-4">
                            <button onclick="closeAktenFolder()" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-gray-600">&#9664; Zurueck</button>
                            <h2 class="text-lg font-semibold text-gray-800" id="aktenFolderTitle">Ordner</h2>
                        </div>
                        <div class="vit-card overflow-hidden">
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Dokument</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Typ</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Hochgeladen</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Groesse</th><th class="text-right py-2.5 px-4 font-semibold text-gray-600">Aktion</th></tr></thead>
                                <tbody id="aktenFileList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Modal -->
                    <div id="aktenUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Dokument hochladen</h3>
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                            </div>
                            <div class="space-y-3">
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option>Vertraege &amp; Recht</option><option>Finanzen &amp; Buchhaltung</option><option>Personal &amp; HR</option>
                                    <option>Standort &amp; Betrieb</option><option>Marketing &amp; Branding</option><option>Lieferanten &amp; Einkauf</option><option>Diverses</option>
                                </select>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-vit-orange transition cursor-pointer">
                                    <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                    <p class="text-sm text-gray-500">Datei hierher ziehen oder <span class="text-vit-orange font-semibold">durchsuchen</span></p>
                                    <p class="text-xs text-gray-400 mt-1">PDF, XLSX, DOCX, JPG â€“ max. 25 MB</p>
                                </div>
                                <input type="text" placeholder="Beschreibung (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="w-full bg-vit-orange text-white py-2 rounded-lg font-semibold hover:opacity-90">Hochladen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="supportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_support">SUPPORT</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showSupportTab('tickets')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="tickets">ðŸŽ« Tickets <span id="supTicketBadge" class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">4</span></button>
                            <button onclick="showSupportTab('kontakte')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="kontakte">ðŸ‘¥ Kontakte Zentrale</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Tickets ===== -->
                    <div id="supTabTickets" class="sup-tab-content">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterTickets('all')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-tf="all">Alle (7)</button>
                                <button onclick="filterTickets('offen')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="offen">Offen (2)</button>
                                <button onclick="filterTickets('bearbeitung')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="bearbeitung">In Bearbeitung (2)</button>
                                <button onclick="filterTickets('geloest')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="geloest">Geloest (3)</button>
                            </div>
                            <button onclick="document.getElementById('ticketCreate').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neues Ticket</button>
                        </div>

                        <!-- Create Ticket Form -->
                        <div id="ticketCreate" class="hidden vit-card p-5 mb-4">
                            <h3 class="font-semibold text-gray-800 mb-3">Neues Support-Ticket erstellen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <select id="ticketCatInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="allgemein">Kategorie waehlen...</option>
                                    <option value="it">IT / Systeme</option>
                                    <option value="einkauf">Einkauf / Lieferanten</option>
                                    <option value="marketing">Marketing / Ads</option>
                                    <option value="buchhaltung">Buchhaltung / BWA</option>
                                    <option value="werkstatt">Werkstatt / Technik</option>
                                    <option value="sonstiges">Sonstiges</option>
                                </select>
                                <select id="ticketPrioInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="mittel">Prioritaet...</option>
                                    <option value="dringend">ðŸ”´ Hoch â€“ Betrieb eingeschraenkt</option>
                                    <option value="mittel">ðŸŸ¡ Mittel â€“ Wichtig, aber kein Stillstand</option>
                                    <option value="niedrig">ðŸŸ¢ Niedrig â€“ Frage / Wunsch</option>
                                </select>
                            </div>
                            <input id="ticketTitelInput" type="text" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                            <textarea id="ticketBeschreibungInput" placeholder="Beschreibe dein Problem oder deine Frage moeglichst genau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-400">Wird im Portal gespeichert</span>
                                <div class="flex space-x-2">
                                    <button onclick="document.getElementById('ticketCreate').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                    <button onclick="submitTicketForm()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Ticket erstellen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket List -->
                        <div id="ticketList" class="space-y-3"></div>

                        <!-- Zoho Desk Hinweis -->
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center space-x-3">
                            <span class="text-2xl">ðŸ”—</span>
                            <div>
                                <p class="text-sm font-semibold text-blue-800">Alle Tickets werden ueber Zoho Desk verwaltet</p>
                                <p class="text-xs text-blue-600">Fuer erweiterte Funktionen (Anhaenge, Chat, Historie) direkt in Zoho Desk oeffnen.</p>
                            </div>
                            <button class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 whitespace-nowrap">Zoho Desk oeffnen â†’</button>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Kontakte Zentrale ===== -->
                    <div id="supTabKontakte" class="sup-tab-content" style="display:none;">
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">Alle Ansprechpartner der vit:bikes Zentrale auf einen Blick. Bei dringenden Problemen bitte direkt anrufen.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="kontakteGrid"></div>
                    </div>
                </div>

                <!-- ===== IDEENBOARD VIEW ===== -->
                <div id="ideenboardView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_ideaboard">IDEENBOARD</h1>
                    <p class="text-sm text-gray-500 mb-6">Hier koennt ihr Ideen, Wuensche und Verbesserungsvorschlaege einreichen â€“ fuer das Portal, die Warenwirtschaft, den Einkauf und alles rund um vit:bikes. Jede Idee zaehlt!</p>

                    <!-- Neue Idee Button + Filter -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex space-x-2">
                            <button onclick="filterIdeen('all')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-if="all">Alle</button>
                            <button onclick="filterIdeen('neu')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="neu">Neu</button>
                            <button onclick="filterIdeen('diskussion')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="diskussion">In Diskussion</button>
                            <button onclick="filterIdeen('geplant')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="geplant">Geplant</button>
                            <button onclick="filterIdeen('umgesetzt')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="umgesetzt">Umgesetzt</button>
                        </div>
                        <button onclick="document.getElementById('ideeCreate').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ’¡ Neue Idee einreichen</button>
                    </div>

                    <!-- Neue Idee Formular -->
                    <div id="ideeCreate" class="hidden vit-card p-5 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">ðŸ’¡ Neue Idee einreichen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <select id="ideeKat" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Bereich waehlen...</option>
                                <option>Portal / Funktionen</option>
                                <option>Warenwirtschaft / Kasse</option>
                                <option>Einkauf / Sortiment</option>
                                <option>Marketing / Werbung</option>
                                <option>Verkauf / Beratung</option>
                                <option>Werkstatt / Service</option>
                                <option>Kommunikation / Zusammenarbeit</option>
                                <option>Sonstiges</option>
                            </select>
                            <select id="ideeTyp" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Typ waehlen...</option>
                                <option>ðŸš€ Neue Funktion</option>
                                <option>ðŸ”§ Verbesserung</option>
                                <option>ðŸ› Problem / Bug</option>
                                <option>ðŸ’¬ Allgemeiner Vorschlag</option>
                            </select>
                        </div>
                        <input id="ideeTitel" type="text" placeholder="Titel deiner Idee..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                        <textarea id="ideeBeschreibung" placeholder="Beschreibe deine Idee moeglichst konkret: Was genau soll verbessert werden? Warum waere das hilfreich? Wie koennte es aussehen?" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Sichtbar fuer alle Partner & die Zentrale</span>
                            <div class="flex space-x-2">
                                <button onclick="document.getElementById('ideeCreate').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                <button onclick="submitIdee()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Idee einreichen</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ideen-Statistik -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-gray-800" id="ideenTotal">0</p>
                            <p class="text-xs text-gray-500">Ideen gesamt</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" id="ideenNeu">0</p>
                            <p class="text-xs text-gray-500">Neue Ideen</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-yellow-600" id="ideenGeplant">0</p>
                            <p class="text-xs text-gray-500">Geplant</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-green-600" id="ideenUmgesetzt">0</p>
                            <p class="text-xs text-gray-500">Umgesetzt</p>
                        </div>
                    </div>

                    <!-- Ideen Liste -->
                    <div id="ideenList" class="space-y-3"></div>
                </div>

                <div id="kommunikationView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_communication">KOMMUNIKATION</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showKommTab('inbox')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="inbox">Inbox <span class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">3</span></button>
                            <button onclick="showKommTab('announce')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="announce">Ankuendigungen</button>
                            <button onclick="showKommTab('forum')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="forum">Forum</button>
                            <button onclick="showKommTab('brett')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="brett">Schwarzes Brett</button>
                            <button onclick="showKommTab('channel')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="channel">Standort-Channel</button>
                            <button onclick="showKommTab('termine')" class="komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="termine">Termine</button>
                        </nav>
                    </div>

                    <!-- ===== TAB: Inbox ===== -->
                    <div id="kommTabInbox" class="komm-tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterInbox('all')" class="inbox-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-f="all">Alle</button>
                                <button onclick="filterInbox('unread')" class="inbox-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-f="unread">Ungelesen (3)</button>
                                <button onclick="filterInbox('sent')" class="inbox-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-f="sent">Gesendet</button>
                            </div>
                            <button onclick="document.getElementById('inboxCompose').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Nachricht</button>
                        </div>

                        <!-- Compose -->
                        <div id="inboxCompose" class="hidden vit-card p-5 mb-4">
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3"><option>An: Zentrale â€“ Allgemein</option><option>An: Einkauf (Lisa Berger)</option><option>An: Marketing (Jan Krause)</option><option>An: Support / IT</option><option>An: Geschaeftsfuehrung</option></select>
                            <input type="text" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                            <textarea placeholder="Nachricht..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                            <div class="flex justify-end space-x-2">
                                <button onclick="document.getElementById('inboxCompose').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                <button onclick="sendInboxMsg()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90"'>2019+t(2019ticket_comment_send2019)+2019</button>
                            </div>
                        </div>

                        <!-- Message List -->
                        <div id="inboxList" class="space-y-2"></div>
                    </div>

                    <!-- ===== TAB: Ankuendigungen ===== -->
                    <div id="kommTabAnnounce" class="komm-tab-content" style="display:none;">
                        <div id="announceList" class="space-y-4"></div>
                    </div>

                    <!-- ===== TAB 1: Forum ===== -->
                    <div id="kommTabForum" class="komm-tab-content" style="display:none;">
                        <!-- Forum Categories -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterForum('all')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-cat="all">Alle</button>
                                <button onclick="filterForum('allgemein')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="allgemein">Allgemein</button>
                                <button onclick="filterForum('verkauf')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="verkauf">Verkauf &amp; Beratung</button>
                                <button onclick="filterForum('werkstatt')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="werkstatt">Werkstatt</button>
                                <button onclick="filterForum('einkauf')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="einkauf">Einkauf &amp; Lager</button>
                                <button onclick="filterForum('zentrale')" class="forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="zentrale">Zentrale</button>
                            </div>
                            <button onclick="document.getElementById('forumNewPost').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neuer Beitrag</button>
                        </div>

                        <!-- New Post Form (hidden) -->
                        <div id="forumNewPost" class="hidden vit-card p-5 mb-4">
                            <input type="text" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange">
                            <textarea placeholder="Deine Nachricht an das Netzwerk..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange" rows="3"></textarea>
                            <div class="flex items-center justify-between">
                                <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option>Allgemein</option><option>Verkauf &amp; Beratung</option><option>Werkstatt</option><option>Einkauf &amp; Lager</option>
                                </select>
                                <button onclick="document.getElementById('forumNewPost').classList.add('hidden')" class="px-5 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Posten</button>
                            </div>
                        </div>

                        <!-- Forum Posts -->
                        <div id="forumPosts" class="space-y-3"></div>
                    </div>

                    <!-- ===== TAB 2: Standort-Channel ===== -->
                    <div id="kommTabChannel" class="komm-tab-content" style="display:none;">
                        <!-- Channel Header -->
                        <div class="vit-card p-4 mb-4 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-vit-orange rounded-lg flex items-center justify-center text-white font-bold">#</div>
                                <div>
                                    <h3 class="font-bold text-gray-800">Grafrath Team-Chat</h3>
                                    <p class="text-xs text-gray-500">Sandra, Thomas, Dirk, Max Â· Nur fuer euer Team sichtbar</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="flex -space-x-2">
                                    <div class="w-7 h-7 bg-blue-500 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold">S</div>
                                    <div class="w-7 h-7 bg-green-500 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold">T</div>
                                    <div class="w-7 h-7 bg-purple-500 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold">D</div>
                                    <div class="w-7 h-7 bg-orange-500 rounded-full border-2 border-white flex items-center justify-center text-white text-xs font-bold">M</div>
                                </div>
                                <span class="text-xs text-green-600 font-semibold">3 online</span>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div class="vit-card overflow-hidden">
                            <div id="channelMessages" class="p-4 space-y-4 max-h-[500px] overflow-y-auto" style="min-height:400px;"></div>

                            <!-- Message Input -->
                            <div class="border-t border-gray-200 p-4 flex items-center space-x-3">
                                <button class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                                </button>
                                <input type="text" id="channelInput" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange" onkeydown="if(event.key==='Enter')sendChannelMsg()">
                                <button onclick="sendChannelMsg()" class="px-4 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90"'>2019+t(2019ticket_comment_send2019)+2019</button>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB: Schwarzes Brett ===== -->
                    <div id="kommTabBrett" class="komm-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterBrett('all')" class="brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-bc="all">Alle</button>
                                <button onclick="filterBrett('suche')" class="brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-bc="suche">Rad gesucht</button>
                                <button onclick="filterBrett('biete')" class="brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-bc="biete">Rad abzugeben</button>
                                <button onclick="filterBrett('frage')" class="brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-bc="frage">Fragen</button>
                                <button onclick="filterBrett('tipp')" class="brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-bc="tipp">Tipps</button>
                            </div>
                            <button onclick="document.getElementById('brettNewPost').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neuer Aushang</button>
                        </div>
                        <div id="brettNewPost" class="hidden vit-card p-5 mb-4">
                            <input type="text" placeholder="Titel..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                            <textarea placeholder="Beschreibung..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="3"></textarea>
                            <div class="flex items-center justify-between">
                                <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm"><option>Rad gesucht</option><option>Rad abzugeben</option><option>Frage</option><option>Tipp</option></select>
                                <button onclick="document.getElementById('brettNewPost').classList.add('hidden')" class="px-5 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Posten</button>
                            </div>
                        </div>
                        <div id="brettPosts" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <!-- ===== TAB: Termine ===== -->
                    <div id="kommTabTermine" class="komm-tab-content" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Upcoming Events -->
                            <div class="lg:col-span-2 space-y-3" id="termineList"></div>
                            <!-- Mini Calendar Sidebar -->
                            <div>
                                <div class="vit-card p-5 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-3">Februar 2026</h3>
                                    <div class="grid grid-cols-7 gap-1 text-center text-xs">
                                        <span class="text-gray-400 font-semibold py-1">Mo</span><span class="text-gray-400 font-semibold py-1">Di</span><span class="text-gray-400 font-semibold py-1">Mi</span><span class="text-gray-400 font-semibold py-1">Do</span><span class="text-gray-400 font-semibold py-1">Fr</span><span class="text-gray-400 font-semibold py-1">Sa</span><span class="text-gray-400 font-semibold py-1">So</span>
                                        <span class="py-1"></span><span class="py-1"></span><span class="py-1"></span><span class="py-1"></span><span class="py-1"></span><span class="py-1"></span><span class="py-1 text-gray-300">1</span>
                                        <span class="py-1">2</span><span class="py-1">3</span><span class="py-1">4</span><span class="py-1">5</span><span class="py-1">6</span><span class="py-1">7</span><span class="py-1 text-gray-300">8</span>
                                        <span class="py-1">9</span><span class="py-1">10</span><span class="py-1">11</span><span class="py-1">12</span><span class="py-1">13</span><span class="py-1 bg-vit-orange text-white rounded-full font-bold">14</span><span class="py-1 text-gray-300">15</span>
                                        <span class="py-1">16</span><span class="py-1">17</span><span class="py-1 bg-blue-100 text-blue-700 rounded-full font-semibold">18</span><span class="py-1">19</span><span class="py-1">20</span><span class="py-1">21</span><span class="py-1 text-gray-300">22</span>
                                        <span class="py-1">23</span><span class="py-1">24</span><span class="py-1 bg-red-100 text-red-700 rounded-full font-semibold">25</span><span class="py-1">26</span><span class="py-1 bg-blue-100 text-blue-700 rounded-full font-semibold">27</span><span class="py-1 bg-green-100 text-green-700 rounded-full font-semibold">28</span><span class="py-1 text-gray-300"></span>
                                    </div>
                                    <div class="mt-3 space-y-1 text-xs">
                                        <div class="flex items-center space-x-2"><span class="w-2 h-2 bg-vit-orange rounded-full"></span><span class="text-gray-500">Heute</span></div>
                                        <div class="flex items-center space-x-2"><span class="w-2 h-2 bg-blue-500 rounded-full"></span><span class="text-gray-500">Meeting / Schulung</span></div>
                                        <div class="flex items-center space-x-2"><span class="w-2 h-2 bg-red-500 rounded-full"></span><span class="text-gray-500">Deadline</span></div>
                                        <div class="flex items-center space-x-2"><span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-gray-500">Event</span></div>
                                    </div>
                                </div>
                                <div class="vit-card p-5">
                                    <h3 class="font-semibold text-gray-800 mb-3">Schnellzugriff</h3>
                                    <div class="space-y-2 text-sm">
                                        <a href="#" class="block text-vit-orange hover:underline">Vororder-Formular H/W 2026</a>
                                        <a href="#" class="block text-vit-orange hover:underline">Schulungskatalog 2026</a>
                                        <a href="#" class="block text-vit-orange hover:underline">Messekalender Bike-Branche</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div id="forumView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_forum">FORUM</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="vit-card p-6 mb-4">
                                <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema erstellen</button>
                            </div>

                            <div class="space-y-4">
                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Neue Marketing-Kampagne fÃ¼r FrÃ¼hjahr 2026</h3>
                                                <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Hallo zusammen! Wir haben eine neue Kampagne fÃ¼r das FrÃ¼hjahr vorbereitet. 
                                                Alle Materialien sind jetzt im Bereich "Marketing" verfÃ¼gbar. WÃ¼rde mich Ã¼ber 
                                                euer Feedback freuen!
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>8 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>42 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                <span class="text-xs text-gray-500">vor 5 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                MÃ¶chte gerne Erfahrungen austauschen zur 3D-KÃ¶rpervermessung. Wie integriert 
                                                ihr das in euren Beratungsprozess? Bei uns dauert das aktuell ca. 15-20 Minuten...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>12 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>67 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Erfolg: Firmenkunden-Akquise</h3>
                                                <span class="text-xs text-gray-500">gestern</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Wollte mal berichten: Wir haben gerade einen Deal mit einem lokalen Unternehmen 
                                                (50 Mitarbeiter) fÃ¼r Bike-Leasing abgeschlossen! ðŸŽ‰ Kann gerne Tipps teilen...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>15 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>89 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="vit-card p-6 mb-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                <div class="space-y-2">
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ”§ Technik & Service</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">45</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">â“ Fragen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">67</span>
                                    </a>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Aktive Mitglieder</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Markus Unger</p>
                                            <p class="text-xs text-gray-500">HQ - Marketing</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Stefan Meyer</p>
                                            <p class="text-xs text-gray-500">Partner MÃ¼nchen</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Julia Fischer</p>
                                            <p class="text-xs text-gray-500">Partner Berlin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kommunikation View (Chat + Forum kombiniert) -->
                <div id="communicationView" class="view premium-feature" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_communication">KOMMUNIKATION</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="flex space-x-4 mb-6">
                        <button onclick="switchCommunicationTab('chat')" id="chatTab" class="px-6 py-3 bg-vit-orange text-white rounded-lg font-semibold">
                            ðŸ’¬ Chat
                        </button>
                        <button onclick="switchCommunicationTab('forum')" id="forumTab" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                            ðŸ—¨ï¸ Forum
                        </button>
                    </div>

                    <!-- Chat Section -->
                    <div id="chatSection">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="vit-card p-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                                <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                                
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">HQ Team</p>
                                            <p class="text-xs text-gray-500 truncate">Neue Schulung verfÃ¼gbar</p>
                                        </div>
                                        <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                    </div>

                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">Thomas Schmidt</p>
                                            <p class="text-xs text-gray-500 truncate">Kunde wartet auf RÃ¼ckruf...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                                <div class="border-b p-4 flex items-center space-x-3">
                                    <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                    <div>
                                        <p class="font-semibold text-gray-800">HQ Team</p>
                                        <p class="text-xs text-green-500">â— Online</p>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto p-4">
                                    <div class="space-y-4">
                                        <div class="chat-message received">
                                            <p class="text-sm">Hey! Die neuen Marketing-Materialien sind online ðŸŽ‰</p>
                                            <p class="text-xs text-gray-500 mt-1">10:23</p>
                                        </div>

                                        <div class="chat-message sent">
                                            <p class="text-sm">Super, danke! Schaue ich mir gleich an.</p>
                                            <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                        </div>

                                        <div class="chat-message received">
                                            <p class="text-sm">Die Schulung am 22.02. - habt ihr euch schon angemeldet?</p>
                                            <p class="text-xs text-gray-500 mt-1">10:30</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t p-4">
                                    <div class="flex space-x-2">
                                        <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                        <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                            Senden
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Section (hidden by default) -->
                    <div id="forumSection" class="view-hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6 mb-4">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema</button>
                                </div>

                                <div class="space-y-4">
                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Marketing&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">FrÃ¼hjahrs-Kampagne 2026 ist live!</h3>
                                                    <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Die Materialien sind jetzt verfÃ¼gbar! WÃ¼rde mich Ã¼ber euer Feedback freuen...
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 8 Antworten</span>
                                                    <span>ðŸ‘ï¸ 42 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                    <span class="text-xs text-gray-500">gestern</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Wie integriert ihr die 3D-Vermessung in den Beratungsprozess?
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 12 Antworten</span>
                                                    <span>ðŸ‘ï¸ 67 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="vit-card p-6 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                    <div class="space-y-2">
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="chatView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_chat">CHAT</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                            <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                            
                            <div class="space-y-2">
                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Markus Unger</p>
                                        <p class="text-xs text-gray-500 truncate">Super, danke fÃ¼r die Info!</p>
                                    </div>
                                    <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Stefan Meyer</p>
                                        <p class="text-xs text-gray-500 truncate">Kannst du mir das Dokument...</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Julia Fischer</p>
                                        <p class="text-xs text-gray-500 truncate">Gerne! Schicke ich dir gleich</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Team+HQ&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Team HQ</p>
                                        <p class="text-xs text-gray-500 truncate">Neue Schulung nÃ¤chste Woche</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                            <div class="border-b p-4 flex items-center space-x-3">
                                <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-semibold text-gray-800">Markus Unger</p>
                                    <p class="text-xs text-green-500">â— Online</p>
                                </div>
                            </div>

                            <div class="flex-1 overflow-y-auto p-4">
                                <div class="space-y-4">
                                    <div class="chat-message received">
                                        <p class="text-sm">Hey! Hast du schon die neuen Marketing-Materialien gesehen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:23</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Ja, sehen super aus! Vor allem die neue FrÃ¼hjahrs-Kampagne.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Freut mich! Kannst du die gleich bei euch im Laden einsetzen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:26</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Auf jeden Fall! Wir planen das ab nÃ¤chster Woche.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:28</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Super, danke fÃ¼r die Info! ðŸ‘</p>
                                        <p class="text-xs text-gray-500 mt-1">10:30</p>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t p-4">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other views placeholders -->
                <div id="appointmentsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_calendar">TERMINE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Terminkalender wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="todosView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_todos">TODOS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Todo-Liste wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="financesView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">FILIAL-PERFORMANCE COCKPIT</h1>
                    
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-sm text-gray-500">Unternehmen / Standort: <strong>vit:bikes Grafrath</strong></p>
                            <p class="text-sm text-gray-500">Jahr: <strong>2026</strong></p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm">2026</button>
                            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">2026-01</button>
                        </div>
                    </div>

                    <!-- Top KPI Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <!-- Umsatz -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz</p>
                            <p class="text-3xl font-bold text-gray-800">55 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag</p>
                            <p class="text-3xl font-bold text-gray-800">21 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag Marge % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag Marge %</p>
                            <p class="text-3xl font-bold text-gray-800">38,88%</p>
                        </div>

                        <!-- Gesamtkosten -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Gesamtkosten</p>
                            <p class="text-3xl font-bold text-gray-800">25 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT</p>
                            <p class="text-3xl font-bold text-red-600">-4 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT-Marge % -->
                        <div class="vit-card p-6 bg-red-50">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT-Marge %</p>
                            <p class="text-3xl font-bold text-red-600">-7,16%</p>
                        </div>

                        <!-- Kostenquote % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Kostenquote %</p>
                            <p class="text-3xl font-bold text-gray-800">46,13%</p>
                        </div>

                        <!-- Umsatz YoY % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz YoY %</p>
                            <p class="text-3xl font-bold text-green-600">78,54%</p>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Umsatz vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ VS PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-32 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                55k
                                            </div>
                                            <div class="bg-gray-300 h-24 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                40k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Umsatz</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rohertrag vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">ROHERTRAG VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-28 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                21k
                                            </div>
                                            <div class="bg-gray-300 h-20 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                18k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Rohertrag</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EBIT vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">EBIT VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end justify-center space-x-4 h-32">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-vit-orange w-16 h-16 rounded flex items-center justify-center text-white text-xs font-semibold">
                                            -4k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">EBIT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-gray-300 w-16 h-24 rounded flex items-center justify-center text-gray-700 text-xs font-semibold">
                                            -7k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">Plan</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YTD Metrics -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">Umsatz YTD vs VJ%</p>
                            <p class="text-4xl font-bold text-green-600">â†‘ 78,5%</p>
                        </div>

                        <div class="vit-card p-6 bg-red-50 border border-red-200">
                            <p class="text-sm text-gray-600 mb-2">Kosten YTD vs VJ %</p>
                            <p class="text-4xl font-bold text-red-600">â†‘ 62,0%</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">EBIT-Marge Î” (%-Pkt.)</p>
                            <p class="text-4xl font-bold text-green-600">4,3 pp</p>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Kostenstruktur Pie Chart -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTENSTRUKTUR (% DER GESAMTKOSTEN)</h2>
                            <div class="flex items-center justify-center">
                                <div class="relative w-48 h-48">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <!-- Personalkosten 53% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#EF7D00" stroke-width="80" stroke-dasharray="167 335" stroke-dashoffset="0"></circle>
                                        <!-- Werbe-/Reisekosten 17% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#F59E0B" stroke-width="80" stroke-dasharray="54 335" stroke-dashoffset="-167"></circle>
                                        <!-- Raummieten 8% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FCD34D" stroke-width="80" stroke-dasharray="25 335" stroke-dashoffset="-221"></circle>
                                        <!-- Sonstige 22% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FEF3C7" stroke-width="80" stroke-dasharray="69 335" stroke-dashoffset="-246"></circle>
                                    </svg>
                                </div>
                                <div class="ml-6 space-y-2 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-vit-orange rounded"></div>
                                        <span>Personalkosten</span>
                                        <span class="font-semibold">53%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-500 rounded"></div>
                                        <span>Werbe-/Reisekosten</span>
                                        <span class="font-semibold">17%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-300 rounded"></div>
                                        <span>Raummieten</span>
                                        <span class="font-semibold">8%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-100 rounded"></div>
                                        <span>Sonstige</span>
                                        <span class="font-semibold">22%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kosten vs Plan Trend -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTEN VS PLAN - TREND</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Personalkosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-12 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">25% / 32%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Raummieten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-8 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">8% / 10%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Werbe-/Reisekosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-4 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-6 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">4% / 7%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Sonstige</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-10 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-14 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">10% / 13%</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs pt-2 border-t">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Kosten Anteil am Umsatz %</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Kosten Anteil am Plan-Umsatz %</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Benchmarking -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">ABWEICHUNG ROHERTRAGSMARGE ZUM STANDORT-BENCHMARK (%-PKT.)</h2>
                            <p class="text-5xl font-bold text-green-600">29,6 pp</p>
                            <p class="text-sm text-gray-600 mt-2">Ãœberdurchschnittliche Leistung</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">BENCHMARK IM VERGLEICH ZUR UMSATZKLASSE</h2>
                            <p class="text-5xl font-bold text-green-600">â†‘ 107,7%</p>
                            <p class="text-sm text-gray-600 mt-2">Weit Ã¼ber dem Durchschnitt der Umsatzklasse</p>
                        </div>
                    </div>

                    <!-- Marketing -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ZU UMSATZ (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">4%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ANTEIL AN GESAMTKOSTEN (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">8%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN STANDORT (â‚¬)</h2>
                            <p class="text-4xl font-bold text-vit-orange">2.039,00 â‚¬</p>
                        </div>
                    </div>
                </div>
                <div id="teamView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">TEAM</h1>
                    
                    <!-- Team Ãœbersicht -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Mitarbeiter</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">8</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                5 Vollzeit, 3 Teilzeit
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Ã˜ Zufriedenheit</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">4.6/5</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Letzte Team-Umfrage
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Krankheitstage</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">12</p>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Dieses Quartal
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Schulungen</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">23</p>
                                </div>
                                <div class="bg-vit-orange bg-opacity-10 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-vit-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Abgeschlossen 2026
                            </div>
                        </div>
                    </div>

                    <!-- Mitarbeiter Liste -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MITARBEITER</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Thomas Schmidt</h3>
                                            <p class="text-sm text-gray-500">Verkaufsleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">32 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Sarah+Mueller&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Sarah MÃ¼ller</h3>
                                            <p class="text-sm text-gray-500">Verkauf & Beratung</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">28 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Michael+Weber&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Michael Weber</h3>
                                            <p class="text-sm text-gray-500">Werkstattleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">98% Auslastung</p>
                                        <p class="text-xs text-gray-500">Werkstatt</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Lisa+Klein&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Lisa Klein</h3>
                                            <p class="text-sm text-gray-500">Zweiradmechatronikerin</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">142 AuftrÃ¤ge</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Jan+Hoffmann&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Jan Hoffmann</h3>
                                            <p class="text-sm text-gray-500">Verkauf (Teilzeit)</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">15 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schichtplan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">SCHICHTPLAN DIESE WOCHE</h2>
                            <div class="space-y-2">
                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Montag, 10.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Dienstag, 11.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Mittwoch, 12.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Donnerstag, 13.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-vit-orange">Freitag, 14.02. (Heute)</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange text-white px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Samstag, 15.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-16h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (9-16h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (9-16h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (9-16h)</span>
                                    </div>
                                </div>
                            </div>

                            <button class="mt-4 w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90 text-sm">
                                Schichtplan bearbeiten
                            </button>
                        </div>
                    </div>

                    <!-- Anstehende Schulungen -->
                    <div class="vit-card p-6">
                        <h2 class="h2-headline text-gray-800 mb-4">ANSTEHENDE SCHULUNGEN</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-vit-orange bg-opacity-5 border border-vit-orange rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">E-Bike Antriebstechnik 2026</h4>
                                <p class="text-sm text-gray-600 mb-3">Bosch & Shimano Updates</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 22.02.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 3 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Verkaufstraining Premium</h4>
                                <p class="text-sm text-gray-600 mb-3">Hochpreisige RÃ¤der verkaufen</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 05.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 4 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Kundenservice Excellence</h4>
                                <p class="text-sm text-gray-600 mb-3">Kundenzufriedenheit steigern</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 12.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ Alle</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="partnersView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">STANDORTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Partner-Ãœbersicht wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="analyticsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">ANALYTICS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Analytics-Dashboard wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="documentsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">DOKUMENTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Dokumentenverwaltung wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="knowledgeView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">INFOS (WISSEN)</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Produkt-HandbÃ¼cher</h3>
                            <p class="text-sm text-gray-600 mb-4">Technische Dokumentation aller E-Bike Hersteller</p>
                            <span class="text-xs text-gray-500">142 Dokumente</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-blue-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Schulungsvideos</h3>
                            <p class="text-sm text-gray-600 mb-4">Video-Tutorials zu Verkauf, Service und Technik</p>
                            <span class="text-xs text-gray-500">67 Videos</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-green-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-green-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">FAQ</h3>
                            <p class="text-sm text-gray-600 mb-4">HÃ¤ufig gestellte Fragen zu allen Themen</p>
                            <span class="text-xs text-gray-500">89 EintrÃ¤ge</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-purple-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-purple-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Werkstatt-Guides</h3>
                            <p class="text-sm text-gray-600 mb-4">Reparatur-Anleitungen und Wartungs-Tipps</p>
                            <span class="text-xs text-gray-500">54 Guides</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer premium-feature">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">vit:bikes Akademie</h3>
                            <p class="text-sm text-gray-600 mb-4">Exklusive Schulungen fÃ¼r Partner</p>
                            <span class="premium-badge text-[8px] px-2 py-1">PREMIUM</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-yellow-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-yellow-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Vorlagen & Checklisten</h3>
                            <p class="text-sm text-gray-600 mb-4">Beratungs-Checklisten, VerkaufsleitfÃ¤den</p>
                            <span class="text-xs text-gray-500">28 Vorlagen</span>
                        </div>
                    </div>
                </div>

                <!-- ===== WISSEN (Zentrale Wissensdatenbank) ===== -->
                <div id="wissenView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ“š WISSENSDATENBANK</h1>
                            <p class="text-sm text-gray-500">Alle Schulungen, Handbuecher, Best Practices und FAQs an einem Ort.</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="wissenSearch" placeholder="Suchen..." oninput="filterWissenGlobal()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm w-48">
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="wissenKpis"></div>

                    <!-- Bereich-Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterWissenBereich('all')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-wbf="all">ðŸ“š Alle Bereiche</button>
                        <button onclick="filterWissenBereich('allgemein')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="allgemein">ðŸ¢ Allgemein</button>
                        <button onclick="filterWissenBereich('verkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="verkauf">ðŸ’° Verkauf</button>
                        <button onclick="filterWissenBereich('einkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="einkauf">ðŸ›’ Einkauf</button>
                        <button onclick="filterWissenBereich('marketing')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="marketing">ðŸ“£ Marketing</button>
                        <button onclick="filterWissenBereich('controlling')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="controlling">ðŸ“Š Controlling</button>
                    </div>

                    <!-- Typ-Tabs -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button onclick="switchWissenTyp('akademie')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-wtt="akademie">ðŸŽ“ Akademie</button>
                            <button onclick="switchWissenTyp('handbuecher')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="handbuecher">ðŸ“– Handbuecher</button>
                            <button onclick="switchWissenTyp('bestpractices')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="bestpractices">ðŸ’¡ Best Practices</button>
                            <button onclick="switchWissenTyp('faq')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="faq">â“ FAQ</button>
                        </nav>
                    </div>

                    <!-- Content -->
                    <div id="wissenGlobalContent" class="space-y-3"></div>
                </div>

                <!-- ===== WERBEMITTEL-SHOP ===== -->
                <div id="shopView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ›ï¸ WERBEMITTEL-SHOP</h1>
                            <p class="text-sm text-gray-500">Offizielle vit:bikes Werbemittel fuer deinen Standort bestellen.</p>
                        </div>
                        <button onclick="document.getElementById('shopCart').classList.toggle('hidden')" class="relative bg-vit-orange text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90">
                            ðŸ›’ Warenkorb <span id="shopCartCount" class="ml-1 bg-white text-vit-orange rounded-full px-1.5 text-xs font-bold">0</span>
                        </button>
                    </div>

                    <!-- Cart Overlay -->
                    <div id="shopCart" class="hidden mb-6 vit-card p-5 border-2 border-vit-orange">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ›’ Dein Warenkorb</h3>
                        <div id="shopCartItems" class="space-y-2 mb-4"></div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                            <span class="font-bold text-gray-800">Gesamt: <span id="shopCartTotal">0,00</span> â‚¬</span>
                            <button onclick="submitShopOrder()" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">Bestellen</button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterShop('all')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-sf="all">Alle</button>
                        <button onclick="filterShop('print')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="print">ðŸ–¨ï¸ Drucksachen</button>
                        <button onclick="filterShop('textil')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="textil">ðŸ‘• Textilien</button>
                        <button onclick="filterShop('display')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="display">ðŸª Displays</button>
                        <button onclick="filterShop('digital')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="digital">ðŸ’» Digital</button>
                        <button onclick="filterShop('give')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="give">ðŸŽ Giveaways</button>
                    </div>

                    <!-- Product Grid -->
                    <div id="shopGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>

                    <!-- Order Confirmation Modal -->
                    <div id="shopOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
                            <div class="text-5xl mb-4">âœ…</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Bestellung eingegangen!</h3>
                            <p class="text-sm text-gray-500 mb-2">Deine Bestellung wird bearbeitet und an deinen Standort geliefert.</p>
                            <p class="text-xs text-gray-400 mb-6">Bestell-Nr.: VB-<span id="shopOrderNr"></span></p>
                            <button onclick="document.getElementById('shopOrderModal').classList.add('hidden')" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">OK</button>
                        </div>
                    </div>
                </div>

                <div id="onboardingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_onboarding">ONBOARDING</h1>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 mb-4">Willkommen bei vit:bikes! Hier findest du alle Aufgaben fÃ¼r deinen erfolgreichen Start.</p>
                    </div>

                    <!-- Asana Project Container (wird dynamisch gefÃ¼llt) -->
                    <div id="asanaOnboardingContent">
                        <!-- Wird via JavaScript befÃ¼llt -->
                    </div>

                    <!-- Static Content als Fallback -->
                    <div id="staticOnboardingContent">
                    <!-- Asana Project wird hier angezeigt -->
                    <div class="vit-card p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="h2-headline text-gray-800">Dein Onboarding-Plan</h2>
                            <button class="text-sm text-vit-orange hover:underline font-semibold">In Asana Ã¶ffnen â†’</button>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6">Arbeite dich durch diese Aufgaben, um optimal vorbereitet zu sein!</p>

                        <!-- Onboarding Fortschritt -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">Gesamt-Fortschritt</span>
                                <span class="text-sm font-semibold text-vit-orange">65%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-vit-orange h-3 rounded-full" style="width: 65%"></div>
                            </div>
                        </div>

                        <!-- Section: Erste Schritte -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">âœ“</span>
                                Erste Schritte
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Portalzugang einrichten</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Willkommensvideo ansehen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Team-Mitglieder einladen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Produkt-Schulung -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-vit-orange text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2/4</span>
                                Produkt-Schulung
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">E-Bike Grundlagen Kurs absolvieren</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Marken-Portfolio kennenlernen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-white border-2 border-vit-orange rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700 font-semibold">3D-Vermessungs-System Training</span>
                                    <span class="ml-auto px-2 py-1 bg-vit-orange text-white text-xs rounded">In Arbeit</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Werkstatt-Prozesse verstehen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 20.02.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Verkaufsprozesse -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-gray-300 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">0/5</span>
                                Verkaufsprozesse
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">CRM-System einrichten</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 18.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">BeratungsgesprÃ¤ch-Training</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 22.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Finanzierungs- & Leasing-Optionen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 25.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Probefahrt-Prozess durchfÃ¼hren</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 28.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Ersten Verkauf abschlieÃŸen ðŸŽ¯</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 03.03.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Marketing & Kommunikation -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-gray-300 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">0/3</span>
                                Marketing & Kommunikation
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Social Media Guidelines durchgehen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 19.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Ersten Social Media Post erstellen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 24.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Marketing-Materialien herunterladen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 26.02.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hilfe & Support -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">ðŸ“ž Brauchst du Hilfe?</h3>
                            <p class="text-sm text-gray-600 mb-4">Unser Onboarding-Team steht dir zur VerfÃ¼gung!</p>
                            <button class="w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90">
                                Support kontaktieren
                            </button>
                        </div>

                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">ðŸ“š Weitere Ressourcen</h3>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ Handbuch fÃ¼r neue Partner</a></li>
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ Video-Tutorials</a></li>
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ FAQ fÃ¼r Einsteiger</a></li>
                            </ul>
                        </div>
                    </div>
                    </div><!-- End staticOnboardingContent -->
                </div>

                <!-- MITARBEITER VIEW (Partner/GF) -->
                <div id="mitarbeiterView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ‘¥ MITARBEITER</h1>
                    <p class="text-sm text-gray-500 mb-6">Mitarbeiter Ihres Standorts verwalten und Rollen zuweisen.</p>

                    <!-- KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-gray-800" id="pMaGesamt">0</div><div class="text-xs text-gray-500">Mitarbeiter</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="pMaAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600" id="pMaOnb">0</div><div class="text-xs text-gray-500">Im Onboarding</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="pMaRollen">4</div><div class="text-xs text-gray-500">Rollen verfÃ¼gbar</div></div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex space-x-2">
                            <button onclick="filterPartnerMa('all')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-pmf="all">Alle</button>
                            <button onclick="filterPartnerMa('aktiv')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="aktiv">ðŸŸ¢ Aktiv</button>
                            <button onclick="filterPartnerMa('demo')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="demo">ðŸ”´ Demo</button>
                            <button onclick="filterPartnerMa('onboarding')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="onboarding">ðŸ”µ Onboarding</button>
                        </div>
                        <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                    </div>

                    <!-- Mitarbeiter Table -->
                    <div class="vit-card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">E-Mail</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Rollen</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Eintritt</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="partnerMaBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="notificationsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">BENACHRICHTIGUNGEN</h1>

                    <!-- Filter -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterNotif('all')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-nf="all">Alle</button>
                        <button onclick="filterNotif('unread')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="unread">Ungelesen</button>
                        <button onclick="filterNotif('system')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="system">System</button>
                        <button onclick="filterNotif('hq')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="hq">HQ</button>
                        <button class="ml-auto text-xs text-vit-orange font-semibold hover:underline" onclick="document.querySelectorAll('.notif-dot').forEach(function(d){d.remove();}); document.querySelector('.absolute.-top-1.-right-1').textContent='0';">Alle als gelesen markieren</button>
                    </div>

                    <div id="notifList" class="space-y-2"></div>
                </div>

                <!-- ===== KALENDER VIEW ===== -->
                <div id="kalenderView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="h1-headline text-gray-800">KALENDER</h1>
                        <div class="flex items-center space-x-3">
                            <select id="kalFilterUser" onchange="renderKalender()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <option value="all">Alle Termine (Standort)</option>
                                <option value="me">Nur meine Termine</option>
                            </select>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openKalDayModal(new Date().toISOString().slice(0,10))">+ Neuer Termin</button>
                        </div>
                    </div>

                    <!-- Month Navigation -->
                    <div class="flex items-center justify-between mb-4">
                        <button onclick="kalNavMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <h2 class="text-lg font-bold text-gray-800" id="kalMonthTitle">Februar 2026</h2>
                        <button onclick="kalNavMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="vit-card overflow-hidden">
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                            <div class="py-2 text-center text-xs font-semibold text-gray-500">Mo</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500">Di</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500">Mi</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500">Do</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500">Fr</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">Sa</div>
                            <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">So</div>
                        </div>
                        <!-- Calendar Body -->
                        <div id="kalGrid" class="grid grid-cols-7"></div>
                    </div>

                    <!-- Upcoming list -->
                    <h3 class="font-bold text-gray-800 mt-6 mb-3">Anstehende Termine</h3>
                    <div id="kalUpcoming" class="space-y-2"></div>

                    <!-- Termin Modal (New + Edit) -->
                    <div id="kalNewModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                            <h3 id="kalModalTitle" class="font-bold text-gray-800 text-lg mb-4">Neuen Termin anlegen</h3>
                            <div class="space-y-3">
                                <input type="text" id="kalNewTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="date" id="kalNewDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="kalNewGanztaegig" onchange="document.getElementById('kalTimeFields').style.display=this.checked?'none':''">
                                        <label for="kalNewGanztaegig" class="text-xs text-gray-600">GanztÃ¤gig</label>
                                    </div>
                                </div>
                                <div id="kalTimeFields" class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] text-gray-500">Von</label><input type="time" id="kalNewTime" value="09:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <div><label class="text-[10px] text-gray-500">Bis</label><input type="time" id="kalNewEndTime" value="10:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                </div>
                                <input type="text" id="kalNewOrt" placeholder="Ort (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <select id="kalNewType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <option value="beratung">Beratung</option>
                                    <option value="probefahrt">Probefahrt</option>
                                    <option value="werkstatt">Werkstatt-Abholung</option>
                                    <option value="meeting">Team-Meeting</option>
                                    <option value="schulung">Schulung</option>
                                    <option value="event">Event</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="sonstig">Sonstiges</option>
                                </select>
                                <textarea id="kalNewNotes" placeholder="Notizen (optional)" rows="2" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button id="kalSaveBtn" onclick="saveKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                <button onclick="document.getElementById('kalNewModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                            </div>
                            <button id="kalDeleteBtn" onclick="deleteKalTermin()" style="display:none" class="w-full mt-2 py-2 text-red-500 text-sm font-semibold hover:bg-red-50 rounded-lg">ðŸ—‘ï¸ Termin lÃ¶schen</button>
                        </div>
                    </div>
                </div>

                <!-- ===== TODO VIEW ===== -->
                <div id="todoView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="h1-headline text-gray-800" data-i18n="h_todos">AUFGABEN</h1>
                        <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="document.getElementById('todoNewModal').classList.remove('hidden')">+ Neue Aufgabe</button>
                    </div>

                    <!-- KPI -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="todoKpiOffen">5</p><p class="text-xs text-gray-500" id="todoKpiOffenLabel" data-i18n="todo_open">Offen</p></div>
                        <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="todoKpiHeute">2</p><p class="text-xs text-gray-500" id="todoKpiHeuteLabel" data-i18n="todo_today">F&auml;llig heute</p></div>
                        <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="todoKpiUeber">1</p><p class="text-xs text-gray-500" id="todoKpiUeberLabel" data-i18n="todo_overdue">&Uuml;berf&auml;llig</p></div>
                        <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="todoKpiDone">12</p><p class="text-xs text-gray-500" id="todoKpiDoneLabel" data-i18n="todo_done">Erledigt (KW)</p></div>
                    </div>

                    <!-- Filter -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterTodos('all')" class="todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-tf="all">Alle offen</button>
                        <button onclick="filterTodos('heute')" class="todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-tf="heute">Heute</button>
                        <button onclick="filterTodos('ueberfaellig')" class="todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-tf="ueberfaellig">ÃœberfÃ¤llig</button>
                        <button onclick="filterTodos('done')" class="todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-tf="done">âœ… Erledigt</button>
                    </div>

                    <div id="todoList" class="space-y-2"></div>

                    <!-- New Todo Modal -->
                    <div id="todoNewModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">Neue Aufgabe</h3>
                            <div class="space-y-3">
                                <input type="text" id="todoNewTitle" placeholder="Aufgabe" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="date" id="todoNewDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <select id="todoNewPrio" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="normal">Normal</option>
                                        <option value="hoch">Hoch</option>
                                        <option value="niedrig">Niedrig</option>
                                    </select>
                                </div>
                                <select id="todoNewKat" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <option value="verkauf">Verkauf</option>
                                    <option value="werkstatt">Werkstatt</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="admin">Administration</option>
                                    <option value="sonstig">Sonstiges</option>
                                </select>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button onclick="addTodo()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                <button onclick="document.getElementById('todoNewModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== ALLGEMEIN VIEW ===== -->
                <div id="allgemeinView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">ALLGEMEIN</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showAllgemeinTab('uebersicht')" class="allg-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="uebersicht">Standort-Uebersicht</button>
                            <button onclick="showAllgemeinTab('strategie')" class="allg-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="strategie">ðŸ“‹ Strategie</button>
                            <button onclick="showAllgemeinTab('wissen')" class="allg-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="wissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- TAB 1: Standort-Uebersicht -->
                    <div id="allgTabUebersicht" class="allg-tab-content">
                        <div class="vit-card p-6 mb-6">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-14 h-14 bg-vit-orange rounded-xl flex items-center justify-center text-white font-bold text-xl">G</div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">vit:bikes Grafrath</h2>
                                    <p class="text-sm text-gray-500">Jesenwanger Str. 52 Â· 82284 Grafrath Â· Tel: 08144/5519377</p>
                                </div>
                                <span class="ml-auto px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Aktiver Partner</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-400">Inhaber</p><p class="text-sm font-semibold">Sandra &amp; Thomas Engelmann</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-400">Mitarbeiter</p><p class="text-sm font-semibold">4 Verkaeufer + Werkstatt</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-400">Schwerpunkt</p><p class="text-sm font-semibold">E-Bikes, Trekking, MTB</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-400">Google-Bewertung</p><p class="text-sm font-semibold">â­ 4,9 (127 Rezensionen)</p></div>
                            </div>
                        </div>

                        <!-- Ansprechpartner vit:bikes -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="vit-card p-5">
                                <p class="text-xs text-gray-400 mb-2">Marketing</p>
                                <p class="font-semibold">Michael Stenzel</p>
                                <p class="text-xs text-gray-500">Jahresgespraech 23.12.2025</p>
                            </div>
                            <div class="vit-card p-5">
                                <p class="text-xs text-gray-400 mb-2">Einkauf</p>
                                <p class="font-semibold">Florian Meier</p>
                                <p class="text-xs text-gray-500">Strategie vom 15.09.2025</p>
                            </div>
                            <div class="vit-card p-5">
                                <p class="text-xs text-gray-400 mb-2">Geschaeftsfuehrung vit:bikes</p>
                                <p class="font-semibold">Sascha Matthies</p>
                                <p class="text-xs text-gray-500">Mitunterzeichner Einkaufsstrategie</p>
                            </div>
                        </div>

                        <!-- Schnellzugriffe -->
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">Schnellzugriff</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onclick="showView('marketing'); showMarketingTab('mktStrategie')" class="p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition text-center"><p class="text-2xl mb-1">ðŸ“¢</p><p class="text-xs font-semibold">Marketing-Strategie</p></button>
                                <button onclick="showView('einkauf'); showEinkaufTab('ekStrategie')" class="p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition text-center"><p class="text-2xl mb-1">ðŸ›’</p><p class="text-xs font-semibold">Einkaufsstrategie</p></button>
                                <button onclick="showView('controlling'); showControllingTab('bwa')" class="p-4 bg-green-50 rounded-lg hover:bg-green-100 transition text-center"><p class="text-2xl mb-1">ðŸ“Š</p><p class="text-xs font-semibold">BWA &amp; Controlling</p></button>
                                <button onclick="showView('aktenschrank')" class="p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition text-center"><p class="text-2xl mb-1">ðŸ“</p><p class="text-xs font-semibold">Aktenschrank</p></button>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: Strategie (Gesamtueberblick) -->
                    <div id="allgTabStrategie" class="allg-tab-content" style="display:none;">
                        <div class="vit-card p-6 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-semibold text-gray-800">Strategie-Ueberblick 2026 â€“ vit:bikes Grafrath</h2>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Alle Strategien vereinbart</span>
                            </div>
                            <p class="text-sm text-gray-500">Zusammenfassung aller strategischen Vereinbarungen fuer den Standort Grafrath</p>
                        </div>

                        <!-- Marketing-Strategie Zusammenfassung -->
                        <div class="vit-card p-6 mb-6 border-l-4 border-vit-orange">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“¢</span> Marketing-Strategie 2026</h3>
                                <button onclick="showView('marketing'); showMarketingTab('mktStrategie')" class="text-xs text-vit-orange hover:text-orange-600 font-semibold">Details anzeigen â†’</button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                <div class="p-3 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-400">Budget/Monat</p><p class="text-lg font-bold text-vit-orange">1.500 â‚¬</p></div>
                                <div class="p-3 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-400">Mediamix</p><p class="text-sm font-bold text-blue-600">Meta + Google</p></div>
                                <div class="p-3 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-400">Storevisit-Ziel</p><p class="text-lg font-bold text-green-600">103%</p></div>
                                <div class="p-3 bg-yellow-50 rounded-lg text-center"><p class="text-xs text-gray-400">Terminziel</p><p class="text-lg font-bold text-yellow-600">56%</p></div>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>âœ“ Individuelle Ads mit besserem Performance &amp; Authentizitaet</p>
                                <p>âœ“ Organische Platzierung auf YouTube, Meta &amp; TikTok</p>
                                <p>âœ“ Lokale Events zur Kundenbindung &amp; Neukundengewinnung</p>
                                <p>âœ“ Content-Unterstuetzung durch vit:bikes Content-Team</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-3">Vereinbart am 23.12.2025 Â· Unterschrieben: Michael Stenzel, Sandra &amp; Thomas Engelmann</p>
                        </div>

                        <!-- Einkaufsstrategie Zusammenfassung -->
                        <div class="vit-card p-6 mb-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800 flex items-center"><span class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ›’</span> Einkaufsstrategie 2026</h3>
                                <button onclick="showView('einkauf'); showEinkaufTab('ekStrategie')" class="text-xs text-blue-600 hover:text-blue-700 font-semibold">Details anzeigen â†’</button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                <div class="p-3 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-400">Bike-Bestand (09/25)</p><p class="text-lg font-bold text-blue-600">156</p></div>
                                <div class="p-3 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-400">Zielmarken 2026</p><p class="text-lg font-bold text-green-600">6</p></div>
                                <div class="p-3 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-400">Vororder Kalkhoff</p><p class="text-lg font-bold text-vit-orange">80 Bikes</p></div>
                                <div class="p-3 bg-red-50 rounded-lg text-center"><p class="text-xs text-gray-400">Ã˜ Nachlass</p><p class="text-lg font-bold text-red-600">8,7%</p><p class="text-xs text-red-400">Ziel: unter 5%</p></div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                                <div class="p-2 bg-green-50 rounded text-xs"><span class="font-semibold">Kalkhoff</span> â€“ VO 80 Bikes</div>
                                <div class="p-2 bg-green-50 rounded text-xs"><span class="font-semibold">Haibike</span> â€“ Blockorder 30-50 eMTBs</div>
                                <div class="p-2 bg-green-50 rounded text-xs"><span class="font-semibold">Orbea</span> â€“ Hoechster DB1</div>
                                <div class="p-2 bg-green-50 rounded text-xs"><span class="font-semibold">Simplon</span> â€“ VO 10 (Gravel/MTB)</div>
                                <div class="p-2 bg-blue-50 rounded text-xs"><span class="font-semibold">Velo de Ville</span> â€“ NEU, 8 Bikes</div>
                                <div class="p-2 bg-blue-50 rounded text-xs"><span class="font-semibold">Steppenwolf</span> â€“ 5 Bikes, ab Juli</div>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>âœ“ Sortiment auf 6 Zielmarken umstellen, Auslaufmarken abverkauft</p>
                                <p>âœ“ Orbea &amp; Simplon aktiv pushen fuer hoeheren Rohertrag</p>
                                <p>âœ“ Rabatte minimieren â€“ Dreingaben statt Preisnachlaesse (Sqlab-Tipp)</p>
                                <p>âœ“ Haibike-Blockorder mit Valuta-Klausel bei Fruehlieferung</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-3">Vereinbart am 15.09.2025 Â· Unterschrieben: Florian Meier, Sandra Engelmann, Sascha Matthies</p>
                        </div>

                        <!-- Strategische Prioritaeten -->
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-green-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸŽ¯</span> Strategische Prioritaeten 2026</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                    <span class="text-red-600 font-bold text-sm mt-0.5">P1</span>
                                    <div><p class="font-semibold text-sm">Rohertrag steigern</p><p class="text-xs text-gray-500">Rabatte unter 5% halten. Orbea (hoechster DB1) und Simplon (hoechster VK) aktiv verkaufen. Sqlab-Sattel statt Rabatt.</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange">
                                    <span class="text-vit-orange font-bold text-sm mt-0.5">P2</span>
                                    <div><p class="font-semibold text-sm">Haibike eMTB-Sortiment sichern</p><p class="text-xs text-gray-500">Blockorder 30-50 AllMtn/AllTrack/Adventr mit Bosch. Konditionen wackeln â€“ Volumen wichtig fuer Netzwerk.</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                    <span class="text-blue-600 font-bold text-sm mt-0.5">P3</span>
                                    <div><p class="font-semibold text-sm">Marketing-Budget effizient nutzen</p><p class="text-xs text-gray-500">1.500 â‚¬/Monat. CPT senken (aktuell 205 â‚¬ vs. Netzwerk 163 â‚¬). Terminziel von 56% auf 80%+ steigern.</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                                    <span class="text-green-600 font-bold text-sm mt-0.5">P4</span>
                                    <div><p class="font-semibold text-sm">Neue Marken etablieren</p><p class="text-xs text-gray-500">Velo de Ville (Alternative Trekking) und Steppenwolf (sportives DJI) erfolgreich einfuehren.</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                                    <span class="text-purple-600 font-bold text-sm mt-0.5">P5</span>
                                    <div><p class="font-semibold text-sm">Lokale Events &amp; Authentizitaet</p><p class="text-xs text-gray-500">Testivals, Grillvents, individuelle Ads. Benefit statt Rabatt kommunizieren. Haendlerprofil schaerfen.</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: Wissen -->
                    <div id="allgTabWissen" class="allg-tab-content" style="display:none;"></div>
                </div>

                <!-- ================================================================= -->
                <!-- ==================== HQ VIEWS ================================== -->
                <!-- ================================================================= -->

                <!-- ===== HQ NETZWERK-COCKPIT ===== -->
                <div id="hqCockpitView" class="view" style="display: none;">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">NETZWERK-COCKPIT ðŸ‘‹</h1>
                            <p class="text-sm text-gray-500" id="hqWelcomeDate">Willkommen zurueck</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-gray-400">Stand: 14.02.2026</span>
                            <select id="hqPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqCockpit()">
                                <option value="ytd">YTD 2026</option>
                                <option value="jan">Januar 2026</option>
                                <option value="feb">Februar 2026</option>
                            </select>
                        </div>
                    </div>

                    <!-- Schnellzugriffe HQ -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
                        <button onclick="showView('hqAktionen')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸš¨</p><p class="text-[10px] font-semibold text-gray-700">Handlungsbedarf</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kampagnen')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸŽ¯</p><p class="text-[10px] font-semibold text-gray-700">Kampagnen</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kommunikation')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“¢</p><p class="text-[10px] font-semibold text-gray-700">Kommunikation</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('aufgaben')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“‹</p><p class="text-[10px] font-semibold text-gray-700">Aufgaben</p></button>
                        <button onclick="showView('hqKommando')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">âš™ï¸</p><p class="text-[10px] font-semibold text-gray-700">Kommandozentrale</p></button>
                        <button onclick="showView('hqAuswertung')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“Š</p><p class="text-[10px] font-semibold text-gray-700">Auswertung</p></button>
                    </div>

                    <!-- Netzwerk KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKpiCards"></div>

                    <!-- Handlungsbedarf Ticker -->
                    <div class="vit-card p-4 mb-6 border-l-4 border-red-500" id="hqAlertBox"></div>

                    <!-- 3-Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- LEFT 2/3: Rankings + Kampagnen + Grid -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Top 5 Standorte</h2>
                                    <div id="hqTop5" class="space-y-2"></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Bottom 5 â€“ Handlungsbedarf</h2>
                                    <div id="hqBottom5" class="space-y-2"></div>
                                </div>
                            </div>

                            <!-- Kampagnen Kompakt -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸŽ¯ Aktive Kampagnen</h2>
                                    <button onclick="showView('hqKampagnen')" class="text-xs text-vit-orange font-semibold hover:underline">Alle anzeigen â†’</button>
                                </div>
                                <div id="hqHomeKampagnen" class="space-y-2"></div>
                            </div>

                            <!-- Standort-Grid -->
                            <div class="vit-card p-5">
                                <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“Š Alle Standorte â€“ Lead-Performance</h2>
                                <div class="flex items-center space-x-4 mb-3 text-[10px] text-gray-500">
                                    <span>ðŸ”´ &lt; 50%</span><span>ðŸŸ  50-75%</span><span>ðŸŸ¢ 75-100%</span><span>ðŸŸ¡ â‰¥ 100%</span>
                                </div>
                                <div id="hqStandortGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
                            </div>
                        </div>

                        <!-- RIGHT 1/3: Live-Feed -->
                        <div class="space-y-6">
                            <!-- Offene Aufgaben -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“‹ Offene Aufgaben</h2>
                                    <button onclick="showView('hqAufgaben')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAufgaben" class="space-y-2"></div>
                            </div>

                            <!-- Naechste Termine -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“… Naechste Termine</h2>
                                    <button onclick="showView('hqKalender')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeTermine" class="space-y-2"></div>
                            </div>

                            <!-- Letzte Ankuendigungen -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“¢ Letzte Ankuendigungen</h2>
                                    <button onclick="showView('hqKomm')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAnnounce" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ===== HQ STANDORTE ===== -->
                <div id="hqStandorteView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="h1-headline text-gray-800">STANDORTE</h1>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="hqStandortSearch" placeholder="Standort suchen..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" oninput="renderHqStandorte()">
                            <select id="hqStandortFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqStandorte()">
                                <option value="all">Alle</option>
                                <option value="kritisch">ðŸ”´ Kritisch (&lt;50%)</option>
                                <option value="achtung">ðŸŸ  Achtung (50-75%)</option>
                                <option value="gut">ðŸŸ¢ Gut (75-100%)</option>
                                <option value="top">ðŸŸ¡ Top (â‰¥100%)</option>
                            </select>
                        </div>
                    </div>
                    <div id="hqStandorteList" class="space-y-3"></div>
                </div>

                <!-- ===== HQ FINANZEN ===== -->
                <div id="hqFinanzenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">FINANZEN â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqFinKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz & Rohertrag pro Standort</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="hqFinTable"></table>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ BWA-Auffaelligkeiten</h2>
                            <div id="hqFinAlerts" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“ˆ Rohertrag-Ranking</h2>
                            <div id="hqFinRohertrag" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- ===== HQ MARKETING ===== -->
                <div id="hqMarketingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">MARKETING â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqMktKpis"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Lead-Performance pro Standort</h2>
                            <div id="hqMktLeads" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸŽ¯ Strategie-Status</h2>
                            <div id="hqMktStrategie" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Handlungsbedarf Marketing</h2>
                        <div id="hqMktAlerts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ EINKAUF ===== -->
                <div id="hqEinkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">EINKAUF â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqEkKpis"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“¦ Vororder-Status 2026</h2>
                            <div id="hqEkVororder" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Rohertrag pro Standort</h2>
                            <div id="hqEkRohertrag" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Handlungsbedarf Einkauf</h2>
                        <div id="hqEkAlerts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ VERKAUF ===== -->
                <div id="hqVerkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">VERKAUF â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqVkKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Verkaufsleistung pro Standort (KW 7)</h2>
                        <div class="overflow-x-auto"><table class="w-full text-sm" id="hqVkTable"></table></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Handlungsbedarf Verkauf</h2>
                        <div id="hqVkAlerts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ HANDLUNGSBEDARF ===== -->
                <div id="hqAktionenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">HANDLUNGSBEDARF â€“ ALLE BEREICHE</h1>
                    <p class="text-sm text-gray-500 mb-6">Konsolidierte Uebersicht aller offenen Punkte, die Aufmerksamkeit der Zentrale erfordern. Sortiert nach Prioritaet.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqAktKpis"></div>
                    <div id="hqAktionenList" class="space-y-3"></div>
                </div>

                <!-- HQ KOMMUNIKATION -->
                <!-- HQ KAMPAGNEN -->
                <!-- HQ DOKUMENTE -->
                <!-- HQ KALENDER -->
                <!-- HQ AUFGABEN -->
                <!-- KOMMANDOZENTRALE -->
                <div id="hqKommandoView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">âš™ï¸ KOMMANDOZENTRALE</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showKommandoTab('standorte')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-ktab="standorte">ðŸ¢ Standorte</button>
                            <button onclick="showKommandoTab('mitarbeiter')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="mitarbeiter">ðŸ‘¥ Mitarbeiter</button>
                            <button onclick="showKommandoTab('kommunikation')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kommunikation">ðŸ“¢ Kommunikation</button>
                            <button onclick="showKommandoTab('kampagnen')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kampagnen">ðŸŽ¯ Kampagnen</button>
                            <button onclick="showKommandoTab('dokumente')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="dokumente">ðŸ“ Dokumente</button>
                            <button onclick="showKommandoTab('kalender')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kalender">ðŸ“… Kalender</button>
                            <button onclick="showKommandoTab('aufgaben')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="aufgaben">ðŸ“‹ Aufgaben</button>
                        </nav>
                    </div>

                    <!-- STANDORTE TAB -->
                    <div id="kommandoTabStandorte" class="kommando-tab-content">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzStandorteGesamt">21</p><p class="text-xs text-gray-500">Standorte gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzStandorteAktiv">18</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzStandorteOnb">2</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzStandorteOff">1</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRegionen">4</p><p class="text-xs text-gray-500">Regionen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterKzStandorte('all')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzf="all">Alle</button>
                                <button onclick="filterKzStandorte('aktiv')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzStandorte('onboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzStandorte('offboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerStandortModal()">+ Neuer Standort</button>
                        </div>

                        <!-- Standorte Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Adresse</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Typ</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Mitarbeiter</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Beitritt</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Telefon</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzStandorteBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- MITARBEITER TAB -->
                    <div id="kommandoTabMitarbeiter" class="kommando-tab-content" style="display:none;">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzMaGesamt">67</p><p class="text-xs text-gray-500">Mitarbeiter gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzMaAktiv">61</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzMaOnb">4</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzMaOff">2</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRollen">5</p><p class="text-xs text-gray-500">Rollen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2 flex-wrap gap-y-2">
                                <button onclick="filterKzMa('all')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzmf="all">Alle</button>
                                <button onclick="filterKzMa('aktiv')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzMa('onboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzMa('offboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <div class="flex space-x-2">
                                <select id="kzMaStandortFilter" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs" onchange="filterKzMa(currentKzMaFilter)">
                                    <option value="all">Alle Standorte</option>
                                </select>
                                <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                            </div>
                        </div>

                        <!-- Mitarbeiter Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Rolle</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Eintritt</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Onboarding</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzMaBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- KOMMUNIKATION TAB -->
                    <div id="kommandoTabKommunikation" class="kommando-tab-content" style="display:none;">
                        <!-- Sub-tabs -->
                        <div class="border-b border-gray-100 mb-4">
                            <nav class="flex space-x-4">
                                <button onclick="showHqKommTab('announce')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-vit-orange font-semibold text-vit-orange" data-hkt="announce">ðŸ“¢ Ankuendigungen</button>
                                <button onclick="showHqKommTab('rundmail')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="rundmail">âœ‰ï¸ Rundmail</button>
                                <button onclick="showHqKommTab('forum')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="forum">ðŸ’¬ Netzwerk-Forum</button>
                            </nav>
                        </div>
                        <div id="hqKommContent"></div>
                    </div>

                    <!-- KAMPAGNEN TAB -->
                    <div id="kommandoTabKampagnen" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Kampagnen erstellen, steuern und Umsetzung ueber alle Standorte tracken.</p>
                            <button onclick="document.getElementById('hqKampModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Kampagne</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKampKpis"></div>
                        <div id="hqKampList" class="space-y-4"></div>
                        <!-- Modal -->
                        <div id="hqKampModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Neue Kampagne erstellen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKampName" placeholder="Kampagnen-Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="date" id="hqKampStart" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <input type="date" id="hqKampEnd" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    </div>
                                    <select id="hqKampType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="saisonal">Saisonkampagne</option><option value="produkt">Produktkampagne</option><option value="event">Event/Aktionstag</option><option value="social">Social Media Push</option>
                                    </select>
                                    <textarea id="hqKampDesc" rows="2" placeholder="Beschreibung / Ziel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKampagne()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Erstellen</button>
                                    <button onclick="document.getElementById('hqKampModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DOKUMENTE TAB -->
                    <div id="kommandoTabDokumente" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-weite Dokumente: Richtlinien, Vorlagen, Schulungen, Vertraege.</p>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openDokUploadModal()">+ Dokument hochladen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqDokKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqDok('all')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hdf="all">Alle</button>
                            <button onclick="filterHqDok('richtlinie')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="richtlinie">ðŸ“‹ Richtlinien</button>
                            <button onclick="filterHqDok('vorlage')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vorlage">ðŸ“„ Vorlagen</button>
                            <button onclick="filterHqDok('schulung')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqDok('vertrag')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vertrag">ðŸ“‘ Vertraege</button>
                        </div>
                        <div id="hqDokList" class="space-y-2"></div>
                    </div>

                    <!-- KALENDER TAB -->
                    <div id="kommandoTabKalender" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-Termine: Schulungen, Events, Deadlines und Meetings fuer alle Standorte.</p>
                            <button onclick="document.getElementById('hqKalModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Netzwerk-Termin</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqKalKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqKal('all')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hkf="all">Alle</button>
                            <button onclick="filterHqKal('schulung')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqKal('event')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="event">ðŸŽª Events</button>
                            <button onclick="filterHqKal('deadline')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="deadline">â° Deadlines</button>
                            <button onclick="filterHqKal('meeting')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="meeting">ðŸ¤ Meetings</button>
                        </div>
                        <div id="hqKalList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqKalModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Netzwerk-Termin anlegen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKalTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3"><input type="date" id="hqKalDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"><input type="time" id="hqKalTime" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <select id="hqKalType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="schulung">ðŸŽ“ Schulung</option><option value="event">ðŸŽª Event</option><option value="deadline">â° Deadline</option><option value="meeting">ðŸ¤ Meeting</option></select>
                                    <select id="hqKalTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte</option><option value="region_sued">Region Sued</option><option value="region_nord">Region Nord</option><option value="region_west">Region West</option><option value="region_ost">Region Ost</option></select>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                    <button onclick="document.getElementById('hqKalModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AUFGABEN TAB -->
                    <div id="kommandoTabAufgaben" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Aufgaben an Standorte verteilen und Umsetzung tracken.</p>
                            <button onclick="document.getElementById('hqTaskModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Aufgabe verteilen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4" id="hqTaskKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqTasks('all')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-htf="all">Alle</button>
                            <button onclick="filterHqTasks('offen')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="offen">ðŸ”´ Offen</button>
                            <button onclick="filterHqTasks('inprogress')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="inprogress">ðŸ”µ In Arbeit</button>
                            <button onclick="filterHqTasks('done')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="done">âœ… Erledigt</button>
                        </div>
                        <div id="hqTaskList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Aufgabe an Standort(e) verteilen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqTaskTitle" placeholder="Aufgabentitel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <input type="date" id="hqTaskDeadline" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <select id="hqTaskPrio" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="hoch">ðŸ”´ Hoch</option><option value="mittel" selected>ðŸŸ¡ Mittel</option><option value="niedrig">ðŸŸ¢ Niedrig</option></select>
                                    <select id="hqTaskTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte (21)</option><option value="region_sued">Region Sued (8)</option><option value="region_nord">Region Nord (5)</option><option value="region_west">Region West (5)</option><option value="region_ost">Region Ost (3)</option></select>
                                    <textarea id="hqTaskDesc" rows="2" placeholder="Beschreibung" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqTask()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Verteilen</button>
                                    <button onclick="document.getElementById('hqTaskModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- HQ AUSWERTUNG: Portal-Nutzung -->
                <div id="hqAuswertungView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“Š AUSWERTUNG â€“ PORTAL-NUTZUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Wie aktiv nutzen die Standorte das vit:bikes Partner-Portal?</p>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqAuswKpis"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Aktivste Standorte</h2>
                            <div id="hqAuswTop" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Geringste Nutzung</h2>
                            <div id="hqAuswBottom" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="vit-card p-5 mb-6">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“‹ Modul-Nutzung im Netzwerk</h2>
                        <div id="hqAuswModules" class="space-y-2"></div>
                    </div>
                    <div class="vit-card p-5">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“ˆ Alle Standorte â€“ Nutzungs-Score</h2>
                        <div id="hqAuswAll" class="space-y-1"></div>
                    </div>
                </div>

                <!-- ===== HQ WISSEN-VERWALTUNG ===== -->
                <div id="hqWissenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“š WISSEN â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Wissensinhalte fuer alle Partner bereitstellen und verwalten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange">24</div><div class="text-xs text-gray-500">Akademie-Kurse</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">18</div><div class="text-xs text-gray-500">Handbuecher</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">12</div><div class="text-xs text-gray-500">Best Practices</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-purple-600">45</div><div class="text-xs text-gray-500">FAQ-Eintraege</div></div>
                    </div>
                    <!-- Neuen Inhalt anlegen -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neuen Wissensinhalt erstellen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Titel</label>
                                <input type="text" id="hqWissenTitel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Leitfaden E-Bike Beratung">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                <select id="hqWissenKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="akademie">ðŸŽ“ Akademie-Kurs</option>
                                    <option value="handbuch">ðŸ“– Handbuch</option>
                                    <option value="bestpractice">â­ Best Practice</option>
                                    <option value="faq">â“ FAQ</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bereich</label>
                            <select id="hqWissenBereich" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="verkauf">Verkauf</option>
                                <option value="werkstatt">Werkstatt</option>
                                <option value="marketing">Marketing</option>
                                <option value="betrieb">Betrieb &amp; Organisation</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Inhalt / Beschreibung</label>
                            <textarea id="hqWissenInhalt" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Inhalt des Wissensartikels..."></textarea>
                        </div>
                        <button onclick="addHqWissen()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ“š Veroeffentlichen</button>
                    </div>
                    <!-- Bestehende Inhalte -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Bestehende Inhalte</h2>
                        <div id="hqWissenList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ SUPPORT-ÃœBERSICHT ===== -->
                <div id="hqSupportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸŽ« SUPPORT â€“ UEBERSICHT</h1>
                    <p class="text-sm text-gray-500 mb-6">Alle Support-Anfragen der Partner im Blick.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-500">7</div><div class="text-xs text-gray-500">Offene Tickets</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-500">3</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">48</div><div class="text-xs text-gray-500">Geloest (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">4.2h</div><div class="text-xs text-gray-500">âŒ€ Reaktionszeit</div></div>
                    </div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ”´ Offene Support-Tickets</h2>
                        <div id="hqSupportTickets" class="space-y-3"></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Tickets nach Standort</h2>
                        <div id="hqSupportStats" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ IDEENBOARD-ÃœBERSICHT ===== -->
                <div id="hqIdeenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ’¡ IDEENBOARD â€“ NETZWERK</h1>
                    <p class="text-sm text-gray-500 mb-6">Alle Ideen und Vorschlaege der Partner einsehen und bewerten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="hqIdeenTotal">0</div><div class="text-xs text-gray-500">Eingereichte Ideen</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-500" id="hqIdeenPruefung">0</div><div class="text-xs text-gray-500">In PrÃ¼fung</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="hqIdeenUmgesetzt">0</div><div class="text-xs text-gray-500">Umgesetzt</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-400" id="hqIdeenAbgelehnt">0</div><div class="text-xs text-gray-500">Abgelehnt</div></div>
                    </div>
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterHqIdeen('all')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-hif="all">Alle</button>
                        <button onclick="filterHqIdeen('neu')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="neu">Neu</button>
                        <button onclick="filterHqIdeen('wird_geprueft')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="wird_geprueft">Wird geprÃ¼ft</button>
                        <button onclick="filterHqIdeen('umgesetzt')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="umgesetzt">Umgesetzt</button>
                        <button onclick="filterHqIdeen('abgelehnt')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="abgelehnt">Abgelehnt</button>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Eingereichte Ideen aller Partner</h2>
                        <div id="hqIdeenList" class="space-y-3"></div>
                    </div>
                </div>

                <!-- ===== HQ SHOP-VERWALTUNG ===== -->
                <div id="hqShopView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ›ï¸ WERBEMITTEL-SHOP â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Sortiment, Preise und Bestellungen verwalten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange">20</div><div class="text-xs text-gray-500">Produkte aktiv</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">34</div><div class="text-xs text-gray-500">Bestellungen (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">â‚¬ 4.280</div><div class="text-xs text-gray-500">Umsatz (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-purple-600">â‚¬ 126</div><div class="text-xs text-gray-500">âŒ€ Bestellwert</div></div>
                    </div>
                    <!-- Neues Produkt -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neues Produkt anlegen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Produktname</label>
                                <input type="text" id="hqShopName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Regenjacke">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                <select id="hqShopKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="print">ðŸ–¨ï¸ Print</option>
                                    <option value="textil">ðŸ‘• Textilien</option>
                                    <option value="display">ðŸª§ Displays</option>
                                    <option value="digital">ðŸ’» Digital</option>
                                    <option value="give">ðŸŽ Giveaways</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Preis (â‚¬)</label>
                                <input type="number" id="hqShopPreis" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <input type="text" id="hqShopDesc" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Kurze Produktbeschreibung">
                        </div>
                        <button onclick="addHqShopProduct()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ›ï¸ Produkt anlegen</button>
                    </div>
                    <!-- Bestellungen -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“¦ Letzte Bestellungen</h2>
                        <div id="hqShopOrders" class="space-y-2"></div>
                    </div>
                    <!-- Produkte -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Alle Produkte</h2>
                        <div id="hqShopProducts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- HQ EINSTELLUNGEN VIEW -->
                <div id="hqEinstellungenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">âš™ï¸ EINSTELLUNGEN</h1>
                    <p class="text-sm text-gray-500 mb-6">Modul-Verwaltung und Rollen-Rechte fÃ¼r das gesamte Netzwerk.</p>

                    <!-- Tab-Navigation -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showSettingsTab('modulstatus')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="modulstatus">ðŸ”§ Modul-Status</button>
                        <button onclick="showSettingsTab('rechte')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="rechte">ðŸ” Rollen & Rechte</button>
                    </div>

                    <!-- TAB 1: Modul-Status -->
                    <div id="settingsTabModulstatus" class="settings-tab-content">
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="countAktiv">0</div><div class="text-xs text-gray-500">Aktive Module</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-yellow-500"><div class="text-2xl font-bold text-yellow-600" id="countWip">0</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-gray-400"><div class="text-2xl font-bold text-gray-400" id="countDeaktiviert">0</div><div class="text-xs text-gray-500">Deaktiviert</div></div>
                        </div>
                        <div class="vit-card overflow-hidden mb-6">
                            <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                <h2 class="font-bold text-gray-800">Modul-Verwaltung</h2>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span><span>Aktiv</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block"></span><span>In Bearbeitung</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 inline-block"></span><span>Deaktiviert</span></span>
                                </div>
                            </div>
                            <div id="modulStatusList" class="divide-y divide-gray-100"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-2">â„¹ï¸ So funktioniert es</h3>
                            <div class="space-y-1.5 text-xs text-gray-600">
                                <p><span class="font-bold text-green-600">Aktiv:</span> Das Modul ist fÃ¼r alle Nutzer sichtbar und nutzbar (sofern ihre Rolle es erlaubt).</p>
                                <p><span class="font-bold text-yellow-600">In Bearbeitung:</span> Das Modul erscheint ausgegraut in der Sidebar mit einem â€žBALD"-Badge. Nutzer kÃ¶nnen es nicht Ã¶ffnen.</p>
                                <p><span class="font-bold text-gray-500">Deaktiviert:</span> Das Modul ist komplett unsichtbar â€“ kein MenÃ¼punkt, kein Zugang.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: Rollen & Rechte (bestehend) -->
                    <div id="settingsTabRechte" class="settings-tab-content" style="display:none;">

                    <!-- Rollen-Ãœbersicht -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center border-l-4 border-orange-500"><div class="text-2xl font-bold text-vit-orange">4</div><div class="text-xs text-gray-500">Standort-Rollen</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-blue-500"><div class="text-2xl font-bold text-blue-600">12</div><div class="text-xs text-gray-500">Standort-Module</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="settingsMaCount">26</div><div class="text-xs text-gray-500">Mitarbeiter gesamt</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-purple-500"><div class="text-2xl font-bold text-purple-600">âœ“</div><div class="text-xs text-gray-500">Multi-Rollen aktiv</div></div>
                    </div>

                    <!-- Rechte-Matrix -->
                    <div class="vit-card overflow-hidden mb-6">
                        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                            <h2 class="font-bold text-gray-800">Rechte-Matrix: Module Ã— Rollen</h2>
                            <span class="text-xs text-gray-400">Klicken zum Aktivieren/Deaktivieren</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="rechteMatrixTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600 min-w-[180px]">Modul</th>
                                        <th class="px-4 py-3 text-center font-semibold text-orange-600 min-w-[100px]">GeschÃ¤ftsleitung</th>
                                        <th class="px-4 py-3 text-center font-semibold text-blue-600 min-w-[100px]">Verkauf</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600 min-w-[100px]">Werkstatt</th>
                                        <th class="px-4 py-3 text-center font-semibold text-purple-600 min-w-[100px]">Buchhaltung</th>
                                    </tr>
                                </thead>
                                <tbody id="rechteMatrixBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rollen-Beschreibungen -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸ“‹ Rollen-Beschreibungen</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-vit-orange text-white mt-0.5">GeschÃ¤ftsleitung</span><p class="text-xs text-gray-600">Vollzugriff auf alle Standort-Module inkl. Dashboards, Shop, Onboarding und Controlling.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700 mt-0.5">Verkauf</span><p class="text-xs text-gray-600">Zugang zu Verkauf, Marketing und allgemeinen Tools. Fokus auf Kundenberatung und Vertrieb.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-gray-200 text-gray-700 mt-0.5">Werkstatt</span><p class="text-xs text-gray-600">Zugang zu Einkauf und allgemeinen Tools. Fokus auf Werkstatt, Teile und Service.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-purple-100 text-purple-700 mt-0.5">Buchhaltung</span><p class="text-xs text-gray-600">Zugang zu Allgemein, Verkauf, Einkauf, Controlling und Aktenschrank. Finanz- und Dokumentenfokus.</p></div>
                            </div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">â„¹ï¸ Hinweise</h3>
                            <div class="space-y-2 text-xs text-gray-600">
                                <p>â€¢ <strong>Kalender, Aufgaben & Kommunikation</strong> sind fÃ¼r alle Rollen verfÃ¼gbar (nicht deaktivierbar).</p>
                                <p>â€¢ <strong>Mehrfach-Rollen:</strong> Ein Mitarbeiter kann mehrere Rollen gleichzeitig haben â€“ die Rechte werden addiert.</p>
                                <p>â€¢ <strong>Rollenzuweisung:</strong> Rollen pro Mitarbeiter vergeben Sie unter Kommandozentrale â†’ Mitarbeiter.</p>
                                <p>â€¢ Ã„nderungen an der Rechte-Matrix werden sofort fÃ¼r alle betroffenen Nutzer wirksam.</p>
                            </div>
                        </div>
                    </div>
                    </div><!-- /settingsTabRechte -->
                </div>

                <!-- HQ Modul-Ãœbersicht View -->
                <div id="hqModulStatusView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">MODUL-ÃœBERSICHT</h1>
                            <p class="text-gray-500 text-sm">Entwicklungsstand aller Portal-Module Â· Stand: 15. Februar 2026</p>
                        </div>
                        <div class="flex items-center space-x-2" id="modulStatusSummary"></div>
                    </div>
                    <!-- Filter -->
                    <div class="flex items-center space-x-2 mb-6">
                        <button onclick="filterModulStatus('alle')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="alle">Alle</button>
                        <button onclick="filterModulStatus('standort')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="standort">Standort-Module</button>
                        <button onclick="filterModulStatus('hq')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hq">HQ-Module</button>
                        <button onclick="filterModulStatus('widgets')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="widgets">Dashboard-Widgets</button>
                        <span class="border-l border-gray-300 h-5 mx-1"></span>
                        <button onclick="filterModulStatus('kiPrio')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="kiPrio">ðŸ¤– PrioritÃ¤t KI</button>
                        <button onclick="filterModulStatus('hqPrio')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hqPrio">ðŸ¢ Prio HQ</button>
                    </div>
                    <div id="modulStatusContent"></div>
                </div>

    </div>

    <script>
        // ============================================
        // SUPABASE CLIENT
        // ============================================
        var SUPABASE_URL = 'https://lwwagbkxeofahhwebkab.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3d2FnYmt4ZW9mYWhod2Via2FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTM3NDAsImV4cCI6MjA4NjU4OTc0MH0.YBKO7grysp8RHzGWA6xSGpTVi0wG2PmeEWJHI25f7ks';
        var sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        var sbUser = null; // Supabase auth user
        var sbProfile = null; // users table row
        var sbRollen = []; // role names array
        var sbStandort = null; // standorte row
        var sbModulStatus = {}; // {modul_key: 'aktiv'|'in_bearbeitung'|'deaktiviert'}

        // Modul-Status aus Supabase laden und auf Sidebar anwenden
        async function loadModulStatus() {
            try {
                var resp = await sb.from('modul_status').select('modul_key, status').order('reihenfolge');
                if(resp.error) throw resp.error;
                sbModulStatus = {};
                (resp.data||[]).forEach(function(m) { sbModulStatus[m.modul_key] = m.status; });
                applyModulStatus();
            } catch(err) { console.error('ModulStatus:', err); }
        }

        function applyModulStatus() {
            // Alle Sidebar-Buttons mit data-module durchgehen
            document.querySelectorAll('[data-module]').forEach(function(btn) {
                var key = btn.getAttribute('data-module');
                var status = sbModulStatus[key] || 'aktiv';

                if(status === 'deaktiviert') {
                    btn.style.display = 'none';
                } else if(status === 'in_bearbeitung') {
                    btn.style.display = '';
                    btn.style.opacity = '0.4';
                    btn.style.pointerEvents = 'none';
                    btn.style.cursor = 'not-allowed';
                    if(!btn.querySelector('.modul-wip-badge')) {
                        var badge = document.createElement('span');
                        badge.className = 'modul-wip-badge ml-auto text-[9px] bg-yellow-500 text-white rounded px-1 py-0.5 font-bold';
                        badge.textContent = 'BALD';
                        btn.appendChild(badge);
                    }
                } else {
                    btn.style.display = '';
                    btn.style.opacity = '';
                    btn.style.pointerEvents = '';
                    btn.style.cursor = '';
                    var oldBadge = btn.querySelector('.modul-wip-badge');
                    if(oldBadge) oldBadge.remove();
                }
            });

            // Wissen-Tabs in Fachbereichen ausblenden wenn Modul deaktiviert
            var wissenStatus = sbModulStatus['wissen'] || 'aktiv';
            var wissenDisabled = wissenStatus === 'deaktiviert';
            var wissenTabSelectors = [
                'button[data-tab="vkWissen"]', '#vkTabVkWissen',
                'button[data-tab="mktWissen"]', '#marketingTabMktWissen',
                'button[data-tab="ekWissen"]', '#ekTabEkWissen',
                'button[data-tab="ctrlWissen"]', '#ctrlTabCtrlWissen',
                'button[data-tab="wissen"]', '#allgTabWissen'
            ];
            wissenTabSelectors.forEach(function(sel) {
                var el = document.querySelector(sel);
                if(el) el.style.display = wissenDisabled ? 'none' : '';
            });

            // Apply beta badges to non-final modules
            try { applyBetaBadges(); } catch(e) { console.warn('Beta badges:', e); }
        }

        // === BETA BADGES ===
        // Mapping: sidebar showView name â†’ module status (not live = beta)
        var BETA_MODULES = {
            // Standort modules
            'verkauf': 'teilweise',
            'dashboards': 'demo',
            'allgemein': 'demo',
            'einkauf': 'demo',
            'marketing': 'demo',
            'wissen': 'teilweise',
            'shop': 'teilweise',
            'onboarding': 'demo',
            'notifications': 'stub',
            // HQ modules
            'hqCockpit': 'teilweise',
            'hqKommando': 'teilweise',
            'hqAktionen': 'stub',
            'hqMarketing': 'demo',
            'hqEinkauf': 'demo',
            'hqVerkauf': 'demo',
            'hqAuswertung': 'stub',
            'hqWissen': 'teilweise',
            'hqShop': 'demo'
        };
        // Tabs that are beta (within otherwise-live modules)
        var BETA_TABS = {
            'benchmark': true,    // Controlling: Benchmarks
            'planist': true,      // Controlling: Plan/Ist
            'liquiditaet': true,  // Controlling: LiquiditÃ¤t
            'vkWissen': true,     // Verkauf: Wissen
            'ekWissen': true,     // Einkauf: Wissen  
            'ctrlWissen': true,   // Controlling: Wissen
            'mktWissen': true,    // Marketing: Wissen
            'kontakte': true,     // Support: Kontakte
            'leadreporting': true // Dashboards: Reporting
        };

        function applyBetaBadges() {
            // Remove old badges first
            document.querySelectorAll('.auto-beta-badge').forEach(function(b){ b.remove(); });

            // Sidebar buttons
            document.querySelectorAll('.sidebar-item').forEach(function(btn) {
                var onclick = btn.getAttribute('onclick') || '';
                var m = onclick.match(/showView\('([^']+)'\)/);
                if(!m) return;
                var viewName = m[1];
                if(!BETA_MODULES[viewName]) return;
                // Don't duplicate
                if(btn.querySelector('.auto-beta-badge')) return;
                var span = btn.querySelector('span[data-i18n], span:not(.auto-beta-badge):not(.modul-wip-badge)');
                if(!span) return;
                var badge = document.createElement('span');
                badge.className = 'auto-beta-badge beta-badge';
                badge.textContent = 'BETA';
                span.parentNode.insertBefore(badge, span.nextSibling);
            });

            // Tab buttons
            document.querySelectorAll('[data-tab]').forEach(function(btn) {
                var tab = btn.getAttribute('data-tab');
                if(!BETA_TABS[tab]) return;
                if(btn.querySelector('.auto-beta-badge')) return;
                var badge = document.createElement('span');
                badge.className = 'auto-beta-badge beta-badge-tab';
                badge.textContent = 'BETA';
                btn.appendChild(badge);
            });

            // View headlines â€“ add beta tag next to H1 inside beta views
            Object.keys(BETA_MODULES).forEach(function(viewName) {
                var viewEl = document.getElementById(viewName + 'View');
                if(!viewEl) return;
                var h1 = viewEl.querySelector('h1');
                if(!h1 || h1.querySelector('.auto-beta-badge')) return;
                var badge = document.createElement('span');
                badge.className = 'auto-beta-badge beta-badge';
                badge.style.fontSize = '10px';
                badge.style.marginLeft = '8px';
                badge.style.verticalAlign = 'middle';
                badge.textContent = 'BETA';
                h1.appendChild(badge);
            });
        }

        // Current user state
        var currentRole = 'inhaber';
        var currentLocation = 'vitbikes-muenchen';
        var isPremium = true;

        // Location data
        var locations = {
            'vitbikes-muenchen': { name: 'vit:bikes MÃ¼nchen Sendling', premium: true },
            'vitbikes-berlin': { name: 'vit:bikes Berlin Mitte', premium: true },
            'vitbikes-hamburg': { name: 'vit:bikes Hamburg Altona', premium: true },
            'radhaus-koeln': { name: 'Radhaus KÃ¶ln', premium: false },
            'bikeshop-dresden': { name: 'BikeShop Dresden', premium: false }
        };

        // Update location info in login screen
        function updateLocationInfo() {
            const select = document.getElementById('locationSelect');
            const selectedOption = select.options[select.selectedIndex];
            const isPremiumLocation = selectedOption.dataset.premium === 'true';
            const badge = document.getElementById('locationBadge');
            
            if (isPremiumLocation) {
                badge.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-vit-orange to-yellow-500 text-white"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg> vit:bikes Partner - Alle Features</span>';
            } else {
                badge.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">ðŸ“¦ Basis-Version - Upgrade verfÃ¼gbar</span>';
            }
        }

        // Initialize location info on page load (only if login screen exists)
        if(document.getElementById('locationSelect')) { updateLocationInfo(); }
        
        // Auto-init: show home view and set defaults
        try { updateUIForRole(); updatePremiumFeatures(); } catch(e) { console.warn('Init:', e); }

        // Handle Login - Role & Location from email
        // === RECHTEMANAGEMENT ===
        // Rollen: inhaber, verkauf, werkstatt, buchhaltung (Standort-Ebene) + hq (HQ-Ebene)
        // Jeder Mitarbeiter kann MEHRERE Rollen haben
        var userAccounts = {
            'max@vitbikes-grafrath.de': {roles:['inhaber'],location:'grafrath',name:'Max Mustermann'},
            'sandra@vitbikes-grafrath.de': {roles:['inhaber','buchhaltung'],location:'grafrath',name:'Sandra Engelmann'},
            'verkauf@vitbikes-grafrath.de': {roles:['verkauf'],location:'grafrath',name:'Tom Berater'},
            'werkstatt@vitbikes-grafrath.de': {roles:['werkstatt'],location:'grafrath',name:'Felix Schrauber'},
            'anna@vitbikes-grafrath.de': {roles:['verkauf','werkstatt'],location:'grafrath',name:'Anna Allround'},
            'buchhaltung@vitbikes-grafrath.de': {roles:['buchhaltung'],location:'grafrath',name:'Petra Zahlen'},
            'hq@vitbikes.de': {roles:['hq'],location:'hq',name:'Lisa Zentrale'},
            'admin@vitbikes.de': {roles:['hq'],location:'hq',name:'Michael Stenzel'}
        };

        // Welche Rollen Zugriff auf welche Module haben
        var rolePermissions = {
            // View-Name: [erlaubte Rollen] â€” 'alle' = jede Standort-Rolle
            'home':           ['alle'],
            'kalender':       ['alle'],
            'todo':           ['alle'],
            'kommunikation':  ['alle'],
            'dashboards':     ['inhaber'],
            'allgemein':      ['inhaber','buchhaltung'],
            'verkauf':        ['inhaber','verkauf','buchhaltung'],
            'einkauf':        ['inhaber','werkstatt','buchhaltung'],
            'marketing':      ['inhaber','verkauf'],
            'controlling':    ['inhaber','buchhaltung'],
            'wissen':         ['alle'],
            'support':        ['alle'],
            'aktenschrank':   ['inhaber','buchhaltung'],
            'ideenboard':     ['alle'],
            'shop':           ['inhaber'],
            'onboarding':     ['inhaber'],
            'mitarbeiter':    ['inhaber']
        };

        // PrÃ¼ft ob der aktuelle User Zugriff auf eine View hat
        function hasAccess(viewName) {
            if(currentRole === 'hq') return viewName.indexOf('hq')===0 || viewName==='kalender' || viewName==='todo' || viewName==='kommunikation';
            var perms = rolePermissions[viewName];
            if(!perms) return true;
            if(perms.indexOf('alle') >= 0) return true;
            for(var i=0; i<currentRoles.length; i++) {
                if(perms.indexOf(currentRoles[i]) >= 0) return true;
            }
            return false;
        }

        // PrÃ¼ft ob User eine bestimmte Rolle hat
        function hasRole(role) {
            return currentRoles.indexOf(role) >= 0;
        }

        // Aktuelle Rollen (Array)
        var currentRoles = ['inhaber'];

        function quickLogin(email) {
            document.getElementById('loginEmail').value = email;
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginPassword').focus();
        }

        // === PASSWORD RESET ===
        function showPasswordReset() {
            var html = '<div id="pwResetOverlay" onclick="closePwReset()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:28px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Passwort zuruecksetzen</h3><button onclick="closePwReset()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-500 mb-4">Gib deine E-Mail-Adresse ein. Du erhaeltst einen Link zum Zuruecksetzen deines Passworts.</p>';
            html += '<input id="pwResetEmail" type="email" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="deine@email.de">';
            html += '<div id="pwResetMsg" style="display:none" class="text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="pwResetBtn" onclick="submitPwReset()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Link senden</button>';
            html += '<button onclick="closePwReset()" class="w-full py-2.5 mt-2 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Zurueck zum Login</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'pwResetContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closePwReset() { var c = document.getElementById('pwResetContainer'); if(c) c.remove(); }
        async function submitPwReset() {
            var email = (document.getElementById('pwResetEmail') || {}).value;
            var msg = document.getElementById('pwResetMsg');
            var btn = document.getElementById('pwResetBtn');
            if (!email || !email.includes('@')) { msg.className = 'text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent = 'Bitte gib eine gueltige E-Mail ein.'; msg.style.display = 'block'; return; }
            btn.disabled = true; btn.textContent = 'Wird gesendet...';
            try {
                var resp = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + window.location.pathname });
                if (resp.error) throw resp.error;
                msg.className = 'text-sm rounded-lg p-3 mb-3 bg-green-50 border border-green-200 text-green-700';
                msg.textContent = 'Falls ein Account mit dieser E-Mail existiert, wurde ein Reset-Link gesendet. Pruefe deinen Posteingang.';
                msg.style.display = 'block';
                btn.textContent = 'Gesendet \u2713'; btn.disabled = true;
            } catch (e) {
                msg.className = 'text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600';
                msg.textContent = 'Fehler: ' + e.message;
                msg.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Link senden';
            }
        }

        // === REGISTRATION ===
        function showRegistration() {
            var loginForm = document.querySelector('#loginScreen form');
            var regLink = loginForm.parentElement.querySelector('.border-t');
            
            var html = '<div id="regOverlay" onclick="hideRegistration()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:28px;width:440px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Registrieren</h3><button onclick="hideRegistration()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-500 mb-4">Nach der Registrierung muss dein Account vom HQ freigeschaltet werden.</p>';
            html += '<div class="space-y-3 mb-5">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Vor- und Nachname *</label><input id="regName" type="text" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Max Mustermann"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail *</label><input id="regEmail" type="email" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@vitbikes-standort.de"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Passwort * (min. 6 Zeichen)</label><input id="regPassword" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="regStandort" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"><option value="">Wird geladen...</option></select></div>';
            html += '</div>';
            html += '<div id="regError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<div id="regSuccess" style="display:none" class="bg-green-50 border border-green-200 text-green-700 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="regSubmitBtn" onclick="submitRegistration()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">Registrieren</button>';
            html += '<button onclick="hideRegistration()" class="w-full py-2.5 mt-2 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">ZurÃ¼ck zum Login</button>';
            html += '</div></div>';
            
            var c = document.createElement('div');
            c.id = 'regContainer';
            c.innerHTML = html;
            document.body.appendChild(c);
            
            // Load standorte into dropdown
            setTimeout(async function(){
                try {
                    var stdResp = await sb.from('standorte').select('id,name').order('name');
                    var sel = document.getElementById('regStandort');
                    if(sel && stdResp.data) {
                        sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                        stdResp.data.forEach(function(s){ sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>'; });
                    }
                } catch(e){ console.error(e); }
            }, 100);
        }

        function hideRegistration() {
            var c = document.getElementById('regContainer');
            if(c) c.remove();
        }

        async function submitRegistration() {
            var name = (document.getElementById('regName')||{}).value||'';
            var email = (document.getElementById('regEmail')||{}).value||'';
            var pw = (document.getElementById('regPassword')||{}).value||'';
            var standortId = (document.getElementById('regStandort')||{}).value||'';
            var errEl = document.getElementById('regError');
            var sucEl = document.getElementById('regSuccess');
            var btn = document.getElementById('regSubmitBtn');
            
            if(errEl) errEl.style.display = 'none';
            if(sucEl) sucEl.style.display = 'none';
            
            if(!name.trim() || !email.trim() || !pw) {
                if(errEl) { errEl.textContent = 'Bitte alle Pflichtfelder ausfÃ¼llen.'; errEl.style.display = 'block'; }
                return;
            }
            if(pw.length < 8) {
                if(errEl) { errEl.textContent = 'Passwort muss mindestens 8 Zeichen haben.'; errEl.style.display = 'block'; }
                return;
            }
            
            if(btn) { btn.disabled = true; btn.textContent = 'Wird registriert...'; }
            
            // Vorname/Nachname aus dem Namen splitten
            var nameParts = name.trim().split(' ');
            var vorname = nameParts[0] || '';
            var nachname = nameParts.slice(1).join(' ') || '';
            
            try {
                // Auth-User erstellen via Standard signUp()
                // Der DB-Trigger handle_new_auth_user() erstellt automatisch:
                // - public.users Eintrag mit status='pending'
                // - HQ-Todo Notification
                // - Email-Queue Eintrag
                var authResp = await sb.auth.signUp({ 
                    email: email.trim().toLowerCase(), 
                    password: pw,
                    options: { 
                        data: { 
                            vorname: vorname,
                            nachname: nachname
                        } 
                    }
                });
                if(authResp.error) throw authResp.error;
                var newUserId = authResp.data.user ? authResp.data.user.id : null;
                
                // Optionalen Standort-Hinweis nachtrÃ¤glich setzen (hilft HQ bei Zuordnung)
                if(standortId && newUserId) {
                    // Kurz warten damit der Trigger den User in public.users erstellt hat
                    await new Promise(function(resolve){ setTimeout(resolve, 1500); });
                    try {
                        await sb.from('users').update({ standort_id: standortId }).eq('id', newUserId);
                    } catch(e) { console.warn('Standort-Hinweis konnte nicht gesetzt werden:', e); }
                }
                
                // Sofort ausloggen (signUp loggt automatisch ein)
                await sb.auth.signOut();
                
                if(sucEl) {
                    sucEl.innerHTML = '\u2705 <strong>Registrierung erfolgreich!</strong><br>Dein Account wartet auf Freigabe durch das HQ. Du wirst benachrichtigt, sobald dein Zugang freigeschaltet wurde.';
                    sucEl.style.display = 'block';
                }
                if(btn) { btn.style.display = 'none'; }
            } catch(err) {
                // Auch ausloggen falls teilweise erfolgreich
                try { await sb.auth.signOut(); } catch(e){}
                var msg = 'Fehler: ' + (err.message||err);
                if(err.message && err.message.includes('already registered')) {
                    msg = 'Diese E-Mail-Adresse ist bereits registriert. Bitte anmelden.';
                }
                if(errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
                if(btn) { btn.disabled = false; btn.textContent = 'Registrieren'; }
            }
        }

        async function handleLogin(event) {
            if(event) { event.preventDefault(); event.stopPropagation(); }
            var email = (document.getElementById('loginEmail')||{}).value||'';
            var pw = (document.getElementById('loginPassword')||{}).value||'';
            if(!email || !pw) { alert('Bitte E-Mail und Passwort eingeben.'); return false; }

            var loginBtn = document.querySelector('#loginScreen form button[type="submit"]');
            if(loginBtn) { loginBtn.disabled = true; loginBtn.textContent = 'Anmelden...'; }
            var errEl = document.getElementById('loginError');
            if(errEl) errEl.style.display = 'none';

            try {
                console.log('[Login] Signing in...');
                var resp = await sb.auth.signInWithPassword({ email: email, password: pw });
                if(resp.error) throw resp.error;
                sbUser = resp.data.user;
                console.log('[Login] Auth OK, user:', sbUser.id);
                
                // Status-Check: Was darf der User sehen?
                var profileResp = await sb.from('users').select('status').eq('id', sbUser.id).single();
                console.log('[Login] Profile status:', profileResp.data ? profileResp.data.status : 'no profile', profileResp.error ? profileResp.error.message : '');
                
                if(profileResp.data && (profileResp.data.status === 'pending' || profileResp.data.status === 'onboarding')) {
                    // Pending-Screen zeigen statt Fehlermeldung
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('pendingScreen').style.display = 'flex';
                    var pendingEmailEl = document.getElementById('pendingEmail');
                    if(pendingEmailEl) pendingEmailEl.textContent = email;
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                if(profileResp.data && (profileResp.data.status === 'offboarding' || profileResp.data.status === 'gesperrt')) {
                    // Gesperrt-Screen zeigen
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('blockedScreen').style.display = 'flex';
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                
                if(!profileResp.data) {
                    // Kein Profil gefunden â€“ wahrscheinlich Trigger-Problem, Pending zeigen
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('pendingScreen').style.display = 'flex';
                    var pendingEmailEl2 = document.getElementById('pendingEmail');
                    if(pendingEmailEl2) pendingEmailEl2.textContent = email;
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                
                console.log('[Login] Loading profile...');
                await loadUserProfile(sbUser.id);
                console.log('[Login] Profile loaded, roles:', currentRoles);
                await loadModulStatus();
                console.log('[Login] Entering app...');
                enterApp();
                try { await loadPipelineFromSupabase(); } catch(e) { console.warn('[Login] Pipeline load optional:', e); }
            } catch(err) {
                console.error('[Login] ERROR:', err);
                if(errEl) { errEl.textContent = err.message || 'Login fehlgeschlagen'; errEl.style.display = 'block'; }
                else alert('Login fehlgeschlagen: ' + (err.message||err));
            } finally {
                if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
            }
            return false;
        }

        async function loadUserProfile(userId) {
            var resp1 = await sb.from('users').select('*, standorte(*)').eq('id', userId).single();
            if(resp1.error) { console.error('[Profile] Error:', resp1.error.message); throw resp1.error; }
            sbProfile = resp1.data;
            sbStandort = sbProfile ? sbProfile.standorte : null;
            var resp2 = await sb.from('user_rollen').select('rollen(name, label)').eq('user_id', userId);
            if(resp2.error) { console.error('[Roles] Error:', resp2.error.message); }
            sbRollen = (resp2.data || []).map(function(ur) { return ur.rollen; });
            var roleNames = sbRollen.map(function(r) { return r ? r.name : ''; }).filter(Boolean);
            currentRoles = roleNames.length > 0 ? roleNames : ['inhaber'];
            // is_hq from DB is the PRIMARY driver for HQ vs Standort view
            if(sbProfile && sbProfile.is_hq) {
                currentRole = 'hq';
            } else {
                currentRole = currentRoles.indexOf('inhaber') >= 0 ? 'inhaber' : currentRoles[0];
            }
            currentLocation = sbStandort ? sbStandort.slug : 'grafrath';
            isPremium = sbStandort ? sbStandort.is_premium : false;
        }

        function enterApp() {
            var userName = sbProfile ? sbProfile.name : 'Benutzer';
            var firstName = userName.split(' ')[0];
            var nameEl = document.querySelector('[data-user-name]');
            if(nameEl) nameEl.textContent = userName;
            var avatarEl = document.querySelector('.topnav-desktop img.rounded-full');
            if(avatarEl) avatarEl.src = 'https://ui-avatars.com/api/?name='+encodeURIComponent(userName)+'&background=EF7D00&color=fff';
            // Dynamic welcome text
            var welcomeEl = document.getElementById('welcomeText');
            if(welcomeEl) {
                var tpl = welcomeEl.textContent || 'Willkommen zurÃ¼ck, {name}!';
                welcomeEl.textContent = tpl.replace('{name}', firstName).replace('Max', firstName);
            }
            // Dynamic date
            var dateEl = document.getElementById('welcomeDate');
            var now = new Date();
            var days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
            var months = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var dateStr = 'Heute ist ' + days[now.getDay()] + ', ' + now.getDate() + '. ' + months[now.getMonth()] + ' ' + now.getFullYear();
            if(dateEl) dateEl.textContent = dateStr;
            var hqDateEl = document.getElementById('hqWelcomeDate');
            if(hqDateEl) hqDateEl.textContent = 'Willkommen zurueck Â· ' + dateStr;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            try { updateUIForRole(); updatePremiumFeatures(); } catch(e) { console.warn(e); }
            // Demo mode check BEFORE rendering views (so demo data is available)
            checkDemoMode();
            if(currentRole === 'hq') { switchViewMode('hq'); } else { showView('home'); loadDashboardWidgets(); }
            // Check for pending approvals (HQ + GF only)
            checkPendingApprovals();
            // Check BWA deadlines and create reminders
            checkBwaDeadlines();
        }

        // === LIVE DASHBOARD WIDGETS ===
        async function loadDashboardWidgets() {
            if(!sb || !sbUser) return;
            var stdId = sbProfile ? sbProfile.standort_id : null;
            
            // KW Label
            var kwEl = document.getElementById('dashKwLabel');
            if(kwEl) {
                var now2 = new Date(); var oneJan = new Date(now2.getFullYear(),0,1);
                var kw = Math.ceil(((now2 - oneJan) / 86400000 + oneJan.getDay() + 1) / 7);
                kwEl.textContent = 'KW ' + kw;
            }
            
            // 1. Offene Todos
            try {
                var tQ = sb.from('todos').select('id,titel,erledigt').eq('erledigt', false);
                if(stdId) tQ = tQ.eq('standort_id', stdId);
                var tR = await tQ.limit(5);
                if(tR.data && tR.data.length >= 0) {
                    var w = document.querySelector('[data-widget="aufgaben"] .space-y-2');
                    if(w) {
                        if(tR.data.length === 0) {
                            w.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">âœ… Keine offenen Aufgaben</p>';
                        } else {
                            w.innerHTML = tR.data.map(function(t){
                                return '<div class="flex items-center space-x-2">'
                                    +'<input type="checkbox" class="rounded border-gray-300" onchange="toggleTodo(\''+t.id+'\')">'
                                    +'<span class="text-sm text-gray-700">'+t.titel+'</span></div>';
                            }).join('');
                        }
                        // Update link
                        var btn = document.querySelector('[data-widget="aufgaben"] button[onclick]');
                        if(btn) btn.onclick = function(){ showView('todos'); };
                    }
                }
            } catch(e) { console.warn('Dashboard todos:', e); }

            // 2. Heutige Termine
            try {
                var today = new Date().toISOString().split('T')[0];
                var kQ = sb.from('kalender_termine').select('id,titel,startzeit,beschreibung').gte('startzeit', today+'T00:00:00').lte('startzeit', today+'T23:59:59');
                if(stdId) kQ = kQ.eq('standort_id', stdId);
                var kR = await kQ.order('startzeit').limit(4);
                if(kR.data) {
                    var w = document.querySelector('[data-widget="termine"] .space-y-3');
                    if(w) {
                        if(kR.data.length === 0) {
                            w.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Keine Termine heute</p>';
                        } else {
                            var colors = ['bg-blue-50','bg-purple-50','bg-green-50','bg-orange-50'];
                            w.innerHTML = kR.data.map(function(t,i){
                                var zeit = t.startzeit ? new Date(t.startzeit).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : '';
                                return '<div class="p-3 '+colors[i%4]+' rounded-lg">'
                                    +'<p class="text-sm font-semibold text-gray-800">'+zeit+' - '+t.titel+'</p>'
                                    +(t.beschreibung ? '<p class="text-xs text-gray-600">'+t.beschreibung+'</p>' : '')
                                    +'</div>';
                            }).join('');
                        }
                    }
                }
            } catch(e) { console.warn('Dashboard termine:', e); }

            // 3. Support Tickets
            try {
                var sQ = sb.from('tickets').select('id,titel,status,created_at').in('status',['offen','in_bearbeitung']);
                if(stdId) sQ = sQ.eq('standort_id', stdId);
                var sR = await sQ.order('created_at',{ascending:false}).limit(3);
                if(sR.data) {
                    var w = document.querySelector('[data-widget="support"] .text-center');
                    if(w) {
                        var count = sR.data.length;
                        var h = '<p class="text-4xl font-bold '+(count>0?'text-yellow-600':'text-green-600')+'">'+count+'</p>';
                        h += '<p class="text-sm text-gray-600 mt-1">Offene Tickets</p>';
                        if(count > 0) {
                            h += '<div class="mt-3 space-y-2">';
                            sR.data.forEach(function(t){
                                var ago = Math.floor((Date.now()-new Date(t.created_at).getTime())/86400000);
                                h += '<div class="text-xs text-left p-2 bg-yellow-50 rounded">'
                                    +'<p class="font-semibold">'+t.titel+'</p>'
                                    +'<p class="text-gray-600">Offen seit '+(ago<1?'heute':ago+' Tag'+(ago>1?'en':''))+'</p></div>';
                            });
                            h += '</div>';
                        }
                        w.innerHTML = h;
                    }
                }
            } catch(e) { console.warn('Dashboard tickets:', e); }

            // 4. BWA/Controlling Status
            try {
                var bQ = sb.from('bwa_daten').select('monat,jahr,umsatzerloese,rohertrag,ergebnis_vor_steuern').eq('jahr', new Date().getFullYear());
                if(stdId) bQ = bQ.eq('standort_id', stdId);
                var bR = await bQ.order('monat',{ascending:false}).limit(1);
                if(bR.data && bR.data.length > 0) {
                    var last = bR.data[0];
                    var w = document.querySelector('[data-widget="controlling"] .space-y-3');
                    if(w) {
                        var u = parseFloat(last.umsatzerloese)||0;
                        var r = parseFloat(last.rohertrag)||0;
                        var e2 = parseFloat(last.ergebnis_vor_steuern)||0;
                        var rm = u > 0 ? Math.round(r/u*100) : 0;
                        var em = u > 0 ? Math.round(e2/u*100) : 0;
                        w.innerHTML = '<p class="text-xs text-gray-400 mb-2">Letzte BWA: '+monatNamen[last.monat]+' '+last.jahr+'</p>'
                            +'<div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600">Umsatz</span><span class="text-sm font-semibold">'+eur(u)+' â‚¬</span></div></div>'
                            +'<div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600">Rohertrag-Marge</span><span class="text-sm font-semibold">'+rm+'%</span></div>'
                            +'<div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width:'+Math.min(rm,100)+'%"></div></div></div>'
                            +'<div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600">Ergebnis-Marge</span><span class="text-sm font-semibold '+(em>=0?'text-green-600':'text-red-600')+'">'+em+'%</span></div>'
                            +'<div class="w-full bg-gray-200 rounded-full h-2"><div class="'+(em>=0?'bg-green-500':'bg-red-500')+' h-2 rounded-full" style="width:'+Math.min(Math.abs(em),100)+'%"></div></div></div>';
                    }
                }
            } catch(e) { console.warn('Dashboard controlling:', e); }

            // 5. Nachrichten/AnkÃ¼ndigungen
            try {
                var aR = await sb.from('ankuendigungen').select('id,titel,created_at').order('created_at',{ascending:false}).limit(3);
                if(aR.data && aR.data.length > 0) {
                    var w = document.querySelector('[data-widget="nachrichten"] .space-y-3');
                    if(w) {
                        var colors2 = ['border-vit-orange bg-orange-50','border-blue-500 bg-blue-50','border-green-500 bg-green-50'];
                        w.innerHTML = aR.data.map(function(a,i){
                            var ago = Math.floor((Date.now()-new Date(a.created_at).getTime())/3600000);
                            var agoStr = ago < 1 ? 'gerade eben' : (ago < 24 ? 'vor '+ago+' Stunde'+(ago>1?'n':'') : 'vor '+Math.floor(ago/24)+' Tag'+(Math.floor(ago/24)>1?'en':''));
                            return '<div class="p-3 rounded-lg border-l-4 '+colors2[i%3]+'">'
                                +'<p class="text-sm font-semibold text-gray-800">'+a.titel+'</p>'
                                +'<p class="text-xs text-gray-600">'+agoStr+'</p></div>';
                        }).join('');
                    }
                }
            } catch(e) { console.warn('Dashboard announcements:', e); }

            // 6. Pipeline Widget
            try {
                var pQ = sb.from('leads').select('id,status');
                if(stdId) pQ = pQ.eq('standort_id', stdId);
                var pR = await pQ;
                if(pR.data) {
                    var offene = pR.data.filter(function(l){ return l.status !== 'abgeschlossen' && l.status !== 'verloren'; }).length;
                    var angebote = pR.data.filter(function(l){ return l.status === 'angebot'; }).length;
                    var w = document.querySelector('[data-widget="pipeline"] .space-y-3');
                    if(w) {
                        // Count today's termine for pipeline widget too
                        var todayTermine = 0;
                        try {
                            var td = new Date().toISOString().split('T')[0];
                            var tResp = await sb.from('kalender_termine').select('id',{count:'exact',head:true}).gte('startzeit',td+'T00:00:00').lte('startzeit',td+'T23:59:59');
                            todayTermine = tResp.count || 0;
                        } catch(e2){}
                        w.innerHTML = '<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Offene Leads</span><span class="font-bold text-blue-600">'+offene+'</span></div>'
                            +'<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Heute Termine</span><span class="font-bold text-purple-600">'+todayTermine+'</span></div>'
                            +'<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Angebote offen</span><span class="font-bold text-orange-600">'+angebote+'</span></div>';
                    }
                }
            } catch(e) { console.warn('Dashboard pipeline:', e); }

            // 7. Umsatz & Ergebnis Hauptkarte
            try {
                var uQ = sb.from('bwa_daten').select('monat,jahr,umsatzerloese,rohertrag,gesamtkosten,ergebnis_vor_steuern,betriebsergebnis');
                if(stdId) uQ = uQ.eq('standort_id', stdId);
                var uR = await uQ.order('jahr',{ascending:false}).order('monat',{ascending:false}).limit(1);
                if(uR.data && uR.data.length > 0) {
                    var d = uR.data[0];
                    var u = parseFloat(d.umsatzerloese)||0;
                    var r = parseFloat(d.rohertrag)||0;
                    var k = parseFloat(d.gesamtkosten)||0;
                    var eg = parseFloat(d.ergebnis_vor_steuern)||parseFloat(d.betriebsergebnis)||0;
                    var rm = u>0?Math.round(r/u*100):0;
                    var em = u>0?Math.round(eg/u*100):0;
                    
                    var el = function(id){ return document.getElementById(id); };
                    if(el('dashUmsatzWert')) el('dashUmsatzWert').textContent = eur(u)+' â‚¬';
                    if(el('dashUmsatzLabel')) el('dashUmsatzLabel').textContent = monatNamen[d.monat]+' '+d.jahr;
                    if(el('dashRohertragWert')) el('dashRohertragWert').textContent = eur(r)+' â‚¬';
                    if(el('dashRohertragBar')) el('dashRohertragBar').style.width = Math.min(rm,100)+'%';
                    if(el('dashRohertragPct')) el('dashRohertragPct').textContent = rm+'%';
                    if(el('dashKostenWert')) el('dashKostenWert').textContent = eur(k)+' â‚¬';
                    if(el('dashErgebnisWert')) { el('dashErgebnisWert').textContent = eur(eg)+' â‚¬'; el('dashErgebnisWert').className = 'text-3xl font-bold '+(eg>=0?'text-green-600':'text-red-600'); }
                    if(el('dashErgebnisBar')) el('dashErgebnisBar').style.width = Math.min(Math.abs(em),100)+'%';
                    if(el('dashErgebnisPct')) { el('dashErgebnisPct').textContent = em+'%'; el('dashErgebnisPct').className = 'text-xs font-semibold '+(em>=0?'text-green-600':'text-red-600'); }
                    if(el('dashErgebnisBar')) el('dashErgebnisBar').className = (eg>=0?'bg-green-500':'bg-red-500')+' h-2 rounded-full';
                } else {
                    var el2 = document.getElementById('dashUmsatzLabel');
                    if(el2) el2.textContent = 'Noch keine BWA hochgeladen';
                }
            } catch(e) { console.warn('Dashboard umsatz card:', e); }
        }

        // === DEMO MODE SYSTEM ===
        var isDemoMode = false;
        var demoDataSeeded = false;

        function checkDemoMode() {
            var oldDemo = isDemoMode;
            isDemoMode = sbProfile && sbProfile.status === 'demo';
            console.log('[DEMO] checkDemoMode: status=' + (sbProfile ? sbProfile.status : 'null') + ', isDemoMode=' + isDemoMode + ', demoDataSeeded=' + demoDataSeeded);
            // Remove banner if it exists
            var existing = document.getElementById('demoBanner');
            if(existing) existing.remove();
            if(isDemoMode) {
                showDemoBanner();
                if(!demoDataSeeded) seedDemoData();
            } else if(oldDemo && demoDataSeeded) {
                // Was demo, now switched away â†’ clear demo data
                clearDemoData();
            }
        }

        function showDemoBanner() {
            var banner = document.createElement('div');
            banner.id = 'demoBanner';
            banner.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;z-index:99999;background:#DC2626;color:white;text-align:center;padding:6px 0;font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;box-shadow:0 2px 8px rgba(220,38,38,0.4);">DEMOMODUS</div>';
            document.body.appendChild(banner);
            // Push nav and content down
            var nav = document.querySelector('.topnav-desktop');
            if(nav) nav.style.marginTop = '32px';
            var mob = document.querySelector('.mobile-nav');
            if(mob) mob.style.marginTop = '32px';
            document.getElementById('mainApp').style.paddingTop = '32px';
        }

        function removeDemoBanner() {
            var b = document.getElementById('demoBanner');
            if(b) b.remove();
            var nav = document.querySelector('.topnav-desktop');
            if(nav) nav.style.marginTop = '0';
            var mob = document.querySelector('.mobile-nav');
            if(mob) mob.style.marginTop = '0';
            document.getElementById('mainApp').style.paddingTop = '0';
        }

        function seedDemoData() {
            demoDataSeeded = true;
            console.log('[DEMO] Seeding demo data...');

            // === HQ STANDORTE (drives Cockpit, Finanzen, Marketing, Standorte views) ===
            var demoStandorte = [
                {name:'vit:bikes Grafrath', inhaber:'Markus Keller', region:'sÃ¼d', umsatzPlan:128000, umsatzIst:142500, rohertrag:38.2, leadPerf:111, leads:48, cpt:127, budget:2400, vororderStatus:'confirmed', vororderBikes:85, rabattQuote:3.8, verkauftKW:6, beratungenKW:14, offeneTickets:1, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Hamburg', inhaber:'Thomas Berger', region:'nord', umsatzPlan:185000, umsatzIst:167800, rohertrag:36.4, leadPerf:91, leads:62, cpt:142, budget:3200, vororderStatus:'confirmed', vororderBikes:120, rabattQuote:4.2, verkauftKW:8, beratungenKW:18, offeneTickets:2, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Berlin-Brandenburg', inhaber:'Patrick Henkel', region:'ost', umsatzPlan:156000, umsatzIst:138200, rohertrag:37.1, leadPerf:89, leads:54, cpt:155, budget:2800, vororderStatus:'confirmed', vororderBikes:95, rabattQuote:4.5, verkauftKW:5, beratungenKW:12, offeneTickets:1, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes MÃ¼nchen Ost', inhaber:'Stefan Lang', region:'sÃ¼d', umsatzPlan:210000, umsatzIst:228400, rohertrag:40.1, leadPerf:109, leads:78, cpt:118, budget:4000, vororderStatus:'confirmed', vororderBikes:145, rabattQuote:2.9, verkauftKW:11, beratungenKW:22, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Erding', inhaber:'Michael Huber', region:'sÃ¼d', umsatzPlan:95000, umsatzIst:88700, rohertrag:35.8, leadPerf:93, leads:32, cpt:165, budget:1800, vororderStatus:'pending', vororderBikes:55, rabattQuote:5.1, verkauftKW:4, beratungenKW:9, offeneTickets:1, strategieStatus:'partial', bwaAuffaellig:null},
                {name:'vit:bikes Holzkirchen', inhaber:'Anna Maier', region:'sÃ¼d', umsatzPlan:82000, umsatzIst:91200, rohertrag:39.5, leadPerf:111, leads:28, cpt:132, budget:1600, vororderStatus:'confirmed', vororderBikes:48, rabattQuote:3.2, verkauftKW:5, beratungenKW:11, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Dessau', inhaber:'Frank Richter', region:'ost', umsatzPlan:68000, umsatzIst:52100, rohertrag:33.2, leadPerf:77, leads:18, cpt:198, budget:1200, vororderStatus:'pending', vororderBikes:35, rabattQuote:6.1, verkauftKW:2, beratungenKW:6, offeneTickets:3, strategieStatus:'pending', bwaAuffaellig:'Rohertrag unter 34%'},
                {name:'vit:bikes Flensburg', inhaber:'Kai Hansen', region:'nord', umsatzPlan:74000, umsatzIst:68900, rohertrag:37.8, leadPerf:93, leads:24, cpt:148, budget:1400, vororderStatus:'confirmed', vororderBikes:42, rabattQuote:4.0, verkauftKW:3, beratungenKW:8, offeneTickets:1, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Ellerhoop', inhaber:'Jan Peters', region:'nord', umsatzPlan:58000, umsatzIst:61300, rohertrag:38.9, leadPerf:106, leads:21, cpt:125, budget:1100, vororderStatus:'confirmed', vororderBikes:38, rabattQuote:3.5, verkauftKW:3, beratungenKW:7, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Gummersbach', inhaber:'Dirk Scholz', region:'west', umsatzPlan:72000, umsatzIst:58400, rohertrag:34.6, leadPerf:81, leads:22, cpt:175, budget:1300, vororderStatus:'pending', vororderBikes:40, rabattQuote:5.4, verkauftKW:3, beratungenKW:8, offeneTickets:2, strategieStatus:'partial', bwaAuffaellig:null},
                {name:'vit:bikes Hanau', inhaber:'Sabine Wolf', region:'mitte', umsatzPlan:88000, umsatzIst:84600, rohertrag:37.3, leadPerf:96, leads:30, cpt:141, budget:1700, vororderStatus:'confirmed', vororderBikes:52, rabattQuote:4.1, verkauftKW:4, beratungenKW:10, offeneTickets:1, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Hann MÃ¼nden', inhaber:'Ralf Braun', region:'mitte', umsatzPlan:52000, umsatzIst:39800, rohertrag:32.1, leadPerf:77, leads:14, cpt:210, budget:900, vororderStatus:'open', vororderBikes:28, rabattQuote:6.8, verkauftKW:1, beratungenKW:5, offeneTickets:2, strategieStatus:'pending', bwaAuffaellig:'Rohertrag unter 34%, Umsatz 77% unter Plan'},
                {name:'vit:bikes Kalkar', inhaber:'Petra Engel', region:'west', umsatzPlan:45000, umsatzIst:47200, rohertrag:39.2, leadPerf:105, leads:16, cpt:130, budget:800, vororderStatus:'confirmed', vororderBikes:25, rabattQuote:3.0, verkauftKW:2, beratungenKW:5, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Karlsdorf-Neuthard', inhaber:'Jens Fischer', region:'sÃ¼d', umsatzPlan:64000, umsatzIst:71800, rohertrag:38.7, leadPerf:112, leads:25, cpt:122, budget:1200, vororderStatus:'confirmed', vororderBikes:38, rabattQuote:3.4, verkauftKW:4, beratungenKW:9, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes MÃ¼nchen West', inhaber:'Lisa Hartmann', region:'sÃ¼d', umsatzPlan:175000, umsatzIst:192600, rohertrag:39.8, leadPerf:110, leads:68, cpt:115, budget:3500, vororderStatus:'confirmed', vororderBikes:130, rabattQuote:3.1, verkauftKW:9, beratungenKW:20, offeneTickets:1, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes MÃ¼nster', inhaber:'Wolfgang Krause', region:'west', umsatzPlan:98000, umsatzIst:87500, rohertrag:36.9, leadPerf:89, leads:35, cpt:152, budget:1900, vororderStatus:'confirmed', vororderBikes:58, rabattQuote:4.3, verkauftKW:5, beratungenKW:11, offeneTickets:1, strategieStatus:'partial', bwaAuffaellig:null},
                {name:'vit:bikes Garching an der Alz', inhaber:'Hans Wimmer', region:'sÃ¼d', umsatzPlan:55000, umsatzIst:62100, rohertrag:40.5, leadPerf:113, leads:20, cpt:118, budget:1000, vororderStatus:'confirmed', vororderBikes:32, rabattQuote:2.8, verkauftKW:3, beratungenKW:7, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Limburg', inhaber:'Claudia Bauer', region:'mitte', umsatzPlan:62000, umsatzIst:54800, rohertrag:35.4, leadPerf:88, leads:19, cpt:168, budget:1100, vororderStatus:'pending', vororderBikes:34, rabattQuote:5.2, verkauftKW:2, beratungenKW:6, offeneTickets:1, strategieStatus:'pending', bwaAuffaellig:null},
                {name:'vit:bikes Lohmar', inhaber:'Martin Schulte', region:'west', umsatzPlan:48000, umsatzIst:44200, rohertrag:37.6, leadPerf:92, leads:15, cpt:145, budget:850, vororderStatus:'confirmed', vororderBikes:28, rabattQuote:3.9, verkauftKW:2, beratungenKW:5, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null},
                {name:'vit:bikes Lasten & Spezial', inhaber:'Bernd Otto', region:'nord', umsatzPlan:42000, umsatzIst:38600, rohertrag:41.2, leadPerf:92, leads:12, cpt:195, budget:750, vororderStatus:'confirmed', vororderBikes:18, rabattQuote:2.5, verkauftKW:1, beratungenKW:4, offeneTickets:0, strategieStatus:'done', bwaAuffaellig:null}
            ];
            // Add id field
            demoStandorte.forEach(function(s,i){ s.id = 'demo-std-'+i; });
            hqStandorte = demoStandorte;

            // === STANDORT-VIEW BWA DATA ===
            bwaCache = [
                {id:'demo-bwa-1', monat:1, jahr:2026, umsatzerloese:54938, wareneinsatz:-33580, rohertrag:21358, personalkosten:-13485, raumkosten:-4150, werbekosten:-2039, abschreibungen:-1567, sonstige_kosten:-61, gesamtkosten:-25342, betriebsergebnis:-3935, zinsaufwand:-550, ergebnis_vor_steuern:-4485, created_at:'2026-02-05', davon_fahrraeder:47380, davon_teile:6052, davon_service:3534, davon_skonti:-2028},
                {id:'demo-bwa-2', monat:12, jahr:2025, umsatzerloese:42100, wareneinsatz:-26300, rohertrag:15800, personalkosten:-12800, raumkosten:-4150, werbekosten:-1200, abschreibungen:-1567, sonstige_kosten:-420, gesamtkosten:-22837, betriebsergebnis:-5237, zinsaufwand:-580, ergebnis_vor_steuern:-5817, created_at:'2026-01-10'}
            ];

            // === PIPELINE (Sales Kanban) ===
            verkaufData.pipeline = [
                {id:1, name:'Thomas Meier', type:'E-MTB', budget:'4.500 â‚¬', stage:'termin', date:'14.02.2026', source:'Website', priority:'hoch', notes:'Probefahrt am Sa'},
                {id:2, name:'Anna Schmidt', type:'City E-Bike', budget:'2.800 â‚¬', stage:'angebot', date:'12.02.2026', source:'Laden', priority:'mittel', notes:'Kalkhoff Entice'},
                {id:3, name:'Michael Weber', type:'Trekking', budget:'3.200 â‚¬', stage:'beratung', date:'10.02.2026', source:'Empfehlung', priority:'hoch', notes:'Orbea Gain'},
                {id:4, name:'Lisa Braun', type:'E-Bike Leasing', budget:'5.000 â‚¬', stage:'lead', date:'13.02.2026', source:'Meta Ad', priority:'mittel', notes:'JobRad Anfrage'},
                {id:5, name:'Peter Koch', type:'Rennrad', budget:'6.500 â‚¬', stage:'verkauft', date:'08.02.2026', source:'Google', priority:'niedrig', notes:'Orbea Orca'},
                {id:6, name:'Sandra Huber', type:'Kinder-MTB', budget:'800 â‚¬', stage:'verloren', date:'05.02.2026', source:'Laden', priority:'niedrig', notes:'Online gekauft'},
                {id:7, name:'Klaus Richter', type:'E-Cargo', budget:'5.500 â‚¬', stage:'termin', date:'15.02.2026', source:'Messe', priority:'hoch', notes:'Riese & MÃ¼ller'},
                {id:8, name:'Maria Fischer', type:'E-MTB', budget:'4.000 â‚¬', stage:'lead', date:'14.02.2026', source:'Instagram', priority:'mittel', notes:'Haibike AllMtn'}
            ];

            // === VERKAUF TRACKING ===
            verkaufData.mitarbeiter = [
                {name:'Sandra', plan_soll:10, gesamt_ist:6, verkauft:4, umsatz_kw:12400, umsatz_jahr:48200, vk_jahr:18, top_marke:'Kalkhoff', quote:67, avg_vk:2678},
                {name:'Thomas', plan_soll:8, gesamt_ist:5, verkauft:3, umsatz_kw:9800, umsatz_jahr:38500, vk_jahr:14, top_marke:'Orbea', quote:60, avg_vk:2750},
                {name:'Dirk', plan_soll:15, gesamt_ist:9, verkauft:6, umsatz_kw:18200, umsatz_jahr:72600, vk_jahr:26, top_marke:'Haibike', quote:67, avg_vk:2792},
                {name:'Max', plan_soll:5, gesamt_ist:3, verkauft:2, umsatz_kw:5600, umsatz_jahr:15800, vk_jahr:6, top_marke:'Simplon', quote:67, avg_vk:2633}
            ];
            verkaufData.monatsuebersicht = [
                {monat:'Januar',plan:57025,ist:57025,termine_soll:24,termine_ist:22,verkauft:18,quote:82,avg:3168},
                {monat:'Februar',plan:77734,ist:46000,termine_soll:32,termine_ist:23,verkauft:15,quote:65,avg:3067}
            ];

            // === TODOS ===
            if(typeof todosData !== 'undefined' && Array.isArray(todosData)) {
                todosData.push(
                    {id:'demo-t1', text:'Schaufenster FrÃ¼hlingsdeko aufbauen', done:false, prio:'hoch', due:'2026-02-20', assignee:'Sandra'},
                    {id:'demo-t2', text:'Orbea Preisliste 2026 durchgehen', done:false, prio:'mittel', due:'2026-02-18', assignee:'Thomas'},
                    {id:'demo-t3', text:'Bosch-Diagnose Software updaten', done:true, prio:'niedrig', due:'2026-02-14', assignee:'Dirk'},
                    {id:'demo-t4', text:'Testival MÃ¤rz planen â€“ Location buchen', done:false, prio:'hoch', due:'2026-02-25', assignee:'Sandra'}
                );
            }

            // === TICKETS ===
            if(typeof ticketData !== 'undefined' && Array.isArray(ticketData)) {
                ticketData.push(
                    {id:'demo-tk1', subject:'POS-System stÃ¼rzt bei Ratenzahlung ab', status:'offen', prio:'hoch', erstellt:'2026-02-13', kat:'IT/Software'},
                    {id:'demo-tk2', subject:'Kalkhoff Entice â€“ Rahmen Garantiefall', status:'in_bearbeitung', prio:'mittel', erstellt:'2026-02-10', kat:'Garantie'},
                    {id:'demo-tk3', subject:'Marketing Budget Q2 Freigabe', status:'offen', prio:'niedrig', erstellt:'2026-02-12', kat:'Buchhaltung'}
                );
            }

            // === ANNOUNCEMENTS ===
            if(typeof announcementsData !== 'undefined' && Array.isArray(announcementsData)) {
                announcementsData.unshift(
                    {id:'demo-a1', title:'ðŸ†• Neue Shimano EP801 Serie ab sofort verfÃ¼gbar', content:'Die EP801 Motoren kÃ¶nnen ab sofort bestellt werden. Bitte aktualisiert eure Ausstellungsmodelle bis Ende Februar.', date:'2026-02-14', type:'produkt', wichtig:true},
                    {id:'demo-a2', title:'ðŸ“… Netzwerk-Meeting Q1 am 5. MÃ¤rz', content:'Pflichttermin fÃ¼r alle Partner. Agenda: Saisonstart, neue Markenpartner, BWA-Auswertung Q4.', date:'2026-02-10', type:'termin', wichtig:false}
                );
            }

            // === KALENDER ===
            if(typeof kalTermine !== 'undefined' && Array.isArray(kalTermine)) {
                kalTermine.push(
                    {id:'demo-k1', title:'Probefahrt Hr. Meier (E-MTB)', date:'2026-02-17', time:'10:00', endTime:'11:00', type:'termin', user:'Sandra', ort:'Laden'},
                    {id:'demo-k2', title:'Bosch Diagnose Schulung', date:'2026-02-19', time:'09:00', endTime:'12:00', type:'schulung', user:'alle', ort:'Online'},
                    {id:'demo-k3', title:'Werkstatt-Team Meeting', date:'2026-02-20', time:'08:00', endTime:'08:30', type:'meeting', user:'alle', ort:'Werkstatt'},
                    {id:'demo-k4', title:'Frau Schmidt Leasing-Abholung', date:'2026-02-21', time:'14:00', endTime:'15:00', type:'termin', user:'Thomas', ort:'Laden'},
                    {id:'demo-k5', title:'Orbea Launch Event Vorbereitung', date:'2026-02-22', time:'16:00', endTime:'17:00', type:'event', user:'Sandra', ort:'Laden'}
                );
            }

            // === HQ KALENDER TERMINE ===
            hqKalTermine = [
                {id:'demo-hk1', title:'Netzwerk-Meeting Q1', date:'2026-03-05', time:'10:00', type:'meeting', target:'alle', pflicht:true},
                {id:'demo-hk2', title:'Shimano EP801 Webinar', date:'2026-02-24', time:'14:00', type:'schulung', target:'verkauf', pflicht:false},
                {id:'demo-hk3', title:'BWA Deadline Januar', date:'2026-02-20', time:'23:59', type:'deadline', target:'buchhaltung', pflicht:true},
                {id:'demo-hk4', title:'Orbea Launch Event MÃ¼nchen', date:'2026-03-12', time:'18:00', type:'event', target:'alle', pflicht:false},
                {id:'demo-hk5', title:'Bosch Smart System Schulung', date:'2026-02-25', time:'09:00', type:'schulung', target:'werkstatt', pflicht:true}
            ];

            // === IDEENBOARD ===
            if(typeof ideenData !== 'undefined' && Array.isArray(ideenData) && ideenData.length === 0) {
                ideenData.push(
                    {id:'demo-i1', title:'Leasing-Rechner auf Website einbauen', desc:'Kunden kÃ¶nnen direkt auf unserer Website die Leasingrate berechnen.', autor:'Sandra (Grafrath)', votes:8, status:'offen', date:'2026-02-01'},
                    {id:'demo-i2', title:'Gemeinsamer Einkauf von Werkstattmaterial', desc:'Ãœber das Portal Sammelbestellungen fÃ¼r Verbrauchsmaterial koordinieren.', autor:'Thomas (Hamburg)', votes:12, status:'in_umsetzung', date:'2026-01-15'}
                );
            }

            // === RE-RENDER ALL HQ VIEWS ===
            try { renderHqCockpit(); } catch(e) { console.warn('[DEMO] cockpit render:', e); }
            try { renderHqStandorte(); } catch(e) { console.warn('[DEMO] standorte render:', e); }
            try { renderHqFinanzen(); } catch(e) { console.warn('[DEMO] finanzen render:', e); }
            try { renderHqMarketing(); } catch(e) { console.warn('[DEMO] marketing render:', e); }
            try { if(typeof renderBwaList === 'function') renderBwaList(); } catch(e) {}
            try { if(typeof renderKanban === 'function') renderKanban(); } catch(e) {}

            console.log('[DEMO] Demo data seeded âœ… (' + hqStandorte.length + ' Standorte)');
        }

        function clearDemoData() {
            demoDataSeeded = false;
            isDemoMode = false;
            removeDemoBanner();
            console.log('[DEMO] Clearing demo data...');

            // Clear HQ Standorte â†’ triggers empty state on re-render
            hqStandorte = [];
            hqKalTermine = [];

            // Clear BWA demo data
            if(typeof bwaCache !== 'undefined') bwaCache = bwaCache.filter(function(b){ return !String(b.id).startsWith('demo-'); });
            // Clear Pipeline demo data
            if(typeof verkaufData !== 'undefined') { verkaufData.pipeline = []; verkaufData.mitarbeiter = []; verkaufData.monatsuebersicht = []; }
            // Clear Todos demo data  
            if(typeof todosData !== 'undefined' && Array.isArray(todosData)) todosData = todosData.filter(function(t){ return !String(t.id).startsWith('demo-'); });
            // Clear Tickets demo
            if(typeof ticketData !== 'undefined' && Array.isArray(ticketData)) ticketData = ticketData.filter(function(t){ return !String(t.id).startsWith('demo-'); });
            // Clear Announcements demo
            if(typeof announcementsData !== 'undefined' && Array.isArray(announcementsData)) announcementsData = announcementsData.filter(function(a){ return !String(a.id).startsWith('demo-'); });
            // Clear Kalender demo
            if(typeof kalTermine !== 'undefined' && Array.isArray(kalTermine)) kalTermine = kalTermine.filter(function(k){ return !String(k.id).startsWith('demo-'); });
            // Clear Ideen demo
            if(typeof ideenData !== 'undefined' && Array.isArray(ideenData)) ideenData = ideenData.filter(function(i){ return !String(i.id).startsWith('demo-'); });

            // Re-render HQ views with real (empty) data
            try { loadHqStandorte().then(function(){ renderHqCockpit(); renderHqStandorte(); renderHqFinanzen(); renderHqMarketing(); }); } catch(e) {}

            console.log('[DEMO] Demo data cleared âœ…');
        }

        async function checkPendingApprovals() {
            var isHQ = currentRoles.indexOf('hq') >= 0 || (sbProfile && sbProfile.is_hq);
            var isGF = currentRoles.indexOf('inhaber') >= 0;
            if(!isHQ && !isGF) return;
            try {
                var query = sb.from('users').select('id,name,email,created_at').in('status',['onboarding','pending']);
                // GF: nur eigener Standort
                if(!isHQ && sbStandort) query = query.eq('standort_id', sbStandort.id);
                var resp = await query;
                if(resp.error || !resp.data) return;
                // Filter: nur User die wirklich keine Rollen haben
                var pendingUsers = [];
                for(var i=0; i<resp.data.length; i++) {
                    var rResp = await sb.from('user_rollen').select('id').eq('user_id', resp.data[i].id);
                    if(!rResp.data || rResp.data.length === 0) pendingUsers.push(resp.data[i]);
                }
                if(pendingUsers.length === 0) return;
                // Show notification banner
                var existing = document.getElementById('approvalBanner');
                if(existing) existing.remove();
                var names = pendingUsers.map(function(u){return u.name;}).join(', ');
                var banner = document.createElement('div');
                banner.id = 'approvalBanner';
                banner.innerHTML = '<div style="position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:9000;max-width:600px;width:90%;" class="bg-yellow-50 border border-yellow-300 rounded-xl shadow-lg px-5 py-3 flex items-center justify-between">'
                    + '<div class="flex items-center space-x-3">'
                    + '<span class="text-2xl">\u26a0\ufe0f</span>'
                    + '<div><p class="text-sm font-semibold text-yellow-800">' + pendingUsers.length + ' neue' + (pendingUsers.length===1?'r Mitarbeiter':' Mitarbeiter') + ' wartet auf Freigabe</p>'
                    + '<p class="text-xs text-yellow-600">' + names + '</p></div></div>'
                    + '<div class="flex items-center space-x-2">'
                    + '<button onclick="showView(\'kzMitarbeiter\');document.getElementById(\'approvalBanner\').remove();" class="px-3 py-1.5 bg-vit-orange text-white text-xs font-semibold rounded-lg hover:opacity-90">Jetzt freigeben</button>'
                    + '<button onclick="document.getElementById(\'approvalBanner\').remove();" class="text-yellow-400 hover:text-yellow-600 text-lg">\u2715</button>'
                    + '</div></div>';
                document.body.appendChild(banner);
            } catch(err) { console.warn('Approval check:', err); }
        }

        async function loadPipelineFromSupabase() {
            try {
                var resp = await sb.from('leads').select('*').order('created_at', { ascending: false });
                if(resp.error) throw resp.error;
                var stageMap = { 'neu':'lead','kontaktiert':'termin','angebot':'angebot','verhandlung':'beratung','gewonnen':'verkauft','verloren':'verloren' };
                verkaufData.pipeline = (resp.data||[]).map(function(l,i) {
                    var d = new Date(l.created_at);
                    return {
                        id: i+1, sb_id: l.id,
                        name: (l.vorname||'')+' '+(l.nachname||''),
                        type: l.interesse||'E-Bike',
                        seller: sbProfile ? sbProfile.name.split(' ')[0] : 'Team',
                        value: parseFloat(l.geschaetzter_wert)||0,
                        stage: stageMap[l.status]||'lead',
                        status_raw: l.status,
                        date: d.getDate().toString().padStart(2,'0')+'.'+(d.getMonth()+1).toString().padStart(2,'0')+'.'
                    };
                });
                if(document.getElementById('vkTabPipeline') && document.getElementById('vkTabPipeline').style.display !== 'none') renderPipeline();
            } catch(err) { console.error('Pipeline load error:', err); }
        }

        async function handleLogout() {
            await sb.auth.signOut();
            sbUser = null; sbProfile = null; sbRollen = []; sbStandort = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('pendingScreen').style.display = 'none';
            document.getElementById('blockedScreen').style.display = 'none';
        }

        async function checkSession() {
            // Detect password recovery from reset link
            var hash = window.location.hash;
            if (hash && hash.includes('type=recovery')) {
                // Supabase will auto-set session from hash
                var resp = await sb.auth.getSession();
                if (resp.data.session) {
                    sbUser = resp.data.session.user;
                    showChangePasswordModal();
                    return;
                }
            }
            var resp = await sb.auth.getSession();
            if(resp.data.session && resp.data.session.user) {
                sbUser = resp.data.session.user;
                try {
                    // Status-Check vor dem App-Laden
                    var profileResp = await sb.from('users').select('status').eq('id', sbUser.id).single();
                    
                    if(profileResp.data && (profileResp.data.status === 'pending' || profileResp.data.status === 'onboarding')) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('pendingScreen').style.display = 'flex';
                        var pe = document.getElementById('pendingEmail');
                        if(pe) pe.textContent = sbUser.email || '';
                        return;
                    }
                    if(profileResp.data && (profileResp.data.status === 'offboarding' || profileResp.data.status === 'gesperrt')) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('blockedScreen').style.display = 'flex';
                        return;
                    }
                    
                    await loadUserProfile(sbUser.id);
                    await loadModulStatus();
                    enterApp();
                } catch(e) { console.warn('Auto-login failed:', e); }
            }
        }

        function showChangePasswordModal() {
            var html = '<div id="changePwOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div style="background:white;border-radius:16px;padding:28px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDD12 '+t('pw_change_title')+'</h3></div>';
            html += '<p class="text-sm text-gray-500 mb-4">'+t('pw_change_desc')+'</p>';
            html += '<input id="newPw1" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="'+t('pw_change_new')+'">';
            html += '<input id="newPw2" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="'+t('pw_change_repeat')+'">';
            html += '<div id="changePwMsg" style="display:none" class="text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="changePwBtn" onclick="submitNewPassword()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">'+t('pw_change_save')+'</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'changePwContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        async function submitNewPassword() {
            var pw1 = (document.getElementById('newPw1') || {}).value;
            var pw2 = (document.getElementById('newPw2') || {}).value;
            var msg = document.getElementById('changePwMsg');
            var btn = document.getElementById('changePwBtn');
            if (!pw1 || pw1.length < 6) { msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent='Mindestens 6 Zeichen.'; msg.style.display='block'; return; }
            if (pw1 !== pw2) { msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent='Passwoerter stimmen nicht ueberein.'; msg.style.display='block'; return; }
            btn.disabled = true; btn.textContent = 'Wird gespeichert...';
            try {
                var resp = await sb.auth.updateUser({ password: pw1 });
                if (resp.error) throw resp.error;
                msg.className='text-sm rounded-lg p-3 mb-3 bg-green-50 border border-green-200 text-green-700';
                msg.textContent='Passwort erfolgreich geaendert! Du wirst weitergeleitet...';
                msg.style.display='block';
                // Clear hash and redirect
                window.location.hash = '';
                setTimeout(function() {
                    var c = document.getElementById('changePwContainer'); if(c) c.remove();
                    checkSession();
                }, 1500);
            } catch(e) {
                msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600';
                msg.textContent='Fehler: '+e.message; msg.style.display='block';
                btn.disabled=false; btn.textContent='Passwort speichern';
            }
        }


        // Update UI based on role
        function updateUIForRole() {
            // Rollen-Texte
            var roleLabels = {
                'inhaber': 'GeschÃ¤ftsleitung',
                'verkauf': 'Verkauf',
                'werkstatt': 'Werkstatt',
                'buchhaltung': 'Buchhaltung',
                'hq': 'HQ'
            };

            // Rollen-Anzeige zusammenbauen
            if(!currentRoles || !Array.isArray(currentRoles)) currentRoles = ['inhaber'];
            var roleDisplay = currentRoles.map(function(r){ return roleLabels[r]||r; }).join(', ');

            // Location name from Supabase
            var locationName = sbStandort ? sbStandort.name : 'Standort';
            var isHQ = currentRole === 'hq' || (sbProfile && sbProfile.is_hq);
            
            var userRoleText = document.getElementById('userRoleText');
            var locationDisplay = document.getElementById('locationDisplay');
            var locationDisplayMobile = document.getElementById('locationDisplayMobile');
            var userRoleDisplay = document.getElementById('userRoleDisplay');
            
            var displayLocation = isHQ ? 'ðŸ¢ HQ â€“ Netzwerk' : locationName;
            if (userRoleText) userRoleText.textContent = roleDisplay;
            if (locationDisplay) locationDisplay.textContent = displayLocation;
            if (locationDisplayMobile) locationDisplayMobile.textContent = displayLocation;
            if (userRoleDisplay) userRoleDisplay.textContent = isHQ ? '' : '';

            // Premium Badge
            var premiumBadge = document.getElementById('premiumBadge');
            if (premiumBadge) {
                if (isPremium) {
                    premiumBadge.innerHTML = '<span class="premium-badge">PREMIUM</span>';
                    premiumBadge.classList.remove('view-hidden');
                } else {
                    premiumBadge.classList.add('view-hidden');
                }
            }

            var isInhaber = hasRole('inhaber');

            // HQ Toggle anzeigen fÃ¼r Inhaber
            var hqToggle = document.getElementById('hqToggleSection');
            if(hqToggle) hqToggle.classList.toggle('hidden', !isInhaber);
            var btnStandort = document.getElementById('btnModeStandort');
            var btnHQ = document.getElementById('btnModeHQ');
            if(btnStandort) btnStandort.className = 'flex-1 py-2 px-3 rounded-md text-xs font-bold transition ' + (isHQ ? 'text-white/60 hover:text-white' : 'bg-white text-gray-800');
            if(btnHQ) btnHQ.className = 'flex-1 py-2 px-3 rounded-md text-xs font-bold transition ' + (isHQ ? 'bg-white text-gray-800' : 'text-white/60 hover:text-white');

            // === SIDEBAR VISIBILITY ===
            // Partner QuickNav (Startseite, Kalender, Aufgaben, Kommunikation) - alle Standort-Rollen
            var partnerQuickNav = document.getElementById('partnerQuickNav');
            if(partnerQuickNav) partnerQuickNav.classList.toggle('hidden', isHQ);

            // Dashboards - nur Inhaber
            var ownerDashboards = document.getElementById('ownerDashboards');
            if(ownerDashboards) ownerDashboards.classList.toggle('hidden', !isInhaber || isHQ);

            // Fachbereiche Container
            var commonTools = document.getElementById('commonTools');
            if(commonTools) commonTools.classList.toggle('hidden', isHQ);

            // Einzelne Fachbereich-Buttons per Rolle steuern
            var sidebarViews = {
                'allgemein': ['inhaber','buchhaltung'],
                'verkauf': ['inhaber','verkauf','buchhaltung'],
                'einkauf': ['inhaber','werkstatt','buchhaltung'],
                'marketing': ['inhaber','verkauf'],
                'controlling': ['inhaber','buchhaltung']
            };
            Object.keys(sidebarViews).forEach(function(viewName){
                var btns = document.querySelectorAll('[onclick*=\"showView(\\\''+viewName+'\\\')\"]');
                btns.forEach(function(btn){
                    var allowed = false;
                    sidebarViews[viewName].forEach(function(r){ if(hasRole(r)) allowed=true; });
                    btn.classList.toggle('hidden', !allowed);
                });
            });

            // Tools-Bereich Einzelsteuerung
            var toolViews = {
                'wissen': ['alle'],
                'support': ['alle'],
                'aktenschrank': ['inhaber','buchhaltung'],
                'ideenboard': ['alle'],
                'shop': ['inhaber']
            };
            Object.keys(toolViews).forEach(function(viewName){
                var btns = document.querySelectorAll('[onclick*=\"showView(\\\''+viewName+'\\\')\"]');
                btns.forEach(function(btn){
                    if(isHQ) { btn.classList.add('hidden'); return; }
                    var perms = toolViews[viewName];
                    var allowed = perms.indexOf('alle')>=0;
                    if(!allowed) perms.forEach(function(r){ if(hasRole(r)) allowed=true; });
                    btn.classList.toggle('hidden', !allowed);
                });
            });

            // Onboarding - nur Inhaber
            var onboardingNav = document.getElementById('onboardingNavSection');
            if(onboardingNav) onboardingNav.classList.toggle('hidden', !isInhaber || isHQ);

            // Mitarbeiter - nur Inhaber
            var mitarbeiterNav = document.getElementById('mitarbeiterNavSection');
            if(mitarbeiterNav) mitarbeiterNav.classList.toggle('hidden', !isInhaber || isHQ);

            // Partner Tools (Wissen, Support, Ideenboard, Shop) - alle Standort-Rollen
            var partnerToolsNav = document.getElementById('partnerToolsNav');
            if(partnerToolsNav) partnerToolsNav.classList.toggle('hidden', isHQ);

            // HQ Menu
            var hqMenu = document.getElementById('hqMenu');
            if(hqMenu) hqMenu.classList.toggle('hidden', !isHQ);
        }

        // Switch between Chat and Forum in Communication view
        function switchCommunicationTab(tab) {
            const chatTab = document.getElementById('chatTab');
            const forumTab = document.getElementById('forumTab');
            const chatSection = document.getElementById('chatSection');
            const forumSection = document.getElementById('forumSection');
            
            if (tab === 'chat') {
                chatTab.classList.remove('bg-gray-200', 'text-gray-700');
                chatTab.classList.add('bg-vit-orange', 'text-white');
                forumTab.classList.remove('bg-vit-orange', 'text-white');
                forumTab.classList.add('bg-gray-200', 'text-gray-700');
                chatSection.style.display = 'block';
                forumSection.style.display = 'none';
            } else {
                forumTab.classList.remove('bg-gray-200', 'text-gray-700');
                forumTab.classList.add('bg-vit-orange', 'text-white');
                chatTab.classList.remove('bg-vit-orange', 'text-white');
                chatTab.classList.add('bg-gray-200', 'text-gray-700');
                forumSection.style.display = 'block';
                chatSection.style.display = 'none';
            }
        }

        // Update premium features visibility
        function updatePremiumFeatures() {
            const premiumMenuItems = document.querySelectorAll('.premium-menu-item');
            const premiumFeatures = document.querySelectorAll('.premium-feature');
            
            premiumMenuItems.forEach(item => {
                if (!isPremium) {
                    item.classList.add('locked-menu-item');
                    item.onclick = function(e) {
                        e.preventDefault();
                        showPremiumUpgradeModal();
                    };
                } else {
                    item.classList.remove('locked-menu-item');
                }
            });

            premiumFeatures.forEach(feature => {
                if (!isPremium) {
                    feature.classList.add('locked');
                } else {
                    feature.classList.remove('locked');
                }
            });
        }

        // Show premium upgrade modal
        function showPremiumUpgradeModal() {
            alert('ðŸ”’ Premium Feature\n\nDiese Funktion ist nur fÃ¼r vit:bikes Franchisenehmer verfÃ¼gbar.\n\nâœ¨ Werde vit:bikes Partner und erhalte Zugang zu:\nâ€¢ Marketing-Materialien vom HQ\nâ€¢ Best Practice Forum\nâ€¢ Einkaufsvorteile\nâ€¢ Schulungen & Support\n\nInteresse? Kontaktiere uns unter: partner@vitbikes.de');
        }

        // Show specific view
        
        // Dashboard Widget Management
        let dashboardEditMode = false;
        
        function toggleDashboardEdit() {
            dashboardEditMode = !dashboardEditMode;
            const addPanel = document.getElementById('widgetAddPanel');
            const removeButtons = document.querySelectorAll('.widget-remove');
            const editButton = document.getElementById('dashboardEditButton');
            
            if (dashboardEditMode) {
                addPanel.classList.remove('hidden');
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
                editButton.textContent = 'Fertig';
            } else {
                addPanel.classList.add('hidden');
                removeButtons.forEach(btn => btn.classList.add('hidden'));
                editButton.textContent = 'Dashboard anpassen';
            }
        }
        
        function addWidget(widgetName) {
            const widget = document.querySelector(`[data-widget="${widgetName}"]`);
            if (widget) {
                widget.style.display = 'block';
                showToast(`Widget "${widgetName}" hinzugefÃ¼gt`);
            }
        }
        
        // Widget Remove (Event Delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.widget-remove')) {
                const widget = e.target.closest('.dashboard-widget');
                const widgetName = widget.getAttribute('data-widget');
                widget.style.display = 'none';
                showToast(`Widget "${widgetName}" entfernt`);
            }
        });
        
        // Tab Switching Functions
        
        function showMarketingTab(tabName) {
            // Hide all marketing tabs
            document.querySelectorAll('.marketing-tab-content').forEach(function(tab) { tab.style.display = 'none'; });
            
            // Reset all tab buttons
            document.querySelectorAll('.marketing-tab-btn').forEach(function(btn) {
                btn.className = 'marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            
            // Show selected tab content
            var tabId = 'marketingTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            var tabEl = document.getElementById(tabId);
            if (tabEl) tabEl.style.display = 'block';
            
            // Highlight active tab button
            var activeBtn = document.querySelector('.marketing-tab-btn[data-tab="' + tabName + '"]');
            if (activeBtn) {
                activeBtn.className = 'marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            }

            // Init Social Media themen on first open
            if(tabName==='social') { renderSmThemen(); }
        }
        
        // === VERKAUF MODULE ===
        var verkaufData = {
            sellers: [
                {
                    name: 'Sandra', plan_soll: 10, gesamt_ist: 2, verkauft: 1, umsatz_kw: 7091, umsatz_jahr: 16192, vk_jahr: 6,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:5024},
                        {day:'Do',plan:2,gesamt:1,geplant:0,spontan:0,online:1,ergo:0,verkauft:1,uebergabe:0,umsatz:2067},
                        {day:'Fr',plan:2,gesamt:1,geplant:0,spontan:1,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Thomas', plan_soll: 0, gesamt_ist: 0, verkauft: 0, umsatz_kw: 0, umsatz_jahr: 17419, vk_jahr: 4,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Do',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Fr',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Dirk', plan_soll: 15, gesamt_ist: 2, verkauft: 0, umsatz_kw: 8569, umsatz_jahr: 36629, vk_jahr: 6,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:253},
                        {day:'Mi',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:4801},
                        {day:'Do',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:59},
                        {day:'Fr',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:3456},
                        {day:'Sa',plan:3,gesamt:2,geplant:0,spontan:2,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Max', plan_soll: 0, gesamt_ist: 0, verkauft: 0, umsatz_kw: 1396, umsatz_jahr: 3813, vk_jahr: 0,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:737},
                        {day:'Do',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Fr',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:659}
                    ]
                }
            ],
            jahres: [
                {monat:'Januar',plan:57025,ist:57025,termine_soll:24,termine_ist:12,verkauft:11,quote:92,avg:5184},
                {monat:'Februar',plan:77734,ist:17057,termine_soll:32,termine_ist:8,verkauft:5,quote:63,avg:3411},
                {monat:'Maerz',plan:150406,ist:0,termine_soll:62,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'April',plan:121269,ist:0,termine_soll:50,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Mai',plan:163470,ist:0,termine_soll:68,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Juni',plan:157808,ist:0,termine_soll:65,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Juli',plan:138764,ist:0,termine_soll:57,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'August',plan:76258,ist:0,termine_soll:32,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'September',plan:86544,ist:0,termine_soll:36,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Oktober',plan:73018,ist:0,termine_soll:30,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'November',plan:40796,ist:0,termine_soll:17,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Dezember',plan:24597,ist:0,termine_soll:10,termine_ist:0,verkauft:0,quote:0,avg:0}
            ],
            pipeline: [
                {id:1,name:'Fam. Mueller',type:'E-Bike Trekking',seller:'Sandra',value:4500,stage:'termin',date:'17.02.'},
                {id:2,name:'Hr. Schneider',type:'E-Bike MTB',seller:'Dirk',value:5200,stage:'beratung',date:'15.02.'},
                {id:3,name:'Fr. Weber',type:'E-Bike City',seller:'Sandra',value:3200,stage:'angebot',date:'14.02.'},
                {id:4,name:'Hr. Becker',type:'Rennrad',seller:'Thomas',value:2800,stage:'angebot',date:'13.02.'},
                {id:5,name:'Fam. Schmidt',type:'E-Bike Cargo',seller:'Dirk',value:6500,stage:'lead',date:'16.02.'},
                {id:6,name:'Fr. Klein',type:'E-Bike Trekking',seller:'Sandra',value:3800,stage:'termin',date:'18.02.'},
                {id:7,name:'Hr. Wagner',type:'MTB',seller:'Thomas',value:1900,stage:'lead',date:'16.02.'},
                {id:8,name:'Fr. Hoffmann',type:'E-Bike City',seller:'Dirk',value:3400,stage:'beratung',date:'14.02.'},
                {id:9,name:'Hr. Braun',type:'E-Bike Trekking',seller:'Sandra',value:4200,stage:'verkauft',date:'12.02.'},
                {id:10,name:'Fr. Richter',type:'E-Bike MTB',seller:'Dirk',value:5800,stage:'verkauft',date:'11.02.'},
                {id:11,name:'Hr. Wolf',type:'E-Bike City',seller:'Thomas',value:2900,stage:'verkauft',date:'10.02.'},
                {id:12,name:'Fam. Koch',type:'E-Bike Trekking',seller:'Dirk',value:4100,stage:'uebergabe',date:'08.02.'},
                {id:13,name:'Hr. Neumann',type:'Rennrad',seller:'Thomas',value:3200,stage:'verloren',date:'09.02.'},
                {id:14,name:'Fr. Schwarz',type:'E-Bike City',seller:'Sandra',value:2700,stage:'verloren',date:'07.02.'}
            ]
        };

        var pipelineStages = [
            {id:'lead',label:'Lead',color:'bg-gray-100 border-gray-300'},
            {id:'termin',label:'Termin gebucht',color:'bg-blue-50 border-blue-300'},
            {id:'beratung',label:'In Beratung',color:'bg-yellow-50 border-yellow-300'},
            {id:'angebot',label:'Angebot',color:'bg-purple-50 border-purple-300'},
            {id:'verkauft',label:'Verkauft',color:'bg-green-50 border-green-300'},
            {id:'uebergabe',label:'Uebergabe',color:'bg-emerald-50 border-emerald-300'},
            {id:'verloren',label:'Nicht gekauft',color:'bg-red-50 border-red-300'}
        ];

        function renderWeekView() {
            var filter = document.getElementById('weekSellerFilter').value;
            var sellers = filter === 'all' ? verkaufData.sellers : verkaufData.sellers.filter(function(s){return s.name === filter;});
            
            // Calculate KPIs
            var totalPlan = 0, totalGesamt = 0, totalVerkauft = 0, totalUmsatz = 0;
            sellers.forEach(function(s) {
                totalPlan += s.plan_soll;
                s.daily.forEach(function(d) {
                    totalGesamt += d.gesamt;
                    totalVerkauft += d.verkauft;
                    totalUmsatz += d.umsatz;
                });
            });
            document.getElementById('wkPlan').textContent = totalPlan;
            document.getElementById('wkGesamt').textContent = totalGesamt;
            document.getElementById('wkVerkauft').textContent = totalVerkauft;
            document.getElementById('wkUmsatz').textContent = totalUmsatz.toLocaleString('de-DE') + ' \u20AC';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            var quoteEl = document.getElementById('wkQuote');
            quoteEl.textContent = quoteVal + '%';
            quoteEl.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600');

            // Render seller tables
            var container = document.getElementById('weekSellerTables');
            var html = '';
            sellers.forEach(function(s) {
                var sUmsatz = 0, sGesamt = 0, sVerkauft = 0;
                s.daily.forEach(function(d) { sUmsatz += d.umsatz; sGesamt += d.gesamt; sVerkauft += d.verkauft; });
                var sQuote = sGesamt > 0 ? Math.round((sVerkauft/sGesamt)*100) : 0;

                html += '<div class="vit-card overflow-hidden">';
                html += '<div class="flex items-center justify-between p-4 bg-gray-50 border-b">';
                html += '<div class="flex items-center space-x-3"><div class="w-8 h-8 bg-vit-orange rounded-full flex items-center justify-center text-white font-bold text-sm">' + s.name.charAt(0) + '</div>';
                html += '<div><p class="font-semibold text-gray-800">' + s.name + '</p><p class="text-xs text-gray-500">Plan: ' + s.plan_soll + ' Termine</p></div></div>';
                html += '<div class="flex space-x-4 text-center">';
                html += '<div><p class="text-xs text-gray-500">Beratungen</p><p class="font-bold text-blue-600">' + sGesamt + '</p></div>';
                html += '<div><p class="text-xs text-gray-500">Verkauft</p><p class="font-bold text-green-600">' + sVerkauft + '</p></div>';
                html += '<div><p class="text-xs text-gray-500">Umsatz</p><p class="font-bold text-vit-orange">' + sUmsatz.toLocaleString('de-DE') + ' \u20AC</p></div>';
                html += '<div><p class="text-xs text-gray-500">Quote</p><p class="font-bold ' + (sQuote >= 70 ? 'text-green-600' : sQuote >= 40 ? 'text-orange-600' : 'text-red-600') + '">' + sQuote + '%</p></div>';
                html += '</div></div>';

                // Daily table
                html += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                html += '<thead><tr class="bg-gray-50 text-xs"><th class="py-2 px-3 text-left text-gray-500">Tag</th><th class="py-2 px-3 text-center text-gray-500">Plan</th><th class="py-2 px-3 text-center text-blue-600">Geplant</th><th class="py-2 px-3 text-center text-purple-600">Spontan</th><th class="py-2 px-3 text-center text-cyan-600">Online</th><th class="py-2 px-3 text-center text-pink-600">Ergo</th><th class="py-2 px-3 text-center font-bold text-gray-700">Gesamt</th><th class="py-2 px-3 text-center text-green-600">Verkauft</th><th class="py-2 px-3 text-center text-gray-500">Uebergabe</th><th class="py-2 px-3 text-right text-vit-orange">Umsatz</th></tr></thead>';
                html += '<tbody>';
                s.daily.forEach(function(d) {
                    var total = d.geplant + d.spontan + d.online + d.ergo;
                    var hasData = d.plan > 0 || total > 0 || d.umsatz > 0;
                    html += '<tr class="border-b ' + (hasData ? '' : 'text-gray-300') + '">';
                    html += '<td class="py-2 px-3 font-semibold">' + d.day + '</td>';
                    html += '<td class="py-2 px-3 text-center">' + (d.plan || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-blue-600">' + (d.geplant || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-purple-600">' + (d.spontan || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-cyan-600">' + (d.online || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-pink-600">' + (d.ergo || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center font-bold">' + (total || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-green-600 font-bold">' + (d.verkauft || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center">' + (d.uebergabe || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-right font-semibold ' + (d.umsatz > 0 ? 'text-vit-orange' : '') + '">' + (d.umsatz > 0 ? d.umsatz.toLocaleString('de-DE') + ' \u20AC' : '-') + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div></div>';
            });
            container.innerHTML = html;
        }

        function renderPipeline() {
            var filter = document.getElementById('pipelineFilter').value;
            var leads = filter === 'all' ? verkaufData.pipeline : verkaufData.pipeline.filter(function(l){return l.seller === filter;});
            var board = document.getElementById('kanbanBoard');
            var html = '';

            pipelineStages.forEach(function(stage) {
                var stageLeads = leads.filter(function(l){return l.stage === stage.id;});
                var stageValue = 0;
                stageLeads.forEach(function(l){stageValue += l.value;});

                html += '<div class="min-w-[220px] flex-shrink-0">';
                html += '<div class="mb-3 flex items-center justify-between">';
                html += '<h3 class="font-semibold text-gray-700 text-sm">' + stage.label + '</h3>';
                html += '<span class="text-xs font-bold bg-gray-200 text-gray-600 rounded-full px-2 py-0.5">' + stageLeads.length + '</span>';
                html += '</div>';
                html += '<div class="space-y-2 min-h-[100px] p-2 rounded-lg border-2 border-dashed ' + stage.color + '">';

                stageLeads.forEach(function(lead) {
                    html += '<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition">';
                    html += '<div class="flex items-center justify-between mb-1"><p class="font-semibold text-gray-800 text-sm">' + lead.name + '</p></div>';
                    html += '<p class="text-xs text-gray-500">' + lead.type + '</p>';
                    html += '<div class="flex items-center justify-between mt-2">';
                    html += '<span class="text-xs text-gray-400">' + lead.seller + ' Â· ' + lead.date + '</span>';
                    html += '<span class="text-sm font-bold text-vit-orange">' + lead.value.toLocaleString('de-DE') + ' \u20AC</span>';
                    html += '</div>';
                    // Stage move buttons
                    var stageIdx = -1;
                    for(var si=0;si<pipelineStages.length;si++){if(pipelineStages[si].id===lead.stage)stageIdx=si;}
                    html += '<div class="flex space-x-1 mt-2">';
                    if(stageIdx > 0) html += '<button onclick="moveLead('+lead.id+',\'' + pipelineStages[stageIdx-1].id + '\')" class="flex-1 text-xs py-1 bg-gray-100 rounded hover:bg-gray-200">&#9664;</button>';
                    if(stageIdx < pipelineStages.length-1) html += '<button onclick="moveLead('+lead.id+',\'' + pipelineStages[stageIdx+1].id + '\')" class="flex-1 text-xs py-1 bg-gray-100 rounded hover:bg-gray-200">&#9654;</button>';
                    html += '</div>';
                    html += '</div>';
                });

                if(stageLeads.length > 0) {
                    html += '<div class="text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-200">' + stageValue.toLocaleString('de-DE') + ' \u20AC</div>';
                }
                html += '</div></div>';
            });
            board.innerHTML = html;
        }

        function moveLead(id, newStage) {
            for(var i=0; i<verkaufData.pipeline.length; i++) {
                if(verkaufData.pipeline[i].id === id) {
                    verkaufData.pipeline[i].stage = newStage;
                    break;
                }
            }
            renderPipeline();
        }

        function showNewLeadModal() {
            document.getElementById('newLeadModal').classList.remove('hidden');
        }

        async function addNewLead() {
            var nameVal = document.getElementById('leadName').value || 'Neuer Kunde';
            var type = document.getElementById('leadType').value;
            var value = parseInt(document.getElementById('leadValue').value) || 3000;
            var notes = document.getElementById('leadNotes') ? document.getElementById('leadNotes').value : '';

            if(!sbUser) { alert('Nicht eingeloggt.'); return; }

            var nameParts = nameVal.trim().split(' ');
            var vorname = nameParts[0] || nameVal;
            var nachname = nameParts.slice(1).join(' ') || '';

            try {
                var resp = await sb.from('leads').insert({
                    standort_id: sbProfile.standort_id,
                    erstellt_von: sbUser.id,
                    vorname: vorname,
                    nachname: nachname,
                    interesse: type,
                    geschaetzter_wert: value,
                    notizen: notes,
                    status: 'neu',
                    quelle: 'walk_in',
                    prioritaet: 'mittel'
                });
                if(resp.error) throw resp.error;

                document.getElementById('newLeadModal').classList.add('hidden');
                document.getElementById('leadName').value = '';
                document.getElementById('leadValue').value = '';
                if(document.getElementById('leadNotes')) document.getElementById('leadNotes').value = '';
                await loadPipelineFromSupabase();
            } catch(err) {
                alert('Fehler: ' + err.message);
            }
        }

        function renderJahresTabelle() {
            var tbody = document.getElementById('jahresTabelle');
            if(!tbody) return;
            var html = '';
            var totals = {plan:0,ist:0,tSoll:0,tIst:0,vk:0};
            verkaufData.jahres.forEach(function(m, idx) {
                var diff = m.ist - m.plan;
                var isCurrent = (idx === 1);
                var isFuture = m.ist === 0 && idx > 1;
                totals.plan += m.plan; totals.ist += m.ist; totals.tSoll += m.termine_soll; totals.tIst += m.termine_ist; totals.vk += m.verkauft;
                html += '<tr class="border-b ' + (isCurrent ? 'bg-blue-50 border-l-4 border-blue-400' : '') + ' ' + (isFuture ? 'text-gray-400' : '') + '">';
                html += '<td class="py-2.5 px-3 font-semibold">' + m.monat + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + m.plan.toLocaleString('de-DE') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.ist > 0 ? m.ist.toLocaleString('de-DE') : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 ' + (diff > 0 ? 'text-green-600' : diff < 0 && !isFuture ? 'text-red-600' : '') + ' font-semibold">' + (m.ist > 0 ? (diff > 0 ? '+' : '') + diff.toLocaleString('de-DE') : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + m.termine_soll + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.termine_ist > 0 ? m.termine_ist : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 font-bold text-green-600">' + (m.verkauft > 0 ? m.verkauft : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 ' + (m.quote >= 70 ? 'text-green-600' : m.quote > 0 ? 'text-orange-600' : '') + '">' + (m.quote > 0 ? m.quote + '%' : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.avg > 0 ? m.avg.toLocaleString('de-DE') + ' \u20AC' : '\u2014') + '</td>';
                html += '</tr>';
            });
            // Totals
            var totalQuote = totals.tIst > 0 ? Math.round((totals.vk/totals.tIst)*100) : 0;
            html += '<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.plan.toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.ist.toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold text-red-600">' + (totals.ist - totals.plan).toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.tSoll + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.tIst + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold text-green-600">' + totals.vk + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totalQuote + '%</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + (totals.vk > 0 ? Math.round(totals.ist/totals.vk).toLocaleString('de-DE') + ' \u20AC' : '\u2014') + '</td>';
            html += '</tr>';
            tbody.innerHTML = html;
        }

        function showVerkaufTab(tabName) {
            document.querySelectorAll('.vk-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.vk-tab-btn').forEach(function(b){
                b.className='vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabId='vkTab'+tabName.charAt(0).toUpperCase()+tabName.slice(1);
            var el=document.getElementById(tabId);
            if(el) el.style.display='block';
            var btn=document.querySelector('.vk-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='woche') loadWeekFromDb();
            if(tabName==='pipeline') renderPipeline();
            if(tabName==='auswertung') renderJahresTabelle();
        }

        function changeWeek(dir) {
            if(!currentWeekStart) { currentWeekStart = getMonday(new Date()); }
            var d = new Date(currentWeekStart);
            d.setDate(d.getDate() + dir * 7);
            currentWeekStart = d;
            loadWeekFromDb();
        }
        function getMonday(d) { var day = d.getDay(); var diff = d.getDate() - day + (day === 0 ? -6 : 1); var m = new Date(d); m.setDate(diff); m.setHours(0,0,0,0); return m; }
        function getKW(d) { var t = new Date(d.getFullYear(), 0, 1); var dn = ((d - t) / 86400000); return Math.ceil((dn + t.getDay() + 1) / 7); }
        var currentWeekStart = null;
        var weekDbData = null;

        async function loadWeekFromDb() {
            if(!currentWeekStart) currentWeekStart = getMonday(new Date());
            var mon = currentWeekStart;
            var sun = new Date(mon); sun.setDate(mon.getDate() + 5); // Mo-Sa
            var monStr = mon.toISOString().slice(0,10);
            var sunStr = sun.toISOString().slice(0,10);
            // Update header
            var kw = getKW(mon);
            var fmt = function(d) { return d.getDate().toString().padStart(2,'0') + '.' + (d.getMonth()+1).toString().padStart(2,'0') + '.'; };
            var titleEl = document.getElementById('weekTitle');
            if(titleEl) titleEl.textContent = 'KW ' + kw + ' \u00B7 ' + fmt(mon) + ' - ' + fmt(sun) + sun.getFullYear();

            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var query = sb.from('verkauf_tracking').select('*').gte('datum', monStr).lte('datum', sunStr).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                weekDbData = resp.data || [];
            } catch(e) { weekDbData = []; console.warn('Week load error:', e); }
            renderWeekViewFromDb();
        }

        function renderWeekViewFromDb() {
            var data = weekDbData || [];
            var dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
            var weekDays = ['Mo','Di','Mi','Do','Fr','Sa'];
            // Group by seller
            var sellerMap = {};
            data.forEach(function(entry) {
                var name = entry.verkaeufer_name;
                if(!sellerMap[name]) sellerMap[name] = { name: name, plan_soll: 0, days: {} };
                weekDays.forEach(function(d) { if(!sellerMap[name].days[d]) sellerMap[name].days[d] = {day:d,plan:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}; });
                var d = new Date(entry.datum);
                var dayName = dayNames[d.getDay()];
                if(sellerMap[name].days[dayName]) {
                    var dd = sellerMap[name].days[dayName];
                    dd.plan += (entry.plan_termine || 0);
                    dd.geplant += (entry.geplant || 0);
                    dd.spontan += (entry.spontan || 0);
                    dd.online += (entry.online || 0);
                    dd.ergo += (entry.ergo || 0);
                    dd.verkauft += (entry.verkauft || 0);
                    dd.uebergabe += (entry.uebergabe || 0);
                    dd.umsatz += parseFloat(entry.umsatz) || 0;
                }
                sellerMap[name].plan_soll += (entry.plan_termine || 0);
            });
            var sellers = Object.values(sellerMap);
            // Update filter dropdown dynamically
            var filterEl = document.getElementById('weekSellerFilter');
            if(filterEl) {
                var curVal = filterEl.value;
                var opts = '<option value="all">Alle Verkaeufer</option>';
                sellers.forEach(function(s) { opts += '<option value="'+s.name+'"'+(s.name===curVal?' selected':'')+'>'+s.name+'</option>'; });
                filterEl.innerHTML = opts;
            }
            var filter = filterEl ? filterEl.value : 'all';
            var filtered = filter === 'all' ? sellers : sellers.filter(function(s){return s.name === filter;});

            // KPIs
            var totalPlan=0, totalGesamt=0, totalVerkauft=0, totalUmsatz=0;
            filtered.forEach(function(s) {
                totalPlan += s.plan_soll;
                weekDays.forEach(function(dn) {
                    var dd = s.days[dn];
                    if(dd) { totalGesamt += dd.geplant+dd.spontan+dd.online+dd.ergo; totalVerkauft += dd.verkauft; totalUmsatz += dd.umsatz; }
                });
            });
            var el;
            el = document.getElementById('wkPlan'); if(el) el.textContent = totalPlan;
            el = document.getElementById('wkGesamt'); if(el) el.textContent = totalGesamt;
            el = document.getElementById('wkVerkauft'); if(el) el.textContent = totalVerkauft;
            el = document.getElementById('wkUmsatz'); if(el) el.textContent = totalUmsatz.toLocaleString('de-DE') + ' \u20AC';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            el = document.getElementById('wkQuote');
            if(el) { el.textContent = quoteVal + '%'; el.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600'); }

            // Seller tables
            var container = document.getElementById('weekSellerTables');
            if(!container) return;
            if(filtered.length === 0) { container.innerHTML = '<div class="vit-card p-8 text-center text-gray-400"><p class="text-lg mb-2">'+t('sales_no_data')+'</p><p class="text-sm">'+t('sales_add_entry')+'</p></div>'; return; }
            var html = '';
            filtered.forEach(function(s) {
                var sUmsatz=0, sGesamt=0, sVerkauft=0;
                weekDays.forEach(function(dn) { var dd=s.days[dn]; if(dd) { sUmsatz+=dd.umsatz; sGesamt+=dd.geplant+dd.spontan+dd.online+dd.ergo; sVerkauft+=dd.verkauft; } });
                var sQuote = sGesamt > 0 ? Math.round((sVerkauft/sGesamt)*100) : 0;
                html += '<div class="vit-card overflow-hidden">';
                html += '<div class="flex items-center justify-between p-4 bg-gray-50 border-b">';
                html += '<div class="flex items-center space-x-3"><div class="w-8 h-8 bg-vit-orange rounded-full flex items-center justify-center text-white font-bold text-sm">'+s.name.charAt(0)+'</div>';
                html += '<div><p class="font-semibold text-gray-800">'+s.name+'</p><p class="text-xs text-gray-500">Plan: '+s.plan_soll+' Termine</p></div></div>';
                html += '<div class="flex space-x-4 text-center">';
                html += '<div><p class="text-xs text-gray-500">Beratungen</p><p class="font-bold text-blue-600">'+sGesamt+'</p></div>';
                html += '<div><p class="text-xs text-gray-500">Verkauft</p><p class="font-bold text-green-600">'+sVerkauft+'</p></div>';
                html += '<div><p class="text-xs text-gray-500">Umsatz</p><p class="font-bold text-vit-orange">'+sUmsatz.toLocaleString('de-DE')+' \u20AC</p></div>';
                html += '<div><p class="text-xs text-gray-500">Quote</p><p class="font-bold '+(sQuote>=70?'text-green-600':sQuote>=40?'text-orange-600':'text-red-600')+'">'+sQuote+'%</p></div>';
                html += '</div></div>';
                html += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                html += '<thead><tr class="bg-gray-50 text-xs"><th class="py-2 px-3 text-left text-gray-500">Tag</th><th class="py-2 px-3 text-center text-gray-500">Plan</th><th class="py-2 px-3 text-center text-blue-600">Geplant</th><th class="py-2 px-3 text-center text-purple-600">Spontan</th><th class="py-2 px-3 text-center text-cyan-600">Online</th><th class="py-2 px-3 text-center text-pink-600">Ergo</th><th class="py-2 px-3 text-center font-bold text-gray-700">Gesamt</th><th class="py-2 px-3 text-center text-green-600">Verkauft</th><th class="py-2 px-3 text-center text-gray-500">Uebergabe</th><th class="py-2 px-3 text-right text-vit-orange">Umsatz</th></tr></thead>';
                html += '<tbody>';
                weekDays.forEach(function(dn) {
                    var dd = s.days[dn] || {plan:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0};
                    var total = dd.geplant+dd.spontan+dd.online+dd.ergo;
                    var hasData = dd.plan>0 || total>0 || dd.umsatz>0;
                    html += '<tr class="border-b '+(hasData?'':'text-gray-300')+'">';
                    html += '<td class="py-2 px-3 font-semibold">'+dn+'</td>';
                    html += '<td class="py-2 px-3 text-center">'+(dd.plan||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-blue-600">'+(dd.geplant||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-purple-600">'+(dd.spontan||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-cyan-600">'+(dd.online||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-pink-600">'+(dd.ergo||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center font-bold">'+(total||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-green-600 font-bold">'+(dd.verkauft||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center">'+(dd.uebergabe||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-right font-semibold '+(dd.umsatz>0?'text-vit-orange':'')+'">'+(dd.umsatz>0?dd.umsatz.toLocaleString('de-DE')+' \u20AC':'-')+'</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div></div>';
            });
            container.innerHTML = html;
        }

        // === EINKAUF ===
        var lieferanten = [
            {name:'Kalkhoff / Derby Cycle',marken:['Kalkhoff','Rixe'],typ:'fahrrad',kontakt:'Sarah Mueller',email:'s.mueller@derbycycle.de',tel:'+49 5765 20-0',konditionen:'38% vom UVP, 3% Skonto 14 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://b2b.derbycycle.com',status:'aktiv',volumen:245000,anteil:22,logo:'bg-blue-600'},
            {name:'Winora Group / Haibike',marken:['Haibike','Winora','Sinus'],typ:'fahrrad',kontakt:'Thomas Weber',email:'t.weber@winora-group.de',tel:'+49 9725 71-0',konditionen:'36% vom UVP, 2% Skonto 10 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://b2b.winora-group.de',status:'aktiv',volumen:198000,anteil:18,logo:'bg-red-600'},
            {name:'Simplon Fahrrad GmbH',marken:['Simplon'],typ:'fahrrad',kontakt:'Markus Huber',email:'m.huber@simplon.com',tel:'+43 5574 6722-0',konditionen:'40% vom UVP, netto 30 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://dealer.simplon.com',status:'aktiv',volumen:165000,anteil:15,logo:'bg-gray-800'},
            {name:'Orbea S.Coop.',marken:['Orbea'],typ:'fahrrad',kontakt:'Carlos Garcia',email:'c.garcia@orbea.com',tel:'+34 943 882 488',konditionen:'37% vom UVP, netto 30 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://b2b.orbea.com',status:'aktiv',volumen:142000,anteil:13,logo:'bg-orange-600'},
            {name:'Stevens Vertriebs GmbH',marken:['Stevens'],typ:'fahrrad',kontakt:'Petra Schulz',email:'p.schulz@stevensbikes.de',tel:'+49 40 6896 20-0',konditionen:'35% vom UVP, 2% Skonto 14 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://dealer.stevensbikes.de',status:'aktiv',volumen:88000,anteil:8,logo:'bg-green-700'},
            {name:'Babboe B.V.',marken:['Babboe'],typ:'fahrrad',kontakt:'Jan de Vries',email:'j.devries@babboe.de',tel:'+31 78 684 56 00',konditionen:'32% vom UVP, netto 30 Tage',rahmenvertrag:'bis 31.12.2026',portal:'https://dealer.babboe.com',status:'aktiv',volumen:52000,anteil:5,logo:'bg-yellow-500'},
            {name:'Riese & Mueller (NEU)',marken:['Riese & Mueller'],typ:'fahrrad',kontakt:'Wird zugeteilt',email:'dealer@r-m.de',tel:'+49 6151 366 86-0',konditionen:'In Verhandlung',rahmenvertrag:'Ab 01.03.2026',portal:'https://b2b.r-m.de',status:'neu',volumen:0,anteil:0,logo:'bg-purple-600'},
            {name:'Shimano Europe',marken:['Shimano','Steps','Deore','XT','SLX'],typ:'teile',kontakt:'Key Account DACH',email:'dealer-dach@shimano.eu',tel:'+49 211 13 06-0',konditionen:'Staffelpreise, netto 30 Tage',rahmenvertrag:'Netzwerkvertrag',portal:'https://b2b.shimano-eu.com',status:'aktiv',volumen:67000,anteil:6,logo:'bg-gray-600'},
            {name:'Bosch eBike Systems',marken:['Bosch','PowerTube','Kiox'],typ:'teile',kontakt:'Partner Service',email:'service@bosch-ebike.de',tel:'+49 711 400 40-990',konditionen:'UVP-gebunden, Bonus 2%',rahmenvertrag:'Netzwerkvertrag',portal:'https://www.bosch-ebike.com/de/haendler',status:'aktiv',volumen:45000,anteil:4,logo:'bg-red-700'},
            {name:'SRAM Europe',marken:['SRAM','RockShox','Avid','Zipp'],typ:'teile',kontakt:'Dealer Support',email:'dealersupport@sram.com',tel:'+49 9721 6571-0',konditionen:'Staffelpreise, netto 30 Tage',rahmenvertrag:'Netzwerkvertrag',portal:'https://b2b.sram.com',status:'aktiv',volumen:28000,anteil:3,logo:'bg-black'},
            {name:'Schwalbe / Ralf Bohle',marken:['Schwalbe','Marathon','Energizer'],typ:'teile',kontakt:'Innenservice',email:'info@schwalbe.de',tel:'+49 2191 946-0',konditionen:'35% vom UVP, netto 14 Tage',rahmenvertrag:'Netzwerkvertrag',portal:'https://b2b.schwalbe.com',status:'aktiv',volumen:12000,anteil:1,logo:'bg-blue-800'},
            {name:'HNF Nicolai (Ausgelistet)',marken:['HNF Nicolai'],typ:'fahrrad',kontakt:'â€”',email:'â€”',tel:'â€”',konditionen:'Vertrag ausgelaufen',rahmenvertrag:'Beendet 31.12.2025',portal:'â€”',status:'inaktiv',volumen:21500,anteil:0,logo:'bg-gray-400'},
            {name:'Husqvarna Bicycles (Ausgelistet)',marken:['Husqvarna'],typ:'fahrrad',kontakt:'â€”',email:'â€”',tel:'â€”',konditionen:'Marke eingestellt',rahmenvertrag:'Beendet 2025',portal:'â€”',status:'inaktiv',volumen:14000,anteil:0,logo:'bg-gray-400'},
        ];

        var liefFilterTyp = 'all';
        var liefFilterStatus = 'all';

        var ekMargen = [
            {marke:'Simplon',marge:42.1,color:'bg-green-500'},
            {marke:'Orbea',marge:39.8,color:'bg-green-500'},
            {marke:'Kalkhoff',marge:38.5,color:'bg-green-500'},
            {marke:'Haibike',marge:37.2,color:'bg-green-400'},
            {marke:'Stevens',marge:35.8,color:'bg-yellow-500'},
            {marke:'Babboe',marge:33.0,color:'bg-orange-500'},
        ];

        var ekTopModelle = [
            {name:'Kalkhoff Endeavour 5.B Move+',stueck:3,umsatz:14280},
            {name:'Simplon Kagu Bosch 275',stueck:2,umsatz:9798},
            {name:'Haibike Trekking 7',stueck:2,umsatz:7990},
            {name:'Orbea Gain D30 1x',stueck:2,umsatz:7198},
            {name:'Stevens E-Triton Forma',stueck:1,umsatz:3799},
        ];

        var ekFlopModelle = [
            {name:'Babboe City Mountain',tage:128,ek:2890,grund:'Saisonware, Herbst-Rest'},
            {name:'Stevens Jazz Lite',tage:104,ek:1249,grund:'Wenig Nachfrage Trekking analog'},
            {name:'Haibike HardSeven 1',tage:96,ek:899,grund:'Auslaufmodell 2025'},
        ];

        function renderLieferanten() {
            var filtered = lieferanten.filter(function(l) {
                if(liefFilterTyp !== 'all' && l.typ !== liefFilterTyp) return false;
                if(liefFilterStatus !== 'all' && l.status !== liefFilterStatus) return false;
                return true;
            });
            var q = (document.getElementById('liefSearch').value || '').toLowerCase();
            if(q) filtered = filtered.filter(function(l){ return (l.name + ' ' + l.marken.join(' ')).toLowerCase().indexOf(q) >= 0; });

            if(filtered.length === 0) {
                document.getElementById('lieferantenGrid').innerHTML = '<div class="col-span-full vit-card p-8 text-center text-gray-400"><p class="text-lg mb-1">Keine Lieferanten gefunden</p><p class="text-sm">Filter anpassen oder Suche aendern</p></div>';
                return;
            }
            var html = '';
            filtered.forEach(function(l) {
                var opacity = l.status === 'inaktiv' ? ' opacity-60' : '';
                html += '<div class="lief-card vit-card p-5 hover:shadow-lg transition' + opacity + '">';
                html += '<div class="flex items-start justify-between mb-3">';
                html += '<div class="flex items-center space-x-3"><div class="w-10 h-10 ' + l.logo + ' rounded-lg flex items-center justify-center text-white font-bold text-xs">' + l.name.charAt(0) + '</div>';
                html += '<div><h3 class="font-bold text-gray-800">' + l.name + '</h3>';
                html += '<p class="text-xs text-gray-500">' + l.marken.join(', ') + '</p></div></div>';
                html += '<div class="flex flex-col items-end space-y-1">';
                if(l.status==='neu') html += '<span class="text-xs font-bold bg-purple-100 text-purple-700 rounded-full px-2 py-0.5">NEU</span>';
                else if(l.status==='inaktiv') html += '<span class="text-xs font-bold bg-gray-200 text-gray-500 rounded-full px-2 py-0.5">Inaktiv</span>';
                else html += '<span class="text-xs font-bold bg-green-100 text-green-700 rounded-full px-2 py-0.5">Aktiv</span>';
                html += '<span class="text-xs rounded-full px-2 py-0.5 ' + (l.typ==='fahrrad' ? 'bg-blue-50 text-blue-600' : 'bg-amber-50 text-amber-700') + '">' + (l.typ==='fahrrad' ? 'ðŸš² Fahrrad' : 'ðŸ”§ Teile') + '</span>';
                html += '</div></div>';
                html += '<div class="space-y-1.5 text-xs text-gray-600 mb-3">';
                html += '<div class="flex justify-between"><span class="text-gray-400">Ansprechpartner:</span><span class="font-semibold">' + l.kontakt + '</span></div>';
                html += '<div class="flex justify-between"><span class="text-gray-400">Konditionen:</span><span class="font-semibold">' + l.konditionen + '</span></div>';
                html += '<div class="flex justify-between"><span class="text-gray-400">Rahmenvertrag:</span><span>' + l.rahmenvertrag + '</span></div>';
                if(l.volumen > 0) html += '<div class="flex justify-between"><span class="text-gray-400">Volumen 2025:</span><span class="font-semibold">' + l.volumen.toLocaleString('de-DE') + ' â‚¬' + (l.anteil > 0 ? ' (' + l.anteil + '%)' : '') + '</span></div>';
                html += '</div>';
                if(l.status !== 'inaktiv') {
                    html += '<div class="flex items-center space-x-2 pt-3 border-t border-gray-100">';
                    html += '<a href="mailto:' + l.email + '" class="flex-1 text-center px-2 py-1.5 text-xs font-semibold border border-gray-300 rounded-lg hover:bg-gray-50">E-Mail</a>';
                    html += '<a href="' + l.portal + '" target="_blank" class="flex-1 text-center px-2 py-1.5 text-xs font-semibold bg-vit-orange text-white rounded-lg hover:opacity-90">B2B-Portal</a>';
                    html += '</div>';
                }
                html += '</div>';
            });
            document.getElementById('lieferantenGrid').innerHTML = html;
        }

        function filterLieferanten() { renderLieferanten(); }

        function toggleLiefFilter(group, val) {
            if(group === 'typ') {
                liefFilterTyp = val;
                document.querySelectorAll('.lief-typ-btn').forEach(function(b){ b.className = 'lief-typ-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200'; });
                var btn = document.querySelector('.lief-typ-btn[data-typ="'+val+'"]');
                if(btn) btn.className = 'lief-typ-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            } else {
                liefFilterStatus = val;
                document.querySelectorAll('.lief-status-btn').forEach(function(b){ b.className = 'lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200'; });
                var btn2 = document.querySelector('.lief-status-btn[data-st="'+val+'"]');
                if(btn2) btn2.className = 'lief-status-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            }
            renderLieferanten();
        }

        function renderEkAuswertung() {
            // Margen
            var html = '';
            ekMargen.forEach(function(m) {
                html += '<div class="flex items-center space-x-3">';
                html += '<span class="w-20 text-sm font-semibold text-gray-700">' + m.marke + '</span>';
                html += '<div class="flex-1 bg-gray-200 rounded-full h-4"><div class="' + m.color + ' h-4 rounded-full flex items-center justify-end pr-2" style="width:' + (m.marge/50*100) + '%"><span class="text-xs text-white font-bold">' + m.marge + '%</span></div></div>';
                html += '</div>';
            });
            document.getElementById('ekMargenList').innerHTML = html;

            // Top Modelle
            html = '';
            ekTopModelle.forEach(function(m,i) {
                html += '<div class="flex items-center justify-between py-2 ' + (i<4?'border-b border-gray-100':'') + '">';
                html += '<div class="flex items-center space-x-2"><span class="text-sm font-bold text-green-600">' + (i+1) + '.</span><span class="text-sm text-gray-800">' + m.name + '</span></div>';
                html += '<div class="text-right"><span class="text-sm font-bold text-gray-800">' + m.stueck + 'x</span><span class="text-xs text-gray-400 ml-2">' + m.umsatz.toLocaleString('de-DE') + ' â‚¬</span></div>';
                html += '</div>';
            });
            document.getElementById('ekTopModelle').innerHTML = html;

            // Flop Modelle
            html = '';
            ekFlopModelle.forEach(function(m,i) {
                html += '<div class="flex items-center justify-between py-2 ' + (i<2?'border-b border-gray-100':'') + '">';
                html += '<div><span class="text-sm text-gray-800">' + m.name + '</span><span class="text-xs text-red-500 ml-2">' + m.tage + ' Tage</span></div>';
                html += '<div class="text-right"><span class="text-xs text-gray-400">EK: ' + m.ek + ' â‚¬</span></div>';
                html += '</div>';
            });
            document.getElementById('ekFlopModelle').innerHTML = html;
        }

        function showEinkaufTab(tabName) {
            document.querySelectorAll('.ek-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.ek-tab-btn').forEach(function(b){
                b.className='ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {lieferanten:'Lieferanten',auswertung:'Auswertung',ekStrategie:'EkStrategie',ekWissen:'EkWissen'};
            var el = document.getElementById('ekTab' + (tabMap[tabName]||''));
            if(el) el.style.display = 'block';
            var btn = document.querySelector('.ek-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='lieferanten') renderLieferanten();
            if(tabName==='auswertung') renderEkAuswertung();
        }

        // Init Einkauf
        renderLieferanten();

        // === KOMMUNIKATION: Inbox, Ankuendigungen, Brett, Termine ===
        var inboxMessages = [
            {id:1,from:'Lisa Berger (Einkauf)',avatar:'LB',color:'bg-emerald-500',subject:'Kalkhoff Vororder â€“ Sonderkonditionen fuer Grafrath',preview:'Hallo Sandra, ich hab fuer euch nochmal 3% Extra auf die Kalkhoff Endeavour Serie rausgeholt. Bitte bis 20.02. bestaetigen...',date:'14.02.2026 09:30',unread:true,sent:false},
            {id:2,from:'Jan Krause (Marketing)',avatar:'JK',color:'bg-blue-500',subject:'Freigabe Fruehjahrs-Schaufenster',preview:'Die Schaufenster-Deko fuer Maerz muss bis 25.02. bestellt werden. Anbei die Vorlage und Bestellliste. Bitte kurz bestaetigen...',date:'13.02.2026 16:10',unread:true,sent:false},
            {id:3,from:'Support / IT',avatar:'IT',color:'bg-gray-500',subject:'Kassensystem-Update am 18.02. ab 20 Uhr',preview:'Am Dienstag wird das Kassensystem aktualisiert. Bitte alle Tagesabschluesse vor 20 Uhr machen. Downtime ca. 2 Stunden...',date:'13.02.2026 11:45',unread:true,sent:false},
            {id:4,from:'Michael Frey (GF)',avatar:'MF',color:'bg-vit-orange',subject:'Re: Personalplanung Saison 2026',preview:'Danke fuer die Rueckmeldung Sandra. Die Aushilfe ab April ist genehmigt. Bitte Stellenanzeige ueber HR abstimmen...',date:'12.02.2026 14:20',unread:false,sent:false},
            {id:5,from:'Lisa Berger (Einkauf)',avatar:'LB',color:'bg-emerald-500',subject:'Re: Orbea Lieferverzoegerung',preview:'Update: Die Orbea-Lieferung KW 8 verschiebt sich auf KW 10. Betrifft 4 Raeder fuer Grafrath. Sorry, liegt am Zoll...',date:'11.02.2026 10:05',unread:false,sent:false},
            {id:6,from:'Du an Lisa Berger',avatar:'SG',color:'bg-blue-300',subject:'Orbea Lieferverzoegerung â€“ 2 Kunden warten',preview:'Hallo Lisa, bei uns warten 2 Kunden auf ihren Orbea Gain. Kannst du mal nachfragen wann die genau kommen?',date:'10.02.2026 16:30',unread:false,sent:true},
            {id:7,from:'Du an Support / IT',avatar:'SG',color:'bg-blue-300',subject:'Drucker im Buero druckt nicht mehr',preview:'Seit Montag druckt der Brother im Buero nicht mehr. Fehlermeldung: Toner leer. Brauchen wir neuen Toner oder neuen Drucker?',date:'08.02.2026 09:15',unread:false,sent:true},
        ];

        var announcements = [
            {id:1,title:'Neue Marke ab Maerz: Riese & Mueller',body:'Wir freuen uns, Riese & Mueller ab Saison 2026 ins Sortiment aufzunehmen! Preislisten und Schulungstermine folgen naechste Woche. Bitte meldet euer Interesse an der Erstbestuckung bis 28.02.',date:'14.02.2026',category:'Sortiment',icon:'ðŸš²',important:true,readBy:8,totalPartners:21},
            {id:2,title:'Preisanpassung Shimano Ersatzteile ab 01.03.',body:'Shimano hat eine Preiserhoehung von durchschnittlich 4.5% auf Ersatzteile angekuendigt (Steps-Motoren, Schaltgruppen, Bremsbelaege). Die neuen Preislisten sind im Einkaufsbereich hinterlegt. Bitte Lagerbestaende pruefen und ggf. vorbestellen.',date:'12.02.2026',category:'Preise',icon:'ðŸ’°',important:true,readBy:15,totalPartners:21},
            {id:3,title:'Kampagnenstart: Fruehjahrs-Aktion 2026',body:'Ab 01.03. startet unsere Fruehjahrs-Kampagne "Dein Fruehling faehrt vit:bikes". Alle Materialien (Flyer, Plakate, Social-Media-Posts, Schaufenster-Deko) sind im Marketing-Bereich zum Download bereit. Bitte bis 25.02. bestellen.',date:'10.02.2026',category:'Marketing',icon:'ðŸ“£',important:false,readBy:19,totalPartners:21},
            {id:4,title:'Schulung: Bosch Smart System am 18.02.',body:'Online-Schulung zum neuen Bosch Smart System (Diagnose, Firmware, Fehlercodes) am 18.02. um 18:00 Uhr via Teams. Anmeldung ueber den Termine-Tab. Pflicht fuer alle Werkstatt-Mitarbeiter.',date:'07.02.2026',category:'Schulung',icon:'ðŸŽ“',important:false,readBy:21,totalPartners:21},
            {id:5,title:'Partner-Meeting Q1 am 28.02. in Muenchen',body:'Das Q1-Partnermeeting findet am 28.02. im Hotel & Wirtshaus Post in Muenchen statt. Agenda: Jahresrueckblick, Sortimentsstrategie 2026, Marketing-Roadmap, offene Runde. Anmeldung bis 20.02.',date:'05.02.2026',category:'Event',icon:'ðŸ“…',important:false,readBy:18,totalPartners:21},
            {id:6,title:'IT: Neues Portal-Feature â€“ Verkaufsmodul live!',body:'Ab sofort ist das neue Verkaufsmodul mit Wochenansicht, Pipeline und Auswertung im Portal verfuegbar. Es ersetzt die Excel-Erfolgstabelle. Bitte testet es und gebt Feedback ueber den Support.',date:'01.02.2026',category:'IT/Portal',icon:'ðŸ’»',important:false,readBy:21,totalPartners:21},
        ];

        var brettPosts = [
            {id:1,cat:'suche',author:'Thomas (Grafrath)',avatar:'TG',color:'bg-green-500',title:'Kalkhoff Endeavour 5.B Move+ L/Diamant gesucht',body:'Kunde braucht es dringend, bei uns erst KW 12. Standort-Transfer moeglich. Bitte melden!',date:'12.02.2026',replies:3,urgent:true},
            {id:2,cat:'biete',author:'Stefan (Karlsfeld)',avatar:'SK',color:'bg-blue-500',title:'2x Orbea Gain D30 in M/S abzugeben',body:'Vorjahresmodell, nagelneu verpackt. Wuerde Selbstkostenpreis machen. Standort-Transfer oder Abholung.',date:'13.02.2026',replies:5,urgent:false},
            {id:3,cat:'biete',author:'Julia (Muenchen Ost)',avatar:'JM',color:'bg-purple-500',title:'Shimano Steps E6100 Motor (Austausch)',body:'Haben einen neuen E6100 Motor uebrig aus Garantiefall. Originalverpackt. VB 480 EUR netto.',date:'11.02.2026',replies:2,urgent:false},
            {id:4,cat:'suche',author:'Markus (Hanau)',avatar:'MH',color:'bg-red-500',title:'Bosch PowerTube 750 horizontal gesucht',body:'Fuer Kundenrad, Bosch liefert erst KW 14. Hat jemand einen auf Lager?',date:'10.02.2026',replies:1,urgent:true},
            {id:5,cat:'frage',author:'Anna (Starnberg)',avatar:'AS',color:'bg-pink-500',title:'Erfahrung mit neuem Kassensystem-Update?',body:'Hat schon jemand das Update installiert? Letzes Mal hatten wir Probleme mit dem EC-Terminal. Will vorbereitet sein.',date:'09.02.2026',replies:7,urgent:false},
            {id:6,cat:'tipp',author:'Dirk (Grafrath)',avatar:'DG',color:'bg-cyan-500',title:'Genialer Montagestaender-Hack',body:'Wer den Feedback Sports Pro Ultra hat: mit einem 3D-gedruckten Adapter passt auch der Bosch CX Gen5 Rahmen rein. STL-Datei kann ich teilen.',date:'08.02.2026',replies:12,urgent:false},
            {id:7,cat:'suche',author:'Petra (Augsburg)',avatar:'PA',color:'bg-yellow-600',title:'Aushilfe fuer Saison gesucht â€“ Erfahrungen?',body:'Wir suchen eine Verkaufs-Aushilfe fuer April-August. Hat jemand Tipps wo man gute Leute findet? Indeed war bei uns bisher Fehlanzeige.',date:'07.02.2026',replies:9,urgent:false},
            {id:8,cat:'biete',author:'Thomas (Grafrath)',avatar:'TG',color:'bg-green-500',title:'Messestand-Material abzugeben',body:'Haben noch 2 Roll-ups und 1 Theke vom letzten Hausmesse-Event. Guter Zustand, gegen Abholung kostenlos.',date:'05.02.2026',replies:4,urgent:false},
        ];

        var termine = [
            {id:1,date:'14.02.2026',time:'Heute',title:'Vororder-Konditionen pruefen',desc:'Sonderkonditionen von Lisa fuer Kalkhoff bestaetigen',type:'deadline',color:'bg-red-500',past:false},
            {id:2,date:'18.02.2026',time:'Di Â· 18:00 â€“ 19:30',title:'Online-Schulung: Bosch Smart System',desc:'Pflicht fuer Werkstatt. Diagnose, Firmware-Updates, Fehlercodes. Via Microsoft Teams.',type:'schulung',color:'bg-blue-500',past:false},
            {id:3,date:'20.02.2026',time:'Do',title:'Deadline: Kalkhoff Vororder H/W 2026',desc:'Bestellformular an Lisa Berger (Einkauf) senden.',type:'deadline',color:'bg-red-500',past:false},
            {id:4,date:'25.02.2026',time:'Mi',title:'Deadline: Fruehjahrs-Schaufenster bestellen',desc:'Deko-Material und Plakate ueber Marketing-Portal bestellen.',type:'deadline',color:'bg-red-500',past:false},
            {id:5,date:'27.02.2026',time:'Fr Â· 10:00 â€“ 11:00',title:'Standort-Call mit Michael Frey',desc:'Monatlicher 1:1 Call mit GF. Themen: Personalplanung, Q1-Performance, Saisonvorbereitung.',type:'meeting',color:'bg-blue-500',past:false},
            {id:6,date:'28.02.2026',time:'Sa Â· 10:00 â€“ 17:00',title:'Partner-Meeting Q1 â€“ Muenchen',desc:'Hotel & Wirtshaus Post, Muenchen. Jahresrueckblick, Sortiment 2026, Marketing-Roadmap. Mittagessen inklusive.',type:'event',color:'bg-green-500',past:false},
            {id:7,date:'28.02.2026',time:'Sa',title:'Deadline: Vororder komplett H/W 2026',desc:'Letzte Moeglichkeit fuer alle H/W Vororders mit Fruehbucher-Konditionen.',type:'deadline',color:'bg-red-500',past:false},
            {id:8,date:'01.03.2026',time:'So',title:'Kampagnenstart: Fruehjahrs-Aktion',desc:'Flyer, Plakate, Schaufenster muessen stehen. Social-Media-Posts starten automatisch.',type:'event',color:'bg-green-500',past:false},
            {id:9,date:'12.03.2026',time:'Do Â· 18:00 â€“ 19:00',title:'Online-Schulung: Riese & Mueller Sortiment',desc:'Einfuehrung neue Marke. Modelle, USPs, Zielgruppen, Preise.',type:'schulung',color:'bg-blue-500',past:false},
            {id:10,date:'18.03.2026',time:'Mi Â· 09:00 â€“ 18:00',title:'Hausmesse Grafrath',desc:'Eigene Hausmesse am Standort. Probefahrten, Fruehjahrs-Angebote, Leasing-Beratung.',type:'event',color:'bg-green-500',past:false},
        ];

        function renderInbox(filter) {
            var msgs = inboxMessages;
            if(filter==='unread') msgs = msgs.filter(function(m){return m.unread;});
            if(filter==='sent') msgs = msgs.filter(function(m){return m.sent;});
            var html = '';
            msgs.forEach(function(m) {
                html += '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer ' + (m.unread ? 'border-l-4 border-vit-orange bg-orange-50' : '') + '">';
                html += '<div class="flex items-start space-x-3">';
                html += '<div class="w-10 h-10 ' + m.color + ' rounded-full flex items-center justify-center text-white font-bold text-xs flex-shrink-0">' + m.avatar + '</div>';
                html += '<div class="flex-1 min-w-0">';
                html += '<div class="flex items-center justify-between mb-0.5"><span class="font-semibold text-gray-800 text-sm">' + m.from + '</span><span class="text-xs text-gray-400 flex-shrink-0 ml-2">' + m.date + '</span></div>';
                html += '<p class="font-semibold text-gray-800 text-sm ' + (m.unread ? '' : 'font-normal') + '">' + m.subject + '</p>';
                html += '<p class="text-xs text-gray-500 truncate mt-0.5">' + m.preview + '</p>';
                html += '</div>';
                if(m.unread) html += '<span class="w-2.5 h-2.5 bg-vit-orange rounded-full flex-shrink-0 mt-2"></span>';
                html += '</div></div>';
            });
            document.getElementById('inboxList').innerHTML = html;
        }

        function filterInbox(f) {
            document.querySelectorAll('.inbox-filter-btn').forEach(function(b){b.className='inbox-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.inbox-filter-btn[data-f="'+f+'"]');
            if(btn) btn.className='inbox-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderInbox(f);
        }

        function sendInboxMsg() {
            var compose = document.getElementById('inboxCompose');
            var inputs = compose.querySelectorAll('input[type=text], textarea, select');
            var to = inputs[0] ? inputs[0].options[inputs[0].selectedIndex].text : 'Zentrale';
            var subject = inputs[1] ? inputs[1].value : '';
            var body = inputs[2] ? inputs[2].value : '';
            if(!subject && !body) { alert('Bitte Betreff oder Nachricht eingeben.'); return; }
            inboxMessages.unshift({
                id: inboxMessages.length+1,
                from: 'Du',
                subject: subject || '(Kein Betreff)',
                preview: body.substring(0,80) || '',
                date: 'Gerade',
                read: true,
                folder: 'sent',
                icon: 'ðŸ“¤'
            });
            if(inputs[1]) inputs[1].value = '';
            if(inputs[2]) inputs[2].value = '';
            compose.classList.add('hidden');
            filterInbox('sent');
        }

        async function renderAnnouncements() {
            var container = document.getElementById('announceList');
            if(!container) return;
            var isHQ = sbProfile && sbProfile.is_hq;
            try {
                var resp = await sb.from('ankuendigungen').select('*, users(name)').order('created_at', {ascending:false});
                if(resp.error) throw resp.error;
                var anns = resp.data || [];
                var html = '';
                var icons = {news:'\uD83D\uDCE2',event:'\uD83D\uDCC5',schulung:'\uD83C\uDF93',marketing:'\uD83D\uDCE3',sortiment:'\uD83D\uDEB2',preise:'\uD83D\uDCB0',it:'\uD83D\uDCBB'};
                anns.forEach(function(a) {
                    var d = new Date(a.created_at);
                    var dateStr = d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});
                    html += '<div class="vit-card p-5 ' + (a.wichtig ? 'border-l-4 border-vit-orange' : '') + '">';
                    html += '<div class="flex items-start space-x-4">';
                    html += '<div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">' + (icons[a.kategorie]||'\uD83D\uDCE2') + '</div>';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center justify-between">';
                    html += '<div class="flex items-center space-x-2 mb-1">';
                    if(a.wichtig) html += '<span class="text-xs font-bold bg-red-100 text-red-600 rounded px-2 py-0.5">Wichtig</span>';
                    html += '<span class="text-xs text-gray-400">' + dateStr + '</span>';
                    if(a.users&&a.users.name) html += '<span class="text-xs text-gray-400">\u00B7 '+a.users.name+'</span>';
                    html += '</div>';
                    if(isHQ) {
                        html += '<div class="flex space-x-1">';
                        html += '<button onclick="editAnkuendigung(\''+a.id+'\',\''+a.titel.replace(/'/g,"\\\'")+'\',\''+a.kategorie+'\','+a.wichtig+')" class="text-xs px-2 py-1 text-gray-400 hover:text-blue-600" title="Bearbeiten">\u270F\uFE0F</button>';
                        html += '<button onclick="deleteAnkuendigung(\''+a.id+'\')" class="text-xs px-2 py-1 text-gray-400 hover:text-red-600" title="L\u00f6schen">\uD83D\uDDD1\uFE0F</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '<h3 class="font-bold text-gray-800 mb-2">' + a.titel + '</h3>';
                    html += '<p class="text-sm text-gray-600">' + a.inhalt + '</p>';
                    html += '</div></div></div>';
                });
                if(anns.length===0) html = '<div class="text-center py-8 text-gray-400">Keine Ank\u00fcndigungen.</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Ank\u00fcndigungen:', err); }
        }

        async function deleteAnkuendigung(id) {
            if(!confirm('Ankuendigung wirklich loeschen?')) return;
            try {
                var resp = await sb.from('ankuendigungen').delete().eq('id', id);
                if(resp.error) throw resp.error;
                renderAnnouncements();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        function editAnkuendigung(id, titel, kategorie, wichtig) {
            openAnkuendigungModal();
            // Prefill nach kurzem Timeout damit Modal da ist
            setTimeout(function() {
                var t = document.getElementById('ankTitel'); if(t) t.value = titel;
                var k = document.getElementById('ankKat'); if(k) k.value = kategorie;
                var w = document.getElementById('ankWichtig'); if(w) w.checked = wichtig;
                // Change save button to update mode
                var btn = document.getElementById('ankSaveBtn');
                if(btn) { btn.textContent = 'Aktualisieren'; btn.onclick = function() { updateAnkuendigung(id); }; }
            }, 100);
        }

        async function updateAnkuendigung(id) {
            var titel = (document.getElementById('ankTitel')||{}).value;
            var inhalt = (document.getElementById('ankInhalt')||{}).value;
            var kategorie = (document.getElementById('ankKat')||{}).value || 'news';
            var wichtig = (document.getElementById('ankWichtig')||{}).checked || false;
            if(!titel||!titel.trim()||!inhalt||!inhalt.trim()) { alert('Bitte Titel und Inhalt ausfuellen.'); return; }
            try {
                var resp = await sb.from('ankuendigungen').update({titel:titel.trim(),inhalt:inhalt.trim(),kategorie:kategorie,wichtig:wichtig}).eq('id',id);
                if(resp.error) throw resp.error;
                closeAnkModal();
                alert('\u2705 Ankuendigung aktualisiert!');
                renderAnnouncements();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function renderBrett(cat) {
            var container = document.getElementById('brettPosts');
            if(!container) return;
            try {
                var query = sb.from('brett_eintraege').select('*, users(name)').eq('aktiv', true).order('created_at', {ascending:false});
                if(cat && cat !== 'all') query = query.eq('kategorie', cat);
                var resp = await query;
                if(resp.error) throw resp.error;
                var posts = resp.data || [];
                var html = '';
                var catColors = {suche:'bg-red-100 text-red-700 border-red-200',biete:'bg-green-100 text-green-700 border-green-200',frage:'bg-blue-100 text-blue-700 border-blue-200',tipp:'bg-yellow-100 text-yellow-700 border-yellow-200',allgemein:'bg-gray-100 text-gray-700 border-gray-200'};
                var catLabels = {suche:'ðŸ” Gesucht',biete:'ðŸ·ï¸ Biete',frage:'â“ Frage',tipp:'ðŸ’¡ Tipp',allgemein:'ðŸ“Œ Allgemein'};
                posts.forEach(function(p) {
                    var authorName = p.users ? p.users.name : 'Unbekannt';
                    var initials = authorName.split(' ').map(function(n){return n[0]}).join('').substring(0,2);
                    var colors = ['bg-green-500','bg-blue-500','bg-purple-500','bg-red-500','bg-pink-500','bg-cyan-500'];
                    var ci = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0)},0) % colors.length;
                    var d = new Date(p.created_at);
                    html += '<div class="vit-card p-5 hover:shadow-md transition">';
                    html += '<div class="flex items-center space-x-2 mb-2"><span class="text-xs font-bold rounded-full px-2.5 py-1 border ' + (catColors[p.kategorie]||catColors.allgemein) + '">' + (catLabels[p.kategorie]||p.kategorie) + '</span></div>';
                    html += '<h3 class="font-bold text-gray-800 mb-1">' + p.titel + '</h3>';
                    html += '<p class="text-sm text-gray-600 mb-3">' + (p.beschreibung||'') + '</p>';
                    html += '<div class="flex items-center space-x-3 text-xs text-gray-400">';
                    html += '<div class="flex items-center space-x-1"><div class="w-5 h-5 ' + colors[ci] + ' rounded-full flex items-center justify-center text-white text-[10px] font-bold">' + initials + '</div><span>' + authorName + '</span></div>';
                    html += '<span>' + d.toLocaleDateString('de-DE') + '</span></div></div>';
                });
                if(posts.length===0) html = '<div class="col-span-2 text-center py-8 text-gray-400">Keine EintrÃ¤ge.</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Brett:', err); }
        }

        function filterBrett(cat) {
            document.querySelectorAll('.brett-cat-btn').forEach(function(b){b.className='brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.brett-cat-btn[data-bc="'+cat+'"]');
            if(btn) btn.className='brett-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderBrett(cat);
        }

        async function renderTermine() {
            var container = document.getElementById('termineList');
            if(!container) return;
            try {
                var resp = await sb.from('termine').select('*').gte('start_zeit', new Date().toISOString().split('T')[0]).order('start_zeit', {ascending:true}).limit(15);
                if(resp.error) throw resp.error;
                var terms = resp.data || [];
                var html = '';
                var typeLabels = {termin:'ðŸ“‹',meeting:'ðŸ‘¥',schulung:'ðŸŽ“',event:'ðŸŽ‰',deadline:'â°',probefahrt:'ðŸš²'};
                terms.forEach(function(t) {
                    var d = new Date(t.start_zeit);
                    var dateStr = d.toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'2-digit'});
                    var timeStr = t.ganztaegig ? 'GanztÃ¤gig' : d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
                    if(t.end_zeit) { var e=new Date(t.end_zeit); timeStr += ' â€“ '+e.getHours()+':'+String(e.getMinutes()).padStart(2,'0'); }
                    html += '<div class="vit-card p-4 flex items-start space-x-4 hover:shadow-md transition">';
                    html += '<div class="text-center flex-shrink-0 w-14"><div class="text-2xl">' + (typeLabels[t.typ]||'ðŸ“‹') + '</div><div class="text-xs font-bold text-gray-500 mt-1">' + dateStr + '</div></div>';
                    html += '<div class="flex-1"><h4 class="font-bold text-gray-800 text-sm">' + t.titel + '</h4>';
                    html += '<p class="text-xs text-gray-500 mt-0.5">' + timeStr + (t.ort ? ' Â· ' + t.ort : '') + '</p>';
                    if(t.beschreibung) html += '<p class="text-xs text-gray-400 mt-1">' + t.beschreibung + '</p>';
                    html += '</div></div>';
                });
                if(terms.length===0) html = '<div class="text-center py-8 text-gray-400">Keine anstehenden Termine.</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Termine:', err); }
        }

        function showKommTab(tabName) {
            document.querySelectorAll('.komm-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.komm-tab-btn').forEach(function(b){
                b.className='komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {inbox:'Inbox',announce:'Announce',forum:'Forum',brett:'Brett',channel:'Channel',termine:'Termine'};
            var el = document.getElementById('kommTab' + (tabMap[tabName]||''));
            if(el) el.style.display = 'block';
            var btn = document.querySelector('.komm-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='komm-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='inbox') renderInbox('all');
            if(tabName==='announce') renderAnnouncements();
            if(tabName==='forum') renderForumPosts('all');
            if(tabName==='brett') renderBrett('all');
            if(tabName==='channel') renderChannelMessages();
            if(tabName==='termine') renderTermine();
        }

        // Init default tab
        renderInbox('all');

        // === KOMMUNIKATION (Forum + Channel data) ===
        var forumPosts = [
            {id:1,cat:'zentrale',pinned:true,author:'vit:bikes Zentrale',avatar:'V',avatarColor:'bg-vit-orange',date:'14.02.2026 Â· 09:00',title:'Vororder Herbst/Winter 2026 â€“ Deadline 28.02.',body:'Liebe Partner, bitte denkt an die Vororder-Deadline fuer H/W 2026. Die Konditionen und Bestellformulare findet ihr im Einkaufsbereich. Bei Fragen meldet euch bei eurem Ansprechpartner.',replies:8,views:142,lastReply:'vor 2 Std.'},
            {id:2,cat:'verkauf',author:'Stefan (Karlsfeld)',avatar:'SK',avatarColor:'bg-blue-500',date:'13.02.2026 Â· 16:45',title:'Erfahrungen mit Simplon Kagu 2026?',body:'Hat jemand schon den neuen Simplon Kagu 2026 im Laden? Wir hatten 3 Probefahrten und die Kunden waren begeistert, aber der Preis ist schon sportlich. Wie argumentiert ihr das?',replies:12,views:89,lastReply:'vor 30 Min.'},
            {id:3,cat:'werkstatt',author:'Markus (Hanau)',avatar:'MH',avatarColor:'bg-green-600',date:'13.02.2026 Â· 14:20',title:'Shimano EP6 Firmware-Update Probleme',body:'Wir haben seit dem letzten Firmware-Update Probleme mit dem EP6 Motor â€“ Display zeigt sporadisch Fehlercode W013. Hat das noch jemand? Shimano Support reagiert langsam.',replies:6,views:67,lastReply:'vor 1 Std.'},
            {id:4,cat:'allgemein',author:'Julia (Muenchen Ost)',avatar:'JM',avatarColor:'bg-purple-500',date:'12.02.2026 Â· 11:30',title:'Wer hat Lust auf ein Partner-Stammtisch Muenchen?',body:'Wir koennten uns mal informell treffen â€“ Pizza, Bier und Erfahrungsaustausch. Wuerde vorschlagen Ende Maerz, wenn die Saison noch nicht voll angelaufen ist. Wer waere dabei?',replies:15,views:103,lastReply:'vor 4 Std.'},
            {id:5,cat:'einkauf',author:'Thomas (Grafrath)',avatar:'TG',avatarColor:'bg-cyan-600',date:'12.02.2026 Â· 09:15',title:'Kalkhoff Endeavour lieferbar?',body:'Hat jemand gerade einen Kalkhoff Endeavour 5.B Move+ in L/Diamant auf Lager? Mein Kunde braucht ihn dringend, bei uns erst KW 12 avisiert. Wuerde Standort-Transfer machen.',replies:3,views:34,lastReply:'vor 8 Std.'},
            {id:6,cat:'zentrale',author:'vit:bikes Zentrale',avatar:'V',avatarColor:'bg-vit-orange',date:'10.02.2026 Â· 10:00',title:'Neue Marketingmaterialien Fruehjahr 2026 verfuegbar',body:'Die neuen Fruehjahrs-Flyer, Plakate und Social Media Templates stehen ab sofort im Marketing-Bereich zum Download bereit. Bitte bis 01.03. im Laden aufhaengen.',replies:4,views:118,lastReply:'vor 2 Tagen'},
            {id:7,cat:'werkstatt',author:'Dirk (Grafrath)',avatar:'DG',avatarColor:'bg-red-500',date:'09.02.2026 Â· 15:40',title:'Tipp: Bosch CX Gen5 Kettenblatt-Wechsel',body:'Kleiner Werkstatt-Tipp: Beim neuen Bosch CX Gen5 muss man das Spezialwerkzeug BDU3741 verwenden, sonst verkratzt man die Motorabdeckung. Hat mich eine Stunde gekostet bis ichs rausgefunden hab.',replies:9,views:76,lastReply:'vor 3 Tagen'},
            {id:8,cat:'verkauf',author:'Anna (Starnberg)',avatar:'AS',avatarColor:'bg-pink-500',date:'08.02.2026 Â· 13:00',title:'Leasing-Antraege beschleunigen â€“ mein Workflow',body:'Ich hab mir einen Prozess gebaut, mit dem Leasing-Antraege in unter 10 Min. durch sind. Kann ich gerne teilen, wenn Interesse besteht. Funktioniert mit Jobrad und Bikeleasing.',replies:18,views:156,lastReply:'vor 4 Tagen'},
        ];

        var channelMessages = [
            {author:'Sandra',avatar:'S',color:'bg-blue-500',time:'08:15',text:'Guten Morgen zusammen! Hab heute 3 Termine ab 10 Uhr. Wer macht Kasse?'},
            {author:'Dirk',avatar:'D',color:'bg-purple-500',time:'08:22',text:'Moin! Ich mach Kasse bis Mittag, dann hab ich den Werkstatt-Rueckstau von gestern.'},
            {author:'Thomas',avatar:'T',color:'bg-green-500',time:'08:30',text:'Bin ab 9 da. Sandra, dein 10-Uhr Termin hat angerufen â€“ kommt 15 Min. spaeter.'},
            {author:'Sandra',avatar:'S',color:'bg-blue-500',time:'08:32',text:'Danke Thomas! Dann zieh ich den Papierkram vor.'},
            {author:'Max',avatar:'M',color:'bg-orange-500',time:'09:05',text:'Morgen! Die Shimano-Lieferung ist da, 3 Kartons. Soll ich direkt einraeumen oder erst die Werkstatt-Auftraege?'},
            {author:'Dirk',avatar:'D',color:'bg-purple-500',time:'09:08',text:'Werkstatt zuerst bitte â€“ der Herr Mueller will sein Rad heute abholen und da fehlen noch die Bremsbelaege.'},
            {author:'Max',avatar:'M',color:'bg-orange-500',time:'09:10',text:'Alles klar, Bremsbelaege muessten in Karton 2 sein. Mach ich sofort.'},
            {author:'Sandra',avatar:'S',color:'bg-blue-500',time:'10:45',text:'Erster Termin war super â€“ Fam. Mueller nimmt den Simplon Kagu! 4.899 EUR. Muss noch Leasing-Antrag machen.'},
            {author:'Thomas',avatar:'T',color:'bg-green-500',time:'10:48',text:'Nice! Welche Farbe?'},
            {author:'Sandra',avatar:'S',color:'bg-blue-500',time:'10:50',text:'Midnight Blue, Groesse M. Lieferzeit hat er gesagt ist ok, braucht es erst Ende Maerz.'},
            {author:'Dirk',avatar:'D',color:'bg-purple-500',time:'12:15',text:'Kurze Info: Der Kalkhoff Endeavour fuer Herrn Schmidt ist jetzt fertig aufgebaut. Kann ab morgen abgeholt werden. Wer ruft ihn an?'},
            {author:'Thomas',avatar:'T',color:'bg-green-500',time:'12:18',text:'Mach ich nach der Pause!'},
            {author:'Max',avatar:'M',color:'bg-orange-500',time:'13:30',text:'Shimano-Lieferung komplett eingeraeumt. Aber es fehlen 2x Deore XT Kassette 12-fach, die waren auf dem Lieferschein. Hab Reklamation per Mail geschickt.'},
            {author:'Sandra',avatar:'S',color:'bg-blue-500',time:'14:20',text:'Zweiter Termin war leider nix â€“ wollte nur Preise vergleichen und kauft wahrscheinlich online. Dritter kommt um 15 Uhr.'},
        ];

        async function renderForumPosts(cat) {
            var container = document.getElementById('forumPosts');
            if(!container) return;
            container.innerHTML = '<div class="text-center py-4"><span class="text-gray-400 text-sm">BeitrÃ¤ge werden geladen...</span></div>';

            try {
                var query = sb.from('forum_beitraege').select('*, users(name)').order('gepinnt', { ascending: false }).order('created_at', { ascending: false });
                if(cat && cat !== 'all') query = query.eq('kategorie', cat);

                var resp = await query;
                if(resp.error) throw resp.error;

                var posts = resp.data || [];
                var html = '';

                if(posts.length === 0) {
                    html = '<div class="text-center py-8"><span class="text-gray-400 text-sm">Keine BeitrÃ¤ge gefunden.</span></div>';
                }

                var catColors = {news:'bg-vit-orange text-white',frage:'bg-blue-100 text-blue-700',tipp:'bg-green-100 text-green-700',allgemein:'bg-gray-100 text-gray-700'};
                var catLabels = {news:'News',frage:'Frage',tipp:'Tipp',allgemein:'Allgemein'};

                for(var i = 0; i < posts.length; i++) {
                    var p = posts[i];
                    var authorName = p.users ? p.users.name : 'Unbekannt';
                    var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var colors = ['bg-blue-500','bg-green-600','bg-purple-500','bg-cyan-600','bg-pink-500','bg-red-500'];
                    var colorIdx = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                    var d = new Date(p.created_at);
                    var dateStr = d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}) + ' Â· ' + d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');

                    // Kommentare zÃ¤hlen
                    var commResp = await sb.from('forum_kommentare').select('id', { count: 'exact', head: true }).eq('beitrag_id', p.id);
                    var replyCount = commResp.count || 0;

                    html += '<div class="vit-card p-5 hover:shadow-md transition ' + (p.gepinnt ? 'border-l-4 border-vit-orange' : '') + '">';
                    html += '<div class="flex items-start space-x-4">';
                    html += '<div class="w-10 h-10 ' + (p.gepinnt ? 'bg-vit-orange' : colors[colorIdx]) + ' rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">' + initials + '</div>';
                    html += '<div class="flex-1 min-w-0">';
                    html += '<div class="flex items-center space-x-2 mb-1">';
                    if(p.gepinnt) html += '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 rounded px-1.5 py-0.5">ðŸ“Œ Angepinnt</span>';
                    html += '<span class="text-xs font-semibold rounded px-2 py-0.5 ' + (catColors[p.kategorie]||catColors.allgemein) + '">' + (catLabels[p.kategorie]||p.kategorie) + '</span>';
                    html += '</div>';
                    html += '<h3 class="font-bold text-gray-800 mb-1 hover:text-vit-orange cursor-pointer">' + p.titel + '</h3>';
                    html += '<p class="text-sm text-gray-600 mb-2 line-clamp-2">' + p.inhalt + '</p>';
                    html += '<div class="flex items-center space-x-4 text-xs text-gray-400">';
                    html += '<span class="font-semibold text-gray-600">' + authorName + '</span>';
                    html += '<span>' + dateStr + '</span>';
                    html += '<span>ðŸ’¬ ' + replyCount + ' Antworten</span>';
                    html += '</div></div></div></div>';
                }

                container.innerHTML = html;
            } catch(err) {
                console.error('Forum laden:', err);
                container.innerHTML = '<div class="text-center py-4"><span class="text-red-400 text-sm">Fehler: ' + err.message + '</span></div>';
            }
        }

        function filterForum(cat) {
            document.querySelectorAll('.forum-cat-btn').forEach(function(b){
                b.className = 'forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200';
            });
            var btn = document.querySelector('.forum-cat-btn[data-cat="'+cat+'"]');
            if(btn) btn.className = 'forum-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderForumPosts(cat);
        }

        var sbKanalId = null; // aktiver Kanal
        var sbKanaele = []; // geladene KanÃ¤le
        var realtimeSubscription = null;

        async function loadKanaele() {
            try {
                var resp = await sb.from('chat_kanaele').select('*').order('created_at');
                if(resp.error) throw resp.error;
                sbKanaele = resp.data || [];
            } catch(err) { console.error('KanÃ¤le laden:', err); }
        }

        async function renderChannelMessages() {
            var container = document.getElementById('channelMessages');
            if(!container) return;
            container.innerHTML = '<div class="text-center py-8"><span class="text-gray-400 text-sm">Nachrichten werden geladen...</span></div>';

            try {
                // KanÃ¤le laden falls noch nicht geschehen
                if(sbKanaele.length === 0) await loadKanaele();

                // Ersten Standort-Kanal wÃ¤hlen (Team-Chat)
                if(!sbKanalId && sbKanaele.length > 0) {
                    var teamKanal = sbKanaele.find(function(k) { return k.standort_id !== null; });
                    sbKanalId = teamKanal ? teamKanal.id : sbKanaele[0].id;
                }

                if(!sbKanalId) {
                    container.innerHTML = '<div class="text-center py-8"><span class="text-gray-400 text-sm">Kein Chat-Kanal verfÃ¼gbar.</span></div>';
                    return;
                }

                // Header aktualisieren
                var aktKanal = sbKanaele.find(function(k) { return k.id === sbKanalId; });
                var headerTitle = container.closest('.komm-tab-content').querySelector('h3.font-bold');
                if(headerTitle && aktKanal) headerTitle.textContent = aktKanal.name;

                // Kanal-Tabs rendern
                renderKanalTabs();

                // Nachrichten laden mit User-Daten
                var resp = await sb.from('chat_nachrichten')
                    .select('*, users(name)')
                    .eq('kanal_id', sbKanalId)
                    .order('created_at', { ascending: true });
                if(resp.error) throw resp.error;

                var messages = resp.data || [];
                var html = '';
                var lastDateStr = '';

                messages.forEach(function(m) {
                    var d = new Date(m.created_at);
                    var dateStr = d.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    if(dateStr !== lastDateStr) {
                        html += '<div class="text-center my-3"><span class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full">' + dateStr + '</span></div>';
                        lastDateStr = dateStr;
                    }
                    var authorName = m.users ? m.users.name : 'Unbekannt';
                    var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var isMe = m.user_id === (sbUser ? sbUser.id : null);
                    var colors = ['bg-blue-500','bg-green-500','bg-purple-500','bg-orange-500','bg-cyan-500','bg-pink-500','bg-red-500'];
                    var colorIdx = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                    var time = d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');

                    html += '<div class="flex items-start space-x-3">';
                    html += '<div class="w-8 h-8 ' + (isMe ? 'bg-vit-orange' : colors[colorIdx]) + ' rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">' + initials + '</div>';
                    html += '<div class="flex-1"><div class="flex items-baseline space-x-2"><span class="font-semibold text-gray-800 text-sm">' + authorName + '</span><span class="text-xs text-gray-400">' + time + '</span></div>';
                    html += '<p class="text-sm text-gray-700 mt-0.5">' + m.nachricht.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p></div></div>';
                });

                if(messages.length === 0) {
                    html = '<div class="text-center py-8"><span class="text-gray-400 text-sm">Noch keine Nachrichten. Schreib die erste! ðŸ‘‹</span></div>';
                }

                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;

                // Realtime subscription starten
                subscribeToChannel();

            } catch(err) {
                console.error('Chat laden:', err);
                container.innerHTML = '<div class="text-center py-8"><span class="text-red-400 text-sm">Fehler beim Laden: ' + err.message + '</span></div>';
            }
        }

        function renderKanalTabs() {
            // Kanal-Wechsel Buttons Ã¼ber dem Chat einfÃ¼gen
            var channelTab = document.getElementById('kommTabChannel');
            var existing = document.getElementById('kanalTabsBar');
            if(existing) existing.remove();
            if(!channelTab || sbKanaele.length <= 1) return;

            var tabsHtml = '<div id="kanalTabsBar" class="flex space-x-2 mb-3">';
            sbKanaele.forEach(function(k) {
                var active = k.id === sbKanalId;
                tabsHtml += '<button onclick="switchKanal(\'' + k.id + '\')" class="px-3 py-1.5 rounded-full text-xs font-semibold ' +
                    (active ? 'bg-vit-orange text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200') + '">' +
                    (k.standort_id ? '# ' : 'ðŸŒ ') + k.name + '</button>';
            });
            tabsHtml += '</div>';

            var headerCard = channelTab.querySelector('.vit-card.p-4.mb-4');
            if(headerCard) headerCard.insertAdjacentHTML('afterend', tabsHtml);
        }

        async function switchKanal(kanalId) {
            sbKanalId = kanalId;
            if(realtimeSubscription) {
                sb.removeChannel(realtimeSubscription);
                realtimeSubscription = null;
            }
            await renderChannelMessages();
        }

        function subscribeToChannel() {
            if(realtimeSubscription) {
                sb.removeChannel(realtimeSubscription);
            }
            realtimeSubscription = sb.channel('chat-' + sbKanalId)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chat_nachrichten',
                    filter: 'kanal_id=eq.' + sbKanalId
                }, async function(payload) {
                    // Neue Nachricht eingetroffen â€“ Autor laden
                    var msg = payload.new;
                    if(msg.user_id === (sbUser ? sbUser.id : null)) return; // eigene schon gerendert
                    var resp = await sb.from('users').select('name').eq('id', msg.user_id).single();
                    var authorName = resp.data ? resp.data.name : 'Unbekannt';
                    var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var colors = ['bg-blue-500','bg-green-500','bg-purple-500','bg-orange-500','bg-cyan-500','bg-pink-500','bg-red-500'];
                    var colorIdx = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                    var d = new Date(msg.created_at);
                    var time = d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');

                    var container = document.getElementById('channelMessages');
                    if(!container) return;
                    var msgHtml = '<div class="flex items-start space-x-3">';
                    msgHtml += '<div class="w-8 h-8 ' + colors[colorIdx] + ' rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">' + initials + '</div>';
                    msgHtml += '<div class="flex-1"><div class="flex items-baseline space-x-2"><span class="font-semibold text-gray-800 text-sm">' + authorName + '</span><span class="text-xs text-gray-400">' + time + '</span></div>';
                    msgHtml += '<p class="text-sm text-gray-700 mt-0.5">' + msg.nachricht.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p></div></div>';
                    container.insertAdjacentHTML('beforeend', msgHtml);
                    container.scrollTop = container.scrollHeight;
                })
                .subscribe();
        }

        async function sendChannelMsg() {
            var input = document.getElementById('channelInput');
            var text = input.value.trim();
            if(!text || !sbUser || !sbKanalId) return;

            input.value = '';
            input.disabled = true;

            try {
                var resp = await sb.from('chat_nachrichten').insert({
                    kanal_id: sbKanalId,
                    user_id: sbUser.id,
                    nachricht: text
                });
                if(resp.error) throw resp.error;

                // Sofort lokal rendern (optimistic UI)
                var container = document.getElementById('channelMessages');
                var emptyMsg = container.querySelector('.text-center.py-8');
                if(emptyMsg) emptyMsg.remove();

                var d = new Date();
                var time = d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
                var authorName = sbProfile ? sbProfile.name : 'Ich';
                var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);

                var msgHtml = '<div class="flex items-start space-x-3">';
                msgHtml += '<div class="w-8 h-8 bg-vit-orange rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">' + initials + '</div>';
                msgHtml += '<div class="flex-1"><div class="flex items-baseline space-x-2"><span class="font-semibold text-gray-800 text-sm">' + authorName + '</span><span class="text-xs text-gray-400">' + time + '</span></div>';
                msgHtml += '<p class="text-sm text-gray-700 mt-0.5">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p></div></div>';
                container.insertAdjacentHTML('beforeend', msgHtml);
                container.scrollTop = container.scrollHeight;
            } catch(err) {
                alert('Senden fehlgeschlagen: ' + err.message);
                input.value = text;
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // === AKTENSCHRANK ===
        var aktenFiles = {};
        var aktenLoaded = false;

        async function loadAktenFiles() {
            if(aktenLoaded) return;
            try {
                var query = sb.from('standort_dokumente').select('*').order('erstellt_am', {ascending:false});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var resp = await query;
                if(!resp.error && resp.data && resp.data.length > 0) {
                    aktenFiles = {};
                    (resp.data||[]).forEach(function(d) {
                        var kat = d.kategorie || 'diverses';
                        if(!aktenFiles[kat]) aktenFiles[kat] = [];
                        aktenFiles[kat].push({
                            id: d.id, name: d.titel || d.datei_name,
                            type: (d.datei_name||'').split('.').pop().toUpperCase() || 'PDF',
                            date: d.erstellt_am ? new Date(d.erstellt_am).toLocaleDateString('de-DE') : '',
                            size: d.datei_groesse ? formatBytes(d.datei_groesse) : '',
                            path: d.datei_url
                        });
                    });
                    aktenLoaded = true;
                } else {
                    // Fallback: static demo data when DB is empty
                    aktenFiles = {
                        vertraege: [
                            {name:'Franchisevertrag vit:bikes 2024',type:'PDF',date:'15.01.2026',size:'2.4 MB'},
                            {name:'Mietvertrag Gewerbeflaeche',type:'PDF',date:'01.03.2024',size:'1.8 MB'},
                            {name:'Betriebshaftpflicht Police 2026',type:'PDF',date:'10.01.2026',size:'520 KB'}
                        ],
                        finanzen: [
                            {name:'BWA Januar 2026',type:'XLSX',date:'05.02.2026',size:'145 KB'},
                            {name:'Jahresabschluss 2024',type:'PDF',date:'30.06.2025',size:'3.1 MB'},
                            {name:'Planung 2026',type:'XLSX',date:'20.12.2025',size:'890 KB'}
                        ],
                        personal: [
                            {name:'Personalplanung 2026',type:'XLSX',date:'20.12.2025',size:'320 KB'},
                            {name:'Urlaubsplanung 2026',type:'XLSX',date:'10.01.2026',size:'85 KB'}
                        ],
                        standort: [
                            {name:'Grundriss Ladenflaeche',type:'PDF',date:'01.02.2024',size:'4.2 MB'},
                            {name:'Brandschutzkonzept',type:'PDF',date:'01.02.2024',size:'1.6 MB'}
                        ],
                        marketing: [
                            {name:'vit:bikes Brand Guidelines 2025',type:'PDF',date:'03.02.2026',size:'12.4 MB'},
                            {name:'Logo-Kit (alle Formate)',type:'ZIP',date:'15.01.2025',size:'8.7 MB'}
                        ],
                        lieferanten: [
                            {name:'Rahmenvertrag Kalkhoff/Derby 2026',type:'PDF',date:'20.01.2026',size:'890 KB'}
                        ],
                        diverses: [
                            {name:'Checkliste Saisonstart Fruehjahr',type:'PDF',date:'01.02.2026',size:'140 KB'}
                        ]
                    };
                    aktenLoaded = true;
                }
            } catch(err) { console.warn('Aktenschrank load:', err); }
        }

        var aktenFolderLabels = {
            vertraege:'Vertraege & Recht', finanzen:'Finanzen & Buchhaltung', personal:'Personal & HR',
            standort:'Standort & Betrieb', marketing:'Marketing & Branding', lieferanten:'Lieferanten & Einkauf', diverses:'Diverses'
        };

        function getFileIcon(type) {
            var colors = {PDF:'text-red-500',XLSX:'text-green-600',DOCX:'text-blue-600',ZIP:'text-yellow-600',JPG:'text-purple-500'};
            return '<span class="font-mono text-xs font-bold px-2 py-1 rounded '+(colors[type]||'text-gray-500')+' bg-gray-100">'+type+'</span>';
        }

        function openDokUploadModal() {
            var html = '<div id="dokUpOverlay" onclick="closeDokUpModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:480px;max-width:95vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDCC4 Dokument hochladen</h3><button onclick="closeDokUpModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Titel *</label><input id="dokUpTitel" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="z.B. Richtlinie Preisgestaltung"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Kategorie</label><select id="dokUpKat" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="richtlinie">Richtlinie</option><option value="vorlage">Vorlage</option><option value="schulung">Schulung</option><option value="vertrag">Vertrag</option><option value="sonstiges">Sonstiges</option></select></div>';
            html += '<div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center"><p class="text-sm text-gray-500 mb-2">Datei auswaehlen</p><input type="file" id="dokUpFile" class="text-sm"></div>';
            html += '</div>';
            html += '<div id="dokUpError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveDokUpload()" id="dokUpBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Hochladen</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'dokUpContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closeDokUpModal() { var c = document.getElementById('dokUpContainer'); if(c) c.remove(); }
        async function saveDokUpload() {
            var titel = (document.getElementById('dokUpTitel')||{}).value;
            var kat = (document.getElementById('dokUpKat')||{}).value||'sonstiges';
            var fileInput = document.getElementById('dokUpFile');
            var errEl = document.getElementById('dokUpError');
            var btn = document.getElementById('dokUpBtn');
            if(!titel||!titel.trim()) { if(errEl){errEl.textContent='Bitte Titel eingeben.';errEl.style.display='block';} return; }
            if(!fileInput||!fileInput.files||!fileInput.files[0]) { if(errEl){errEl.textContent='Bitte Datei auswaehlen.';errEl.style.display='block';} return; }
            if(btn){btn.disabled=true;btn.textContent='Wird hochgeladen...';}
            try {
                var file = fileInput.files[0];
                var path = 'netzwerk/'+kat+'/'+Date.now()+'_'+file.name;
                var upResp = await sb.storage.from('dokumente').upload(path, file, {upsert:true});
                if(upResp.error) throw upResp.error;
                var urlResp = sb.storage.from('dokumente').getPublicUrl(path);
                await sb.from('netzwerk_dokumente').insert({
                    titel:titel.trim(), kategorie:kat, datei_url:path, datei_name:file.name,
                    datei_groesse:file.size, mime_type:file.type,
                    erstellt_von:sbUser?sbUser.id:null
                });
                closeDokUpModal();
                alert('\u2705 Dokument hochgeladen!');
                loadNetzwerkDokumente();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn){btn.disabled=false;btn.textContent='Hochladen';}
            }
        }

        async function openAktenFolder(folderId) {
            if(!aktenLoaded) await loadAktenFiles();
            var files = aktenFiles[folderId] || [];
            document.getElementById('aktenFolderTitle').textContent = aktenFolderLabels[folderId] || folderId;
            var html = '';
            files.forEach(function(f) {
                html += '<tr class="border-b hover:bg-gray-50">';
                html += '<td class="py-3 px-4"><div class="flex items-center space-x-3">' + getFileIcon(f.type) + '<span class="font-medium text-gray-800">' + f.name + '</span></div></td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.type + '</td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.date + '</td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.size + '</td>';
                html += '<td class="py-3 px-4 text-right"><button class="text-vit-orange hover:underline text-sm font-semibold mr-3">Oeffnen</button><button class="text-gray-400 hover:text-red-500 text-sm">Loeschen</button></td>';
                html += '</tr>';
            });
            document.getElementById('aktenFileList').innerHTML = html;
            document.getElementById('aktenFolders').style.display = 'none';
            document.getElementById('aktenFolderDetail').classList.remove('hidden');
        }

        function closeAktenFolder() {
            document.getElementById('aktenFolders').style.display = '';
            document.getElementById('aktenFolderDetail').classList.add('hidden');
        }

        function filterAkten() {
            var q = document.getElementById('aktenSearch').value.toLowerCase();
            document.querySelectorAll('.akten-folder').forEach(function(f) {
                var text = f.textContent.toLowerCase();
                f.style.display = text.indexOf(q) >= 0 ? '' : 'none';
            });
        }

        // Init verkauf - DB loading happens on tab switch after login
        renderPipeline();

        // Check for existing Supabase session
        checkSession();

        // === CONTROLLING TABS ===
        function showControllingTab(tabName) {
            document.querySelectorAll('.ctrl-tab-content').forEach(function(t) { t.style.display = 'none'; });
            document.querySelectorAll('.ctrl-tab-btn').forEach(function(b) {
                b.className = 'ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabId = 'ctrlTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            var el = document.getElementById(tabId);
            if (el) el.style.display = 'block';
            var btn = document.querySelector('.ctrl-tab-btn[data-tab="' + tabName + '"]');
            if (btn) btn.className = 'ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        function showBwaDetail(id) {
            // Legacy stub - now handled by showBwaFromDb
        }

        // =============================================
        // BWA PARSER MODULE (Auto-Detect 8 Formate)
        // =============================================
        var BwaParser=(function(){'use strict';var BWA_ZEILEN={1020:{name:'UmsatzerlÃ¶se',gruppe:'UmsatzerlÃ¶se',summe:true},1040:{name:'BestandsverÃ¤nderg. FE/UE',gruppe:'BestandsverÃ¤nderungen',summe:true},1045:{name:'Aktivierte Eigenleistungen',gruppe:'Eigenleistungen',summe:true},1050:{name:'Sonstige betriebliche ErlÃ¶se',gruppe:'Sonstige ErlÃ¶se',summe:true},1051:{name:'Gesamtleistung',gruppe:'Gesamtleistung',summe:true},1060:{name:'Material-/Wareneinkauf',gruppe:'Materialaufwand',summe:true},1080:{name:'Rohertrag',gruppe:'Rohertrag',summe:true},1090:{name:'So. betr. ErlÃ¶se',gruppe:'Sonstige ErlÃ¶se',summe:true},1092:{name:'Betrieblicher Rohertrag',gruppe:'Betrieblicher Rohertrag',summe:true},1100:{name:'Personalkosten',gruppe:'Personalkosten',summe:true},1120:{name:'Raumkosten',gruppe:'Raumkosten',summe:true},1140:{name:'Betriebliche Steuern',gruppe:'Betriebliche Steuern',summe:true},1150:{name:'Versicherungen/BeitrÃ¤ge',gruppe:'Versicherungen/BeitrÃ¤ge',summe:true},1160:{name:'Besondere Kosten',gruppe:'Besondere Kosten',summe:true},1180:{name:'Fahrzeugkosten (ohne Steuer)',gruppe:'Fahrzeugkosten',summe:true},1200:{name:'Werbe-/Reisekosten',gruppe:'Werbe-/Reisekosten',summe:true},1220:{name:'Kosten Warenabgabe',gruppe:'Kosten Warenabgabe',summe:true},1240:{name:'Abschreibungen',gruppe:'Abschreibungen',summe:true},1250:{name:'Reparatur/Instandhaltung',gruppe:'Reparatur/Instandhaltung',summe:true},1260:{name:'Sonstige Kosten',gruppe:'Sonstige Kosten',summe:true},1280:{name:'Gesamtkosten',gruppe:'Gesamtkosten',summe:true},1300:{name:'Betriebsergebnis',gruppe:'Betriebsergebnis',summe:true},1310:{name:'Zinsaufwand',gruppe:'Zinsaufwand',summe:true},1312:{name:'Sonstiger neutraler Aufwand',gruppe:'Sonstiger neutraler Aufwand',summe:true},1320:{name:'Neutraler Aufwand',gruppe:'Neutraler Aufwand',summe:true},1322:{name:'ZinsertrÃ¤ge',gruppe:'ZinsertrÃ¤ge',summe:true},1323:{name:'Sonstiger neutraler Ertrag',gruppe:'Sonstiger neutraler Ertrag',summe:true},1324:{name:'Verrechnete kalk. Kosten',gruppe:'Verrechnete kalk. Kosten',summe:true},1330:{name:'Neutraler Ertrag',gruppe:'Neutraler Ertrag',summe:true},1340:{name:'Kontenklasse unbesetzt',gruppe:'Kontenklasse unbesetzt',summe:true},1345:{name:'Ergebnis vor Steuern',gruppe:'Ergebnis vor Steuern',summe:true},1355:{name:'Steuern Einkommen u. Ertrag',gruppe:'Steuern Einkommen u. Ertrag',summe:true},1380:{name:'VorlÃ¤ufiges Ergebnis',gruppe:'VorlÃ¤ufiges Ergebnis',summe:true}};
        var KOMPAKT_MAP={'umsatzerlÃ¶se':{gruppe:'UmsatzerlÃ¶se',zeile:1020,summe:true},'umsatzerl.':{gruppe:'UmsatzerlÃ¶se',zeile:1020,summe:true},'gesamterlÃ¶se':{gruppe:'Gesamtleistung',zeile:1051,summe:true},'gesamtleistung':{gruppe:'Gesamtleistung',zeile:1051,summe:true},'bestandsverÃ¤nderg. fe/ue':{gruppe:'BestandsverÃ¤nderungen',zeile:1040,summe:true},'aktivierte eigenleistungen':{gruppe:'Eigenleistungen',zeile:1045,summe:true},'wareneinsatz':{gruppe:'Materialaufwand',zeile:1060,summe:true},'wareneinsatz / material- und stoffverbrauch':{gruppe:'Materialaufwand',zeile:1060,summe:true},'material-/wareneinkauf':{gruppe:'Materialaufwand',zeile:1060,summe:true},'mat./wareneinkauf':{gruppe:'Materialaufwand',zeile:1060,summe:true},'rohertrag':{gruppe:'Rohertrag',zeile:1080,summe:true},'sonstige betriebliche erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'sonst. betr. erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'so. betr. erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'sonstige betr. erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'betrieblicher rohertrag':{gruppe:'Betrieblicher Rohertrag',zeile:1120,summe:true},'personalkosten':{gruppe:'Personalkosten',zeile:1140,summe:true},'personalaufwand':{gruppe:'Personalkosten',zeile:1140,summe:true},'lÃ¶hne/gehÃ¤lter':{gruppe:'Personalkosten',zeile:1150,summe:false},'lÃ¶hne und gehÃ¤lter':{gruppe:'Personalkosten',zeile:1150,summe:false},'ges. soz. aufwendung':{gruppe:'Personalkosten',zeile:1155,summe:false},'soziale abgaben':{gruppe:'Personalkosten',zeile:1155,summe:false},'raumkosten':{gruppe:'Raumkosten',zeile:1160,summe:true},'betriebliche steuern':{gruppe:'Steuern/Versicherungen',zeile:1170,summe:true},'vers./beitr./steuern':{gruppe:'Steuern/Versicherungen',zeile:1175,summe:true},'versicherungen / beitrÃ¤ge':{gruppe:'Steuern/Versicherungen',zeile:1175,summe:true},'versicherungen/beitrÃ¤ge':{gruppe:'Steuern/Versicherungen',zeile:1175,summe:true},'kfz. kosten':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'kfz.-kosten (ohne steuer)':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'fahrzeugkosten (ohne steuer)':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'fahrzeugkosten':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'werbe- und reisekost':{gruppe:'Werbe-/Reisekosten',zeile:1190,summe:true},'werbe- / reisekosten':{gruppe:'Werbe-/Reisekosten',zeile:1190,summe:true},'werbe-/reisekosten':{gruppe:'Werbe-/Reisekosten',zeile:1190,summe:true},'kosten warenabgabe':{gruppe:'Warenabgabekosten',zeile:1200,summe:true},'kosten der warenabgabe':{gruppe:'Warenabgabekosten',zeile:1200,summe:true},'afa anlageverm.':{gruppe:'Abschreibungen',zeile:1210,summe:false},'afa umlaufverm.':{gruppe:'Abschreibungen',zeile:1210,summe:false},'afa gesamt':{gruppe:'Abschreibungen',zeile:1210,summe:true},'abschreibungen':{gruppe:'Abschreibungen',zeile:1210,summe:true},'instandhaltung':{gruppe:'Instandhaltung',zeile:1220,summe:true},'reparatur/instandhaltung':{gruppe:'Instandhaltung',zeile:1220,summe:true},'sonstige kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:true},'verschiedene kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:true},'gesamtkosten':{gruppe:'Gesamtkosten',zeile:1250,summe:true},'summe kosten':{gruppe:'Gesamtkosten',zeile:1250,summe:true},'summe betr.aufw.':{gruppe:'Summe Aufwendungen',zeile:1260,summe:true},'betriebsergebnis':{gruppe:'Betriebsergebnis',zeile:1270,summe:true},'zinsertrag':{gruppe:'Zinsen',zeile:1285,summe:false},'zinsertrÃ¤ge':{gruppe:'Zinsen',zeile:1285,summe:false},'zinsaufwand':{gruppe:'Zinsen',zeile:1280,summe:false},'neutraler aufwand':{gruppe:'Neutrales Ergebnis',zeile:1290,summe:false},'sonstiger neutraler aufwand':{gruppe:'Neutrales Ergebnis',zeile:1290,summe:false},'neutraler ertrag':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:false},'sonstiger neutraler ertrag':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:false},'verrechnete kalk. kosten':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:false},'neutrales ergebnis':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:true},'ergebnis vor steuern':{gruppe:'Ergebnis',zeile:1300,summe:true},'vorl. ergebnis':{gruppe:'Ergebnis',zeile:1370,summe:true},'vorlÃ¤ufiges ergebnis':{gruppe:'Ergebnis',zeile:1370,summe:true},'besondere kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:false}};
        function grv(sheet,rowNum){var vals=[];var range=XLSX.utils.decode_range(sheet['!ref']||'A1');for(var c=range.s.c;c<=range.e.c;c++){var cell=sheet[XLSX.utils.encode_cell({r:rowNum-1,c:c})];vals.push(cell?(cell.v!==undefined?cell.v:''):'');}return vals;}
        function gcv(sheet,row,col){var cell=sheet[XLSX.utils.encode_cell({r:row-1,c:col-1})];return cell?(cell.v!==undefined?cell.v:null):null;}
        function toNum(val){if(val===null||val===undefined||val===''||val===' ')return null;if(typeof val==='number')return val;var s=String(val).trim().replace(/\s/g,'');if(s===''||s==='-')return null;s=s.replace(/\./g,'').replace(',','.');var n=parseFloat(s);return isNaN(n)?null:n;}
        function normBez(bez){if(!bez)return '';return String(bez).trim().replace(/\s+/g,' ');}
        function lookupK(bez){var key=normBez(bez).toLowerCase();return KOMPAKT_MAP[key]||null;}
        function extractMJ(filename){var result={monat:null,jahr:null,standort:''};var jahrMatch=filename.match(/(20\d{2})/);if(jahrMatch)result.jahr=parseInt(jahrMatch[1]);var monate={'januar':1,'jan':1,'februar':2,'feb':2,'mÃ¤rz':3,'mrz':3,'april':4,'apr':4,'mai':5,'juni':6,'jun':6,'juli':7,'jul':7,'august':8,'aug':8,'september':9,'sep':9,'oktober':10,'okt':10,'november':11,'nov':11,'dezember':12,'dez':12};var lower=filename.toLowerCase();for(var m in monate){if(lower.includes(m)){result.monat=monate[m];break;}}var parts=filename.replace(/\.[^.]+$/,'').split('_');if(parts.length>=3){if(parts[0].toLowerCase()==='bwa')result.standort=parts[2].replace(/U_berarbeitet|MF|Version.*$/gi,'').trim();if(parts[0].toLowerCase()==='planung')result.standort=parts[1];}return result;}
        function detectFmt(sheet,filename){var r1=grv(sheet,1);var r2=grv(sheet,2);var r1s=r1.join(' ').toLowerCase();var r2s=r2.join(' ').toLowerCase();var isJ=filename.toLowerCase().includes('jahr');if(filename.toLowerCase().includes('planung'))return{format:'planung',typ:'plan'};if(r1s.includes('zeile')&&r1s.includes('bezeichnung')&&r1s.includes('konto')&&r1s.includes('konten'))return{format:'datev_wertenachweis',typ:isJ?'jahr':'monat'};var r3=grv(sheet,3);var r3s=r3.join(' ').toLowerCase();if(r3s.includes('zeile')&&r3s.includes('bezeichnung')&&r3s.includes('konto'))return{format:'datev_wertenachweis_offset',typ:isJ?'jahr':'monat'};if(r1s.includes('summen')&&r1s.includes('salden'))return{format:'susa',typ:'monat'};if(r2s.includes('konto')&&r2s.includes('beschriftung')&&r2s.includes('eb-wert'))return{format:'susa',typ:'monat'};if(r1s.includes('kanzlei-rechnungswesen')&&r2s.includes('zeile')&&r2s.includes('konto')&&r2s.includes('verÃ¤nderung'))return{format:'datev_vorjahresvergleich',typ:isJ?'jahr':'monat'};if(r1s.includes('kanzlei-rechnungswesen')&&r2s.includes('zeile')&&r2s.includes('konto'))return{format:'datev_erfolgsrechnung',typ:isJ?'jahr':'monat'};if(r1s.includes('datev-bwa')||r1s.includes('betriebswirtschaftliche auswertung'))return{format:'datev_jahresuebersicht',typ:'jahr'};if(r1s.includes('bezeichnung')){var c2=sheet['B1']?sheet['B1'].v:null;var isDateB1=c2 instanceof Date||(typeof c2==='number'&&c2>40000);if(isDateB1)return{format:'kompakt_datum',typ:'monat'};}if(r1s.includes('bezeichnung')&&(r1s.includes('monat')||r1s.includes('ums.%')||r1s.includes('ges.-leistg')||r1s.includes('ges.leistg')||r1s.includes('% ges'))){if(r1.length>10||isJ)return{format:'kompakt_jahr',typ:'jahr'};return{format:'kompakt',typ:'monat'};}if(r1s.includes('bezeichnung')){var c2b=sheet['B1']?sheet['B1'].v:null;if(typeof c2b==='number'||c2b instanceof Date)return{format:'kompakt_jahr_datum',typ:'jahr'};}return{format:'unbekannt',typ:isJ?'jahr':'monat'};}
        function parseDWN(sheet,meta,hRow){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var cz=null;var cb='';for(var r=hRow;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var bez=gcv(sheet,r+1,2);var konto=gcv(sheet,r+1,3);var kontoBez=gcv(sheet,r+1,5)||gcv(sheet,r+1,4);var wM=gcv(sheet,r+1,7);var wB=gcv(sheet,r+1,8);var wK=gcv(sheet,r+1,9);var wKB=gcv(sheet,r+1,10);if(zeile&&typeof zeile==='number'&&zeile>=1000){cz=zeile;cb=normBez(bez||kontoBez||'');}if(toNum(wM)===null&&toNum(wB)===null&&toNum(wK)===null)continue;var iS=(zeile&&zeile>=1000)&&(wB!==null);var dB=kontoBez?normBez(kontoBez):cb;if(!dB)continue;var bi=cz?BWA_ZEILEN[cz]:null;rows.push({zeile:cz,konto:konto?String(konto):null,kontengruppe:bi?bi.gruppe:(cb||''),bezeichnung:iS?(bi?bi.name:dB):dB,wert:toNum(iS?wB:wM),wert_kumuliert:toNum(iS?wKB:wK),ist_summenzeile:iS,ebene:iS?0:(konto?2:1),sortierung:si++});}return rows;}
        function parseKompakt(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var wCol=2;var kCol=null;var vjCol=null;var pctCol=null;var dateDetected=false;var header=grv(sheet,1);for(var i=1;i<header.length;i++){var h=String(header[i]).toLowerCase();var isDate=header[i] instanceof Date||(typeof header[i]==='number'&&header[i]>40000);if(isDate&&!dateDetected){wCol=i+1;dateDetected=true;}if(!dateDetected&&(h.includes('monat')||(h.match&&h.match(/^(20\d{2})$/))))wCol=i+1;if(h.includes('jan/')||h.includes('jan-')||h.includes('lfd. jahr')||h.includes('lfd.jahr')||(h.includes('jan')&&h.includes('/')))kCol=i+1;else if(!dateDetected&&(h.includes('2025')||h.includes('2024')||h.includes('2026'))&&!h.includes('jan')&&!h.includes('-'))wCol=i+1;if(h.includes('vj. monat')||h.includes('vorjahr')||h.includes('vj.monat'))vjCol=i+1;if(h.includes('ges.-leistg')||h.includes('ges.leistg')||h.includes('% ges'))pctCol=i+1;}for(var r=1;r<=range.e.r;r++){var bez=gcv(sheet,r+1,1);if(!bez||typeof bez!=='string')continue;bez=normBez(bez);if(bez.includes('Bezeichnung')||bez==='Kostenarten:'||bez==='Kostenarten')continue;var mapped=lookupK(bez);var wert=toNum(gcv(sheet,r+1,wCol));var kum=kCol?toNum(gcv(sheet,r+1,kCol)):null;var vj=vjCol?toNum(gcv(sheet,r+1,vjCol)):null;var pct=pctCol?toNum(gcv(sheet,r+1,pctCol)):null;if(wert===null&&kum===null)continue;rows.push({zeile:mapped?mapped.zeile:null,konto:null,kontengruppe:mapped?mapped.gruppe:bez,bezeichnung:bez,wert:wert,wert_kumuliert:kum,wert_vorjahr:vj,prozent_gesamtleistung:pct,ist_summenzeile:mapped?mapped.summe:false,ebene:mapped&&mapped.summe?0:1,sortierung:si++});}return rows;}
        function parseDER(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var cz=null;for(var r=2;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var konto=gcv(sheet,r+1,2);var bez=gcv(sheet,r+1,3);var wM=gcv(sheet,r+1,4);var wK=gcv(sheet,r+1,9);if(zeile&&typeof zeile==='number'&&zeile>=1000)cz=zeile;if(!bez||toNum(wM)===null)continue;bez=normBez(bez);var iS=(zeile&&zeile>=1000);var bi=cz?BWA_ZEILEN[cz]:null;rows.push({zeile:cz,konto:konto?String(konto):null,kontengruppe:bi?bi.gruppe:'',bezeichnung:bez,wert:toNum(wM),wert_kumuliert:toNum(wK),ist_summenzeile:iS,ebene:iS?0:(konto?2:1),sortierung:si++});}return rows;}
        function parseDVJ(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=2;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var bez=gcv(sheet,r+1,2);var wM=gcv(sheet,r+1,3);var wVj=gcv(sheet,r+1,4);var wK=gcv(sheet,r+1,7);var wVjK=gcv(sheet,r+1,8);if(!zeile||typeof zeile!=='number'||zeile<1000)continue;if(toNum(wM)===null&&toNum(wK)===null)continue;var bi=BWA_ZEILEN[zeile];bez=normBez(bez||(bi?bi.name:''));rows.push({zeile:zeile,konto:null,kontengruppe:bi?bi.gruppe:'',bezeichnung:bez,wert:toNum(wM),wert_kumuliert:toNum(wK),wert_vorjahr:toNum(wVj),wert_vorjahr_kumuliert:toNum(wVjK),ist_summenzeile:true,ebene:0,sortierung:si++});}return rows;}
        function parseJU(sheet,meta,startRow){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=startRow;r<=range.e.r;r++){var bez=gcv(sheet,r+1,1);if(!bez||typeof bez!=='string')continue;bez=normBez(bez);if(bez.includes('Kurzfristige Erfolgsrechnung')||bez.includes('Kostenarten'))continue;var mapped=lookupK(bez);var mw={};var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];var summe=null;for(var c=1;c<=Math.min(13,range.e.c);c++){var val=toNum(gcv(sheet,r+1,c+1));if(c<=12)mw[mn[c-1]]=val||0;else summe=val;}if(summe===null){summe=0;for(var m in mw)summe+=(mw[m]||0);}rows.push({bezeichnung:bez,kontengruppe:mapped?mapped.gruppe:bez,konto:null,jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:summe,ist_summenzeile:mapped?mapped.summe:false,sortierung:si++});}return rows;}
        function parseCsvJ(text,meta){var lines=text.split('\n');var rows=[];var si=0;var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];for(var i=1;i<lines.length;i++){var parts=lines[i].split(';');if(parts.length<2)continue;var bez=normBez(parts[0]);if(!bez||bez.includes('Kurzfristige Erfolgsrechnung'))continue;var mapped=lookupK(bez);var mw={};var summe=0;for(var c=1;c<=Math.min(13,parts.length-1);c++){var val=toNum(parts[c]);if(c<=12)mw[mn[c-1]]=val||0;else summe=val;}if(summe===0)for(var m in mw)summe+=(mw[m]||0);rows.push({bezeichnung:bez,kontengruppe:mapped?mapped.gruppe:bez,jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:Math.round(summe*100)/100,ist_summenzeile:mapped?mapped.summe:false,sortierung:si++});}return rows;}
        function parsePBwa(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=4;r<=range.e.r;r++){var gruppe=gcv(sheet,r+1,2);var kontoNr=gcv(sheet,r+1,3);var konto=gcv(sheet,r+1,4);var aktBwa=gcv(sheet,r+1,5);var ytd=gcv(sheet,r+1,6);var ds=gcv(sheet,r+1,7);var hr=gcv(sheet,r+1,8);if(!kontoNr&&!konto)continue;var bez=normBez(konto||'');if(!bez)continue;var pw={};var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];var sm=0;for(var c=0;c<12;c++){var val=toNum(gcv(sheet,r+1,10+c));pw[mn[c]]=val||0;sm+=(val||0);}rows.push({kontengruppe:normBez(gruppe||''),konto:kontoNr?String(kontoNr):null,bezeichnung:bez,vorjahr_aktuell:toNum(aktBwa),vorjahr_ytd:toNum(ytd),vorjahr_durchschnitt:toNum(ds),vorjahr_hochrechnung:toNum(hr),jan:pw.jan,feb:pw.feb,mrz:pw.mrz,apr:pw.apr,mai:pw.mai,jun:pw.jun,jul:pw.jul,aug:pw.aug,sep:pw.sep,okt:pw.okt,nov:pw.nov,dez:pw.dez,summe:Math.round(sm*100)/100,sortierung:si++});}return rows;}
        function parsePUms(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];for(var r=4;r<=range.e.r;r++){var marke=gcv(sheet,r+1,3);if(!marke||typeof marke!=='string'||marke==='0')continue;marke=normBez(marke);if(marke.toLowerCase().includes('planung')||marke.toLowerCase().includes('gesamt'))continue;var mw={};var sm=0;for(var c=0;c<12;c++){var val=toNum(gcv(sheet,r+1,4+c));mw[mn[c]]=val||0;sm+=(val||0);}if(sm===0)continue;rows.push({marke:marke,kategorie:'FahrrÃ¤der',jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:sm,sortierung:si++});}return rows;}
        function parsePPers(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);for(var r=3;r<=range.e.r;r++){var nn=gcv(sheet,r+1,1);var vn=gcv(sheet,r+1,2);if(!nn||typeof nn!=='string')continue;if(nn.includes('Gesamt')||nn.includes('AB Zeile')||nn.includes('Nachname'))continue;var td=function(v){if(!v)return null;if(v instanceof Date)return v.toISOString().split('T')[0];return null;};rows.push({nachname:normBez(nn),vorname:normBez(vn||''),status:gcv(sheet,r+1,3)||'',standort_name:gcv(sheet,r+1,4)||'',abteilung:gcv(sheet,r+1,5)||'',position:gcv(sheet,r+1,7)||'',wochenarbeitszeit:toNum(gcv(sheet,r+1,8)),stundenlohn:toNum(gcv(sheet,r+1,9)),anstelldatum:td(gcv(sheet,r+1,10)),austrittsdatum:td(gcv(sheet,r+1,11)),fixgehalt:toNum(gcv(sheet,r+1,12)),gehalt_neu_1:toNum(gcv(sheet,r+1,13)),gehalt_neu_1_ab:td(gcv(sheet,r+1,14)),gehalt_neu_2:toNum(gcv(sheet,r+1,15)),gehalt_neu_2_ab:td(gcv(sheet,r+1,16))});}return rows;}
        function parseFile(file,callback){var filename=file.name;var meta=extractMJ(filename);meta.dateiname=filename;var reader=new FileReader();if(filename.toLowerCase().endsWith('.csv')){reader.onload=function(e){var text=e.target.result;var header=text.split('\n')[0]||'';meta.format=header.includes('Bezeichnung')&&header.includes('EUR')?'csv_jahresuebersicht':'csv_unbekannt';meta.typ='jahr';var result={meta:meta,bwa_daten:[],bwa_jahr_daten:[],plan_bwa:[],plan_umsaetze:[],plan_personal:[]};if(meta.format==='csv_jahresuebersicht')result.bwa_jahr_daten=parseCsvJ(text,meta);callback(null,result);};reader.readAsText(file,'utf-8');}else{reader.onload=function(e){try{var wb=XLSX.read(e.target.result,{type:'array',cellDates:true});var sn=wb.SheetNames[0];var ws=wb.Sheets[sn];try{var rawJson=XLSX.utils.sheet_to_json(ws,{header:'A',defval:null,raw:true});window._bwaRawSheetData=rawJson;}catch(rErr){window._bwaRawSheetData=[];}var det=detectFmt(ws,filename);meta.format=det.format;meta.typ=det.typ;var result={meta:meta,bwa_daten:[],bwa_jahr_daten:[],plan_bwa:[],plan_umsaetze:[],plan_personal:[]};if(meta.format==='planung'){wb.SheetNames.forEach(function(s){var w=wb.Sheets[s];var sl=s.toLowerCase();if(sl.includes('bwa'))result.plan_bwa=parsePBwa(w);else if(sl.includes('umsÃ¤tze')||sl.includes('umsaetze'))result.plan_umsaetze=parsePUms(w);else if(sl.includes('personal'))result.plan_personal=parsePPers(w);});meta.typ='plan';callback(null,result);return;}switch(meta.format){case 'datev_wertenachweis':result.bwa_daten=parseDWN(ws,meta,1);break;case 'datev_wertenachweis_offset':result.bwa_daten=parseDWN(ws,meta,3);break;case 'kompakt':case 'kompakt_datum':result.bwa_daten=parseKompakt(ws,meta);if(meta.format==='kompakt_datum'){var b1=ws['B1']?ws['B1'].v:null;if(b1 instanceof Date){if(!meta.monat)meta.monat=b1.getMonth()+1;if(!meta.jahr)meta.jahr=b1.getFullYear();}else if(typeof b1==='number'&&b1>40000){var dt=new Date((b1-25569)*86400000);if(!meta.monat)meta.monat=dt.getMonth()+1;if(!meta.jahr)meta.jahr=dt.getFullYear();}}break;case 'datev_erfolgsrechnung':result.bwa_daten=parseDER(ws,meta);break;case 'datev_vorjahresvergleich':result.bwa_daten=parseDVJ(ws,meta);break;case 'kompakt_jahr':case 'kompakt_jahr_datum':case 'datev_jahresuebersicht':var sr=0;for(var r=0;r<5;r++){var v=gcv(ws,r+1,1);if(v&&String(v).toLowerCase().includes('umsatzerlÃ¶se')){sr=r;break;}if(v&&String(v).toLowerCase().includes('bezeichnung')){sr=r+1;break;}}result.bwa_jahr_daten=parseJU(ws,meta,sr);break;default:result.bwa_daten=parseKompakt(ws,meta);}callback(null,result);}catch(err){callback(err,null);}};reader.readAsArrayBuffer(file);}};return{parseFile:parseFile,extractMonatJahr:extractMJ,BWA_ZEILEN:BWA_ZEILEN,KOMPAKT_MAP:KOMPAKT_MAP};})();

        // =============================================
        // BWA SUPABASE FUNCTIONS
        // =============================================
        var bwaCache = [];
        var selectedBwaId = null;

        var monatNamen = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

        function eur(val) {
            if(val===null||val===undefined) return 'â€”';
            var n = parseFloat(val);
            return n.toLocaleString('de-DE', {minimumFractionDigits:0, maximumFractionDigits:0});
        }
        function eurColor(val) {
            var n = parseFloat(val)||0;
            return n >= 0 ? 'text-gray-800' : 'text-red-600';
        }
        function diffHtml(ist, plan) {
            if(!plan) return '<td class="text-right py-2 px-3 text-gray-300">â€”</td>';
            var d = parseFloat(ist) - parseFloat(plan);
            var cl = d >= 0 ? 'text-green-600' : 'text-red-600';
            var prefix = d >= 0 ? '+' : '';
            return '<td class="text-right py-2 px-3 '+cl+' font-semibold">'+prefix+eur(d)+'</td>';
        }

        async function loadBwaList() {
            var container = document.getElementById('bwaFileList');
            if(!container) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                console.log('[BWA] loadBwaList() stdId:', stdId, 'is_hq:', sbProfile ? sbProfile.is_hq : 'no profile');
                var query = sb.from('bwa_daten').select('id,monat,jahr,umsatzerloese,rohertrag,ergebnis_vor_steuern,datei_name,created_at').order('jahr', {ascending:false}).order('monat', {ascending:false});
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                bwaCache = resp.data || [];
                if(bwaCache.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Noch keine BWAs erfasst.</p>';
                    return;
                }
                // Group by year
                var years = {};
                bwaCache.forEach(function(b) {
                    if(!years[b.jahr]) years[b.jahr] = [];
                    years[b.jahr].push(b);
                });
                var h = '';
                Object.keys(years).sort(function(a,b){return b-a;}).forEach(function(yr) {
                    var items = years[yr];
                    h += '<div class="mb-3">';
                    h += '<button onclick="this.nextElementSibling.classList.toggle(\'hidden\')" class="flex items-center justify-between w-full text-left p-2 bg-gray-100 rounded-lg hover:bg-gray-200">';
                    h += '<span class="font-semibold text-gray-700">ðŸ“ '+yr+'</span>';
                    h += '<span class="text-gray-400 text-xs">'+items.length+' BWA'+(items.length>1?'s':'')+'</span></button>';
                    h += '<div class="mt-2 space-y-1">';
                    items.forEach(function(b) {
                        var isSelected = selectedBwaId === b.id;
                        var ergClass = parseFloat(b.ergebnis_vor_steuern) >= 0 ? 'text-green-600' : 'text-red-500';
                        h += '<button onclick="showBwaFromDb(\''+b.id+'\')" class="bwa-file-db w-full flex items-center justify-between p-2.5 rounded-lg hover:bg-orange-50 text-left'+(isSelected?' bg-orange-50 border border-vit-orange':'')+'">';
                        h += '<div class="flex items-center space-x-3"><span class="text-red-500">ðŸ“„</span>';
                        h += '<div><p class="text-sm font-semibold '+(isSelected?'text-vit-orange':'text-gray-800')+'">'+monatNamen[b.monat]+' '+b.jahr+'</p>';
                        h += '<p class="text-xs text-gray-500">Umsatz: '+eur(b.umsatzerloese)+' â‚¬</p></div></div>';
                        h += '<span class="text-xs '+ergClass+'">'+eur(b.ergebnis_vor_steuern)+' â‚¬</span>';
                        h += '</button>';
                    });
                    h += '</div></div>';
                });
                container.innerHTML = h;
            } catch(err) { container.innerHTML = '<p class="text-sm text-red-400 text-center py-4">Fehler: '+err.message+'</p>'; }
        }

        async function showBwaFromDb(bwaId) {
            selectedBwaId = bwaId;
            try {
                var resp = await sb.from('bwa_daten').select('*').eq('id', bwaId).single();
                if(resp.error) throw resp.error;
                var b = resp.data;
                // Update title
                document.getElementById('bwaTitle').textContent = 'BWA ' + monatNamen[b.monat] + ' ' + b.jahr;
                document.getElementById('bwaEditBtn').style.display = '';
                document.getElementById('bwaDeleteBtn').style.display = '';
                // KPIs
                var marge = parseFloat(b.umsatzerloese) > 0 ? ((parseFloat(b.rohertrag)/parseFloat(b.umsatzerloese))*100).toFixed(1) : 0;
                var ergMarge = parseFloat(b.umsatzerloese) > 0 ? ((parseFloat(b.ergebnis_vor_steuern)/parseFloat(b.umsatzerloese))*100).toFixed(1) : 0;
                document.getElementById('bwaKpiUmsatz').textContent = eur(b.umsatzerloese) + ' â‚¬';
                document.getElementById('bwaKpiUmsatzVj').textContent = b.plan_umsatz ? 'Plan: '+eur(b.plan_umsatz)+' â‚¬' : '';
                document.getElementById('bwaKpiRohertrag').textContent = eur(b.rohertrag) + ' â‚¬';
                document.getElementById('bwaKpiMarge').textContent = 'Marge: '+marge+'%';
                document.getElementById('bwaKpiKosten').textContent = eur(b.gesamtkosten) + ' â‚¬';
                document.getElementById('bwaKpiKostenVj').textContent = b.plan_gesamtkosten ? 'Plan: '+eur(b.plan_gesamtkosten)+' â‚¬' : '';
                var ergEl = document.getElementById('bwaKpiErgebnis');
                ergEl.textContent = eur(b.ergebnis_vor_steuern) + ' â‚¬';
                ergEl.className = 'text-xl font-bold ' + (parseFloat(b.ergebnis_vor_steuern) >= 0 ? 'text-green-600' : 'text-red-600');
                document.getElementById('bwaKpiErgebnisMarge').textContent = 'Marge: '+ergMarge+'%';

                // Detail table - try loading from bwa_detail_positionen first
                var detailResp = await sb.from('bwa_detail_positionen').select('*').eq('bwa_id', bwaId).order('sortierung');
                var detailRows = (detailResp.data && detailResp.data.length > 0) ? detailResp.data : null;
                
                var tbody = '';
                if(detailRows) {
                    // Zeige alle Detail-Positionen aus dem Parser
                    var lastGruppe = '';
                    detailRows.forEach(function(d) {
                        var isSumme = d.ist_summenzeile;
                        var isDetail = d.ebene >= 2;
                        var cls = isSumme ? 'bg-gray-50 border-b-2 border-gray-300' : 'border-b border-gray-100';
                        var tdBold = isSumme ? 'font-semibold' : '';
                        var indent = isDetail ? 'pl-6 text-xs text-gray-500' : (d.ebene === 1 ? 'pl-3 text-sm' : '');
                        
                        // Gruppenheader
                        if(isSumme && d.kontengruppe && d.kontengruppe !== lastGruppe) {
                            lastGruppe = d.kontengruppe;
                        }
                        
                        // Highlight fÃ¼r wichtige Summenzeilen
                        var hlCls = '';
                        var kg = d.kontengruppe || '';
                        if((kg === 'Rohertrag' || kg === 'Betrieblicher Rohertrag') && isSumme) { cls = 'bg-blue-50 border-b-2 border-blue-200'; hlCls = 'text-blue-800'; }
                        if((kg === 'Ergebnis' || kg === 'Ergebnis vor Steuern' || kg === 'VorlÃ¤ufiges Ergebnis') && isSumme) { 
                            var ergVal = parseFloat(d.wert)||0;
                            cls = (ergVal >= 0 ? 'bg-green-50 border-t-2 border-green-400' : 'bg-red-50 border-t-2 border-red-400');
                            hlCls = ergVal >= 0 ? 'text-green-800' : 'text-red-800';
                        }
                        if(kg === 'Betriebsergebnis' && isSumme) cls = 'bg-orange-50 border-b-2 border-orange-200';
                        if(kg === 'Gesamtkosten' || kg === 'Summe Aufwendungen') { if(isSumme) cls = 'bg-gray-100 border-b-2 border-gray-400'; }
                        if(kg === 'Materialaufwand' && isSumme) cls = 'bg-gray-50 border-b-2 border-gray-200';
                        if(kg === 'Personalkosten' && isSumme) cls = 'bg-gray-50 border-b border-gray-200';
                        if(kg === 'UmsatzerlÃ¶se' && isSumme) cls = 'bg-gray-50 border-b-2 border-gray-300';
                        
                        tbody += '<tr class="'+cls+'">';
                        tbody += '<td class="py-1.5 px-3 '+tdBold+' '+hlCls+' '+indent+'">';
                        if(isDetail && d.konto) tbody += '<span class="text-gray-400 text-[10px] mr-1">'+d.konto+'</span> ';
                        tbody += (d.bezeichnung||'')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 '+tdBold+' '+hlCls+' '+eurColor(d.wert)+'">'+eur(d.wert)+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-400">'+(d.wert_kumuliert ? eur(d.wert_kumuliert) : 'â€”')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-400">'+(d.wert_vorjahr ? eur(d.wert_vorjahr) : 'â€”')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-300">'+(d.prozent_gesamtleistung ? d.prozent_gesamtleistung+'%' : '')+'</td>';
                        tbody += '</tr>';
                    });
                    // Update table header for detail view
                    document.querySelector('#bwaDetailTable thead tr').innerHTML = 
                        '<th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Monat</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Kumuliert</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Vorjahr</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">%</th>';
                } else {
                    // Fallback: Standard-Ansicht aus Zusammenfassung
                    var rows = [
                        {label:'Umsatzerloese', ist:b.umsatzerloese, plan:b.plan_umsatz, bold:true},
                        {label:'  Fahrraeder', ist:b.davon_fahrraeder, sub:true},
                        {label:'  Teile & Zubehoer', ist:b.davon_teile, sub:true},
                        {label:'  Service / Reparatur', ist:b.davon_service, sub:true},
                        {label:'  Skonti', ist:b.davon_skonti, sub:true},
                        {label:'Wareneinsatz', ist:b.wareneinsatz, plan:b.plan_wareneinsatz, bold:true, bg:'bg-gray-50'},
                        {label:'Rohertrag', ist:b.rohertrag, plan:b.plan_rohertrag, bold:true, bg:'bg-blue-50', highlight:'text-blue-800'},
                        {label:'Personalkosten', ist:b.personalkosten, plan:b.plan_personalkosten, bold:true},
                        {label:'Miete / Raumkosten', ist:b.miete, plan:b.plan_raumkosten, bold:true},
                        {label:'Versicherungen / BeitrÃ¤ge', ist:b.versicherungen, bold:true},
                        {label:'Fahrzeugkosten', ist:b.fahrzeugkosten, bold:true},
                        {label:'Werbung / Marketing', ist:b.werbung_marketing, plan:b.plan_werbekosten, bold:true},
                        {label:'Kosten Warenabgabe', ist:b.kosten_warenabgabe, bold:true},
                        {label:'Abschreibungen', ist:b.abschreibungen, bold:true},
                        {label:'Reparatur / Instandhaltung', ist:b.reparaturen_instandhaltung, bold:true},
                        {label:'Sonstige Kosten', ist:b.sonstige_kosten, bold:true},
                        {label:'Gesamtkosten', ist:b.gesamtkosten, plan:b.plan_gesamtkosten, bold:true, bg:'bg-gray-50', separator:true},
                        {label:'Betriebsergebnis', ist:b.betriebsergebnis, bold:true},
                        {label:'Zinsen', ist:b.zinsen, bold:true},
                        {label:'Ergebnis vor Steuern', ist:b.ergebnis_vor_steuern, plan:b.plan_ergebnis, bold:true, bg:parseFloat(b.ergebnis_vor_steuern)>=0?'bg-green-50':'bg-red-50', highlight:parseFloat(b.ergebnis_vor_steuern)>=0?'text-green-800':'text-red-800', separator:true, big:true}
                    ];
                    // Restore default header
                    document.querySelector('#bwaDetailTable thead tr').innerHTML = 
                        '<th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">IST</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Plan</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Abweichung</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">VJ</th>';
                    rows.forEach(function(r) {
                        var cls = (r.separator?'border-t-2 border-gray-800 ':'border-b ') + (r.bg||'');
                        var tdCls = r.bold ? 'font-semibold' : '';
                        var hlCls = r.highlight || '';
                        var sz = r.big ? 'text-base' : '';
                        var indent = r.sub ? 'pl-6 text-gray-600 text-xs' : '';
                        tbody += '<tr class="'+cls+'">';
                        tbody += '<td class="py-2 px-3 '+tdCls+' '+hlCls+' '+sz+' '+indent+'">'+r.label.trim()+'</td>';
                        tbody += '<td class="text-right py-2 px-3 '+tdCls+' '+hlCls+' '+sz+' '+eurColor(r.ist)+'">'+eur(r.ist)+'</td>';
                        tbody += '<td class="text-right py-2 px-3 text-gray-400">'+(r.plan?eur(r.plan):'â€”')+'</td>';
                        tbody += diffHtml(r.ist, r.plan);
                        tbody += '<td class="text-right py-2 px-3 text-gray-400">â€”</td>';
                        tbody += '</tr>';
                    });
                }
                document.getElementById('bwaDetailBody').innerHTML = tbody;

                // Load trend
                loadBwaTrend(b.standort_id, b.jahr);
                // Refresh file list highlight
                loadBwaList();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function loadBwaTrend(stdId, jahr) {
            var sec = document.getElementById('bwaTrendSection');
            var cards = document.getElementById('bwaTrendCards');
            if(!sec||!cards) return;
            try {
                var query = sb.from('bwa_daten').select('monat,umsatzerloese,rohertrag,gesamtkosten,ergebnis_vor_steuern').eq('jahr', jahr).order('monat');
                if(stdId) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error || !resp.data || resp.data.length < 2) { sec.style.display = 'none'; return; }
                sec.style.display = '';
                var data = resp.data;
                var metrics = [
                    {label:'Umsatz',key:'umsatzerloese',color:'#22C55E',bg:'bg-green-50'},
                    {label:'Rohertrag',key:'rohertrag',color:'#3B82F6',bg:'bg-blue-50'},
                    {label:'Ergebnis',key:'ergebnis_vor_steuern',color:'#EF7D00',bg:'bg-orange-50'},
                    {label:'Gesamtkosten',key:'gesamtkosten',color:'#EF4444',bg:'bg-red-50'}
                ];
                var h = '';
                metrics.forEach(function(m) {
                    var vals = data.map(function(d){return parseFloat(d[m.key])||0;});
                    var labels = data.map(function(d){return monatNamen[d.monat].substring(0,3);});
                    var last = vals[vals.length-1];
                    var prev = vals.length>1 ? vals[vals.length-2] : last;
                    var change = prev!==0 ? Math.round((last-prev)/Math.abs(prev)*100) : 0;
                    var totalYTD = vals.reduce(function(a,b){return a+b;},0);
                    // Sparkline SVG
                    var minV=Math.min.apply(null,vals); var maxV=Math.max.apply(null,vals); var range=maxV-minV||1;
                    var sw=120; var sh=35;
                    var pts = vals.map(function(v,i){return Math.round(i/(vals.length-1)*sw)+','+Math.round(sh-(v-minV)/range*sh);});
                    // Fill area
                    var areaPts = pts.join(' ')+' '+sw+','+sh+' 0,'+sh;
                    h += '<div class="p-3 '+m.bg+' rounded-lg">';
                    h += '<p class="text-xs text-gray-500 mb-1">'+m.label+'</p>';
                    h += '<p class="text-lg font-bold text-gray-800">'+eur(last)+' \u20AC</p>';
                    h += '<div class="flex items-center justify-between">';
                    h += '<p class="text-xs '+(change>=0?'text-green-600':'text-red-600')+'">'+(change>=0?'\u2191':'\u2193')+' '+(change>=0?'+':'')+change+'%</p>';
                    h += '<p class="text-xs text-gray-400">YTD: '+eur(totalYTD)+'</p>';
                    h += '</div>';
                    h += '<svg width="'+sw+'" height="'+(sh+2)+'" class="mt-1">';
                    h += '<polygon points="'+areaPts+'" fill="'+m.color+'" fill-opacity="0.15"/>';
                    h += '<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+m.color+'" stroke-width="2" stroke-linejoin="round"/>';
                    // Last point dot
                    var lastPt = pts[pts.length-1].split(',');
                    h += '<circle cx="'+lastPt[0]+'" cy="'+lastPt[1]+'" r="3" fill="'+m.color+'"/>';
                    h += '</svg>';
                    h += '</div>';
                });
                cards.innerHTML = h;
            } catch(e) { sec.style.display = 'none'; }
        }

        function openBwaUploadModal() {
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var now = new Date();
            var html = '<div id="bwaUploadOverlay" onclick="closeBwaUploadModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:600px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">ðŸ“Š BWA erfassen</h3><button onclick="closeBwaUploadModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            
            // AI Upload Section FIRST
            html += '<div class="mb-4 p-4 border-2 border-dashed border-vit-orange/40 rounded-lg bg-orange-50/50">';
            html += '<div class="flex items-center space-x-2 mb-2"><span class="text-lg">ðŸ¤–</span><p class="text-sm font-semibold text-gray-800">BWA-Datei hochladen â€“ KI liest Werte automatisch</p></div>';
            html += '<p class="text-xs text-gray-500 mb-3">Lade deine BWA als Excel (.xlsx/.xls/.csv) oder PDF hoch. Die KI erkennt Monat, Jahr und alle Kennzahlen automatisch.</p>';
            html += '<div class="flex items-center space-x-3">';
            html += '<input type="file" id="bwaFileInput" accept=".pdf,.xlsx,.xls,.csv" class="text-xs flex-1" onchange="handleBwaFileSelect(this)">';
            html += '<button id="bwaParseBtn" onclick="parseBwaWithAI()" disabled class="px-4 py-2 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed whitespace-nowrap">ðŸ¤– Auslesen</button>';
            html += '</div>';
            html += '<div id="bwaAiStatus" class="mt-2 hidden"><div class="flex items-center space-x-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600" id="bwaAiStatusText">KI analysiert Datei...</span></div></div>';
            html += '<div id="bwaAiResult" class="mt-2 hidden"></div>';
            html += '</div>';

            // Month/Year AFTER upload (auto-filled by KI)
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Monat</label><select id="bwaMonth" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            for(var m=1;m<=12;m++) html += '<option value="'+m+'"'+(m===(now.getMonth())?' selected':'')+'>'+monatNamen[m]+'</option>';
            html += '</select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Jahr</label><select id="bwaYear" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            for(var y=2026;y>=2023;y--) html += '<option value="'+y+'">'+y+'</option>';
            html += '</select></div></div>';
            
            // Data entry
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Kennzahlen <span class="text-gray-400 font-normal">(werden automatisch befÃ¼llt oder manuell eingeben)</span></p>';
            var fields = [
                {id:'bwaF_umsatz',label:'Umsatzerloese',ph:'z.B. 54938'},
                {id:'bwaF_fahrraeder',label:'davon Fahrraeder',ph:'',sub:true},
                {id:'bwaF_teile',label:'davon Teile & Zubehoer',ph:'',sub:true},
                {id:'bwaF_service',label:'davon Service',ph:'',sub:true},
                {id:'bwaF_skonti',label:'davon Skonti (negativ)',ph:'z.B. -2028',sub:true},
                {id:'bwaF_wareneinsatz',label:'Wareneinsatz (negativ)',ph:'z.B. -33580'},
                {id:'bwaF_personal',label:'Personalkosten (negativ)',ph:'z.B. -13485'},
                {id:'bwaF_raum',label:'Raumkosten (negativ)',ph:'z.B. -4150'},
                {id:'bwaF_werbe',label:'Werbe-/Reisekosten',ph:''},
                {id:'bwaF_warenabgabe',label:'Kosten Warenabgabe',ph:''},
                {id:'bwaF_abschreibung',label:'Abschreibungen',ph:''},
                {id:'bwaF_sonstige',label:'Sonstige Kosten',ph:''},
                {id:'bwaF_zins',label:'Zinsaufwand',ph:''}
            ];
            html += '<div class="space-y-2 mb-4 max-h-60 overflow-y-auto">';
            fields.forEach(function(f) {
                html += '<div class="flex items-center space-x-2"><label class="'+(f.sub?'pl-4 ':'')+' text-xs text-gray-600 w-48 flex-shrink-0">'+f.label+'</label>';
                html += '<input id="'+f.id+'" type="number" step="0.01" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm text-right bwa-field" placeholder="'+f.ph+'"></div>';
            });
            html += '</div>';
            html += '<div id="bwaUploadError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveBwaData()" id="bwaSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">BWA speichern</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'bwaUploadContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        function handleBwaFileSelect(input) {
            var btn = document.getElementById('bwaParseBtn');
            if(btn) btn.disabled = !(input.files && input.files.length > 0);
        }

        // =====================================================================
        // BWA PLAUSIBILITÃ„TS-CHECK â€“ SelbststÃ¤ndige Validierung mit Eskalation
        // =====================================================================
        // Level: ok â†’ alles plausibel, warning â†’ verdÃ¤chtig aber speicherbar, critical â†’ blockiert
        // Eskalation: Wenn critical â†’ User muss manuell bestÃ¤tigen oder Werte korrigieren
        function validateParsedBwa(parsed, meta, matchedRows) {
            var issues = [];
            var u = parsed.umsatzerloese;
            var w = parsed.wareneinsatz;
            var r = parsed.rohertrag;
            var gk = parsed.gesamtkosten;
            var be = parsed.betriebsergebnis;
            var ev = parsed.ergebnis_vor_steuern;
            var pk = parsed.personalkosten;

            // === CRITICAL CHECKS (blockieren das Speichern) ===

            // 1. Umsatz = 0 aber andere Werte vorhanden â†’ falsches Spalten-Mapping
            if((u === 0 || u === undefined) && matchedRows && matchedRows.length > 5) {
                issues.push({severity:'error', code:'UMSATZ_NULL', message:'UmsatzerlÃ¶se = 0 â‚¬, obwohl ' + matchedRows.length + ' Werte erkannt wurden. MÃ¶glicherweise wurde die falsche Spalte gelesen.'});
            }

            // 2. Rohertrag > Umsatz (mathematisch unmÃ¶glich bei positiven Wareneinsatz)
            if(u !== undefined && u > 0 && r !== undefined && r > u * 1.05) {
                issues.push({severity:'error', code:'ROHERTRAG_GT_UMSATZ', message:'Rohertrag (' + Math.round(r).toLocaleString('de-DE') + ' â‚¬) ist grÃ¶ÃŸer als Umsatz (' + Math.round(u).toLocaleString('de-DE') + ' â‚¬). Das ist rechnerisch nicht mÃ¶glich.'});
            }

            // 3. Werte sehen nach Prozentzahlen aus (typisch: alle < 200)
            var allSmall = (u !== undefined && Math.abs(u) < 200) && (r !== undefined && Math.abs(r) < 200) && (matchedRows && matchedRows.length > 5);
            if(allSmall && u !== 0) {
                issues.push({severity:'error', code:'PROZENT_STATT_EURO', message:'Alle Werte sind sehr klein (< 200). MÃ¶glicherweise wurden Prozentwerte statt Euro-BetrÃ¤ge gelesen.'});
            }

            // 4. Wareneinsatz positiv (sollte negativ sein in BWA)
            if(w !== undefined && w > 1000) {
                issues.push({severity:'error', code:'WARENEINSATZ_POSITIV', message:'Wareneinsatz ist positiv (' + Math.round(w).toLocaleString('de-DE') + ' â‚¬). In der BWA sollte er negativ sein (= Aufwand). MÃ¶glicherweise Vorzeichenfehler.'});
            }

            // === WARNING CHECKS (speicherbar, aber Hinweis) ===

            // 5. Rohertragsmarge ungewÃ¶hnlich
            if(u !== undefined && u > 0 && r !== undefined) {
                var marge = (r / u) * 100;
                if(marge < 15) {
                    issues.push({severity:'warning', code:'MARGE_NIEDRIG', message:'Rohertragsmarge nur ' + marge.toFixed(1) + '%. BranchenÃ¼blich fÃ¼r Fahrrad: 30-50%. Bitte prÃ¼fen.'});
                }
                if(marge > 70) {
                    issues.push({severity:'warning', code:'MARGE_HOCH', message:'Rohertragsmarge ' + marge.toFixed(1) + '%. UngewÃ¶hnlich hoch fÃ¼r Fahrradhandel. Bitte prÃ¼fen.'});
                }
            }

            // 6. Personalkosten = 0 (ungewÃ¶hnlich)
            if(u !== undefined && u > 5000 && (pk === 0 || pk === undefined)) {
                issues.push({severity:'warning', code:'PERSONAL_NULL', message:'Personalkosten = 0 â‚¬. UngewÃ¶hnlich bei aktivem GeschÃ¤ftsbetrieb.'});
            }

            // 7. Gesamtkosten = 0 aber Umsatz vorhanden
            if(u !== undefined && u > 5000 && (gk === 0 || gk === undefined)) {
                issues.push({severity:'warning', code:'KOSTEN_NULL', message:'Gesamtkosten = 0 â‚¬. Bitte prÃ¼fen ob alle Kostenarten erfasst wurden.'});
            }

            // 8. Ergebnis > Umsatz (unplausibel)
            if(u !== undefined && u > 0 && ev !== undefined && Math.abs(ev) > u) {
                issues.push({severity:'warning', code:'ERGEBNIS_GT_UMSATZ', message:'Ergebnis (' + Math.round(ev).toLocaleString('de-DE') + ' â‚¬) ist betragsmÃ¤ÃŸig grÃ¶ÃŸer als Umsatz. Bitte prÃ¼fen.'});
            }

            // 9. Format-Warnung bei unbekanntem Format
            if(meta.format === 'unbekannt') {
                issues.push({severity:'warning', code:'FORMAT_UNBEKANNT', message:'Dateiformat konnte nicht erkannt werden. Werte kÃ¶nnten falsch zugeordnet sein.'});
            }

            // 10. Monat/Jahr nicht erkannt
            if(!meta.monat || !meta.jahr) {
                issues.push({severity:'warning', code:'PERIODE_FEHLT', message:'Monat und/oder Jahr konnten nicht automatisch erkannt werden. Bitte manuell Ã¼berprÃ¼fen.'});
            }

            // === CROSS-CHECK: Rohertrag = Umsatz + Wareneinsatz? ===
            if(u !== undefined && w !== undefined && r !== undefined) {
                var expected = u + w;
                var diff = Math.abs(r - expected);
                if(diff > 1 && diff > Math.abs(u) * 0.01) {
                    issues.push({severity:'warning', code:'ROHERTRAG_DIFFERENZ', message:'Rohertrag (' + Math.round(r).toLocaleString('de-DE') + ' â‚¬) â‰  Umsatz + Wareneinsatz (' + Math.round(expected).toLocaleString('de-DE') + ' â‚¬). Differenz: ' + Math.round(diff).toLocaleString('de-DE') + ' â‚¬'});
                }
            }

            // Determine level
            var hasError = issues.some(function(i) { return i.severity === 'error'; });
            var hasWarning = issues.some(function(i) { return i.severity === 'warning'; });
            var level = hasError ? 'critical' : (hasWarning ? 'warning' : 'ok');

            console.log('[BWA Validation]', level, issues.length + ' issues:', issues.map(function(i){return i.code;}).join(', '));
            return { level: level, issues: issues };
        }

        // Render escalation UI for failed parsing
        function renderBwaEscalation(level, meta, matchedRows, validation) {
            var html = '';
            if(level === 'critical' && (!matchedRows || matchedRows.length === 0)) {
                // Total failure - no values recognized
                html += '<div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">';
                html += '<p class="text-sm font-bold text-red-800 mb-2">ðŸš¨ Automatische Erkennung fehlgeschlagen</p>';
                html += '<p class="text-xs text-red-700 mb-2">Format erkannt: <code>' + meta.format + '</code>, aber keine Werte konnten zugeordnet werden.</p>';
                html += '<div class="bg-white rounded p-3 mb-3">';
                html += '<p class="text-xs font-semibold text-gray-700 mb-1">Was tun?</p>';
                html += '<ol class="text-xs text-gray-600 space-y-1 list-decimal pl-4">';
                html += '<li>PrÃ¼fe ob die Datei eine gÃ¼ltige BWA ist (Excel mit Positionen wie UmsatzerlÃ¶se, Rohertrag etc.)</li>';
                html += '<li>Gib die Werte unten <strong>manuell ein</strong> â€“ die Formularfelder sind weiterhin aktiv</li>';
                html += '<li>Falls das Format neu ist: Melde es dem HQ, damit der Parser erweitert werden kann</li>';
                html += '</ol></div>';
                html += '<details class="mt-2"><summary class="text-[10px] text-red-400 cursor-pointer">Technische Details fÃ¼r Support</summary>';
                html += '<div class="mt-1 bg-red-100 rounded p-2 text-[10px] text-red-700 font-mono">';
                html += 'Dateiname: ' + (meta.dateiname || '-') + '<br>';
                html += 'Format: ' + meta.format + '<br>';
                html += 'Typ: ' + (meta.typ || '-') + '<br>';
                html += 'Monat: ' + (meta.monat || 'nicht erkannt') + '<br>';
                html += 'Jahr: ' + (meta.jahr || 'nicht erkannt') + '<br>';
                if(validation && validation.issues.length > 0) {
                    html += 'Issues: ' + validation.issues.map(function(i){return i.code;}).join(', ');
                }
                html += '</div></details>';
                html += '</div>';
            }
            return html;
        }

        async function parseBwaWithAI() {
            var fileInput = document.getElementById('bwaFileInput');
            if(!fileInput || !fileInput.files || !fileInput.files[0]) return;
            var file = fileInput.files[0];
            var statusEl = document.getElementById('bwaAiStatus');
            var statusText = document.getElementById('bwaAiStatusText');
            var resultEl = document.getElementById('bwaAiResult');
            var parseBtn = document.getElementById('bwaParseBtn');

            statusEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            if(parseBtn) parseBtn.disabled = true;

            var isPdf = file.name.match(/\.pdf$/i);
            if(isPdf) {
                statusEl.querySelector('.animate-spin').style.display = 'none';
                statusText.textContent = 'â„¹ï¸ PDF erkannt â€“ bitte Werte manuell eingeben';
                resultEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700">'
                    + '<p class="font-semibold mb-1">PDF-Erkennung kommt bald</p>'
                    + '<p>Aktuell werden nur Excel-Dateien (.xlsx/.xls/.csv) automatisch ausgelesen.</p></div>';
                resultEl.classList.remove('hidden');
                if(parseBtn) parseBtn.disabled = false;
                return;
            }

            statusText.textContent = 'ðŸ“Š Datei wird analysiert...';

            BwaParser.parseFile(file, function(err, result) {
                if(err) {
                    statusEl.querySelector('.animate-spin').style.display = 'none';
                    statusText.textContent = 'âŒ Fehler: ' + (err.message||'Unbekannt');
                    resultEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700">'
                        + '<p class="font-semibold mb-1">Automatische Erkennung fehlgeschlagen</p>'
                        + '<p>Bitte die Werte manuell eingeben.</p></div>';
                    resultEl.classList.remove('hidden');
                    if(parseBtn) parseBtn.disabled = false;
                    return;
                }

                var meta = result.meta;
                var daten = result.bwa_daten;
                var jahrDaten = result.bwa_jahr_daten;

                // Apply detected month/year
                if(meta.monat) {
                    var mSel = document.getElementById('bwaMonth');
                    if(mSel) { mSel.value = meta.monat; mSel.style.borderColor = '#f97316'; mSel.style.backgroundColor = '#fff7ed'; }
                }
                if(meta.jahr) {
                    var ySel = document.getElementById('bwaYear');
                    if(ySel) { ySel.value = meta.jahr; ySel.style.borderColor = '#f97316'; ySel.style.backgroundColor = '#fff7ed'; }
                }

                // Extract key values from parsed data
                var parsed = {};
                var matchedRows = [];
                
                // Mapping: kontengruppe/bezeichnung â†’ form field
                var gruppenMap = {
                    'UmsatzerlÃ¶se': 'umsatzerloese',
                    'Materialaufwand': 'wareneinsatz',
                    'Rohertrag': 'rohertrag',
                    'Betrieblicher Rohertrag': 'rohertrag',
                    'Personalkosten': 'personalkosten',
                    'Raumkosten': 'raumkosten',
                    'Werbe-/Reisekosten': 'werbekosten',
                    'Warenabgabekosten': 'kosten_warenabgabe',
                    'Kosten Warenabgabe': 'kosten_warenabgabe',
                    'Abschreibungen': 'abschreibungen',
                    'Sonstige Kosten': 'sonstige_kosten',
                    'Gesamtkosten': 'gesamtkosten',
                    'Summe Aufwendungen': 'gesamtkosten',
                    'Fahrzeugkosten': 'fahrzeugkosten',
                    'Steuern/Versicherungen': 'versicherungen',
                    'Versicherungen/BeitrÃ¤ge': 'versicherungen',
                    'Betriebliche Steuern': 'betriebliche_steuern',
                    'Instandhaltung': 'instandhaltung',
                    'Reparatur/Instandhaltung': 'instandhaltung',
                    'Betriebsergebnis': 'betriebsergebnis',
                    'Ergebnis': 'ergebnis_vor_steuern',
                    'Ergebnis vor Steuern': 'ergebnis_vor_steuern',
                    'VorlÃ¤ufiges Ergebnis': 'vorlaefiges_ergebnis',
                    'Zinsen': 'zinsaufwand',
                    'Zinsaufwand': 'zinsaufwand',
                    'Gesamtleistung': 'gesamtleistung',
                    'Sonstige ErlÃ¶se': 'sonstige_erloese',
                    'BestandsverÃ¤nderungen': 'bestandsveraenderungen',
                    'Eigenleistungen': 'eigenleistungen',
                    'Neutrales Ergebnis': 'neutrales_ergebnis',
                    'Besondere Kosten': 'besondere_kosten',
                    'Steuern Einkommen u. Ertrag': 'steuern_einkommen'
                };
                
                // Detail-Konten Mapping
                var kontoMap = {
                    '4400': 'davon_fahrraeder',
                    '4405': 'davon_teile',
                    '4407': 'davon_service',
                    '4410': 'davon_service',
                    '4730': 'davon_skonti',
                    '4736': 'davon_skonti'
                };
                
                // Verarbeite Monats-BWA Daten
                if(daten && daten.length > 0) {
                    daten.forEach(function(row) {
                        if(!row.wert && row.wert !== 0) return;
                        
                        // Summenzeilen â†’ Hauptfelder
                        if(row.ist_summenzeile && row.kontengruppe && gruppenMap[row.kontengruppe]) {
                            var key = gruppenMap[row.kontengruppe];
                            if(parsed[key] === undefined) {
                                parsed[key] = row.wert;
                                matchedRows.push({key: key, label: row.bezeichnung, value: row.wert});
                            }
                        }
                        
                        // Detail-Konten â†’ Unterfelder
                        if(row.konto && kontoMap[row.konto]) {
                            var dKey = kontoMap[row.konto];
                            parsed[dKey] = (parsed[dKey] || 0) + row.wert;
                            matchedRows.push({key: dKey, label: row.bezeichnung, value: row.wert});
                        }
                    });
                }
                
                // Verarbeite Jahres-BWA Daten (nimm den letzten befÃ¼llten Monat)
                if(jahrDaten && jahrDaten.length > 0 && daten.length === 0) {
                    var monatKeys = ['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
                    // Finde letzten Monat mit Daten
                    var lastMonat = 0;
                    jahrDaten.forEach(function(row) {
                        for(var m = 11; m >= 0; m--) {
                            if(row[monatKeys[m]] && row[monatKeys[m]] !== 0 && m+1 > lastMonat) {
                                lastMonat = m+1;
                            }
                        }
                    });
                    if(lastMonat > 0 && !meta.monat) {
                        meta.monat = lastMonat;
                        var mSel2 = document.getElementById('bwaMonth');
                        if(mSel2) { mSel2.value = lastMonat; mSel2.style.borderColor = '#f97316'; mSel2.style.backgroundColor = '#fff7ed'; }
                    }
                    var mKey = lastMonat > 0 ? monatKeys[lastMonat - 1] : null;
                    if(mKey) {
                        jahrDaten.forEach(function(row) {
                            var val = row[mKey];
                            if(!val && val !== 0) return;
                            var bez = (row.bezeichnung || '').toLowerCase();
                            var mapped = null;
                            // Suche in kompakt map
                            var kompaktKeys = Object.keys(BwaParser.KOMPAKT_MAP);
                            for(var i = 0; i < kompaktKeys.length; i++) {
                                if(bez === kompaktKeys[i]) {
                                    var info = BwaParser.KOMPAKT_MAP[kompaktKeys[i]];
                                    if(info.gruppe && gruppenMap[info.gruppe]) {
                                        mapped = gruppenMap[info.gruppe];
                                        break;
                                    }
                                }
                            }
                            if(mapped && !parsed[mapped]) {
                                parsed[mapped] = val;
                                matchedRows.push({key: mapped, label: row.bezeichnung, value: val});
                            }
                        });
                    }
                }

                // Berechne abgeleitete Werte
                if(parsed.rohertrag === undefined && parsed.umsatzerloese !== undefined && parsed.wareneinsatz !== undefined) {
                    parsed.rohertrag = parsed.umsatzerloese + parsed.wareneinsatz;
                }
                if(parsed.gesamtkosten === undefined) {
                    parsed.gesamtkosten = (parsed.personalkosten||0) + (parsed.raumkosten||0) + (parsed.werbekosten||0) + 
                        (parsed.kosten_warenabgabe||0) + (parsed.abschreibungen||0) + (parsed.sonstige_kosten||0);
                }
                if(parsed.betriebsergebnis === undefined && parsed.rohertrag !== undefined) {
                    parsed.betriebsergebnis = parsed.rohertrag + (parsed.gesamtkosten||0);
                }
                if(parsed.ergebnis_vor_steuern === undefined && parsed.betriebsergebnis !== undefined) {
                    parsed.ergebnis_vor_steuern = parsed.betriebsergebnis + (parsed.zinsaufwand||0);
                }

                // ============================================================
                // BWA VALIDIERUNG â€“ PlausibilitÃ¤ts-Check mit Eskalation
                // ============================================================
                var validation = validateParsedBwa(parsed, meta, matchedRows);
                
                statusEl.querySelector('.animate-spin').style.display = 'none';

                if(matchedRows.length === 0) {
                    statusText.textContent = 'âš ï¸ Keine BWA-Felder erkannt (Format: ' + meta.format + ')';
                    resultEl.innerHTML = renderBwaEscalation('critical', meta, [], validation);
                    resultEl.classList.remove('hidden');
                    if(parseBtn) parseBtn.disabled = false;
                    window._lastParsedSummary = null; // Block saving
                    return;
                }

                // Show validation result in status
                var periodInfo = meta.monat && meta.jahr ? ' (' + monatNamen[meta.monat] + ' ' + meta.jahr + ')' : '';
                if(validation.level === 'ok') {
                    statusText.textContent = 'âœ… ' + matchedRows.length + ' Werte erkannt!' + periodInfo + ' [' + meta.format + ']';
                } else if(validation.level === 'warning') {
                    statusText.textContent = 'âš ï¸ ' + matchedRows.length + ' Werte erkannt â€“ PlausibilitÃ¤tsprobleme!' + periodInfo;
                } else {
                    statusText.textContent = 'ðŸš¨ ' + matchedRows.length + ' Werte erkannt â€“ DATEN UNPLAUSIBEL!' + periodInfo;
                }

                // Fill form fields
                var fieldMap = {
                    umsatzerloese: 'bwaF_umsatz',
                    davon_fahrraeder: 'bwaF_fahrraeder',
                    davon_teile: 'bwaF_teile',
                    davon_service: 'bwaF_service',
                    davon_skonti: 'bwaF_skonti',
                    wareneinsatz: 'bwaF_wareneinsatz',
                    personalkosten: 'bwaF_personal',
                    raumkosten: 'bwaF_raum',
                    werbekosten: 'bwaF_werbe',
                    kosten_warenabgabe: 'bwaF_warenabgabe',
                    abschreibungen: 'bwaF_abschreibung',
                    sonstige_kosten: 'bwaF_sonstige',
                    zinsaufwand: 'bwaF_zins'
                };

                var filledCount = 0;
                Object.keys(fieldMap).forEach(function(key) {
                    var val = parsed[key];
                    if(val !== undefined && val !== null) {
                        var el = document.getElementById(fieldMap[key]);
                        if(el) { 
                            el.value = Math.round(val * 100) / 100; 
                            el.style.borderColor = '#f97316'; 
                            el.style.backgroundColor = '#fff7ed'; 
                            filledCount++; 
                        }
                    }
                });

                // Show results with validation
                var umsatz = parsed.umsatzerloese || 0;
                var rohertrag = parsed.rohertrag || 0;
                var rohertragPct = umsatz ? ((rohertrag / umsatz) * 100).toFixed(1) : 0;
                var ergebnis = parsed.ergebnis_vor_steuern || parsed.betriebsergebnis || 0;
                
                var validationHtml = '';
                if(validation.level !== 'ok') {
                    var vBg = validation.level === 'warning' ? 'bg-yellow-50 border-yellow-300' : 'bg-red-50 border-red-300';
                    var vIcon = validation.level === 'warning' ? 'âš ï¸' : 'ðŸš¨';
                    var vColor = validation.level === 'warning' ? 'text-yellow-800' : 'text-red-800';
                    validationHtml = '<div class="' + vBg + ' border rounded-lg p-3 mb-2">';
                    validationHtml += '<p class="text-xs font-bold ' + vColor + ' mb-1">' + vIcon + ' PlausibilitÃ¤ts-Check</p>';
                    validation.issues.forEach(function(issue) {
                        var iIcon = issue.severity === 'error' ? 'âŒ' : 'âš¡';
                        validationHtml += '<p class="text-[11px] ' + vColor + '">' + iIcon + ' ' + issue.message + '</p>';
                    });
                    if(validation.level === 'critical') {
                        validationHtml += '<p class="text-[11px] font-semibold text-red-700 mt-2">â†’ Speichern blockiert. Bitte Datei prÃ¼fen oder Werte manuell korrigieren.</p>';
                        validationHtml += '<button onclick="window._bwaForceOverride=true;document.getElementById(\'bwaSaveBtn\').disabled=false;this.parentElement.style.opacity=0.5;this.textContent=\'Override aktiv\';this.disabled=true;" class="mt-2 px-3 py-1 bg-red-100 text-red-700 text-[10px] font-semibold rounded hover:bg-red-200">ðŸ”“ Trotzdem speichern (auf eigenes Risiko)</button>';
                    }
                    validationHtml += '</div>';
                }

                resultEl.innerHTML = validationHtml
                    + '<div class="' + (validation.level === 'ok' ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200') + ' border rounded-lg p-3">'
                    + '<p class="text-xs font-semibold ' + (validation.level === 'ok' ? 'text-green-700' : 'text-gray-700') + ' mb-2">'
                    + (validation.level === 'ok' ? 'âœ…' : 'ðŸ“Š') + ' ' + filledCount + ' Werte erkannt Â· Format: <code>' + meta.format + '</code>'
                    + (validation.level === 'ok' ? ' Â· <span class="text-green-600">Plausibel âœ“</span>' : '') + '</p>'
                    + '<div class="grid grid-cols-3 gap-2 text-xs">'
                    + '<div><span class="text-gray-500">Umsatz:</span><br><strong>' + umsatz.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                    + '<div><span class="text-gray-500">Rohertrag:</span><br><strong>' + rohertragPct + '%</strong></div>'
                    + '<div><span class="text-gray-500">Ergebnis:</span><br><strong class="' + (ergebnis >= 0 ? 'text-green-600' : 'text-red-600') + '">' + ergebnis.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                    + '</div>'
                    + '<details class="mt-2"><summary class="text-[10px] text-gray-400 cursor-pointer">Erkannte Zuordnungen (' + matchedRows.length + ')</summary>'
                    + '<div class="mt-1 space-y-0.5 max-h-40 overflow-y-auto">' + matchedRows.map(function(m) { 
                        return '<div class="text-[10px] text-gray-500"><span class="text-gray-700">"' + m.label + '"</span> â†’ <strong>' + m.key + '</strong> = ' + (typeof m.value === 'number' ? m.value.toLocaleString('de-DE') : m.value) + '</div>'; 
                    }).join('') + '</div></details>'
                    + '</div>';
                resultEl.classList.remove('hidden');
                
                // Store detail data for saveBwaData()
                window._lastParsedDetails = daten && daten.length > 0 ? daten : [];
                window._lastParsedFormat = meta.format;
                window._lastParsedSummary = parsed;
                window._lastValidation = validation;
                window._bwaForceOverride = false;
                
                // === SELF-HEALING: Bei critical â†’ KI-Retry-Loop starten ===
                if(validation.level === 'critical') {
                    var saveBtn = document.getElementById('bwaSaveBtn');
                    if(saveBtn) { saveBtn.disabled = true; saveBtn.title = 'KI-Analyse lÃ¤uft...'; }
                    
                    // Rohdaten fÃ¼r KI vorbereiten
                    var rawData = window._bwaRawSheetData; // set during XLSX parse
                    if(rawData && rawData.length > 0) {
                        bwaAiRetryLoop(rawData, meta, validation, parsed, statusText, resultEl, parseBtn);
                        return; // UI wird vom retry loop aktualisiert
                    }
                }
                
                if(parseBtn) parseBtn.disabled = false;
            });
        }

        // =====================================================================
        // BWA SELF-HEALING â€“ KI-gestÃ¼tzte Datenextraktion mit Retry-Loop
        // =====================================================================
        // Wenn der regelbasierte Parser versagt, analysiert Claude die Rohdaten.
        // Max 5 Versuche. Danach â†’ HQ-Ticket.
        
        async function bwaAiRetryLoop(rawData, meta, initialValidation, initialParsed, statusText, resultEl, parseBtn) {
            var MAX_RETRIES = 3;
            var attempt = 0;
            var lastValidation = initialValidation;
            var lastParsed = initialParsed;
            
            // Prepare compact raw data (max 80 rows to stay within token limits)
            var compactRaw = rawData.slice(0, 80).map(function(row, idx) {
                var cells = {};
                Object.keys(row).forEach(function(k) {
                    if(row[k] !== null && row[k] !== undefined && row[k] !== '') cells[k] = row[k];
                });
                return cells;
            }).filter(function(r) { return Object.keys(r).length > 0; });
            
            var issueDesc = lastValidation.issues.map(function(i) { return i.code + ': ' + i.message; }).join('\n');
            
            statusText.textContent = 'ðŸ¤– KI-Analyse gestartet (Versuch 1/' + MAX_RETRIES + ')...';
            
            while(attempt < MAX_RETRIES) {
                attempt++;
                statusText.textContent = 'ðŸ¤– KI analysiert Rohdaten (Versuch ' + attempt + '/' + MAX_RETRIES + ')...';
                
                try {
                    var aiResult = await callBwaAiExtraction(compactRaw, meta, issueDesc, attempt);
                    
                    if(aiResult && aiResult.umsatzerloese !== undefined) {
                        // Validate AI result
                        var aiValidation = validateParsedBwa(aiResult, meta, []);
                        
                        if(aiValidation.level === 'ok' || aiValidation.level === 'warning') {
                            // SUCCESS! Fill form with AI-extracted values
                            statusText.textContent = 'âœ… KI hat plausible Werte extrahiert! (Versuch ' + attempt + ')';
                            applyAiResultToForm(aiResult);
                            window._lastParsedSummary = aiResult;
                            window._lastValidation = aiValidation;
                            
                            renderBwaAiSuccess(resultEl, aiResult, aiValidation, attempt, meta);
                            
                            var saveBtn = document.getElementById('bwaSaveBtn');
                            if(saveBtn) { saveBtn.disabled = false; saveBtn.title = ''; }
                            if(parseBtn) parseBtn.disabled = false;
                            return; // Done!
                        } else {
                            // AI result also failed validation
                            issueDesc = aiValidation.issues.map(function(i) { return i.code + ': ' + i.message; }).join('\n');
                            lastValidation = aiValidation;
                            lastParsed = aiResult;
                            console.warn('[BWA AI] Versuch ' + attempt + ' fehlgeschlagen, issues:', aiValidation.issues.map(function(i){return i.code;}).join(', '));
                        }
                    } else {
                        console.warn('[BWA AI] Versuch ' + attempt + ': Keine gÃ¼ltigen Daten von KI erhalten');
                        issueDesc += '\nKI-Versuch ' + attempt + ' lieferte keine verwertbaren Daten.';
                    }
                } catch(aiErr) {
                    console.error('[BWA AI] Versuch ' + attempt + ' Error:', aiErr);
                    issueDesc += '\nKI-Fehler: ' + (aiErr.message || 'Unbekannt');
                }
            }
            
            // All retries failed â†’ User must enter manually
            statusText.textContent = 'âš ï¸ Bitte Werte manuell eingeben';
            renderBwaEscalationFinal(resultEl, meta, lastValidation, MAX_RETRIES);
            
            // Allow manual entry
            var saveBtn = document.getElementById('bwaSaveBtn');
            if(saveBtn) { saveBtn.disabled = false; saveBtn.title = 'Manuelle Eingabe mÃ¶glich'; }
            if(parseBtn) parseBtn.disabled = false;
        }
        
        // Call Claude API to extract BWA values from raw sheet data
        async function callBwaAiExtraction(rawRows, meta, errorContext, attempt) {
            var systemPrompt = 'Du bist ein BWA-Datenexperte. Du bekommst Rohdaten aus einer Excel-BWA-Datei als JSON.\n'
                + 'Extrahiere die monatlichen BWA-Kennzahlen und gib NUR ein JSON-Objekt zurÃ¼ck.\n'
                + 'Alle Werte in Euro. Kosten/Aufwand als NEGATIVE Zahlen.\n'
                + 'WICHTIG: Unterscheide zwischen Monatswerten und kumulierten Jahreswerten. Wir brauchen die MONATSWERTE.\n'
                + 'Antworte NUR mit dem JSON, keine ErklÃ¤rung, keine Markdown-Backticks.';
            
            var userPrompt = 'BWA-Datei: ' + (meta.dateiname || 'unbekannt') + '\n'
                + 'Erkanntes Format: ' + meta.format + '\n'
                + 'Erwarteter Monat: ' + (meta.monat ? monatNamen[meta.monat] : '?') + ' ' + (meta.jahr || '?') + '\n\n';
            
            if(errorContext) {
                userPrompt += 'BISHERIGE PROBLEME:\n' + errorContext + '\n\n';
            }
            
            if(attempt > 1) {
                userPrompt += 'Dies ist Versuch ' + attempt + '. Der vorherige Versuch hat nicht plausible Werte geliefert. '
                    + 'Bitte analysiere die Spaltenstruktur besonders sorgfÃ¤ltig. '
                    + 'Achte auf: Welche Spalte enthÃ¤lt Monatswerte vs. kumulierte Werte vs. Prozentwerte?\n\n';
            }
            
            userPrompt += 'ROHDATEN (Zeilen mit Spalten A,B,C,... als JSON):\n' + JSON.stringify(rawRows, null, 0) + '\n\n'
                + 'Extrahiere folgende Felder als JSON-Objekt:\n'
                + '{"umsatzerloese": number, "wareneinsatz": number (negativ!), "rohertrag": number, '
                + '"personalkosten": number (negativ), "raumkosten": number (negativ), "werbekosten": number (negativ), '
                + '"kosten_warenabgabe": number (negativ), "abschreibungen": number (negativ), '
                + '"sonstige_kosten": number (negativ), "gesamtkosten": number (negativ), '
                + '"betriebsergebnis": number, "zinsaufwand": number (negativ), "ergebnis_vor_steuern": number, '
                + '"fahrzeugkosten": number (negativ), "versicherungen": number (negativ), "instandhaltung": number (negativ)}';
            
            var response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            
            var data = await response.json();
            var text = (data.content || []).map(function(b) { return b.text || ''; }).join('');
            
            // Parse JSON from response (strip any markdown fences)
            text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
            console.log('[BWA AI] Raw response:', text.substring(0, 300));
            
            var result = JSON.parse(text);
            return result;
        }
        
        // Apply AI-extracted values to form fields
        function applyAiResultToForm(aiResult) {
            var fieldMap = {
                umsatzerloese: 'bwaF_umsatz', wareneinsatz: 'bwaF_wareneinsatz',
                personalkosten: 'bwaF_personal', raumkosten: 'bwaF_raum',
                werbekosten: 'bwaF_werbe', kosten_warenabgabe: 'bwaF_warenabgabe',
                abschreibungen: 'bwaF_abschreibung', sonstige_kosten: 'bwaF_sonstige',
                zinsaufwand: 'bwaF_zins'
            };
            Object.keys(fieldMap).forEach(function(key) {
                var val = aiResult[key];
                if(val !== undefined && val !== null) {
                    var el = document.getElementById(fieldMap[key]);
                    if(el) {
                        el.value = Math.round(val * 100) / 100;
                        el.style.borderColor = '#8b5cf6';
                        el.style.backgroundColor = '#f5f3ff';
                    }
                }
            });
        }
        
        // Render success UI after AI extraction
        function renderBwaAiSuccess(resultEl, aiResult, validation, attempt, meta) {
            var u = aiResult.umsatzerloese || 0;
            var r = aiResult.rohertrag || 0;
            var e = aiResult.ergebnis_vor_steuern || 0;
            var marge = u ? ((r / u) * 100).toFixed(1) : 0;
            
            var warnHtml = '';
            if(validation.level === 'warning') {
                warnHtml = '<div class="bg-yellow-50 border border-yellow-200 rounded p-2 mb-2">';
                validation.issues.forEach(function(i) {
                    warnHtml += '<p class="text-[10px] text-yellow-700">âš¡ ' + i.message + '</p>';
                });
                warnHtml += '</div>';
            }
            
            resultEl.innerHTML = '<div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3">'
                + '<p class="text-xs font-bold text-purple-800 mb-2">ðŸ¤– KI-Extraktion erfolgreich (Versuch ' + attempt + ')</p>'
                + '<p class="text-[10px] text-purple-600 mb-2">Claude hat die Rohdaten analysiert und plausible Werte extrahiert.</p>'
                + warnHtml
                + '<div class="grid grid-cols-4 gap-2 text-xs">'
                + '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Umsatz</span><br><strong>' + u.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                + '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Rohertrag</span><br><strong>' + marge + '%</strong></div>'
                + '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Gesamtkosten</span><br><strong>' + (aiResult.gesamtkosten || 0).toLocaleString('de-DE') + ' â‚¬</strong></div>'
                + '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Ergebnis</span><br><strong class="' + (e >= 0 ? 'text-green-600' : 'text-red-600') + '">' + e.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                + '</div>'
                + '<p class="text-[10px] text-purple-400 mt-2">Format: ' + meta.format + ' Â· Felder sind lila markiert (ðŸ¤– = KI-extrahiert). Bitte vor dem Speichern prÃ¼fen.</p>'
                + '</div>';
            resultEl.classList.remove('hidden');
        }
        
        // Render final escalation after all retries failed - USER must enter data manually
        function renderBwaEscalationFinal(resultEl, meta, validation, attempts) {
            var html = '<div class="bg-amber-50 border-2 border-amber-400 rounded-lg p-4">';
            html += '<p class="text-sm font-bold text-amber-800 mb-2">âš ï¸ Automatische Erkennung nicht mÃ¶glich</p>';
            html += '<p class="text-xs text-amber-700 mb-3">Nach ' + attempts + ' KI-Versuchen konnten keine plausiblen Werte extrahiert werden. Das kann an einem ungewÃ¶hnlichen Format deiner BWA liegen.</p>';
            
            html += '<div class="bg-white rounded-lg p-3 mb-3 border border-amber-200">';
            html += '<p class="text-xs font-bold text-gray-800 mb-2">ðŸ‘‡ Bitte trage die Werte manuell ein:</p>';
            html += '<ol class="text-xs text-gray-600 space-y-1.5 list-decimal pl-4">';
            html += '<li>Ã–ffne deine BWA-Datei in Excel</li>';
            html += '<li>Ãœbertrage die <strong>Monatswerte</strong> in die Felder unten (Umsatz, Wareneinsatz, Personalkosten, ...)</li>';
            html += '<li>Klicke auf <strong>"BWA speichern"</strong></li>';
            html += '</ol></div>';
            
            html += '<div class="bg-blue-50 rounded p-2 mb-2">';
            html += '<p class="text-[11px] text-blue-700">ðŸ’¡ <strong>Tipp:</strong> Achte darauf, dass Kosten als <strong>negative Zahlen</strong> eingetragen werden (z.B. Wareneinsatz: -85000)</p>';
            html += '</div>';
            
            if(validation && validation.issues.length > 0) {
                html += '<details><summary class="text-[10px] text-amber-500 cursor-pointer">Technische Details fÃ¼r Support (' + validation.issues.length + ' Issues)</summary>';
                html += '<div class="mt-1 bg-amber-100 rounded p-2 text-[10px] text-amber-800 font-mono">';
                html += 'Datei: ' + (meta.dateiname || '-') + '<br>';
                html += 'Format: ' + meta.format + '<br>';
                html += 'KI-Versuche: ' + attempts + '<br>';
                validation.issues.forEach(function(i) { html += i.code + ': ' + i.message + '<br>'; });
                html += '</div></details>';
            }
            html += '</div>';
            
            resultEl.innerHTML = html;
            resultEl.classList.remove('hidden');
        }
        
        function closeBwaUploadModal() { var c = document.getElementById('bwaUploadContainer'); if(c) c.remove(); }

        async function saveBwaData() {
            var month = parseInt(document.getElementById('bwaMonth').value);
            var year = parseInt(document.getElementById('bwaYear').value);
            var errEl = document.getElementById('bwaUploadError');
            var btn = document.getElementById('bwaSaveBtn');
            var v = function(id) { return parseFloat((document.getElementById(id)||{}).value) || 0; };
            var p = window._lastParsedSummary || {};

            // === DUPLIKAT-CHECK: Existiert bereits eine BWA fÃ¼r diesen Monat? ===
            if(!window._bwaDuplicateConfirmed) {
                try {
                    var stdId = sbProfile ? sbProfile.standort_id : null;
                    var existing = await sb.from('bwa_daten').select('id,umsatzerloese,rohertrag,ergebnis_vor_steuern,updated_at').eq('standort_id', stdId).eq('monat', month).eq('jahr', year).maybeSingle();
                    if(existing.data) {
                        var exU = (existing.data.umsatzerloese || 0);
                        var exR = (existing.data.rohertrag || 0);
                        var exE = (existing.data.ergebnis_vor_steuern || 0);
                        var exDate = existing.data.updated_at ? new Date(existing.data.updated_at).toLocaleDateString('de-DE') : '?';
                        
                        // Show inline confirmation instead of browser confirm()
                        if(errEl) {
                            errEl.innerHTML = '<div class="bg-amber-50 border border-amber-300 rounded-lg p-3">'
                                + '<p class="text-xs font-bold text-amber-800 mb-1">âš ï¸ FÃ¼r ' + monatNamen[month] + ' ' + year + ' existiert bereits eine BWA</p>'
                                + '<div class="grid grid-cols-3 gap-2 text-[11px] text-amber-700 mb-2">'
                                + '<div>Umsatz: <strong>' + exU.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                                + '<div>Rohertrag: <strong>' + exR.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                                + '<div>Ergebnis: <strong>' + exE.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                                + '</div>'
                                + '<p class="text-[10px] text-amber-600 mb-2">Zuletzt aktualisiert: ' + exDate + '</p>'
                                + '<div class="flex gap-2">'
                                + '<button onclick="window._bwaDuplicateConfirmed=true;saveBwaData();" class="px-3 py-1.5 bg-amber-500 text-white text-xs font-semibold rounded hover:bg-amber-600">âœ… Ãœberschreiben</button>'
                                + '<button onclick="document.getElementById(\'bwaUploadError\').style.display=\'none\';" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-semibold rounded hover:bg-gray-300">Abbrechen</button>'
                                + '</div></div>';
                            errEl.style.display = 'block';
                        }
                        return;
                    }
                } catch(dupErr) {
                    console.warn('[BWA] Duplicate check failed:', dupErr.message);
                    // Continue saving if check fails
                }
            }
            window._bwaDuplicateConfirmed = false; // Reset for next save

            // Use parsed values if available, otherwise form fields
            // IMPORTANT: use !== undefined check because 0 is a valid value (|| would skip 0)
            var pv = function(key, formId) { return (p[key] !== undefined && p[key] !== null) ? p[key] : v(formId); };
            var umsatz = pv('umsatzerloese', 'bwaF_umsatz');
            var wareneinsatz = pv('wareneinsatz', 'bwaF_wareneinsatz');
            var rohertrag = (p.rohertrag !== undefined && p.rohertrag !== null) ? p.rohertrag : (umsatz + wareneinsatz);
            var personal = pv('personalkosten', 'bwaF_personal');
            var raum = pv('raumkosten', 'bwaF_raum');
            var werbe = pv('werbekosten', 'bwaF_werbe');
            var warenabgabe = pv('kosten_warenabgabe', 'bwaF_warenabgabe');
            var abschreibung = pv('abschreibungen', 'bwaF_abschreibung');
            var sonstige = pv('sonstige_kosten', 'bwaF_sonstige');
            var gesamtkosten = (p.gesamtkosten !== undefined && p.gesamtkosten !== null) ? p.gesamtkosten : (personal + raum + werbe + warenabgabe + abschreibung + sonstige);
            var betriebsergebnis = (p.betriebsergebnis !== undefined && p.betriebsergebnis !== null) ? p.betriebsergebnis : (rohertrag + gesamtkosten);
            var zins = pv('zinsaufwand', 'bwaF_zins');
            var ergebnis = (p.ergebnis_vor_steuern !== undefined && p.ergebnis_vor_steuern !== null) ? p.ergebnis_vor_steuern : ((p.vorlaefiges_ergebnis !== undefined && p.vorlaefiges_ergebnis !== null) ? p.vorlaefiges_ergebnis : (betriebsergebnis + zins));
            var fahrzeugkosten = (p.fahrzeugkosten !== undefined && p.fahrzeugkosten !== null) ? p.fahrzeugkosten : 0;
            var versicherungen = (p.versicherungen !== undefined && p.versicherungen !== null) ? p.versicherungen : 0;
            var instandhaltung = (p.instandhaltung !== undefined && p.instandhaltung !== null) ? p.instandhaltung : 0;

            if(!umsatz && !wareneinsatz) { if(errEl){errEl.textContent='Bitte mindestens Umsatz oder Wareneinsatz eingeben.';errEl.style.display='block';} return; }
            if(umsatz === 0 && !window._lastParsedSummary) { if(errEl){errEl.textContent='Bitte zuerst eine BWA-Datei hochladen und analysieren lassen.';errEl.style.display='block';} return; }

            // PlausibilitÃ¤ts-Check vor dem Speichern
            var saveValidation = window._lastValidation;
            if(saveValidation && saveValidation.level === 'critical' && !window._bwaForceOverride) {
                if(errEl){errEl.textContent='âš ï¸ PlausibilitÃ¤ts-Check fehlgeschlagen: ' + saveValidation.issues.map(function(i){return i.message;}).join('; ');errEl.style.display='block';}
                return;
            }
            // Quick sanity check even without prior validation
            if(umsatz > 0 && rohertrag > umsatz * 1.5) {
                if(!confirm('âš ï¸ Rohertrag (' + eur(rohertrag) + 'â‚¬) ist deutlich hÃ¶her als Umsatz (' + eur(umsatz) + 'â‚¬). Das ist ungewÃ¶hnlich.\n\nTrotzdem speichern?')) return;
            }
            if(umsatz > 0 && Math.abs(ergebnis) > umsatz * 2) {
                if(!confirm('âš ï¸ Ergebnis (' + eur(ergebnis) + 'â‚¬) ist extrem hoch im VerhÃ¤ltnis zum Umsatz (' + eur(umsatz) + 'â‚¬).\n\nTrotzdem speichern?')) return;
            }

            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;

                // Upload file if selected (optional - ignore errors)
                var fileUrl = null;
                var fileName = null;
                var fileInput = document.getElementById('bwaFileInput');
                if(fileInput && fileInput.files && fileInput.files[0]) {
                    var file = fileInput.files[0];
                    fileName = file.name;
                    try {
                        var path = (stdId||'hq')+'/'+year+'/'+month+'_'+file.name;
                        var upResp = await sb.storage.from('bwa-dateien').upload(path, file, {upsert:true});
                        if(upResp.error) console.warn('File upload skipped:', upResp.error.message);
                        else fileUrl = path;
                    } catch(uploadErr) {
                        console.warn('File upload skipped:', uploadErr.message || uploadErr);
                    }
                }

                var data = {
                    standort_id: stdId,
                    monat: month,
                    jahr: year,
                    umsatzerloese: umsatz,
                    davon_fahrraeder: p.davon_fahrraeder || v('bwaF_fahrraeder'),
                    davon_teile: p.davon_teile || v('bwaF_teile'),
                    davon_service: p.davon_service || v('bwaF_service'),
                    davon_skonti: p.davon_skonti || v('bwaF_skonti'),
                    wareneinsatz: wareneinsatz,
                    rohertrag: rohertrag,
                    personalkosten: personal,
                    miete: raum,
                    werbung_marketing: werbe,
                    kosten_warenabgabe: warenabgabe,
                    abschreibungen: abschreibung,
                    fahrzeugkosten: fahrzeugkosten,
                    versicherungen: versicherungen,
                    reparaturen_instandhaltung: instandhaltung,
                    sonstige_kosten: sonstige,
                    gesamtkosten: gesamtkosten,
                    betriebsergebnis: betriebsergebnis,
                    zinsen: zins,
                    ergebnis_vor_steuern: ergebnis,
                    plan_umsatz: v('bwaF_planUmsatz'),
                    plan_wareneinsatz: v('bwaF_planWareneinsatz'),
                    plan_rohertrag: v('bwaF_planRohertrag'),
                    plan_personalkosten: v('bwaF_planPersonal'),
                    plan_raumkosten: v('bwaF_planRaum'),
                    plan_werbekosten: v('bwaF_planWerbe'),
                    plan_gesamtkosten: v('bwaF_planGesamt'),
                    plan_ergebnis: v('bwaF_planErgebnis'),
                    format: window._lastParsedFormat || null,
                    hochgeladen_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                if(fileUrl) { data.datei_url = fileUrl; }
                if(fileName) { data.datei_name = fileName; }

                var resp = await sb.from('bwa_daten').upsert(data, {onConflict:'standort_id,monat,jahr'}).select();
                console.log('[BWA] upsert response:', resp);
                if(resp.error) throw resp.error;
                var bwaId = resp.data && resp.data[0] ? resp.data[0].id : null;

                // Detail-Positionen speichern (wenn vom Parser vorhanden)
                if(bwaId && window._lastParsedDetails && window._lastParsedDetails.length > 0) {
                    // Alte Details lÃ¶schen
                    await sb.from('bwa_detail_positionen').delete().eq('bwa_id', bwaId);
                    // Neue Details in Batches speichern
                    var details = window._lastParsedDetails.map(function(d) {
                        return {
                            bwa_id: bwaId,
                            standort_id: stdId,
                            jahr: year,
                            monat: month,
                            zeile: d.zeile || null,
                            konto: d.konto || null,
                            kontengruppe: d.kontengruppe || null,
                            bezeichnung: d.bezeichnung,
                            wert: d.wert,
                            wert_kumuliert: d.wert_kumuliert || null,
                            wert_vorjahr: d.wert_vorjahr || null,
                            prozent_gesamtleistung: d.prozent_gesamtleistung || null,
                            ist_summenzeile: d.ist_summenzeile || false,
                            ebene: d.ebene || 0,
                            sortierung: d.sortierung || 0,
                            format: window._lastParsedFormat || null
                        };
                    });
                    // Batch insert (max 500 per request)
                    for(var bi = 0; bi < details.length; bi += 500) {
                        var batch = details.slice(bi, bi + 500);
                        var detResp = await sb.from('bwa_detail_positionen').insert(batch);
                        if(detResp.error) console.warn('Detail insert batch error:', detResp.error);
                    }
                    console.log('âœ… ' + details.length + ' Detail-Positionen gespeichert');
                }

                // Cleanup temp vars
                window._lastParsedDetails = null;
                window._lastParsedFormat = null;
                window._lastParsedSummary = null;
                window._lastValidation = null;
                window._bwaForceOverride = false;

                closeBwaUploadModal();
                await loadBwaList();
                if(bwaId) showBwaFromDb(bwaId);
                alert('âœ… BWA '+monatNamen[month]+' '+year+' gespeichert!');
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='BWA speichern'; }
            }
        }

        // === PLAN / IST SYSTEM ===
        var currentPlan = null; // { jahr, monate: [{monat, umsatz, wareneinsatz, personal, raum, werbe, abschreibung, sonstige, zins, ...}] }
        var planIstYear = new Date().getFullYear();

        async function renderPlanIst() {
            var el = document.getElementById('planIstContent');
            if(!el) return;

            // Try load plan from DB
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                if(stdId) {
                    var resp = await sb.from('jahresplaene').select('*').eq('jahr', planIstYear).eq('standort_id', stdId).maybeSingle();
                    if(!resp.error && resp.data) {
                        currentPlan = resp.data;
                    }
                }
            } catch(e) { /* no plan yet or table does not exist */ }

            if(!currentPlan || !currentPlan.plan_daten) {
                renderPlanUploadScreen(el);
            } else {
                await renderPlanVergleich(el);
            }
        }

        function renderPlanUploadScreen(el) {
            var h = '';
            h += '<div class="text-center py-8">';
            h += '<div class="max-w-lg mx-auto">';
            h += '<div class="text-6xl mb-4">ðŸ“‹</div>';
            h += '<h2 class="text-xl font-bold text-gray-800 mb-2">Jahresplan '+planIstYear+' hochladen</h2>';
            h += '<p class="text-sm text-gray-500 mb-6">Um den Plan/Ist-Vergleich nutzen zu kÃ¶nnen, lade zuerst deinen Jahresplan als Excel-Datei hoch. Das Portal liest die monatlichen Plan-Werte automatisch aus.</p>';
            h += '<div class="vit-card p-6 text-left">';
            h += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Schritt 1: Plan-Datei hochladen</p>';
            h += '<div class="p-4 border-2 border-dashed border-vit-orange/40 rounded-lg bg-orange-50/50 mb-4">';
            h += '<p class="text-xs text-gray-500 mb-2">Erwartetes Format: Excel mit Monatszeilen und Spalten fÃ¼r Umsatz, Wareneinsatz, Personalkosten, etc.</p>';
            h += '<input type="file" id="planFileInput" accept=".xlsx,.xls,.csv" class="text-xs" onchange="document.getElementById(\'planParseBtn\').disabled=!this.files.length">';
            h += '</div>';
            h += '<button id="planParseBtn" onclick="parsePlanFile()" disabled class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed mb-3">ðŸ“Š Plan auslesen & speichern</button>';
            h += '<div id="planParseStatus" class="hidden"></div>';
            h += '<div id="planParseResult" class="hidden"></div>';
            h += '</div>';
            // Manual entry option
            h += '<details class="vit-card p-6 text-left mt-4"><summary class="text-xs font-semibold text-gray-500 cursor-pointer">Alternativ: Plan manuell eingeben</summary>';
            h += '<div class="mt-4 space-y-2">';
            var mNamen = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            for(var m=1;m<=12;m++) {
                h += '<div class="flex items-center space-x-2"><label class="text-xs text-gray-600 w-24 flex-shrink-0">'+mNamen[m]+'</label>';
                h += '<input id="planM_umsatz_'+m+'" type="number" placeholder="Umsatz" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_we_'+m+'" type="number" placeholder="Wareneins." class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_pk_'+m+'" type="number" placeholder="Personal" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_rk_'+m+'" type="number" placeholder="Raum" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '</div>';
            }
            h += '<button onclick="saveManualPlan()" class="w-full mt-3 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Plan speichern</button>';
            h += '</div></details>';
            h += '</div></div>';
            el.innerHTML = h;
        }

        async function parsePlanFile() {
            var fileInput = document.getElementById('planFileInput');
            if(!fileInput || !fileInput.files[0]) return;
            var file = fileInput.files[0];
            var statusEl = document.getElementById('planParseStatus');
            var resultEl = document.getElementById('planParseResult');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="flex items-center space-x-2 mt-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600">Excel wird analysiert...</span></div>';

            try {
                var arrayBuf = await file.arrayBuffer();
                var wb = XLSX.read(arrayBuf, { type: 'array', cellDates: true });

                // 1. Find BWA sheet (most important for plan values)
                var bwaSheetName = null;
                var umsatzSheetName = null;
                var personalSheetName = null;
                wb.SheetNames.forEach(function(sn) {
                    var sl = sn.toLowerCase();
                    if(sl.includes('bwa')) bwaSheetName = sn;
                    if(sl.includes('umsÃ¤tze') || sl.includes('umsaetze') || sl.includes('umsÃ¤tze')) umsatzSheetName = sn;
                    if(sl.includes('personal')) personalSheetName = sn;
                });

                console.log('[Plan Parser] Sheets:', wb.SheetNames, 'BWA:', bwaSheetName, 'UmsÃ¤tze:', umsatzSheetName);

                if(!bwaSheetName) {
                    // Fallback: try first sheet
                    bwaSheetName = wb.SheetNames[0];
                    console.log('[Plan Parser] No BWA sheet found, using first:', bwaSheetName);
                }

                var ws = wb.Sheets[bwaSheetName];
                var rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null, raw: true });

                // 2. Find plan year columns - supports 3 formats:
                //    A) Standard: R3=year, R4=Date(year-01-01), 12 monthly columns
                //    B) Compact: Plan starts at col 5, R3=year, only plan year (no IST)
                //    C) Yearly total: R4="Plan 2026" single column + seasonal % in R1
                var planStartCol = -1;
                var planYear = planIstYear;
                var planFormat = null; // 'monthly' | 'yearly_total'
                var seasonalPcts = null;
                var yearlyTotalCol = -1;

                var r1 = rows[0] || [];
                var r2 = rows[1] || [];
                var r3 = rows[2] || [];
                var r4 = rows[3] || [];

                // Helper: extract year from any value (number, Date, string, serial)
                function extractYear(v) {
                    if(v === null || v === undefined) return 0;
                    if(typeof v === 'number' && v >= 2020 && v <= 2035) return v;
                    if(v instanceof Date) return v.getFullYear();
                    if(typeof v === 'string') {
                        var m = v.match(/(20\d{2})/);
                        if(m) return parseInt(m[1]);
                    }
                    return 0;
                }
                // Helper: check if value represents January of a given year
                function isJanOfYear(v, yr) {
                    if(!v) return false;
                    if(v instanceof Date) return v.getMonth() === 0 && v.getFullYear() == yr;
                    if(typeof v === 'number' && v > 40000) {
                        // Excel serial date: convert to JS date
                        var d = new Date((v - 25569) * 86400000);
                        return d.getMonth() === 0 && d.getFullYear() == yr;
                    }
                    if(typeof v === 'string') {
                        return (v.includes(String(yr)) && (v.includes('01-01') || v.includes('Jan') || v.includes('jan')));
                    }
                    return false;
                }

                console.log('[Plan Parser] R3 sample:', JSON.stringify(r3.slice(0, 50).map(function(v,i) { return v !== null ? i+':'+typeof v+'='+v : null; }).filter(Boolean)));
                console.log('[Plan Parser] R4 sample:', JSON.stringify(r4.slice(0, 50).map(function(v,i) { return v !== null ? i+':'+typeof v+'='+(v instanceof Date ? v.toISOString() : v) : null; }).filter(Boolean)));

                // Strategy A+B: scan for column where R3 = planYear and R4 is Jan of that year
                for(var c = 0; c < Math.max(r3.length, r4.length); c++) {
                    var yr = extractYear(r3[c]);
                    if(yr == planYear) {
                        if(isJanOfYear(r4[c], planYear)) {
                            planStartCol = c;
                            planFormat = 'monthly';
                            console.log('[Plan Parser] Format A/B: R3 year + R4 date match at col ' + c);
                            break;
                        }
                        // R3 has year but R4 doesn't look like a date - check if R4 has 'Jan' text
                        var r4v = String(r4[c] || '').toLowerCase();
                        if(r4v.startsWith('jan') || r4v.includes('januar')) {
                            planStartCol = c;
                            planFormat = 'monthly';
                            console.log('[Plan Parser] Format A/B: R3 year + R4 Jan text at col ' + c);
                            break;
                        }
                    }
                }

                // Fallback: scan R4 for dates with planYear anywhere (R3 might be empty)
                if(planStartCol < 0) {
                    for(var c2 = 0; c2 < r4.length; c2++) {
                        if(isJanOfYear(r4[c2], planYear)) {
                            planStartCol = c2;
                            planFormat = 'monthly';
                            console.log('[Plan Parser] Fallback: R4 date match at col ' + c2);
                            break;
                        }
                    }
                }

                // Fallback 2: scan ALL header rows (R1-R4) for year + any adjacent Jan indicator
                if(planStartCol < 0) {
                    for(var c2b = 0; c2b < Math.max(r1.length, r2.length, r3.length, r4.length); c2b++) {
                        for(var ri = 0; ri < 4; ri++) {
                            var rv = [r1, r2, r3, r4][ri][c2b];
                            if(extractYear(rv) == planYear) {
                                // Check neighboring header rows for Jan date
                                for(var ri2 = 0; ri2 < 4; ri2++) {
                                    if(isJanOfYear([r1, r2, r3, r4][ri2][c2b], planYear)) {
                                        planStartCol = c2b;
                                        planFormat = 'monthly';
                                        console.log('[Plan Parser] Deep fallback: year in R' + (ri+1) + ' + date in R' + (ri2+1) + ' at col ' + c2b);
                                        break;
                                    }
                                }
                                if(planStartCol >= 0) break;
                            }
                        }
                        if(planStartCol >= 0) break;
                    }
                }

                // Strategy C: scan R4 for "Plan 2026" text in a single column
                if(planStartCol < 0) {
                    for(var c3 = 0; c3 < r4.length; c3++) {
                        var txt = String(r4[c3] || '');
                        if(txt.toLowerCase().includes('plan') && txt.includes(String(planYear))) {
                            yearlyTotalCol = c3;
                            planFormat = 'yearly_total';
                            console.log('[Plan Parser] Format C: Found yearly total "Plan ' + planYear + '" at col ' + c3);
                            // Look for seasonal distribution in R1 (sum should be ~1.0)
                            // Find 12 consecutive percentage values in R1
                            for(var sc = 0; sc < r1.length - 11; sc++) {
                                var pctSum = 0;
                                var pcts = [];
                                var allNum = true;
                                for(var si = 0; si < 12; si++) {
                                    var pv = r1[sc + si];
                                    if(typeof pv === 'number' && pv > 0 && pv < 1) {
                                        pcts.push(pv);
                                        pctSum += pv;
                                    } else { allNum = false; break; }
                                }
                                if(allNum && pctSum > 0.95 && pctSum < 1.05) {
                                    seasonalPcts = pcts;
                                    console.log('[Plan Parser] Found seasonal distribution at R1 cols ' + sc + '-' + (sc + 11) + ', sum=' + pctSum.toFixed(4));
                                    break;
                                }
                            }
                            break;
                        }
                    }
                }

                if(planStartCol < 0 && yearlyTotalCol < 0) {
                    statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Keine Plan-Spalten fÃ¼r ' + planYear + ' gefunden. Bitte prÃ¼fe ob die Datei Planwerte fÃ¼r ' + planYear + ' enthÃ¤lt.</p>';
                    // Try AI fallback
                    var rawJson = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, raw: true });
                    startPlanAiFallback(rawJson, file.name, statusEl, resultEl);
                    return;
                }

                // 3. Find key BWA rows by scanning Kontengruppe column (typically col B = index 1)
                var gruppeCol = -1;
                for(var gc = 0; gc < 5; gc++) {
                    if(r4[gc] && String(r4[gc]).toLowerCase().includes('kontengruppe')) { gruppeCol = gc; break; }
                }
                if(gruppeCol < 0) gruppeCol = 1; // Default B

                var planMonths = {};
                var keyRows = {};
                var keyPatterns = {
                    umsatz: /umsatzerlÃ¶se\s*gesamt|^umsatzerlÃ¶se\s*$/i,
                    wareneinsatz: /material.*wareneinkauf\s*gesamt|materialaufwand|^wareneinsatz$/i,
                    rohertrag: /^rohertrag$/i,
                    personalkosten: /personalkosten\s*gesamt|^personalkosten\s*$/i,
                    raumkosten: /raumkosten\s*gesamt|^raumkosten\s*$/i,
                    versicherungen: /versicherungen.*beitr/i,
                    fahrzeugkosten: /fahrzeugkosten/i,
                    werbekosten: /werbe.*reise|marketing/i,
                    warenabgabe: /kosten\s*warenabgabe/i,
                    abschreibungen: /^abschreibung/i,
                    reparaturen: /reparatur.*instandhaltung/i,
                    sonstige: /sonstige.*kosten/i,
                    gesamtkosten: /^gesamtkosten$/i,
                    betriebsergebnis: /^betriebsergebnis$/i,
                    ergebnis: /vorsteuer.*ergebnis|ergebnis.*vor.*steuer/i,
                    zins: /zinsaufwand\s*gesamt|^zinsaufwand$/i
                };

                // Scan all rows for matching groups (prefer "Gesamt" summary rows)
                for(var r = 4; r < rows.length; r++) {
                    var gruppe = String(rows[r][gruppeCol] || '').trim();
                    if(!gruppe) continue;
                    Object.keys(keyPatterns).forEach(function(key) {
                        if(keyPatterns[key].test(gruppe) && !keyRows[key]) {
                            if(planFormat === 'monthly') {
                                // Format A/B: Extract 12 monthly values from consecutive columns
                                var vals = [];
                                for(var m = 0; m < 12; m++) {
                                    var v = rows[r][planStartCol + m];
                                    vals.push(typeof v === 'number' ? v : 0);
                                }
                                keyRows[key] = { row: r, label: gruppe, values: vals };
                            } else if(planFormat === 'yearly_total') {
                                // Format C: Single yearly total, distribute by seasonal %
                                var yearTotal = rows[r][yearlyTotalCol];
                                yearTotal = typeof yearTotal === 'number' ? yearTotal : 0;
                                var vals2 = [];
                                if(seasonalPcts && seasonalPcts.length === 12) {
                                    for(var m2 = 0; m2 < 12; m2++) vals2.push(yearTotal * seasonalPcts[m2]);
                                } else {
                                    // Equal distribution if no seasonal data
                                    for(var m3 = 0; m3 < 12; m3++) vals2.push(yearTotal / 12);
                                }
                                keyRows[key] = { row: r, label: gruppe, values: vals2, yearTotal: yearTotal };
                            }
                        }
                    });
                }

                // Build planMonths
                var mLabels2 = ['Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
                for(var m = 0; m < 12; m++) {
                    var pm = { monat: m + 1 };
                    Object.keys(keyRows).forEach(function(key) {
                        pm[key] = keyRows[key].values[m];
                    });
                    // Calculate derived values if missing
                    if(pm.umsatz !== undefined && pm.wareneinsatz !== undefined && pm.rohertrag === undefined) {
                        pm.rohertrag = pm.umsatz + pm.wareneinsatz;
                    }
                    if(pm.rohertrag !== undefined && pm.gesamtkosten !== undefined && pm.betriebsergebnis === undefined) {
                        pm.betriebsergebnis = pm.rohertrag + pm.gesamtkosten;
                    }
                    planMonths[m + 1] = pm;
                }

                // 4. Validate plan data
                var validation = validatePlanData(planMonths, keyRows);
                var matchCount = Object.keys(keyRows).length;

                if(validation.level === 'critical') {
                    statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">ðŸš¨ ' + matchCount + ' Positionen erkannt, aber PlausibilitÃ¤tsprobleme!</p>';
                    // Try AI fallback
                    var rawJson2 = XLSX.utils.sheet_to_json(ws, { header: 'A', defval: null, raw: true });
                    startPlanAiFallback(rawJson2, file.name, statusEl, resultEl);
                    return;
                }

                // Show status
                var fmtLabel = planFormat === 'yearly_total' ? 'Jahressumme + saisonale Verteilung' : 'Monatswerte';
                var warnText = validation.level === 'warning' ? ' âš ï¸ ' + validation.issues.length + ' Hinweise' : '';
                statusEl.innerHTML = '<p class="text-xs text-green-600 mt-2">âœ… ' + matchCount + ' Positionen erkannt fÃ¼r ' + planYear + ' (' + fmtLabel + ', Sheet: ' + bwaSheetName + ')' + warnText + '</p>';

                // 5. Show preview
                renderPlanPreview(resultEl, planMonths, keyRows, validation, planYear);

                window._parsedPlanMonths = planMonths;

            } catch(err) {
                console.error('[Plan Parser] Error:', err);
                statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Fehler: ' + (err.message || err) + '</p>';
            }
        }

        function validatePlanData(planMonths, keyRows) {
            var issues = [];
            var hasUmsatz = !!keyRows.umsatz;
            var hasRohertrag = !!keyRows.rohertrag;
            var totalUmsatz = 0;

            // Check: Umsatz found?
            if(!hasUmsatz) {
                issues.push({ severity: 'error', message: 'UmsatzerlÃ¶se nicht erkannt. MÃ¶glicherweise fehlt die Zeile "UmsatzerlÃ¶se Gesamt".' });
            } else {
                for(var m = 1; m <= 12; m++) {
                    totalUmsatz += (planMonths[m] && planMonths[m].umsatz) || 0;
                }
                if(totalUmsatz === 0) {
                    issues.push({ severity: 'error', message: 'Jahresumsatz = 0 â‚¬. MÃ¶glicherweise wurden die falschen Spalten gelesen.' });
                }
                if(totalUmsatz > 0 && totalUmsatz < 10000) {
                    issues.push({ severity: 'error', message: 'Jahresumsatz nur ' + Math.round(totalUmsatz).toLocaleString('de-DE') + ' â‚¬. Sieht nach Prozentwerten oder falscher Spalte aus.' });
                }
            }

            // Check: at least 3 key positions found
            if(Object.keys(keyRows).length < 3) {
                issues.push({ severity: 'warning', message: 'Nur ' + Object.keys(keyRows).length + ' Positionen erkannt. Erwartet: mindestens 5.' });
            }

            // Check: all months have values
            var emptyMonths = 0;
            for(var m2 = 1; m2 <= 12; m2++) {
                if(!planMonths[m2] || (planMonths[m2].umsatz === 0 && planMonths[m2].rohertrag === 0)) emptyMonths++;
            }
            if(emptyMonths > 3) {
                issues.push({ severity: 'warning', message: emptyMonths + ' Monate ohne Werte. Bitte prÃ¼fen.' });
            }

            // Check: Rohertragsmarge plausibel
            if(hasUmsatz && hasRohertrag && totalUmsatz > 0) {
                var totalRoh = 0;
                for(var m3 = 1; m3 <= 12; m3++) totalRoh += (planMonths[m3] && planMonths[m3].rohertrag) || 0;
                var marge = (totalRoh / totalUmsatz) * 100;
                if(marge < 10 || marge > 80) {
                    issues.push({ severity: 'warning', message: 'Rohertragsmarge ' + marge.toFixed(1) + '% ungewÃ¶hnlich fÃ¼r Fahrradhandel (erwartet: 30-50%).' });
                }
            }

            var hasError = issues.some(function(i) { return i.severity === 'error'; });
            return { level: hasError ? 'critical' : (issues.length > 0 ? 'warning' : 'ok'), issues: issues };
        }

        function renderPlanPreview(resultEl, planMonths, keyRows, validation, planYear) {
            var mLabels = ['','Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var h = '';

            // Validation warnings
            if(validation.issues.length > 0) {
                var vBg = validation.level === 'warning' ? 'bg-yellow-50 border-yellow-300' : 'bg-red-50 border-red-300';
                h += '<div class="' + vBg + ' border rounded-lg p-2 mt-3 mb-2">';
                validation.issues.forEach(function(i) {
                    h += '<p class="text-[11px] ' + (i.severity === 'error' ? 'text-red-700' : 'text-yellow-700') + '">' + (i.severity === 'error' ? 'âŒ' : 'âš¡') + ' ' + i.message + '</p>';
                });
                h += '</div>';
            }

            // Summary card
            var totalU = 0, totalR = 0, totalE = 0;
            for(var m = 1; m <= 12; m++) {
                var pm = planMonths[m] || {};
                totalU += pm.umsatz || 0;
                totalR += pm.rohertrag || 0;
                totalE += pm.ergebnis || pm.betriebsergebnis || 0;
            }
            h += '<div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-3">';
            h += '<p class="text-xs font-semibold text-green-700 mb-2">Plan-Werte ' + planYear + ':</p>';
            h += '<div class="grid grid-cols-3 gap-3 text-xs mb-3">';
            h += '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Umsatz (Jahr)</span><br><strong>' + Math.round(totalU).toLocaleString('de-DE') + ' â‚¬</strong></div>';
            h += '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Rohertrag</span><br><strong>' + (totalU ? ((totalR/totalU)*100).toFixed(1) : 0) + '%</strong></div>';
            h += '<div class="bg-white rounded p-2 text-center"><span class="text-gray-500 text-[10px]">Ergebnis</span><br><strong class="' + (totalE >= 0 ? 'text-green-600' : 'text-red-600') + '">' + Math.round(totalE).toLocaleString('de-DE') + ' â‚¬</strong></div>';
            h += '</div>';

            // Monthly mini-chart
            h += '<div class="grid grid-cols-12 gap-0.5 text-[9px] mb-3">';
            for(var m2 = 1; m2 <= 12; m2++) {
                var pm = planMonths[m2] || {};
                var u = pm.umsatz || 0;
                h += '<div class="text-center p-1 bg-white rounded"><div class="font-bold">' + mLabels[m2] + '</div>';
                h += '<div>' + (u ? Math.round(u/1000) + 'k' : 'â€”') + '</div></div>';
            }
            h += '</div>';

            // Recognized positions
            h += '<details><summary class="text-[10px] text-gray-400 cursor-pointer">Erkannte Positionen (' + Object.keys(keyRows).length + ')</summary>';
            h += '<div class="mt-1 space-y-0.5">';
            Object.keys(keyRows).forEach(function(key) {
                var kr = keyRows[key];
                var total = kr.values.reduce(function(a, b) { return a + b; }, 0);
                h += '<div class="text-[10px] text-gray-500">' + key + ' â†’ "<span class="text-gray-700">' + kr.label + '</span>" (Zeile ' + (kr.row + 1) + ') = ' + Math.round(total).toLocaleString('de-DE') + ' â‚¬/Jahr</div>';
            });
            h += '</div></details>';

            h += '<button onclick="saveParsedPlan()" class="w-full mt-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:opacity-90">âœ… Plan fÃ¼r ' + planYear + ' speichern</button>';
            h += '</div>';
            resultEl.innerHTML = h;
            resultEl.classList.remove('hidden');
        }

        async function startPlanAiFallback(rawRows, filename, statusEl, resultEl) {
            var MAX_RETRIES = 3;
            var compact = rawRows.slice(0, 80).map(function(row) {
                var cells = {};
                Object.keys(row).forEach(function(k) {
                    if(row[k] !== null && row[k] !== undefined && row[k] !== '') cells[k] = row[k];
                });
                return cells;
            }).filter(function(r) { return Object.keys(r).length > 0; });

            for(var attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                statusEl.innerHTML = '<div class="flex items-center space-x-2 mt-2"><div class="w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-purple-600">ðŸ¤– KI analysiert Plan-Daten (Versuch ' + attempt + '/' + MAX_RETRIES + ')...</span></div>';

                try {
                    var response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 2000,
                            system: 'Du bist ein Finanz-Datenexperte. Extrahiere monatliche Plan-BWA-Werte aus Excel-Rohdaten. Antwort NUR als JSON, keine ErklÃ¤rung.',
                            messages: [{ role: 'user', content: 'Datei: ' + filename + '\nPlanjahr: ' + planIstYear + '\n\nRohdaten (erste 80 Zeilen):\n' + JSON.stringify(compact) + '\n\nExtrahiere fÃ¼r jeden Monat (1-12) diese Werte:\n{"1":{"umsatz":number,"wareneinsatz":number(negativ),"rohertrag":number,"personalkosten":number(negativ),"raumkosten":number(negativ),"gesamtkosten":number(negativ),"ergebnis":number},"2":{...},...,"12":{...}}\n\nWICHTIG: Finde die Spalten fÃ¼r das Planjahr ' + planIstYear + '. Suche nach SpaltenÃ¼berschriften mit Datum ' + planIstYear + '. Monatliche Werte, NICHT kumuliert.' }]
                        })
                    });
                    var data = await response.json();
                    var text = (data.content || []).map(function(b) { return b.text || ''; }).join('');
                    text = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                    var aiPlan = JSON.parse(text);

                    // Validate AI result
                    var planMonths = {};
                    var totalU = 0;
                    for(var m = 1; m <= 12; m++) {
                        var pd = aiPlan[String(m)] || aiPlan[m] || {};
                        planMonths[m] = { monat: m, umsatz: pd.umsatz || 0, wareneinsatz: pd.wareneinsatz || 0, rohertrag: pd.rohertrag || (pd.umsatz||0) + (pd.wareneinsatz||0), personalkosten: pd.personalkosten || 0, raumkosten: pd.raumkosten || 0, gesamtkosten: pd.gesamtkosten || 0, ergebnis: pd.ergebnis || 0 };
                        totalU += planMonths[m].umsatz;
                    }

                    if(totalU > 10000) {
                        statusEl.innerHTML = '<p class="text-xs text-purple-600 mt-2">ðŸ¤– KI hat Plan-Daten extrahiert! (Versuch ' + attempt + ')</p>';
                        renderPlanPreview(resultEl, planMonths, { 'KI-extrahiert': { row: 0, label: 'Claude AI', values: [] } }, { level: 'ok', issues: [] }, planIstYear);
                        window._parsedPlanMonths = planMonths;
                        return;
                    }
                } catch(aiErr) {
                    console.warn('[Plan AI] Attempt ' + attempt + ' failed:', aiErr);
                }
            }

            // All attempts failed
            statusEl.innerHTML = '<p class="text-xs text-amber-600 mt-2">âš ï¸ Automatische Erkennung nicht mÃ¶glich. Bitte trage die Plan-Werte manuell ein.</p>';
            resultEl.innerHTML = '<div class="bg-amber-50 border border-amber-300 rounded-lg p-3 mt-2"><p class="text-xs text-amber-700">Die Plan-Datei konnte nicht automatisch gelesen werden. Nutze die manuelle Eingabe unten.</p></div>';
            resultEl.classList.remove('hidden');
        }

        async function saveParsedPlan() {
            var planMonths = window._parsedPlanMonths;
            if(!planMonths) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;

                // Duplicate check
                if(!window._planDuplicateConfirmed) {
                    var existing = await sb.from('jahresplaene').select('id,plan_daten,updated_at').eq('standort_id', stdId).eq('jahr', planIstYear).maybeSingle();
                    if(existing.data) {
                        var exDate = existing.data.updated_at ? new Date(existing.data.updated_at).toLocaleDateString('de-DE') : '?';
                        var resultEl = document.getElementById('planParseResult');
                        if(resultEl) {
                            resultEl.innerHTML = '<div class="bg-amber-50 border border-amber-300 rounded-lg p-3 mt-2">'
                                + '<p class="text-xs font-bold text-amber-800 mb-1">âš ï¸ FÃ¼r ' + planIstYear + ' existiert bereits ein Jahresplan</p>'
                                + '<p class="text-[10px] text-amber-600 mb-2">Zuletzt aktualisiert: ' + exDate + '</p>'
                                + '<div class="flex gap-2">'
                                + '<button onclick="window._planDuplicateConfirmed=true;saveParsedPlan();" class="px-3 py-1.5 bg-amber-500 text-white text-xs font-semibold rounded hover:bg-amber-600">âœ… Ãœberschreiben</button>'
                                + '<button onclick="document.getElementById(\'planParseResult\').innerHTML=\'\'" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-semibold rounded hover:bg-gray-300">Abbrechen</button>'
                                + '</div></div>';
                            resultEl.classList.remove('hidden');
                        }
                        return;
                    }
                }
                window._planDuplicateConfirmed = false;

                var payload = {
                    standort_id: stdId,
                    jahr: planIstYear,
                    plan_daten: planMonths,
                    erstellt_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                var resp = await sb.from('jahresplaene').upsert(payload, {onConflict:'standort_id,jahr'}).select();
                if(resp.error) throw resp.error;
                currentPlan = resp.data[0] || payload;
                alert('âœ… Jahresplan '+planIstYear+' gespeichert!');
                renderPlanIst();
            } catch(err) { alert('Fehler: '+(err.message||err)); }
        }

        async function saveManualPlan() {
            var planMonths = {};
            for(var m=1;m<=12;m++) {
                var u = parseFloat((document.getElementById('planM_umsatz_'+m)||{}).value) || 0;
                var we = parseFloat((document.getElementById('planM_we_'+m)||{}).value) || 0;
                var pk = parseFloat((document.getElementById('planM_pk_'+m)||{}).value) || 0;
                var rk = parseFloat((document.getElementById('planM_rk_'+m)||{}).value) || 0;
                if(u || we || pk || rk) {
                    planMonths[m] = { monat:m, umsatz:u, wareneinsatz:we, personalkosten:pk, raumkosten:rk };
                }
            }
            if(Object.keys(planMonths).length < 1) { alert('Bitte mindestens einen Monat ausfÃ¼llen.'); return; }
            window._parsedPlanMonths = planMonths;
            await saveParsedPlan();
        }

        async function renderPlanVergleich(el) {
            // Load all BWAs for this year
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var bwaResp = await sb.from('bwa_daten').select('*').eq('standort_id', stdId).eq('jahr', planIstYear).order('monat');
            var bwas = bwaResp.data || [];
            var bwaByMonth = {};
            bwas.forEach(function(b) { bwaByMonth[b.monat] = b; });

            var plan = currentPlan.plan_daten;
            var mLabels = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var currentMonth = new Date().getMonth() + 1;

            // Find selected month for detail view (default: latest with BWA data)
            var detailMonth = 0;
            for(var dm=12;dm>=1;dm--) { if(bwaByMonth[dm]) { detailMonth = dm; break; } }

            // KPIs: YTD totals
            var ytdPlanUmsatz = 0, ytdIstUmsatz = 0, ytdPlanErgebnis = 0, ytdIstErgebnis = 0;
            for(var k=1;k<=12;k++) {
                var p = plan[String(k)] || plan[k] || {};
                ytdPlanUmsatz += (p.umsatz||0);
                ytdPlanErgebnis += (p.ergebnis||0);
                if(bwaByMonth[k]) {
                    ytdIstUmsatz += (parseFloat(bwaByMonth[k].umsatzerloese)||0);
                    ytdIstErgebnis += (parseFloat(bwaByMonth[k].ergebnis_vor_steuern)||0);
                }
            }

            var h = '';
            // Year selector + reupload button
            h += '<div class="flex items-center justify-between mb-4">';
            h += '<div class="flex items-center space-x-3"><h2 class="text-lg font-bold text-gray-800">Plan / Ist Vergleich</h2>';
            h += '<select id="planIstYearSel" onchange="planIstYear=parseInt(this.value);currentPlan=null;renderPlanIst()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm">';
            for(var yy=2026;yy>=2024;yy--) h += '<option value="'+yy+'"'+(yy===planIstYear?' selected':'')+'>'+yy+'</option>';
            h += '</select></div>';
            h += '<button onclick="currentPlan=null;renderPlanIst()" class="text-xs text-vit-orange font-semibold hover:underline">ðŸ“„ Neuen Plan hochladen</button>';
            h += '</div>';

            // KPIs
            var diffUmsatz = ytdIstUmsatz - ytdPlanUmsatz;
            var pctUmsatz = ytdPlanUmsatz ? Math.round(ytdIstUmsatz/ytdPlanUmsatz*100) : 0;
            h += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz Plan YTD</p><p class="text-2xl font-bold text-blue-600">'+ytdPlanUmsatz.toLocaleString('de-DE')+' â‚¬</p></div>';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz Ist YTD</p><p class="text-2xl font-bold '+(ytdIstUmsatz>=ytdPlanUmsatz?'text-green-600':'text-red-500')+'">'+ytdIstUmsatz.toLocaleString('de-DE')+' â‚¬</p><p class="text-xs '+(diffUmsatz>=0?'text-green-600':'text-red-500')+'">'+(diffUmsatz>=0?'+':'')+diffUmsatz.toLocaleString('de-DE')+' â‚¬ ('+pctUmsatz+'%)</p></div>';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">BWAs eingereicht</p><p class="text-2xl font-bold text-gray-800">'+bwas.length+' / '+(currentMonth-1)+'</p><p class="text-xs text-gray-500">Monate</p></div>';
            var missing = [];
            for(var mm=1;mm<currentMonth;mm++) { if(!bwaByMonth[mm]) missing.push(mLabels[mm]); }
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Fehlend</p><p class="text-2xl font-bold '+(missing.length>0?'text-red-500':'text-green-600')+'">'+(missing.length||'âœ…')+'</p>'+(missing.length?'<p class="text-[10px] text-red-400">'+missing.join(', ')+'</p>':'')+'</div>';
            h += '</div>';

            // Monthly overview table
            h += '<div class="vit-card p-6 mb-6">';
            h += '<h3 class="font-semibold text-gray-800 mb-3">MonatsÃ¼bersicht '+planIstYear+'</h3>';
            h += '<div class="overflow-x-auto"><table class="w-full text-sm">';
            h += '<thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-3 font-semibold text-gray-600">Monat</th><th class="text-right py-2.5 px-3 font-semibold text-blue-600">Plan Umsatz</th><th class="text-right py-2.5 px-3 font-semibold text-vit-orange">Ist Umsatz</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">ErfÃ¼llung</th><th class="text-center py-2.5 px-3 font-semibold text-gray-600">Status</th></tr></thead>';
            h += '<tbody>';
            var sumPlan=0,sumIst=0;
            for(var m=1;m<=12;m++) {
                var p = plan[String(m)] || plan[m] || {};
                var b = bwaByMonth[m];
                var pu = p.umsatz || 0;
                var iu = b ? (parseFloat(b.umsatzerloese)||0) : 0;
                sumPlan += pu; sumIst += iu;
                var diff = iu - pu;
                var pct = pu ? Math.round(iu/pu*100) : 0;
                var hasBwa = !!b;
                var isPast = m < currentMonth;
                var isCurrent = m === currentMonth;
                var status = hasBwa ? (pct>=100?'ðŸŸ¢':pct>=75?'ðŸŸ¡':'ðŸ”´') : (isPast?'âš ï¸':'â³');
                var rowCls = hasBwa ? (pct>=100?'bg-green-50 border-l-4 border-green-400':'bg-orange-50 border-l-4 border-orange-400') : (isCurrent?'bg-blue-50 border-l-4 border-blue-400':'text-gray-400');
                h += '<tr class="border-b '+rowCls+'" '+(hasBwa?'onclick="showMonthDetail('+m+')" class="cursor-pointer hover:bg-gray-100"':'')+'>';
                h += '<td class="py-2.5 px-3 font-semibold">'+mLabels[m]+(isCurrent?' <span class="text-[10px] text-blue-500">(aktuell)</span>':'')+'</td>';
                h += '<td class="text-right py-2.5 px-3 text-blue-600">'+pu.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 font-bold '+(hasBwa?'text-vit-orange':'')+'">'+( hasBwa ? iu.toLocaleString('de-DE') : 'â€”')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(hasBwa?(diff>=0?'text-green-600 font-semibold':'text-red-600 font-semibold'):'')+'">'+( hasBwa ? (diff>=0?'+':'')+diff.toLocaleString('de-DE') : 'â€”')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(hasBwa?(pct>=100?'text-green-600 font-bold':'text-red-600 font-bold'):'')+'">'+( hasBwa ? pct+'%' : 'â€”')+'</td>';
                h += '<td class="text-center py-2.5 px-3">'+status+'</td>';
                h += '</tr>';
            }
            var totalDiff = sumIst-sumPlan; var totalPct = sumPlan?Math.round(sumIst/sumPlan*100):0;
            h += '<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT '+planIstYear+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold text-blue-600">'+sumPlan.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold text-vit-orange">'+sumIst.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold '+(totalDiff>=0?'text-green-600':'text-red-600')+'">'+(totalDiff>=0?'+':'')+totalDiff.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold">'+totalPct+'%</td><td class="text-center">ðŸ“Š</td></tr>';
            h += '</tbody></table></div></div>';

            // Detail view for selected month
            if(detailMonth && bwaByMonth[detailMonth]) {
                var b = bwaByMonth[detailMonth];
                var p = plan[String(detailMonth)] || plan[detailMonth] || {};
                h += '<div class="vit-card p-6" id="planIstDetail">';
                h += '<div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-gray-800">Plan / Ist Detail â€“ '+mLabels[detailMonth]+' '+planIstYear+'</h3>';
                h += '<select onchange="showMonthDetail(parseInt(this.value))" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm">';
                for(var ms=1;ms<=12;ms++) {
                    var hasBwa2 = !!bwaByMonth[ms];
                    h += '<option value="'+ms+'"'+(ms===detailMonth?' selected':'')+(hasBwa2?'':' disabled')+'>'+mLabels[ms]+(hasBwa2?'':' (keine BWA)')+'</option>';
                }
                h += '</select></div>';
                h += buildPlanIstTable(p, b);
                h += '</div>';
            }

            el.innerHTML = h;
        }

        function buildPlanIstTable(plan, bwa) {
            var rows = [
                {label:'UmsatzerlÃ¶se', plan: plan.umsatz, ist: parseFloat(bwa.umsatzerloese)||0, bold:true},
                {label:'Wareneinsatz', plan: plan.wareneinsatz, ist: parseFloat(bwa.wareneinsatz)||0, bold:true},
                {label:'Rohertrag', plan: (plan.umsatz||0)+(plan.wareneinsatz||0), ist: parseFloat(bwa.rohertrag)||0, highlight:'blue'},
                {label:'Personalkosten', plan: plan.personalkosten, ist: parseFloat(bwa.personalkosten)||0, bold:true},
                {label:'Raumkosten', plan: plan.raumkosten, ist: parseFloat(bwa.raumkosten)||0},
                {label:'Werbe-/Reisekosten', plan: plan.werbekosten, ist: parseFloat(bwa.werbekosten)||0},
                {label:'Abschreibungen', plan: plan.abschreibungen||plan.abschreibung, ist: parseFloat(bwa.abschreibungen)||0},
                {label:'Sonstige Kosten', plan: plan.sonstige, ist: parseFloat(bwa.sonstige_kosten)||0},
                {label:'Gesamtkosten', plan: (plan.personalkosten||0)+(plan.raumkosten||0)+(plan.werbekosten||0)+(plan.sonstige||0), ist: parseFloat(bwa.gesamtkosten)||0, highlight:'gray'},
                {label:'Betriebsergebnis', plan: plan.ergebnis||((plan.umsatz||0)+(plan.wareneinsatz||0)+(plan.personalkosten||0)+(plan.raumkosten||0)+(plan.sonstige||0)), ist: parseFloat(bwa.betriebsergebnis)||0, highlight:'yellow'},
                {label:'Zinsaufwand', plan: plan.zins||plan.zinsaufwand, ist: parseFloat(bwa.zinsaufwand)||0},
                {label:'Ergebnis vor Steuern', plan: plan.ergebnis, ist: parseFloat(bwa.ergebnis_vor_steuern)||0, highlight:'result'}
            ];

            var h = '<div class="overflow-x-auto"><table class="w-full text-sm">';
            h += '<thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-3 font-semibold text-gray-600 w-1/4">Position</th><th class="text-right py-2.5 px-3 font-semibold text-blue-600">Plan</th><th class="text-right py-2.5 px-3 font-semibold text-vit-orange">Ist (BWA)</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">%</th></tr></thead>';
            h += '<tbody>';
            rows.forEach(function(r) {
                var pv = r.plan || 0;
                var iv = r.ist || 0;
                var diff = iv - pv;
                var isGood = r.label.match(/Umsatz|Rohertrag|Ergebnis/) ? diff >= 0 : diff <= 0;
                var pct = pv ? Math.round(Math.abs(iv/pv)*100) : (iv?'â€”':'â€”');
                var bgCls = '';
                if(r.highlight==='blue') bgCls = 'bg-blue-50 border-b-2 border-gray-800';
                else if(r.highlight==='yellow') bgCls = 'bg-yellow-50 border-b-2 border-gray-600';
                else if(r.highlight==='gray') bgCls = 'bg-gray-100 border-t-2';
                else if(r.highlight==='result') bgCls = (iv>=0?'bg-green-50':'bg-red-50')+' border-t-2 border-gray-800';
                h += '<tr class="border-b '+bgCls+'">';
                h += '<td class="py-2.5 px-3 '+(r.bold||r.highlight?'font-bold':'font-semibold')+' text-gray-800 '+(r.highlight?'text-base':'')+'">'+r.label+'</td>';
                h += '<td class="text-right py-2.5 px-3 text-blue-600 '+(r.highlight?'font-bold':'')+'">'+pv.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(r.highlight?'font-bold text-base':'font-semibold')+' text-vit-orange">'+iv.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 font-semibold '+(isGood?'text-green-600':'text-red-600')+'">'+(diff>=0?'+':'')+diff.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(isGood?'text-green-600':'text-red-600')+'">'+pct+'%</td>';
                h += '</tr>';
            });
            h += '</tbody></table></div>';
            // Rohertragsmarge
            var planMarge = (rows[0].plan||1) ? (((rows[2].plan||0)/(rows[0].plan||1))*100).toFixed(1) : 0;
            var istMarge = (rows[0].ist||1) ? (((rows[2].ist||0)/(rows[0].ist||1))*100).toFixed(1) : 0;
            h += '<div class="mt-3 flex items-center space-x-4 text-xs text-gray-500"><span>Rohertragsmarge: <strong class="text-blue-600">Plan '+planMarge+'%</strong></span><span>|</span><span><strong class="text-vit-orange">Ist '+istMarge+'%</strong></span><span>|</span><span class="'+(parseFloat(istMarge)>=parseFloat(planMarge)?'text-green-600':'text-red-500')+'">Differenz: '+(parseFloat(istMarge)-parseFloat(planMarge)).toFixed(1)+' Pp</span></div>';
            return h;
        }

        function showMonthDetail(m) {
            // Re-render detail only - we need to reload
            renderPlanIst();
        }

        function editSelectedBwa() {
            if(!selectedBwaId) return;
            // Find in cache and open modal pre-filled
            var b = bwaCache.find(function(x){return x.id===selectedBwaId;});
            if(!b) { openBwaUploadModal(); return; }
            openBwaUploadModal();
            // Pre-fill after modal renders
            setTimeout(async function(){
                try {
                    var resp = await sb.from('bwa_daten').select('*').eq('id', selectedBwaId).single();
                    if(resp.error) return;
                    var d = resp.data;
                    document.getElementById('bwaMonth').value = d.monat;
                    document.getElementById('bwaYear').value = d.jahr;
                    var map = {
                        'bwaF_umsatz':d.umsatzerloese,'bwaF_fahrraeder':d.davon_fahrraeder,'bwaF_teile':d.davon_teile,
                        'bwaF_service':d.davon_service,'bwaF_skonti':d.davon_skonti,'bwaF_wareneinsatz':d.wareneinsatz,
                        'bwaF_personal':d.personalkosten,'bwaF_raum':d.raumkosten,'bwaF_werbe':d.werbekosten,
                        'bwaF_warenabgabe':d.kosten_warenabgabe,'bwaF_abschreibung':d.abschreibungen,'bwaF_sonstige':d.sonstige_kosten,
                        'bwaF_zins':d.zinsaufwand,'bwaF_planUmsatz':d.plan_umsatz,'bwaF_planWareneinsatz':d.plan_wareneinsatz,
                        'bwaF_planRohertrag':d.plan_rohertrag,'bwaF_planPersonal':d.plan_personalkosten,'bwaF_planRaum':d.plan_raumkosten,
                        'bwaF_planWerbe':d.plan_werbekosten,'bwaF_planGesamt':d.plan_gesamtkosten,'bwaF_planErgebnis':d.plan_ergebnis
                    };
                    Object.keys(map).forEach(function(id) { var el = document.getElementById(id); if(el && map[id]) el.value = map[id]; });
                } catch(e) {}
            }, 200);
        }

        async function deleteBwa() {
            if(!selectedBwaId) return;
            if(!confirm('BWA wirklich loeschen?')) return;
            try {
                var resp = await sb.from('bwa_daten').delete().eq('id', selectedBwaId);
                if(resp.error) throw resp.error;
                selectedBwaId = null;
                document.getElementById('bwaTitle').textContent = 'BWA auswaehlen';
                document.getElementById('bwaDetailBody').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">BWA geloescht.</td></tr>';
                document.getElementById('bwaEditBtn').style.display = 'none';
                document.getElementById('bwaDeleteBtn').style.display = 'none';
                document.getElementById('bwaTrendSection').style.display = 'none';
                document.getElementById('bwaKpiUmsatz').textContent = 'â€”';
                document.getElementById('bwaKpiRohertrag').textContent = 'â€”';
                document.getElementById('bwaKpiKosten').textContent = 'â€”';
                document.getElementById('bwaKpiErgebnis').textContent = 'â€”';
                loadBwaList();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // =============================================
        // VERKAUFSERFOLG TRACKING - SUPABASE
        // =============================================
        var vtCache = [];

        async function loadVerkaufTracking() {
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var now = new Date();
            // Get Monday of current week
            var day = now.getDay(); var diff = now.getDate() - day + (day===0?-6:1);
            var monday = new Date(now); monday.setDate(diff); monday.setHours(0,0,0,0);
            var sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
            var monStr = monday.toISOString().slice(0,10);
            var sunStr = sunday.toISOString().slice(0,10);
            try {
                var query = sb.from('verkauf_tracking').select('*').gte('datum', monStr).lte('datum', sunStr).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                vtCache = resp.data || [];
                renderVerkaufFromDb();
            } catch(err) { console.error('VT load error:', err); }
        }

        function renderVerkaufFromDb() {
            // Aggregate data by seller
            var sellerMap = {};
            vtCache.forEach(function(entry) {
                var name = entry.verkaeufer_name;
                if(!sellerMap[name]) sellerMap[name] = {name:name,total:0,verkauft:0,umsatz:0,daily:{}};
                var s = sellerMap[name];
                var d = new Date(entry.datum);
                var dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
                var dayName = dayNames[d.getDay()];
                s.daily[dayName] = entry;
                var gesamt = (entry.geplant||0) + (entry.spontan||0) + (entry.online||0) + (entry.ergo||0);
                s.total += gesamt;
                s.verkauft += (entry.verkauft||0);
                s.umsatz += parseFloat(entry.umsatz)||0;
            });

            // Update KPIs
            var totalPlan=0,totalGesamt=0,totalVerkauft=0,totalUmsatz=0;
            Object.values(sellerMap).forEach(function(s) {
                totalGesamt += s.total;
                totalVerkauft += s.verkauft;
                totalUmsatz += s.umsatz;
            });
            var el;
            el = document.getElementById('wkGesamt'); if(el) el.textContent = totalGesamt;
            el = document.getElementById('wkVerkauft'); if(el) el.textContent = totalVerkauft;
            el = document.getElementById('wkUmsatz'); if(el) el.textContent = totalUmsatz.toLocaleString('de-DE') + ' â‚¬';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            el = document.getElementById('wkQuote');
            if(el) { el.textContent = quoteVal + '%'; el.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600'); }
        }

        function openVerkaufEntryModal() {
            var now = new Date();
            var today = now.toISOString().slice(0,10);
            var html = '<div id="vtEntryOverlay" onclick="closeVtModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">ðŸ’° Verkaufserfolg eintragen</h3><button onclick="closeVtModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Datum</label><input id="vtDate" type="date" value="'+today+'" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Verkaeufer</label><input id="vtSeller" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Name" value="'+(sbProfile?sbProfile.name:'')+'"></div>';
            html += '</div>';
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Beratungen</p>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            var vtFields = [
                {id:'vtPlan',label:'Plan-Termine',ph:'0'},
                {id:'vtGeplant',label:'Geplant',ph:'0'},
                {id:'vtSpontan',label:'Spontan',ph:'0'},
                {id:'vtOnline',label:'Online',ph:'0'},
                {id:'vtErgo',label:'Ergo-Beratung',ph:'0'},
                {id:'vtVerkauft',label:'Verkauft âœ…',ph:'0'}
            ];
            vtFields.forEach(function(f) {
                html += '<div><label class="block text-xs text-gray-600 mb-1">'+f.label+'</label>';
                html += '<input id="'+f.id+'" type="number" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-center" placeholder="'+f.ph+'" value="0"></div>';
            });
            html += '</div>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs text-gray-600 mb-1">Uebergaben</label><input id="vtUebergabe" type="number" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-center" value="0"></div>';
            html += '<div><label class="block text-xs text-gray-600 mb-1">Umsatz (â‚¬)</label><input id="vtUmsatz" type="number" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-right" placeholder="0"></div>';
            html += '</div>';
            html += '<div class="mb-3"><label class="block text-xs text-gray-600 mb-1">Notizen</label><textarea id="vtNotizen" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" rows="2" placeholder="z.B. Kunde kommt naechste Woche wieder..."></textarea></div>';
            html += '<div id="vtError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveVtEntry()" id="vtSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'vtEntryContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        function closeVtModal() { var c = document.getElementById('vtEntryContainer'); if(c) c.remove(); }

        // =============================================
        // AUSWERTUNG TAB - Yearly Analysis from DB
        // =============================================
        async function loadAuswertung() {
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var year = new Date().getFullYear();
                var startDate = year+'-01-01';
                var endDate = year+'-12-31';
                var query = sb.from('verkauf_tracking').select('*').gte('datum', startDate).lte('datum', endDate).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                var data = resp.data || [];
                renderAuswertung(data, year);
            } catch(e) { console.error('Auswertung load:', e); }
        }

        function renderAuswertung(data, year) {
            var mn = ['','Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var mnFull = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var nowMonth = new Date().getMonth()+1;
            // Aggregate by month
            var months = {};
            for(var m=1;m<=12;m++) months[m]={beratungen:0,verkauft:0,umsatz:0,plan:0};
            var sellerMap = {};
            data.forEach(function(d){
                var dm = new Date(d.datum).getMonth()+1;
                var ges = (d.geplant||0)+(d.spontan||0)+(d.online||0)+(d.ergo||0);
                months[dm].beratungen += ges;
                months[dm].verkauft += (d.verkauft||0);
                months[dm].umsatz += parseFloat(d.umsatz)||0;
                months[dm].plan += (d.plan_termine||0);
                // Seller aggregation
                var n = d.verkaeufer_name||'Unbekannt';
                if(!sellerMap[n]) sellerMap[n]={name:n,umsatz:0,verkauft:0,beratungen:0};
                sellerMap[n].umsatz += parseFloat(d.umsatz)||0;
                sellerMap[n].verkauft += (d.verkauft||0);
                sellerMap[n].beratungen += ges;
            });
            // Year totals
            var totBer=0,totVk=0,totUms=0;
            for(var m=1;m<=12;m++){totBer+=months[m].beratungen;totVk+=months[m].verkauft;totUms+=months[m].umsatz;}
            var ytdQuote = totBer>0?Math.round(totVk/totBer*100):0;
            var avgPreis = totVk>0?Math.round(totUms/totVk):0;
            // Update KPIs
            var el;
            el=document.getElementById('ausUmsatzYTD'); if(el) el.textContent=eur(totUms)+' \u20AC';
            el=document.getElementById('ausVerkauft'); if(el) el.textContent=totVk;
            el=document.getElementById('ausQuote'); if(el) el.textContent=ytdQuote+'%';
            el=document.getElementById('ausAvgPreis'); if(el) el.textContent=eur(avgPreis)+' \u20AC';

            // SVG Chart
            var chartEl = document.getElementById('ausChartContainer');
            if(chartEl) {
                var w=chartEl.offsetWidth||600; var h=180; var pad=40;
                var vals=[]; for(var m=1;m<=12;m++) vals.push(months[m].umsatz);
                var maxV=Math.max.apply(null,vals.concat([1]));
                var barW=Math.floor((w-pad*2)/12)-8;
                var svg='<svg width="'+w+'" height="'+(h+30)+'" style="display:block">';
                // Grid lines
                for(var g=0;g<=4;g++){
                    var gy=pad+g*(h-pad)/4;
                    var label=eur(Math.round(maxV*(4-g)/4));
                    svg+='<line x1="'+pad+'" y1="'+gy+'" x2="'+(w-10)+'" y2="'+gy+'" stroke="#e5e7eb" stroke-width="1"/>';
                    svg+='<text x="'+(pad-5)+'" y="'+(gy+4)+'" text-anchor="end" fill="#9ca3af" font-size="9">'+label+'</text>';
                }
                // Bars
                for(var m=1;m<=12;m++){
                    var x=pad+(m-1)*((w-pad*2)/12)+4;
                    var val=vals[m-1];
                    var barH=maxV>0?(val/maxV)*(h-pad):0;
                    var color=m<=nowMonth?(val>0?'#EF7D00':'#D1D5DB'):'#E5E7EB';
                    svg+='<rect x="'+x+'" y="'+(h-barH)+'" width="'+barW+'" height="'+Math.max(barH,1)+'" rx="3" fill="'+color+'"/>';
                    if(val>0) svg+='<text x="'+(x+barW/2)+'" y="'+(h-barH-4)+'" text-anchor="middle" fill="#374151" font-size="9" font-weight="bold">'+eur(val)+'</text>';
                    svg+='<text x="'+(x+barW/2)+'" y="'+(h+15)+'" text-anchor="middle" fill="#6B7280" font-size="10">'+mn[m]+'</text>';
                }
                svg+='</svg>';
                chartEl.innerHTML=svg;
            }

            // Monthly table
            var tbody=document.getElementById('jahresTabelle');
            if(tbody){
                var h='';
                for(var m=1;m<=12;m++){
                    var md=months[m];
                    var q=md.beratungen>0?Math.round(md.verkauft/md.beratungen*100):0;
                    var avg=md.verkauft>0?Math.round(md.umsatz/md.verkauft):0;
                    var isCur=m===nowMonth; var isPast=m<nowMonth; var hasDat=md.beratungen>0||md.umsatz>0;
                    var rc=isCur?'bg-blue-50 border-l-4 border-blue-400':hasDat?'':'text-gray-400';
                    h+='<tr class="border-b '+rc+'">';
                    h+='<td class="py-2.5 px-3 '+(isCur?'font-semibold':'')+'">'+mnFull[m]+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.beratungen>0?'text-blue-600 font-semibold':'')+'">'+( md.beratungen>0?md.beratungen:'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.verkauft>0?'text-green-600 font-bold':'')+'">'+( md.verkauft>0?md.verkauft:'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(q>=70?'text-green-600':q>=40?'text-orange-600':q>0?'text-red-600':'')+'">'+( q>0?q+'%':'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.umsatz>0?'font-bold text-vit-orange':'')+'">'+( md.umsatz>0?eur(md.umsatz)+' \u20AC':'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3">'+( avg>0?eur(avg)+' \u20AC':'\u2014')+'</td>';
                    h+='</tr>';
                }
                h+='<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT '+year+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-blue-600">'+totBer+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-green-600">'+totVk+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold">'+ytdQuote+'%</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-vit-orange">'+eur(totUms)+' \u20AC</td>';
                h+='<td class="text-right py-3 px-3 font-bold">'+eur(avgPreis)+' \u20AC</td></tr>';
                tbody.innerHTML=h;
            }

            // Ranking
            var sellers=Object.values(sellerMap).sort(function(a,b){return b.umsatz-a.umsatz;});
            var rankEl=document.getElementById('ausRanking');
            if(rankEl && sellers.length>0){
                var medals=['\ud83e\udd47','\ud83e\udd48','\ud83e\udd49'];
                var colors=['border-2 border-yellow-400 bg-yellow-50','border-2 border-gray-300 bg-gray-50','border-2 border-orange-300 bg-orange-50'];
                var rh='';
                sellers.slice(0,8).forEach(function(s,i){
                    var cls=i<3?colors[i]:'border border-gray-200';
                    var q=s.beratungen>0?Math.round(s.verkauft/s.beratungen*100):0;
                    rh+='<div class="p-4 '+cls+' rounded-xl text-center">';
                    rh+='<p class="text-3xl mb-1">'+(i<3?medals[i]:(i+1))+'</p>';
                    rh+='<p class="font-bold text-gray-800">'+s.name+'</p>';
                    rh+='<p class="text-xl font-bold text-vit-orange">'+eur(s.umsatz)+' \u20AC</p>';
                    rh+='<p class="text-xs text-gray-500">'+s.verkauft+' Verkaeufe Â· Quote: '+q+'%</p>';
                    rh+='</div>';
                });
                rankEl.innerHTML=rh;
            } else if(rankEl) {
                rankEl.innerHTML='<p class="text-sm text-gray-400 col-span-4 text-center py-4">Noch keine Verkaufsdaten erfasst. Nutze "+ Eintragen" in der Wochenansicht.</p>';
            }
        }

        async function saveVtEntry() {
            var datum = (document.getElementById('vtDate')||{}).value;
            var seller = (document.getElementById('vtSeller')||{}).value;
            var errEl = document.getElementById('vtError');
            var btn = document.getElementById('vtSaveBtn');
            if(!datum || !seller.trim()) { if(errEl){errEl.textContent='Bitte Datum und Verkaeufer eingeben.';errEl.style.display='block';} return; }
            var vi = function(id) { return parseInt((document.getElementById(id)||{}).value) || 0; };
            var vf = function(id) { return parseFloat((document.getElementById(id)||{}).value) || 0; };

            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var data = {
                    standort_id: stdId,
                    datum: datum,
                    verkaeufer_name: seller.trim(),
                    plan_termine: vi('vtPlan'),
                    geplant: vi('vtGeplant'),
                    spontan: vi('vtSpontan'),
                    online: vi('vtOnline'),
                    ergo: vi('vtErgo'),
                    verkauft: vi('vtVerkauft'),
                    uebergabe: vi('vtUebergabe'),
                    umsatz: vf('vtUmsatz'),
                    notizen: (document.getElementById('vtNotizen')||{}).value || null,
                    erfasst_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                var resp = await sb.from('verkauf_tracking').upsert(data, {onConflict:'standort_id,datum,verkaeufer_name'}).select();
                if(resp.error) throw resp.error;
                closeVtModal();
                alert('âœ… Verkaufsdaten gespeichert!');
                loadVerkaufTracking();
                loadWeekFromDb();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Speichern'; }
            }
        }

        // Load BWA on controlling tab open
        var origShowControllingTab = showControllingTab;
        showControllingTab = function(t) {
            origShowControllingTab(t);
            if(t === 'bwa') loadBwaList();
            if(t === 'planist') renderPlanIst();
            if(t === 'ctrlWissen') renderWissenTab('controlling','ctrlTabCtrlWissen');
        };

        // === LEAD REPORTING DASHBOARD (computed from hqStandorte) ===
        function getLeadData() {
            if(!hqStandorte || !Array.isArray(hqStandorte) || hqStandorte.length === 0) return { standorte: [], monate: [] };
            // Standorte performance sorted
            var standorte = hqStandorte.map(function(s) {
                return { name: s.name, perf: s.leadPerf || 0 };
            }).sort(function(a,b) { return a.perf - b.perf; });

            // Monthly data - use actual data from DB where available
            var monate = [
                { name: 'Jan', soll: 135.3 }, { name: 'Feb', soll: 287.4 },
                { name: 'Maerz', soll: 363.4 }, { name: 'Apr', soll: 397.3 },
                { name: 'Mai', soll: 432.9 }, { name: 'Jun', soll: 397.3 },
                { name: 'Jul', soll: 396.2 }, { name: 'Aug', soll: 359.7 },
                { name: 'Sep', soll: 324.0 }, { name: 'Okt', soll: 218.8 },
                { name: 'Nov', soll: 182.0 }, { name: 'Dez', soll: 108.2 }
            ];
            // Calculate actual totals from standorte
            var totalIst = hqStandorte.reduce(function(a,s){ return a + s.umsatzIst; }, 0);
            var totalLeads = hqStandorte.reduce(function(a,s){ return a + s.leads; }, 0);
            var currentMonth = new Date().getMonth();
            if(currentMonth >= 0 && totalIst > 0) monate[0].ist = Math.round(totalIst * 0.4 / 1000);
            if(currentMonth >= 1 && totalIst > 0) monate[1].ist = Math.round(totalIst * 0.6 / 1000);

            return { standorte: standorte, monate: monate };
        }

        function getPerformanceColor(perf) {
            if (perf >= 100) return 'bg-yellow-400';
            if (perf >= 75) return 'bg-green-500';
            if (perf >= 50) return 'bg-orange-500';
            return 'bg-red-500';
        }

        function getPerformanceDot(perf) {
            if (perf >= 100) return '#FBBF24';
            if (perf >= 75) return '#22C55E';
            if (perf >= 50) return '#F97316';
            return '#EF4444';
        }

        async function renderLeadDashboard() {
            try { if(hqStandorte.length === 0) await loadHqStandorte(); } catch(e) { console.warn('Lead dashboard: no HQ data'); }
            var leadData = getLeadData();
            if(!leadData || !leadData.monate) return;
            // Chart Bars
            var chartBars = document.getElementById('chartBars');
            var chartLabels = document.getElementById('chartLabels');
            if (!chartBars) return;
            var maxVal = 600;
            var barsHtml = '';
            var labelsHtml = '';
            leadData.monate.forEach(function(m) {
                var sollH = (m.soll / maxVal) * 100;
                var istH = m.ist ? (m.ist / maxVal) * 100 : 0;
                barsHtml += '<div class="flex-1 flex items-end justify-center space-x-1">' +
                    '<div class="w-5 bg-gray-300 rounded-t" style="height:' + sollH + '%;"></div>';
                if (m.ist) {
                    barsHtml += '<div class="w-5 bg-vit-orange rounded-t" style="height:' + istH + '%;"></div>';
                }
                barsHtml += '</div>';
                labelsHtml += '<span class="flex-1 text-center">' + m.name + '</span>';
            });
            chartBars.innerHTML = barsHtml;
            chartLabels.innerHTML = labelsHtml;

            // Detail Table
            var tbody = document.getElementById('detailTableBody');
            if (!tbody) return;
            var rowsHtml = '';
            leadData.monate.forEach(function(m, i) {
                var isCurrent = (i === 1);
                var rowClass = isCurrent ? 'bg-blue-50 border-l-4 border-blue-400' : '';
                var statusIcon = 'â³';
                if (m.perf) {
                    statusIcon = m.perf >= 100 ? 'âœ…' : 'âŒ';
                }
                rowsHtml += '<tr class="border-b border-gray-100 ' + rowClass + '">' +
                    '<td class="py-3 px-2 font-semibold text-gray-800">' + m.name + '</td>' +
                    '<td class="py-3 px-2 text-right text-gray-700">' + m.soll.toFixed(1) + '</td>' +
                    '<td class="py-3 px-2 text-right text-green-600 font-semibold">' + (m.ist || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-purple-600">' + (m.termin_cost ? m.termin_cost + ' â‚¬' : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-blue-600">' + (m.sv025 || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-orange-600">' + (m.sv_roh || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right font-bold text-gray-800">' + (m.gesamt ? m.gesamt.toFixed(1) : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right ' + (m.diff > 0 ? 'text-green-600' : m.diff < 0 ? 'text-red-600' : 'text-gray-400') + ' font-semibold">' + (m.diff ? (m.diff > 0 ? '+' : '') + m.diff.toFixed(1) : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right font-bold ' + (m.perf >= 100 ? 'text-green-600' : m.perf ? 'text-red-600' : 'text-gray-400') + '">' + (m.perf ? m.perf + '%' : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-center">' + statusIcon + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = rowsHtml;
        }

        // Render on load
        renderLeadDashboard();

        // === WISSEN MODULE ===
        function showWissenTab(tabName) {
            document.querySelectorAll('.wissen-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.wissen-tab-btn').forEach(function(b){
                b.className='wissen-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {akademie:'Akademie',handbuecher:'Handbuecher',bestpractices:'Bestpractices',faq:'Faq'};
            var el = document.getElementById('wissenTab' + (tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.wissen-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='wissen-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        // --- AKADEMIE DATA ---
        var akademieKurse = [
            {id:1, title:'Verkaufsgespraech E-Bike', desc:'Bedarfsermittlung, Einwandbehandlung, Abschluss-Techniken fuer E-Bike Beratung', cat:'verkauf', pflicht:true, dauer:'45 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:2, title:'Ergonomie-Beratung im Laden', desc:'Koerperanalyse, Sitzposition, Rahmengroesse bestimmen â€“ mit SQlab Methodik', cat:'verkauf', pflicht:true, dauer:'60 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:3, title:'Leasing richtig erklaeren', desc:'JobRad, Dienstrad, Bikeleasing â€“ Unterschiede, Rechenbeispiele, Einwaende', cat:'verkauf', pflicht:true, dauer:'30 Min.', progress:75, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:4, title:'Bosch Diagnose-Tool', desc:'Smart System, Fehlercode-Auslesen, Software-Updates, Kundenkommunikation', cat:'allgemein', pflicht:true, dauer:'90 Min.', progress:100, zertifikat:true, format:'ðŸ›  Workshop'},
            {id:5, title:'Shimano Steps Technik', desc:'Di2, EP8 Motor, Fehlerdiagnose, Firmware-Updates', cat:'allgemein', pflicht:false, dauer:'60 Min.', progress:50, zertifikat:false, format:'ðŸ›  Workshop'},
            {id:6, title:'vit:bikes Kassensystem Schulung', desc:'Tagesabschluss, Retouren, Gutscheine, Lagerbuchungen im POS', cat:'allgemein', pflicht:true, dauer:'40 Min.', progress:100, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:7, title:'Social Media fuer Partner', desc:'Reels erstellen, Story-Formate, Hashtag-Strategie, Content-Kalender', cat:'marketing', pflicht:false, dauer:'35 Min.', progress:30, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:8, title:'Google My Business optimieren', desc:'Fotos, Beitraege, Rezensionen beantworten, Insights nutzen', cat:'marketing', pflicht:false, dauer:'25 Min.', progress:100, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:9, title:'Event-Planung &amp; Durchfuehrung', desc:'Testivals, Grillvents, Schluesselaktionen â€“ von der Idee bis zur Nachbereitung', cat:'marketing', pflicht:false, dauer:'50 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:10, title:'Vororder richtig planen', desc:'Bedarfsanalyse, Saisonplanung, Verhandlung mit Lieferanten, Blockorder-Strategie', cat:'einkauf', pflicht:true, dauer:'55 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:11, title:'Rohertrag optimieren', desc:'Rabatt-Strategie, Dreingaben statt Nachlass, Marken-Mix fuer maximalen DB', cat:'einkauf', pflicht:false, dauer:'30 Min.', progress:60, zertifikat:false, format:'ðŸ“Š Case Study'},
            {id:12, title:'Lagermanagement &amp; Umschlag', desc:'Bestandsoptimierung, Slow-Mover erkennen, Abverkaufsstrategien', cat:'einkauf', pflicht:false, dauer:'40 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:13, title:'BWA lesen &amp; verstehen', desc:'Umsatzerloese, Rohertrag, Kostenarten, Betriebsergebnis â€“ Praxis fuer Nicht-Kaufleute', cat:'controlling', pflicht:true, dauer:'45 Min.', progress:100, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:14, title:'Plan/Ist-Analyse durchfuehren', desc:'Monatliche Abweichungen erkennen, Massnahmen ableiten, Benchmarks nutzen', cat:'controlling', pflicht:false, dauer:'35 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:15, title:'Liquiditaetsplanung Basics', desc:'Cashflow verstehen, Zahlungsziele nutzen, saisonale Engpaesse vorbeugen', cat:'controlling', pflicht:false, dauer:'30 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:16, title:'Pipeline-Management im Portal', desc:'Leads erfassen, Kanban nutzen, Wiedervorlage, Conversion-Tracking', cat:'verkauf', pflicht:false, dauer:'20 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:17, title:'Reklamation &amp; Garantie', desc:'Ablauf Garantiefall, Hersteller-Kontakt, Dokumentation, Kulanz-Regeln', cat:'allgemein', pflicht:false, dauer:'35 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:18, title:'Personalfuehrung im Fachhandel', desc:'Teamgespraeche, Zielvereinbarungen, Motivation, Feedback-Kultur', cat:'allgemein', pflicht:false, dauer:'50 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'}
        ];
        var akdFilterCat = 'all';
        function filterAkademie(cat) {
            akdFilterCat = cat;
            document.querySelectorAll('.akd-filter-btn').forEach(function(b){ b.className='akd-filter-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.akd-filter-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='akd-filter-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderAkademie();
        }
        function renderAkademie() {
            var g = document.getElementById('akademieGrid'); if(!g) return;
            var filtered = akademieKurse.filter(function(k){ return akdFilterCat==='all' || k.cat===akdFilterCat; });
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var h = '';
            filtered.forEach(function(k){
                var pColor = k.progress>=100?'bg-green-500':k.progress>=50?'bg-vit-orange':'bg-gray-300';
                var statusText = k.progress>=100?'<span class="text-green-600 text-xs font-bold">âœ“ Abgeschlossen</span>':k.progress>0?'<span class="text-vit-orange text-xs font-bold">In Bearbeitung</span>':'<span class="text-gray-400 text-xs">Nicht gestartet</span>';
                h += '<div class="vit-card p-5">' +
                    '<div class="flex items-start justify-between mb-2">' +
                        '<div class="flex items-center space-x-2">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[k.cat]+'">'+catLabels[k.cat]+'</span>' +
                            (k.pflicht?'<span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700">Pflicht</span>':'') +
                            '<span class="text-xs text-gray-400">'+k.format+'</span>' +
                        '</div>' +
                        (k.zertifikat?'<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-semibold">ðŸ† Zertifikat</span>':'') +
                    '</div>' +
                    '<h4 class="font-semibold text-gray-800 mb-1">'+k.title+'</h4>' +
                    '<p class="text-xs text-gray-500 mb-3">'+k.desc+'</p>' +
                    '<div class="flex items-center justify-between">' +
                        '<div class="flex-1 mr-4"><div class="w-full bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div></div>' +
                        '<span class="text-xs text-gray-500 mr-3">'+k.progress+'%</span>' +
                        '<span class="text-xs text-gray-400">'+k.dauer+'</span>' +
                    '</div>' +
                    '<div class="mt-2">'+statusText+'</div>' +
                '</div>';
            });
            g.innerHTML = h || '<p class="text-gray-400 text-sm py-8 text-center">Keine Kurse in dieser Kategorie.</p>';
        }
        renderAkademie();

        // --- HANDBUECHER DATA ---
        var handbuecher = [
            {title:'Bosch Smart System â€“ Einrichtung &amp; Diagnose', cat:'allgemein', marke:'Bosch', typ:'PDF', seiten:42, aktualisiert:'01/2026'},
            {title:'Shimano Steps EP8 â€“ Fehlercodes &amp; Loesungen', cat:'allgemein', marke:'Shimano', typ:'PDF', seiten:28, aktualisiert:'11/2025'},
            {title:'Shimano Di2 â€“ Einstellungen &amp; Updates', cat:'allgemein', marke:'Shimano', typ:'PDF', seiten:35, aktualisiert:'09/2025'},
            {title:'Kalkhoff Garantieabwicklung â€“ Prozesshandbuch', cat:'einkauf', marke:'Kalkhoff', typ:'PDF', seiten:18, aktualisiert:'03/2025'},
            {title:'Haibike Modellkatalog 2026', cat:'einkauf', marke:'Haibike', typ:'Katalog', seiten:64, aktualisiert:'10/2025'},
            {title:'Orbea MyO Konfigurator â€“ Haendler-Guide', cat:'verkauf', marke:'Orbea', typ:'PDF', seiten:12, aktualisiert:'06/2025'},
            {title:'Simplon Bestellprozess B2B-Portal', cat:'einkauf', marke:'Simplon', typ:'PDF', seiten:8, aktualisiert:'08/2025'},
            {title:'vit:bikes Kassensystem â€“ Benutzerhandbuch', cat:'allgemein', marke:'vit:bikes', typ:'PDF', seiten:55, aktualisiert:'01/2026'},
            {title:'vit:bikes CI-Guide â€“ Logo, Farben, Vorlagen', cat:'marketing', marke:'vit:bikes', typ:'PDF', seiten:24, aktualisiert:'04/2025'},
            {title:'Meta Business Suite â€“ Anleitung fuer Partner', cat:'marketing', marke:'Meta', typ:'PDF', seiten:32, aktualisiert:'02/2026'},
            {title:'Google Ads â€“ Kampagnen-Setup Leitfaden', cat:'marketing', marke:'Google', typ:'PDF', seiten:20, aktualisiert:'12/2025'},
            {title:'JobRad Haendler-Handbuch', cat:'verkauf', marke:'JobRad', typ:'PDF', seiten:38, aktualisiert:'01/2026'},
            {title:'Bikeleasing â€“ Vertragsprozess A-Z', cat:'verkauf', marke:'Bikeleasing', typ:'PDF', seiten:15, aktualisiert:'11/2025'},
            {title:'DATEV-Schnittstelle â€“ BWA-Export Anleitung', cat:'controlling', marke:'DATEV', typ:'PDF', seiten:10, aktualisiert:'01/2026'},
            {title:'Liquiditaetsplanung â€“ Excel-Vorlage &amp; Erklaerung', cat:'controlling', marke:'vit:bikes', typ:'Excel', seiten:5, aktualisiert:'09/2025'},
            {title:'SQlab Ergonomie-Messung â€“ Leitfaden', cat:'verkauf', marke:'SQlab', typ:'PDF', seiten:22, aktualisiert:'07/2025'},
            {title:'Velo de Ville â€“ Konfigurator &amp; Bestellprozess', cat:'einkauf', marke:'Velo de Ville', typ:'PDF', seiten:14, aktualisiert:'10/2025'},
            {title:'etermin â€“ Terminbuchung Setup', cat:'allgemein', marke:'etermin', typ:'PDF', seiten:9, aktualisiert:'05/2025'}
        ];
        var hbFilterCat = 'all';
        function filterHbCat(cat) {
            hbFilterCat = cat;
            document.querySelectorAll('.hb-cat-btn').forEach(function(b){ b.className='hb-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.hb-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='hb-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderHandbuecher();
        }
        function filterHandbuecher() { renderHandbuecher(); }
        function renderHandbuecher() {
            var g = document.getElementById('handbuchGrid'); if(!g) return;
            var q = (document.getElementById('hbSearch')||{}).value||'';
            q = q.toLowerCase();
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var typIcons = {PDF:'ðŸ“„',Katalog:'ðŸ“•',Excel:'ðŸ“Š'};
            var filtered = handbuecher.filter(function(h){
                var catOk = hbFilterCat==='all' || h.cat===hbFilterCat;
                var searchOk = !q || h.title.toLowerCase().indexOf(q)>-1 || h.marke.toLowerCase().indexOf(q)>-1 || h.cat.indexOf(q)>-1;
                return catOk && searchOk;
            });
            var html = '';
            filtered.forEach(function(h){
                html += '<div class="vit-card p-4 flex items-center justify-between">' +
                    '<div class="flex items-center space-x-4">' +
                        '<span class="text-2xl">'+(typIcons[h.typ]||'ðŸ“„')+'</span>' +
                        '<div>' +
                            '<p class="font-semibold text-sm text-gray-800">'+h.title+'</p>' +
                            '<div class="flex items-center space-x-2 mt-1">' +
                                '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[h.cat]+'">'+catLabels[h.cat]+'</span>' +
                                '<span class="text-xs text-gray-400">'+h.marke+'</span>' +
                                '<span class="text-xs text-gray-400">Â·</span>' +
                                '<span class="text-xs text-gray-400">'+h.seiten+' Seiten</span>' +
                                '<span class="text-xs text-gray-400">Â·</span>' +
                                '<span class="text-xs text-gray-400">Aktualisiert: '+h.aktualisiert+'</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<button class="px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:bg-orange-600">Oeffnen</button>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine Handbuecher gefunden.</p>';
        }
        renderHandbuecher();

        // --- BEST PRACTICES DATA ---
        var bestPractices = [
            {title:'So hat Hamburg seinen Rohertrag um 4 Pp gesteigert', cat:'einkauf', standort:'Hamburg', datum:'01/2026', desc:'Durch konsequentes Anbieten von Orbea und Simplon statt Kalkhoff-Einstiegsmodellen konnte Hamburg den durchschnittlichen DB1 von 31% auf 35% steigern.', likes:24, typ:'ðŸ“ˆ Erfolgsgeschichte'},
            {title:'Werkstatt-Auslastung auf 92% optimiert', cat:'allgemein', standort:'Muenchen-Thal.', datum:'11/2025', desc:'Durch Einfuehrung fester Werkstatt-Slots via etermin und Vorab-Diagnose am Telefon konnte die Durchlaufzeit pro Rad um 25% gesenkt werden.', likes:31, typ:'âš™ï¸ Prozess'},
            {title:'Erfolgreiche Event-Formate: Testival + Grillevent', cat:'marketing', standort:'Grafrath', datum:'05/2025', desc:'Kombination aus Probefahrten und lockerer Atmosphaere mit Waffeln und Getraenken. 108 Store Visits, 40 Terminbuchungen. Benefit statt Rabatt in den Vordergrund stellen.', likes:18, typ:'ðŸŽª Event'},
            {title:'Sqlab-Sattel statt Rabatt: 50% weniger Rohertragsverlust', cat:'verkauf', standort:'Zentrale', datum:'09/2025', desc:'100â‚¬ Sqlab Sattel als Dreingabe statt 100â‚¬ Rabatt: Kunde erhaelt gefuehlt gleichen Vorteil, Rohertragsverlust nur 50â‚¬ netto statt 100â‚¬.', likes:42, typ:'ðŸ’° Tipp'},
            {title:'Leasing-Anteil auf 38% gesteigert', cat:'verkauf', standort:'Wesel', datum:'12/2025', desc:'Durch aktive Ansprache und eine Leasing-Vergleichstabelle am Beratungsplatz konnten wir den Leasing-Anteil von 22% auf 38% steigern. Hoehere Durchschnittspreise als Effekt.', likes:27, typ:'ðŸ“ˆ Erfolgsgeschichte'},
            {title:'Google My Business: Von 4.2 auf 4.8 Sterne', cat:'marketing', standort:'Reutlingen', datum:'10/2025', desc:'Systematisches Ansprechen zufriedener Kunden bei Raduebergabe. QR-Code auf Kassenbon. Jede Rezension innerhalb 24h beantworten â€“ auch negative.', likes:35, typ:'â­ Tipp'},
            {title:'BWA monatlich im Team besprechen', cat:'controlling', standort:'Holzkirchen', datum:'02/2026', desc:'Jeden 10. des Monats 30-Min-Meeting mit allen Verkaeufern. Umsatz, Rohertrag, Nachlass-Quote transparent machen. Bewusstsein fuer Kosten schaerfen.', likes:19, typ:'ðŸ“Š Prozess'},
            {title:'Vororder-Planung mit Verkaufsdaten', cat:'einkauf', standort:'Karlsdorf-Neuth.', datum:'08/2025', desc:'Statt nach Bauchgefuehl zu ordern: Top-10-Modelle des Vorjahres als Basis, +10% Puffer fuer Wachstumsmarken, -20% fuer ruecklaeufige Kategorien.', likes:22, typ:'ðŸ“¦ Prozess'},
            {title:'Personalgespraeche alle 6 Wochen', cat:'allgemein', standort:'Muenster', datum:'01/2026', desc:'Kurze 20-Min-Check-ins mit jedem Mitarbeiter. Keine grossen Ueberraschungen bei Jahresgespraechen. Motivation und Bindung deutlich gestiegen.', likes:15, typ:'ðŸ‘¥ Fuehrung'},
            {title:'Plan/Ist-Abgleich als Fruehwarnsystem', cat:'controlling', standort:'Weilheim', datum:'11/2025', desc:'Wenn Umsatz in KW4 unter 80% des Plans liegt, sofort Gegenmassnahmen einleiten: Aktionen, Kundenkontakt, Social Media Push. Nicht bis Monatsende warten.', likes:28, typ:'ðŸš¨ Tipp'}
        ];
        var bpFilterCat = 'all';
        function filterBP(cat) {
            bpFilterCat = cat;
            document.querySelectorAll('.bp-cat-btn').forEach(function(b){ b.className='bp-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.bp-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='bp-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderBP();
        }
        function renderBP() {
            var g = document.getElementById('bpGrid'); if(!g) return;
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var filtered = bestPractices.filter(function(b){ return bpFilterCat==='all' || b.cat===bpFilterCat; });
            var html = '';
            filtered.forEach(function(b){
                html += '<div class="vit-card p-5">' +
                    '<div class="flex items-center justify-between mb-2">' +
                        '<div class="flex items-center space-x-2">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[b.cat]+'">'+catLabels[b.cat]+'</span>' +
                            '<span class="text-xs text-gray-400">'+b.typ+'</span>' +
                        '</div>' +
                        '<span class="text-xs text-gray-400">'+b.standort+' Â· '+b.datum+'</span>' +
                    '</div>' +
                    '<h4 class="font-semibold text-gray-800 mb-2">'+b.title+'</h4>' +
                    '<p class="text-sm text-gray-600 mb-3">'+b.desc+'</p>' +
                    '<div class="flex items-center justify-between">' +
                        '<span class="text-xs text-gray-400">ðŸ‘ '+b.likes+' Partner fanden das hilfreich</span>' +
                        '<button class="text-xs text-vit-orange font-semibold hover:text-orange-600">Hilfreich ðŸ‘</button>' +
                    '</div>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine Best Practices in dieser Kategorie.</p>';
        }
        renderBP();

        // --- FAQ DATA ---
        var faqItems = [
            {q:'Wie funktioniert die Garantieabwicklung bei Kalkhoff?', a:'Defektes Teil fotografieren, im Kalkhoff B2B-Portal Garantieantrag stellen (unter Service > Garantie). Bearbeitungszeit ca. 5-7 Werktage. Bei Rahmenbruch immer zuerst vit:bikes Einkauf kontaktieren.', cat:'einkauf'},
            {q:'Welche Leasing-Anbieter sind zugelassen?', a:'JobRad, Deutsche Dienstrad, Bikeleasing, Businessbike und Lease-a-Bike. Alle Anbieter sind im Kassensystem hinterlegt. Fuer neue Anbieter bitte Support-Ticket erstellen.', cat:'verkauf'},
            {q:'Wie erstelle ich eine Retoure im Kassensystem?', a:'Verkauf > Retoure > Originalbeleg scannen oder Belegnummer eingeben. Grund auswaehlen. Bei Retouren ueber 500â‚¬ ist eine Freigabe durch den Inhaber erforderlich.', cat:'allgemein'},
            {q:'Wann bekomme ich meine monatliche BWA?', a:'Die BWA wird jeweils bis zum 15. des Folgemonats vom Steuerberater bereitgestellt und ist dann im Controlling-Modul unter BWAs abrufbar.', cat:'controlling'},
            {q:'Wie aendere ich mein Marketing-Budget?', a:'Das Marketing-Budget kann jederzeit nach Absprache mit dem vit:bikes Marketing-Team angepasst werden. Aenderungen sind jeweils zum Monatsanfang des Folgemonats wirksam. Kontakt: Michael Stenzel.', cat:'marketing'},
            {q:'Was tun bei Bosch-Fehlermeldung am Display?', a:'Fehlercode notieren, im Bosch Diagnose-Tool auslesen (siehe Handbuch). Bei Codes 5xx: Software-Update durchfuehren. Bei Hardware-Fehlern (Codes 6xx/7xx): Bosch Service-Ticket im B2B-Portal.', cat:'allgemein'},
            {q:'Wie funktioniert die Vororder?', a:'Die Vororder fuer das Folgejahr wird zwischen Juli und Oktober platziert. Konditionen werden vorab mit vit:bikes Einkauf abgestimmt. Bestellungen laufen ueber die jeweiligen B2B-Portale der Hersteller.', cat:'einkauf'},
            {q:'Wie kann ich Rabatte im Kassensystem dokumentieren?', a:'Bei jedem Verkauf mit Rabatt das Feld Nachlass-Grund ausfuellen. Woechentlich die Nachlass-Auswertung pruefen. Ziel: unter 5% durchschnittlicher Nachlass.', cat:'verkauf'},
            {q:'Welche Kosten traegt vit:bikes beim Marketing?', a:'vit:bikes steuert die zentrale Kampagnenplanung, Content-Erstellung und Kanal-Optimierung bei. Das Mediabudget (z.B. 1.500â‚¬/Monat) wird vom Partner getragen.', cat:'marketing'},
            {q:'Wie buche ich einen Werkstatt-Termin ueber etermin?', a:'Kunden koennen direkt ueber die Standortseite auf vitbikes.de buchen. Intern: etermin-Backend > Neuer Termin > Kategorie Werkstatt. Zeiten sind in 30-Min-Slots konfiguriert.', cat:'allgemein'},
            {q:'Was ist der Unterschied zwischen Plan und Forecast?', a:'Der Plan wird einmal jaehrlich im Voraus erstellt (Planung_2026). Der Forecast wird monatlich angepasst basierend auf der aktuellen Entwicklung. Beide sind im Controlling-Modul sichtbar.', cat:'controlling'},
            {q:'Wie melde ich einen IT-Fehler?', a:'Im Support-Bereich ein Ticket mit Kategorie "IT" erstellen. Screenshot beifuegen. Kritische Ausfaelle (Kasse, Internet): direkt IT-Hotline anrufen unter 089/123456-99.', cat:'allgemein'},
            {q:'Wie funktioniert der Skonto bei Kalkhoff?', a:'3% Skonto bei Zahlung innerhalb von 14 Tagen. Bei Vororder-Bikes gilt das Skonto ab Rechnungsdatum, nicht ab Lieferdatum. Achtung: Skonto verfaellt bei verspaeteter Zahlung komplett.', cat:'einkauf'},
            {q:'Kann ich eigene Social-Media-Posts machen?', a:'Ja, ausdruecklich erwuenscht! Bitte den vit:bikes CI-Guide beachten (Logo-Verwendung, Farben). Organische Posts werden vom Content-Team gerne auf den zentralen Kanaelen geteilt.', cat:'marketing'},
            {q:'Wie interpretiere ich die Rohertragsmarge?', a:'Rohertrag = VK netto minus EK netto. Rohertragsmarge = Rohertrag / VK netto Ã— 100. Zielwert bei E-Bikes: 35-42%. Unter 30% sollte Ursachenanalyse erfolgen (zu viel Rabatt? falsche Modelle?).', cat:'controlling'}
        ];
        var faqFilterCat = 'all';
        function filterFaqCat(cat) {
            faqFilterCat = cat;
            document.querySelectorAll('.faq-cat-btn').forEach(function(b){ b.className='faq-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.faq-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='faq-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderFAQ();
        }
        function filterFAQ() { renderFAQ(); }
        function renderFAQ() {
            var g = document.getElementById('faqGrid'); if(!g) return;
            var q = (document.getElementById('faqSearch')||{}).value||'';
            q = q.toLowerCase();
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var filtered = faqItems.filter(function(f){
                var catOk = faqFilterCat==='all' || f.cat===faqFilterCat;
                var searchOk = !q || f.q.toLowerCase().indexOf(q)>-1 || f.a.toLowerCase().indexOf(q)>-1;
                return catOk && searchOk;
            });
            var html = '';
            filtered.forEach(function(f, idx){
                var faqId = 'faq_'+faqFilterCat+'_'+idx;
                html += '<div class="vit-card overflow-hidden">' +
                    '<button onclick="toggleFaq(\''+faqId+'\')" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50">' +
                        '<div class="flex items-center space-x-3">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[f.cat]+'">'+catLabels[f.cat]+'</span>' +
                            '<span class="font-semibold text-sm text-gray-800">'+f.q+'</span>' +
                        '</div>' +
                        '<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
                    '</button>' +
                    '<div id="'+faqId+'" style="display:none" class="px-4 pb-4 border-t border-gray-100">' +
                        '<p class="text-sm text-gray-600 pt-3">'+f.a+'</p>' +
                    '</div>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine FAQ-Eintraege gefunden.</p>';
        }
        function toggleFaq(id) {
            var el = document.getElementById(id);
            if(el) el.style.display = el.style.display==='none'?'block':'none';
        }
        renderFAQ();

        // === Dashboards Tabs ===
        var dashTabInited = false;
        function initDashboardTabs() {
            if(dashTabInited) return;
            dashTabInited = true;
            // Move contents from old separate views into tab containers
            var finSrc = document.getElementById('financesView');
            var leadSrc = document.getElementById('leadReportingView');
            var teamSrc = document.getElementById('teamView');
            var finDest = document.getElementById('dashTabFinanzen');
            var leadDest = document.getElementById('dashTabLeadreporting');
            var teamDest = document.getElementById('dashTabTeam');
            if(finSrc && finDest) { while(finSrc.firstChild) finDest.appendChild(finSrc.firstChild); }
            if(leadSrc && leadDest) { while(leadSrc.firstChild) leadDest.appendChild(leadSrc.firstChild); }
            if(teamSrc && teamDest) { while(teamSrc.firstChild) teamDest.appendChild(teamSrc.firstChild); }
        }
        function showDashboardTab(tabName) {
            initDashboardTabs();
            document.querySelectorAll('.dash-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.dash-tab-btn').forEach(function(b){
                b.className='dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {finanzen:'Finanzen',leadreporting:'Leadreporting',team:'Team'};
            var el = document.getElementById('dashTab' + (tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.dash-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        // === WISSEN TABS (kontextuell pro Modul) ===
        // Static knowledge base - can be enriched from DB (netzwerk_dokumente)
        var wissenData = {
            allgemein: {
                akademie: [
                    {title:'Onboarding: vit:bikes Partner werden',dauer:'45 min',typ:'pflicht',progress:100,desc:'Einfuehrung in Systeme, Prozesse und Ansprechpartner'},
                    {title:'Kassensystem & Warenwirtschaft',dauer:'30 min',typ:'pflicht',progress:75,desc:'Tagesabschluss, Retouren, Gutscheine, Inventur'},
                    {title:'Datenschutz & DSGVO im Handel',dauer:'20 min',typ:'pflicht',progress:0,desc:'Kundendaten, Einwilligungen, Loeschfristen'},
                    {title:'Arbeitsschutz & Ladensicherheit',dauer:'15 min',typ:'wahl',progress:0,desc:'Brandschutz, Erste Hilfe, Diebstahlpraevention'}
                ],
                handbuecher: [
                    {title:'vit:bikes Partner-Handbuch 2026',marke:'vit:bikes',typ:'PDF',seiten:64},
                    {title:'CI-Guide: Logo, Farben, Schriften',marke:'vit:bikes',typ:'PDF',seiten:12},
                    {title:'Leasing-Leitfaden (JobRad, Dienstrad, Bikeleasing)',marke:'Uebergreifend',typ:'PDF',seiten:28},
                    {title:'Garantie- & Reklamationshandbuch',marke:'vit:bikes',typ:'PDF',seiten:35}
                ],
                bestpractices: [
                    {title:'So hat Hamburg seinen Rohertrag um 4 Pp gesteigert',standort:'Hamburg',datum:'Jan 2026',tags:['Rohertrag','Rabatte']},
                    {title:'Werkstatt-Auslastung optimieren: 5 Hebel',standort:'Zentrale',datum:'Dez 2025',tags:['Werkstatt','Effizienz']},
                    {title:'Erfolgreiche Event-Formate fuer Standorte',standort:'Weilheim',datum:'Nov 2025',tags:['Events','Marketing']}
                ],
                faq: [
                    {frage:'Wie melde ich einen Garantiefall?',kat:'Prozesse'},
                    {frage:'Welche Leasing-Anbieter sind freigeschaltet?',kat:'Leasing'},
                    {frage:'Wie funktioniert die Upway-Abwicklung?',kat:'Einkauf'},
                    {frage:'Wer ist mein Ansprechpartner bei IT-Problemen?',kat:'IT/Support'},
                    {frage:'Wie laeuft die Monatsabrechnung?',kat:'Buchhaltung'}
                ]
            },
            marketing: {
                akademie: [
                    {title:'Social Media fuer Fahrradhaendler',dauer:'60 min',typ:'pflicht',progress:50,desc:'Instagram, Facebook, TikTok: Content-Strategie fuer lokale Reichweite'},
                    {title:'Google My Business optimieren',dauer:'25 min',typ:'pflicht',progress:100,desc:'Profil pflegen, Rezensionen beantworten, Beitraege posten'},
                    {title:'Individuelle Ads erstellen (Meta)',dauer:'40 min',typ:'wahl',progress:30,desc:'Reels drehen, Texte schreiben, Zielgruppen definieren'},
                    {title:'Event-Marketing: Testival planen',dauer:'35 min',typ:'wahl',progress:0,desc:'Checkliste, Zeitplan, Bewerbung, Nachbereitung'}
                ],
                handbuecher: [
                    {title:'vit:bikes Content-Styleguide',marke:'vit:bikes',typ:'PDF',seiten:18},
                    {title:'Meta Ads Manager â€“ Schritt fuer Schritt',marke:'Meta',typ:'PDF',seiten:24},
                    {title:'Google Ads fuer lokale Haendler',marke:'Google',typ:'PDF',seiten:20},
                    {title:'Etermin: Terminbuchung einrichten',marke:'Etermin',typ:'PDF',seiten:8}
                ],
                bestpractices: [
                    {title:'Individuelle Ads: 3x bessere CTR als generische',standort:'Zentrale',datum:'Feb 2026',tags:['Ads','Performance']},
                    {title:'Wie Weilheim 91% Storevisit-Ziel erreicht',standort:'Weilheim',datum:'Jan 2026',tags:['Storevisits','Meta']},
                    {title:'Influencer-Kooperation: So funktioniert es',standort:'Muenchen Ost',datum:'Dez 2025',tags:['Influencer','Content']}
                ],
                faq: [
                    {frage:'Wie kann ich mein Marketing-Budget aendern?',kat:'Budget'},
                    {frage:'Wann werden neue Ads geschaltet?',kat:'Ads'},
                    {frage:'Kann ich eigene Stories auf dem vit:bikes Kanal posten?',kat:'Content'},
                    {frage:'Wie messe ich den Erfolg meiner Kampagnen?',kat:'Analytics'},
                    {frage:'Was kostet ein lokales Event?',kat:'Events'}
                ]
            },
            einkauf: {
                akademie: [
                    {title:'Einkaufsstrategie verstehen & umsetzen',dauer:'45 min',typ:'pflicht',progress:60,desc:'Vororder, Blockorder, Konditionen, Rabattsteuerung'},
                    {title:'Rohertrag optimieren: Praxis-Workshop',dauer:'50 min',typ:'pflicht',progress:25,desc:'DB1 berechnen, Dreingaben vs. Rabatte, Nachlass-Tracking'},
                    {title:'B2B-Portale der Lieferanten nutzen',dauer:'30 min',typ:'wahl',progress:0,desc:'Kalkhoff, Shimano, Orbea: Bestellprozesse und Retouren'},
                    {title:'Lagerbestand & Umschlag steuern',dauer:'25 min',typ:'wahl',progress:0,desc:'Ladenhuter erkennen, Saisonplanung, Abverkaufsstrategien'}
                ],
                handbuecher: [
                    {title:'Kalkhoff/Derby Cycle â€“ Haendlerportal Guide',marke:'Kalkhoff',typ:'PDF',seiten:16},
                    {title:'Shimano Steps â€“ Fehlercodes & Diagnose',marke:'Shimano',typ:'PDF',seiten:42},
                    {title:'Bosch Smart System â€“ Einrichtung & Updates',marke:'Bosch',typ:'PDF',seiten:38},
                    {title:'Haibike Modellueberblick 2026',marke:'Haibike',typ:'PDF',seiten:22},
                    {title:'Orbea MyO Konfigurator â€“ Haendler-Anleitung',marke:'Orbea',typ:'PDF',seiten:14}
                ],
                bestpractices: [
                    {title:'Sqlab-Sattel statt Rabatt: 50% weniger DB-Verlust',standort:'Zentrale',datum:'Sep 2025',tags:['Rohertrag','Dreingaben']},
                    {title:'Kalkhoff 7er-Modelle ueber Upway: So gehts',standort:'Grafrath',datum:'Okt 2025',tags:['Upway','Abverkauf']},
                    {title:'Haibike Blockorder: Verhandlungstipps',standort:'Zentrale',datum:'Aug 2025',tags:['Haibike','Konditionen']}
                ],
                faq: [
                    {frage:'Wie platziere ich eine Nachbestellung?',kat:'Bestellung'},
                    {frage:'Was tun bei Lieferverzoegerung?',kat:'Logistik'},
                    {frage:'Wie funktioniert die Garantieabwicklung pro Marke?',kat:'Garantie'},
                    {frage:'Kann ich Konditionen individuell verhandeln?',kat:'Konditionen'},
                    {frage:'Wie melde ich defekte Ware / Transportschaden?',kat:'Reklamation'}
                ]
            },
            controlling: {
                akademie: [
                    {title:'BWA lesen & verstehen',dauer:'40 min',typ:'pflicht',progress:80,desc:'Umsatzerloese, Wareneinsatz, Rohertrag, Betriebsergebnis'},
                    {title:'Plan/Ist-Vergleich nutzen',dauer:'30 min',typ:'pflicht',progress:40,desc:'Abweichungen erkennen, Massnahmen ableiten, Prognosen'},
                    {title:'Liquiditaetsplanung Basics',dauer:'25 min',typ:'wahl',progress:0,desc:'Cashflow verstehen, Engpaesse vermeiden, Vorausplanung'},
                    {title:'Benchmarking im vit:bikes Netzwerk',dauer:'20 min',typ:'wahl',progress:10,desc:'Eigene Kennzahlen vs. Netzwerk, Potentiale erkennen'}
                ],
                handbuecher: [
                    {title:'BWA-Positionen: Was steckt hinter jeder Zeile',marke:'vit:bikes',typ:'PDF',seiten:20},
                    {title:'Steuerliche Grundlagen fuer Fahrradhaendler',marke:'Uebergreifend',typ:'PDF',seiten:32},
                    {title:'DATEV-Schnittstelle: Belege digital einreichen',marke:'DATEV',typ:'PDF',seiten:12},
                    {title:'Investitionsplanung & AfA im Fahrradhandel',marke:'vit:bikes',typ:'PDF',seiten:16}
                ],
                bestpractices: [
                    {title:'Werbekosten im Griff: 5% vom Umsatz als Faustregel',standort:'Zentrale',datum:'Jan 2026',tags:['Marketing-Budget','Planung']},
                    {title:'Personalkosten-Quote senken ohne Kuerzungen',standort:'Hamburg',datum:'Nov 2025',tags:['Personal','Effizienz']},
                    {title:'Saisonale Liquiditaetsplanung: Vorsaison richtig finanzieren',standort:'Zentrale',datum:'Okt 2025',tags:['Liquiditaet','Cashflow']}
                ],
                faq: [
                    {frage:'Wann erhalte ich meine monatliche BWA?',kat:'BWA'},
                    {frage:'Wie ist die Ziel-Rohertragsmarge?',kat:'Kennzahlen'},
                    {frage:'Wer ist fuer die Buchhaltung zustaendig?',kat:'Prozesse'},
                    {frage:'Wie beantrage ich eine Investition?',kat:'Investition'},
                    {frage:'Was bedeuten die Benchmark-Ampelfarben?',kat:'Benchmark'}
                ]
            },
            verkauf: {
                akademie: [
                    {title:'Verkaufsgespraech E-Bike: Beratungsleitfaden',dauer:'60 min',typ:'pflicht',progress:65,desc:'Bedarfsanalyse, Probefahrt, Abschluss, Finanzierung'},
                    {title:'Ergonomie-Beratung: Sitzposition & Rahmengroesse',dauer:'45 min',typ:'pflicht',progress:90,desc:'Vermessung, Sattel, Lenker, Vorbau â€“ der Unterschied'},
                    {title:'Leasing richtig erklaeren (JobRad & Co.)',dauer:'30 min',typ:'pflicht',progress:40,desc:'Steuervorteile, Ablauf, Arbeitgeber-Ansprache, Rechner'},
                    {title:'Einwaende souveraen behandeln',dauer:'35 min',typ:'wahl',progress:15,desc:'Preis, Online-Vergleich, Lieferzeit â€“ die Top-5 Einwaende'},
                    {title:'Zusatzverkauf: Zubehoer & Service-Pakete',dauer:'20 min',typ:'wahl',progress:0,desc:'Helme, Schloesser, Sqlab, Versicherung, Inspektion'}
                ],
                handbuecher: [
                    {title:'Beratungsbogen / Setting-Tool Anleitung',marke:'vit:bikes',typ:'PDF',seiten:8},
                    {title:'Finanzierungsrechner: So nutzt du den Kalkulator',marke:'vit:bikes',typ:'PDF',seiten:6},
                    {title:'Probefahrt-Protokoll & Haftung',marke:'vit:bikes',typ:'PDF',seiten:4},
                    {title:'E-Bike Kategorie-Guide: Trekking vs. MTB vs. City',marke:'Uebergreifend',typ:'PDF',seiten:18}
                ],
                bestpractices: [
                    {title:'Pipeline-Management: Kein Lead geht verloren',standort:'Karlsdorf-Neuth.',datum:'Feb 2026',tags:['Pipeline','Follow-up']},
                    {title:'Orbea & Simplon aktiv verkaufen: Verkaeufermotivation',standort:'Grafrath',datum:'Sep 2025',tags:['Beratung','Rohertrag']},
                    {title:'Testival als Verkaufs-Booster: 23 Abschluesse an einem Tag',standort:'Weilheim',datum:'Mai 2025',tags:['Events','Abschluss']}
                ],
                faq: [
                    {frage:'Wie viel Rabatt darf ich maximal geben?',kat:'Konditionen'},
                    {frage:'Wie trage ich einen Verkauf in die Pipeline ein?',kat:'Pipeline'},
                    {frage:'Was mache ich bei einer Stornierung?',kat:'Prozesse'},
                    {frage:'Wie funktioniert die Uebergabe an den Kunden?',kat:'Uebergabe'},
                    {frage:'Wann wird die Wochenauswertung aktualisiert?',kat:'Reporting'}
                ]
            }
        };

        function renderWissenTab(bereich, containerId) {
            var d = wissenData[bereich];
            if(!d) return;
            var el = document.getElementById(containerId);
            if(!el || el.dataset.rendered) return;
            el.dataset.rendered = 'true';
            var h = '';

            // Sub-Tab Navigation
            h += '<div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1">';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'akademie\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md bg-white shadow text-vit-orange" data-sub="akademie">ðŸŽ“ Akademie</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'handbuecher\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="handbuecher">ðŸ“– Handbuecher</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'bestpractices\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="bestpractices">ðŸ’¡ Best Practices</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'faq\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="faq">â“ FAQ</button>';
            h += '</div>';

            // Akademie
            h += '<div id="'+containerId+'_akademie" class="wissen-section-'+containerId+'">';
            h += '<div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-gray-800">ðŸŽ“ Schulungen & Kurse</h3><span class="text-xs text-gray-400">'+d.akademie.filter(function(k){return k.progress===100;}).length+' / '+d.akademie.length+' abgeschlossen</span></div>';
            d.akademie.forEach(function(k) {
                var pColor = k.progress===100?'bg-green-500':k.progress>0?'bg-vit-orange':'bg-gray-300';
                var badge = k.typ==='pflicht'?'<span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">Pflicht</span>':'<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-bold">Wahl</span>';
                h += '<div class="vit-card p-4 mb-3 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="font-semibold text-sm">'+k.title+'</span>'+badge+'</div><span class="text-xs text-gray-400">'+k.dauer+'</span></div>';
                h += '<p class="text-xs text-gray-500 mb-2">'+k.desc+'</p>';
                h += '<div class="flex items-center space-x-3"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div><span class="text-xs font-bold '+(k.progress===100?'text-green-600':'text-gray-500')+'">'+k.progress+'%</span></div>';
                h += '</div>';
            });
            h += '</div>';

            // Handbuecher
            h += '<div id="'+containerId+'_handbuecher" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">ðŸ“– Technische Dokus & Marken-Guides</h3>';
            h += '<div class="space-y-2">';
            d.handbuecher.forEach(function(doc) {
                h += '<div class="vit-card p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer">';
                h += '<div class="flex items-center space-x-3"><div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-red-600 text-xs font-bold">PDF</div>';
                h += '<div><p class="text-sm font-semibold">'+doc.title+'</p><p class="text-xs text-gray-400">'+doc.marke+' Â· '+doc.seiten+' Seiten</p></div></div>';
                h += '<button class="px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded-lg hover:bg-gray-50">Oeffnen</button>';
                h += '</div>';
            });
            h += '</div></div>';

            // Best Practices
            h += '<div id="'+containerId+'_bestpractices" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">ðŸ’¡ Best Practices aus dem Netzwerk</h3>';
            d.bestpractices.forEach(function(bp) {
                h += '<div class="vit-card p-5 mb-3 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-2"><span class="font-semibold text-sm">'+bp.title+'</span><span class="text-xs text-gray-400">'+bp.datum+'</span></div>';
                h += '<div class="flex items-center space-x-2"><span class="text-xs text-gray-500">ðŸ“ '+bp.standort+'</span>';
                bp.tags.forEach(function(t){ h += '<span class="text-[10px] px-2 py-0.5 bg-blue-50 text-blue-600 rounded-full">'+t+'</span>'; });
                h += '</div></div>';
            });
            h += '</div>';

            // FAQ
            h += '<div id="'+containerId+'_faq" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">â“ Haeufige Fragen</h3>';
            h += '<div class="space-y-2">';
            d.faq.forEach(function(f,i) {
                h += '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="this.querySelector(\'.faq-answer\').style.display=this.querySelector(\'.faq-answer\').style.display===\'none\'?\'block\':\'none\'">';
                h += '<div class="flex items-center justify-between"><span class="text-sm font-semibold">'+f.frage+'</span><span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">'+f.kat+'</span></div>';
                h += '<div class="faq-answer text-xs text-gray-500 mt-2" style="display:none;">Antwort wird geladen... (Im echten Produkt: vollstaendige Antwort aus der Wissensdatenbank)</div>';
                h += '</div>';
            });
            h += '</div></div>';

            el.innerHTML = h;
        }

        function switchWissenSub(containerId, sub) {
            document.querySelectorAll('.wissen-section-'+containerId).forEach(function(s){ s.style.display='none'; });
            var target = document.getElementById(containerId+'_'+sub);
            if(target) target.style.display='block';
            document.querySelectorAll('.wissen-sub-'+containerId).forEach(function(b){
                b.className='wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white';
            });
            var btn = document.querySelector('.wissen-sub-'+containerId+'[data-sub="'+sub+'"]');
            if(btn) btn.className='wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md bg-white shadow text-vit-orange';
        }

        // === GLOBAL WISSEN VIEW ===
        var currentWissenBereich = 'all';
        var currentWissenTyp = 'akademie';

        function renderWissenGlobal() {
            var bereiche = ['allgemein','verkauf','einkauf','marketing','controlling'];
            var bereichLabels = {allgemein:'Allgemein',verkauf:'Verkauf',einkauf:'Einkauf',marketing:'Marketing',controlling:'Controlling'};
            var bereichIcons = {allgemein:'ðŸ¢',verkauf:'ðŸ’°',einkauf:'ðŸ›’',marketing:'ðŸ“£',controlling:'ðŸ“Š'};

            // Aggregate all items
            var allAkademie=[],allHandbuecher=[],allBp=[],allFaq=[];
            bereiche.forEach(function(b){
                var d=wissenData[b]; if(!d)return;
                (d.akademie||[]).forEach(function(i){i._bereich=b;allAkademie.push(i);});
                (d.handbuecher||[]).forEach(function(i){i._bereich=b;allHandbuecher.push(i);});
                (d.bestPractices||[]).forEach(function(i){i._bereich=b;allBp.push(i);});
                (d.faq||[]).forEach(function(i){i._bereich=b;allFaq.push(i);});
            });

            // KPIs
            var totalKurse=allAkademie.length;
            var doneKurse=allAkademie.filter(function(k){return k.progress===100;}).length;
            var pflichtOffen=allAkademie.filter(function(k){return k.typ==='pflicht'&&k.progress<100;}).length;
            var kpi=document.getElementById('wissenKpis');
            if(kpi) kpi.innerHTML=
                '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+totalKurse+'</p><p class="text-xs text-gray-500">Schulungen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+doneKurse+'</p><p class="text-xs text-gray-500">Abgeschlossen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold '+(pflichtOffen>0?'text-red-500':'text-green-600')+'">'+pflichtOffen+'</p><p class="text-xs text-gray-500">Pflicht offen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+allHandbuecher.length+'</p><p class="text-xs text-gray-500">Handbuecher</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+allFaq.length+'</p><p class="text-xs text-gray-500">FAQs</p></div>';

            // Determine which list to show
            var items=[];
            if(currentWissenTyp==='akademie') items=allAkademie;
            else if(currentWissenTyp==='handbuecher') items=allHandbuecher;
            else if(currentWissenTyp==='bestpractices') items=allBp;
            else if(currentWissenTyp==='faq') items=allFaq;

            // Filter by bereich
            if(currentWissenBereich!=='all') items=items.filter(function(i){return i._bereich===currentWissenBereich;});

            // Search
            var search=(document.getElementById('wissenSearch')||{}).value||'';
            if(search) {
                var s=search.toLowerCase();
                items=items.filter(function(i){return (i.title||i.frage||'').toLowerCase().indexOf(s)>-1 || (i.desc||i.antwort||'').toLowerCase().indexOf(s)>-1;});
            }

            var el=document.getElementById('wissenGlobalContent');
            if(!el) return;
            var h='';

            if(currentWissenTyp==='akademie'){
                items.forEach(function(k){
                    var pColor=k.progress===100?'bg-green-500':k.progress>0?'bg-vit-orange':'bg-gray-300';
                    var badge=k.typ==='pflicht'?'<span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">Pflicht</span>':'<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-bold">Wahl</span>';
                    h+='<div class="vit-card p-4 hover:shadow-md transition"><div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[k._bereich]+' '+bereichLabels[k._bereich]+'</span><span class="font-semibold text-sm">'+k.title+'</span>'+badge+'</div><span class="text-xs text-gray-400">'+k.dauer+'</span></div><p class="text-xs text-gray-500 mb-2">'+k.desc+'</p><div class="flex items-center space-x-3"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div><span class="text-xs font-bold '+(k.progress===100?'text-green-600':'text-gray-500')+'">'+k.progress+'%</span></div></div>';
                });
            } else if(currentWissenTyp==='handbuecher'){
                items.forEach(function(b){
                    h+='<div class="vit-card p-4 hover:shadow-md transition flex items-center space-x-4"><div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-xs">PDF</div><div class="flex-1"><div class="flex items-center space-x-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[b._bereich]+' '+bereichLabels[b._bereich]+'</span><span class="font-semibold text-sm">'+b.title+'</span></div><p class="text-xs text-gray-400 mt-1">'+(b.pages||'â€”')+' Â· '+(b.updated||'')+'</p></div><button class="text-vit-orange hover:text-orange-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></button></div>';
                });
            } else if(currentWissenTyp==='bestpractices'){
                items.forEach(function(bp){
                    h+='<div class="vit-card p-4 hover:shadow-md transition"><div class="flex items-center space-x-2 mb-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[bp._bereich]+' '+bereichLabels[bp._bereich]+'</span><span class="font-semibold text-sm">'+bp.title+'</span></div><p class="text-xs text-gray-500">'+(bp.desc||bp.content||'')+'</p></div>';
                });
            } else if(currentWissenTyp==='faq'){
                items.forEach(function(fq,i){
                    h+='<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="var fa=this.querySelector(\'.faq-a\');fa.style.display=fa.style.display===\'none\'?\'block\':\'none\'"><div class="flex items-center space-x-2 mb-1"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[fq._bereich]+'</span><span class="font-semibold text-sm">'+fq.frage+'</span></div><div class="faq-a text-xs text-gray-500 mt-2" style="display:none;">'+fq.antwort+'</div></div>';
                });
            }

            if(!h) h='<div class="text-center text-gray-400 py-8"><p class="text-lg mb-2">ðŸ”</p><p class="text-sm">Keine Eintraege gefunden.</p></div>';
            el.innerHTML=h;
        }

        function filterWissenBereich(b){
            currentWissenBereich=b;
            document.querySelectorAll('.wissen-bereich-filter').forEach(function(btn){btn.className='wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.wissen-bereich-filter[data-wbf="'+b+'"]');
            if(btn) btn.className='wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderWissenGlobal();
        }
        function switchWissenTyp(t){
            currentWissenTyp=t;
            document.querySelectorAll('.wissen-typ-btn').forEach(function(btn){btn.className='wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';});
            var btn=document.querySelector('.wissen-typ-btn[data-wtt="'+t+'"]');
            if(btn) btn.className='wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            renderWissenGlobal();
        }
        function filterWissenGlobal(){ renderWissenGlobal(); }

        // Hook wissen rendering into tab switches
        var origShowAllgemeinTab = showAllgemeinTab;
        showAllgemeinTab = function(t) { origShowAllgemeinTab(t); if(t==='wissen') renderWissenTab('allgemein','allgTabWissen'); };

        var origShowMarketingTab = showMarketingTab;
        showMarketingTab = function(t) { origShowMarketingTab(t); if(t==='mktWissen') renderWissenTab('marketing','marketingTabMktWissen'); };

        var origShowEinkaufTab = showEinkaufTab;
        showEinkaufTab = function(t) { origShowEinkaufTab(t); if(t==='ekWissen') renderWissenTab('einkauf','ekTabEkWissen'); };


        var origShowVerkaufTab = showVerkaufTab;
        var ausLoaded = false;
        var vtLoaded = false;
        showVerkaufTab = function(t) { origShowVerkaufTab(t); if(t==='vkWissen') renderWissenTab('verkauf','vkTabVkWissen'); if(t==='auswertung' && !ausLoaded) { ausLoaded=true; loadAuswertung(); } if(t==='woche' && !vtLoaded) { vtLoaded=true; loadVerkaufTracking(); } };

        // === SUPPORT MODULE ===
        async function renderTickets(filter) {
            var container = document.getElementById('ticketList');
            if(!container) return;
            try {
                var query = sb.from('support_tickets').select('*, users(name)').order('created_at', {ascending:false});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                if(filter==='offen') query = query.in('status', ['offen','in_bearbeitung']);
                if(filter==='geloest') query = query.eq('status', 'geloest');
                var resp = await query;
                if(resp.error) throw resp.error;
                var tickets = resp.data || [];
                var html = '';
                var statusColors = {offen:'bg-yellow-100 text-yellow-700',in_bearbeitung:'bg-blue-100 text-blue-700',warten:'bg-gray-100 text-gray-700',geloest:'bg-green-100 text-green-700'};
                var statusLabels = {offen:'Offen',in_bearbeitung:'In Bearbeitung',warten:'Wartend',geloest:'Gel\u00f6st'};
                var prioIcons = {dringend:'\uD83D\uDD34',hoch:'\uD83D\uDFE0',mittel:'\uD83D\uDFE1',niedrig:'\u26AA'};
                tickets.forEach(function(t) {
                    var d = new Date(t.created_at);
                    var desc = (t.beschreibung||'').length > 120 ? t.beschreibung.substring(0,120)+'...' : (t.beschreibung||'');
                    html += '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="openTicketDetail(\''+t.id+'\')">';
                    html += '<div class="flex items-start justify-between">';
                    html += '<div class="flex-1"><div class="flex items-center space-x-2 mb-1">';
                    html += '<span class="text-xs font-semibold rounded px-2 py-0.5 ' + (statusColors[t.status]||'') + '">' + (statusLabels[t.status]||t.status) + '</span>';
                    html += '<span>' + (prioIcons[t.prioritaet]||'') + '</span>';
                    html += '<span class="text-xs text-gray-400">#' + t.id.substring(0,8) + '</span></div>';
                    html += '<h4 class="font-bold text-gray-800 text-sm">' + t.titel + '</h4>';
                    html += '<p class="text-xs text-gray-500 mt-1">' + desc + '</p>';
                    html += '<div class="flex items-center space-x-3 mt-2 text-xs text-gray-400">';
                    html += '<span>' + d.toLocaleDateString('de-DE') + '</span>';
                    html += '<span>' + (t.kategorie||'') + '</span>';
                    if(t.users && t.users.name) html += '<span>\uD83D\uDC64 '+t.users.name+'</span>';
                    html += '</div></div>';
                    html += '<span class="text-gray-300 text-lg ml-2">\u203A</span>';
                    html += '</div></div>';
                });
                if(tickets.length===0) html = '<div class="text-center py-8 text-gray-400">Keine Tickets in dieser Kategorie.</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Support:', err); container.innerHTML='<div class="text-center py-8 text-red-400">Fehler beim Laden der Tickets.</div>'; }
        }

        async function openTicketDetail(ticketId) {
            try {
                var tResp = await sb.from('support_tickets').select('*, users(name)').eq('id', ticketId).single();
                if(tResp.error) throw tResp.error;
                var t = tResp.data;
                var cResp = await sb.from('ticket_kommentare').select('*, users(name)').eq('ticket_id', ticketId).order('created_at', {ascending:true});
                var kommentare = (cResp.data || []);

                var statusLabels = {offen:'Offen',in_bearbeitung:'In Bearbeitung',warten:'Wartend',geloest:'Gel\u00f6st'};
                var statusColors = {offen:'bg-yellow-100 text-yellow-700',in_bearbeitung:'bg-blue-100 text-blue-700',warten:'bg-gray-100 text-gray-700',geloest:'bg-green-100 text-green-700'};
                var prioIcons = {dringend:'\uD83D\uDD34',hoch:'\uD83D\uDFE0',mittel:'\uD83D\uDFE1',niedrig:'\u26AA'};
                var d = new Date(t.created_at);
                var isHQ = sbProfile && sbProfile.is_hq;

                var html = '<div id="ticketDetailOverlay" onclick="closeTicketDetail()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
                html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:0;width:640px;max-width:95vw;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;">';

                // Header
                html += '<div class="p-5 border-b border-gray-100">';
                html += '<div class="flex items-center justify-between mb-3">';
                html += '<div class="flex items-center space-x-2"><span class="text-xs font-semibold rounded px-2 py-0.5 '+(statusColors[t.status]||'')+'">'+(statusLabels[t.status]||t.status)+'</span>';
                html += '<span>'+(prioIcons[t.prioritaet]||'')+'</span>';
                html += '<span class="text-xs text-gray-400">#'+t.id.substring(0,8)+'</span></div>';
                html += '<button onclick="closeTicketDetail()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
                html += '<h3 class="font-bold text-gray-800 text-lg">'+t.titel+'</h3>';
                html += '<div class="flex items-center space-x-4 mt-2 text-xs text-gray-400">';
                html += '<span>Erstellt: '+d.toLocaleDateString('de-DE')+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})+'</span>';
                html += '<span>Kategorie: '+(t.kategorie||'')+'</span>';
                if(t.users&&t.users.name) html += '<span>Von: '+t.users.name+'</span>';
                html += '</div></div>';

                // Body
                html += '<div class="flex-1 overflow-y-auto p-5">';
                html += '<div class="bg-gray-50 rounded-lg p-4 mb-4"><p class="text-sm text-gray-700 whitespace-pre-wrap">'+(t.beschreibung||'Keine Beschreibung.')+'</p></div>';

                // Status change (HQ can change, user can close)
                html += '<div class="mb-4 p-3 bg-blue-50 rounded-lg flex items-center justify-between">';
                html += '<span class="text-xs font-semibold text-blue-700">'+t('ticket_change_status')+':</span>';
                html += '<div class="flex space-x-1">';
                if(isHQ) {
                    ['offen','in_bearbeitung','warten','geloest'].forEach(function(st) {
                        var active = t.status===st;
                        html += '<button onclick="changeTicketStatus(\''+ticketId+'\',\''+st+'\')" class="text-xs px-2.5 py-1 rounded-full font-semibold '+(active?'bg-vit-orange text-white':'bg-white text-gray-600 border border-gray-200 hover:bg-gray-100')+'">'+(statusLabels[st])+'</button>';
                    });
                } else {
                    if(t.status!=='geloest') html += '<button onclick="changeTicketStatus(\''+ticketId+'\',\'geloest\')" class="text-xs px-3 py-1 rounded-full font-semibold bg-green-500 text-white hover:bg-green-600">'+t('ticket_mark_resolved')+'</button>';
                    else html += '<span class="text-xs text-green-600 font-semibold">\u2705 Gel\u00f6st</span>';
                }
                html += '</div></div>';

                // Kommentare
                html += '<h4 class="font-semibold text-gray-700 text-sm mb-3">'+t('ticket_comments')+' ('+kommentare.length+')</h4>';
                if(kommentare.length === 0) html += '<p class="text-sm text-gray-400 mb-4">Noch keine Kommentare.</p>';
                kommentare.forEach(function(k) {
                    var kd = new Date(k.created_at);
                    var isOwn = sbUser && k.erstellt_von === sbUser.id;
                    html += '<div class="mb-3 p-3 rounded-lg '+(isOwn?'bg-orange-50 border border-orange-100':'bg-gray-50 border border-gray-100')+'">';
                    html += '<div class="flex items-center justify-between mb-1"><span class="text-xs font-bold text-gray-700">'+(k.users&&k.users.name?k.users.name:'Unbekannt')+'</span>';
                    html += '<span class="text-[10px] text-gray-400">'+kd.toLocaleDateString('de-DE')+' '+kd.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})+'</span></div>';
                    html += '<p class="text-sm text-gray-600 whitespace-pre-wrap">'+k.text+'</p></div>';
                });

                // Neuer Kommentar
                html += '<div class="mt-3 flex space-x-2">';
                html += '<textarea id="ticketKommentarInput" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm resize-none" rows="2" placeholder="'+t('ticket_comment_ph')+'"></textarea>';
                html += '<button onclick="addTicketComment(\''+ticketId+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 self-end">'+t('ticket_comment_send')+'</button>';
                html += '</div>';

                html += '</div></div></div>';
                var c = document.createElement('div'); c.id = 'ticketDetailContainer'; c.innerHTML = html; document.body.appendChild(c);
            } catch(err) { console.error('Ticket detail:', err); alert('Fehler beim Laden des Tickets.'); }
        }

        function closeTicketDetail() { var c = document.getElementById('ticketDetailContainer'); if(c) c.remove(); }

        async function changeTicketStatus(ticketId, newStatus) {
            try {
                var resp = await sb.from('support_tickets').update({status:newStatus, updated_at:new Date().toISOString()}).eq('id',ticketId);
                if(resp.error) throw resp.error;
                closeTicketDetail();
                await openTicketDetail(ticketId);
                renderTickets('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function addTicketComment(ticketId) {
            var input = document.getElementById('ticketKommentarInput');
            if(!input || !input.value.trim()) return;
            try {
                var resp = await sb.from('ticket_kommentare').insert({
                    ticket_id:ticketId, erstellt_von:sbUser?sbUser.id:null, text:input.value.trim()
                });
                if(resp.error) throw resp.error;
                closeTicketDetail();
                await openTicketDetail(ticketId);
            } catch(err) { alert('Fehler: '+err.message); }
        }

        function filterTickets(filter) {
            document.querySelectorAll('.ticket-filter').forEach(function(b){b.className='ticket-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.ticket-filter[data-f="'+filter+'"]');
            if(btn) btn.className='ticket-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderTickets(filter);
        }

        async function sendTicket() {
            var title = document.getElementById('ticketTitle');
            var desc = document.getElementById('ticketDesc');
            var cat = document.getElementById('ticketCat');
            if(!title || !title.value.trim()) return;
            try {
                await sb.from('support_tickets').insert({standort_id: sbStandort?sbStandort.id:null, erstellt_von:sbUser.id, titel:title.value.trim(), beschreibung:(desc?desc.value:''), kategorie:(cat?cat.value:'allgemein'), prioritaet:'mittel'});
                if(title) title.value=''; if(desc) desc.value='';
                var form=document.getElementById('newTicketForm'); if(form) form.classList.add('hidden');
                renderTickets('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function submitTicketForm() {
            var titel = (document.getElementById('ticketTitelInput')||{}).value;
            var beschreibung = (document.getElementById('ticketBeschreibungInput')||{}).value;
            var kategorie = (document.getElementById('ticketCatInput')||{}).value || 'allgemein';
            var prioritaet = (document.getElementById('ticketPrioInput')||{}).value || 'mittel';
            if(!titel || !titel.trim()) { alert('Bitte Betreff eingeben.'); return; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var resp = await sb.from('support_tickets').insert({
                    standort_id: stdId, erstellt_von: sbUser ? sbUser.id : null,
                    titel: titel.trim(), beschreibung: beschreibung || '',
                    kategorie: kategorie, prioritaet: prioritaet, status: 'offen'
                });
                if(resp.error) throw resp.error;
                document.getElementById('ticketCreate').classList.add('hidden');
                document.getElementById('ticketTitelInput').value = '';
                document.getElementById('ticketBeschreibungInput').value = '';
                alert('\u2705 Ticket erstellt!');
                renderTickets('all');
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        var zentraleKontakte = [
            {name:'Sascha Matthies',rolle:'Geschaeftsfuehrung',bereich:'GF',tel:'+49 170 1234567',email:'sascha@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 9-18 Uhr',schwerpunkt:'Strategie, Partnerschaften, Finanzen'},
            {name:'Florian Meier',rolle:'Einkauf & Sortiment',bereich:'Einkauf',tel:'+49 170 2345678',email:'florian@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 8-17 Uhr',schwerpunkt:'Vororder, Konditionen, Lieferanten, Sortiment'},
            {name:'Michael Stenzel',rolle:'Marketing & Performance',bereich:'Marketing',tel:'+49 170 3456789',email:'michael@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 9-18 Uhr',schwerpunkt:'Ads, Content, Events, Jahresgespraeche'},
            {name:'Tim Schaefer',rolle:'IT & Systeme',bereich:'IT',tel:'+49 170 4567890',email:'tim@vitbikes.de',verfuegbar:false,zeiten:'Mo-Fr 8-16 Uhr',schwerpunkt:'Kassensystem, B2B-Portale, Etermin, Netzwerk'},
            {name:'Laura Hofmann',rolle:'Buchhaltung & Controlling',bereich:'Buchhaltung',tel:'+49 170 5678901',email:'laura@vitbikes.de',verfuegbar:true,zeiten:'Mo-Do 8-16, Fr 8-14 Uhr',schwerpunkt:'BWA, Monatsabschluss, Rechnungen, DATEV'},
            {name:'Jonas Becker',rolle:'Werkstatt-Support & Schulung',bereich:'Werkstatt',tel:'+49 170 6789012',email:'jonas@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 7-16 Uhr',schwerpunkt:'Shimano, Bosch, Diagnose, Technik-Schulungen'}
        ];

        function showSupportTab(tabName) {
            document.querySelectorAll('.sup-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.sup-tab-btn').forEach(function(b){
                b.className='sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {tickets:'Tickets',kontakte:'Kontakte'};
            var el = document.getElementById('supTab'+(tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.sup-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='tickets') renderTickets('all');
            if(tabName==='kontakte') renderKontakte();
        }

        function renderKontakte() {
            var grid = document.getElementById('kontakteGrid');
            if(!grid || grid.dataset.rendered) return;
            grid.dataset.rendered = 'true';
            var bereichColors = {'GF':'bg-purple-500','Einkauf':'bg-blue-500','Marketing':'bg-orange-500','IT':'bg-gray-600','Buchhaltung':'bg-green-600','Werkstatt':'bg-red-500'};
            var h = '';
            zentraleKontakte.forEach(function(k) {
                var col = bereichColors[k.bereich]||'bg-gray-500';
                var initials = k.name.split(' ').map(function(w){return w[0];}).join('');
                h += '<div class="vit-card p-5 hover:shadow-md transition">';
                h += '<div class="flex items-center space-x-3 mb-4">';
                h += '<div class="w-14 h-14 '+col+' rounded-full flex items-center justify-center text-white font-bold text-lg">'+initials+'</div>';
                h += '<div>';
                h += '<p class="font-semibold text-gray-800">'+k.name+'</p>';
                h += '<p class="text-xs text-gray-500">'+k.rolle+'</p>';
                h += '<span class="inline-flex items-center mt-1 '+(k.verfuegbar?'text-green-600':'text-gray-400')+' text-xs">';
                h += '<span class="w-2 h-2 rounded-full '+(k.verfuegbar?'bg-green-500':'bg-gray-300')+' mr-1"></span>';
                h += (k.verfuegbar?'Verfuegbar':'Nicht verfuegbar');
                h += '</span>';
                h += '</div></div>';
                h += '<div class="space-y-2 mb-4">';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">ðŸ“ž</span><a href="tel:'+k.tel+'" class="text-gray-700 hover:text-vit-orange">'+k.tel+'</a></div>';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">âœ‰ï¸</span><a href="mailto:'+k.email+'" class="text-gray-700 hover:text-vit-orange">'+k.email+'</a></div>';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">ðŸ•</span><span class="text-gray-600">'+k.zeiten+'</span></div>';
                h += '</div>';
                h += '<div class="pt-3 border-t border-gray-100">';
                h += '<p class="text-xs text-gray-400 mb-1">Schwerpunkte</p>';
                h += '<p class="text-xs text-gray-600">'+k.schwerpunkt+'</p>';
                h += '</div>';
                h += '<div class="flex space-x-2 mt-3">';
                h += '<button class="flex-1 px-3 py-2 text-xs font-semibold border border-gray-300 rounded-lg hover:bg-gray-50">âœ‰ï¸ E-Mail</button>';
                h += '<button class="flex-1 px-3 py-2 text-xs font-semibold bg-vit-orange text-white rounded-lg hover:opacity-90">ðŸ“ž Anrufen</button>';
                h += '</div>';
                h += '</div>';
            });
            grid.innerHTML = h;
        }

        // Init support on view
        var origShowView = showView;
        showView = function(v) {
            origShowView(v);
            if(v==='support') { renderTickets('all'); renderKontakte(); }
            if(v==='ideenboard') { renderIdeen('all'); }
            if(v==='wissen') { renderWissenGlobal(); }
            if(v==='shop') { renderShop(); }
        };

        // === IDEENBOARD ===
        async function renderIdeen(filter) {
            var container = document.getElementById('ideenList');
            if(!container) return;
            try {
                var query = sb.from('ideen').select('*, users(name)').order('votes', {ascending:false});
                if(filter && filter!=='all') query = query.eq('status', filter);
                var resp = await query;
                if(resp.error) throw resp.error;
                var ideas = resp.data || [];
                // KPIs (immer alle zÃ¤hlen)
                var allResp = await sb.from('ideen').select('status');
                var allIdeas = allResp.data || [];
                var ge=document.getElementById('ideenTotal');if(ge)ge.textContent=allIdeas.length;
                var ne=document.getElementById('ideenNeu');if(ne)ne.textContent=allIdeas.filter(function(i){return i.status==='neu';}).length;
                var gp=document.getElementById('ideenGeplant');if(gp)gp.textContent=allIdeas.filter(function(i){return i.status==='wird_geprueft'||i.status==='geplant'||i.status==='diskussion';}).length;
                var um=document.getElementById('ideenUmgesetzt');if(um)um.textContent=allIdeas.filter(function(i){return i.status==='umgesetzt';}).length;

                var html = '';
                var statusColors = {neu:'bg-blue-100 text-blue-700',diskussion:'bg-yellow-100 text-yellow-700',wird_geprueft:'bg-yellow-100 text-yellow-700',geplant:'bg-purple-100 text-purple-700',umgesetzt:'bg-green-100 text-green-700',abgelehnt:'bg-red-100 text-red-700'};
                var statusLabels = {neu:'Neu',diskussion:'In Diskussion',wird_geprueft:'Wird geprÃ¼ft',geplant:'Geplant',umgesetzt:'Umgesetzt',abgelehnt:'Abgelehnt'};
                ideas.forEach(function(i) {
                    var authorName = i.users ? i.users.name : 'Unbekannt';
                    var d = i.created_at ? new Date(i.created_at) : new Date();
                    var datum = d.toLocaleDateString('de-DE');
                    html += '<div class="vit-card p-5 hover:shadow-md transition">';
                    html += '<div class="flex items-start space-x-4">';
                    html += '<div class="text-center flex-shrink-0"><button onclick="voteIdee(\''+i.id+'\')" class="w-12 h-12 rounded-xl bg-gray-100 hover:bg-vit-orange hover:text-white flex items-center justify-center text-lg font-bold text-gray-600 transition">\u25b2</button><span class="text-sm font-bold text-gray-800 block mt-1">' + (i.votes||0) + '</span></div>';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center space-x-2 mb-1"><span class="text-xs font-semibold rounded px-2 py-0.5 ' + (statusColors[i.status]||'bg-gray-100 text-gray-600') + '">' + (statusLabels[i.status]||i.status) + '</span></div>';
                    html += '<h3 class="font-bold text-gray-800 mb-1">' + i.titel + '</h3>';
                    if(i.beschreibung) html += '<p class="text-sm text-gray-600 mb-2">' + i.beschreibung + '</p>';
                    html += '<span class="text-xs text-gray-400">' + authorName + ' \u00b7 ' + datum + '</span>';
                    html += '</div></div></div>';
                });
                if(ideas.length===0) html = '<div class="text-center py-8 text-gray-400">Noch keine Ideen â€“ sei der Erste! \ud83d\udca1</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Ideen:', err); container.innerHTML='<div class="text-center py-4 text-red-400">Fehler: '+err.message+'</div>'; }
        }

        function filterIdeen(filter) {
            document.querySelectorAll('.ideen-filter').forEach(function(b){b.className='ideen-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.ideen-filter[data-f="'+filter+'"]');
            if(btn) btn.className='ideen-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderIdeen(filter);
        }

        async function voteIdee(id) {
            try {
                // Check if it's own idea
                var ideeResp = await sb.from('ideen').select('user_id,votes').eq('id',id).single();
                if(ideeResp.data && ideeResp.data.user_id === sbUser.id) {
                    alert('Du kannst deine eigene Idee nicht bewerten.');
                    return;
                }
                // Check if already voted
                var checkResp = await sb.from('ideen_votes').select('id').eq('idee_id',id).eq('user_id',sbUser.id);
                if(checkResp.data && checkResp.data.length > 0) {
                    alert('Du hast bereits fÃ¼r diese Idee gestimmt!');
                    return;
                }
                // Insert vote
                var voteResp = await sb.from('ideen_votes').insert({idee_id:id, user_id:sbUser.id});
                if(voteResp.error) throw voteResp.error;
                // Increment votes count
                var newVotes = (ideeResp.data.votes||0) + 1;
                await sb.from('ideen').update({votes: newVotes}).eq('id',id);
                renderIdeen('all');
            } catch(err) { 
                if(err.code==='23505') alert('Du hast bereits fÃ¼r diese Idee gestimmt!');
                else { console.error('Vote:', err); alert('Fehler: '+(err.message||err)); }
            }
        }

        async function submitIdee() {
            var titelEl = document.getElementById('ideeTitel');
            var beschEl = document.getElementById('ideeBeschreibung');
            var katEl = document.getElementById('ideeKat');
            var typEl = document.getElementById('ideeTyp');
            if(!titelEl || !titelEl.value.trim()) { alert('Bitte einen Titel eingeben.'); return; }
            try {
                var insertData = {
                    user_id: sbUser.id,
                    standort_id: sbStandort ? sbStandort.id : null,
                    titel: titelEl.value.trim(),
                    beschreibung: beschEl ? beschEl.value.trim() : '',
                    kategorie: katEl ? katEl.value : null,
                    status: 'neu',
                    votes: 0
                };
                var resp = await sb.from('ideen').insert(insertData);
                if(resp.error) throw resp.error;
                if(titelEl) titelEl.value='';
                if(beschEl) beschEl.value='';
                if(katEl) katEl.selectedIndex=0;
                if(typEl) typEl.selectedIndex=0;
                document.getElementById('ideeCreate').classList.add('hidden');
                renderIdeen('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // === HQ STANDORT-DATEN (Netzwerk-weite Kennzahlen) ===
        var hqStandorte = [];

        async function loadHqStandorte() {
            // In demo mode, hqStandorte is already filled by seedDemoData
            if(isDemoMode && hqStandorte.length > 0) return;
            try {
                // Load standorte with their BWA and ticket data
                var sResp = await sb.from('standorte').select('*').order('name');
                if(sResp.error) throw sResp.error;
                var standorte = sResp.data || [];

                // Load BWA data for current year
                var currentYear = new Date().getFullYear();
                var bwaResp = await sb.from('bwa_daten').select('standort_id, monat, umsatzerloese, rohertrag, wareneinsatz, gesamtkosten, ergebnis_vor_steuern').eq('jahr', currentYear);
                var bwaData = bwaResp.data || [];

                // Load open tickets
                var ticketResp = await sb.from('support_tickets').select('standort_id').neq('status','geloest');
                var tickets = ticketResp.data || [];

                // Load leads
                var leadResp = await sb.from('leads').select('standort_id, status, wert');
                var leads = leadResp.data || [];

                // Load verkauf tracking
                var vtResp = await sb.from('verkauf_tracking').select('standort_id, beratungen, verkauft, umsatz');
                var vtData = vtResp.data || [];

                // Build hqStandorte array matching old structure
                hqStandorte = standorte.map(function(s) {
                    var sBwa = bwaData.filter(function(b) { return b.standort_id === s.id; });
                    var totalUmsatz = sBwa.reduce(function(a, b) { return a + (parseFloat(b.umsatzerloese) || 0); }, 0);
                    var avgRohertrag = sBwa.length ? (sBwa.reduce(function(a, b) { return a + (parseFloat(b.rohertrag) || 0); }, 0) / sBwa.length) : 0;
                    var sTickets = tickets.filter(function(t) { return t.standort_id === s.id; }).length;
                    var sLeads = leads.filter(function(l) { return l.standort_id === s.id; });
                    var sVt = vtData.filter(function(v) { return v.standort_id === s.id; });
                    var totalBeratungen = sVt.reduce(function(a, v) { return a + (v.beratungen || 0); }, 0);
                    var totalVerkauft = sVt.reduce(function(a, v) { return a + (v.verkauft || 0); }, 0);
                    var leadPerf = s.umsatz_plan_ytd ? Math.round(totalUmsatz / s.umsatz_plan_ytd * 100) : 0;

                    var auffaellig = null;
                    if(avgRohertrag > 0 && avgRohertrag < 34) auffaellig = 'Rohertrag unter 34%';
                    if(leadPerf < 50 && leadPerf > 0) auffaellig = (auffaellig ? auffaellig + ', ' : '') + 'Umsatz ' + leadPerf + '% unter Plan';

                    return {
                        id: s.id,
                        name: s.name || 'Unbekannt',
                        inhaber: s.inhaber_name || '(unbekannt)',
                        umsatzPlan: s.umsatz_plan_ytd || 0,
                        umsatzIst: totalUmsatz,
                        rohertrag: parseFloat(avgRohertrag.toFixed(1)),
                        leadPerf: leadPerf,
                        leads: sLeads.length,
                        cpt: sLeads.length > 0 ? Math.round(totalUmsatz / sLeads.length) : 0,
                        budget: s.marketing_budget || 0,
                        vororderStatus: s.vororder_status || 'open',
                        vororderBikes: s.vororder_bikes || 0,
                        rabattQuote: s.rabatt_quote || 0,
                        verkauftKW: totalVerkauft,
                        beratungenKW: totalBeratungen,
                        offeneTickets: sTickets,
                        strategieStatus: s.strategie_status || 'pending',
                        bwaAuffaellig: auffaellig,
                        region: s.region || ''
                    };
                });
            } catch(err) {
                console.warn('HQ Standorte load error:', err);
                // Fallback: empty
                hqStandorte = [];
            }
        }

        function perfColor(p) { return p>=100?'text-green-600':p>=75?'text-green-500':p>=50?'text-yellow-600':'text-red-600'; }
        function perfBg(p) { return p>=100?'bg-green-100 text-green-700':p>=75?'bg-green-50 text-green-600':p>=50?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'; }
        function perfDot(p) { return p>=100?'#FBBF24':p>=75?'#22C55E':p>=50?'#F97316':'#EF4444'; }
        function fmt(n) { return n>=1000 ? Math.round(n/1000)+'k' : n.toLocaleString('de-DE'); }
        function stratBadge(s) { var m={done:'âœ… Vereinbart',pending:'â³ Ausstehend',missing:'âŒ Fehlt',partial:'ðŸ”¶ Teilweise'}; var c={done:'bg-green-100 text-green-700',pending:'bg-yellow-100 text-yellow-700',missing:'bg-red-100 text-red-700',partial:'bg-orange-100 text-orange-700'}; return '<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(c[s]||c.missing)+'">'+(m[s]||'?')+'</span>'; }

        // === HQ COCKPIT ===
        async function renderHqCockpit() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var active = hqStandorte.filter(function(s){return s.umsatzIst>0;});
            var totalUmsatz = hqStandorte.reduce(function(a,s){return a+s.umsatzIst;},0);
            var totalPlan = hqStandorte.reduce(function(a,s){return a+s.umsatzPlan;},0);
            var avgRohertrag = active.length ? (active.reduce(function(a,s){return a+s.rohertrag;},0)/active.length).toFixed(1) : 0;
            var totalLeads = hqStandorte.reduce(function(a,s){return a+s.leads;},0);
            var kritisch = hqStandorte.filter(function(s){return s.leadPerf<50;}).length;
            var tickets = hqStandorte.reduce(function(a,s){return a+s.offeneTickets;},0);

            // KPIs
            var el = document.getElementById('hqKpiCards');
            if(el) el.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Netzwerk-Umsatz YTD</p><p class="text-2xl font-bold text-gray-800">'+fmt(totalUmsatz)+' â‚¬</p><p class="text-xs '+(totalUmsatz>=totalPlan?'text-green-600':'text-red-500')+'">Plan: '+fmt(totalPlan)+' â‚¬</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rohertrag</p><p class="text-2xl font-bold text-gray-800">'+avgRohertrag+'%</p><p class="text-xs text-gray-500">Ziel: â‰¥ 38%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Leads gesamt</p><p class="text-2xl font-bold text-gray-800">'+totalLeads+'</p><p class="text-xs text-gray-500">'+active.length+' aktive Standorte</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Standorte kritisch</p><p class="text-2xl font-bold '+(kritisch>3?'text-red-600':'text-yellow-600')+'">'+kritisch+' / '+hqStandorte.length+'</p><p class="text-xs text-gray-500">Lead-Performance &lt; 50%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Offene Tickets</p><p class="text-2xl font-bold '+(tickets>10?'text-red-600':'text-gray-800')+'">'+tickets+'</p><p class="text-xs text-gray-500">Netzwerk-weit</p></div>';

            // Alert box
            var alerts = hqStandorte.filter(function(s){return s.bwaAuffaellig;});
            var ab = document.getElementById('hqAlertBox');
            if(ab) {
                var ah = '<div class="flex items-center space-x-2 mb-2"><span class="text-lg">ðŸš¨</span><span class="font-bold text-red-700">'+alerts.length+' Standorte mit Handlungsbedarf</span></div>';
                ah += '<div class="flex flex-wrap gap-2">';
                alerts.forEach(function(s){ ah += '<span class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded-lg"><strong>'+s.name+':</strong> '+s.bwaAuffaellig+'</span>'; });
                ah += '</div>';
                ab.innerHTML = ah;
            }

            // Top 5
            var sorted = hqStandorte.slice().sort(function(a,b){return b.leadPerf-a.leadPerf;});
            var t5 = document.getElementById('hqTop5');
            if(t5) {
                var th = '';
                sorted.slice(0,5).forEach(function(s,i){
                    th += '<div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg"><span class="text-lg font-bold text-gray-300 w-6">'+(i+1)+'</span><div class="flex-1"><p class="text-sm font-semibold">'+s.name+'</p><p class="text-xs text-gray-400">'+s.inhaber+'</p></div><div class="text-right"><p class="font-bold '+perfColor(s.leadPerf)+'">'+s.leadPerf+'%</p><p class="text-xs text-gray-400">'+fmt(s.umsatzIst)+' â‚¬ Umsatz</p></div></div>';
                });
                t5.innerHTML = th;
            }

            // Bottom 5
            var b5 = document.getElementById('hqBottom5');
            if(b5) {
                var bh = '';
                sorted.slice(-5).reverse().forEach(function(s){
                    bh += '<div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg"><span class="text-lg">âš ï¸</span><div class="flex-1"><p class="text-sm font-semibold text-red-700">'+s.name+'</p><p class="text-xs text-red-500">'+(s.bwaAuffaellig||'Lead-Performance kritisch')+'</p></div><div class="text-right"><p class="font-bold text-red-600">'+s.leadPerf+'%</p><button class="text-[10px] px-2 py-1 bg-red-600 text-white rounded mt-1" onclick="alert(\'Standort '+s.name+' wird geoeffnet\')">Details â†’</button></div></div>';
                });
                b5.innerHTML = bh;
            }

            // Grid
            var grid = document.getElementById('hqStandortGrid');
            if(grid) {
                var gh = '';
                sorted.forEach(function(s){
                    gh += '<div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onclick="alert(\'Standort '+s.name+' oeffnen\')">'
                        +'<div class="flex items-center justify-center space-x-1 mb-1"><span style="width:10px;height:10px;border-radius:50%;background:'+perfDot(s.leadPerf)+';display:inline-block;"></span><span class="text-xs font-semibold text-gray-700 truncate">'+s.name+'</span></div>'
                        +'<span class="text-sm font-bold text-gray-800">'+s.leadPerf+'%</span>'
                        +'</div>';
                });
                grid.innerHTML = gh;
            }

            // === HOME WIDGETS (rechte Spalte) ===
            // Aktive Kampagnen kompakt
            var hkEl = document.getElementById('hqHomeKampagnen');
            if(hkEl && typeof hqKampagnen !== 'undefined') {
                var hkh = '';
                hqKampagnen.filter(function(k){return k.status==='aktiv';}).forEach(function(k){
                    var pct = k.standorte ? Math.round(k.umgesetzt/k.standorte*100) : 0;
                    hkh += '<div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">';
                    hkh += '<div class="flex-1 min-w-0"><p class="text-xs font-semibold text-gray-800 truncate">'+k.name+'</p>';
                    hkh += '<div class="w-full bg-gray-200 rounded-full h-1.5 mt-1"><div class="h-1.5 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-400')+'" style="width:'+pct+'%"></div></div></div>';
                    hkh += '<span class="text-xs font-bold '+(pct>=80?'text-green-600':'text-orange-500')+'">'+pct+'%</span>';
                    hkh += '</div>';
                });
                if(!hkh) hkh = '<p class="text-xs text-gray-400">Keine aktiven Kampagnen</p>';
                hkEl.innerHTML = hkh;
            }

            // Offene Aufgaben kompakt
            var haEl = document.getElementById('hqHomeAufgaben');
            if(haEl && typeof hqTasks !== 'undefined') {
                var hah = '';
                var prioIcons = {hoch:'ðŸ”´',mittel:'ðŸŸ¡',niedrig:'ðŸŸ¢'};
                hqTasks.filter(function(t){return t.status!=='done';}).sort(function(a,b){var po={hoch:0,mittel:1,niedrig:2};return (po[a.prio]||1)-(po[b.prio]||1);}).slice(0,5).forEach(function(t){
                    var pct = Math.round(t.done/t.total*100);
                    hah += '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-lg">';
                    hah += '<span class="text-xs">'+(prioIcons[t.prio]||'')+'</span>';
                    hah += '<div class="flex-1 min-w-0"><p class="text-[11px] font-semibold text-gray-800 truncate">'+t.title+'</p>';
                    hah += '<p class="text-[9px] text-gray-400">Frist: '+t.deadline+' Â· '+pct+'% erledigt</p></div>';
                    hah += '</div>';
                });
                if(!hah) hah = '<p class="text-xs text-gray-400 text-center">Alles erledigt! âœ…</p>';
                haEl.innerHTML = hah;
            }

            // Naechste Termine kompakt
            var htEl = document.getElementById('hqHomeTermine');
            if(htEl && typeof hqKalTermine !== 'undefined') {
                var hth = '';
                var typeIcons = {schulung:'ðŸŽ“',event:'ðŸŽª',deadline:'â°',meeting:'ðŸ¤'};
                hqKalTermine.filter(function(t){return t.date>='2026-02-14';}).sort(function(a,b){return a.date>b.date?1:-1;}).slice(0,5).forEach(function(t){
                    hth += '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-lg">';
                    hth += '<span class="text-sm">'+(typeIcons[t.type]||'ðŸ“…')+'</span>';
                    hth += '<div class="flex-1 min-w-0"><p class="text-[11px] font-semibold text-gray-800 truncate">'+t.title+'</p>';
                    hth += '<p class="text-[9px] text-gray-400">'+t.date+' Â· '+t.time+' Uhr'+(t.pflicht?' Â· <span class="text-red-500">PFLICHT</span>':'')+'</p></div>';
                    hth += '</div>';
                });
                if(!hth) hth = '<p class="text-xs text-gray-400 text-center">Keine Termine</p>';
                htEl.innerHTML = hth;
            }

            // Letzte Ankuendigungen kompakt
            var aaEl = document.getElementById('hqHomeAnnounce');
            if(aaEl && typeof hqAnnouncements !== 'undefined') {
                var aah = '';
                hqAnnouncements.slice(0,3).forEach(function(a){
                    var readPct = Math.round(a.read/a.total*100);
                    aah += '<div class="p-2 bg-gray-50 rounded-lg">';
                    aah += '<p class="text-[11px] font-semibold text-gray-800 truncate">'+a.title+'</p>';
                    aah += '<div class="flex items-center justify-between mt-1"><p class="text-[9px] text-gray-400">'+a.date+' Â· '+a.author+'</p>';
                    aah += '<span class="text-[9px] font-bold '+(readPct>=90?'text-green-600':'text-orange-500')+'">'+a.read+'/'+a.total+' gelesen</span></div>';
                    aah += '</div>';
                });
                aaEl.innerHTML = aah;
            }
        }

        // === HQ STANDORTE (Detailliste) ===
        async function renderHqStandorte() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var search = (document.getElementById('hqStandortSearch')||{}).value||'';
            var filter = (document.getElementById('hqStandortFilter')||{}).value||'all';
            var list = hqStandorte.filter(function(s){
                if(search && s.name.toLowerCase().indexOf(search.toLowerCase())===-1) return false;
                if(filter==='kritisch' && s.leadPerf>=50) return false;
                if(filter==='achtung' && (s.leadPerf<50||s.leadPerf>=75)) return false;
                if(filter==='gut' && (s.leadPerf<75||s.leadPerf>=100)) return false;
                if(filter==='top' && s.leadPerf<100) return false;
                return true;
            });
            list.sort(function(a,b){return b.leadPerf-a.leadPerf;});
            var el = document.getElementById('hqStandorteList');
            if(!el) return;
            var h = '';
            list.forEach(function(s) {
                h += '<div class="vit-card p-5 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-3">';
                h += '<div><h3 class="font-bold text-gray-800">'+s.name+'</h3><p class="text-xs text-gray-400">'+s.inhaber+' Â· Region: '+s.region+'</p></div>';
                h += '<div class="flex items-center space-x-3">';
                h += stratBadge(s.strategieStatus);
                h += '<span class="'+perfBg(s.leadPerf)+' text-xs px-3 py-1 rounded-full font-bold">'+s.leadPerf+'% Lead-Perf.</span>';
                h += '</div></div>';
                h += '<div class="grid grid-cols-3 md:grid-cols-6 gap-3">';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Umsatz</p><p class="text-sm font-bold">'+fmt(s.umsatzIst)+' â‚¬</p><p class="text-[10px] '+(s.umsatzIst>=s.umsatzPlan?'text-green-500':'text-red-500')+'">Plan: '+fmt(s.umsatzPlan)+'</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Rohertrag</p><p class="text-sm font-bold '+(s.rohertrag>=38?'text-green-600':'text-red-500')+'">'+s.rohertrag+'%</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Leads</p><p class="text-sm font-bold">'+s.leads+'</p><p class="text-[10px] text-gray-400">CPT: '+s.cpt+' â‚¬</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Rabattquote</p><p class="text-sm font-bold '+(s.rabattQuote<=5?'text-green-600':s.rabattQuote<=8?'text-yellow-600':'text-red-500')+'">'+s.rabattQuote+'%</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Vororder</p><p class="text-sm font-bold">'+(s.vororderBikes||'â€”')+' Bikes</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Tickets</p><p class="text-sm font-bold '+(s.offeneTickets>2?'text-red-500':'text-gray-700')+'">'+s.offeneTickets+'</p></div>';
                h += '</div>';
                if(s.bwaAuffaellig) h += '<div class="mt-3 p-2 bg-red-50 rounded text-xs text-red-600">âš ï¸ '+s.bwaAuffaellig+'</div>';
                h += '<div class="mt-3 pt-3 border-t border-gray-100 flex justify-end"><button onclick="hqDrillDown(\''+s.name.toLowerCase().replace(/[^a-z]/g,'').substring(0,8)+'\')" class="text-xs text-vit-orange hover:text-orange-600 font-semibold flex items-center space-x-1"><span>Standort oeffnen</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button></div>';
                h += '</div>';
            });
            if(!list.length) h = '<div class="text-center py-12 text-gray-400">Keine Standorte gefunden</div>';
            el.innerHTML = h;
        }

        // === HQ FINANZEN ===
        async function renderHqFinanzen() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var active = hqStandorte.filter(function(s){return s.umsatzIst>0;});
            var totalU = hqStandorte.reduce(function(a,s){return a+s.umsatzIst;},0);
            var totalP = hqStandorte.reduce(function(a,s){return a+s.umsatzPlan;},0);
            var avgRoh = active.length?(active.reduce(function(a,s){return a+s.rohertrag;},0)/active.length).toFixed(1):0;
            var avgRab = active.length?(active.reduce(function(a,s){return a+s.rabattQuote;},0)/active.length).toFixed(1):0;

            var kpi = document.getElementById('hqFinKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Netzwerk-Umsatz</p><p class="text-2xl font-bold">'+fmt(totalU)+' â‚¬</p><p class="text-xs '+(totalU>=totalP?'text-green-500':'text-red-500')+'">Plan: '+fmt(totalP)+' â‚¬</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rohertrag</p><p class="text-2xl font-bold '+(avgRoh>=38?'text-green-600':'text-red-500')+'">'+avgRoh+'%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rabattquote</p><p class="text-2xl font-bold '+(avgRab<=5?'text-green-600':'text-red-500')+'">'+avgRab+'%</p><p class="text-xs text-gray-500">Ziel: unter 5%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">BWA-Auffaelligkeiten</p><p class="text-2xl font-bold text-red-600">'+hqStandorte.filter(function(s){return s.bwaAuffaellig;}).length+'</p></div>';

            // Table
            var t = document.getElementById('hqFinTable');
            if(t) {
                var th = '<thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-2 text-xs text-gray-500">Standort</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz Plan</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz Ist</th><th class="text-right py-2 px-2 text-xs text-gray-500">Abw.</th><th class="text-right py-2 px-2 text-xs text-gray-500">Rohertrag</th><th class="text-right py-2 px-2 text-xs text-gray-500">Rabatt %</th><th class="text-center py-2 px-2 text-xs text-gray-500">BWA</th></tr></thead><tbody>';
                hqStandorte.slice().sort(function(a,b){return b.umsatzIst-a.umsatzIst;}).forEach(function(s){
                    var abw = s.umsatzPlan?Math.round((s.umsatzIst/s.umsatzPlan-1)*100):0;
                    th += '<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="py-2 px-2 text-sm font-semibold">'+s.name+'</td><td class="py-2 px-2 text-sm text-right text-gray-500">'+fmt(s.umsatzPlan)+'</td><td class="py-2 px-2 text-sm text-right font-semibold">'+fmt(s.umsatzIst)+'</td><td class="py-2 px-2 text-sm text-right font-bold '+(abw>=0?'text-green-600':'text-red-500')+'">'+(abw>=0?'+':'')+abw+'%</td><td class="py-2 px-2 text-sm text-right '+(s.rohertrag>=38?'text-green-600':'text-red-500')+'">'+s.rohertrag+'%</td><td class="py-2 px-2 text-sm text-right '+(s.rabattQuote<=5?'text-green-600':s.rabattQuote<=8?'text-yellow-600':'text-red-500')+'">'+s.rabattQuote+'%</td><td class="py-2 px-2 text-center">'+(s.bwaAuffaellig?'<span class="text-xs text-red-500">âš ï¸</span>':'<span class="text-xs text-green-500">âœ“</span>')+'</td></tr>';
                });
                th += '</tbody>';
                t.innerHTML = th;
            }

            // Alerts
            var al = document.getElementById('hqFinAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.bwaAuffaellig;}).sort(function(a,b){return a.rohertrag-b.rohertrag;}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg flex items-center justify-between"><div><p class="text-sm font-semibold text-red-700">'+s.name+'</p><p class="text-xs text-red-500">'+s.bwaAuffaellig+'</p></div><span class="text-xs text-gray-400">Rohertrag: '+s.rohertrag+'%</span></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Keine Auffaelligkeiten</p>';
            }

            // Rohertrag Ranking
            var rr = document.getElementById('hqFinRohertrag');
            if(rr) {
                var rrh = '';
                hqStandorte.filter(function(s){return s.umsatzIst>0;}).sort(function(a,b){return b.rohertrag-a.rohertrag;}).forEach(function(s){
                    var w = Math.max(5, s.rohertrag * 2);
                    rrh += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-4"><div class="h-4 rounded-full '+(s.rohertrag>=38?'bg-green-500':s.rohertrag>=34?'bg-yellow-500':'bg-red-500')+'" style="width:'+w+'%"></div></div><span class="text-xs font-bold w-12 text-right">'+s.rohertrag+'%</span></div>';
                });
                rr.innerHTML = rrh;
            }
        }

        // === HQ MARKETING ===
        function renderHqMarketing() {
            var active = hqStandorte.filter(function(s){return s.leads>0;});
            var totalLeads = hqStandorte.reduce(function(a,s){return a+s.leads;},0);
            var totalBudget = hqStandorte.reduce(function(a,s){return a+s.budget;},0);
            var avgCpt = active.length?Math.round(active.reduce(function(a,s){return a+s.cpt;},0)/active.length):0;
            var avgPerf = active.length?Math.round(active.reduce(function(a,s){return a+s.leadPerf;},0)/active.length):0;
            var stratDone = hqStandorte.filter(function(s){return s.strategieStatus==='done';}).length;

            var kpi = document.getElementById('hqMktKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-4"><p class="text-xs text-gray-400">Leads gesamt</p><p class="text-xl font-bold">'+totalLeads+'</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Budget/Monat</p><p class="text-xl font-bold">'+fmt(totalBudget)+' â‚¬</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Ã˜ CPT</p><p class="text-xl font-bold">'+avgCpt+' â‚¬</p><p class="text-[10px] text-gray-400">Ziel: &lt;163 â‚¬</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Ã˜ Lead-Perf.</p><p class="text-xl font-bold '+perfColor(avgPerf)+'">'+avgPerf+'%</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Strategie vereinbart</p><p class="text-xl font-bold">'+stratDone+' / '+hqStandorte.length+'</p></div>';

            // Lead Performance
            var lp = document.getElementById('hqMktLeads');
            if(lp) {
                var lph = '';
                hqStandorte.slice().sort(function(a,b){return b.leadPerf-a.leadPerf;}).forEach(function(s){
                    var w = Math.min(100, s.leadPerf);
                    lph += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full" style="width:'+w+'%;background:'+perfDot(s.leadPerf)+'"></div></div><span class="text-xs font-bold w-10 text-right">'+s.leadPerf+'%</span></div>';
                });
                lp.innerHTML = lph;
            }

            // Strategie Status
            var ms = document.getElementById('hqMktStrategie');
            if(ms) {
                var msh = '';
                hqStandorte.forEach(function(s){
                    msh += '<div class="flex items-center justify-between py-1"><span class="text-xs">'+s.name+'</span>'+stratBadge(s.strategieStatus)+'</div>';
                });
                ms.innerHTML = msh;
            }

            // Alerts
            var ma = document.getElementById('hqMktAlerts');
            if(ma) {
                var mah = '';
                hqStandorte.filter(function(s){return s.leadPerf<50;}).sort(function(a,b){return a.leadPerf-b.leadPerf;}).forEach(function(s){
                    mah += '<div class="p-3 bg-red-50 rounded-lg"><div class="flex justify-between"><span class="text-sm font-semibold text-red-700">'+s.name+' â€“ '+s.leadPerf+'% Lead-Performance</span><span class="text-xs text-gray-400">CPT: '+s.cpt+' â‚¬</span></div><p class="text-xs text-red-500 mt-1">Budget: '+s.budget+' â‚¬/Monat Â· '+s.leads+' Leads Â· '+(s.strategieStatus==='missing'?'âŒ Keine Strategie vereinbart':'Strategie: '+s.strategieStatus)+'</p></div>';
                });
                hqStandorte.filter(function(s){return s.strategieStatus==='missing';}).forEach(function(s){
                    if(s.leadPerf>=50) mah += '<div class="p-3 bg-yellow-50 rounded-lg"><span class="text-sm font-semibold text-yellow-700">'+s.name+' â€“ Marketing-Strategie fehlt</span></div>';
                });
                ma.innerHTML = mah || '<p class="text-sm text-green-600">âœ… Alle Standorte im gruenen Bereich</p>';
            }
        }

        // === HQ EINKAUF ===
        function renderHqEinkauf() {
            var totalVO = hqStandorte.reduce(function(a,s){return a+s.vororderBikes;},0);
            var voDone = hqStandorte.filter(function(s){return s.vororderStatus==='done';}).length;
            var voOpen = hqStandorte.filter(function(s){return s.vororderStatus==='open';}).length;
            var avgRab = (hqStandorte.filter(function(s){return s.rabattQuote>0;}).reduce(function(a,s){return a+s.rabattQuote;},0)/hqStandorte.filter(function(s){return s.rabattQuote>0;}).length).toFixed(1);

            var kpi = document.getElementById('hqEkKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder Bikes gesamt</p><p class="text-2xl font-bold">'+totalVO+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder abgeschlossen</p><p class="text-2xl font-bold text-green-600">'+voDone+' / '+hqStandorte.length+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder offen</p><p class="text-2xl font-bold '+(voOpen>3?'text-red-600':'text-yellow-600')+'">'+voOpen+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rabattquote</p><p class="text-2xl font-bold '+(avgRab<=5?'text-green-600':'text-red-500')+'">'+avgRab+'%</p><p class="text-xs text-gray-500">Ziel: unter 5%</p></div>';

            // Vororder
            var vo = document.getElementById('hqEkVororder');
            if(vo) {
                var voh = '';
                hqStandorte.forEach(function(s){
                    var vc = {done:'bg-green-100 text-green-700',partial:'bg-yellow-100 text-yellow-700',open:'bg-red-100 text-red-700'};
                    var vl = {done:'âœ… Abgeschlossen',partial:'ðŸ”¶ Teilweise',open:'âŒ Offen'};
                    voh += '<div class="flex items-center justify-between py-1.5 border-b border-gray-50"><span class="text-xs w-28 truncate font-semibold">'+s.name+'</span><span class="text-xs">'+(s.vororderBikes||'â€”')+' Bikes</span><span class="text-[10px] px-2 py-0.5 rounded-full '+(vc[s.vororderStatus]||vc.open)+'">'+(vl[s.vororderStatus]||'?')+'</span></div>';
                });
                vo.innerHTML = voh;
            }

            // Rohertrag
            var rr = document.getElementById('hqEkRohertrag');
            if(rr) {
                var rrh = '';
                hqStandorte.filter(function(s){return s.rohertrag>0;}).sort(function(a,b){return b.rohertrag-a.rohertrag;}).forEach(function(s){
                    rrh += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full '+(s.rohertrag>=38?'bg-green-500':s.rohertrag>=34?'bg-yellow-500':'bg-red-500')+'" style="width:'+Math.max(5,s.rohertrag*2)+'%"></div></div><span class="text-xs font-bold w-12 text-right">'+s.rohertrag+'%</span></div>';
                });
                rr.innerHTML = rrh;
            }

            // Alerts
            var al = document.getElementById('hqEkAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.vororderStatus==='open';}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg mb-2"><span class="text-sm font-semibold text-red-700">âŒ '+s.name+' â€“ Keine Vororder platziert</span><p class="text-xs text-red-500">Dringend Gespraech mit Inhaber fuehren</p></div>';
                });
                hqStandorte.filter(function(s){return s.rabattQuote>8;}).forEach(function(s){
                    alh += '<div class="p-3 bg-yellow-50 rounded-lg mb-2"><span class="text-sm font-semibold text-yellow-700">âš ï¸ '+s.name+' â€“ Rabattquote '+s.rabattQuote+'%</span><p class="text-xs text-yellow-600">Ziel unter 5%. Schulung Dreingaben vs. Rabatte empfohlen.</p></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Alle Standorte im gruenen Bereich</p>';
            }
        }

        // === HQ VERKAUF ===
        function renderHqVerkauf() {
            var totalVK = hqStandorte.reduce(function(a,s){return a+s.verkauftKW;},0);
            var totalBer = hqStandorte.reduce(function(a,s){return a+s.beratungenKW;},0);
            var conversion = totalBer ? Math.round(totalVK/totalBer*100) : 0;
            var active = hqStandorte.filter(function(s){return s.verkauftKW>0;}).length;

            var kpi = document.getElementById('hqVkKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Verkaeufe KW 7</p><p class="text-2xl font-bold">'+totalVK+'</p><p class="text-xs text-gray-500">Netzwerk-weit</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Beratungen KW 7</p><p class="text-2xl font-bold">'+totalBer+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Conversion</p><p class="text-2xl font-bold '+(conversion>=40?'text-green-600':'text-yellow-600')+'">'+conversion+'%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Aktive Standorte</p><p class="text-2xl font-bold">'+active+' / '+hqStandorte.length+'</p></div>';

            var t = document.getElementById('hqVkTable');
            if(t) {
                var th = '<thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-2 text-xs text-gray-500">Standort</th><th class="text-right py-2 px-2 text-xs text-gray-500">Beratungen</th><th class="text-right py-2 px-2 text-xs text-gray-500">Verkauft</th><th class="text-right py-2 px-2 text-xs text-gray-500">Conversion</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz YTD</th></tr></thead><tbody>';
                hqStandorte.slice().sort(function(a,b){return b.verkauftKW-a.verkauftKW;}).forEach(function(s){
                    var conv = s.beratungenKW ? Math.round(s.verkauftKW/s.beratungenKW*100) : 0;
                    th += '<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="py-2 px-2 text-sm font-semibold">'+s.name+'</td><td class="py-2 px-2 text-sm text-right">'+s.beratungenKW+'</td><td class="py-2 px-2 text-sm text-right font-bold">'+s.verkauftKW+'</td><td class="py-2 px-2 text-sm text-right '+(conv>=40?'text-green-600':conv>=25?'text-yellow-600':'text-red-500')+'">'+conv+'%</td><td class="py-2 px-2 text-sm text-right">'+fmt(s.umsatzIst)+' â‚¬</td></tr>';
                });
                th += '</tbody>';
                t.innerHTML = th;
            }

            var al = document.getElementById('hqVkAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.verkauftKW===0;}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg mb-2"><span class="text-sm font-semibold text-red-700">ðŸ”´ '+s.name+' â€“ 0 Verkaeufe in KW 7</span></div>';
                });
                hqStandorte.filter(function(s){return s.beratungenKW>0 && s.verkauftKW>0 && (s.verkauftKW/s.beratungenKW)<0.2;}).forEach(function(s){
                    alh += '<div class="p-3 bg-yellow-50 rounded-lg mb-2"><span class="text-sm font-semibold text-yellow-700">âš ï¸ '+s.name+' â€“ Conversion unter 20%</span><p class="text-xs text-yellow-600">'+s.beratungenKW+' Beratungen, nur '+s.verkauftKW+' Abschluesse. Verkaufsschulung empfohlen.</p></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Alle Standorte verkaufen aktiv</p>';
            }
        }

        // === HQ HANDLUNGSBEDARF (konsolidiert) ===
        function renderHqAktionen() {
            var aktionen = [];
            hqStandorte.forEach(function(s) {
                if(s.leadPerf===0) aktionen.push({prio:1,bereich:'Standort',standort:s.name,text:'Standort inaktiv â€“ Nachfolger/Reaktivierung noetig',color:'bg-gray-800 text-white'});
                if(s.strategieStatus==='missing' && s.umsatzIst>0) aktionen.push({prio:1,bereich:'Strategie',standort:s.name,text:'Marketing- & Einkaufsstrategie fehlt â€“ Termin vereinbaren',color:'bg-red-600 text-white'});
                if(s.vororderStatus==='open' && s.umsatzIst>0) aktionen.push({prio:2,bereich:'Einkauf',standort:s.name,text:'Keine Vororder 2026 platziert â€“ dringend Gespraech fuehren',color:'bg-red-500 text-white'});
                if(s.rohertrag>0 && s.rohertrag<32) aktionen.push({prio:2,bereich:'Controlling',standort:s.name,text:'Rohertrag kritisch ('+s.rohertrag+'%) â€“ Massnahmenplan erstellen',color:'bg-red-500 text-white'});
                if(s.rabattQuote>10) aktionen.push({prio:2,bereich:'Verkauf',standort:s.name,text:'Rabattquote '+s.rabattQuote+'% â€“ Schulung Dreingaben vs. Rabatte',color:'bg-red-400 text-white'});
                if(s.leadPerf>0 && s.leadPerf<50) aktionen.push({prio:3,bereich:'Marketing',standort:s.name,text:'Lead-Performance '+s.leadPerf+'% â€“ Budget/Strategie pruefen',color:'bg-orange-500 text-white'});
                if(s.offeneTickets>=4) aktionen.push({prio:3,bereich:'Support',standort:s.name,text:s.offeneTickets+' offene Tickets â€“ Abarbeitung priorisieren',color:'bg-yellow-500 text-gray-800'});
                if(s.bwaAuffaellig && s.rohertrag>=32) aktionen.push({prio:4,bereich:'Controlling',standort:s.name,text:s.bwaAuffaellig,color:'bg-yellow-400 text-gray-800'});
                if(s.strategieStatus==='pending') aktionen.push({prio:4,bereich:'Strategie',standort:s.name,text:'Strategie-Vereinbarung noch ausstehend â€“ nachfassen',color:'bg-yellow-300 text-gray-800'});
            });
            aktionen.sort(function(a,b){return a.prio-b.prio;});

            var kpi = document.getElementById('hqAktKpis');
            if(kpi) {
                var p1 = aktionen.filter(function(a){return a.prio<=2;}).length;
                var p2 = aktionen.filter(function(a){return a.prio===3;}).length;
                var p3 = aktionen.filter(function(a){return a.prio>=4;}).length;
                kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Aktionen gesamt</p><p class="text-2xl font-bold text-gray-800">'+aktionen.length+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-red-500"><p class="text-xs text-gray-400 uppercase">ðŸ”´ Kritisch</p><p class="text-2xl font-bold text-red-600">'+p1+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-orange-500"><p class="text-xs text-gray-400 uppercase">ðŸŸ  Wichtig</p><p class="text-2xl font-bold text-orange-600">'+p2+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-yellow-400"><p class="text-xs text-gray-400 uppercase">ðŸŸ¡ Beobachten</p><p class="text-2xl font-bold text-yellow-600">'+p3+'</p></div>';
            }

            var list = document.getElementById('hqAktionenList');
            if(list) {
                var lh = '';
                aktionen.forEach(function(a) {
                    lh += '<div class="vit-card p-4 flex items-center space-x-4 hover:shadow-md transition">';
                    lh += '<span class="'+a.color+' text-[10px] px-2.5 py-1 rounded-full font-bold whitespace-nowrap">'+a.bereich+'</span>';
                    lh += '<div class="flex-1"><p class="text-sm font-semibold text-gray-800">'+a.standort+'</p><p class="text-xs text-gray-500">'+a.text+'</p></div>';
                    lh += '<span class="text-xs text-gray-400 whitespace-nowrap">Prio '+(a.prio<=2?'ðŸ”´':a.prio===3?'ðŸŸ ':'ðŸŸ¡')+'</span>';
                    lh += '</div>';
                });
                list.innerHTML = lh || '<div class="text-center py-12 text-gray-400"><p class="text-4xl mb-2">âœ…</p><p>Kein Handlungsbedarf â€“ alles laeuft!</p></div>';
            }
        }

        // Hook HQ views into showView
        var origShowView2 = showView;
        showView = function(v) {
            // RechteprÃ¼fung
            if(!hasAccess(v)) {
                alert('Kein Zugriff auf diesen Bereich mit Ihrer aktuellen Rolle.');
                return;
            }
            // Redirect 'home' to HQ Cockpit when in HQ mode
            if(v==='home' && currentRole==='hq') { v='hqCockpit'; }
            origShowView2(v);
            if(v==='hqCockpit') renderHqCockpit();
            if(v==='hqStandorte') renderHqStandorte();
            if(v==='hqFinanzen') renderHqFinanzen();
            if(v==='hqMarketing') renderHqMarketing();
            if(v==='hqEinkauf') renderHqEinkauf();
            if(v==='hqVerkauf') renderHqVerkauf();
            if(v==='hqAktionen') renderHqAktionen();
            if(v==='hqKomm'){showView('hqKommando');showKommandoTab('kommunikation');return;}
            if(v==='hqKampagnen'){showView('hqKommando');showKommandoTab('kampagnen');return;}
            if(v==='hqDokumente'){showView('hqKommando');showKommandoTab('dokumente');return;}
            if(v==='hqKalender'){showView('hqKommando');showKommandoTab('kalender');return;}
            if(v==='hqAufgaben'){showView('hqKommando');showKommandoTab('aufgaben');return;}
            if(v==='hqAuswertung') renderHqAuswertung();
            if(v==='hqWissen') renderHqWissen();
            if(v==='hqSupport') renderHqSupport();
            if(v==='hqIdeen') renderHqIdeen();
            if(v==='hqShop') renderHqShop();
            if(v==='hqEinstellungen') renderHqEinstellungen();
            if(v==='mitarbeiter') renderPartnerMitarbeiter();
            if(v==='hqKommando') renderKommandozentrale();
            if(v==='kalender') loadKalTermine();
            if(v==='todo') loadTodos();
            if(v==='notifications') renderNotifications('all');
        };

        // === MOBILE SIDEBAR ===
        function toggleMobileSidebar() {
            var sidebar = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if(sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        function closeMobileSidebar() {
            var sidebar = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if(sidebar) sidebar.classList.remove('mobile-open');
            if(overlay) overlay.classList.remove('active');
        }
        // Auto-close sidebar on navigation (mobile)
        var origShowViewMobile = showView;
        showView = function(v) {
            closeMobileSidebar();
            origShowViewMobile(v);
        };

        // === VIEW MODE SWITCHER (Partner vs HQ) ===
        function switchViewMode(mode) {
            var isHQ = mode === 'hq';

            if(isHQ) {
                currentRole = 'hq';
                // Keep original roles but add hq
                if(currentRoles.indexOf('hq') < 0) currentRoles.push('hq');
            } else {
                // Remove hq from roles, restore original
                currentRoles = currentRoles.filter(function(r){ return r !== 'hq'; });
                if(currentRoles.length === 0) currentRoles = ['inhaber'];
                currentRole = currentRoles[0];
            }

            try { updateUIForRole(); } catch(e) { console.warn(e); }
            try { applyModulStatus(); } catch(e) { console.warn(e); }

            if(isHQ) {
                showView('hqCockpit');
            } else {
                showView('home');
            }
        }


        // === MODUL-ÃœBERSICHT ===
        var currentModulFilter = 'alle';
        
        var MODUL_DATEN = {
            standort: [
                {name:'Startseite / Dashboard', view:'homeView', status:'live', typ:'standort', details:'Personalisiert, 7 Live-Widgets, 3 Demo-Widgets', kiPrio:35, aufwand:'S', kiTodo:'Restliche 3 Widgets (Kampagnen, Top-VerkÃ¤ufer, Neue Inhalte) an DB anbinden'},
                {name:'Verkauf / CRM', view:'verkaufView', status:'teilweise', typ:'standort', details:'Pipeline/Kanban mit DB, Lead-CRUD, Verkaufstracking, Auswertung', kiPrio:2, aufwand:'L', kiTodo:'Angebotserstellung (PDF), Lead-Import, Follow-up-Erinnerungen. Kernmodul fÃ¼r Umsatz â€“ grÃ¶ÃŸter Hebel fÃ¼r Partner.'},
                {name:'Kalender', view:'kalenderView', status:'live', typ:'standort', details:'Monatsansicht, Termine aus DB laden/erstellen/lÃ¶schen', kiPrio:20, aufwand:'XL', kiTodo:'MS365-Sync wÃ¤re nice-to-have, kein Blocker. Wochenansicht als UX-Verbesserung.'},
                {name:'Aufgaben / Todos', view:'todoView', status:'live', typ:'standort', details:'Erstellen, Bearbeiten, Abhaken, LÃ¶schen, Filtern â€“ alles DB', kiPrio:30, aufwand:'M', kiTodo:'FÃ¤lligkeitsdatum, Zuweisung an Mitarbeiter. Funktioniert aber bereits gut.'},
                {name:'Kommunikation', view:'kommunikationView', status:'live', typ:'standort', details:'AnkÃ¼ndigungen, Brett, Forum, Chat-KanÃ¤le', kiPrio:28, aufwand:'M', kiTodo:'Direktnachrichten fehlt. Ansonsten solide â€“ geringere Prio.'},
                {name:'Controlling / BWA', view:'controllingView', status:'live', typ:'standort', details:'BWA-Parser (10 Formate), Detail-Positionen, KPIs, Trend-Sparklines', kiPrio:3, aufwand:'M', kiTodo:'Benchmarks vs. Netzwerk-Ã˜, LiquiditÃ¤t, Plan/Ist mit echten Plan-Daten. Kernmodul fÃ¼r Steuerung.'},
                {name:'Marketing', view:'marketingView', status:'demo', typ:'standort', details:'6 Tabs, alles statische Demo-Daten, keine DB', kiPrio:8, aufwand:'L', kiTodo:'DB-Tabelle fÃ¼r Kampagnen, Social-Kalender mit echten Terminen, Content-Bibliothek.'},
                {name:'Einkauf', view:'einkaufView', status:'demo', typ:'standort', details:'Lieferanten-Ãœbersicht statisch, keine DB', kiPrio:12, aufwand:'L', kiTodo:'Lieferanten-DB anlegen, Konditionen pflegen, BestellvorschlÃ¤ge.'},
                {name:'Allgemein', view:'allgemeinView', status:'demo', typ:'standort', details:'Standort-Ãœbersicht, Strategie â€“ statisch', kiPrio:33, aufwand:'M', kiTodo:'Standort-Stammdaten aus DB (Adresse, Ã–ffnungszeiten, Team). Nice-to-have.'},
                {name:'Wissen', view:'wissenView', status:'teilweise', typ:'standort', details:'Komplettes UI, aber alle Inhalte in JS hardcoded', kiPrio:10, aufwand:'L', kiTodo:'CMS-DB: Artikel/Videos/Checklisten als DatensÃ¤tze. HQ kann Inhalte zentral pflegen.'},
                {name:'Support', view:'supportView', status:'live', typ:'standort', details:'Ticket-CRUD, Detail, Kommentare, Status â€“ alles DB', kiPrio:25, aufwand:'M', kiTodo:'Ticket-Zuweisung an HQ-Mitarbeiter, E-Mail bei StatusÃ¤nderung.'},
                {name:'Ideenboard', view:'ideenboardView', status:'live', typ:'standort', details:'Einreichen, Abstimmen, Status-Filter â€“ alles DB', kiPrio:34, aufwand:'S', kiTodo:'Kommentar-Funktion unter Ideen. Grundfunktion top.'},
                {name:'Shop', view:'shopView', status:'teilweise', typ:'standort', details:'Produkte aus DB, Warenkorb, Bestellung', kiPrio:18, aufwand:'M', kiTodo:'Bestellhistorie, Lieferstatus-Tracking, PDF-Rechnung.'},
                {name:'Aktenschrank', view:'aktenschrankView', status:'live', typ:'standort', details:'Dokumente aus DB, Upload/Download, Kategorie-Filter', kiPrio:27, aufwand:'S', kiTodo:'Ordnerstruktur verbessern, Vorschau. Funktioniert gut.'},
                {name:'Onboarding', view:'onboardingView', status:'demo', typ:'standort', details:'Demo-Tasks, kein echter Asana-API-Call', kiPrio:5, aufwand:'L', kiTodo:'Echte Asana-API oder eigenes Task-System. Kritisch fÃ¼r neue Partner â€“ erster Eindruck zÃ¤hlt.'},
                {name:'Mitarbeiter', view:'mitarbeiterView', status:'live', typ:'standort', details:'User-CRUD, Rollen, Freigabe â€“ alles DB', kiPrio:29, aufwand:'S', kiTodo:'Profilbild, Arbeitszeitmodell. Core funktioniert top.'},
                {name:'Dashboards', view:'dashboardsView', status:'demo', typ:'standort', details:'Lead-Dashboard + Reporting, Demo-Daten', kiPrio:15, aufwand:'M', kiTodo:'Echte Verkaufs-KPIs aus verkauf_tracking, Vormonat/Vorjahr-Vergleich.'},
                {name:'Benachrichtigungen', view:'notificationsView', status:'stub', typ:'standort', details:'Leerer Container', kiPrio:7, aufwand:'L', kiTodo:'Zentrales System: Tickets, BWA-Erinnerung, Chat-Mentions, Ideen-Status. Querschnittsfunktion.'}
            ],
            hq: [
                {name:'HQ Cockpit', view:'hqCockpitView', status:'teilweise', typ:'hq', details:'Netzwerk-KPIs, Standort-Karten, BWA-Status', kiPrio:4, aufwand:'M', kiTodo:'Echte aggregierte KPIs: Netzwerk-Umsatz aus BWA, Standort-Ranking, Alarm-Logik.'},
                {name:'HQ Kommandozentrale', view:'hqKommandoView', status:'teilweise', typ:'hq', details:'Kommunikation, Dokumente, Kalender (DB), Kampagnen (Demo)', kiPrio:9, aufwand:'M', kiTodo:'Aufgaben-Zuweisung an Standorte, Kampagnen-DB, Push-Nachrichten.'},
                {name:'HQ Aktionen', view:'hqAktionenView', status:'stub', typ:'hq', details:'Nur Container-Stub', kiPrio:22, aufwand:'L', kiTodo:'Netzwerk-Aktionen planen (Rabattaktionen, Events). Evtl. in Marketing integrieren.'},
                {name:'HQ Standorte', view:'hqStandorteView', status:'live', typ:'hq', details:'Standort-Tabelle, Anlegen, Status-Filter', kiPrio:31, aufwand:'S', kiTodo:'Standort-Detail-Seite mit Kennzahlen, MA-Liste, BWA-History.'},
                {name:'HQ Finanzen', view:'hqFinanzenView', status:'live', typ:'hq', details:'BWA-Status aller Standorte, Netzwerk-Finanzen', kiPrio:6, aufwand:'M', kiTodo:'Netzwerk-P&L, Standort-Vergleich, Benchmark-Analyse, Excel/PDF-Export.'},
                {name:'HQ Marketing', view:'hqMarketingView', status:'demo', typ:'hq', details:'Performance-Tabelle mit Demo-Daten', kiPrio:16, aufwand:'L', kiTodo:'Kampagnen-DB, Erfolgs-Tracking pro Standort, Asset-Verwaltung.'},
                {name:'HQ Einkauf', view:'hqEinkaufView', status:'demo', typ:'hq', details:'Demo-Rabattquoten und Bestellvolumen', kiPrio:19, aufwand:'L', kiTodo:'Zentraleinkauf-Dashboard, Konditionen-Verhandlung, BestellbÃ¼ndelung.'},
                {name:'HQ Verkauf', view:'hqVerkaufView', status:'demo', typ:'hq', details:'Ranking mit Demo-Daten', kiPrio:11, aufwand:'M', kiTodo:'Echtes Netzwerk-Ranking aus verkauf_tracking + leads, Standort-Vergleich.'},
                {name:'HQ Auswertung', view:'hqAuswertungView', status:'stub', typ:'hq', details:'Tab-Struktur, keine Inhalte', kiPrio:14, aufwand:'XL', kiTodo:'Business-Intelligence: Netzwerk-Trends, Saisonvergleiche, Forecasting. Komplex.'},
                {name:'HQ Wissen', view:'hqWissenView', status:'teilweise', typ:'hq', details:'Artikel-Ãœbersicht', kiPrio:13, aufwand:'L', kiTodo:'CMS-Backend: Artikel erstellen/bearbeiten/publizieren, PflichtlektÃ¼re markieren.'},
                {name:'HQ Support', view:'hqSupportView', status:'live', typ:'hq', details:'Netzwerk-Tickets, Status Ã¤ndern', kiPrio:24, aufwand:'M', kiTodo:'Ticket-Zuweisung an HQ-MA, SLA-Tracking, Auto-Eskalation.'},
                {name:'HQ Ideen', view:'hqIdeenView', status:'live', typ:'hq', details:'Ideen verwalten, Status Ã¤ndern, Filter', kiPrio:32, aufwand:'S', kiTodo:'Idee-zu-Projekt Konversion, Roadmap-Ansicht. Grundfunktion top.'},
                {name:'HQ Shop', view:'hqShopView', status:'demo', typ:'hq', details:'UI zum HinzufÃ¼gen, keine echte DB', kiPrio:21, aufwand:'L', kiTodo:'Produktverwaltung CRUD, BestellÃ¼bersicht, Rechnungserstellung.'},
                {name:'HQ Einstellungen', view:'hqEinstellungenView', status:'live', typ:'hq', details:'Module, Rollen, User-Freigabe, Login-As â€“ alles DB', kiPrio:36, aufwand:'S', kiTodo:'Branding-Einstellungen (Logo, Farben). Core funktioniert bereits top.'}
            ],
            widgets: [
                {name:'Umsatz & Ergebnis (Hauptkarte)', status:'live', typ:'widget', details:'Letzte BWA aus bwa_daten', kiPrio:37, aufwand:'S', kiTodo:'Plan-Vergleich einbauen wenn Plan-Daten vorhanden.'},
                {name:'Widget: Pipeline', status:'live', typ:'widget', details:'Live aus leads + kalender_termine', kiPrio:38, aufwand:'S', kiTodo:'Click-Through zu konkretem Lead.'},
                {name:'Widget: Termine heute', status:'live', typ:'widget', details:'Echte Termine aus kalender_termine', kiPrio:39, aufwand:'S', kiTodo:'Termin-Direkterstellung aus Widget.'},
                {name:'Widget: Offene Aufgaben', status:'live', typ:'widget', details:'Echte Todos mit Checkbox', kiPrio:40, aufwand:'S', kiTodo:'Direkt-Erstellung im Widget.'},
                {name:'Widget: Controlling', status:'live', typ:'widget', details:'Letzte BWA-Kennzahlen', kiPrio:41, aufwand:'S', kiTodo:'Trend-Pfeil vs. Vormonat.'},
                {name:'Widget: Support Tickets', status:'live', typ:'widget', details:'Offene Tickets mit Alter', kiPrio:42, aufwand:'S', kiTodo:'Farbwechsel bei >7 Tage.'},
                {name:'Widget: Nachrichten HQ', status:'live', typ:'widget', details:'AnkÃ¼ndigungen mit relativer Zeit', kiPrio:43, aufwand:'S', kiTodo:'Fertig. Keine Ã„nderung nÃ¶tig.'},
                {name:'Widget: Verkaufserfolg KW', status:'demo', typ:'widget', details:'KW dynamisch, Zahlen statisch', kiPrio:17, aufwand:'M', kiTodo:'Echte Wochen-Daten aus verkauf_tracking aggregieren.'},
                {name:'Widget: Aktive Kampagnen', status:'stub', typ:'widget', details:'Statisch, keine DB', kiPrio:23, aufwand:'M', kiTodo:'Braucht erst Kampagnen-DB (abhÃ¤ngig von Marketing-Modul).'},
                {name:'Widget: Top VerkÃ¤ufer', status:'stub', typ:'widget', details:'Statische Demo-Namen', kiPrio:26, aufwand:'M', kiTodo:'Ranking aus verkauf_tracking pro MA. Braucht MA-Zuordnung.'},
                {name:'Widget: Neue Inhalte', status:'stub', typ:'widget', details:'Statische Demo-EintrÃ¤ge', kiPrio:36, aufwand:'M', kiTodo:'Braucht Wissens-CMS (abhÃ¤ngig von Wissen-Modul).'}
            ]
        };

        // HQ-Prio: eigene Reihenfolge, gespeichert in localStorage
        var hqPrioOrder = null;

        function loadHqPrio() {
            try { var s = localStorage.getItem('vitbikes_hq_prio'); if(s) { hqPrioOrder = JSON.parse(s); return; } } catch(e) {}
            hqPrioOrder = null;
        }
        function saveHqPrio() {
            try { localStorage.setItem('vitbikes_hq_prio', JSON.stringify(hqPrioOrder)); } catch(e) {}
        }
        function resetHqPrio() {
            hqPrioOrder = null;
            try { localStorage.removeItem('vitbikes_hq_prio'); } catch(e){}
            renderModulStatus();
        }

        function getAllModulesFlat() {
            return MODUL_DATEN.standort.concat(MODUL_DATEN.hq).concat(MODUL_DATEN.widgets);
        }

        function getAufwandBadge(a) {
            var map = { 'S':{bg:'bg-green-100 text-green-700',label:'S Â· <1 Tag'}, 'M':{bg:'bg-blue-100 text-blue-700',label:'M Â· 1-3 Tage'}, 'L':{bg:'bg-orange-100 text-orange-700',label:'L Â· 3-7 Tage'}, 'XL':{bg:'bg-red-100 text-red-700',label:'XL Â· >1 Woche'} };
            var m = map[a] || map['M'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold '+m.bg+'">'+m.label+'</span>';
        }
        function getTypBadge(t) {
            var map = { 'standort':{bg:'bg-indigo-100 text-indigo-700',label:'ðŸª Standort'}, 'hq':{bg:'bg-purple-100 text-purple-700',label:'ðŸ¢ HQ'}, 'widget':{bg:'bg-cyan-100 text-cyan-700',label:'ðŸ“Š Widget'} };
            var m = map[t] || map['standort'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold '+m.bg+'">'+m.label+'</span>';
        }
        function getStatusBadge(s) {
            var map = { 'live':{bg:'bg-green-100 text-green-800',icon:'ðŸŸ¢',label:'Live'}, 'teilweise':{bg:'bg-yellow-100 text-yellow-800',icon:'ðŸŸ¡',label:'Teilweise'}, 'demo':{bg:'bg-orange-100 text-orange-800',icon:'ðŸŸ ',label:'Demo/UI'}, 'stub':{bg:'bg-red-100 text-red-800',icon:'ðŸ”´',label:'Stub'} };
            var m = map[s] || map['stub'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold '+m.bg+'">'+m.icon+' '+m.label+'</span>';
        }

        function filterModulStatus(f) {
            currentModulFilter = f;
            document.querySelectorAll('.ms-filter').forEach(function(b){
                b.className = 'ms-filter text-xs px-3 py-1.5 rounded-full font-semibold ' + (b.getAttribute('data-f')===f ? 'bg-vit-orange text-white' : 'bg-gray-100 text-gray-600');
            });
            renderModulStatus();
        }

        function renderPrioTable(items, isDraggable) {
            var tid = isDraggable ? 'hqPrioTable' : 'kiPrioTable';
            var s = '<div class="overflow-x-auto"><table class="w-full text-sm" id="'+tid+'">';
            s += '<thead><tr class="border-b-2 border-gray-200">';
            s += '<th class="text-left py-2 px-2 font-semibold text-gray-600 w-10">#</th>';
            if(isDraggable) s += '<th class="w-10 text-center font-semibold text-gray-400 text-xs">â†•</th>';
            s += '<th class="text-left py-2 px-3 font-semibold text-gray-600">Modul</th>';
            s += '<th class="text-left py-2 px-2 font-semibold text-gray-600 w-20">Typ</th>';
            s += '<th class="text-left py-2 px-2 font-semibold text-gray-600 w-24">Status</th>';
            s += '<th class="text-left py-2 px-2 font-semibold text-gray-600 w-28">Aufwand</th>';
            s += '<th class="text-left py-2 px-3 font-semibold text-gray-600">NÃ¤chster Schritt</th>';
            s += '</tr></thead><tbody>';
            items.forEach(function(m, idx) {
                var rowBg = m.status==='stub' ? 'bg-red-50/40' : (m.status==='demo' ? 'bg-orange-50/30' : '');
                s += '<tr class="border-b border-gray-100 hover:bg-gray-50 '+rowBg+'" data-idx="'+idx+'" data-name="'+m.name+'"';
                if(isDraggable) s += ' draggable="true" ondragstart="onPrioDragStart(event)" ondragover="onPrioDragOver(event)" ondragleave="onPrioDragLeave(event)" ondrop="onPrioDrop(event)" style="cursor:grab;"';
                s += '>';
                var numCls = idx < 3 ? 'bg-vit-orange text-white' : (idx < 10 ? 'bg-orange-100 text-orange-700' : 'bg-gray-200 text-gray-600');
                s += '<td class="py-2 px-2 text-center"><span class="inline-flex items-center justify-center w-7 h-7 rounded-full '+numCls+' text-xs font-bold">'+(idx+1)+'</span></td>';
                if(isDraggable) {
                    s += '<td class="text-center"><div class="flex flex-col items-center leading-none">';
                    s += '<button onclick="moveHqPrio('+idx+',-1)" class="text-gray-400 hover:text-vit-orange text-sm leading-none">â–²</button>';
                    s += '<span class="text-gray-300 text-[10px]">â ¿</span>';
                    s += '<button onclick="moveHqPrio('+idx+',1)" class="text-gray-400 hover:text-vit-orange text-sm leading-none">â–¼</button>';
                    s += '</div></td>';
                }
                s += '<td class="py-2 px-3 font-semibold text-gray-800">';
                if(m.view) s += '<button onclick="showView(\''+m.view.replace('View','')+'\')" class="hover:text-vit-orange transition-colors text-left">'+m.name+'</button>';
                else s += m.name;
                s += '</td>';
                s += '<td class="py-2 px-2">'+getTypBadge(m.typ||'standort')+'</td>';
                s += '<td class="py-2 px-2">'+getStatusBadge(m.status)+'</td>';
                s += '<td class="py-2 px-2">'+getAufwandBadge(m.aufwand||'M')+'</td>';
                s += '<td class="py-2 px-3 text-gray-500 text-xs leading-snug">'+(m.kiTodo||m.details)+'</td>';
                s += '</tr>';
            });
            s += '</tbody></table></div>';
            return s;
        }

        // Drag & Drop for HQ Prio
        var _prioDragIdx = null;
        function onPrioDragStart(e) {
            _prioDragIdx = parseInt(e.target.closest('tr').getAttribute('data-idx'));
            e.target.closest('tr').style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }
        function onPrioDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; var tr = e.target.closest('tr'); if(tr) tr.style.borderTop = '3px solid #EF7D00'; }
        function onPrioDragLeave(e) { var tr = e.target.closest('tr'); if(tr) tr.style.borderTop = ''; }
        function onPrioDrop(e) {
            e.preventDefault();
            var tr = e.target.closest('tr'); if(tr) tr.style.borderTop = '';
            var targetIdx = parseInt(tr.getAttribute('data-idx'));
            if(_prioDragIdx === null || _prioDragIdx === targetIdx) return;
            var item = hqPrioOrder.splice(_prioDragIdx, 1)[0];
            hqPrioOrder.splice(targetIdx, 0, item);
            saveHqPrio();
            renderModulStatus();
            _prioDragIdx = null;
        }
        function moveHqPrio(idx, dir) {
            if(!hqPrioOrder) return;
            var ni = idx + dir;
            if(ni < 0 || ni >= hqPrioOrder.length) return;
            var tmp = hqPrioOrder[idx]; hqPrioOrder[idx] = hqPrioOrder[ni]; hqPrioOrder[ni] = tmp;
            saveHqPrio();
            renderModulStatus();
        }

        function renderModulStatus() {
            var el = document.getElementById('modulStatusContent');
            if(!el) return;
            var h = '';
            var allModules = getAllModulesFlat();
            var counts = {live:0, teilweise:0, demo:0, stub:0};
            allModules.forEach(function(m){ counts[m.status] = (counts[m.status]||0)+1; });

            var sumEl = document.getElementById('modulStatusSummary');
            if(sumEl) {
                sumEl.innerHTML = '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold">ðŸŸ¢ '+counts.live+' Live</span>'
                    +'<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">ðŸŸ¡ '+counts.teilweise+' Teilw.</span>'
                    +'<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-semibold">ðŸŸ  '+counts.demo+' Demo</span>'
                    +'<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-semibold">ðŸ”´ '+counts.stub+' Stub</span>';
            }

            // === KI PRIO ===
            if(currentModulFilter === 'kiPrio') {
                var sorted = allModules.slice().sort(function(a,b){ return (a.kiPrio||99) - (b.kiPrio||99); });
                h += '<div class="vit-card p-6 mb-6">';
                h += '<div class="mb-4"><h2 class="text-lg font-bold text-gray-800">ðŸ¤– KI-Empfehlung: Umsetzungs-Reihenfolge</h2>';
                h += '<p class="text-xs text-gray-500 mt-1">Sortiert nach Business-Impact Ã— Machbarkeit Ã— AbhÃ¤ngigkeiten. Fokus: Maximaler Partner-Mehrwert bei realistischem Aufwand.</p></div>';
                h += '<div class="grid grid-cols-5 gap-3 mb-6">';
                for(var i=0; i<5 && i<sorted.length; i++) {
                    var m = sorted[i];
                    h += '<div class="p-3 rounded-lg border-2 '+(i===0?'border-vit-orange bg-orange-50':'border-gray-200 bg-white')+'">';
                    h += '<p class="text-[10px] text-gray-400 font-bold">#'+(i+1)+'</p>';
                    h += '<p class="text-sm font-bold text-gray-800 leading-tight">'+m.name+'</p>';
                    h += '<div class="mt-2 flex flex-wrap gap-1">'+getStatusBadge(m.status)+' '+getAufwandBadge(m.aufwand||'M')+'</div>';
                    h += '</div>';
                }
                h += '</div>';
                h += renderPrioTable(sorted, false);
                h += '</div>';
                el.innerHTML = h;
                return;
            }

            // === HQ PRIO ===
            if(currentModulFilter === 'hqPrio') {
                loadHqPrio();
                var kiSorted = allModules.slice().sort(function(a,b){ return (a.kiPrio||99) - (b.kiPrio||99); });
                if(!hqPrioOrder) {
                    hqPrioOrder = kiSorted.map(function(m){ return {name:m.name, typ:m.typ||'standort'}; });
                    saveHqPrio();
                }
                var resolved = [];
                hqPrioOrder.forEach(function(ref) {
                    var found = allModules.find(function(m){ return m.name === ref.name; });
                    if(found) resolved.push(found);
                });
                allModules.forEach(function(m) {
                    if(!resolved.find(function(r){ return r.name === m.name; })) resolved.push(m);
                });
                hqPrioOrder = resolved.map(function(m){ return {name:m.name, typ:m.typ||'standort'}; });

                h += '<div class="vit-card p-6 mb-6">';
                h += '<div class="flex items-center justify-between mb-4">';
                h += '<div><h2 class="text-lg font-bold text-gray-800">ðŸ¢ HQ-PrioritÃ¤t: Eigene Reihenfolge</h2>';
                h += '<p class="text-xs text-gray-500 mt-1">Per Drag & Drop oder â–²â–¼ Pfeile sortieren. Wird automatisch im Browser gespeichert.</p></div>';
                h += '<div class="flex items-center space-x-2">';
                h += '<span class="text-[10px] text-green-600 font-semibold bg-green-50 px-2 py-1 rounded-full">âœ“ Auto-gespeichert</span>';
                h += '<button onclick="resetHqPrio()" class="text-xs px-3 py-1.5 bg-gray-100 hover:bg-red-100 text-gray-600 hover:text-red-600 rounded-full font-semibold transition-colors">â†º Auf KI-Empfehlung zurÃ¼cksetzen</button>';
                h += '</div></div>';
                h += renderPrioTable(resolved, true);
                h += '</div>';
                el.innerHTML = h;
                return;
            }

            // === STANDARD VIEWS ===
            function renderSection(title, items, icon) {
                var s = '<div class="vit-card p-6 mb-6">';
                s += '<h2 class="text-lg font-bold text-gray-800 mb-4">'+icon+' '+title+' <span class="text-sm font-normal text-gray-400">('+items.length+' Module)</span></h2>';
                s += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                s += '<thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-3 font-semibold text-gray-600">Modul</th><th class="text-left py-2 px-3 font-semibold text-gray-600 w-28">Status</th><th class="text-left py-2 px-3 font-semibold text-gray-600">Details</th></tr></thead><tbody>';
                items.forEach(function(m) {
                    var rowCls = m.status==='stub' ? 'bg-red-50/30' : (m.status==='demo' ? 'bg-orange-50/30' : '');
                    s += '<tr class="border-b border-gray-100 hover:bg-gray-50 '+rowCls+'">';
                    s += '<td class="py-2.5 px-3 font-semibold text-gray-800">';
                    if(m.view) s += '<button onclick="showView(\''+m.view.replace('View','')+'\')" class="hover:text-vit-orange transition-colors text-left">'+m.name+'</button>';
                    else s += m.name;
                    s += '</td>';
                    s += '<td class="py-2.5 px-3">'+getStatusBadge(m.status)+'</td>';
                    s += '<td class="py-2.5 px-3 text-gray-500 text-xs">'+m.details+'</td>';
                    s += '</tr>';
                });
                s += '</tbody></table></div>';
                s += '</div>';
                return s;
            }

            if(currentModulFilter === 'alle' || currentModulFilter === 'standort') h += renderSection('Standort-Module (Partner-Sicht)', MODUL_DATEN.standort, 'ðŸª');
            if(currentModulFilter === 'alle' || currentModulFilter === 'hq') h += renderSection('HQ-Module (Hauptquartier)', MODUL_DATEN.hq, 'ðŸ¢');
            if(currentModulFilter === 'alle' || currentModulFilter === 'widgets') h += renderSection('Dashboard-Widgets (Startseite)', MODUL_DATEN.widgets, 'ðŸ“Š');

            if(currentModulFilter === 'alle') {
                var total = allModules.length;
                var pL = Math.round(counts.live/total*100), pT = Math.round(counts.teilweise/total*100), pD = Math.round(counts.demo/total*100), pS = Math.round(counts.stub/total*100);
                h += '<div class="vit-card p-6"><h2 class="text-lg font-bold text-gray-800 mb-4">ðŸ“ˆ Gesamtfortschritt</h2>';
                h += '<div class="w-full bg-gray-200 rounded-full h-6 flex overflow-hidden mb-3">';
                h += '<div class="bg-green-500 h-6 flex items-center justify-center text-white text-xs font-bold" style="width:'+pL+'%">'+counts.live+'</div>';
                h += '<div class="bg-yellow-400 h-6 flex items-center justify-center text-white text-xs font-bold" style="width:'+pT+'%">'+counts.teilweise+'</div>';
                h += '<div class="bg-orange-400 h-6 flex items-center justify-center text-white text-xs font-bold" style="width:'+pD+'%">'+counts.demo+'</div>';
                h += '<div class="bg-red-400 h-6 flex items-center justify-center text-white text-xs font-bold" style="width:'+pS+'%">'+counts.stub+'</div>';
                h += '</div><div class="grid grid-cols-4 gap-4 text-center">';
                h += '<div><p class="text-2xl font-bold text-green-600">'+counts.live+'</p><p class="text-xs text-gray-500">Live</p></div>';
                h += '<div><p class="text-2xl font-bold text-yellow-600">'+counts.teilweise+'</p><p class="text-xs text-gray-500">Teilweise</p></div>';
                h += '<div><p class="text-2xl font-bold text-orange-600">'+counts.demo+'</p><p class="text-xs text-gray-500">Demo/UI</p></div>';
                h += '<div><p class="text-2xl font-bold text-red-600">'+counts.stub+'</p><p class="text-xs text-gray-500">Stub</p></div>';
                h += '</div></div>';
            }
            el.innerHTML = h;
        }


        // Init: show partner mode by default
        switchViewMode('partner_grafrath');

        // === SOCIAL MEDIA LOCAL HERO ===
        var smThemen = [
            {id:'c001',thema:'Eure Kundenstories',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas hat euch am meisten ueberrascht nach dem Kauf?"','â€žUnser Kunde faehrt jetzt jeden Tag mit dem Rad zur Arbeit â€“ und hat uns das geschrieben:"'],
                hauptteil:'Kunden vor oder im Laden nach ihrer Erfahrung fragen. Was hat sich veraendert, seit sie das Rad haben? Wie fuehlt sich der Alltag an? Einfach authentisch erzaehlen lassen.',
                cta:'Komm vorbei und werde Teil der vit:bikes Community. Wir freuen uns auf deine Geschichte!',
                hqTipp:'Kurzes, ehrliches Statement vom Kunden ist Gold wert. Handy aufs Stativ, Kunde davor â€“ 30 Sekunden reichen.'
            },
            {id:'c002',thema:'Vario-Sattelstuetze: Lifehack fuer die Ampel',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:'https://www.instagram.com/reel/example_c002/',
                hook:['â€žDu stehst an der Ampel und kommst kaum vom Sattel?"','â€žDieser eine Hebel veraendert alles beim Stadtradeln."'],
                hauptteil:'Zeige die Vario-Sattelstuetze in Aktion: Hebel druecken, Sattel runter, bequem stehen. Erklaere kurz: Nicht nur fuers Gelaende, auch in der Stadt mega praktisch. Verschiedene Modelle erwaehnen.',
                cta:'Vario-Sattelstuetze nachruestbar â€“ komm vorbei, wir zeigen dir welche an dein Rad passt.',
                hqTipp:'Am besten direkt vor dem Laden an der Strasse drehen. Reale Ampel-Situation wirkt authentisch.'
            },
            {id:'c003',thema:'Erzaehl was Schoenes! Positive Kundenerfahrung',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas war euer schoenster Moment mit einem Kunden?"','â€žManchmal passieren im Laden Dinge, die kann man nicht planen."'],
                hauptteil:'Erzaehle eine persoenliche, positive Erfahrung mit einem Kunden. Was hat dich beruehrt, ueberrascht, gluecklich gemacht? Authentisch und emotional.',
                cta:'Bei uns geht es nicht nur ums Rad â€“ sondern um euch. Kommt vorbei!',
                hqTipp:'Kamera auf Stativ, direkt in die Kamera sprechen. Persoenlich und ehrlich â€“ das kommt am besten an.'
            },
            {id:'c008',thema:'Warum das Systemgewicht beim Radfahren zaehlt',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žAlle reden ueber Radgewicht â€“ aber was wirklich zaehlt, ist das Systemgewicht."','â€ž15 kg Rad oder 18 kg? Warum der Unterschied kleiner ist als du denkst."'],
                hauptteil:'Erklaere Systemgewicht = Fahrer + Gepaeck + Rad. Zeige: 3 kg Unterschied am Rad machen bei 100 kg Systemgewicht nur 3% aus. Viel wichtiger: Ergonomie, Komfort, Antrieb. Beim E-Bike relativiert der Motor das Gewicht zusaetzlich.',
                cta:'Wir beraten dich ganzheitlich â€“ nicht nur nach Gewicht. Komm zur Probefahrt!',
                hqTipp:'Mit einer Waage im Laden visualisieren. Rad draufstellen, dann Rucksack dazu â€“ der Aha-Effekt kommt von selbst.'
            },
            {id:'c015',thema:'Unsere Bedarfsanalyse',kat:'Beratung',schwierig:'leicht',done:true,
                beispiel:null,
                hook:['â€žBevor wir dir ein Rad zeigen, stellen wir erstmal Fragen."','â€žDie wichtigste Phase beim Radkauf? Bevor du ueberhaupt aufsteigst."'],
                hauptteil:'Zeige den Beratungsbogen, erklaere die Fragen: Wie oft faehrst du? Welche Strecken? Welcher Untergrund? Koerpergroesse? Beschwerden? Zeige wie du mit dem Kunden zusammen die Beduerfnisse herausarbeitest.',
                cta:'Individuelle Beratung statt Massenware. Vereinbare deinen Beratungstermin!',
                hqTipp:'Beratungssituation nachstellen mit Kollege als Kunde. Natuerlich und locker.'
            },
            {id:'c018',thema:'Aufgeschobener Service wird teuer',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDiesen Fehler machen 80% aller Radfahrer."','â€žKleine Wartung jetzt oder grosse Reparatur spaeter â€“ du hast die Wahl."'],
                hauptteil:'Zeige Beispiele: Verschlissene Kette zerstoert Ritzel (30â‚¬ vs. 150â‚¬). Abgefahrene Bremsbelaege beschaedigen Scheibe. Platter Reifen durch kaputten Mantel. Immer die guenstige Wartung vs. die teure Folge-Reparatur gegenueberstellen.',
                cta:'Mach einen Termin zur Inspektion â€“ bevor es teuer wird. Link in Bio!',
                hqTipp:'Verschleissteile nebeneinander legen: alt vs. neu. Der visuelle Vergleich wirkt sofort.'
            },
            {id:'c019',thema:'Wie eine Vermessung bei uns ablaeuft',kat:'Beratung',schwierig:'mittel',done:true,
                beispiel:null,
                hook:['â€žIn 15 Minuten weisst du mehr ueber deinen Koerper als in 15 Jahren Radfahren."','â€žRadfahren tut weh? Dann stimmt die Vermessung nicht."'],
                hauptteil:'Zeige den Ablauf Schritt fuer Schritt: Beinlaenge messen, Sitzknochenvermessung, Oberkoerper-Flexibilitaet, Ergebnis erklaeren, Rad einstellen. Zeige die Messgeraete und was sie aussagen.',
                cta:'Deine persoenliche Vermessung wartet. Buch deinen Termin â€“ kostenlos beim Neukauf!',
                hqTipp:'Am besten eine echte Vermessung mitfilmen (mit Einverstaendnis des Kunden natuerlich).'
            },
            {id:'c021',thema:'Entspannt bergauf fahren',kat:'Tipps',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žBergauf fahren und dabei laecheln? Geht!"','â€žDie meisten schalten zu spaet â€“ deswegen wird es anstrengend."'],
                hauptteil:'Tipps: Frueh genug runterschalten, gleichmaessige Trittfrequenz 70-80, Oberkoerper locker, Gewicht nach vorne. Beim E-Bike: Richtige Unterstuetzungsstufe waehlen, nicht im hoechsten Modus dauerhaft fahren.',
                cta:'Komm zur Probefahrt und erlebe wie entspannt E-Biken bergauf sein kann!',
                hqTipp:'Am besten draussen an einem kleinen Huegel drehen. Vorher-Nachher mit richtigem vs. falschem Gang.'
            },
            {id:'C024',thema:'Vorstellung vit:Fahrspassgarantie',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWann faehrt man gerne Fahrrad?"','â€žWenn alles passt."'],
                hauptteil:'Beim Neuradkauf gibt es unsere Fahrspassgarantie kostenlos dazu: 3D-Vermessung, Rad perfekt eingestellt, 4 Wochen Rueckgaberecht. Werkstatt max. 48 Stunden â€“ sonst Leihrad. Kleine Nachjustierungen 3 Monate gratis. Zubehoer montieren wir auch spaeter kostenlos.',
                cta:'Am Ende gehts nur darum: Dass Radfahren Spass macht. Komm vorbei!',
                hqTipp:'Elementarer USP! Jeder Standort sollte das drehen. Einfach die 5 Punkte durchgehen, laechelnd.'
            },
            {id:'c022',thema:'Akku im Winter richtig nutzen',kat:'Technik',schwierig:'mittel',done:true,
                beispiel:null,
                hook:['â€žDein E-Bike-Akku leidet im Winter â€“ wenn du diesen Fehler machst."','â€žWeniger Reichweite bei Kaelte? So holst du das Maximum raus."'],
                hauptteil:'Akku bei Zimmertemperatur lagern und erst kurz vor Fahrt einsetzen. Nicht unter 0Â°C laden. Eco-Modus nutzt bei Kaelte mehr als Turbo. Akku nie komplett leer fahren im Winter. Kontakte sauber halten.',
                cta:'Fragen zum Akku? Komm vorbei oder ruf an â€“ wir helfen gerne!',
                hqTipp:'Kann man gut im Laden drehen mit Akku in der Hand. Thermometer daneben stellen als Effekt.'
            },
            {id:'c025',thema:'Sicher anfahren im Winter',kat:'Tipps',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDer gefaehrlichste Moment im Winter? Die ersten 3 Meter."','â€žSo faehrst du sicher los wenn es glatt ist."'],
                hauptteil:'Niedrige Unterstuetzungsstufe beim Anfahren. Sanft in die Pedale, nicht ruckartig. Sattel etwas tiefer fuer bessere Standsicherheit. Reifendruck leicht reduzieren fuer mehr Grip. Immer beide Bremsen gleichmaessig.',
                cta:'Komm zum Winter-Check â€“ wir pruefen Bremsen, Reifen und Licht!',
                hqTipp:'Draussen bei echtem Winterwetter drehen â€“ Authentizitaet schlaegt Studioluft.'
            },
            {id:'c027',thema:'Einfach Bremsbelaege selber tauschen',kat:'Werkstatt',schwierig:'mittel',done:false,
                beispiel:'https://www.instagram.com/reel/DTKkhQjjVoT/',
                hook:['â€žBremsbelaege wechseln ist kein Hexenwerk â€“ wenn man einen wichtigen Schritt kennt."','â€žViele scheitern beim Bremsbelagwechsel an einem Detail: den Bremskolben."'],
                hauptteil:'Bremsbelaege sind Verschleissteile. Abgefahren = schlechtere Bremsleistung. Neue sind dicker, Kolben stehen weiter draussen â†’ muessen zurueckgedrueckt werden. Ablauf: Rad sicher abstellen, Vorderrad ausbauen, alte Belaege raus, Kolben vorsichtig zurueckdruecken (Kunststoff-Montierhebel), neue Belaege rein, Sicherung montieren, Vorderrad einsetzen, Bremse mehrfach ziehen.',
                cta:'Bei Unsicherheit lieber kurz stoppen und bei uns vorbeikommen. Bremsen sind sicherheitsrelevant!',
                hqTipp:'Super einfaches und erfolgreiches Video mit viel Mehrwert. Das kann jeder aus der Werkstatt nachmachen! ðŸ’ª'
            },
            {id:'c028',thema:'Schwalbe Click Valve Ventil',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žReifen aufpumpen nervt? Dieses Ventil aendert alles."','â€žKlick â€“ und die Pumpe sitzt perfekt. Kein Fummelei mehr."'],
                hauptteil:'Zeige das Click-Valve in Aktion: Aufstecken, Klick, pumpen, fertig. Vergleiche mit herkoemmlichem Ventil (Fummelei, Luft entweicht). Erwaehne: Kompatibel mit allen Schwalbe-Schlaeuchen, einfach nachzuruesten.',
                cta:'Click Valve nachruessten? Haben wir da â€“ komm vorbei oder bestell im Shop!',
                hqTipp:'Kurzes Vergleichsvideo: Alt vs. Neu. Der Unterschied verkauft sich von selbst.'
            },
            {id:'c033',thema:'Warum die richtige Rahmengroesse entscheidend ist',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDas falsche Rad in der richtigen Groesse ist besser als das richtige Rad in der falschen."','â€žKnieschmerzen, Rueckenschmerzen, Nackenschmerzen â€“ eine Ursache."'],
                hauptteil:'Zeige zwei gleiche Raeder in verschiedenen Groessen. Erklaere was passiert bei zu gross (Ueberstreckung, Nacken) und zu klein (Knie, Ruecken). Zeige wie ihr die richtige Groesse ermittelt (nicht nur nach Koerpergroesse!).',
                cta:'Sichere Groessenberatung bei uns â€“ kostenlos und unverbindlich.',
                hqTipp:'Am besten mit zwei Raedern nebeneinander und einer Person die beide testet.'
            },
            {id:'c038',thema:'Das ist mein Lieblingsprodukt',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWenn ich nur ein Produkt aus dem Laden mitnehmen duerfte..."','â€žJeder im Team hat einen Favoriten â€“ das ist meiner:"'],
                hauptteil:'Zeig dein persoenliches Lieblingsprodukt (muss kein Rad sein â€“ kann Helm, Schloss, Licht, Tasche sein). Erklaere WARUM es dein Favorit ist. Was macht es besonders? Persoenliche Geschichte dazu.',
                cta:'Was ist dein Must-Have? Komm vorbei und lass dich inspirieren!',
                hqTipp:'Super einfach zu drehen, sehr persoenlich. Ideal fuer Mitarbeiter die zum ersten Mal vor der Kamera stehen.'
            },
            {id:'c060',thema:'So vielseitig ist das vit:bikes Sortiment',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žVon Stadtrad bis Mountainbike â€“ alles unter einem Dach."','â€žWir haben nicht nur E-Bikes. Lass mich dir zeigen was noch geht."'],
                hauptteil:'Schneller Walk-Through durch den Laden. Zeige verschiedene Kategorien: City, Trekking, E-MTB, Cargo, Kinder. Betone die Markenvielfalt und dass fuer jeden was dabei ist.',
                cta:'Egal was du suchst â€“ bei uns findest du es. Oder wir bestellen es fuer dich!',
                hqTipp:'Dynamisch durch den Laden laufen, Kamera auf Gimbal oder einfach in der Hand. Schnelle Schnitte machen wir.'
            },
            {id:'c061',thema:'Knacken am Tretlager â€“ was steckt dahinter?',kat:'Werkstatt',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDein Rad knackt beim Treten? Das kann 5 verschiedene Ursachen haben."','â€žKnackgeraeuesche sind nervig â€“ aber meistens einfach zu beheben."'],
                hauptteil:'Haeufigste Ursachen: Lose Pedalgewinde, Tretlager nachziehen, Sattelklemme, Kettenblattschrauben, Schnellspanner. Zeige wie man systematisch die Ursache eingrenz. Einfache Loesungen vs. wann zum Profi.',
                cta:'Knacken nervt â€“ wir finden die Ursache. Termin vereinbaren!',
                hqTipp:'In der Werkstatt drehen, dabei die verschiedenen Stellen am Rad zeigen und abklopfen.'
            },
            {id:'c063',thema:'Software-Update â€“ wie fuehlt sich das an?',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDein E-Bike bekommt Updates wie dein Handy."','â€žNach dem Update fuehlt sich mein Rad an wie neu â€“ kein Witz."'],
                hauptteil:'Zeige den Update-Prozess: Rad anschliessen, Software pruefen, Update starten. Erklaere was sich aendert: Neue Fahrmodi, bessere Motorsteuerung, Fehlerbehebung. Vergleiche vorher/nachher wenn moeglich.',
                cta:'Kostenloses Software-Update bei uns â€“ einfach Termin machen!',
                hqTipp:'Am besten den Bildschirm zeigen waehrend das Update laeuft. Vorher/Nachher Fahreindruck waere top.'
            },
            {id:'c064',thema:'Der Aha-Moment bei der Probefahrt',kat:'Beratung',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDieser eine Moment auf der Probefahrt â€“ danach will jeder ein E-Bike."','â€žIch sehe es jedes Mal: Dieses Grinsen nach den ersten 50 Metern."'],
                hauptteil:'Beschreibe den typischen Ablauf: Kunde steigt auf, erste Pedalumdrehung, Motor schiebt an, das Laecheln kommt. Erklaere warum die Probefahrt so wichtig ist â€“ Zahlen und Daten ersetzen nicht das Gefuehl.',
                cta:'Erleb es selbst â€“ kostenlose Probefahrt jederzeit bei uns!',
                hqTipp:'Ideal: Filmst den Kunden (mit Erlaubnis!) beim ersten Moment auf dem E-Bike. Das Laecheln sagt alles.'
            },
            {id:'c065',thema:'Bremsen-Check in der Werkstatt',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWann hast du zuletzt deine Bremsen checken lassen?"','â€ž2 Minuten Check â€“ koennen Leben retten."'],
                hauptteil:'Zeige den schnellen Bremsen-Check: Belagstaerke pruefen, Scheibe auf Verschleiss kontrollieren, BremsflÃ¼ssigkeit checken, Zugseil spannen. Was sind Warnzeichen? Quietschen, langer Bremsweg, Hebel geht bis zum Lenker.',
                cta:'Bremsen-Check bei uns â€“ schnell, gruendlich, fuer deine Sicherheit.',
                hqTipp:'Werkstatt-Setting, Nahaufnahme der Bremsbelaege. Vergleich: Neu vs. Verschlissen.'
            },
            {id:'c068',thema:'Warum wir Kunden auch mal vom Kauf abraten',kat:'USP',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žJa, manchmal sagen wir: Kauf das Rad nicht."','â€žEin guter Berater verkaeuft dir nicht das teuerste â€“ sondern das richtige."'],
                hauptteil:'Erklaere wann ihr abratet: Rad passt nicht zur Nutzung, Kunde braucht eigentlich eine andere Kategorie, Budget stimmt nicht (lieber gut gebraucht als schlecht neu). Das schafft Vertrauen und kommt langfristig zurueck.',
                cta:'Ehrliche Beratung statt Verkaufsdruck. Das ist vit:bikes.',
                hqTipp:'Sehr starkes Thema fuer Vertrauensaufbau. Persoenlich in die Kamera, ruhig und ehrlich.'
            },
            {id:'c069',thema:'Akku richtig laden: die 5 groessten Fehler',kat:'Technik',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDu laedt deinen E-Bike-Akku falsch â€“ und merkst es nicht."','â€ž5 Fehler die deinen Akku schneller altern lassen."'],
                hauptteil:'Fehler: 1) Immer auf 100% laden (besser 80%). 2) Komplett leer fahren. 3) Bei Hitze/Kaelte laden. 4) Billig-Ladegeraet nutzen. 5) Akku monatelang voll/leer lagern. Zu jedem Fehler die Loesung.',
                cta:'Fragen zum Akku? Wir beraten dich gerne â€“ auch nach dem Kauf!',
                hqTipp:'5 Punkte = 5 kurze Cuts. Kann man gut nummeriert darstellen (Finger zeigen oder Zahlen einblenden).'
            },
            {id:'c073',thema:'So laeuft ein professioneller Werkstatt-Check ab',kat:'Werkstatt',schwierig:'leicht',done:true,
                beispiel:null,
                hook:['â€ž30 Punkte in 45 Minuten â€“ so gruendlich ist unser Check."','â€žDein Rad bekommt bei uns die volle Behandlung."'],
                hauptteil:'Zeige die einzelnen Pruefpunkte: Bremsen, Schaltung, Reifendruck, Speichenspannung, Tretlager, Steuersatz, Beleuchtung, Akku-Check (E-Bike). Erklaere was geprueft wird und warum.',
                cta:'Dein Rad verdient den besten Service. Termin zur Inspektion jetzt buchen!',
                hqTipp:'Top-Content! Einmal die Werkstatt-Arbeit filmen, verschiedene Stationen zeigen.'
            },
            {id:'c074',thema:'Danke zu 10.000 Follower',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€ž10.000! Danke an jeden einzelnen von euch."','â€žWas als kleiner Kanal angefangen hat..."'],
                hauptteil:'Persoenliches Danke-Video. Rueckblick: Wie alles angefangen hat, Lieblingsmomente, Community-Highlights. Was kommt als naechstes?',
                cta:'Feiert mit uns â€“ kommt im Laden vorbei, es gibt eine kleine Ueberraschung!',
                hqTipp:'Meilenstein-Videos performen super. Team zusammen vor die Kamera, Konfetti optional ðŸŽ‰'
            },
            {id:'c080',thema:'Leasing vs. Kauf â€“ was ist besser?',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žJobRad, Bikeleasing, oder doch bar zahlen?"','â€žSo viel sparst du wirklich beim Leasing â€“ Klartext."'],
                hauptteil:'Vergleiche: Steuerersparnis beim Leasing (bis 40%), dafuer gebunden. Barkauf: Sofort deins, verhandelbar. Finanzierung: Flexibel, aber Zinsen. Fuer wen lohnt sich was? Rechenbeispiel mit konkreten Zahlen.',
                cta:'Wir rechnen es mit dir durch â€“ kostenlos und unverbindlich. Komm vorbei!',
                hqTipp:'Mit Taschenrechner oder Whiteboard. Zahlen sichtbar machen ueberzeugt.'
            },
            {id:'c081',thema:'Rueckenschmerzen auf dem E-Bike',kat:'Ergonomie',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žRueckenschmerzen nach jeder Fahrt? Das muss nicht sein."','â€ž3 Einstellungen die deinen Ruecken sofort entlasten."'],
                hauptteil:'Haeufigste Ursachen: Sattel zu niedrig/hoch, Lenker zu weit weg, falsche Rahmengroesse. Schnelle Fixes: Sattelhoehe anpassen, Vorbau kuerzer/hoeher, ergonomische Griffe. Wann professionelle Vermessung noetig.',
                cta:'Schmerzfrei Radfahren ist moeglich. Komm zur Ergonomie-Beratung!',
                hqTipp:'Person zeigt falsche vs. richtige Sitzposition. Der Unterschied ist sofort sichtbar.'
            },
            {id:'c085',thema:'Probefahren reicht nicht',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDu warst Probefahren und denkst: Passt? Vielleicht nicht."','â€žWarum 10 Minuten Probefahrt nicht reichen fuer die richtige Entscheidung."'],
                hauptteil:'Probefahrt gibt ersten Eindruck, aber: Sitzposition zeigt Probleme erst nach 30+ Minuten. Deshalb machen wir vorab Vermessung. Rueckgaberecht nach 4 Wochen als Sicherheitsnetz. Erst im Alltag zeigt sich ob das Rad passt.',
                cta:'Bei uns hast du 4 Wochen zum Testen. Fahrspassgarantie inklusive!',
                hqTipp:'Starkes USP-Video. Kurz und knackig die Fahrspassgarantie erwaehnen.'
            },
            {id:'c088',thema:'Erklaere die MyO-Konfiguration von Orbea',kat:'Technik',schwierig:'schwer',done:false,
                beispiel:null,
                hook:['â€žDein Rad, deine Farbe, deine Ausstattung â€“ so geht Individualisierung."','â€žOrbea MyO: Wie du dein Traumrad selbst zusammenstellst."'],
                hauptteil:'Zeige den MyO-Konfigurator am Bildschirm oder Tablet. Schritt fuer Schritt: Modell waehlen, Farbe anpassen, Komponenten auswaehlen. Lieferzeit erwaehnen. Vorteil: Einzigartiges Rad, kein Aufpreis fuer Farbwahl.',
                cta:'Lust auf dein individuelles Orbea? Wir konfigurieren es gemeinsam mit dir!',
                hqTipp:'Bildschirmaufnahme vom Konfigurator + Reaktion des Beraters. Oder Kunde konfiguriert live.'
            },
            {id:'c089',thema:'Die Raduebergabe bei vit:bikes',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDie Uebergabe ist der schoenste Moment â€“ fuer uns und fuer euch."','â€žDein neues Rad wartet. So uebergeben wir es dir."'],
                hauptteil:'Zeige den Ablauf: Rad nochmal komplett gecheckt, alles eingestellt, Funktionen erklaert (E-Bike: Display, Modi, Akku). Erste gemeinsame Runde. Fotos fuer Social Media (mit Erlaubnis). Serviceplan erklaeren.',
                cta:'Bald ist dein Rad dran. Wir freuen uns darauf!',
                hqTipp:'Die strahlenden Gesichter bei der Uebergabe sind unbezahlbar. Authentische Freude filmen.'
            },
            {id:'c091',thema:'Sitzknochenvermessung',kat:'Ergonomie',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDein Po schmerzt beim Radfahren? Dein Sattel ist nicht schuld â€“ du sitzt falsch."','â€žDie wichtigste Zahl beim Sattelkauf: Dein Sitzknochenabstand."'],
                hauptteil:'Erklaere: Jeder hat andere Sitzknochen. Breite messen (Gel-Pad oder Wellpappe). Richtige Sattelbreite ableiten. Zeige verschiedene Saettel fuer verschiedene Breiten. Sitzposition sportlich vs. aufrecht macht auch einen Unterschied.',
                cta:'Kostenlose Sitzknochenvermessung bei uns â€“ in 5 Minuten zum perfekten Sattel!',
                hqTipp:'Vermessungs-Prozess filmen. Der Moment wenn der Kunde die Zahl erfaehrt ist immer spannend.'
            },
            {id:'c095',thema:'Kette reinigen â€“ auch im Winter',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žIm Winter rostet deine Kette 3x so schnell."','â€ž5 Minuten Pflege sparen dir 80 Euro Kettenwechsel."'],
                hauptteil:'Zeige: Kette mit Kettenreiniger reinigen, trocknen lassen, frisches Kettenoel auftragen. Im Winter oefter noetig wegen Salz und Naesse. Warnung: Zu viel Oel zieht Schmutz an!',
                cta:'Kettenreiniger und -oel bei uns im Shop. Oder wir machen das fuer dich!',
                hqTipp:'Nahaufnahme der Kette: Schmutzig â†’ Sauber. Vorher/Nachher ist super Content.'
            },
            {id:'c096',thema:'Riese & Mueller Vorstellung',kat:'Technik',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žMade in Germany, und das merkt man."','â€žWarum Riese & Mueller Premium ist â€“ und es sich lohnt."'],
                hauptteil:'Markenvorstellung: Darmstadt, Handmontage, Qualitaet. Zeige 2-3 Modelle im Laden. Was macht R&M besonders? DualBattery, Vollfederung, Cargo-Loesungen. Fuer wen ideal?',
                cta:'Riese & Mueller Probefahrt bei uns â€“ erlebe den Unterschied!',
                hqTipp:'Wenn R&M im Laden steht, direkt dort filmen. Qualitaet zeigen, Details hervorheben.'
            },
            {id:'c099',thema:'Was ist das Smartphone Grip?',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDein Handy am Lenker â€“ aber sicher."','â€žNavigation, Musik, Fitness â€“ alles auf dem Rad. So befestigst du es richtig."'],
                hauptteil:'Zeige verschiedene Smartphone-Halterungen: Quad Lock, SP Connect, universelle Loesungen. Vor- und Nachteile. Wichtig: Vibrationen koennen Kamera beschaedigen! Anti-Vibrations-Modul erwaehnen.',
                cta:'Smartphone-Halterung nachruestbar â€“ wir beraten dich welche passt!',
                hqTipp:'Zeige die Montage und das Einrasten des Handys. Der Klick-Moment ist befriedigend.'
            },
            {id:'c101',thema:'Helmberatung',kat:'Beratung',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDer beste Helm ist der, den du auch wirklich aufsetzt."','â€ž95% tragen ihren Helm falsch. Gehoerst du dazu?"'],
                hauptteil:'Richtigen Sitz zeigen: 2 Finger ueber Augenbrauen, Riemen bilden V unter den Ohren, ein Finger zwischen Kinn und Riemen. Verschiedene Typen: City, MTB, Speed-Pedelec. MIPS erklaeren. Wann Helm tauschen (nach Sturz, nach 5 Jahren).',
                cta:'Helmberatung bei uns â€“ finde den perfekten Helm fuer dich.',
                hqTipp:'Helm falsch aufsetzen, dann richtig. Der Unterschied ist deutlich und lehrreich.'
            },
            {id:'c103',thema:'Was faehrt vit:bikes? Team stellt ihre Raeder vor',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas fahren eigentlich die, die den ganzen Tag Raeder verkaufen?"','â€žUnser Team zeigt: Das sind unsere persoenlichen Raeder."'],
                hauptteil:'Jedes Teammitglied stellt kurz sein eigenes Rad vor: Was ist es, warum genau das, was ist das Besondere daran? Persoenlich und authentisch.',
                cta:'Welches Rad passt zu dir? Wir helfen dir â€“ aus eigener Erfahrung!',
                hqTipp:'Jeder Mitarbeiter 15-20 Sekunden mit seinem Rad. Zusammenschneiden wir. Super Team-Content!'
            }
        ];

        var smRankingData = [
            {name:'Pfaffenhofen',count:7},{name:'Witten',count:6},{name:'Berlin',count:6},
            {name:'Weilheim',count:4},{name:'Grafrath',count:4},{name:'Wachtendonk',count:3},
            {name:'Teisendorf',count:1},{name:'Warendorf',count:1},{name:'Muenster',count:1},{name:'Lohmar',count:1},
            {name:'Karlsdorf',count:0},{name:'Garching',count:0},{name:'Reutlingen',count:0},
            {name:'Holzkirchen',count:0},{name:'Hann. Muenden',count:0},{name:'Zell',count:0},
            {name:'Wesel',count:0},{name:'Rottweil',count:0},{name:'Hamburg',count:0},
            {name:'M-Thalkirchen',count:0},{name:'Muenchen BAL',count:0}
        ];

        // === I18N TRANSLATION SYSTEM ===

        // === NOTIFICATIONS DATA & LOGIC ===
        var notifications = [
            {id:1,type:'hq',icon:'ðŸ“¢',title:'Neue Kampagne: Fruehjahrs-Aktion 2026',desc:'Das HQ hat eine neue Kampagne gestartet. Materialien stehen bereit.',time:'vor 15 Min.',read:false,action:'showView(\'marketing\')'},
            {id:2,type:'system',icon:'âš ï¸',title:'Ticket #1042 eskaliert',desc:'Kunde Huber wartet seit 5 Tagen auf Rueckmeldung.',time:'vor 1 Std.',read:false,action:'showView(\'support\')'},
            {id:3,type:'hq',icon:'ðŸŽ¬',title:'Neues Content-Thema verfuegbar',desc:'Thema C035: "Helmberatung" wurde im Local Hero Katalog ergaenzt.',time:'vor 3 Std.',read:false,action:'showView(\'marketing\');showMarketingTab(\'social\')'},
            {id:4,type:'system',icon:'ðŸ“Š',title:'BWA Januar 2026 verfuegbar',desc:'Die BWA fuer Januar wurde hochgeladen und kann eingesehen werden.',time:'Gestern',read:true,action:'showView(\'controlling\')'},
            {id:5,type:'hq',icon:'ðŸ“‹',title:'Neue Einkaufsrichtlinie',desc:'Aktualisierte Margen-Empfehlung fuer Q1 2026 verfuegbar.',time:'Gestern',read:true,action:'showView(\'einkauf\')'},
            {id:6,type:'system',icon:'âœ…',title:'Onboarding: 70% abgeschlossen',desc:'Du hast 7 von 10 Onboarding-Schritten erledigt.',time:'vor 2 Tagen',read:true,action:'showView(\'onboarding\')'},
            {id:7,type:'hq',icon:'ðŸ†',title:'Verkaufs-Ranking: Platz 3!',desc:'Euer Standort ist im Netzwerk-Ranking auf Platz 3 geklettert.',time:'vor 3 Tagen',read:true,action:'showView(\'verkauf\')'},
            {id:8,type:'system',icon:'ðŸ””',title:'Termin morgen: Probefahrt Hr. Mueller',desc:'Morgen um 10:00 Uhr â€“ Probefahrt E-MTB geplant.',time:'vor 3 Tagen',read:true,action:'showView(\'kalender\')'}
        ];

        function filterNotif(f) {
            document.querySelectorAll('.notif-filter').forEach(function(b){b.className='notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.notif-filter[data-nf="'+f+'"]');
            if(btn)btn.className='notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderNotifications(f);
        }
        function renderNotifications(filter) {
            filter=filter||'all';
            var list=notifications.filter(function(n){
                if(filter==='unread') return !n.read;
                if(filter==='system') return n.type==='system';
                if(filter==='hq') return n.type==='hq';
                return true;
            });
            var el=document.getElementById('notifList'); if(!el)return;
            var h='';
            list.forEach(function(n){
                h+='<div class="vit-card p-4 flex items-start space-x-3 cursor-pointer hover:shadow-md transition '+(n.read?'opacity-70':'')+'" onclick="'+n.action+'">';
                h+='<span class="text-2xl flex-shrink-0">'+n.icon+'</span>';
                h+='<div class="flex-1 min-w-0">';
                h+='<div class="flex items-center space-x-2"><p class="font-semibold text-gray-800 text-sm truncate">'+n.title+'</p>';
                if(!n.read) h+='<span class="notif-dot w-2 h-2 bg-vit-orange rounded-full flex-shrink-0"></span>';
                h+='</div>';
                h+='<p class="text-xs text-gray-500 mt-0.5">'+n.desc+'</p>';
                h+='<p class="text-[10px] text-gray-400 mt-1">'+n.time+'</p>';
                h+='</div>';
                h+='<span class="text-xs px-2 py-0.5 rounded-full '+(n.type==='hq'?'bg-vit-orange text-white':'bg-gray-100 text-gray-500')+'">'+n.type.toUpperCase()+'</span>';
                h+='</div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">ðŸ””</p><p class="text-sm">Keine Benachrichtigungen</p></div>';
            el.innerHTML=h;
        }

        // === KALENDER DATA & LOGIC (DB-backed) ===
        var kalMonth = new Date().getMonth(); var kalYear = new Date().getFullYear();
        var kalTermine = [];
        var kalEditId = null; // Track which termin is being edited

        var typeColors = {beratung:'bg-blue-100 text-blue-700 border-blue-300',probefahrt:'bg-green-100 text-green-700 border-green-300',werkstatt:'bg-gray-200 text-gray-700 border-gray-300',meeting:'bg-purple-100 text-purple-700 border-purple-300',sonstig:'bg-orange-100 text-orange-700 border-orange-300',schulung:'bg-indigo-100 text-indigo-700 border-indigo-300',event:'bg-pink-100 text-pink-700 border-pink-300',deadline:'bg-red-100 text-red-700 border-red-300'};
        var typeLabels = {beratung:'Beratung',probefahrt:'Probefahrt',werkstatt:'Werkstatt',meeting:'Meeting',sonstig:'Sonstiges',schulung:'Schulung',event:'Event',deadline:'Deadline'};

        async function loadKalTermine() {
            try {
                var query = sb.from('termine').select('*').order('start_zeit', {ascending:true});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var resp = await query;
                if(!resp.error) {
                    kalTermine = (resp.data||[]).map(function(t) {
                        var d = new Date(t.start_zeit);
                        var endTime = t.end_zeit ? new Date(t.end_zeit) : null;
                        return {
                            id: t.id, title: t.titel, 
                            date: d.toISOString().slice(0,10),
                            time: t.ganztaegig ? '00:00' : String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'),
                            endTime: endTime ? String(endTime.getHours()).padStart(2,'0')+':'+String(endTime.getMinutes()).padStart(2,'0') : null,
                            type: t.typ || 'sonstig',
                            user: t.erstellt_von_name || 'all',
                            notes: t.beschreibung || '',
                            ort: t.ort || '',
                            ganztaegig: t.ganztaegig || false,
                            erstellt_von: t.erstellt_von,
                            ms365_event_id: t.ms365_event_id || null,
                            ms365_sync_status: t.ms365_sync_status || null
                        };
                    });
                } else { kalTermine = []; }
            } catch(e) { console.warn('Kalender load:', e); kalTermine = []; }
            renderKalender();
        }

        function kalNavMonth(d){kalMonth+=d;if(kalMonth>11){kalMonth=0;kalYear++;}if(kalMonth<0){kalMonth=11;kalYear--;}renderKalender();}

        function renderKalender(){
            var months=['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            document.getElementById('kalMonthTitle').textContent=months[kalMonth]+' '+kalYear;
            var userFilter=(document.getElementById('kalFilterUser')||{}).value||'all';
            var filtered=kalTermine.filter(function(t){
                if(userFilter==='me' && sbProfile) return t.erstellt_von===sbUser.id || t.user==='all';
                return true;
            });

            var firstDay=new Date(kalYear,kalMonth,1).getDay();
            firstDay=firstDay===0?6:firstDay-1;
            var daysInMonth=new Date(kalYear,kalMonth+1,0).getDate();
            var today=new Date(); var todayStr=today.toISOString().slice(0,10);
            var grid=document.getElementById('kalGrid'); var h='';

            for(var i=0;i<firstDay;i++) h+='<div class="min-h-[80px] border-b border-r border-gray-100 p-1 bg-gray-50"></div>';

            for(var d=1;d<=daysInMonth;d++){
                var dateStr=kalYear+'-'+String(kalMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                var isToday=dateStr===todayStr;
                var dayTermine=filtered.filter(function(t){return t.date===dateStr;});
                h+='<div class="min-h-[80px] border-b border-r border-gray-100 p-1 cursor-pointer hover:bg-blue-50 '+(isToday?'bg-orange-50':'')+'" onclick="openKalDayModal(\''+dateStr+'\')">';
                h+='<p class="text-xs font-bold '+(isToday?'text-vit-orange':'text-gray-600')+'">'+d+'</p>';
                dayTermine.forEach(function(t){
                    var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                    h+='<div onclick="event.stopPropagation();openTerminDetail(\''+t.id+'\')" class="mt-0.5 px-1 py-0.5 rounded text-[9px] font-semibold truncate border cursor-pointer hover:opacity-80 '+cls+'" title="'+t.time+' '+t.title+'">'+t.time.slice(0,5)+' '+t.title.slice(0,15)+'</div>';
                });
                h+='</div>';
            }
            grid.innerHTML=h;

            // Upcoming list with edit/delete buttons
            var upcoming=filtered.filter(function(t){return t.date>=todayStr;}).sort(function(a,b){return a.date>b.date?1:-1;}).slice(0,8);
            var uEl=document.getElementById('kalUpcoming'); var uh='';
            upcoming.forEach(function(t){
                var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                var dayNames=['So','Mo','Di','Mi','Do','Fr','Sa'];
                var dd=new Date(t.date); var dayName=dayNames[dd.getDay()];
                var canEdit = !sbProfile || sbProfile.is_hq || t.erstellt_von === (sbUser?sbUser.id:null);
                uh+='<div class="vit-card p-3 flex items-center space-x-3 cursor-pointer hover:shadow-md transition" onclick="openTerminDetail(\''+t.id+'\')">';
                uh+='<div class="text-center flex-shrink-0 w-12"><p class="text-xs text-gray-500">'+dayName+'</p><p class="text-lg font-bold text-gray-800">'+parseInt(t.date.slice(8))+'</p><p class="text-[10px] text-gray-400">'+t.date.slice(5,7)+'</p></div>';
                uh+='<div class="flex-1 min-w-0"><p class="font-semibold text-gray-800 text-sm truncate">'+t.title+'</p><p class="text-xs text-gray-500">'+t.time+' Uhr'+(t.endTime?' â€“ '+t.endTime+' Uhr':'')+(t.ort?' Â· '+t.ort:'')+(t.user!=='all'?' Â· '+t.user:'')+'</p></div>';
                uh+='<span class="text-[10px] px-2 py-0.5 rounded-full font-semibold '+cls+'">'+typeLabels[t.type]+'</span>';
                if(t.ms365_event_id) uh+='<span class="text-[10px] text-blue-500" title="Synced with MS365">ðŸ“…</span>';
                uh+='</div>';
            });
            uEl.innerHTML=uh||'<div class="text-center py-4 text-gray-400 text-sm">Keine anstehenden Termine.</div>';
        }

        // Open day view to quickly add termin on that date
        function openKalDayModal(dateStr) {
            kalEditId = null;
            document.getElementById('kalNewTitle').value = '';
            document.getElementById('kalNewDate').value = dateStr;
            document.getElementById('kalNewTime').value = '09:00';
            document.getElementById('kalNewEndTime').value = '10:00';
            document.getElementById('kalNewType').value = 'beratung';
            document.getElementById('kalNewNotes').value = '';
            document.getElementById('kalNewOrt').value = '';
            document.getElementById('kalNewGanztaegig').checked = false;
            document.getElementById('kalModalTitle').textContent = 'Neuen Termin anlegen';
            document.getElementById('kalSaveBtn').textContent = 'Speichern';
            var delBtn = document.getElementById('kalDeleteBtn');
            if(delBtn) delBtn.style.display = 'none';
            document.getElementById('kalNewModal').classList.remove('hidden');
        }

        // Open termin detail/edit
        function openTerminDetail(terminId) {
            var t = kalTermine.find(function(x){ return x.id == terminId; });
            if(!t) return;
            kalEditId = t.id;
            document.getElementById('kalNewTitle').value = t.title;
            document.getElementById('kalNewDate').value = t.date;
            document.getElementById('kalNewTime').value = t.time || '09:00';
            document.getElementById('kalNewEndTime').value = t.endTime || '';
            document.getElementById('kalNewType').value = t.type;
            document.getElementById('kalNewNotes').value = t.notes || '';
            document.getElementById('kalNewOrt').value = t.ort || '';
            document.getElementById('kalNewGanztaegig').checked = t.ganztaegig || false;
            document.getElementById('kalModalTitle').textContent = 'Termin bearbeiten';
            document.getElementById('kalSaveBtn').textContent = 'Aktualisieren';
            var delBtn = document.getElementById('kalDeleteBtn');
            if(delBtn) delBtn.style.display = '';
            document.getElementById('kalNewModal').classList.remove('hidden');
        }

        async function saveKalTermin(){
            var title=document.getElementById('kalNewTitle').value;
            var date=document.getElementById('kalNewDate').value;
            var time=document.getElementById('kalNewTime').value||'09:00';
            var endTime=document.getElementById('kalNewEndTime').value||null;
            var type=document.getElementById('kalNewType').value;
            var notes=document.getElementById('kalNewNotes').value;
            var ort=document.getElementById('kalNewOrt').value;
            var ganztaegig=document.getElementById('kalNewGanztaegig').checked;
            if(!title||!date){alert('Bitte Titel und Datum angeben.');return;}

            var startZeit = date+'T'+time+':00';
            var endZeit = endTime ? date+'T'+endTime+':00' : null;
            var payload = {
                titel: title, start_zeit: startZeit, end_zeit: endZeit,
                typ: type, beschreibung: notes, ort: ort, ganztaegig: ganztaegig,
                erstellt_von: sbUser ? sbUser.id : null,
                erstellt_von_name: sbProfile ? sbProfile.name : 'Unbekannt',
                standort_id: sbProfile ? sbProfile.standort_id : null
            };

            try {
                if(kalEditId) {
                    // Update existing
                    var resp = await sb.from('termine').update(payload).eq('id', kalEditId);
                    if(resp.error) throw resp.error;
                } else {
                    // Insert new
                    var resp = await sb.from('termine').insert(payload);
                    if(resp.error) throw resp.error;
                }
                document.getElementById('kalNewModal').classList.add('hidden');
                kalEditId = null;
                await loadKalTermine();
            } catch(err) { alert('Fehler: '+(err.message||err)); }
        }

        async function deleteKalTermin() {
            if(!kalEditId) return;
            if(!confirm('Termin wirklich lÃ¶schen?')) return;
            try {
                var resp = await sb.from('termine').delete().eq('id', kalEditId);
                if(resp.error) throw resp.error;
                document.getElementById('kalNewModal').classList.add('hidden');
                kalEditId = null;
                await loadKalTermine();
            } catch(err) { alert('Fehler: '+(err.message||err)); }
        }

        // === MS365 CALENDAR SYNC PREPARATION ===
        // Data model: termine table has ms365_event_id and ms365_sync_status columns
        // Sync flow: 
        //   1. User connects MS365 account (OAuth2 via Azure AD)
        //   2. On termin create/update/delete â†’ push to MS365 Graph API
        //   3. Periodic pull from MS365 â†’ merge into termine table
        //   4. Conflict resolution: last-write-wins with ms365_last_synced timestamp
        //
        // Graph API endpoints:
        //   POST   /me/events                    â†’ Create event
        //   PATCH  /me/events/{id}               â†’ Update event  
        //   DELETE /me/events/{id}               â†’ Delete event
        //   GET    /me/calendarView?startDateTime=&endDateTime= â†’ Pull events
        //
        // Required Azure AD app permissions: Calendars.ReadWrite
        //
        // Implementation: Supabase Edge Function that:
        //   1. Receives webhook from termine table changes
        //   2. Calls MS Graph API with user's OAuth token
        //   3. Stores ms365_event_id back in termine row
        //   4. Cron job for periodic bidirectional sync

        async function syncTerminToMs365(terminId) {
            // Placeholder: will be implemented via Supabase Edge Function
            var t = kalTermine.find(function(x){ return x.id == terminId; });
            if(!t) return;
            console.log('[MS365 Sync] Would sync termin:', t.title, 'to MS365');
            // Future: await sb.functions.invoke('ms365-calendar-sync', { body: { action: 'push', termin_id: terminId } });
        }

        async function pullMs365Events() {
            // Placeholder: pull events from MS365 and merge into termine table
            console.log('[MS365 Sync] Would pull events from MS365');
            // Future: var resp = await sb.functions.invoke('ms365-calendar-sync', { body: { action: 'pull' } });
        }

        // === TODO DATA & LOGIC (DB-backed) ===
        var todos = [];
        var currentTodoFilter='all';

        async function loadTodos() {
            try {
                var query = sb.from('todos').select('*').order('prio_sort', {ascending:true}).order('faellig_am', {ascending:true});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var resp = await query;
                if(!resp.error) todos = resp.data || [];
                else todos = [];
            } catch(e) { console.warn('Todos load:', e); }
            renderTodos();
        }

        function filterTodos(f){
            currentTodoFilter=f;
            document.querySelectorAll('.todo-filter').forEach(function(b){b.className='todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.todo-filter[data-tf="'+f+'"]');
            if(btn)btn.className='todo-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderTodos();
        }

        function renderTodos(){
            var today=new Date().toISOString().slice(0,10);
            var list=todos.filter(function(td){
                if(currentTodoFilter==='all') return !td.erledigt;
                if(currentTodoFilter==='heute') return !td.erledigt && td.faellig_am===today;
                if(currentTodoFilter==='ueberfaellig') return !td.erledigt && td.faellig_am && td.faellig_am<today;
                if(currentTodoFilter==='done') return td.erledigt;
                return true;
            });
            var offen=todos.filter(function(td){return !td.erledigt;}).length;
            var heute=todos.filter(function(td){return !td.erledigt && td.faellig_am===today;}).length;
            var ueber=todos.filter(function(td){return !td.erledigt && td.faellig_am && td.faellig_am<today;}).length;
            var done=todos.filter(function(td){return td.erledigt;}).length;
            var kO=document.getElementById('todoKpiOffen');if(kO)kO.textContent=offen;
            var kH=document.getElementById('todoKpiHeute');if(kH)kH.textContent=heute;
            var kU=document.getElementById('todoKpiUeber');if(kU)kU.textContent=ueber;
            var kD=document.getElementById('todoKpiDone');if(kD)kD.textContent=done;
            // Update KPI labels
            var lO=document.getElementById('todoKpiOffenLabel');if(lO)lO.textContent=t('todo_open');
            var lH=document.getElementById('todoKpiHeuteLabel');if(lH)lH.textContent=t('todo_today');
            var lU=document.getElementById('todoKpiUeberLabel');if(lU)lU.textContent=t('todo_overdue');
            var lD=document.getElementById('todoKpiDoneLabel');if(lD)lD.textContent=t('todo_done');
            var badge=document.getElementById('todoSidebarBadge');if(badge)badge.textContent=offen;

            var el=document.getElementById('todoList');if(!el)return;
            var h='';
            var prioIcons={hoch:'\uD83D\uDD34',dringend:'\uD83D\uDD34',normal:'\uD83D\uDFE1',niedrig:'\uD83D\uDFE2'};
            var katIcons={verkauf:'\uD83D\uDCB0',werkstatt:'\uD83D\uDD27',marketing:'\uD83D\uDCE3',admin:'\uD83D\uDCCB',sonstig:'\uD83D\uDCCC'};
            var katLabels={verkauf:t('cat_sales'),werkstatt:t('cat_workshop'),marketing:t('cat_marketing'),admin:t('cat_admin'),sonstig:t('cat_other')};
            var prioSort={dringend:-1,hoch:0,normal:1,niedrig:2};
            list.sort(function(a,b){return (prioSort[a.prio]||1)-(prioSort[b.prio]||1);});
            list.forEach(function(td){
                var isOver=!td.erledigt && td.faellig_am && td.faellig_am<today;
                var isSystem = td.typ === 'system' || td.referenz_typ === 'bwa_erinnerung';
                var isEscalated = td.eskalation_stufe && td.eskalation_stufe >= 2;
                var fmtDate=td.faellig_am?td.faellig_am.slice(8)+'.'+td.faellig_am.slice(5,7)+'.':'';
                var borderClass = isEscalated ? 'border-l-4 border-red-400' : (isSystem ? 'border-l-4 border-blue-300' : '');
                h+='<div class="vit-card p-3 flex items-center space-x-3 '+(td.erledigt?'opacity-50':'')+' '+borderClass+'">';
                h+='<button onclick="toggleTodo(\''+td.id+'\')" class="mt-0.5 w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 '+(td.erledigt?'border-green-500 bg-green-500 text-white':'border-gray-300 hover:border-vit-orange')+'">';
                if(td.erledigt) h+='<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>';
                h+='</button>';
                h+='<div class="flex-1 min-w-0">';
                h+='<div class="flex items-center space-x-1.5">';
                if(isSystem) h+='<span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-600 font-bold">\uD83E\uDD16 '+t('todo_system')+'</span>';
                if(isEscalated) h+='<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-100 text-red-600 font-bold">\uD83D\uDD25 '+t('prio_urgent')+'</span>';
                h+='</div>';
                h+='<p class="font-semibold text-sm '+(td.erledigt?'line-through text-gray-400':'text-gray-800')+'">'+td.titel+'</p>';
                h+='<p class="text-[10px] text-gray-500 mt-0.5">'+(katIcons[td.kategorie]||'')+' '+(katLabels[td.kategorie]||td.kategorie||'')+' \u00B7 '+t('todo_due')+': '+fmtDate+(isOver?' <span class="text-red-500 font-bold">'+t('todo_overdue')+'</span>':'')+'</p>';
                if(td.beschreibung && !td.erledigt) h+='<p class="text-[10px] text-gray-400 mt-0.5 truncate">'+td.beschreibung.substring(0,80)+'</p>';
                h+='</div>';
                h+='<span class="text-xs">'+(prioIcons[td.prio]||'')+'</span>';
                if(!isSystem) h+='<button onclick="editTodo(\''+td.id+'\')" class="text-gray-300 hover:text-blue-500 text-xs" title="'+t('todo_edit')+'">\u270F\uFE0F</button>';
                h+='<button onclick="deleteTodo(\''+td.id+'\')" class="text-gray-300 hover:text-red-500 text-xs" title="'+t('todo_delete')+'">\u2715</button>';
                h+='</div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">\u2705</p><p class="text-sm">'+t('todo_no_tasks')+'</p></div>';
            el.innerHTML=h;
        }

        async function toggleTodo(id){
            var td=todos.find(function(t){return t.id===id;});
            if(!td) return;
            td.erledigt=!td.erledigt;
            try { await sb.from('todos').update({erledigt:td.erledigt, erledigt_am:td.erledigt?new Date().toISOString():null}).eq('id',id); } catch(e){}
            renderTodos();
        }

        async function deleteTodo(id){
            try { await sb.from('todos').delete().eq('id',id); todos=todos.filter(function(t){return t.id!==id;}); } catch(e){}
            renderTodos();
        }

        function editTodo(id) {
            var td = todos.find(function(t){return t.id===id;});
            if(!td) return;
            var html = '<div id="todoEditOverlay" onclick="closeTodoEdit()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:440px;max-width:95vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Aufgabe bearbeiten</h3><button onclick="closeTodoEdit()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-4">';
            html += '<input id="todoEditTitle" type="text" value="'+td.titel.replace(/"/g,'&quot;')+'" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            html += '<div class="grid grid-cols-3 gap-2">';
            html += '<input id="todoEditDate" type="date" value="'+(td.faellig_am||'')+'" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            html += '<select id="todoEditPrio" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="hoch"'+(td.prio==='hoch'?' selected':'')+'>Hoch</option><option value="normal"'+(td.prio==='normal'?' selected':'')+'>Normal</option><option value="niedrig"'+(td.prio==='niedrig'?' selected':'')+'>Niedrig</option></select>';
            html += '<select id="todoEditKat" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="verkauf"'+(td.kategorie==='verkauf'?' selected':'')+'>Verkauf</option><option value="werkstatt"'+(td.kategorie==='werkstatt'?' selected':'')+'>Werkstatt</option><option value="marketing"'+(td.kategorie==='marketing'?' selected':'')+'>Marketing</option><option value="admin"'+(td.kategorie==='admin'?' selected':'')+'>Admin</option><option value="sonstig"'+(td.kategorie==='sonstig'?' selected':'')+'>Sonstig</option></select>';
            html += '</div></div>';
            html += '<button onclick="saveTodoEdit(\''+id+'\')" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'todoEditContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        function closeTodoEdit() { var c = document.getElementById('todoEditContainer'); if(c) c.remove(); }

        async function saveTodoEdit(id) {
            var titel = (document.getElementById('todoEditTitle')||{}).value;
            var faellig = (document.getElementById('todoEditDate')||{}).value || null;
            var prio = (document.getElementById('todoEditPrio')||{}).value || 'normal';
            var kat = (document.getElementById('todoEditKat')||{}).value || 'sonstig';
            var prioSortMap = {hoch:0,normal:1,niedrig:2};
            if(!titel||!titel.trim()) return;
            try {
                var resp = await sb.from('todos').update({titel:titel.trim(),faellig_am:faellig,prio:prio,kategorie:kat,prio_sort:prioSortMap[prio]||1}).eq('id',id);
                if(resp.error) throw resp.error;
                var td = todos.find(function(t){return t.id===id;});
                if(td) { td.titel=titel.trim(); td.faellig_am=faellig; td.prio=prio; td.kategorie=kat; td.prio_sort=prioSortMap[prio]||1; }
                closeTodoEdit();
                renderTodos();
            } catch(e) { alert('Fehler: '+e.message); }
        }

        async function addTodo(){
            var title=(document.getElementById('todoNewTitle')||{}).value;
            if(!title||!title.trim()){alert('Bitte Aufgabe eingeben.');return;}
            var faellig=(document.getElementById('todoNewDate')||{}).value||null;
            var prio=(document.getElementById('todoNewPrio')||{}).value||'normal';
            var kat=(document.getElementById('todoNewKat')||{}).value||'sonstig';
            var prioSort={hoch:0,normal:1,niedrig:2};
            try {
                var resp = await sb.from('todos').insert({
                    standort_id: sbProfile?sbProfile.standort_id:null,
                    erstellt_von: sbUser?sbUser.id:null,
                    titel: title.trim(), faellig_am: faellig, prio: prio, kategorie: kat,
                    prio_sort: prioSort[prio]||1, erledigt: false
                }).select();
                if(resp.error) throw resp.error;
                if(resp.data&&resp.data[0]) todos.unshift(resp.data[0]);
            } catch(e) { console.error('Todo add:', e); }
            document.getElementById('todoNewModal').classList.add('hidden');
            document.getElementById('todoNewTitle').value='';
            renderTodos();
        }

        // =====================================================================
        // BWA ERINNERUNGSLOGIK â€“ Automatische Deadline-Todos mit Eskalation
        // =====================================================================
        // Deadline: BWA fÃ¼r Monat X muss bis zum 15. des Folgemonats (X+1) eingereicht sein.
        // Eskalationsstufen:
        //   Stufe 0: Ab dem 1. des Folgemonats â†’ Todo â€žBWA einreichen" (prio: normal)
        //   Stufe 1: Ab dem 8. des Folgemonats â†’ Prio hochsetzen auf â€žhoch", Hinweistext
        //   Stufe 2: Ab dem 13. des Folgemonats â†’ Prio â€ždringend", Banner-Warnung
        //   Stufe 3: Nach dem 15. â†’ ÃœBERFÃ„LLIG, E-Mail-Eskalation an HQ (Platzhalter)
        // Jede Stufe: erinnerung_email_faellig = true â†’ wird von externem Cronjob/Edge Function abgeholt

        async function checkBwaDeadlines() {
            // Nur fÃ¼r Inhaber/Buchhaltung relevant, nicht fÃ¼r HQ
            var isInhaber = currentRoles.indexOf('inhaber') >= 0 || currentRoles.indexOf('buchhaltung') >= 0;
            var isHQ = sbProfile && sbProfile.is_hq;
            if(!isInhaber || isHQ) return;
            if(!sbProfile || !sbProfile.standort_id) return;

            var today = new Date();
            var todayStr = today.toISOString().slice(0,10);

            // Welche BWA-Monate fehlen? PrÃ¼fe die letzten 3 Monate
            var missingMonths = [];
            for(var offset = 1; offset <= 3; offset++) {
                var checkDate = new Date(today.getFullYear(), today.getMonth() - offset, 1);
                var bwaMonat = checkDate.getMonth() + 1; // 1-12
                var bwaJahr = checkDate.getFullYear();
                // Deadline = 15. des Folgemonats
                var deadlineDate = new Date(bwaJahr, bwaMonat, 15); // bwaMonat ist 0-indexed+1 = nÃ¤chster Monat
                // Nur relevant wenn wir nach dem 1. des Folgemonats sind
                var reminderStart = new Date(bwaJahr, bwaMonat, 1);
                if(today >= reminderStart) {
                    missingMonths.push({
                        monat: bwaMonat === 0 ? 12 : bwaMonat,
                        jahr: bwaMonat === 0 ? bwaJahr - 1 : bwaJahr,
                        bwaMonat: checkDate.getMonth() + 1,
                        bwaJahr: checkDate.getFullYear(),
                        deadline: deadlineDate,
                        deadlineStr: deadlineDate.toISOString().slice(0,10)
                    });
                }
            }
            if(missingMonths.length === 0) return;

            // PrÃ¼fe welche BWAs bereits eingereicht sind
            try {
                var bwaResp = await sb.from('bwa_daten').select('monat,jahr').eq('standort_id', sbProfile.standort_id);
                if(bwaResp.error) throw bwaResp.error;
                var submitted = (bwaResp.data || []);
                var submittedKeys = submitted.map(function(b) { return b.jahr + '-' + b.monat; });

                // PrÃ¼fe welche Reminder-Todos bereits existieren
                var todoResp = await sb.from('todos').select('id,titel,prio,eskalation_stufe,referenz_typ,referenz_id')
                    .eq('standort_id', sbProfile.standort_id)
                    .eq('referenz_typ', 'bwa_erinnerung')
                    .eq('erledigt', false);
                var existingTodos = (todoResp.data || []);
                var existingKeys = existingTodos.map(function(t) { return t.referenz_id; });

                var monatNamen = ['', 'Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
                var bwaRemindersCreated = 0;
                var bwaEscalations = [];

                for(var i = 0; i < missingMonths.length; i++) {
                    var mm = missingMonths[i];
                    var key = mm.bwaJahr + '-' + mm.bwaMonat;

                    // Schon eingereicht? â†’ Skip
                    if(submittedKeys.indexOf(key) >= 0) {
                        // Falls ein Todo dafÃ¼r existiert, als erledigt markieren
                        var doneTodo = existingTodos.find(function(t){ return t.referenz_id === key; });
                        if(doneTodo) {
                            await sb.from('todos').update({erledigt:true, erledigt_am:new Date().toISOString()}).eq('id', doneTodo.id);
                        }
                        continue;
                    }

                    // Eskalationsstufe berechnen
                    var dayOfMonth = today.getDate();
                    var monthDiff = (today.getFullYear() - mm.bwaJahr) * 12 + (today.getMonth() + 1 - mm.bwaMonat);
                    var eskalation = 0;
                    if(monthDiff >= 1) { // Wir sind im Folgemonat oder spÃ¤ter
                        if(dayOfMonth >= 16 || monthDiff > 1) eskalation = 3; // ÃœBERFÃ„LLIG
                        else if(dayOfMonth >= 13) eskalation = 2; // Dringend
                        else if(dayOfMonth >= 8) eskalation = 1; // Hoch
                        else eskalation = 0; // Normal
                    }

                    var prioMap = ['normal','hoch','hoch','dringend'];
                    var prioSortMap = [1,0,0,0];
                    var prio = prioMap[eskalation] || 'normal';
                    var prioSort = prioSortMap[eskalation] || 1;
                    var monatLabel = monatNamen[mm.bwaMonat] || ('Monat ' + mm.bwaMonat);
                    var titel = t('bwa_reminder_title').replace('{monat}', monatLabel).replace('{jahr}', mm.bwaJahr);
                    var beschreibung = t('bwa_reminder_desc')
                        .replace('{monat}', monatLabel).replace('{jahr}', mm.bwaJahr)
                        .replace('{deadline}', mm.deadline.toLocaleDateString('de-DE'));
                    if(eskalation >= 2) beschreibung += '\n\n' + t('bwa_reminder_urgent');
                    if(eskalation >= 3) beschreibung += '\n' + t('bwa_reminder_overdue');

                    // Todo existiert schon? â†’ Update Eskalation
                    var existingTodo = existingTodos.find(function(t){ return t.referenz_id === key; });
                    if(existingTodo) {
                        if((existingTodo.eskalation_stufe || 0) < eskalation) {
                            await sb.from('todos').update({
                                prio: prio, prio_sort: prioSort,
                                eskalation_stufe: eskalation,
                                titel: titel, beschreibung: beschreibung,
                                erinnerung_email_faellig: eskalation >= 2
                            }).eq('id', existingTodo.id);
                            if(eskalation >= 2) bwaEscalations.push(mm);
                        }
                    } else {
                        // Neues Todo anlegen
                        await sb.from('todos').insert({
                            standort_id: sbProfile.standort_id,
                            erstellt_von: null, // System-generiert
                            titel: titel,
                            beschreibung: beschreibung,
                            faellig_am: mm.deadlineStr,
                            prio: prio, prio_sort: prioSort,
                            kategorie: 'admin',
                            typ: 'system',
                            referenz_typ: 'bwa_erinnerung',
                            referenz_id: key,
                            eskalation_stufe: eskalation,
                            erinnerung_email_faellig: eskalation >= 1
                        });
                        bwaRemindersCreated++;
                    }
                }

                // Banner anzeigen wenn Ã¼berfÃ¤llige BWAs vorhanden
                if(bwaEscalations.length > 0 || missingMonths.some(function(m){ return submittedKeys.indexOf(m.bwaJahr+'-'+m.bwaMonat) < 0; })) {
                    showBwaReminderBanner(missingMonths.filter(function(m){
                        return submittedKeys.indexOf(m.bwaJahr+'-'+m.bwaMonat) < 0;
                    }));
                }

            } catch(err) {
                console.warn('BWA deadline check:', err);
            }
        }

        function showBwaReminderBanner(missingBwas) {
            if(!missingBwas || missingBwas.length === 0) return;
            var existing = document.getElementById('bwaReminderBanner');
            if(existing) existing.remove();

            var today = new Date();
            var monatNamen = ['','Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var worst = 0;
            var labels = missingBwas.map(function(m) {
                var dayOfMonth = today.getDate();
                var monthDiff = (today.getFullYear() - m.bwaJahr) * 12 + (today.getMonth() + 1 - m.bwaMonat);
                var esk = 0;
                if(monthDiff >= 1) {
                    if(dayOfMonth >= 16 || monthDiff > 1) esk = 3;
                    else if(dayOfMonth >= 13) esk = 2;
                    else if(dayOfMonth >= 8) esk = 1;
                }
                if(esk > worst) worst = esk;
                return monatNamen[m.bwaMonat] + ' ' + m.bwaJahr;
            });

            var colors = ['bg-blue-50 border-blue-300 text-blue-800','bg-yellow-50 border-yellow-300 text-yellow-800','bg-orange-50 border-orange-400 text-orange-800','bg-red-50 border-red-400 text-red-800'];
            var icons = ['\u2139\uFE0F','\u26A0\uFE0F','\uD83D\uDD25','\uD83D\uDEA8'];
            var msgKeys = ['bwa_banner_info','bwa_banner_warn','bwa_banner_urgent','bwa_banner_overdue'];

            var banner = document.createElement('div');
            banner.id = 'bwaReminderBanner';
            banner.innerHTML = '<div style="position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:8999;max-width:640px;width:95%;" class="'+colors[worst]+' border rounded-xl shadow-lg px-5 py-3 flex items-center justify-between">'
                + '<div class="flex items-center space-x-3">'
                + '<span class="text-2xl">'+icons[worst]+'</span>'
                + '<div><p class="text-sm font-semibold">'+t(msgKeys[worst])+'</p>'
                + '<p class="text-xs opacity-75">' + t('bwa_banner_missing') + ': ' + labels.join(', ') + '</p></div></div>'
                + '<div class="flex items-center space-x-2">'
                + '<button onclick="showView(\'controlling\');document.getElementById(\'bwaReminderBanner\').remove();" class="px-3 py-1.5 bg-vit-orange text-white text-xs font-semibold rounded-lg hover:opacity-90">' + t('bwa_banner_btn') + '</button>'
                + '<button onclick="document.getElementById(\'bwaReminderBanner\').remove();" class="text-gray-400 hover:text-gray-600">\u2715</button>'
                + '</div></div>';
            document.body.appendChild(banner);
        }

        // HQ: Ãœbersicht fehlender BWAs aller Standorte
        async function loadHqBwaStatus() {
            if(!sbProfile || !sbProfile.is_hq) return;
            try {
                var today = new Date();
                var prevMonth = today.getMonth(); // 0-11, 0=Jan â†’ prev=Dec
                var prevYear = prevMonth === 0 ? today.getFullYear() - 1 : today.getFullYear();
                if(prevMonth === 0) prevMonth = 12; // Korrektur

                // Alle Standorte laden
                var stdResp = await sb.from('standorte').select('id,name');
                if(stdResp.error) return;
                var standorte = stdResp.data || [];

                // Alle BWAs fÃ¼r den Vormonat
                var bwaResp = await sb.from('bwa_daten').select('standort_id').eq('monat', prevMonth).eq('jahr', prevYear);
                var submittedIds = (bwaResp.data||[]).map(function(b){return b.standort_id;});

                var missing = standorte.filter(function(s){ return submittedIds.indexOf(s.id) < 0; });

                // Todos mit Ã¼berfÃ¤lligen BWA-Erinnerungen
                var eskResp = await sb.from('todos').select('standort_id,eskalation_stufe,erinnerung_email_faellig')
                    .eq('referenz_typ','bwa_erinnerung').eq('erledigt',false).gte('eskalation_stufe',2);
                var escalated = eskResp.data || [];

                return { missing: missing, escalated: escalated, total: standorte.length, month: prevMonth, year: prevYear };
            } catch(e) { console.warn('HQ BWA status:', e); return null; }
        }

        // === HQ KOMMUNIKATION ===
        var hqAnnouncements = [
            {id:1,title:'Fruehjahrs-Aktion 2026 â€“ Materialien verfuegbar',date:'2026-02-12',author:'Lisa Zentrale',priority:'hoch',target:'alle',body:'Liebe Partner, die Materialien fuer die Fruehjahrs-Aktion stehen ab sofort im Content-Bereich bereit. Bitte bis 01.03. im Laden platzieren.',read:18,total:21},
            {id:2,title:'Neue Einkaufsrichtlinie Q1/2026',date:'2026-02-10',author:'Thomas HQ',priority:'hoch',target:'alle',body:'Aktualisierte Margen-Empfehlung und Vororder-Deadlines fuer Q1 2026.',read:15,total:21},
            {id:3,title:'Schulung: Bosch Smart System â€“ 25.02.',date:'2026-02-08',author:'Lisa Zentrale',priority:'mittel',target:'alle',body:'Online-Schulung via Teams. Link wird per Mail versendet. Teilnahme empfohlen fuer alle Werkstatt-MA.',read:12,total:21},
            {id:4,title:'Osteraktion: Fruehbucher-Rabatt auf E-MTBs',date:'2026-02-05',author:'Marketing HQ',priority:'mittel',target:'alle',body:'10% Fruehbucher-Rabatt auf alle Orbea Rise und Wild. Gilt 01.03.â€“15.04.',read:21,total:21},
            {id:5,title:'Region Sued: Lagerbestand-Inventur bis 01.03.',date:'2026-02-03',author:'Thomas HQ',priority:'niedrig',target:'Region SÃ¼d',body:'Bitte Inventur durchfuehren und Ergebnisse in den Aktenschrank hochladen.',read:6,total:8}
        ];
        var hqForumTopics = [
            {id:1,title:'Best Practices: E-Bike Probefahrten organisieren',author:'Max Mustermann, Grafrath',date:'2026-02-13',replies:8,pinned:true},
            {id:2,title:'Erfahrungen mit Shimano EP6 Antrieb?',author:'Peter Hansen, Hamburg',date:'2026-02-12',replies:5,pinned:false},
            {id:3,title:'Werkstatt-Auslastung im Fruehjahr managen',author:'Jan Schulze, Berlin',date:'2026-02-11',replies:12,pinned:false},
            {id:4,title:'Jobrad-Leasing: Tipps fuer B2B-Kunden',author:'Miriam Deichmann, Hamburg',date:'2026-02-09',replies:3,pinned:true},
            {id:5,title:'Social Media: Welche Themen laufen bei euch?',author:'Laura Schmidt, Grafrath',date:'2026-02-07',replies:15,pinned:false}
        ];
        var currentHqKommTab='announce';
        function showHqKommTab(tab){
            currentHqKommTab=tab;
            document.querySelectorAll('.hqkomm-tab-btn').forEach(function(b){b.className='hqkomm-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700';});
            var btn=document.querySelector('.hqkomm-tab-btn[data-hkt="'+tab+'"]');
            if(btn)btn.className='hqkomm-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            renderHqKomm();
        }
        function openAnkuendigungModal() {
            var html = '<div id="ankOverlay" onclick="closeAnkModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDCE2 Neue Ankuendigung</h3><button onclick="closeAnkModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Titel *</label><input id="ankTitel" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="z.B. Neue Preisliste ab Maerz"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Kategorie</label><select id="ankKat" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="news">News</option><option value="event">Event</option><option value="schulung">Schulung</option><option value="marketing">Marketing</option><option value="sortiment">Sortiment</option><option value="preise">Preise</option><option value="it">IT</option></select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Inhalt *</label><textarea id="ankInhalt" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" rows="5" placeholder="Ankuendigungstext..."></textarea></div>';
            html += '<label class="flex items-center space-x-2"><input id="ankWichtig" type="checkbox" class="rounded"><span class="text-sm text-gray-600">Als wichtig markieren</span></label>';
            html += '</div>';
            html += '<div id="ankError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveAnkuendigung()" id="ankSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Veroeffentlichen</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'ankContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closeAnkModal() { var c = document.getElementById('ankContainer'); if(c) c.remove(); }
        async function saveAnkuendigung() {
            var titel = (document.getElementById('ankTitel')||{}).value;
            var inhalt = (document.getElementById('ankInhalt')||{}).value;
            var kategorie = (document.getElementById('ankKat')||{}).value || 'news';
            var wichtig = (document.getElementById('ankWichtig')||{}).checked || false;
            var errEl = document.getElementById('ankError');
            if(!titel||!titel.trim()||!inhalt||!inhalt.trim()) { if(errEl){errEl.textContent='Bitte Titel und Inhalt ausfuellen.';errEl.style.display='block';} return; }
            var btn = document.getElementById('ankSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var resp = await sb.from('ankuendigungen').insert({
                    titel: titel.trim(), inhalt: inhalt.trim(), kategorie: kategorie,
                    wichtig: wichtig, erstellt_von: sbUser ? sbUser.id : null
                });
                if(resp.error) throw resp.error;
                closeAnkModal();
                alert('\u2705 Ankuendigung veroeffentlicht!');
                renderAnnouncements();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn){btn.disabled=false;btn.textContent='Veroeffentlichen';}
            }
        }

        function renderHqKomm(){
            var el=document.getElementById('hqKommContent');if(!el)return;
            var h='';
            if(currentHqKommTab==='announce'){
                h+='<div class="flex justify-end mb-4"><button onclick="alert(\'Neue Ankuendigung erstellen (Demo)\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Ankuendigung</button></div>';
                hqAnnouncements.forEach(function(a){
                    var prioBg=a.priority==='hoch'?'border-l-4 border-red-500':a.priority==='mittel'?'border-l-4 border-yellow-400':'border-l-4 border-gray-300';
                    var readPct=Math.round(a.read/a.total*100);
                    h+='<div class="vit-card p-4 mb-3 '+prioBg+'">';
                    h+='<div class="flex items-start justify-between"><div class="flex-1">';
                    h+='<div class="flex items-center space-x-2"><p class="font-bold text-gray-800">'+a.title+'</p>';
                    if(a.priority==='hoch') h+='<span class="text-[10px] px-2 py-0.5 rounded-full bg-red-100 text-red-600 font-bold">WICHTIG</span>';
                    h+='</div>';
                    h+='<p class="text-xs text-gray-500 mt-1">'+a.author+' Â· '+a.date+' Â· Ziel: '+a.target+'</p>';
                    h+='<p class="text-sm text-gray-600 mt-2">'+a.body+'</p>';
                    h+='</div>';
                    h+='<div class="text-right flex-shrink-0 ml-4"><p class="text-xs text-gray-400">Gelesen</p>';
                    h+='<p class="text-lg font-bold '+(readPct>=90?'text-green-600':readPct>=50?'text-yellow-600':'text-red-500')+'">'+a.read+'/'+a.total+'</p>';
                    h+='<div class="w-16 bg-gray-100 rounded-full h-1.5 mt-1"><div class="h-1.5 rounded-full '+(readPct>=90?'bg-green-500':'bg-yellow-500')+'" style="width:'+readPct+'%"></div></div>';
                    h+='</div></div></div>';
                });
            } else if(currentHqKommTab==='rundmail'){
                h+='<div class="vit-card p-6"><h3 class="font-bold text-gray-800 mb-4">âœ‰ï¸ Rundmail an Standorte senden</h3>';
                h+='<div class="space-y-3">';
                h+='<select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option>Alle Standorte (21)</option><option>Region Sued (8)</option><option>Region Nord (5)</option><option>Region West (5)</option><option>Region Ost (3)</option><option>Nur Inhaber</option></select>';
                h+='<input type="text" placeholder="Betreff" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
                h+='<textarea rows="6" placeholder="Nachricht an das Netzwerk..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>';
                h+='<div class="flex items-center space-x-3"><label class="flex items-center text-sm text-gray-600"><input type="checkbox" class="mr-2"> Als Ankuendigung im Portal anzeigen</label></div>';
                h+='<button onclick="this.textContent=\'âœ… Gesendet!\';this.disabled=true;setTimeout(function(){this.textContent=\'ðŸ“¨ Senden\';this.disabled=false;}.bind(this),2000)" class="px-6 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ“¨ Senden</button>';
                h+='</div></div>';
                h+='<h3 class="font-bold text-gray-800 mt-6 mb-3">Letzte Rundmails</h3>';
                var mails=[{subj:'Fruehjahrs-Aktion Materialien',date:'12.02.2026',to:'Alle',opened:'18/21'},{subj:'Einkaufsrichtlinie Q1',date:'10.02.2026',to:'Alle',opened:'15/21'},{subj:'Inventur-Erinnerung',date:'03.02.2026',to:'Region Sued',opened:'6/8'}];
                mails.forEach(function(m){
                    h+='<div class="vit-card p-3 flex items-center justify-between mb-2"><div><p class="text-sm font-semibold text-gray-800">'+m.subj+'</p><p class="text-xs text-gray-500">'+m.date+' Â· An: '+m.to+'</p></div><span class="text-xs font-semibold text-gray-500">Geoeffnet: '+m.opened+'</span></div>';
                });
            } else if(currentHqKommTab==='forum'){
                h+='<p class="text-sm text-gray-500 mb-4">Netzwerk-Forum: Moderieren und Pinnen von Beitraegen aller Standorte.</p>';
                hqForumTopics.forEach(function(f){
                    h+='<div class="vit-card p-4 flex items-center space-x-3 mb-2">';
                    if(f.pinned) h+='<span class="text-vit-orange text-sm">ðŸ“Œ</span>'; else h+='<span class="text-gray-300 text-sm">ðŸ’¬</span>';
                    h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+f.title+'</p><p class="text-xs text-gray-500">'+f.author+' Â· '+f.date+'</p></div>';
                    h+='<div class="text-right flex-shrink-0"><span class="text-xs font-bold text-gray-600">'+f.replies+' Antworten</span></div>';
                    h+='<button onclick="alert(\'Beitrag '+(f.pinned?'loesen':'pinnen')+' (Demo)\')" class="text-xs px-2 py-1 rounded border border-gray-200 text-gray-500 hover:bg-gray-50">'+(f.pinned?'Loesen':'Pinnen')+'</button>';
                    h+='</div>';
                });
            }
            el.innerHTML=h;
        }

        // === HQ KAMPAGNEN ===
        var hqKampagnen = [
            {id:1,name:'Fruehjahrs-Aktion 2026',type:'saisonal',start:'2026-03-01',end:'2026-04-15',status:'aktiv',standorte:21,umgesetzt:14,budget:25000,desc:'Fokus auf E-Bikes und Zubehoer. POS-Material + Online-Banner.'},
            {id:2,name:'Orbea Rise Launch Event',type:'produkt',start:'2026-02-20',end:'2026-03-10',status:'aktiv',standorte:21,umgesetzt:8,budget:15000,desc:'Produktlaunch neues Orbea Rise 2026. Probefahrt-Events an allen Standorten.'},
            {id:3,name:'Jobrad-Fruehjahr B2B',type:'event',start:'2026-03-15',end:'2026-05-31',status:'geplant',standorte:12,umgesetzt:0,budget:10000,desc:'B2B-Kampagne fuer Firmenkunden. Flyer + Akquise-Toolbox.'},
            {id:4,name:'Social Media Push #BikeLife',type:'social',start:'2026-02-01',end:'2026-02-28',status:'aktiv',standorte:21,umgesetzt:16,budget:5000,desc:'Netzwerk-weiter Social Media Push mit Hashtag-Kampagne.'},
            {id:5,name:'Black Friday Bikes',type:'saisonal',start:'2025-11-25',end:'2025-12-01',status:'beendet',standorte:21,umgesetzt:21,budget:20000,desc:'Abgeschlossene Saisonkampagne.'},
            {id:6,name:'Weihnachts-Zubehoer',type:'saisonal',start:'2025-12-01',end:'2025-12-24',status:'beendet',standorte:21,umgesetzt:19,budget:8000,desc:'Zubehoer-Fokus im Weihnachtsgeschaeft.'}
        ];
        function renderHqKampagnen(){
            var aktiv=hqKampagnen.filter(function(k){return k.status==='aktiv';}).length;
            var geplant=hqKampagnen.filter(function(k){return k.status==='geplant';}).length;
            var beendet=hqKampagnen.filter(function(k){return k.status==='beendet';}).length;
            var totalBudget=hqKampagnen.reduce(function(a,k){return a+k.budget;},0);
            var avgUmsetzung=Math.round(hqKampagnen.filter(function(k){return k.status==='aktiv';}).reduce(function(a,k){return a+Math.round(k.umgesetzt/k.standorte*100);},0)/(aktiv||1));
            var kpi=document.getElementById('hqKampKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqKampagnen.length+'</p><p class="text-xs text-gray-500">Kampagnen total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+aktiv+'</p><p class="text-xs text-gray-500">Aktiv</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+geplant+'</p><p class="text-xs text-gray-500">Geplant</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-400">'+beendet+'</p><p class="text-xs text-gray-500">Beendet</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+avgUmsetzung+'%</p><p class="text-xs text-gray-500">Ã˜ Umsetzung (aktiv)</p></div>';

            var el=document.getElementById('hqKampList');if(!el)return;
            var h='';
            var statusCls={aktiv:'bg-green-100 text-green-700',geplant:'bg-blue-100 text-blue-700',beendet:'bg-gray-100 text-gray-500'};
            var statusLabel={aktiv:'ðŸŸ¢ Aktiv',geplant:'ðŸ”µ Geplant',beendet:'âšª Beendet'};
            var typLabel={saisonal:'ðŸŒ¸ Saison',produkt:'ðŸš² Produkt',event:'ðŸŽª Event',social:'ðŸ“± Social'};
            hqKampagnen.forEach(function(k){
                var pct=k.standorte?Math.round(k.umgesetzt/k.standorte*100):0;
                h+='<div class="vit-card p-5">';
                h+='<div class="flex items-start justify-between mb-3"><div><h3 class="font-bold text-gray-800">'+k.name+'</h3>';
                h+='<p class="text-xs text-gray-500">'+k.start+' bis '+k.end+' Â· Budget: '+fmt(k.budget)+' EUR</p></div>';
                h+='<div class="flex items-center space-x-2"><span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">'+(typLabel[k.type]||k.type)+'</span>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(statusCls[k.status]||'')+'">'+(statusLabel[k.status]||k.status)+'</span></div></div>';
                h+='<p class="text-sm text-gray-600 mb-3">'+k.desc+'</p>';
                h+='<div class="flex items-center space-x-4">';
                h+='<div class="flex-1"><p class="text-xs text-gray-500 mb-1">Umsetzung: '+k.umgesetzt+'/'+k.standorte+' Standorte ('+pct+'%)</p>';
                h+='<div class="w-full bg-gray-100 rounded-full h-2.5"><div class="h-2.5 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-500')+'" style="width:'+pct+'%"></div></div></div>';
                if(k.status!=='beendet') h+='<button onclick="alert(\'Kampagne bearbeiten (Demo)\')" class="text-xs px-3 py-1.5 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">Bearbeiten</button>';
                h+='</div></div>';
            });
            el.innerHTML=h;
        }
        function addHqKampagne(){
            var n=document.getElementById('hqKampName').value;if(!n){alert('Bitte Name eingeben.');return;}
            hqKampagnen.unshift({id:hqKampagnen.length+1,name:n,type:document.getElementById('hqKampType').value,start:document.getElementById('hqKampStart').value||'2026-03-01',end:document.getElementById('hqKampEnd').value||'2026-04-30',status:'geplant',standorte:21,umgesetzt:0,budget:0,desc:document.getElementById('hqKampDesc').value||''});
            document.getElementById('hqKampModal').classList.add('hidden');document.getElementById('hqKampName').value='';
            renderHqKampagnen();
        }

        // === HQ DOKUMENTE ===
        var hqDokumente = [
            {id:1,name:'Franchise-Handbuch v4.2',kat:'richtlinie',date:'2026-01-15',size:'2.4 MB',type:'PDF',target:'alle',downloads:18},
            {id:2,name:'Einkaufsrichtlinie Q1/2026',kat:'richtlinie',date:'2026-02-10',size:'840 KB',type:'PDF',target:'alle',downloads:15},
            {id:3,name:'Margen-Kalkulation Vorlage',kat:'vorlage',date:'2026-01-20',size:'120 KB',type:'XLSX',target:'alle',downloads:12},
            {id:4,name:'Angebots-Template vit:bikes',kat:'vorlage',date:'2025-11-01',size:'95 KB',type:'DOCX',target:'alle',downloads:21},
            {id:5,name:'BWA-Analyse Checkliste',kat:'vorlage',date:'2026-01-08',size:'65 KB',type:'PDF',target:'Inhaber',downloads:9},
            {id:6,name:'Schulung: Bosch Smart System',kat:'schulung',date:'2026-02-08',size:'15 MB',type:'MP4',target:'alle',downloads:8},
            {id:7,name:'Schulung: Verkaufsgespraeche fuehren',kat:'schulung',date:'2025-12-15',size:'22 MB',type:'MP4',target:'alle',downloads:14},
            {id:8,name:'Schulung: Reklamationsmanagement',kat:'schulung',date:'2025-10-20',size:'18 MB',type:'MP4',target:'alle',downloads:19},
            {id:9,name:'Muster-Arbeitsvertrag Verkaeufer',kat:'vertrag',date:'2025-09-01',size:'180 KB',type:'DOCX',target:'Inhaber',downloads:7},
            {id:10,name:'Muster-Arbeitsvertrag Werkstatt',kat:'vertrag',date:'2025-09-01',size:'175 KB',type:'DOCX',target:'Inhaber',downloads:5},
            {id:11,name:'Social Media Guidelines',kat:'richtlinie',date:'2026-01-25',size:'1.1 MB',type:'PDF',target:'alle',downloads:11},
            {id:12,name:'Ladenbau-Richtlinie CI/CD',kat:'richtlinie',date:'2025-06-01',size:'3.8 MB',type:'PDF',target:'alle',downloads:20}
        ];
        var currentHqDokFilter='all';
        function filterHqDok(f){
            currentHqDokFilter=f;
            document.querySelectorAll('.hqdok-filter').forEach(function(b){b.className='hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqdok-filter[data-hdf="'+f+'"]');
            if(btn)btn.className='hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqDokumente();
        }

        var netzDokCache = null;
        async function loadNetzwerkDokumente() {
            try {
                var resp = await sb.from('netzwerk_dokumente').select('*, users(name)').order('created_at', {ascending:false});
                if(resp.error) throw resp.error;
                netzDokCache = resp.data || [];
            } catch(e) { netzDokCache = []; console.warn('Dok load:', e); }
            renderHqDokumente();
        }

        function renderHqDokumente(){
            // Wenn DB-Daten da sind, nutze die; sonst Fallback auf hardcoded
            var allDoks = netzDokCache || hqDokumente || [];
            var isFromDb = netzDokCache !== null && netzDokCache.length > 0;
            var isHQ = sbProfile && sbProfile.is_hq;

            var list = currentHqDokFilter==='all' ? allDoks : allDoks.filter(function(d){ return isFromDb ? d.kategorie===currentHqDokFilter : d.kat===currentHqDokFilter; });

            var kpi=document.getElementById('hqDokKpis');
            var totalCount = allDoks.length;
            var richtCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='richtlinie';}).length;
            var vorlCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='vorlage';}).length;
            var schulCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='schulung';}).length;
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+totalCount+'</p><p class="text-xs text-gray-500">Dokumente</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+richtCount+'</p><p class="text-xs text-gray-500">Richtlinien</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+vorlCount+'</p><p class="text-xs text-gray-500">Vorlagen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-purple-600">'+schulCount+'</p><p class="text-xs text-gray-500">Schulungen</p></div>';

            var el=document.getElementById('hqDokList');if(!el)return;
            var h='';
            var katIcons={richtlinie:'\uD83D\uDCCB',vorlage:'\uD83D\uDCC4',schulung:'\uD83C\uDF93',vertrag:'\uD83D\uDCD1',sonstiges:'\uD83D\uDCC1'};
            list.forEach(function(d){
                var kat = isFromDb ? d.kategorie : d.kat;
                var name = isFromDb ? d.titel : d.name;
                var dateStr = isFromDb ? new Date(d.created_at).toLocaleDateString('de-DE') : d.date;
                var sizeStr = isFromDb ? formatFileSize(d.datei_groesse) : d.size;
                var fileName = isFromDb ? (d.datei_name||'') : '';
                var ext = fileName.split('.').pop().toUpperCase();
                var typeColors={PDF:'bg-red-100 text-red-600',XLSX:'bg-green-100 text-green-700',DOCX:'bg-blue-100 text-blue-700',MP4:'bg-purple-100 text-purple-700',PNG:'bg-pink-100 text-pink-600',JPG:'bg-pink-100 text-pink-600'};

                h+='<div class="vit-card p-3 flex items-center space-x-3">';
                h+='<span class="text-2xl">'+(katIcons[kat]||'\uD83D\uDCC1')+'</span>';
                h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+name+'</p>';
                h+='<p class="text-[10px] text-gray-500">'+dateStr+' \u00B7 '+sizeStr;
                if(isFromDb && d.users && d.users.name) h+=' \u00B7 '+d.users.name;
                h+='</p></div>';
                if(ext) h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(typeColors[ext]||'bg-gray-100 text-gray-600')+'">'+ext+'</span>';
                if(isFromDb) {
                    h+='<button onclick="downloadDokument(\''+d.datei_url+'\')" class="text-xs px-3 py-1 bg-vit-orange text-white rounded-lg hover:opacity-90">\u2193</button>';
                    if(isHQ) h+='<button onclick="deleteNetzwerkDok(\''+d.id+'\')" class="text-xs px-2 py-1 text-gray-300 hover:text-red-500">\u2715</button>';
                } else {
                    h+='<span class="text-xs text-gray-400">'+(d.downloads||0)+'x \u2193</span>';
                    h+='<button onclick="alert(\'Download fuer '+name+' wird vorbereitet...\')" class="text-xs px-3 py-1 bg-vit-orange text-white rounded-lg hover:opacity-90">\u2193</button>';
                }
                h+='</div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400">Keine Dokumente in dieser Kategorie.</div>';
            el.innerHTML=h;
        }

        function formatFileSize(bytes) {
            if(!bytes) return 'â€”';
            if(bytes < 1024) return bytes + ' B';
            if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
            return (bytes/1048576).toFixed(1) + ' MB';
        }

        async function downloadDokument(path) {
            try {
                var resp = await sb.storage.from('dokumente').createSignedUrl(path, 3600);
                if(resp.error) throw resp.error;
                window.open(resp.data.signedUrl, '_blank');
            } catch(err) { alert('Download-Fehler: '+err.message); }
        }

        async function deleteNetzwerkDok(id) {
            if(!confirm('Dokument wirklich loeschen?')) return;
            try {
                var dokResp = await sb.from('netzwerk_dokumente').select('datei_url').eq('id',id).single();
                if(dokResp.data && dokResp.data.datei_url) {
                    await sb.storage.from('dokumente').remove([dokResp.data.datei_url]);
                }
                await sb.from('netzwerk_dokumente').delete().eq('id',id);
                await loadNetzwerkDokumente();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // === HQ KALENDER (DB-backed) ===
        var hqKalTermine = [];

        async function loadHqKalTermine() {
            try {
                var resp = await sb.from('termine').select('*').eq('ist_netzwerk_termin', true).order('start_zeit', {ascending:true});
                if(!resp.error && resp.data && resp.data.length > 0) {
                    hqKalTermine = (resp.data||[]).map(function(t) {
                        var d = new Date(t.start_zeit);
                        return {
                            id: t.id, title: t.titel,
                            date: d.toISOString().slice(0,10),
                            time: t.ganztaegig ? '23:59' : String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'),
                            type: t.typ || 'meeting',
                            target: t.zielgruppe || 'alle',
                            pflicht: t.pflicht || false,
                            ms365_event_id: t.ms365_event_id || null
                        };
                    });
                } else {
                    // Fallback demo data when DB is empty
                    hqKalTermine = [
                        {id:1,title:'Schulung: Bosch Smart System (Online)',date:'2026-02-25',time:'09:00',type:'schulung',target:'alle',pflicht:true},
                        {id:2,title:'Orbea Rise Launch Event â€“ Kick-off',date:'2026-02-20',time:'10:00',type:'event',target:'alle',pflicht:false},
                        {id:3,title:'Deadline: Vororder Sommer 2026',date:'2026-03-01',time:'23:59',type:'deadline',target:'alle',pflicht:true},
                        {id:4,title:'Netzwerk-Meeting Q1 (Online)',date:'2026-03-05',time:'14:00',type:'meeting',target:'alle',pflicht:true},
                        {id:5,title:'Schulung: Verkaufsgespraeche Advanced',date:'2026-03-12',time:'09:00',type:'schulung',target:'alle',pflicht:false},
                        {id:6,title:'Fruehlings-Aktionstag â€“ Probefahrt-Event',date:'2026-03-15',time:'10:00',type:'event',target:'alle',pflicht:false},
                        {id:7,title:'Deadline: Social Media Monatsplanung Maerz',date:'2026-02-28',time:'23:59',type:'deadline',target:'alle',pflicht:false},
                        {id:8,title:'Region Sued Meeting',date:'2026-03-10',time:'15:00',type:'meeting',target:'Region SÃ¼d',pflicht:true},
                        {id:9,title:'Schulung: Shimano STEPS EP801',date:'2026-03-20',time:'09:00',type:'schulung',target:'alle',pflicht:false},
                        {id:10,title:'Deadline: BWA Februar einreichen',date:'2026-03-15',time:'23:59',type:'deadline',target:'Inhaber',pflicht:true}
                    ];
                }
            } catch(err) { console.warn('HQ Kalender load:', err); }
            renderHqKalender();
        }
        var currentHqKalFilter='all';
        function filterHqKal(f){
            currentHqKalFilter=f;
            document.querySelectorAll('.hqkal-filter').forEach(function(b){b.className='hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqkal-filter[data-hkf="'+f+'"]');
            if(btn)btn.className='hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqKalender();
        }
        function renderHqKalender(){
            var today=new Date().toISOString().slice(0,10);
            var list=hqKalTermine.filter(function(t){
                if(currentHqKalFilter!=='all' && t.type!==currentHqKalFilter) return false;
                return true;
            }).sort(function(a,b){return a.date>b.date?1:-1;});

            var upcoming=list.filter(function(t){return t.date>=today;}).length;
            var past=list.filter(function(t){return t.date<today;}).length;
            var pflicht=list.filter(function(t){return t.pflicht && t.date>=today;}).length;
            var kpi=document.getElementById('hqKalKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqKalTermine.length+'</p><p class="text-xs text-gray-500">Termine total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+upcoming+'</p><p class="text-xs text-gray-500">Anstehend</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500">'+pflicht+'</p><p class="text-xs text-gray-500">Pflichttermine</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-400">'+past+'</p><p class="text-xs text-gray-500">Vergangen</p></div>';

            var el=document.getElementById('hqKalList');if(!el)return;
            var h='';
            var typeIcons={schulung:'ðŸŽ“',event:'ðŸŽª',deadline:'â°',meeting:'ðŸ¤'};
            var typeCls={schulung:'bg-purple-100 text-purple-700',event:'bg-green-100 text-green-700',deadline:'bg-red-100 text-red-700',meeting:'bg-blue-100 text-blue-700'};
            var dayNames=['So','Mo','Di','Mi','Do','Fr','Sa'];
            list.forEach(function(t){
                var dd=new Date(t.date);var dayName=dayNames[dd.getDay()];
                var isPast=t.date<today;
                h+='<div class="vit-card p-3 flex items-center space-x-3 '+(isPast?'opacity-50':'')+'">';
                h+='<div class="text-center flex-shrink-0 w-14 '+(isPast?'':'bg-orange-50 rounded-lg p-1')+'"><p class="text-[10px] text-gray-500">'+dayName+'</p><p class="text-lg font-bold text-gray-800">'+parseInt(t.date.slice(8))+'</p><p class="text-[10px] text-gray-400">'+t.date.slice(5,7)+'.'+t.date.slice(0,4)+'</p></div>';
                h+='<span class="text-xl">'+(typeIcons[t.type]||'ðŸ“…')+'</span>';
                h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+t.title+'</p>';
                h+='<p class="text-[10px] text-gray-500">'+t.time+' Uhr Â· Ziel: '+t.target+(t.pflicht?' Â· <span class="text-red-500 font-bold">PFLICHT</span>':'')+'</p></div>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(typeCls[t.type]||'')+'">'+(typeIcons[t.type]||'')+' '+t.type.charAt(0).toUpperCase()+t.type.slice(1)+'</span>';
                h+='</div>';
            });
            el.innerHTML=h;
        }
        function addHqKalTermin(){
            var title=document.getElementById('hqKalTitle').value;if(!title){alert('Bitte Titel eingeben.');return;}
            hqKalTermine.push({id:hqKalTermine.length+1,title:title,date:document.getElementById('hqKalDate').value||'2026-03-01',time:document.getElementById('hqKalTime').value||'09:00',type:document.getElementById('hqKalType').value,target:document.getElementById('hqKalTarget').value==='alle'?'alle':'Region',pflicht:false});
            document.getElementById('hqKalModal').classList.add('hidden');document.getElementById('hqKalTitle').value='';
            renderHqKalender();
        }

        // === HQ AUFGABEN ===
        var hqTasks = [
            {id:1,title:'Fruehjahrs-Deko aufbauen (POS-Material)',deadline:'2026-03-01',prio:'hoch',target:'alle',status:'offen',done:8,total:21,kat:'Marketing'},
            {id:2,title:'Vororder Sommer 2026 platzieren',deadline:'2026-03-01',prio:'hoch',target:'alle',status:'inprogress',done:14,total:21,kat:'Einkauf'},
            {id:3,title:'BWA Januar einreichen',deadline:'2026-02-20',prio:'hoch',target:'Inhaber',status:'inprogress',done:15,total:21,kat:'Controlling'},
            {id:4,title:'Local Hero Video drehen: Fruehjahrsthema',deadline:'2026-02-28',prio:'mittel',target:'alle',status:'offen',done:5,total:21,kat:'Marketing'},
            {id:5,title:'Werkstatt-Inventur durchfuehren',deadline:'2026-03-01',prio:'mittel',target:'Region SÃ¼d',status:'inprogress',done:4,total:8,kat:'Operations'},
            {id:6,title:'Schulungs-Video Bosch anschauen',deadline:'2026-02-28',prio:'niedrig',target:'alle',status:'offen',done:8,total:21,kat:'Wissen'},
            {id:7,title:'Kundenzufriedenheits-Umfrage ausfuellen',deadline:'2026-02-15',prio:'mittel',target:'alle',status:'inprogress',done:17,total:21,kat:'Support'},
            {id:8,title:'Jobrad-Info im Laden aushangen',deadline:'2026-03-15',prio:'niedrig',target:'alle',status:'offen',done:0,total:21,kat:'Marketing'},
            {id:9,title:'Social Media Profil aktualisieren',deadline:'2026-01-31',prio:'niedrig',target:'alle',status:'done',done:21,total:21,kat:'Marketing'},
            {id:10,title:'Weihnachts-Deko abbauen',deadline:'2026-01-10',prio:'niedrig',target:'alle',status:'done',done:21,total:21,kat:'Operations'}
        ];
        var currentHqTaskFilter='all';
        function filterHqTasks(f){
            currentHqTaskFilter=f;
            document.querySelectorAll('.hqtask-filter').forEach(function(b){b.className='hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqtask-filter[data-htf="'+f+'"]');
            if(btn)btn.className='hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqAufgaben();
        }
        function renderHqAufgaben(){
            var today=new Date().toISOString().slice(0,10);
            var list=hqTasks.filter(function(t){
                if(currentHqTaskFilter==='all') return true;
                return t.status===currentHqTaskFilter;
            });
            var offen=hqTasks.filter(function(t){return t.status==='offen';}).length;
            var inprog=hqTasks.filter(function(t){return t.status==='inprogress';}).length;
            var done=hqTasks.filter(function(t){return t.status==='done';}).length;
            var overdue=hqTasks.filter(function(t){return t.status!=='done'&&t.deadline<today;}).length;
            var avgCompl=Math.round(hqTasks.filter(function(t){return t.status!=='done';}).reduce(function(a,t){return a+Math.round(t.done/t.total*100);},0)/(hqTasks.filter(function(t){return t.status!=='done';}).length||1));
            var kpi=document.getElementById('hqTaskKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqTasks.length+'</p><p class="text-xs text-gray-500">Aufgaben total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500">'+offen+'</p><p class="text-xs text-gray-500">Offen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+inprog+'</p><p class="text-xs text-gray-500">In Arbeit</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+done+'</p><p class="text-xs text-gray-500">Erledigt</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+avgCompl+'%</p><p class="text-xs text-gray-500">Ã˜ Umsetzung</p></div>';

            var el=document.getElementById('hqTaskList');if(!el)return;
            var h='';
            var prioIcons={hoch:'ðŸ”´',mittel:'ðŸŸ¡',niedrig:'ðŸŸ¢'};
            var statusCls={offen:'bg-red-100 text-red-700',inprogress:'bg-blue-100 text-blue-700',done:'bg-green-100 text-green-700'};
            var statusLabel={offen:'Offen',inprogress:'In Arbeit',done:'Erledigt'};
            list.sort(function(a,b){var po={hoch:0,mittel:1,niedrig:2};return (po[a.prio]||1)-(po[b.prio]||1);});
            list.forEach(function(t){
                var pct=Math.round(t.done/t.total*100);
                var isOver=t.status!=='done'&&t.deadline<today;
                h+='<div class="vit-card p-4 '+(isOver?'border-l-4 border-red-500':'')+'">';
                h+='<div class="flex items-start justify-between mb-2"><div class="flex-1">';
                h+='<div class="flex items-center space-x-2"><span>'+(prioIcons[t.prio]||'')+'</span><p class="font-bold text-sm text-gray-800">'+t.title+'</p></div>';
                h+='<p class="text-[10px] text-gray-500 mt-0.5">'+t.kat+' Â· Deadline: '+t.deadline+' Â· Ziel: '+t.target+(isOver?' Â· <span class="text-red-500 font-bold">'+t('todo_overdue')+'</span>':'')+'</p>';
                h+='</div>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(statusCls[t.status]||'')+'">'+(statusLabel[t.status]||t.status)+'</span></div>';
                h+='<div class="flex items-center space-x-3"><div class="flex-1">';
                h+='<div class="flex items-center justify-between mb-0.5"><span class="text-[10px] text-gray-500">'+t.done+' / '+t.total+' Standorte ('+pct+'%)</span></div>';
                h+='<div class="w-full bg-gray-100 rounded-full h-2"><div class="h-2 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-400')+'" style="width:'+pct+'%"></div></div>';
                h+='</div></div></div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">âœ…</p><p class="text-sm">Keine Aufgaben in diesem Filter</p></div>';
            el.innerHTML=h;
        }
        function addHqTask(){
            var title=document.getElementById('hqTaskTitle').value;if(!title){alert('Bitte Aufgabe eingeben.');return;}
            var target=document.getElementById('hqTaskTarget').value;
            var total=target==='alle'?21:target==='region_sued'?8:target==='region_nord'?5:target==='region_west'?5:3;
            hqTasks.unshift({id:hqTasks.length+1,title:title,deadline:document.getElementById('hqTaskDeadline').value||'2026-03-31',prio:document.getElementById('hqTaskPrio').value,target:target==='alle'?'alle':target.replace('region_','Region '),status:'offen',done:0,total:total,kat:'HQ'});
            document.getElementById('hqTaskModal').classList.add('hidden');document.getElementById('hqTaskTitle').value='';
            renderHqAufgaben();
        }

        // === HQ AUSWERTUNG: Portal-Nutzung ===
        var portalNutzung = [
            {name:'Grafrath',logins:48,bwaUploaded:true,videosDone:4,aufgabenDone:85,moduleUsed:11,lastLogin:'2026-02-14'},
            {name:'Hamburg',logins:62,bwaUploaded:true,videosDone:6,aufgabenDone:92,moduleUsed:12,lastLogin:'2026-02-14'},
            {name:'Karlsdorf-Neuth.',logins:55,bwaUploaded:true,videosDone:5,aufgabenDone:88,moduleUsed:11,lastLogin:'2026-02-14'},
            {name:'Weilheim',logins:41,bwaUploaded:true,videosDone:3,aufgabenDone:78,moduleUsed:10,lastLogin:'2026-02-13'},
            {name:'Muenchen-Thal.',logins:38,bwaUploaded:true,videosDone:2,aufgabenDone:72,moduleUsed:9,lastLogin:'2026-02-13'},
            {name:'Holzkirchen',logins:35,bwaUploaded:true,videosDone:3,aufgabenDone:80,moduleUsed:10,lastLogin:'2026-02-14'},
            {name:'Teisendorf',logins:29,bwaUploaded:true,videosDone:2,aufgabenDone:65,moduleUsed:8,lastLogin:'2026-02-12'},
            {name:'Wesel',logins:26,bwaUploaded:true,videosDone:1,aufgabenDone:60,moduleUsed:8,lastLogin:'2026-02-12'},
            {name:'Reutlingen',logins:33,bwaUploaded:true,videosDone:2,aufgabenDone:70,moduleUsed:9,lastLogin:'2026-02-13'},
            {name:'Muenster',logins:22,bwaUploaded:false,videosDone:1,aufgabenDone:55,moduleUsed:7,lastLogin:'2026-02-11'},
            {name:'Rottweil',logins:18,bwaUploaded:false,videosDone:0,aufgabenDone:45,moduleUsed:6,lastLogin:'2026-02-10'},
            {name:'Berlin-Brand.',logins:31,bwaUploaded:false,videosDone:1,aufgabenDone:50,moduleUsed:7,lastLogin:'2026-02-11'},
            {name:'Witten',logins:15,bwaUploaded:false,videosDone:0,aufgabenDone:40,moduleUsed:5,lastLogin:'2026-02-09'},
            {name:'Warendorf',logins:12,bwaUploaded:false,videosDone:0,aufgabenDone:35,moduleUsed:5,lastLogin:'2026-02-08'},
            {name:'Muenchen-Berg',logins:20,bwaUploaded:false,videosDone:1,aufgabenDone:42,moduleUsed:6,lastLogin:'2026-02-10'},
            {name:'Pfaffenhofen',logins:8,bwaUploaded:false,videosDone:0,aufgabenDone:25,moduleUsed:4,lastLogin:'2026-02-06'},
            {name:'Zell',logins:5,bwaUploaded:false,videosDone:0,aufgabenDone:15,moduleUsed:3,lastLogin:'2026-02-03'},
            {name:'Lohmar',logins:6,bwaUploaded:false,videosDone:0,aufgabenDone:20,moduleUsed:3,lastLogin:'2026-02-04'},
            {name:'Garching',logins:4,bwaUploaded:false,videosDone:0,aufgabenDone:10,moduleUsed:2,lastLogin:'2026-02-02'},
            {name:'Dresden',logins:0,bwaUploaded:false,videosDone:0,aufgabenDone:0,moduleUsed:0,lastLogin:'â€”'},
            {name:'Passau (Onb.)',logins:3,bwaUploaded:false,videosDone:0,aufgabenDone:5,moduleUsed:1,lastLogin:'2026-02-01'}
        ];

        var modulNutzung = [
            {name:'Verkauf',icon:'ðŸ’°',pct:92,users:19},
            {name:'Marketing',icon:'ðŸ“£',pct:85,users:18},
            {name:'Einkauf',icon:'ðŸ›’',pct:78,users:16},
            {name:'Controlling / BWA',icon:'ðŸ“Š',pct:71,users:15},
            {name:'Kommunikation',icon:'ðŸ’¬',pct:68,users:14},
            {name:'Social Media',icon:'ðŸ“±',pct:62,users:13},
            {name:'Aktenschrank',icon:'ðŸ“',pct:55,users:12},
            {name:'Kalender',icon:'ðŸ“…',pct:82,users:17},
            {name:'Aufgaben',icon:'ðŸ“‹',pct:75,users:16},
            {name:'Ideenboard',icon:'ðŸ’¡',pct:38,users:8},
            {name:'Support',icon:'ðŸŽ«',pct:45,users:9},
            {name:'Onboarding',icon:'âœ…',pct:95,users:20}
        ];

        function calcScore(p){return Math.round(p.logins*0.3+p.aufgabenDone*0.3+p.moduleUsed*3+p.videosDone*2+(p.bwaUploaded?5:0));}

        function renderHqAuswertung(){
            var sorted=portalNutzung.slice().sort(function(a,b){return calcScore(b)-calcScore(a);});
            var avgLogins=Math.round(portalNutzung.reduce(function(a,p){return a+p.logins;},0)/portalNutzung.length);
            var bwaCount=portalNutzung.filter(function(p){return p.bwaUploaded;}).length;
            var avgScore=Math.round(sorted.reduce(function(a,p){return a+calcScore(p);},0)/sorted.length);
            var inactive=portalNutzung.filter(function(p){return p.logins<5;}).length;
            var avgModules=Math.round(portalNutzung.reduce(function(a,p){return a+p.moduleUsed;},0)/portalNutzung.length*10)/10;

            var kpi=document.getElementById('hqAuswKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+avgScore+'</p><p class="text-xs text-gray-500">Ã˜ Nutzungs-Score</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+avgLogins+'</p><p class="text-xs text-gray-500">Ã˜ Logins/Monat</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold '+(bwaCount>=15?'text-green-600':'text-yellow-600')+'">'+bwaCount+'/21</p><p class="text-xs text-gray-500">BWA hochgeladen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+avgModules+'</p><p class="text-xs text-gray-500">Ã˜ Module genutzt</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold '+(inactive>3?'text-red-500':'text-gray-500')+'">'+inactive+'</p><p class="text-xs text-gray-500">Inaktive Standorte</p></div>';

            // Top 5
            var topEl=document.getElementById('hqAuswTop');
            if(topEl){
                var h='';
                sorted.slice(0,5).forEach(function(p,i){
                    var sc=calcScore(p);
                    h+='<div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg"><span class="text-sm font-bold text-gray-300 w-5">'+(i+1)+'</span><div class="flex-1"><p class="text-xs font-semibold">'+p.name+'</p><p class="text-[10px] text-gray-400">'+p.logins+' Logins Â· '+p.moduleUsed+' Module Â· '+p.videosDone+' Videos</p></div><span class="text-sm font-bold text-green-600">'+sc+'</span></div>';
                });
                topEl.innerHTML=h;
            }

            // Bottom 5
            var botEl=document.getElementById('hqAuswBottom');
            if(botEl){
                var h='';
                sorted.slice(-5).reverse().forEach(function(p,i){
                    var sc=calcScore(p);
                    h+='<div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg"><div class="flex-1"><p class="text-xs font-semibold text-gray-800">'+p.name+'</p><p class="text-[10px] text-gray-400">'+p.logins+' Logins Â· Letzter: '+(p.lastLogin||'nie')+'</p></div><span class="text-sm font-bold '+(sc<10?'text-red-500':'text-yellow-600')+'">'+sc+'</span></div>';
                });
                botEl.innerHTML=h;
            }

            // Module usage
            var modEl=document.getElementById('hqAuswModules');
            if(modEl){
                var h='';
                modulNutzung.sort(function(a,b){return b.pct-a.pct;}).forEach(function(m){
                    h+='<div class="flex items-center space-x-3"><span class="text-sm w-5">'+m.icon+'</span><span class="text-xs w-32 truncate font-semibold">'+m.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full '+(m.pct>=75?'bg-green-500':m.pct>=50?'bg-yellow-500':'bg-red-400')+'" style="width:'+m.pct+'%"></div></div><span class="text-xs font-bold w-16 text-right">'+m.pct+'% ('+m.users+')</span></div>';
                });
                modEl.innerHTML=h;
            }

            // All locations bar
            var allEl=document.getElementById('hqAuswAll');
            if(allEl){
                var h='';
                sorted.forEach(function(p){
                    var sc=calcScore(p);
                    var maxSc=60;
                    var w=Math.min(100,Math.round(sc/maxSc*100));
                    h+='<div class="flex items-center space-x-2"><span class="text-[10px] w-28 truncate">'+p.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-2.5"><div class="h-2.5 rounded-full '+(sc>=30?'bg-green-500':sc>=15?'bg-yellow-500':'bg-red-400')+'" style="width:'+w+'%"></div></div><span class="text-[10px] font-bold w-8 text-right">'+sc+'</span></div>';
                });
                allEl.innerHTML=h;
            }
        }

        // === HQ WISSEN-VERWALTUNG ===
        var hqWissenItems = [
            {titel:'E-Bike Beratungsleitfaden 2026',kat:'handbuch',bereich:'Verkauf',datum:'12.02.2026',status:'live'},
            {titel:'Werkstatt: Bosch CX Gen5 Service',kat:'akademie',bereich:'Werkstatt',datum:'08.02.2026',status:'live'},
            {titel:'Social Media Best Practices Q1',kat:'bestpractice',bereich:'Marketing',datum:'05.02.2026',status:'live'},
            {titel:'Kassensystem Einrichtung',kat:'handbuch',bereich:'Betrieb',datum:'01.02.2026',status:'live'},
            {titel:'FAQ: Garantie-Abwicklung',kat:'faq',bereich:'Verkauf',datum:'28.01.2026',status:'live'},
            {titel:'Leasing-Angebote richtig kalkulieren',kat:'akademie',bereich:'Verkauf',datum:'25.01.2026',status:'live'},
            {titel:'Ladenbau-Konzept Richtlinien',kat:'handbuch',bereich:'Betrieb',datum:'20.01.2026',status:'live'},
            {titel:'Instagram Reels Anleitung',kat:'bestpractice',bereich:'Marketing',datum:'15.01.2026',status:'live'}
        ];
        function renderHqWissen(){
            var el=document.getElementById('hqWissenList');
            if(!el) return;
            var katIcons={akademie:'ðŸŽ“',handbuch:'ðŸ“–',bestpractice:'â­',faq:'â“'};
            var h='';
            hqWissenItems.forEach(function(w,i){
                h+='<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center space-x-3"><span class="text-lg">'+katIcons[w.kat]+'</span><div><p class="text-sm font-semibold text-gray-800">'+w.titel+'</p><p class="text-xs text-gray-500">'+w.bereich+' Â· '+w.datum+'</p></div></div><span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">'+w.status+'</span></div>';
            });
            el.innerHTML=h;
        }
        function addHqWissen(){
            var t=document.getElementById('hqWissenTitel');
            var k=document.getElementById('hqWissenKat');
            if(!t||!t.value.trim()){alert('Bitte Titel eingeben');return;}
            hqWissenItems.unshift({titel:t.value.trim(),kat:k.value,bereich:document.getElementById('hqWissenBereich').value,datum:new Date().toLocaleDateString('de-DE'),status:'live'});
            t.value='';document.getElementById('hqWissenInhalt').value='';
            renderHqWissen();
        }

        // === HQ SUPPORT-ÃœBERSICHT ===
        var hqSupportData = [
            {id:'T-2401',standort:'Grafrath',betreff:'Kassensystem Fehler beim Tagesabschluss',prio:'hoch',status:'offen',datum:'13.02.2026'},
            {id:'T-2402',standort:'Hamburg',betreff:'Schaufenster-Folie loest sich',prio:'mittel',status:'offen',datum:'13.02.2026'},
            {id:'T-2403',standort:'Weilheim',betreff:'Zugang Buchhaltungs-Tool gesperrt',prio:'hoch',status:'in Bearbeitung',datum:'12.02.2026'},
            {id:'T-2404',standort:'Karlsdorf',betreff:'Lieferverzoegerung Shimano Steps',prio:'mittel',status:'offen',datum:'12.02.2026'},
            {id:'T-2405',standort:'Grafrath',betreff:'Portal: BWA-Upload Fehlermeldung',prio:'niedrig',status:'in Bearbeitung',datum:'11.02.2026'},
            {id:'T-2406',standort:'Hamburg',betreff:'Marketing-Material fuer Fruehjahrsaktion',prio:'niedrig',status:'offen',datum:'11.02.2026'},
            {id:'T-2407',standort:'Weilheim',betreff:'Werkstatt-Terminplaner synchronisiert nicht',prio:'hoch',status:'in Bearbeitung',datum:'10.02.2026'}
        ];
        function renderHqSupport(){
            var el=document.getElementById('hqSupportTickets');
            if(!el) return;
            var prioColors={hoch:'bg-red-100 text-red-700',mittel:'bg-yellow-100 text-yellow-700',niedrig:'bg-gray-100 text-gray-600'};
            var statusColors={'offen':'bg-red-50 text-red-600','in Bearbeitung':'bg-blue-50 text-blue-600'};
            var h='';
            hqSupportData.forEach(function(t){
                h+='<div class="p-4 bg-gray-50 rounded-lg"><div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="text-xs font-mono text-gray-400">'+t.id+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(prioColors[t.prio]||'')+'">'+t.prio+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusColors[t.status]||'')+'">'+t.status+'</span></div><span class="text-xs text-gray-400">'+t.datum+'</span></div><p class="text-sm font-semibold text-gray-800">'+t.betreff+'</p><p class="text-xs text-gray-500 mt-1">ðŸ“ '+t.standort+'</p></div>';
            });
            el.innerHTML=h;
            // Stats per location
            var stats={};
            hqSupportData.forEach(function(t){stats[t.standort]=(stats[t.standort]||0)+1;});
            var sEl=document.getElementById('hqSupportStats');
            if(sEl){
                var sh='';
                Object.keys(stats).sort(function(a,b){return stats[b]-stats[a];}).forEach(function(s){
                    sh+='<div class="flex items-center justify-between p-2 bg-gray-50 rounded"><span class="text-sm font-semibold">ðŸ“ '+s+'</span><span class="text-sm font-bold text-gray-800">'+stats[s]+' Tickets</span></div>';
                });
                sEl.innerHTML=sh;
            }
        }

        // === HQ IDEENBOARD (Supabase) ===
        async function renderHqIdeen(filter){
            var el=document.getElementById('hqIdeenList');
            if(!el) return;
            try {
                var query = sb.from('ideen').select('*, users(name), standorte(name)').order('votes', {ascending:false});
                if(filter && filter!=='all') query = query.eq('status', filter);
                var resp = await query;
                if(resp.error) throw resp.error;
                var ideas = resp.data || [];
                var allResp = await sb.from('ideen').select('status');
                var all = allResp.data || [];
                var t=document.getElementById('hqIdeenTotal');if(t)t.textContent=all.length;
                var p=document.getElementById('hqIdeenPruefung');if(p)p.textContent=all.filter(function(i){return i.status==='wird_geprueft'||i.status==='diskussion';}).length;
                var u=document.getElementById('hqIdeenUmgesetzt');if(u)u.textContent=all.filter(function(i){return i.status==='umgesetzt';}).length;
                var a=document.getElementById('hqIdeenAbgelehnt');if(a)a.textContent=all.filter(function(i){return i.status==='abgelehnt';}).length;
                var statusC={neu:'bg-blue-100 text-blue-700',diskussion:'bg-yellow-100 text-yellow-700',wird_geprueft:'bg-yellow-100 text-yellow-700',geplant:'bg-purple-100 text-purple-700',umgesetzt:'bg-green-100 text-green-700',abgelehnt:'bg-red-100 text-red-700'};
                var statusL={neu:'Neu',diskussion:'In Diskussion',wird_geprueft:'Wird gepr\u00fcft',geplant:'Geplant',umgesetzt:'Umgesetzt',abgelehnt:'Abgelehnt'};
                var h='';
                ideas.forEach(function(idee){
                    var standortName = idee.standorte ? idee.standorte.name : 'HQ';
                    var authorName = idee.users ? idee.users.name : 'Unbekannt';
                    var d = idee.created_at ? new Date(idee.created_at).toLocaleDateString('de-DE') : '';
                    h+='<div class="p-4 bg-gray-50 rounded-lg">';
                    h+='<div class="flex items-center justify-between mb-2">';
                    h+='<div class="flex items-center space-x-3">';
                    h+='<span class="text-lg font-bold text-vit-orange">\ud83d\udc4d '+(idee.votes||0)+'</span>';
                    h+='<span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusC[idee.status]||'bg-gray-100 text-gray-600')+'">'+(statusL[idee.status]||idee.status)+'</span>';
                    h+='<select onchange="updateIdeeStatus(\''+idee.id+'\',this.value)" class="text-xs border border-gray-200 rounded px-1 py-0.5">';
                    ['neu','wird_geprueft','geplant','umgesetzt','abgelehnt'].forEach(function(s){
                        h+='<option value="'+s+'"'+(idee.status===s?' selected':'')+'>'+(statusL[s]||s)+'</option>';
                    });
                    h+='</select></div>';
                    h+='<span class="text-xs text-gray-400">'+d+'</span></div>';
                    h+='<p class="text-sm font-semibold text-gray-800">'+idee.titel+'</p>';
                    if(idee.beschreibung) h+='<p class="text-xs text-gray-600 mt-1">'+idee.beschreibung+'</p>';
                    h+='<p class="text-xs text-gray-400 mt-1">\ud83d\udca1 '+authorName+' \u00b7 \ud83d\udccd '+standortName+'</p>';
                    h+='</div>';
                });
                if(ideas.length===0) h='<div class="text-center py-4 text-gray-400">Noch keine Ideen eingereicht.</div>';
                el.innerHTML=h;
            } catch(err) { console.error('HQ Ideen:', err); }
        }
        function filterHqIdeen(filter) {
            document.querySelectorAll('.hq-ideen-filter').forEach(function(b){b.className='hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hq-ideen-filter[data-hif="'+filter+'"]');
            if(btn) btn.className='hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderHqIdeen(filter);
        }
        async function updateIdeeStatus(ideeId, newStatus) {
            try {
                var resp = await sb.from('ideen').update({status: newStatus}).eq('id', ideeId).select();
                if(resp.error) throw resp.error;
                if(!resp.data || resp.data.length === 0) {
                    alert('Status konnte nicht geÃ¤ndert werden â€“ keine Berechtigung.');
                    return;
                }
                renderHqIdeen('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }


        // === HQ SHOP-VERWALTUNG ===
        var hqShopOrders = [
            {nr:'B-20260214-001',standort:'Grafrath',produkte:'3x Polo-Shirt, 2x Roll-Up',summe:309.70,datum:'14.02.2026',status:'in Bearbeitung'},
            {nr:'B-20260213-004',standort:'Hamburg',produkte:'100x Visitenkarten, 50x Flyer',summe:138.90,datum:'13.02.2026',status:'versendet'},
            {nr:'B-20260213-002',standort:'Weilheim',produkte:'5x Trinkflasche, 20x Sattelbezug',summe:122.50,datum:'13.02.2026',status:'versendet'},
            {nr:'B-20260212-001',standort:'Karlsdorf',produkte:'1x Kundenstopper, 2x Fensterfolie',summe:239.00,datum:'12.02.2026',status:'geliefert'},
            {nr:'B-20260211-003',standort:'Hamburg',produkte:'10x Softshell-Jacke',summe:799.00,datum:'11.02.2026',status:'geliefert'}
        ];
        function renderHqShop(){
            // Orders
            var oEl=document.getElementById('hqShopOrders');
            if(oEl){
                var h='';
                var statusC={'in Bearbeitung':'bg-yellow-100 text-yellow-700','versendet':'bg-blue-100 text-blue-700','geliefert':'bg-green-100 text-green-700'};
                hqShopOrders.forEach(function(o){
                    h+='<div class="p-3 bg-gray-50 rounded-lg"><div class="flex items-center justify-between mb-1"><div class="flex items-center space-x-2"><span class="text-xs font-mono text-gray-400">'+o.nr+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusC[o.status]||'')+'">'+o.status+'</span></div><span class="text-sm font-bold text-gray-800">â‚¬ '+o.summe.toFixed(2)+'</span></div><p class="text-xs text-gray-600">'+o.produkte+'</p><p class="text-xs text-gray-400">ðŸ“ '+o.standort+' Â· '+o.datum+'</p></div>';
                });
                oEl.innerHTML=h;
            }
            // Products from shop data
            var pEl=document.getElementById('hqShopProducts');
            if(pEl && typeof shopProducts!=='undefined'){
                var h='';
                shopProducts.forEach(function(p){
                    h+='<div class="flex items-center justify-between p-2 bg-gray-50 rounded"><div class="flex items-center space-x-2"><span>'+p.icon+'</span><span class="text-sm font-semibold">'+p.name+'</span><span class="text-xs text-gray-400">('+p.kat+')</span></div><span class="text-sm font-bold text-gray-800">'+(p.preis>0?'â‚¬ '+p.preis.toFixed(2):'Kostenlos')+'</span></div>';
                });
                pEl.innerHTML=h;
            }
        }
        function addHqShopProduct(){
            var n=document.getElementById('hqShopName');
            var p=document.getElementById('hqShopPreis');
            if(!n||!n.value.trim()){alert('Bitte Produktname eingeben');return;}
            if(typeof shopProducts!=='undefined'){
                shopProducts.push({id:'prod_new_'+Date.now(),name:n.value.trim(),kat:document.getElementById('hqShopKat').value,preis:parseFloat(p.value)||0,icon:'ðŸ†•',beschreibung:document.getElementById('hqShopDesc').value||''});
            }
            n.value='';p.value='';document.getElementById('hqShopDesc').value='';
            renderHqShop();
        }
        var kzStandorte = []; // loaded from Supabase

        var kzMitarbeiter = []; // loaded from Supabase

        var currentKzStdFilter = 'all';
        var currentKzMaFilter = 'all';

        function showKommandoTab(tab) {
            document.querySelectorAll('.kommando-tab-content').forEach(function(el){el.style.display='none';});
            document.querySelectorAll('.kommando-tab-btn').forEach(function(b){
                b.className='kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabEl=document.getElementById('kommandoTab'+tab.charAt(0).toUpperCase()+tab.slice(1));
            if(tabEl)tabEl.style.display='block';
            var btn=document.querySelector('.kommando-tab-btn[data-ktab="'+tab+'"]');
            if(btn)btn.className='kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tab==='standorte') renderKzStandorte();
            if(tab==='mitarbeiter') renderKzMitarbeiter();
            if(tab==='kommunikation') renderHqKomm();
            if(tab==='kampagnen') renderHqKampagnen();
            if(tab==='dokumente') loadNetzwerkDokumente();
            if(tab==='kalender') loadHqKalTermine();
            if(tab==='aufgaben') renderHqAufgaben();
        }

        function filterKzStandorte(f) {
            currentKzStdFilter=f;
            document.querySelectorAll('.kz-std-filter').forEach(function(b){b.className='kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.kz-std-filter[data-kzf="'+f+'"]');
            if(btn)btn.className='kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderKzStandorte();
        }
        function filterKzMa(f) {
            currentKzMaFilter=f;
            document.querySelectorAll('.kz-ma-filter').forEach(function(b){b.className='kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.kz-ma-filter[data-kzmf="'+f+'"]');
            if(btn)btn.className='kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderKzMitarbeiter();
        }

        function statusBadge(s) {
            if(s==='aktiv') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-green-100 text-green-700">ðŸŸ¢ Aktiv</span>';
            if(s==='demo') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700 animate-pulse">ðŸ”´ Demo</span>';
            if(s==='onboarding') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700">ðŸ”µ Onboarding</span>';
            if(s==='pending') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-yellow-100 text-yellow-700">â³ Wartet</span>';
            if(s==='gesperrt') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">ðŸš« Gesperrt</span>';
            if(s==='offboarding') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">ðŸ”´ Offboarding</span>';
            return s;
        }
        function rolleBadge(r) {
            var colors = {'inhaber':'bg-vit-orange text-white','verkauf':'bg-blue-100 text-blue-700','werkstatt':'bg-gray-200 text-gray-700','buchhaltung':'bg-purple-100 text-purple-700','hq':'bg-red-100 text-red-700'};
            var labels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung','hq':'HQ'};
            return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold '+(colors[r]||'bg-gray-100 text-gray-600')+'">'+(labels[r]||r)+'</span>';
        }
        function rollenBadges(rollen) {
            return rollen.map(function(r){ return rolleBadge(r); }).join(' ');
        }

        async function renderKzStandorte() {
            var body=document.getElementById('kzStandorteBody');
            if(!body)return;
            try {
                var resp = await sb.from('standorte').select('*').order('name');
                if(resp.error) throw resp.error;
                var standorte = resp.data || [];
                var countResp = await sb.from('users').select('standort_id');
                var userCounts = {};
                (countResp.data||[]).forEach(function(u){ if(u.standort_id) userCounts[u.standort_id] = (userCounts[u.standort_id]||0)+1; });
                var filter = currentKzStdFilter || 'all';
                var h='';
                standorte.forEach(function(s){
                    var st = s.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return;
                    var d = s.created_at ? new Date(s.created_at) : new Date();
                    var beitritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50">';
                    h+='<td class="px-4 py-3 font-semibold text-gray-800">'+s.name+'</td>';
                    h+='<td class="px-4 py-3 text-gray-600">'+(s.adresse||s.region||'')+'</td>';
                    h+='<td class="px-4 py-3"><span class="text-xs px-2 py-0.5 rounded '+(s.is_premium?'bg-vit-orange text-white':'bg-gray-100 text-gray-600')+'">'+(s.is_premium?'Premium':'Standard')+'</span></td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center font-semibold">'+(userCounts[s.id]||0)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+beitritt+'</td>';
                    h+='<td class="px-4 py-3 text-center text-xs text-gray-500">'+(s.telefon||'â€”')+'</td>';
                    h+='<td class="px-4 py-3 text-center"><button class="text-xs text-vit-orange hover:underline font-semibold" onclick="alert(\''+s.name+'\\nAdresse: '+(s.adresse||'â€“')+'\\nTelefon: '+(s.telefon||'â€“')+'\\nSlug: '+s.slug+'\')">Details â†’</button></td>';
                    h+='</tr>';
                });
                if(standorte.length===0) h='<tr><td colspan="8" class="text-center py-8 text-gray-400">Keine Standorte.</td></tr>';
                body.innerHTML=h;
                var ge=document.getElementById('kzStandorteGesamt');if(ge)ge.textContent=standorte.length;
                var ak=document.getElementById('kzStandorteAktiv');if(ak)ak.textContent=standorte.filter(function(s){return (s.status||'aktiv')==='aktiv';}).length;
                var ob=document.getElementById('kzStandorteOnb');if(ob)ob.textContent=standorte.filter(function(s){return s.status==='onboarding';}).length;
                var of2=document.getElementById('kzStandorteOff');if(of2)of2.textContent=standorte.filter(function(s){return s.status==='offboarding';}).length;
            } catch(err) { console.error('Standorte:', err); body.innerHTML='<tr><td colspan="8" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        async function renderKzMitarbeiter() {
            var body=document.getElementById('kzMaBody');
            if(!body)return;
            try {
                var resp = await sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').order('name');
                if(resp.error) throw resp.error;
                var users = resp.data || [];
                var stdFilter=(document.getElementById('kzMaStandortFilter')||{}).value||'all';
                var filter = currentKzMaFilter || 'all';
                var list = users.filter(function(u){
                    var st = u.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return false;
                    var stdName = u.standorte ? u.standorte.name : 'HQ';
                    if(stdFilter!=='all' && stdName!==stdFilter) return false;
                    return true;
                });
                var h='';
                list.forEach(function(u){
                    var stdName = u.standorte ? u.standorte.name : 'HQ';
                    var rollen = (u.user_rollen||[]).map(function(ur){ return ur.rollen ? ur.rollen.name : ''; }).filter(Boolean);
                    var st = u.status || 'aktiv';
                    var d = u.created_at ? new Date(u.created_at) : new Date();
                    var eintritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    // Action button: Freigeben for onboarding/pending, Details for others
                    var actionBtn = '';
                    if((st === 'onboarding' || st === 'pending') && rollen.length === 0) {
                        actionBtn = '<button class="text-xs px-3 py-1 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600" onclick="approveUser(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">Freigeben</button>';
                    } else {
                        actionBtn = '<button class="text-xs text-vit-orange hover:underline font-semibold" onclick="openEditMaModal(\''+u.id+'\')">âœï¸</button>'
                    +' <button class="text-xs text-blue-500 hover:text-blue-700 hover:underline font-semibold ml-1" onclick="loginAs(\''+u.id+'\',\''+u.email+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ”‘</button>'
                    +' <button class="text-xs text-red-400 hover:text-red-600 hover:underline font-semibold ml-1" onclick="deleteMa(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ—‘ï¸</button>';
                    }
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50'+((st==='onboarding' || st==='pending') && rollen.length===0 ? ' bg-yellow-50':'')+'">';
                    h+='<td class="px-4 py-3"><div class="flex items-center space-x-2"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)+'&background=EF7D00&color=fff&size=28" class="w-7 h-7 rounded-full"><div><span class="font-semibold text-gray-800">'+u.name+'</span><p class="text-[10px] text-gray-400">'+u.email+'</p></div></div></td>';
                    h+='<td class="px-4 py-3 text-gray-600 text-xs">'+stdName+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+(rollen.length > 0 ? rollenBadges(rollen) : '<span class="text-xs text-yellow-600 font-semibold">Wartet auf Freigabe</span>')+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+eintritt+'</td>';
                    h+='<td class="px-4 py-3 text-center"><span class="text-xs text-gray-400">'+(u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.label:'';}).filter(Boolean).join(', ')+'</span></td>';
                    h+='<td class="px-4 py-3 text-center">'+actionBtn+'</td>';
                    h+='</tr>';
                });
                if(list.length===0) h='<tr><td colspan="7" class="text-center py-8 text-gray-400">Keine Mitarbeiter gefunden.</td></tr>';
                body.innerHTML=h;
                var ge=document.getElementById('kzMaGesamt');if(ge)ge.textContent=users.length;
                var ak=document.getElementById('kzMaAktiv');if(ak)ak.textContent=users.filter(function(u){return (u.status||'aktiv')==='aktiv';}).length;
                var onbCount = users.filter(function(u){return u.status==='onboarding';}).length;
                var ob=document.getElementById('kzMaOnb');if(ob)ob.textContent=onbCount;
                var of2=document.getElementById('kzMaOff');if(of2)of2.textContent=users.filter(function(u){return u.status==='offboarding';}).length;
                var ro=document.getElementById('kzRollen');if(ro)ro.textContent='4';
                // Standort dropdown
                var sel=document.getElementById('kzMaStandortFilter');
                if(sel && sel.options.length<=1){
                    var standorte=[];
                    users.forEach(function(u){ var sn=u.standorte?u.standorte.name:'HQ'; if(standorte.indexOf(sn)===-1)standorte.push(sn); });
                    standorte.sort().forEach(function(s){sel.innerHTML+='<option value="'+s+'">'+s+'</option>';});
                }
            } catch(err) { console.error('Mitarbeiter:', err); body.innerHTML='<tr><td colspan="7" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        // === USER FREIGABE (mit Ebene-Logik) ===
        var approveEbene = 'standort';
        
        async function approveUser(userId, userName) {
            approveEbene = 'standort';
            
            // User-Daten laden fÃ¼r Standort-Info
            var userResp = await sb.from('users').select('*, standorte(name)').eq('id', userId).single();
            var userData = userResp.data || {};
            var currentStandortId = userData.standort_id || '';
            var currentStandortName = userData.standorte ? userData.standorte.name : '';
            
            var html = '<div id="approveOverlay" onclick="closeApproveModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">User freigeben</h3><button onclick="closeApproveModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-600 mb-4"><strong>'+userName+'</strong> hat sich registriert und wartet auf Freigabe.'+(currentStandortName ? ' <span class="text-xs text-gray-400">(GewÃ¼nschter Standort: '+currentStandortName+')</span>' : '')+'</p>';
            
            // === EBENE (HQ vs Standort) ===
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
            html += '<div class="flex space-x-2">';
            html += '<button type="button" id="approveEbeneHQ" onclick="switchApproveEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300">\ud83c\udfe2 HQ</button>';
            html += '<button type="button" id="approveEbeneStd" onclick="switchApproveEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700">\ud83c\udfea Standort</button>';
            html += '</div></div>';
            
            // Standort Dropdown
            html += '<div id="approveStandortWrap"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="approveStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';
            html += '</div>';
            
            // === ROLLEN (dynamisch basierend auf Ebene) ===
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen zuweisen</p>';
            
            // HQ Rollen (initial hidden)
            html += '<div id="approveRollesHQ" style="display:none">';
            html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
            html += '<input type="checkbox" id="approveRole_hq" class="rounded" style="accent-color:#EF7D00;" checked>';
            html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
            html += '</div>';
            
            // Standort Rollen (initial visible)
            html += '<div id="approveRollesStd">';
            var stdRollen = ['inhaber','verkauf','werkstatt','buchhaltung'];
            var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
            stdRollen.forEach(function(r){
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="approveRole_'+r+'" class="rounded" style="accent-color:#EF7D00;">';
                html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
            });
            html += '</div>';
            
            html += '<div id="approveError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
            html += '<div class="flex space-x-3 mt-4">';
            html += '<button id="approveSaveBtn" onclick="confirmApprove(\''+userId+'\')" class="flex-1 py-2.5 bg-green-500 text-white rounded-lg font-semibold text-sm hover:bg-green-600">\u2705 Freigeben</button>';
            html += '<button onclick="rejectUser(\''+userId+'\')" class="py-2.5 px-4 bg-red-100 text-red-600 rounded-lg font-semibold text-sm hover:bg-red-200">\u274c Ablehnen</button>';
            html += '<button onclick="closeApproveModal()" class="py-2.5 px-4 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button>';
            html += '</div>';
            html += '</div></div>';
            
            var c = document.createElement('div');
            c.id = 'approveContainer';
            c.innerHTML = html;
            document.body.appendChild(c);
            
            // Standorte laden
            setTimeout(async function(){
                try {
                    var stdResp = await sb.from('standorte').select('id,name').order('name');
                    var sel = document.getElementById('approveStandort');
                    if(sel && stdResp.data) {
                        sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                        stdResp.data.forEach(function(s){
                            var selected = (currentStandortId === s.id) ? ' selected' : '';
                            sel.innerHTML += '<option value="'+s.id+'"'+selected+'>'+s.name+'</option>';
                        });
                    }
                } catch(e){ console.error(e); }
            }, 100);
        }
        
        function switchApproveEbene(ebene) {
            approveEbene = ebene;
            var hqBtn = document.getElementById('approveEbeneHQ');
            var stdBtn = document.getElementById('approveEbeneStd');
            var stdWrap = document.getElementById('approveStandortWrap');
            var rollesHQ = document.getElementById('approveRollesHQ');
            var rollesStd = document.getElementById('approveRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk) hqChk.checked = true;
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('approveRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeApproveModal() {
            var c = document.getElementById('approveContainer');
            if(c) c.remove();
        }

        async function confirmApprove(userId) {
            var errEl = document.getElementById('approveError');
            if(errEl) errEl.style.display = 'none';
            
            // Rollen basierend auf Ebene sammeln
            var selected = [];
            var isHqUser = (approveEbene === 'hq');
            if(isHqUser) {
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk && hqChk.checked) selected.push('hq');
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('approveRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
            }
            if(selected.length === 0) { 
                if(errEl) { errEl.textContent = 'Bitte mindestens eine Rolle zuweisen.'; errEl.style.display = 'block'; }
                return; 
            }
            
            // Standort-Pflicht fÃ¼r Standort-User
            var standortId = null;
            if(!isHqUser) {
                var stdSel = document.getElementById('approveStandort');
                standortId = stdSel ? stdSel.value : null;
                if(!standortId) {
                    if(errEl) { errEl.textContent = 'Bitte einen Standort wÃ¤hlen.'; errEl.style.display = 'block'; }
                    return;
                }
            }
            
            var btn = document.getElementById('approveSaveBtn');
            if(btn) { btn.disabled = true; btn.textContent = 'Wird freigeschaltet...'; }
            
            try {
                // 1. Status auf aktiv + is_hq + Standort setzen
                var updateData = { 
                    status: 'aktiv', 
                    is_hq: isHqUser,
                    standort_id: isHqUser ? null : standortId
                };
                var upd = await sb.from('users').update(updateData).eq('id', userId);
                if(upd.error) throw upd.error;
                
                // 2. Rollen-IDs holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                
                // 3. Bestehende Rollen lÃ¶schen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                
                // 4. Neue Rollen zuweisen
                var rollenInserts = selected.map(function(roleName){
                    return { user_id: userId, rolle_id: rollenMap[roleName] };
                }).filter(function(ri){ return ri.rolle_id; });
                
                if(rollenInserts.length > 0) {
                    var insResp = await sb.from('user_rollen').insert(rollenInserts);
                    if(insResp.error) throw insResp.error;
                }
                
                closeApproveModal();
                var rollenLabels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                alert('\u2705 User freigeschaltet!\nRollen: ' + selected.map(function(r){return rollenLabels[r]||r;}).join(', ') + '\n\nDer Mitarbeiter kann sich jetzt einloggen.');
                renderKzMitarbeiter();
            } catch(err) {
                if(errEl) { errEl.textContent = 'Fehler: ' + err.message; errEl.style.display = 'block'; }
                if(btn) { btn.disabled = false; btn.textContent = '\u2705 Freigeben'; }
            }
        }

        async function rejectUser(userId) {
            if(!confirm('User wirklich ablehnen? Der Account wird gesperrt.')) return;
            try {
                await sb.from('users').update({status: 'gesperrt'}).eq('id', userId);
                closeApproveModal();
                alert('User abgelehnt und gesperrt.');
                renderKzMitarbeiter();
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        // === ROLLEN-MODAL ===
        function openRollenModal(maIdx) {
            var m = kzMitarbeiter[maIdx];
            if(!m) return;
            var allRollen = ['hq','inhaber','verkauf','werkstatt','buchhaltung'];
            var labels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var desc = {'inhaber':'Vollzugriff auf alle Module, Dashboards, Shop, Onboarding','verkauf':'Verkauf, Marketing, Wissen, Support, Ideenboard','werkstatt':'Einkauf, Wissen, Support, Ideenboard','buchhaltung':'Allgemein, Verkauf, Einkauf, Controlling, Aktenschrank'};

            var html = '<div id="rollenModalOverlay" onclick="closeRollenModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Rollen bearbeiten</h3><button onclick="closeRollenModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            html += '<div class="flex items-center space-x-3 mb-5 pb-4 border-b"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(m.name)+'&background=EF7D00&color=fff&size=40" class="w-10 h-10 rounded-full"><div><p class="font-semibold text-gray-800">'+m.name+'</p><p class="text-xs text-gray-500">'+m.standort+' Â· '+m.email+'</p></div></div>';
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Rollen zuweisen (Mehrfachauswahl)</p>';
            allRollen.forEach(function(r){
                var checked = m.rollen.indexOf(r)>=0 ? 'checked' : '';
                var colors = {'hq':'border-red-300 bg-red-50','inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
                html += '<label class="flex items-start space-x-3 p-3 rounded-lg border '+colors[r]+' mb-2 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="roleChk_'+r+'" '+checked+' class="mt-1 rounded" style="accent-color:#EF7D00;">';
                html += '<div><p class="font-semibold text-sm text-gray-800">'+labels[r]+'</p><p class="text-[11px] text-gray-500">'+desc[r]+'</p></div>';
                html += '</label>';
            });
            html += '<div class="flex space-x-3 mt-5"><button onclick="saveRollen('+maIdx+')" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
            html += '<button onclick="closeRollenModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';

            var container = document.createElement('div');
            container.id = 'rollenModalContainer';
            container.innerHTML = html;
            document.body.appendChild(container);
        }
        function closeRollenModal() {
            var c = document.getElementById('rollenModalContainer');
            if(c) c.remove();
        }
        function saveRollen(maIdx) {
            var allRollen = ['hq','inhaber','verkauf','werkstatt','buchhaltung'];
            var selected = [];
            allRollen.forEach(function(r){
                var chk = document.getElementById('roleChk_'+r);
                if(chk && chk.checked) selected.push(r);
            });
            if(selected.length===0) { alert('Mindestens eine Rolle muss zugewiesen werden.'); return; }
            kzMitarbeiter[maIdx].rollen = selected;
            closeRollenModal();
            renderKzMitarbeiter();

            var labels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var names = selected.map(function(r){return labels[r];}).join(', ');
            alert('âœ… Rollen fÃ¼r '+kzMitarbeiter[maIdx].name+' gespeichert:\n'+names);
        }

        // === PARTNER MITARBEITER-VERWALTUNG (GF-Ebene) ===
        var currentPartnerMaFilter = 'all';

        function getStandortName() {
            if(currentLocation && locations[currentLocation]) return locations[currentLocation].name;
            return 'Grafrath';
        }

        function getPartnerMitarbeiter() {
            var sName = getStandortName();
            return kzMitarbeiter.filter(function(m){ return m.standort === sName; });
        }

        function filterPartnerMa(f) {
            currentPartnerMaFilter = f;
            document.querySelectorAll('.p-ma-filter').forEach(function(b){
                b.className='p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';
            });
            var btn=document.querySelector('.p-ma-filter[data-pmf="'+f+'"]');
            if(btn) btn.className='p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderPartnerMitarbeiter();
        }

        async function renderPartnerMitarbeiter() {
            var body=document.getElementById('partnerMaBody');
            if(!body) return;
            try {
                // Nur Mitarbeiter des eigenen Standorts laden
                var query = sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').order('name');
                if(sbStandort && sbStandort.id) {
                    query = query.eq('standort_id', sbStandort.id);
                }
                var resp = await query;
                if(resp.error) throw resp.error;
                var users = resp.data || [];
                var filter = currentPartnerMaFilter || 'all';
                var list = users.filter(function(u){
                    var st = u.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return false;
                    return true;
                });
                // KPIs
                var ge=document.getElementById('pMaGesamt');if(ge)ge.textContent=users.length;
                var ak=document.getElementById('pMaAktiv');if(ak)ak.textContent=users.filter(function(u){return (u.status||'aktiv')==='aktiv';}).length;
                var ob=document.getElementById('pMaOnb');if(ob)ob.textContent=users.filter(function(u){return u.status==='onboarding';}).length;
                var h='';
                list.forEach(function(u){
                    var rollen = (u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.name:'';}).filter(Boolean);
                    var st = u.status || 'aktiv';
                    var d = u.created_at ? new Date(u.created_at) : new Date();
                    var eintritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50">';
                    h+='<td class="px-4 py-3"><div class="flex items-center space-x-2"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)+'&background=EF7D00&color=fff&size=28" class="w-7 h-7 rounded-full"><span class="font-semibold text-gray-800">'+u.name+'</span></div></td>';
                    h+='<td class="px-4 py-3 text-gray-500 text-xs">'+u.email+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+rollenBadges(rollen)+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+eintritt+'</td>';
                    h+='<td class="px-4 py-3 text-center"><div class="flex justify-center space-x-2">';
                    h+='<button class="text-xs text-vit-orange hover:underline font-semibold" onclick="openEditMaModal(\''+u.id+'\')">âœï¸</button>';
                    h+='<button class="text-xs text-red-400 hover:underline font-semibold" onclick="deleteMa(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ—‘ï¸</button>';
                    h+='</div></td>';
                    h+='</tr>';
                });
                if(list.length===0) h='<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Keine Mitarbeiter gefunden.</td></tr>';
                body.innerHTML=h;
            } catch(err) { console.error('Partner-MA:', err); body.innerHTML='<tr><td colspan="6" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        function deactivateMa(idx) {
            // Deprecated - use openEditMaModal instead
        }

        // Neuer Mitarbeiter Modal
        var newMaEbene = 'standort'; // tracks current ebene selection in create modal
        
        function openNeuerMaModal() {
            var isHQ = currentRoles.indexOf('hq') >= 0 || (sbProfile && sbProfile.is_hq);
            newMaEbene = 'standort';

            var html = '<div id="neuerMaOverlay" onclick="closeNeuerMaModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Neuen Mitarbeiter anlegen</h3><button onclick="closeNeuerMaModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            
            // Name fields
            html += '<div class="space-y-3 mb-4">';
            html += '<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-semibold text-gray-600 mb-1">Vorname *</label><input id="newMaVorname" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Max"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Nachname *</label><input id="newMaNachname" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Mustermann"></div></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail *</label><input id="newMaEmail" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@vitbikes-standort.de"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Passwort * (min. 8 Zeichen)</label><input id="newMaPassword" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="VitBikes2026!"></div>';

            // === EBENE (HQ vs Standort) â€“ nur fÃ¼r HQ-Admins sichtbar ===
            if(isHQ) {
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
                html += '<div class="flex space-x-2">';
                html += '<button type="button" id="newMaEbeneHQ" onclick="switchNewMaEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300">\ud83c\udfe2 HQ</button>';
                html += '<button type="button" id="newMaEbeneStd" onclick="switchNewMaEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700">\ud83c\udfea Standort</button>';
                html += '</div></div>';
            }

            // Standort Dropdown (visible when Ebene = Standort)
            if(isHQ) {
                html += '<div id="newMaStandortWrap"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="newMaStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';
            } else {
                // GF: Standort ist fix der eigene
                var stdName = sbStandort ? sbStandort.name : 'Dein Standort';
                var stdId = sbStandort ? sbStandort.id : '';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Standort</label><input type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 text-gray-500" value="'+stdName+'" disabled><input type="hidden" id="newMaStandort" value="'+stdId+'"></div>';
            }
            html += '</div>';

            // === ROLLEN (dynamisch basierend auf Ebene) ===
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen zuweisen</p>';

            // HQ Rollen (initial hidden)
            html += '<div id="newMaRollesHQ" style="display:none">';
            html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
            html += '<input type="checkbox" id="newMaRole_hq" class="rounded" style="accent-color:#EF7D00;" checked>';
            html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
            html += '<p class="text-[10px] text-gray-400 ml-1 mb-2">Weitere HQ-Rollen kommen bald (z.B. HQ Marketing, HQ Finanzen)</p>';
            html += '</div>';

            // Standort Rollen (initial visible)
            html += '<div id="newMaRollesStd">';
            var stdRollen = isHQ ? ['inhaber','verkauf','werkstatt','buchhaltung'] : ['verkauf','werkstatt','buchhaltung'];
            var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
            stdRollen.forEach(function(r){
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="newMaRole_'+r+'" class="rounded" style="accent-color:#EF7D00;">';
                html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
            });
            html += '</div>';

            if(!isHQ) { html += '<p class="text-xs text-blue-600 bg-blue-50 rounded-lg p-2 mt-2">\ud83d\udccd Mitarbeiter wird deinem Standort zugeordnet.</p>'; }
            html += '<div id="newMaError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
            html += '<div class="flex space-x-3 mt-4"><button id="newMaSaveBtn" onclick="saveNeuerMa()" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Anlegen</button>';
            html += '<button onclick="closeNeuerMaModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'neuerMaContainer'; c.innerHTML = html; document.body.appendChild(c);
            if(isHQ) {
                setTimeout(async function(){
                    try {
                        var stdResp = await sb.from('standorte').select('id,name').order('name');
                        var sel = document.getElementById('newMaStandort');
                        if(sel && stdResp.data) {
                            sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                            stdResp.data.forEach(function(s){ sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>'; });
                        }
                    } catch(e){ console.error(e); }
                }, 100);
            }
        }

        function switchNewMaEbene(ebene) {
            newMaEbene = ebene;
            var hqBtn = document.getElementById('newMaEbeneHQ');
            var stdBtn = document.getElementById('newMaEbeneStd');
            var stdWrap = document.getElementById('newMaStandortWrap');
            var rollesHQ = document.getElementById('newMaRollesHQ');
            var rollesStd = document.getElementById('newMaRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                // Auto-check HQ role
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk) hqChk.checked = true;
                // Uncheck standort roles
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('newMaRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                // Uncheck HQ role
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeNeuerMaModal() { var c = document.getElementById('neuerMaContainer'); if(c) c.remove(); }

        async function saveNeuerMa() {
            var vorname = (document.getElementById('newMaVorname')||{}).value||'';
            var nachname = (document.getElementById('newMaNachname')||{}).value||'';
            var email = (document.getElementById('newMaEmail')||{}).value||'';
            var pw = (document.getElementById('newMaPassword')||{}).value||'';
            var stdSel = document.getElementById('newMaStandort');
            var standortId = stdSel ? stdSel.value : null;
            var errEl = document.getElementById('newMaError');
            if(errEl) errEl.style.display = 'none';

            if(!vorname.trim() || !nachname.trim() || !email.trim()) { if(errEl){errEl.textContent='Bitte Vorname, Nachname und E-Mail ausfÃ¼llen.';errEl.style.display='block';} return; }
            if(!pw || pw.length < 8) { if(errEl){errEl.textContent='Passwort muss mindestens 8 Zeichen haben.';errEl.style.display='block';} return; }

            // Rollen basierend auf Ebene sammeln
            var selected = [];
            var isHqUser = (newMaEbene === 'hq');
            if(isHqUser) {
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk && hqChk.checked) selected.push('hq');
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('newMaRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
                // Standort-Pflicht prÃ¼fen
                if(!standortId) { if(errEl){errEl.textContent='Bitte einen Standort wÃ¤hlen.';errEl.style.display='block';} return; }
            }
            if(selected.length===0) { if(errEl){errEl.textContent='Bitte mindestens eine Rolle zuweisen.';errEl.style.display='block';} return; }

            var btn = document.getElementById('newMaSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird angelegt...'; }

            var isHqUser = selected.indexOf('hq') >= 0;

            try {
                // Rollen-IDs aus der DB holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                var rollenIds = selected.map(function(r){ return rollenMap[r]; }).filter(Boolean);

                // Aktuelle Admin-Session sichern (signUp erstellt neue Session!)
                var adminSession = await sb.auth.getSession();
                var adminToken = adminSession.data.session ? adminSession.data.session.access_token : null;
                var adminRefresh = adminSession.data.session ? adminSession.data.session.refresh_token : null;

                // User direkt Ã¼ber Auth API erstellen (ohne Edge Function)
                var signUpResp = await sb.auth.signUp({
                    email: email.trim().toLowerCase(),
                    password: pw,
                    options: {
                        data: {
                            vorname: vorname.trim(),
                            nachname: nachname.trim(),
                            name: vorname.trim() + ' ' + nachname.trim()
                        }
                    }
                });

                // Admin-Session sofort wiederherstellen!
                if(adminRefresh) {
                    await sb.auth.setSession({ access_token: adminToken, refresh_token: adminRefresh });
                    console.log('[CreateUser] Admin session restored');
                }

                if(signUpResp.error) throw { message: 'Auth-Fehler: ' + signUpResp.error.message };
                if(!signUpResp.data.user) throw { message: 'User konnte nicht erstellt werden' };

                var newUserId = signUpResp.data.user.id;
                console.log('[CreateUser] Auth user created:', newUserId);

                // Kurz warten damit der DB-Trigger das Profil erstellen kann
                await new Promise(function(resolve) { setTimeout(resolve, 1500); });

                // Profil updaten (DB-Trigger hat es mit status='pending' erstellt)
                var updateData = {
                    name: vorname.trim() + ' ' + nachname.trim(),
                    vorname: vorname.trim(),
                    nachname: nachname.trim(),
                    is_hq: isHqUser,
                    standort_id: isHqUser ? null : (standortId || null),
                    status: 'aktiv'
                };

                var profileResp = await sb.from('users').update(updateData).eq('id', newUserId).select();
                console.log('[CreateUser] Profile update result:', profileResp.error ? profileResp.error.message : 'OK', profileResp.data);
                
                // Fallback: Wenn update fehlschlÃ¤gt, versuche insert
                if(profileResp.error || !profileResp.data || profileResp.data.length === 0) {
                    console.log('[CreateUser] Update failed, trying insert...');
                    var insertData = Object.assign({id: newUserId, email: email.trim().toLowerCase(), created_at: new Date().toISOString()}, updateData);
                    var insResp = await sb.from('users').insert(insertData).select();
                    console.log('[CreateUser] Profile insert result:', insResp.error ? insResp.error.message : 'OK');
                }

                // Rollen zuweisen
                if(rollenIds.length > 0) {
                    // Erst alte Rollen lÃ¶schen (falls vorhanden)
                    await sb.from('user_rollen').delete().eq('user_id', newUserId);
                    
                    var rollenInserts = rollenIds.map(function(rid) {
                        return { user_id: newUserId, rollen_id: rid };
                    });
                    var rollenInsResp = await sb.from('user_rollen').insert(rollenInserts);
                    console.log('[CreateUser] Rollen insert result:', rollenInsResp.error ? rollenInsResp.error.message : 'OK (' + selected.join(', ') + ')');
                }

                // Passwort setzen (falls signUp ein confirmation-basiertes System nutzt)
                try {
                    var pwResp = await sb.rpc('set_user_password', { user_id: newUserId, new_password: pw });
                    if(pwResp.error) console.warn('[CreateUser] set_user_password warning:', pwResp.error);
                } catch(pwErr) {
                    console.warn('[CreateUser] Password set skipped:', pwErr);
                }

                closeNeuerMaModal();
                var rollenLabels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                alert('\u2705 Mitarbeiter angelegt!\n'+vorname.trim()+' '+nachname.trim()+'\nRollen: '+selected.map(function(r){return rollenLabels[r]||r;}).join(', ')+'\n\nDer Mitarbeiter kann sich sofort mit seinem Passwort anmelden.');
                renderKzMitarbeiter();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+(err.message||err);errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Anlegen'; }
            }
        }

        // === MITARBEITER BEARBEITEN ===
        async function openEditMaModal(userId) {
            try {
                var resp = await sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').eq('id', userId).single();
                if(resp.error) throw resp.error;
                var u = resp.data;
                var userRollen = (u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.name:'';}).filter(Boolean);
                var isUserHQ = u.is_hq || false;
                editMaEbene = isUserHQ ? 'hq' : 'standort';

                var html = '<div id="editMaOverlay" onclick="closeEditMaModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
                html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
                html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Mitarbeiter bearbeiten</h3><button onclick="closeEditMaModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
                html += '<div class="space-y-3 mb-4">';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Name</label><input id="editMaName" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="'+u.name+'"></div>';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail</label><input id="editMaEmail" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="'+u.email+'"></div>';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Neues Passwort (leer lassen = unverÃ¤ndert)</label><input id="editMaPassword" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Neues Passwort eingeben..."></div>';

                // === EBENE (HQ vs Standort) ===
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
                html += '<div class="flex space-x-2">';
                html += '<button type="button" id="editMaEbeneHQ" onclick="switchEditEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition '+(isUserHQ?'border-red-500 bg-red-50 text-red-700':'border-gray-200 bg-white text-gray-500 hover:border-gray-300')+'">ðŸ¢ HQ</button>';
                html += '<button type="button" id="editMaEbeneStd" onclick="switchEditEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition '+(!isUserHQ?'border-vit-orange bg-orange-50 text-orange-700':'border-gray-200 bg-white text-gray-500 hover:border-gray-300')+'">ðŸª Standort</button>';
                html += '</div></div>';

                // Standort (hidden for HQ)
                html += '<div id="editMaStandortWrap" style="'+(isUserHQ?'display:none':'')+'"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort</label><select id="editMaStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';

                // Status
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Status</label><select id="editMaStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
                html += '<option value="aktiv"'+(u.status==='aktiv'?' selected':'')+'>Aktiv</option>';
                html += '<option value="demo"'+(u.status==='demo'?' selected':'')+'>ðŸ”´ Demomodus</option>';
                html += '<option value="onboarding"'+(u.status==='onboarding'?' selected':'')+'>Onboarding</option>';
                html += '<option value="offboarding"'+(u.status==='offboarding'?' selected':'')+'>Offboarding</option>';
                html += '</select></div>';
                html += '</div>';

                // === ROLLEN (dynamic based on Ebene) ===
                html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen</p>';

                // HQ Roles
                html += '<div id="editMaRollesHQ" style="'+(isUserHQ?'':'display:none')+'">';
                var hqChecked = userRollen.indexOf('hq') >= 0 ? ' checked' : '';
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="editMaRole_hq" class="rounded" style="accent-color:#EF7D00;"'+hqChecked+'>';
                html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
                html += '<p class="text-[10px] text-gray-400 ml-1 mb-2">Weitere HQ-Rollen kommen bald (z.B. HQ Marketing, HQ Finanzen)</p>';
                html += '</div>';

                // Standort Roles
                html += '<div id="editMaRollesStd" style="'+(!isUserHQ?'':'display:none')+'">';
                var stdRollen = ['inhaber','verkauf','werkstatt','buchhaltung'];
                var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
                stdRollen.forEach(function(r){
                    var checked = userRollen.indexOf(r) >= 0 ? ' checked' : '';
                    html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                    html += '<input type="checkbox" id="editMaRole_'+r+'" class="rounded" style="accent-color:#EF7D00;"'+checked+'>';
                    html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
                });
                html += '</div>';

                html += '<div id="editMaError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
                html += '<div class="flex space-x-3 mt-4">';
                html += '<button id="editMaSaveBtn" onclick="saveEditMa(\''+userId+'\')" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
                html += '<button onclick="closeEditMaModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button>';
                html += '</div></div></div>';

                var c = document.createElement('div'); c.id = 'editMaContainer'; c.innerHTML = html; document.body.appendChild(c);

                // Load standorte dropdown
                setTimeout(async function(){
                    try {
                        var stdResp = await sb.from('standorte').select('id,name').order('name');
                        var sel = document.getElementById('editMaStandort');
                        if(sel && stdResp.data) {
                            sel.innerHTML = '<option value="hq">HQ (kein Standort)</option>';
                            stdResp.data.forEach(function(s){
                                var selected = (u.standort_id === s.id) ? ' selected' : '';
                                sel.innerHTML += '<option value="'+s.id+'"'+selected+'>'+s.name+'</option>';
                            });
                        }
                    } catch(e){}
                }, 100);
            } catch(err) { alert('Fehler: '+err.message); }
        }

        var editMaEbene = 'standort'; // tracks current ebene selection in edit modal
        function switchEditEbene(ebene) {
            editMaEbene = ebene;
            var hqBtn = document.getElementById('editMaEbeneHQ');
            var stdBtn = document.getElementById('editMaEbeneStd');
            var stdWrap = document.getElementById('editMaStandortWrap');
            var rollesHQ = document.getElementById('editMaRollesHQ');
            var rollesStd = document.getElementById('editMaRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                // Auto-check HQ role
                var hqChk = document.getElementById('editMaRole_hq');
                if(hqChk) hqChk.checked = true;
                // Uncheck standort roles
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('editMaRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                // Uncheck HQ role
                var hqChk = document.getElementById('editMaRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeEditMaModal() { var c = document.getElementById('editMaContainer'); if(c) c.remove(); }

        async function saveEditMa(userId) {
            var name = (document.getElementById('editMaName')||{}).value||'';
            var email = (document.getElementById('editMaEmail')||{}).value||'';
            var pw = (document.getElementById('editMaPassword')||{}).value||'';
            var standortId = (document.getElementById('editMaStandort')||{}).value||'';
            var status = (document.getElementById('editMaStatus')||{}).value||'aktiv';
            var isHQ = editMaEbene === 'hq';
            var errEl = document.getElementById('editMaError');
            if(errEl) errEl.style.display = 'none';

            if(!name.trim() || !email.trim()) { if(errEl){errEl.textContent='Name und E-Mail sind Pflicht.';errEl.style.display='block';} return; }
            if(!isHQ && (!standortId || standortId === 'hq')) { if(errEl){errEl.textContent='Bitte einen Standort zuweisen.';errEl.style.display='block';} return; }

            // Collect roles based on ebene
            var selected = [];
            if(isHQ) {
                selected = ['hq'];
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('editMaRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
            }
            if(selected.length===0) { if(errEl){errEl.textContent='Mindestens eine Rolle nÃ¶tig.';errEl.style.display='block';} return; }

            var btn = document.getElementById('editMaSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }

            try {
                // 1. Users-Tabelle updaten
                var upd = await sb.from('users').update({
                    name: name.trim(),
                    email: email.trim().toLowerCase(),
                    standort_id: isHQ ? null : standortId,
                    is_hq: isHQ,
                    status: status
                }).eq('id', userId);
                if(upd.error) throw upd.error;

                // 2. Passwort Ã¤ndern (via set_user_password)
                if(pw && pw.length >= 6) {
                    var pwResp = await sb.rpc('set_user_password', { user_id: userId, new_password: pw });
                    if(pwResp && pwResp.error) console.warn('Passwort-Update:', pwResp.error.message);
                }

                // 3. Rollen: alte lÃ¶schen, neue setzen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                
                // Rollen-IDs holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                
                var rollenInserts = selected.map(function(roleName){
                    return { user_id: userId, rolle_id: rollenMap[roleName] };
                }).filter(function(ri){ return ri.rolle_id; });
                
                if(rollenInserts.length > 0) {
                    var insResp = await sb.from('user_rollen').insert(rollenInserts);
                    if(insResp.error) console.warn('Rollen-Zuweisung:', insResp.error.message);
                }

                closeEditMaModal();
                alert('\u2705 Mitarbeiter aktualisiert!');
                renderKzMitarbeiter();
                // If this user's status changed, re-check demo mode
                if(sbProfile && userId === sbProfile.id) {
                    sbProfile.status = status;
                    checkDemoMode();
                } else if(status === 'demo' || (sbProfile && sbProfile.status === 'demo')) {
                    // If any user was set to/from demo while viewing as that user
                    checkDemoMode();
                }
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+(err.message||err);errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Speichern'; }
            }
        }


        // === ALS USER ANMELDEN (ohne Passwort) ===
        async function loginAs(userId, email, userName) {
            if(!confirm('Als "'+userName+'" anmelden?\n\nDu wirst als dieser User eingeloggt um die Rechte zu testen.')) return;
            try {
                // 1. TemporÃ¤res Passwort setzen
                var tempPw = '_TempLogin_' + Date.now();
                await sb.rpc('set_user_password', { user_id: userId, new_password: tempPw });
                
                // 2. Ausloggen
                await sb.auth.signOut();
                
                // 3. Mit temporÃ¤rem Passwort einloggen
                var resp = await sb.auth.signInWithPassword({ email: email, password: tempPw });
                if(resp.error) throw resp.error;
                sbUser = resp.data.user;
                await loadUserProfile(sbUser.id);
                await loadModulStatus();
                enterApp();
                try { await loadPipelineFromSupabase(); } catch(e) {}
            } catch(err) {
                alert('Login fehlgeschlagen: '+(err.message||err)+'\n\nSeite wird neu geladen.');
                location.reload();
            }
        }

        // === MITARBEITER LÃ–SCHEN ===
        async function deleteMa(userId, userName) {
            if(!confirm('Mitarbeiter "'+userName+'" wirklich lÃ¶schen?\n\nDies lÃ¶scht den Account komplett (Auth + Profil + Rollen).')) return;
            try {
                // 1. Rollen lÃ¶schen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                // 2. User-Profil lÃ¶schen
                await sb.from('users').delete().eq('id', userId);
                // 3. Auth-User lÃ¶schen (via DB-Funktion)
                await sb.rpc('delete_auth_user', { target_user_id: userId });
                alert('\u2705 '+userName+' wurde gelÃ¶scht.');
                renderKzMitarbeiter();
            } catch(err) {
                // Auch bei Fehler beim Auth-LÃ¶schen: Profil ist bereits weg
                if(err.message && err.message.includes('delete_auth_user')) {
                    alert('\u2705 '+userName+' Profil gelÃ¶scht.\n\u26a0\ufe0f Auth-User muss manuell im Supabase Dashboard entfernt werden.');
                    renderKzMitarbeiter();
                } else {
                    alert('Fehler: '+(err.message||err));
                }
            }
        }

        // === NEUER STANDORT MODAL ===
        function openNeuerStandortModal() {
            var html = '<div id="neuerStdOverlay" onclick="closeNeuerStdModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Neuen Standort anlegen</h3><button onclick="closeNeuerStdModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-5">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Name *</label><input id="newStdName" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="z.B. vit:bikes MÃ¼nchen"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Slug * (URL-Key, nur Kleinbuchstaben)</label><input id="newStdSlug" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="z.B. muenchen"></div>';
            html += '<div class="grid grid-cols-2 gap-3">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Region</label><select id="newStdRegion" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option>SÃ¼d</option><option>Nord</option><option>West</option><option>Ost</option><option>Mitte</option></select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Status</label><select id="newStdStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="onboarding">Onboarding</option><option value="aktiv">Aktiv</option></select></div>';
            html += '</div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Adresse</label><input id="newStdAdresse" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="StraÃŸe, PLZ Ort"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Telefon</label><input id="newStdTelefon" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="+49 ..."></div>';
            html += '<div><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="newStdPremium" style="accent-color:#EF7D00;"><span class="text-sm text-gray-700">Premium-Partner</span></label></div>';
            html += '</div>';
            html += '<div class="flex space-x-3"><button onclick="saveNeuerStandort()" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Anlegen</button>';
            html += '<button onclick="closeNeuerStdModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';
            var container = document.createElement('div');
            container.id = 'neuerStdContainer';
            container.innerHTML = html;
            document.body.appendChild(container);
            // Auto-generate slug from name
            var nameInput = document.getElementById('newStdName');
            if(nameInput) nameInput.addEventListener('input', function(){
                var slug = this.value.toLowerCase().replace(/vit:bikes\s*/i,'').replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
                var slugInput = document.getElementById('newStdSlug');
                if(slugInput) slugInput.value = slug;
            });
        }

        function closeNeuerStdModal() {
            var c = document.getElementById('neuerStdContainer');
            if(c) c.remove();
        }

        async function saveNeuerStandort() {
            var name = (document.getElementById('newStdName')||{}).value||'';
            var slug = (document.getElementById('newStdSlug')||{}).value||'';
            var region = (document.getElementById('newStdRegion')||{}).value||'SÃ¼d';
            var status = (document.getElementById('newStdStatus')||{}).value||'onboarding';
            var adresse = (document.getElementById('newStdAdresse')||{}).value||'';
            var telefon = (document.getElementById('newStdTelefon')||{}).value||'';
            var premium = (document.getElementById('newStdPremium')||{}).checked||false;

            if(!name.trim() || !slug.trim()) { alert('Bitte Name und Slug ausfÃ¼llen.'); return; }
            slug = slug.toLowerCase().replace(/[^a-z0-9-]/g,'');

            var btn = document.querySelector('#neuerStdContainer .bg-vit-orange');
            if(btn) { btn.disabled=true; btn.textContent='Wird angelegt...'; }

            try {
                var resp = await sb.from('standorte').insert({
                    name: name.trim(),
                    slug: slug,
                    region: region,
                    status: status,
                    is_premium: premium,
                    adresse: adresse.trim() || null,
                    telefon: telefon.trim() || null
                }).select().single();
                if(resp.error) throw resp.error;

                closeNeuerStdModal();
                alert('\u2705 Standort angelegt!\n'+name.trim()+'\nSlug: '+slug+'\nStatus: '+status);
                renderKzStandorte();
            } catch(err) {
                alert('Fehler: ' + err.message);
                if(btn) { btn.disabled=false; btn.textContent='Anlegen'; }
            }
        }

        // === HQ EINSTELLUNGEN - RECHTE-MATRIX ===
        function showSettingsTab(tab) {
            document.querySelectorAll('.settings-tab').forEach(function(b){
                b.className = 'settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            });
            var btn = document.querySelector('.settings-tab[data-tab="'+tab+'"]');
            if(btn) btn.className = 'settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange';
            document.querySelectorAll('.settings-tab-content').forEach(function(c){ c.style.display = 'none'; });
            var content = document.getElementById('settingsTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if(content) content.style.display = '';
        }

        async function renderModulStatusList() {
            var container = document.getElementById('modulStatusList');
            if(!container) return;
            try {
                var resp = await sb.from('modul_status').select('*').order('reihenfolge');
                if(resp.error) throw resp.error;
                var modules = resp.data || [];
                var html = '';
                var katLabels = {basis:'Basis',dashboards:'Dashboards',fachbereiche:'Fachbereiche',tools:'Tools'};
                var lastKat = '';
                var counts = {aktiv:0, in_bearbeitung:0, deaktiviert:0};

                modules.forEach(function(m) {
                    counts[m.status] = (counts[m.status]||0) + 1;
                    if(m.kategorie !== lastKat) {
                        lastKat = m.kategorie;
                        html += '<div class="px-5 py-2 bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">' + (katLabels[m.kategorie]||m.kategorie) + '</div>';
                    }
                    var icons = {startseite:'ðŸ ',kalender:'ðŸ“…',aufgaben:'ðŸ“‹',kommunikation:'ðŸ’¬',dashboards:'ðŸ“Š',allgemein:'ðŸ¢',verkauf:'ðŸ“ˆ',einkauf:'ðŸ›’',marketing:'ðŸ“£',controlling:'ðŸ“Š',wissen:'ðŸ“š',support:'ðŸŽ«',ideenboard:'ðŸ’¡',shop:'ðŸ›ï¸',onboarding:'ðŸŽ¯',mitarbeiter:'ðŸ‘¥'};
                    html += '<div class="px-5 py-3 flex items-center justify-between hover:bg-gray-50 transition">';
                    html += '<div class="flex items-center space-x-3">';
                    html += '<span class="text-xl">' + (icons[m.modul_key]||'ðŸ“¦') + '</span>';
                    html += '<div><span class="font-semibold text-gray-800 text-sm">' + m.modul_name + '</span>';
                    html += '<span class="text-xs text-gray-400 ml-2">' + m.modul_key + '</span></div>';
                    html += '</div>';
                    html += '<div class="flex items-center space-x-1 bg-gray-100 rounded-lg p-0.5">';
                    // 3 Toggle Buttons
                    var btnBase = 'px-3 py-1.5 rounded-md text-xs font-semibold transition cursor-pointer';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'aktiv\')" class="' + btnBase + ' ' + (m.status==='aktiv' ? 'bg-green-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">âœ“ Aktiv</button>';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'in_bearbeitung\')" class="' + btnBase + ' ' + (m.status==='in_bearbeitung' ? 'bg-yellow-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">ðŸ”§ In Bearbeitung</button>';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'deaktiviert\')" class="' + btnBase + ' ' + (m.status==='deaktiviert' ? 'bg-gray-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">âœ• Deaktiviert</button>';
                    html += '</div></div>';
                });
                container.innerHTML = html;

                // Update counters
                var el1 = document.getElementById('countAktiv'); if(el1) el1.textContent = counts.aktiv||0;
                var el2 = document.getElementById('countWip'); if(el2) el2.textContent = counts.in_bearbeitung||0;
                var el3 = document.getElementById('countDeaktiviert'); if(el3) el3.textContent = counts.deaktiviert||0;
            } catch(err) { console.error('ModulStatusList:', err); container.innerHTML = '<div class="p-4 text-center text-red-400">Fehler beim Laden</div>'; }
        }

        async function setModulStatus(id, newStatus) {
            try {
                var resp = await sb.from('modul_status').update({status: newStatus, updated_by: sbUser ? sbUser.id : null}).eq('id', id);
                if(resp.error) throw resp.error;
                // Reload both the list and the sidebar
                await loadModulStatus();
                renderModulStatusList();
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        function renderHqEinstellungen() {
            // Modul-Status Tab rendern
            renderModulStatusList();

            // Rechte-Matrix rendern
            var modules = [
                {key:'home',label:'Startseite',icon:'ðŸ ',core:true},
                {key:'kalender',label:'Kalender',icon:'ðŸ“…',core:true},
                {key:'todo',label:'Aufgaben',icon:'ðŸ“‹',core:true},
                {key:'kommunikation',label:'Kommunikation',icon:'ðŸ’¬',core:true},
                {key:'dashboards',label:'Dashboards',icon:'ðŸ“Š',core:false},
                {key:'allgemein',label:'Allgemein',icon:'ðŸ¢',core:false},
                {key:'verkauf',label:'Verkauf',icon:'ðŸ“ˆ',core:false},
                {key:'einkauf',label:'Einkauf',icon:'ðŸ›’',core:false},
                {key:'marketing',label:'Marketing',icon:'ðŸ“£',core:false},
                {key:'controlling',label:'Controlling',icon:'ðŸ“Š',core:false},
                {key:'wissen',label:'Wissen',icon:'ðŸ“š',core:false},
                {key:'support',label:'Support',icon:'ðŸŽ«',core:false},
                {key:'aktenschrank',label:'Aktenschrank',icon:'ðŸ“',core:false},
                {key:'ideenboard',label:'Ideenboard',icon:'ðŸ’¡',core:false},
                {key:'shop',label:'Werbemittel-Shop',icon:'ðŸ›ï¸',core:false},
                {key:'onboarding',label:'Onboarding',icon:'ðŸŽ¯',core:false}
            ];
            var rollen = ['inhaber','verkauf','werkstatt','buchhaltung'];

            var body = document.getElementById('rechteMatrixBody');
            if(!body) return;
            var h = '';
            modules.forEach(function(mod){
                var perms = rolePermissions[mod.key] || ['alle'];
                var isCore = mod.core;
                h += '<tr class="border-t border-gray-100 '+(isCore?'bg-green-50':'hover:bg-gray-50')+'">';
                h += '<td class="px-4 py-2.5 font-semibold text-gray-700 text-xs">'+mod.icon+' '+mod.label;
                if(isCore) h += ' <span class="text-[9px] text-green-600 font-normal">(Basis)</span>';
                h += '</td>';
                rollen.forEach(function(r){
                    var isAllowed = perms.indexOf('alle')>=0 || perms.indexOf(r)>=0;
                    if(isCore) {
                        h += '<td class="px-4 py-2.5 text-center"><span class="text-green-500 text-lg cursor-not-allowed" title="Basis-Modul â€“ immer aktiv">âœ…</span></td>';
                    } else {
                        h += '<td class="px-4 py-2.5 text-center"><button onclick="togglePermission(\''+mod.key+'\',\''+r+'\')" class="text-lg transition hover:scale-125" title="Klicken zum Umschalten">'+(isAllowed?'âœ…':'âŒ')+'</button></td>';
                    }
                });
                h += '</tr>';
            });
            body.innerHTML = h;

            // Update MA count
            var cnt = document.getElementById('settingsMaCount');
            if(cnt) cnt.textContent = kzMitarbeiter.length;
        }

        function togglePermission(modKey, rolle) {
            var perms = rolePermissions[modKey];
            if(!perms) { rolePermissions[modKey] = [rolle]; renderHqEinstellungen(); return; }

            // If currently 'alle', convert to explicit list minus this role
            if(perms.indexOf('alle')>=0) {
                rolePermissions[modKey] = ['inhaber','verkauf','werkstatt','buchhaltung'].filter(function(r){return r!==rolle;});
                renderHqEinstellungen();
                return;
            }

            var idx = perms.indexOf(rolle);
            if(idx>=0) {
                perms.splice(idx,1);
                if(perms.length===0) perms.push('inhaber'); // mindestens Inhaber
            } else {
                perms.push(rolle);
            }
            // If all 4 roles selected, simplify to 'alle'
            if(perms.length===4) rolePermissions[modKey] = ['alle'];
            renderHqEinstellungen();
            // Also update sidebar immediately if user is logged in
            try { updateUIForRole(); } catch(e){}
        }

        function renderKommandozentrale() {
            renderKzStandorte();
            renderKzMitarbeiter();
        }
        var currentLang = 'de';
        var i18n = {
            de: {
                // Navigation
                nav_home:'Startseite', nav_dashboards:'Dashboards', nav_mainmenu:'HauptmenÃ¼',
                nav_general:'Allgemein', nav_marketing:'Marketing', nav_purchasing:'Einkauf',
                nav_controlling:'Controlling', nav_sales:'Verkauf', nav_filingcab:'Aktenschrank',
                nav_support:'Support', nav_communication:'Kommunikation', nav_knowledge:'Wissen', nav_shop:'Werbemittel-Shop', h_purchasing:'EINKAUF', h_controlling:'CONTROLLING', h_filingcab:'AKTENSCHRANK', h_support:'SUPPORT', h_ideaboard:'IDEENBOARD', h_communication:'KOMMUNIKATION', h_forum:'FORUM', h_chat:'CHAT', h_calendar:'TERMINE', h_todos:'AUFGABEN', h_onboarding:'ONBOARDING', nav_ideaboard:'Ideenboard',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Steuerung',
                nav_hq_cockpit:'Netzwerk-Cockpit', nav_hq_locations:'Standorte',
                nav_hq_finance:'Finanzen', nav_hq_actions:'Handlungsbedarf', nav_hq_command:'Kommandozentrale', nav_hq_comm:'Kommunikation', nav_hq_campaigns:'Kampagnen', nav_hq_docs:'Dokumente', nav_hq_calendar:'Kalender', nav_hq_tasks:'Aufgaben', nav_hq_analytics:'Nutzung Portal', nav_calendar:'Kalender', nav_todo:'Aufgaben',
                // Headlines
                h_marketing:'MARKETING', h_sales:'VERKAUF', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD REPORTING',
                welcome:'Willkommen zurÃ¼ck, {name}!',
                // Dashboard
                dash_consultations:'Beratungen heute', dash_openoffers:'Offene Angebote',
                dash_opentickets:'Tickets offen',
                // Marketing tabs
                tab_campaigns:'Kampagnen', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Library', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategie', tab_knowledge:'ðŸ“š Wissen',
                // Social Media
                sm_channels:'ðŸ“± Unsere KanÃ¤le', sm_topics:'ðŸŽ¬ Themen-AuftrÃ¤ge',
                sm_upload:'ðŸ“¤ Video hochladen', sm_ranking:'ðŸ“Š Netzwerk-Ranking',
                sm_howto:"â„¹ï¸ So funktioniert's",
                filter_all:'Alle', filter_new:'ðŸ†• Neu fÃ¼r dich', filter_done:'âœ… Erledigt',
                search_topic:'Thema suchen...',
                // Role
                role_seller:'Verkauf',
                // Buttons & Labels
                btn_shoot:'ðŸ“¤ Drehen', btn_upload_now:'ðŸ“¤ Dieses Thema jetzt drehen & hochladen',
                btn_submit:'ðŸš€ Video einreichen', btn_to_channel:'Zum Kanal â†’',
                btn_follow:'Folgen', btn_subscribe:'Abonnieren',
                lbl_videos_shot:'Videos gedreht', lbl_topics:'Themen',
                lbl_streak:'ðŸ”¥ Streak: 2 Wochen', lbl_rank:'ðŸ† Rang 5 von 21',
                lbl_next_badge:'â­ NÃ¤chstes Badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (erste 3 Sekunden)',
                lbl_main:'ðŸ“‹ Hauptteil â€“ Was zeigen/erzÃ¤hlen',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tipp vom HQ-Marketing',
                lbl_example_video:'Beispielvideo ansehen',
                lbl_example_desc:'Schau dir an wie andere das gemacht haben â€“ dann nachmachen!',
                lbl_watch:'Ansehen â†’', lbl_done_video:'âœ… Du hast dieses Video bereits eingereicht!',
                lbl_difficulty:'Schwierigkeit',
                // Upload form
                upl_title:'Video hochladen', upl_desc:'WÃ¤hle ein Thema, lade dein Video hoch â€“ fertig! Wir kÃ¼mmern uns um Schnitt, Untertitel und Posting.',
                upl_select:'Thema wÃ¤hlen...', upl_own:'0000 â€“ Eigener Vorschlag',
                upl_your_video:'Dein Video', upl_drag:'Video hierhin ziehen',
                upl_click:'oder klicken zum AuswÃ¤hlen', upl_comment:'Kurzer Kommentar',
                upl_comment_ph:"z.B. 'Haben das im Laden gedreht, Lichtsituation war schwierig'",
                upl_footer:'Das HQ schneidet euer Video, packt Untertitel drauf und postet es als Collab-Post auf eurem Profil.',
                // Ranking
                rank_title:'ðŸ† Content-Ranking â€“ Wer dreht am meisten?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Netzwerk-Statistik',
                rank_total_vids:'Videos gesamt', rank_topics_covered:'Themen abgedeckt',
                rank_active:'Aktive Standorte', rank_no_video:'Noch ohne Video',
                // Howto
                howto_title:'So funktioniert Local Hero â€“ in 3 Schritten',
                howto_step1:'1. Inspiration', howto_step1d:'Wir stellen Thema + Beispielvideo bereit',
                howto_step2:'2. Drehen & Upload', howto_step2d:'1-3 Min. Video mit dem Handy drehen und hier hochladen',
                howto_step3:'3. Schnitt & Posting', howto_step3d:'Wir schneiden, packen Untertitel drauf und posten als Collab',
                howto_tips:'ðŸ’¡ Tipps fÃ¼r gute Videos', howto_links:'ðŸ”— Hilfreiche Links',
                // Local Hero header
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategie',
                lh_desc:'Dreh ein kurzes Video, lade es hoch â€“ wir machen den Rest! Schnitt, Untertitel & Posting Ã¼bernimmt das HQ.',
                // Channel cards
                ch_followers:'Follower', ch_posts:'BeitrÃ¤ge', ch_engagement:'Engagement',
                ch_subscribers:'Abonnenten', ch_videos:'Videos', ch_views:'Aufrufe',
                ch_likes:'Likes',
                // Badges
                badge_first:'Erster Upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Erreicht', badge_almost:'Noch 1!', badge_locked:'Gesperrt',
                // Content themes
                lbl_content_theme:'Content-Thema w\u00e4hlen',
                // Generic
                optional:'(optional)',
                // === BWA Erinnerungen ===
                bwa_reminder_title:'BWA {monat} {jahr} einreichen',
                bwa_reminder_desc:'Die BWA f\u00fcr {monat} {jahr} muss bis zum {deadline} eingereicht werden. Bitte im Bereich Controlling hochladen.',
                bwa_reminder_urgent:'\u26A0\uFE0F DRINGEND: Die Deadline ist in wenigen Tagen!',
                bwa_reminder_overdue:'\uD83D\uDEA8 \u00dcBERF\u00c4LLIG! Bitte umgehend einreichen. Das HQ wird benachrichtigt.',
                bwa_banner_info:'BWA-Erinnerung: Bitte einreichen.',
                bwa_banner_warn:'BWA-Erinnerung: Deadline naht!',
                bwa_banner_urgent:'BWA dringend einreichen!',
                bwa_banner_overdue:'BWA \u00fcberf\u00e4llig! HQ wird informiert.',
                bwa_banner_missing:'Fehlend',
                bwa_banner_btn:'Jetzt einreichen',
                // === Todos ===
                todo_open:'Offen', todo_today:'Heute', todo_overdue:'\u00dcberf\u00e4llig', todo_done:'Erledigt',
                todo_no_tasks:'Keine Aufgaben', todo_add:'Aufgabe hinzuf\u00fcgen', todo_edit:'Bearbeiten',
                todo_delete:'L\u00f6schen', todo_save:'Speichern', todo_cancel:'Abbrechen',
                todo_title_ph:'Aufgabe eingeben...', todo_due:'F\u00e4llig', todo_prio:'Priorit\u00e4t',
                todo_cat:'Kategorie', todo_system:'System-Aufgabe', todo_manual:'Manuell',
                prio_high:'Hoch', prio_normal:'Normal', prio_low:'Niedrig', prio_urgent:'Dringend',
                cat_sales:'Verkauf', cat_workshop:'Werkstatt', cat_marketing:'Marketing',
                cat_admin:'Admin', cat_other:'Sonstig',
                // === Tickets ===
                ticket_new:'Neues Ticket', ticket_subject:'Betreff', ticket_desc:'Beschreibung',
                ticket_category:'Kategorie', ticket_priority:'Priorit\u00e4t', ticket_create:'Ticket erstellen',
                ticket_status_open:'Offen', ticket_status_progress:'In Bearbeitung',
                ticket_status_waiting:'Wartend', ticket_status_resolved:'Gel\u00f6st',
                ticket_comments:'Kommentare', ticket_comment_ph:'Kommentar schreiben...',
                ticket_comment_send:'Senden', ticket_change_status:'Status \u00e4ndern',
                ticket_mark_resolved:'Als gel\u00f6st markieren', ticket_no_tickets:'Keine Tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'BWA hochladen',
                ctrl_month:'Monat', ctrl_year:'Jahr', ctrl_revenue:'Umsatz',
                ctrl_gross_profit:'Rohertrag', ctrl_costs:'Gesamtkosten', ctrl_result:'Ergebnis',
                ctrl_select_bwa:'BWA ausw\u00e4hlen', ctrl_edit:'Bearbeiten', ctrl_delete:'L\u00f6schen',
                // === Verkauf ===
                sales_week:'Wochenansicht', sales_pipeline:'Pipeline', sales_analysis:'Auswertung',
                sales_yearly:'Jahresplan', sales_plan:'Plan', sales_actual:'Ist',
                sales_consultations:'Beratungen', sales_sold:'Verkauft', sales_revenue:'Umsatz',
                sales_quote:'Quote', sales_all_sellers:'Alle Verk\u00e4ufer',
                sales_no_data:'Keine Verkaufsdaten f\u00fcr diese Woche',
                sales_add_entry:'Eintragen',
                // === Kommunikation ===
                comm_announcements:'Ank\u00fcndigungen', comm_board:'Schwarzes Brett',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'Neue Ank\u00fcndigung', comm_important:'Wichtig',
                comm_edit:'Bearbeiten', comm_delete:'L\u00f6schen', comm_publish:'Ver\u00f6ffentlichen',
                // === Dokumente ===
                doc_upload:'Dokument hochladen', doc_title:'Titel', doc_category:'Kategorie',
                doc_download:'Herunterladen', doc_delete:'L\u00f6schen', doc_select_file:'Datei ausw\u00e4hlen',
                doc_guidelines:'Richtlinien', doc_templates:'Vorlagen', doc_trainings:'Schulungen',
                doc_contracts:'Vertr\u00e4ge', doc_other:'Sonstiges',
                // === Shop ===
                shop_cart:'Warenkorb', shop_empty:'Warenkorb leer', shop_order:'Bestellen',
                shop_total:'Gesamt', shop_per_piece:'pro St\u00fcck', shop_remove:'Entfernen',
                // === Allgemein ===
                btn_save:'Speichern', btn_cancel:'Abbrechen', btn_close:'Schlie\u00dfen',
                btn_back:'Zur\u00fcck', btn_next:'Weiter', btn_confirm:'Best\u00e4tigen',
                loading:'Wird geladen...', error:'Fehler', success:'Erfolg',
                confirm_delete:'Wirklich l\u00f6schen?',
                // === Login ===
                login_title:'Partner Portal', login_email:'E-Mail', login_password:'Passwort',
                login_submit:'Anmelden', login_forgot:'Passwort vergessen?',
                login_reset_title:'Passwort zur\u00fccksetzen',
                login_reset_desc:'Gib deine E-Mail ein. Du erh\u00e4ltst einen Link zum Zur\u00fccksetzen.',
                login_reset_send:'Link senden', login_reset_sent:'E-Mail gesendet! Pr\u00fcfe deinen Posteingang.',
                pw_change_title:'Neues Passwort setzen',
                pw_change_desc:'Gib dein neues Passwort ein (mindestens 6 Zeichen).',
                pw_change_new:'Neues Passwort', pw_change_repeat:'Passwort wiederholen',
                pw_change_save:'Passwort speichern', pw_change_success:'Passwort erfolgreich ge\u00e4ndert!',
                pw_change_mismatch:'Passw\u00f6rter stimmen nicht \u00fcberein.',
                pw_change_min:'Mindestens 6 Zeichen.'
            },
            en: {
                nav_home:'Home', nav_dashboards:'Dashboards', nav_mainmenu:'Main Menu',
                nav_general:'General', nav_marketing:'Marketing', nav_purchasing:'Purchasing',
                nav_controlling:'Controlling', nav_sales:'Sales', nav_filingcab:'Filing Cabinet',
                nav_support:'Support', nav_communication:'Communication', nav_knowledge:'Knowledge', nav_shop:'Merchandise Shop', h_purchasing:'PURCHASING', h_controlling:'CONTROLLING', h_filingcab:'FILE CABINET', h_support:'SUPPORT', h_ideaboard:'IDEA BOARD', h_communication:'COMMUNICATION', h_forum:'FORUM', h_chat:'CHAT', h_calendar:'CALENDAR', h_todos:'TASKS', h_onboarding:'ONBOARDING', nav_ideaboard:'Idea Board',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Control',
                nav_hq_cockpit:'Network Cockpit', nav_hq_locations:'Locations',
                nav_hq_finance:'Finance', nav_hq_actions:'Action Required', nav_hq_command:'Command Center', nav_hq_comm:'Communication', nav_hq_campaigns:'Campaigns', nav_hq_docs:'Documents', nav_hq_calendar:'Calendar', nav_hq_tasks:'Tasks', nav_hq_analytics:'Portal Usage', nav_calendar:'Calendar', nav_todo:'Tasks',
                h_marketing:'MARKETING', h_sales:'SALES', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD REPORTING',
                welcome:'Welcome back, {name}!',
                dash_consultations:'Consultations today', dash_openoffers:'Open offers',
                dash_opentickets:'Open tickets',
                tab_campaigns:'Campaigns', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Library', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategy', tab_knowledge:'ðŸ“š Knowledge',
                sm_channels:'ðŸ“± Our Channels', sm_topics:'ðŸŽ¬ Content Briefs',
                sm_upload:'ðŸ“¤ Upload Video', sm_ranking:'ðŸ“Š Network Ranking',
                sm_howto:'â„¹ï¸ How it works',
                filter_all:'All', filter_new:'ðŸ†• New for you', filter_done:'âœ… Completed',
                search_topic:'Search topic...',
                role_seller:'Sales Associate',
                btn_shoot:'ðŸ“¤ Shoot', btn_upload_now:'ðŸ“¤ Shoot & upload this topic now',
                btn_submit:'ðŸš€ Submit video', btn_to_channel:'Go to channel â†’',
                btn_follow:'Follow', btn_subscribe:'Subscribe',
                lbl_videos_shot:'Videos recorded', lbl_topics:'Topics',
                lbl_streak:'ðŸ”¥ Streak: 2 weeks', lbl_rank:'ðŸ† Rank 5 of 21',
                lbl_next_badge:'â­ Next badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (first 3 seconds)',
                lbl_main:'ðŸ“‹ Main Part â€“ What to show/say',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tip from HQ Marketing',
                lbl_example_video:'Watch example video',
                lbl_example_desc:'See how others did it â€“ then recreate it!',
                lbl_watch:'Watch â†’', lbl_done_video:'âœ… You have already submitted this video!',
                lbl_difficulty:'Difficulty',
                upl_title:'Upload Video', upl_desc:'Choose a topic, upload your video â€“ done! We handle editing, subtitles and posting.',
                upl_select:'Choose topic...', upl_own:'0000 â€“ Own suggestion',
                upl_your_video:'Your Video', upl_drag:'Drag video here',
                upl_click:'or click to browse', upl_comment:'Short comment',
                upl_comment_ph:"e.g. 'Shot in the store, lighting was tricky'",
                upl_footer:'HQ edits your video, adds subtitles and posts it as a collab post on your profile.',
                rank_title:'ðŸ† Content Ranking â€“ Who shoots the most?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Network Statistics',
                rank_total_vids:'Total videos', rank_topics_covered:'Topics covered',
                rank_active:'Active locations', rank_no_video:'No video yet',
                howto_title:'How Local Hero works â€“ 3 simple steps',
                howto_step1:'1. Inspiration', howto_step1d:'We provide the topic + example video',
                howto_step2:'2. Shoot & Upload', howto_step2d:'Shoot 1-3 min. video with your phone and upload here',
                howto_step3:'3. Edit & Post', howto_step3d:'We edit, add subtitles and post as a collab',
                howto_tips:'ðŸ’¡ Tips for great videos', howto_links:'ðŸ”— Helpful links',
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategy',
                lh_desc:'Shoot a quick video, upload it â€“ we do the rest! Editing, subtitles & posting is handled by HQ.',
                ch_followers:'Followers', ch_posts:'Posts', ch_engagement:'Engagement',
                ch_subscribers:'Subscribers', ch_videos:'Videos', ch_views:'Views',
                ch_likes:'Likes',
                badge_first:'First Upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Achieved', badge_almost:'1 more!', badge_locked:'Locked',
                lbl_content_theme:'Choose content topic',
                optional:'(optional)',
                // === BWA Reminders ===
                bwa_reminder_title:'Submit BWA {monat} {jahr}',
                bwa_reminder_desc:'The BWA for {monat} {jahr} must be submitted by {deadline}. Please upload in the Controlling section.',
                bwa_reminder_urgent:'\u26A0\uFE0F URGENT: The deadline is in a few days!',
                bwa_reminder_overdue:'\uD83D\uDEA8 OVERDUE! Please submit immediately. HQ will be notified.',
                bwa_banner_info:'BWA reminder: Please submit.',
                bwa_banner_warn:'BWA reminder: Deadline approaching!',
                bwa_banner_urgent:'Submit BWA urgently!',
                bwa_banner_overdue:'BWA overdue! HQ will be notified.',
                bwa_banner_missing:'Missing',
                bwa_banner_btn:'Submit now',
                // === Todos ===
                todo_open:'Open', todo_today:'Today', todo_overdue:'Overdue', todo_done:'Done',
                todo_no_tasks:'No tasks', todo_add:'Add task', todo_edit:'Edit',
                todo_delete:'Delete', todo_save:'Save', todo_cancel:'Cancel',
                todo_title_ph:'Enter task...', todo_due:'Due', todo_prio:'Priority',
                todo_cat:'Category', todo_system:'System task', todo_manual:'Manual',
                prio_high:'High', prio_normal:'Normal', prio_low:'Low', prio_urgent:'Urgent',
                cat_sales:'Sales', cat_workshop:'Workshop', cat_marketing:'Marketing',
                cat_admin:'Admin', cat_other:'Other',
                // === Tickets ===
                ticket_new:'New ticket', ticket_subject:'Subject', ticket_desc:'Description',
                ticket_category:'Category', ticket_priority:'Priority', ticket_create:'Create ticket',
                ticket_status_open:'Open', ticket_status_progress:'In Progress',
                ticket_status_waiting:'Waiting', ticket_status_resolved:'Resolved',
                ticket_comments:'Comments', ticket_comment_ph:'Write a comment...',
                ticket_comment_send:'Send', ticket_change_status:'Change status',
                ticket_mark_resolved:'Mark as resolved', ticket_no_tickets:'No tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'Upload BWA',
                ctrl_month:'Month', ctrl_year:'Year', ctrl_revenue:'Revenue',
                ctrl_gross_profit:'Gross profit', ctrl_costs:'Total costs', ctrl_result:'Result',
                ctrl_select_bwa:'Select BWA', ctrl_edit:'Edit', ctrl_delete:'Delete',
                // === Sales ===
                sales_week:'Week view', sales_pipeline:'Pipeline', sales_analysis:'Analysis',
                sales_yearly:'Annual plan', sales_plan:'Plan', sales_actual:'Actual',
                sales_consultations:'Consultations', sales_sold:'Sold', sales_revenue:'Revenue',
                sales_quote:'Rate', sales_all_sellers:'All sellers',
                sales_no_data:'No sales data for this week',
                sales_add_entry:'Add entry',
                // === Communication ===
                comm_announcements:'Announcements', comm_board:'Bulletin board',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'New announcement', comm_important:'Important',
                comm_edit:'Edit', comm_delete:'Delete', comm_publish:'Publish',
                // === Documents ===
                doc_upload:'Upload document', doc_title:'Title', doc_category:'Category',
                doc_download:'Download', doc_delete:'Delete', doc_select_file:'Select file',
                doc_guidelines:'Guidelines', doc_templates:'Templates', doc_trainings:'Trainings',
                doc_contracts:'Contracts', doc_other:'Other',
                // === Shop ===
                shop_cart:'Shopping cart', shop_empty:'Cart is empty', shop_order:'Order',
                shop_total:'Total', shop_per_piece:'per piece', shop_remove:'Remove',
                // === General ===
                btn_save:'Save', btn_cancel:'Cancel', btn_close:'Close',
                btn_back:'Back', btn_next:'Next', btn_confirm:'Confirm',
                loading:'Loading...', error:'Error', success:'Success',
                confirm_delete:'Really delete?',
                // === Login ===
                login_title:'Partner Portal', login_email:'Email', login_password:'Password',
                login_submit:'Sign in', login_forgot:'Forgot password?',
                login_reset_title:'Reset password',
                login_reset_desc:'Enter your email. You will receive a link to reset your password.',
                login_reset_send:'Send link', login_reset_sent:'Email sent! Check your inbox.',
                pw_change_title:'Set new password',
                pw_change_desc:'Enter your new password (at least 6 characters).',
                pw_change_new:'New password', pw_change_repeat:'Repeat password',
                pw_change_save:'Save password', pw_change_success:'Password changed successfully!',
                pw_change_mismatch:'Passwords do not match.',
                pw_change_min:'At least 6 characters.'
            },
            nl: {
                nav_home:'Startpagina', nav_dashboards:'Dashboards', nav_mainmenu:'Hoofdmenu',
                nav_general:'Algemeen', nav_marketing:'Marketing', nav_purchasing:'Inkoop',
                nav_controlling:'Controlling', nav_sales:'Verkoop', nav_filingcab:'Documentenarchief',
                nav_support:'Ondersteuning', nav_communication:'Communicatie', nav_ideaboard:'IdeeÃ«nbord',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Beheer',
                nav_hq_cockpit:'Netwerk-Cockpit', nav_hq_locations:'Locaties',
                nav_hq_finance:'FinanciÃ«n', nav_hq_actions:'Actie vereist', nav_hq_command:'Commandocentrum', nav_hq_comm:'Communicatie', nav_hq_campaigns:'Campagnes', nav_hq_docs:'Documenten', nav_hq_calendar:'Agenda', nav_hq_tasks:'Taken', nav_hq_analytics:'Portaalgebruik', nav_calendar:'Agenda', nav_todo:'Taken',
                h_marketing:'MARKETING', h_sales:'VERKOOP', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD RAPPORTAGE',
                h_purchasing:'INKOOP', h_controlling:'CONTROLLING', h_filingcab:'DOCUMENTENARCHIEF',
                h_support:'ONDERSTEUNING', h_ideaboard:'IDEE\u00cbNBORD', h_communication:'COMMUNICATIE',
                h_forum:'FORUM', h_chat:'CHAT', h_calendar:'AGENDA', h_todos:'TAKEN', h_onboarding:'ONBOARDING',
                nav_knowledge:'Kennis', nav_shop:'Promotieshop',
                welcome:'Welkom terug, {name}!',
                dash_consultations:'Adviezen vandaag', dash_openoffers:'Openstaande offertes',
                dash_opentickets:'Open tickets',
                tab_campaigns:'Campagnes', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Bibliotheek', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategie', tab_knowledge:'ðŸ“š Kennis',
                sm_channels:'ðŸ“± Onze kanalen', sm_topics:'ðŸŽ¬ Content-opdrachten',
                sm_upload:'ðŸ“¤ Video uploaden', sm_ranking:'ðŸ“Š Netwerk-ranking',
                sm_howto:'â„¹ï¸ Zo werkt het',
                filter_all:'Alle', filter_new:'ðŸ†• Nieuw voor jou', filter_done:'âœ… Afgerond',
                search_topic:'Onderwerp zoeken...',
                role_seller:'Verkoper',
                btn_shoot:'ðŸ“¤ Filmen', btn_upload_now:'ðŸ“¤ Dit onderwerp nu filmen & uploaden',
                btn_submit:'ðŸš€ Video indienen', btn_to_channel:'Naar kanaal â†’',
                btn_follow:'Volgen', btn_subscribe:'Abonneren',
                lbl_videos_shot:'Videos gemaakt', lbl_topics:'Onderwerpen',
                lbl_streak:'ðŸ”¥ Reeks: 2 weken', lbl_rank:'ðŸ† Rang 5 van 21',
                lbl_next_badge:'â­ Volgende badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (eerste 3 seconden)',
                lbl_main:'ðŸ“‹ Hoofddeel â€“ Wat laten zien/vertellen',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tip van HQ Marketing',
                lbl_example_video:'Voorbeeldvideo bekijken',
                lbl_example_desc:'Bekijk hoe anderen het deden â€“ en doe het na!',
                lbl_watch:'Bekijken â†’', lbl_done_video:'âœ… Je hebt deze video al ingediend!',
                lbl_difficulty:'Moeilijkheid',
                upl_title:'Video uploaden', upl_desc:'Kies een onderwerp, upload je video â€“ klaar! Wij zorgen voor montage, ondertiteling en publicatie.',
                upl_select:'Onderwerp kiezen...', upl_own:'0000 â€“ Eigen voorstel',
                upl_your_video:'Jouw video', upl_drag:'Sleep video hierheen',
                upl_click:'of klik om te selecteren', upl_comment:'Kort commentaar',
                upl_comment_ph:"bijv. 'In de winkel gefilmd, belichting was lastig'",
                upl_footer:'HQ monteert je video, voegt ondertiteling toe en plaatst het als collab-post op je profiel.',
                rank_title:'ðŸ† Content-ranking â€“ Wie filmt het meest?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Netwerkstatistieken',
                rank_total_vids:'Totaal videos', rank_topics_covered:'Onderwerpen behandeld',
                rank_active:'Actieve locaties', rank_no_video:'Nog geen video',
                howto_title:'Zo werkt Local Hero â€“ in 3 stappen',
                howto_step1:'1. Inspiratie', howto_step1d:'Wij leveren het onderwerp + voorbeeldvideo',
                howto_step2:'2. Filmen & Upload', howto_step2d:'Film 1-3 min. video met je telefoon en upload hier',
                howto_step3:'3. Montage & Publicatie', howto_step3d:'Wij monteren, voegen ondertiteling toe en publiceren als collab',
                howto_tips:'ðŸ’¡ Tips voor goede videos', howto_links:'ðŸ”— Handige links',
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategie',
                lh_desc:'Film een korte video, upload het â€“ wij doen de rest! Montage, ondertiteling & publicatie doet het HQ.',
                ch_followers:'Volgers', ch_posts:'Berichten', ch_engagement:'Betrokkenheid',
                ch_subscribers:'Abonnees', ch_videos:'Videos', ch_views:'Weergaven',
                ch_likes:'Likes',
                badge_first:'Eerste upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Behaald', badge_almost:'Nog 1!', badge_locked:'Vergrendeld',
                lbl_content_theme:'Content-onderwerp kiezen',
                optional:'(optioneel)',
                // === BWA Herinneringen ===
                bwa_reminder_title:'BWA {monat} {jahr} indienen',
                bwa_reminder_desc:'De BWA voor {monat} {jahr} moet voor {deadline} ingediend worden. Upload in het onderdeel Controlling.',
                bwa_reminder_urgent:'\u26A0\uFE0F DRINGEND: De deadline is over een paar dagen!',
                bwa_reminder_overdue:'\uD83D\uDEA8 TE LAAT! Dien zo snel mogelijk in. HQ wordt ge\u00efnformeerd.',
                bwa_banner_info:'BWA-herinnering: Gelieve in te dienen.',
                bwa_banner_warn:'BWA-herinnering: Deadline nadert!',
                bwa_banner_urgent:'BWA dringend indienen!',
                bwa_banner_overdue:'BWA te laat! HQ wordt ge\u00efnformeerd.',
                bwa_banner_missing:'Ontbrekend',
                bwa_banner_btn:'Nu indienen',
                // === Taken ===
                todo_open:'Open', todo_today:'Vandaag', todo_overdue:'Te laat', todo_done:'Afgerond',
                todo_no_tasks:'Geen taken', todo_add:'Taak toevoegen', todo_edit:'Bewerken',
                todo_delete:'Verwijderen', todo_save:'Opslaan', todo_cancel:'Annuleren',
                todo_title_ph:'Taak invoeren...', todo_due:'Deadline', todo_prio:'Prioriteit',
                todo_cat:'Categorie', todo_system:'Systeemtaak', todo_manual:'Handmatig',
                prio_high:'Hoog', prio_normal:'Normaal', prio_low:'Laag', prio_urgent:'Dringend',
                cat_sales:'Verkoop', cat_workshop:'Werkplaats', cat_marketing:'Marketing',
                cat_admin:'Administratie', cat_other:'Overig',
                // === Tickets ===
                ticket_new:'Nieuw ticket', ticket_subject:'Onderwerp', ticket_desc:'Beschrijving',
                ticket_category:'Categorie', ticket_priority:'Prioriteit', ticket_create:'Ticket aanmaken',
                ticket_status_open:'Open', ticket_status_progress:'In behandeling',
                ticket_status_waiting:'Wachtend', ticket_status_resolved:'Opgelost',
                ticket_comments:'Reacties', ticket_comment_ph:'Reactie schrijven...',
                ticket_comment_send:'Verzenden', ticket_change_status:'Status wijzigen',
                ticket_mark_resolved:'Als opgelost markeren', ticket_no_tickets:'Geen tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'BWA uploaden',
                ctrl_month:'Maand', ctrl_year:'Jaar', ctrl_revenue:'Omzet',
                ctrl_gross_profit:'Brutowinst', ctrl_costs:'Totale kosten', ctrl_result:'Resultaat',
                ctrl_select_bwa:'BWA selecteren', ctrl_edit:'Bewerken', ctrl_delete:'Verwijderen',
                // === Verkoop ===
                sales_week:'Weekoverzicht', sales_pipeline:'Pipeline', sales_analysis:'Analyse',
                sales_yearly:'Jaarplan', sales_plan:'Plan', sales_actual:'Werkelijk',
                sales_consultations:'Adviezen', sales_sold:'Verkocht', sales_revenue:'Omzet',
                sales_quote:'Percentage', sales_all_sellers:'Alle verkopers',
                sales_no_data:'Geen verkoopgegevens voor deze week',
                sales_add_entry:'Invoeren',
                // === Communicatie ===
                comm_announcements:'Aankondigingen', comm_board:'Prikbord',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'Nieuwe aankondiging', comm_important:'Belangrijk',
                comm_edit:'Bewerken', comm_delete:'Verwijderen', comm_publish:'Publiceren',
                // === Documenten ===
                doc_upload:'Document uploaden', doc_title:'Titel', doc_category:'Categorie',
                doc_download:'Downloaden', doc_delete:'Verwijderen', doc_select_file:'Bestand selecteren',
                doc_guidelines:'Richtlijnen', doc_templates:'Sjablonen', doc_trainings:'Trainingen',
                doc_contracts:'Contracten', doc_other:'Overig',
                // === Shop ===
                shop_cart:'Winkelwagen', shop_empty:'Winkelwagen leeg', shop_order:'Bestellen',
                shop_total:'Totaal', shop_per_piece:'per stuk', shop_remove:'Verwijderen',
                // === Algemeen ===
                btn_save:'Opslaan', btn_cancel:'Annuleren', btn_close:'Sluiten',
                btn_back:'Terug', btn_next:'Volgende', btn_confirm:'Bevestigen',
                loading:'Wordt geladen...', error:'Fout', success:'Gelukt',
                confirm_delete:'Echt verwijderen?',
                // === Login ===
                login_title:'Partner Portaal', login_email:'E-mail', login_password:'Wachtwoord',
                login_submit:'Inloggen', login_forgot:'Wachtwoord vergeten?',
                login_reset_title:'Wachtwoord resetten',
                login_reset_desc:'Voer je e-mailadres in. Je ontvangt een link om je wachtwoord te resetten.',
                login_reset_send:'Link verzenden', login_reset_sent:'E-mail verzonden! Controleer je inbox.',
                pw_change_title:'Nieuw wachtwoord instellen',
                pw_change_desc:'Voer je nieuwe wachtwoord in (minimaal 6 tekens).',
                pw_change_new:'Nieuw wachtwoord', pw_change_repeat:'Wachtwoord herhalen',
                pw_change_save:'Wachtwoord opslaan', pw_change_success:'Wachtwoord succesvol gewijzigd!',
                pw_change_mismatch:'Wachtwoorden komen niet overeen.',
                pw_change_min:'Minimaal 6 tekens.'
            }
        };

        // ========== WERBEMITTEL-SHOP ==========
        var shopCart = [];

        async function renderShop() {
            var container = document.getElementById('shopGrid');
            if(!container) return;
            try {
                var resp = await sb.from('shop_produkte').select('*').eq('verfuegbar', true).order('kategorie');
                if(resp.error) throw resp.error;
                var products = resp.data || [];
                var html = '';
                products.forEach(function(p) {
                    var inCart = shopCart.find(function(c){return c.id===p.id});
                    html += '<div class="vit-card p-5 hover:shadow-md transition">';
                    html += '<div class="w-full h-32 bg-gray-100 rounded-lg mb-3 flex items-center justify-center text-4xl">ðŸ›ï¸</div>';
                    html += '<span class="text-xs font-semibold text-vit-orange uppercase">' + (p.kategorie||'') + '</span>';
                    html += '<h3 class="font-bold text-gray-800 text-sm mt-1">' + p.name + '</h3>';
                    if(p.beschreibung) html += '<p class="text-xs text-gray-500 mt-1">' + p.beschreibung + '</p>';
                    html += '<div class="flex items-center justify-between mt-3">';
                    html += '<span class="font-bold text-gray-800">' + (p.preis > 0 ? p.preis.toFixed(2) + ' \u20ac' : 'Kostenlos') + '</span>';
                    html += '<button onclick="addToCart(\x27'+p.id+'\x27,\x27'+(p.name||'').replace(/\x27/g,'')+'\x27,'+p.preis+')" class="px-3 py-1.5 text-xs font-semibold rounded-lg ' + (inCart ? 'bg-green-500 text-white' : 'bg-vit-orange text-white hover:opacity-90') + '">' + (inCart ? '\u2713 Im Warenkorb' : '+ Bestellen') + '</button>';
                    html += '</div></div>';
                });
                if(products.length===0) html = '<div class="col-span-3 text-center py-8 text-gray-400">Keine Produkte.</div>';
                container.innerHTML = html;
                renderShopCart();
            } catch(err) { console.error('Shop:', err); }
        }

        function addToCart(id, name, preis) {
            var existing = shopCart.find(function(c){return c.id===id});
            if(existing) { existing.menge++; } else { shopCart.push({id:id, name:name, preis:preis, menge:1}); }
            renderShop();
        }

        function renderShopCart() {
            var container = document.getElementById('shopCartItems');
            if(!container) return;
            if(shopCart.length===0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Warenkorb leer</p>';
                var totalEl = document.getElementById('shopCartTotal'); if(totalEl) totalEl.textContent = '0,00';
                var countEl = document.getElementById('shopCartCount'); if(countEl) countEl.textContent = '0';
                return;
            }
            var html = ''; var total = 0; var count = 0;
            shopCart.forEach(function(c) {
                total += c.preis * c.menge;
                count += c.menge;
                html += '<div class="flex items-center justify-between py-2 border-b border-gray-100">';
                html += '<div class="flex-1 min-w-0"><span class="text-sm font-medium text-gray-800 truncate block">' + c.name + '</span>';
                html += '<span class="text-xs text-gray-400">' + c.preis.toFixed(2) + ' \u20ac / St\u00fcck</span></div>';
                html += '<div class="flex items-center space-x-2 ml-3">';
                html += '<button onclick="updateShopCart(\x27'+c.id+'\x27,-1)" class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold">\u2212</button>';
                html += '<span class="text-sm font-bold w-6 text-center">' + c.menge + '</span>';
                html += '<button onclick="updateShopCart(\x27'+c.id+'\x27,1)" class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold">+</button>';
                html += '<span class="text-sm font-bold text-gray-800 w-16 text-right">' + (c.preis*c.menge).toFixed(2) + ' \u20ac</span>';
                html += '<button onclick="removeFromCart(\x27'+c.id+'\x27)" class="text-gray-300 hover:text-red-500 ml-1">\u2715</button>';
                html += '</div></div>';
            });
            html += '<div class="flex justify-between pt-3 font-bold text-gray-800"><span>Gesamt</span><span>' + total.toFixed(2) + ' \u20ac</span></div>';
            container.innerHTML = html;
            var totalEl = document.getElementById('shopCartTotal'); if(totalEl) totalEl.textContent = total.toFixed(2).replace('.',',');
            var countEl = document.getElementById('shopCartCount'); if(countEl) countEl.textContent = count;
        }

        function filterShop(kat) {
            document.querySelectorAll('.shop-filter-btn').forEach(function(b){b.className='shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.shop-filter-btn[data-sf="'+kat+'"]');
            if(btn) btn.className='shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderShop();
        }

        async function submitShopOrder() {
            if(shopCart.length===0 || !sbUser) return;
            try {
                var total = shopCart.reduce(function(a,c){return a+c.preis*c.menge},0);
                var orderResp = await sb.from('shop_bestellungen').insert({standort_id:sbStandort?sbStandort.id:null, user_id:sbUser.id, gesamt_preis:total}).select().single();
                if(orderResp.error) throw orderResp.error;
                var positionen = shopCart.map(function(c){ return {bestellung_id:orderResp.data.id, produkt_id:c.id, menge:c.menge, einzelpreis:c.preis}; });
                await sb.from('shop_positionen').insert(positionen);
                shopCart = [];
                alert('Bestellung erfolgreich! \ud83c\udf89');
                renderShop();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        function removeFromCart(id) {
            shopCart = shopCart.filter(function(c){return c.id!==id;});
            renderShop();
        }

        function updateShopCart(id, delta) {
            var item = shopCart.find(function(c){return c.id===id;});
            if(!item) return;
            item.menge += delta;
            if(item.menge <= 0) shopCart = shopCart.filter(function(c){return c.id!==id;});
            renderShop();
        }

        // ========== HQ DRILL-DOWN: Switch to Partner view for a specific location ==========
        function hqDrillDown(locationKey) {
            // Switch to partner mode for that location
            var sel = document.getElementById('viewModeSwitch');
            if(sel) {
                // Find matching option
                var opts = sel.options;
                for(var i=0; i<opts.length; i++) {
                    if(opts[i].value.indexOf(locationKey) > -1) {
                        sel.value = opts[i].value;
                        switchViewMode(opts[i].value);
                        return;
                    }
                }
            }
            // Fallback
            switchViewMode('partner_grafrath');
        }

        function handleFileUpload(input) {
            if(input.files && input.files[0]) {
                var name = input.files[0].name;
                var size = (input.files[0].size/1024).toFixed(1);
                var parent = input.closest('[onclick]') || input.parentElement;
                if(parent) {
                    var origHTML = parent.innerHTML;
                    parent.innerHTML = '<div class="py-4"><p class="text-green-600 font-semibold text-sm">âœ… '+name+'</p><p class="text-xs text-gray-400">'+size+' KB hochgeladen</p></div>';
                }
            }
        }

        function switchLang(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            // Update flag opacity
            document.querySelectorAll('.lang-flag').forEach(function(f){
                f.classList.toggle('opacity-40', f.getAttribute('data-lang')!==lang);
                f.classList.toggle('opacity-100', f.getAttribute('data-lang')===lang);
            });
            // Translate all data-i18n elements
            document.querySelectorAll('[data-i18n]').forEach(function(el){
                var key = el.getAttribute('data-i18n');
                if(i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el){
                var key = el.getAttribute('data-i18n-placeholder');
                if(i18n[lang] && i18n[lang][key]) {
                    el.placeholder = i18n[lang][key];
                }
            });
            // Re-render ALL visible dynamic content
            try { renderTodos(); } catch(e){}
            try { renderTickets('all'); } catch(e){}
            try { renderAnnouncements(); } catch(e){}
            try { renderShopCart(); } catch(e){}
            var views = document.querySelectorAll('.view');
            views.forEach(function(v) {
                if(v.style.display !== 'none') {
                    var vid = v.id;
                    if(vid==='homeView') { /* static i18n handles it */ }
                    if(vid==='smThemenList' || document.getElementById('smThemenList')) { try{renderSmThemen();}catch(e){} }
                    if(vid==='smRankingList' || document.getElementById('smRankingList')) { try{renderSmRanking();}catch(e){} }
                    if(vid==='shopView') { try{renderShop();}catch(e){} }
                    if(vid==='wissenView') { try{renderWissenGlobal();}catch(e){} }
                }
            });
            // Force re-render SM if visible
            try{if(document.getElementById('smThemenList') && document.getElementById('smThemenList').innerHTML) renderSmThemen();}catch(e){}
            try{if(document.getElementById('smRankingList') && document.getElementById('smRankingList').innerHTML) renderSmRanking();}catch(e){}
        }

        // Helper: get translated text (for JS-rendered content)
        function t(key) {
            return (i18n[currentLang] && i18n[currentLang][key]) || (i18n.de[key]) || key;
        }

        var currentSmFilter = 'all';

        function switchSmSub(sub) {
            document.querySelectorAll('.sm-sub-content').forEach(function(el){el.style.display='none';});
            document.querySelectorAll('.sm-sub-btn').forEach(function(b){b.className='sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600';});
            var target = document.getElementById('smSub'+sub.charAt(0).toUpperCase()+sub.slice(1));
            if(target) target.style.display='block';
            var btn = document.querySelector('.sm-sub-btn[data-smsub="'+sub+'"]');
            if(btn) btn.className='sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-vit-orange text-white';
            if(sub==='themen') renderSmThemen();
            if(sub==='ranking') renderSmRanking();
        }

        function filterSmThemen(filter) {
            currentSmFilter = filter;
            document.querySelectorAll('.sm-thema-filter').forEach(function(b){b.className='sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn = document.querySelector('.sm-thema-filter[data-smf="'+filter+'"]');
            if(btn) btn.className='sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderSmThemen();
        }

        function renderSmThemen() {
            var search = (document.getElementById('smThemenSearch')||{}).value||'';
            var list = smThemen.filter(function(t){
                if(currentSmFilter==='neu' && t.done) return false;
                if(currentSmFilter==='done' && !t.done) return false;
                if(search && t.thema.toLowerCase().indexOf(search.toLowerCase())===-1 && t.id.toLowerCase().indexOf(search.toLowerCase())===-1) return false;
                return true;
            });

            var katColors = {Story:'bg-pink-100 text-pink-700',Technik:'bg-blue-100 text-blue-700',Beratung:'bg-green-100 text-green-700',Werkstatt:'bg-gray-200 text-gray-700',USP:'bg-orange-100 text-orange-700',Tipps:'bg-cyan-100 text-cyan-700',Ergonomie:'bg-purple-100 text-purple-700'};
            var schwColors = {leicht:'ðŸŸ¢',mittel:'ðŸŸ¡',schwer:'ðŸ”´'};

            var el = document.getElementById('smThemenList');
            if(!el) return;
            var h = '';
            list.forEach(function(th,idx){
                var detailId = 'smDetail_'+th.id;
                h += '<div class="vit-card overflow-hidden '+(th.done?'opacity-60 border-l-4 border-green-400':'border-l-4 border-transparent hover:border-l-4 hover:border-vit-orange')+' transition">';

                // Header row (clickable to expand)
                h += '<div class="p-4 flex items-center space-x-4 cursor-pointer" onclick="var d=document.getElementById(\''+detailId+'\');d.style.display=d.style.display===\'none\'?\'block\':\'none\'">';
                // Status icon
                if(th.done) {
                    h += '<div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">âœ“</div>';
                } else {
                    h += '<div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-vit-orange font-bold text-lg flex-shrink-0">â–¶</div>';
                }
                // Title area
                h += '<div class="flex-1 min-w-0">';
                h += '<div class="flex items-center space-x-2 mb-0.5">';
                h += '<span class="text-[10px] font-mono font-bold text-gray-400">'+th.id.toUpperCase()+'</span>';
                h += '<span class="text-[10px] px-1.5 py-0.5 rounded '+(katColors[th.kat]||'bg-gray-100 text-gray-600')+'">'+th.kat+'</span>';
                h += '<span class="text-[10px]">'+schwColors[th.schwierig]+' '+th.schwierig+'</span>';
                if(th.beispiel) h += '<span class="text-[10px] px-1.5 py-0.5 bg-red-50 text-red-600 rounded">ðŸŽ¥ Beispielvideo</span>';
                h += '</div>';
                h += '<p class="text-sm font-semibold text-gray-800">'+th.thema+'</p>';
                h += '</div>';
                // Expand arrow + action
                h += '<div class="flex items-center space-x-2 flex-shrink-0">';
                if(!th.done) h += '<button class="px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:opacity-90 whitespace-nowrap" onclick="event.stopPropagation(); switchSmSub(\'upload\')">'+ t('btn_shoot')+'</button>';
                h += '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
                h += '</div>';
                h += '</div>';

                // Expandable detail (hidden by default)
                h += '<div id="'+detailId+'" style="display:none;" class="px-4 pb-5 border-t border-gray-100 bg-gray-50">';
                h += '<div class="pt-4 space-y-4">';

                // Beispielvideo
                if(th.beispiel) {
                    h += '<div class="p-3 bg-red-50 rounded-lg flex items-center space-x-3">';
                    h += '<span class="text-2xl">ðŸŽ¥</span>';
                    h += '<div class="flex-1"><p class="text-xs font-bold text-gray-700">'+ t('lbl_example_video')+'</p><p class="text-[10px] text-gray-500">'+t('lbl_example_desc')+'</p></div>';
                    h += '<a href="'+th.beispiel+'" target="_blank" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-semibold hover:opacity-90">'+ t('lbl_watch')+'</a>';
                    h += '</div>';
                }

                // Hook
                h += '<div>';
                h += '<p class="text-xs font-bold text-vit-orange uppercase mb-1.5">'+ t('lbl_hook')+'</p>';
                th.hook.forEach(function(hk){
                    h += '<p class="text-sm text-gray-700 italic bg-white p-2 rounded mb-1 border-l-3 border-l-2 border-vit-orange">'+hk+'</p>';
                });
                h += '</div>';

                // Hauptteil
                h += '<div>';
                h += '<p class="text-xs font-bold text-blue-600 uppercase mb-1.5">'+ t('lbl_main')+'</p>';
                h += '<p class="text-sm text-gray-700 bg-white p-3 rounded leading-relaxed">'+th.hauptteil+'</p>';
                h += '</div>';

                // CTA
                h += '<div>';
                h += '<p class="text-xs font-bold text-green-600 uppercase mb-1.5">'+ t('lbl_outro')+'</p>';
                h += '<p class="text-sm text-gray-700 bg-white p-2 rounded italic">'+th.cta+'</p>';
                h += '</div>';

                // HQ Tipp
                if(th.hqTipp) {
                    h += '<div class="p-3 bg-orange-50 rounded-lg border border-orange-200">';
                    h += '<p class="text-xs font-bold text-vit-orange mb-1">'+ t('lbl_hqtip')+'</p>';
                    h += '<p class="text-xs text-gray-600">'+th.hqTipp+'</p>';
                    h += '</div>';
                }

                // Upload CTA
                if(!th.done) {
                    h += '<button class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold text-sm hover:opacity-90 transition" onclick="switchSmSub(\'upload\')">'+ t('btn_upload_now')+'</button>';
                } else {
                    h += '<div class="text-center py-2 text-sm text-green-600 font-semibold">'+ t('lbl_done_video')+'</div>';
                }

                h += '</div></div>';
                h += '</div>';
            });
            if(!list.length) h = '<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">ðŸŽ¬</p><p class="text-sm">Keine Themen gefunden</p></div>';
            el.innerHTML = h;

            // Populate upload select
            var sel = document.getElementById('smUploadThema');
            if(sel && sel.options.length<=1) {
                smThemen.filter(function(t){return !t.done;}).forEach(function(t){
                    sel.innerHTML += '<option value="'+t.id+'">'+t.id.toUpperCase()+' â€“ '+t.thema+'</option>';
                });
                sel.innerHTML += '<option value="0000">0000 â€“ Eigener Vorschlag</option>';
            }
        }

        function renderSmRanking() {
            var el = document.getElementById('smRankingList');
            if(!el) return;
            var sorted = smRankingData.slice().sort(function(a,b){return b.count-a.count;});
            var maxCount = sorted[0]?sorted[0].count:1;
            var h = '';
            sorted.forEach(function(s,i){
                var isMe = s.name==='Grafrath';
                var w = maxCount ? Math.max(5, s.count/maxCount*100) : 5;
                var medal = i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':'';
                h += '<div class="flex items-center space-x-3 p-2 rounded-lg '+(isMe?'bg-orange-50 border border-orange-200':'')+'"><span class="text-xs w-5 text-gray-400 font-bold">'+(i+1)+'</span><span class="text-xs w-28 truncate font-semibold '+(isMe?'text-vit-orange':'text-gray-700')+'">'+medal+' '+s.name+(isMe?' (du)':'')+'</span><div class="flex-1 bg-gray-100 rounded-full h-4"><div class="h-4 rounded-full '+(s.count>0?'bg-gradient-to-r from-vit-orange to-yellow-400':'bg-gray-200')+'" style="width:'+w+'%"></div></div><span class="text-xs font-bold w-8 text-right">'+s.count+'</span></div>';
            });
            el.innerHTML = h;
        }

        function showAllgemeinTab(tabName) {
            document.querySelectorAll('.allg-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.allg-tab-btn').forEach(function(b){
                b.className='allg-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {uebersicht:'Uebersicht',strategie:'Strategie',wissen:'Wissen'};
            var el = document.getElementById('allgTab' + (tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.allg-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='allg-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        function showView(viewName) {
            console.log('showView called with:', viewName);
            
            // Verstecke ALLE Views automatisch (per Klasse statt hardcoded Liste)
            var allViews = document.querySelectorAll('.view');
            console.log('Found', allViews.length, 'views to hide');
            for(var i = 0; i < allViews.length; i++) {
                allViews[i].style.display = 'none';
            }
            
            // Zeige gewÃ¤hlte View
            var viewId = viewName + 'View';
            var viewEl = document.getElementById(viewId);
            if(viewEl) {
                viewEl.style.display = 'block';
                console.log('SUCCESS: Showed', viewId, '- offsetHeight:', viewEl.offsetHeight);
                if(viewName === 'dashboards') initDashboardTabs();
                if(viewName === 'hqModulStatus') renderModulStatus();
                if(viewName === 'controlling') { try { loadBwaList(); } catch(e){} }
                if(viewName === 'support') { try { renderTickets(); } catch(e){} }
                if(viewName === 'ideenboard') { try { renderIdeen(); } catch(e){} }
                if(viewName === 'todo') { try { loadTodos(); } catch(e){} }
                if(viewName === 'kalender') { try { loadKalTermine().then(function(){renderKalender();}); } catch(e){} }
                if(viewName === 'kommunikation') { try { renderBrett(); } catch(e){} }
                if(viewName === 'aktenschrank') { try { loadAktenFiles(); } catch(e){} }
                if(viewName === 'shop') { try { renderShop(); } catch(e){} }
            } else {
                console.error('FAILED: View not found:', viewId);
            }
        }

        // Asana Onboarding Integration
        const ASANA_PROJECT_ID = '1212995737414526'; // Onboarding vit:bikes Partner
        let asanaTasks = [];
        let asanaSections = {};
        
        async function loadAsanaOnboarding() {
            const container = document.getElementById('asanaOnboardingContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vit-orange"></div>
                    <p class="mt-4 text-gray-600 font-semibold">Lade Onboarding-Aufgaben...</p>
                    <p class="mt-2 text-sm text-gray-500">Synchronisiere mit Asana Projekt</p>
                </div>
            `;
            
            // Simuliere kurzes Laden
            setTimeout(() => {
                loadDemoTasks();
                groupTasksBySections();
                renderAsanaTasks();
            }, 800);
        }
        
        
        function loadDemoTasks() {
            // Demo Tasks basierend auf echten Asana Daten
            asanaTasks = [
                // Allgemein - Qualifizierungsphase
                { gid: '1', name: 'Whatsapp-Gruppe beitreten', completed: true, section: 'Allgemein', due_on: null, notes: 'Link zur WhatsApp-Gruppe findest du in der Willkommens-E-Mail', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '2', name: 'Sharepoint Zugang einrichten', completed: true, section: 'Allgemein', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '3', name: 'Vorstellung Teams im BÃ¼ro', completed: false, section: 'Allgemein', due_on: '2026-02-20', assignee: { name: 'Jens Bader' }, notes: 'Kennenlernen der Kollegen im HQ', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '4', name: 'Das vit:bikes Portal kennenlernen', completed: false, section: 'Allgemein', due_on: '2026-02-18', assignee: { name: 'Markus Unger' }, notes: 'EinfÃ¼hrung in alle Features', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '5', name: 'Lizenzvertrag durchgehen', completed: false, section: 'Allgemein', due_on: '2026-02-19', assignee: { name: 'Markus Unger' }, notes: 'Vertragsdetails klÃ¤ren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // vit:bikes basic
                { gid: '10', name: 'Akademie App installieren', completed: true, section: 'vit:bikes basic', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '11', name: 'Module durchgehen', completed: true, section: 'vit:bikes basic', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '12', name: 'Social Media KanÃ¤le folgen', completed: true, section: 'vit:bikes basic', due_on: null, notes: 'Instagram, LinkedIn, Facebook', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '13', name: 'Die Entwicklung des Fahrradmarktes verstehen', completed: false, section: 'vit:bikes basic', due_on: '2026-02-22', notes: 'Video-Kurs in der Akademie', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '14', name: 'Zielgruppe definieren', completed: false, section: 'vit:bikes basic', due_on: '2026-02-24', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Marketing
                { gid: '20', name: 'Willkommen im Marketing-Modul', completed: true, section: 'Marketing', due_on: null, assignee: { name: 'Mike' }, notes: 'EinfÃ¼hrung von Mike', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '21', name: 'Google My Business Profil optimieren', completed: true, section: 'Marketing', due_on: null, notes: 'Schritt-fÃ¼r-Schritt Anleitung befolgen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '22', name: 'Social Media Bestandsaufnahme', completed: true, section: 'Marketing', due_on: null, notes: 'Alle Profile durchgehen und dokumentieren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '23', name: 'Youtube Kanal einrichten', completed: false, section: 'Marketing', due_on: '2026-02-25', assignee: { name: 'Basti Schrecker' }, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '24', name: 'Website Check durchfÃ¼hren', completed: false, section: 'Marketing', due_on: '2026-02-28', notes: 'Performance, SEO, UX prÃ¼fen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '25', name: 'Strategie-Meeting mit Mike', completed: false, section: 'Marketing', due_on: '2026-03-03', assignee: { name: 'Mike' }, notes: 'Marketingstrategie besprechen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Verkauf
                { gid: '30', name: 'Was ist Verkauf?', completed: true, section: 'Verkauf', due_on: null, notes: 'Grundlagen-Video ansehen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '31', name: 'vit:bikes Verkaufsablauf lernen', completed: true, section: 'Verkauf', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '32', name: 'Die Erfolgstabelle verstehen', completed: true, section: 'Verkauf', due_on: null, notes: 'Tracking-System einfÃ¼hren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '33', name: '3D-Vermessungssystem Training', completed: false, section: 'Verkauf', due_on: '2026-02-21', notes: 'Praktisches Training vor Ort', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '34', name: 'FahrspaÃŸgarantie verstehen', completed: false, section: 'Verkauf', due_on: '2026-02-26', notes: 'USP von vit:bikes', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '35', name: 'Verkaufstraining fÃ¼r Mitarbeiter', completed: false, section: 'Verkauf', due_on: '2026-03-01', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Einkauf
                { gid: '40', name: 'Willkommen im Einkaufssystem', completed: false, section: 'Einkauf', due_on: '2026-02-19', assignee: { name: 'Florian' }, notes: 'EinfÃ¼hrung von Florian', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '41', name: 'Gemeinsam stark Prinzip verstehen', completed: false, section: 'Einkauf', due_on: '2026-02-23', notes: 'Warum Gruppenvolumen Konditionssprung bedeutet', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '42', name: 'Zentralregulierung erklÃ¤rt', completed: false, section: 'Einkauf', due_on: '2026-02-27', notes: 'IHT statt Bico Prozess', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '43', name: 'Kernsortiment: 7-8 Marken Strategie', completed: false, section: 'Einkauf', due_on: '2026-03-02', notes: 'Fokus auf Kernlieferanten', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '44', name: '4-Marken-Strategie definieren', completed: false, section: 'Einkauf', due_on: '2026-03-05', notes: 'Expertenstatus statt Bauchladen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Werkstatt
                { gid: '50', name: 'Werkstatt-Prozesse kennenlernen', completed: false, section: 'Werkstatt', due_on: '2026-02-24', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '51', name: 'Service-Standards vit:bikes', completed: false, section: 'Werkstatt', due_on: '2026-03-01', notes: 'QualitÃ¤tsrichtlinien', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Toolbox
                { gid: '60', name: 'Quiply App installieren', completed: false, section: 'Toolbox', due_on: '2026-02-20', notes: 'Interne Kommunikation', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '61', name: 'Todoist einrichten', completed: false, section: 'Toolbox', due_on: '2026-02-22', notes: 'Task Management', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '62', name: 'Outlook konfigurieren', completed: false, section: 'Toolbox', due_on: '2026-02-25', notes: 'E-Mail Setup', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` }
            ];
        }
        
        function groupTasksBySections() {
            asanaSections = {};
            
            asanaTasks.forEach(task => {
                if (task.memberships && task.memberships.length > 0) {
                    const sectionName = task.memberships[0].section.name;
                    
                    if (!asanaSections[sectionName]) {
                        asanaSections[sectionName] = [];
                    }
                    
                    asanaSections[sectionName].push(task);
                }
            });
        }
        
        function renderAsanaTasks() {
            const container = document.getElementById('asanaOnboardingContent');
            
            // Berechne Gesamt-Fortschritt
            const totalTasks = asanaTasks.length;
            const completedTasks = asanaTasks.filter(t => t.completed).length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            let html = `
                <!-- Header mit Fortschritt -->
                <div class="vit-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="h2-headline text-gray-800">Dein Onboarding-Plan</h2>
                        <a href="https://app.asana.com/0/${ASANA_PROJECT_ID}" target="_blank" class="text-sm text-vit-orange hover:underline font-semibold">
                            In Asana Ã¶ffnen â†’
                        </a>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-6">Live synchronisiert mit Asana â€¢ ${totalTasks} Aufgaben</p>

                    <!-- Gesamt-Fortschritt -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Gesamt-Fortschritt</span>
                            <span class="text-sm font-semibold text-vit-orange">${progress}% (${completedTasks}/${totalTasks})</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-vit-orange h-3 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Wichtige Sections die wir anzeigen wollen
            const sectionsToShow = [
                'Allgemein',
                'vit:bikes basic',
                'Marketing', 
                'Verkauf',
                'Einkauf',
                'Werkstatt',
                'Toolbox'
            ];
            
            sectionsToShow.forEach(sectionName => {
                if (asanaSections[sectionName]) {
                    html += renderSection(sectionName, asanaSections[sectionName]);
                }
            });
            
            container.innerHTML = html;
        }
        
        function renderSection(sectionName, tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const sectionProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Filter out separator tasks (those starting with --)
            const realTasks = tasks.filter(t => !t.name.startsWith('--'));
            
            if (realTasks.length === 0) return '';
            
            return `
                <div class="vit-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            ${getSectionIcon(sectionName)}
                            <span class="ml-2">${sectionName}</span>
                            <span class="ml-3 text-sm font-normal text-gray-500">${completedTasks}/${totalTasks}</span>
                        </h3>
                        <div class="text-sm font-semibold ${sectionProgress === 100 ? 'text-green-600' : 'text-vit-orange'}">
                            ${sectionProgress}%
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-vit-orange h-2 rounded-full transition-all duration-500" style="width: ${sectionProgress}%"></div>
                    </div>
                    
                    <div class="space-y-2">
                        ${realTasks.map(task => renderTask(task)).join('')}
                    </div>
                </div>
            `;
        }
        
        function getSectionIcon(sectionName) {
            const icons = {
                'Allgemein': 'ðŸ“‹',
                'vit:bikes basic': 'ðŸŽ“',
                'Marketing': 'ðŸ“¢',
                'Verkauf': 'ðŸŽ¯',
                'Einkauf': 'ðŸ›’',
                'Werkstatt': 'ðŸ”§',
                'Toolbox': 'ðŸ› ï¸',
                'Mitarbeiter/Team': 'ðŸ‘¥'
            };
            return `<span class="text-2xl">${icons[sectionName] || 'ðŸ“Œ'}</span>`;
        }
        
        function renderTask(task) {
            const isCompleted = task.completed;
            const dueDate = task.due_on ? new Date(task.due_on).toLocaleDateString('de-DE') : null;
            const assignee = task.assignee ? task.assignee.name : null;
            
            return `
                <div class="flex items-start space-x-3 p-3 ${isCompleted ? 'bg-green-50' : 'bg-white border border-gray-200'} rounded-lg hover:shadow-sm transition-shadow">
                    <input 
                        type="checkbox" 
                        ${isCompleted ? 'checked' : ''} 
                        onchange="toggleTaskCompletion('${task.gid}', this.checked)"
                        class="w-5 h-5 mt-0.5 text-vit-orange rounded cursor-pointer"
                    >
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <span class="text-sm ${isCompleted ? 'text-gray-500 line-through' : 'text-gray-700 font-medium'}">
                                ${task.name}
                            </span>
                            ${dueDate || assignee ? `
                                <div class="flex items-center space-x-2 ml-2">
                                    ${dueDate ? `<span class="text-xs text-gray-500">ðŸ“… ${dueDate}</span>` : ''}
                                    ${assignee ? `<span class="text-xs text-gray-500">ðŸ‘¤ ${assignee}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${task.notes ? `
                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">${task.notes}</p>
                        ` : ''}
                    </div>
                    <a href="${task.permalink_url}" target="_blank" class="text-gray-400 hover:text-vit-orange">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            `;
        }
        
        async function toggleTaskCompletion(taskGid, completed) {
            try {
                // Optimistic UI Update
                const task = asanaTasks.find(t => t.gid === taskGid);
                if (task) {
                    task.completed = completed;
                    renderAsanaTasks();
                }
                
                // Update in Asana via MCP
                const response = await fetch('/api/asana/task/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_id: taskGid,
                        completed: completed
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update task');
                }
                
                // Show success feedback
                showNotification(completed ? 'âœ… Aufgabe abgeschlossen!' : 'â†©ï¸ Aufgabe reaktiviert', 'success');
                
            } catch (error) {
                console.error('Error updating task:', error);
                
                // Revert optimistic update
                const task = asanaTasks.find(t => t.gid === taskGid);
                if (task) {
                    task.completed = !completed;
                    renderAsanaTasks();
                }
                
                showNotification('âŒ Fehler beim Aktualisieren', 'error');
            }
        }
        
        
        // Verkaufserfolg Tracking Functions
        function updateSalesData() {
            const planned = parseInt(document.getElementById('plannedInput').value) || 0;
            const spontaneous = parseInt(document.getElementById('spontaneousInput').value) || 0;
            const online = parseInt(document.getElementById('onlineInput').value) || 0;
            const ergo = parseInt(document.getElementById('ergoInput').value) || 0;
            const sales = parseInt(document.getElementById('salesInput').value) || 0;
            
            // Berechne Gesamt-Beratungen
            const totalConsultations = planned + spontaneous + online;
            
            // Berechne Quote
            const quote = totalConsultations > 0 ? Math.round((sales / totalConsultations) * 100) : 0;
            
            // Update Display
            document.getElementById('totalConsultations').textContent = totalConsultations;
            document.getElementById('quoteDisplay').textContent = quote + '%';
            
            // FÃ¤rbe Quote je nach Performance
            const quoteElement = document.getElementById('quoteDisplay');
            if (quote >= 40) {
                quoteElement.className = 'text-2xl font-bold text-green-600';
            } else if (quote >= 25) {
                quoteElement.className = 'text-2xl font-bold text-blue-600';
            } else {
                quoteElement.className = 'text-2xl font-bold text-orange-600';
            }
        }
        
        function saveSalesData() {
            var salesperson = document.getElementById('salesPersonSelect').value;
            var planned = document.getElementById('plannedInput').value;
            var spontaneous = document.getElementById('spontaneousInput').value;
            var online = document.getElementById('onlineInput').value;
            var ergo = document.getElementById('ergoInput').value;
            
            // Show success feedback
            var btn = event && event.target ? event.target : null;
            if(btn) {
                var orig = btn.innerHTML;
                btn.innerHTML = 'âœ… Gespeichert!';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-vit-orange');
                setTimeout(function(){ btn.innerHTML = orig; btn.classList.remove('bg-green-500'); btn.classList.add('bg-vit-orange'); }, 2000);
            }
        }
    </script>
</body>
</html>