<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vit:bikes Partnerportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <style>
        * {
            font-family: 'Open Sans', sans-serif;
        }
        
        /* vit:bikes Corporate Colors */
        :root {
            --vit-orange: #EF7D00;
            --vit-gray: #626062;
            --vit-black: #000000;
            --vit-white: #FFFFFF;
        }
        
        .bg-vit-orange { background-color: var(--vit-orange); }
        .bg-vit-gray { background-color: var(--vit-gray); }
        .text-vit-orange { color: var(--vit-orange); }
        .text-vit-gray { color: var(--vit-gray); }
        .border-vit-orange { border-color: var(--vit-orange); }
        .hover\:bg-vit-orange:hover { background-color: var(--vit-orange); }
        
        /* Corporate Font Styles */
        .h1-headline {
            font-weight: 700;
            font-size: 26px;
            line-height: 32px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--vit-black);
        }
        
        .h2-headline {
            font-weight: 400;
            font-size: 12px;
            line-height: 18px;
            text-transform: uppercase;
            position: relative;
            padding-bottom: 8px;
            display: inline-block;
        }
        
        .h2-headline::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -3mm;
            width: 15.5mm;
            height: 0.5pt;
            background-color: var(--vit-orange);
        }
        
        /* Gradient Backgrounds */
        .vit-gradient {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }
        
        /* Subtiler vit-Hintergrund fÃ¼r Main Content */
        .vit-background {
            position: relative;
        }
        
        .vit-background::before {
            content: '';
            position: fixed;
            top: 0;
            left: 256px; /* Sidebar width */
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            z-index: -1;
        }
        
        /* Card Styles */
        .vit-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .vit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 125, 0, 0.2);
        }
        
        /* vit-Logo Watermark auf Cards */
        .vit-card-watermark::before {
            content: 'vit';
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 120px;
            font-weight: 900;
            color: rgba(239, 125, 0, 0.03);
            pointer-events: none;
            font-style: italic;
        }
        
        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
        }
        
        .sidebar-item {
            transition: all 0.2s;
        }
        
        .sidebar-item:hover {
            background-color: rgba(239, 125, 0, 0.1);
            border-left: 3px solid var(--vit-orange);
        }
        
        .sidebar-item.active {
            background-color: rgba(239, 125, 0, 0.15);
            border-left: 3px solid var(--vit-orange);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new { 
            background-color: rgba(239, 125, 0, 0.15); 
            color: var(--vit-orange);
            border: 1px solid var(--vit-orange);
        }
        .status-inprogress { 
            background-color: var(--vit-orange); 
            color: white; 
        }

        /* Badge-System wird jetzt Ã¼ber modul_status DB gesteuert */
        /* Dev-Status Badge styles */
        .dev-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .dev-badge.live { background-color: #dcfce7; color: #15803d; }
        .dev-badge.beta { background-color: #ede9fe; color: #6d28d9; }
        .dev-badge.demo { background-color: #fef3c7; color: #b45309; }
        .dev-badge.wip { background-color: #dbeafe; color: #1d4ed8; }
        .dev-badge.planned { background-color: #f3f4f6; color: #6b7280; }

        .status-done { 
            background-color: var(--vit-gray); 
            color: white; 
        }
        
        /* Chat Styles */
        .chat-message {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .chat-message.sent {
            background-color: var(--vit-orange);
            color: white;
            margin-left: 20%;
        }
        
        .chat-message.received {
            background-color: #F3F4F6;
            margin-right: 20%;
        }
        
        /* Forum Styles */
        .forum-post {
            border-left: 3px solid var(--vit-orange);
            padding-left: 15px;
        }
        
        /* Corporate Bullets - Orangene Kreise */
        .vit-list {
            list-style: none;
            padding-left: 0;
        }
        
        .vit-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
        }
        
        .vit-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 7px;
            width: 8px;
            height: 8px;
            background-color: var(--vit-orange);
            border-radius: 50%;
        }
        
        /* Hide class for view switching - MUST override Tailwind */
        /* Premium Feature Locks */
        .premium-feature {
            position: relative;
        }
        
        .premium-feature.locked::after {
            content: 'ðŸ”’ Nur fÃ¼r vit:bikes Partner';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--vit-gray);
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #EF7D00 0%, #FF9500 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .locked-menu-item {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .locked-menu-item::after {
            content: 'ðŸ”’';
            margin-left: auto;
            font-size: 12px;
        }

        /* === MOBILE RESPONSIVE === */
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
        }
        #sidebarOverlay.active { display: block; }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px !important;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .topnav-desktop { display: none !important; }
            .topnav-mobile { display: flex !important; }
            .main-content-area {
                margin-left: 0 !important;
                padding: 16px !important;
            }
        }
        @media (min-width: 769px) {
            .topnav-mobile { display: none !important; }
            .topnav-desktop { display: flex !important; }
            #sidebarOverlay { display: none !important; }
        }

        /* Tab navigation scroll on mobile */
        nav.-mb-px {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        nav.-mb-px::-webkit-scrollbar { display: none; }

        /* Headline responsive */
        @media (max-width: 768px) {
            .h1-headline { font-size: 1.25rem !important; }
        }
    
        @keyframes tpulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1.2)}}
        .t-msg-customer{padding:12px 16px;border-radius:12px;background:#f9fafb;border:1px solid #e5e7eb;margin-bottom:8px}
        .t-msg-seller{padding:12px 16px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;margin-left:48px;margin-bottom:8px}
        .t-msg-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
        .t-msg-text{font-size:13px;color:#374151;line-height:1.5}
        .t-scenario-card{cursor:pointer;transition:all 0.2s}.t-scenario-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}

/* === EINKAUF MODULE CSS (from standalone) === */
.vc{background:#fff;border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);border:1px solid #eee;transition:box-shadow .2s}.vc:hover{box-shadow:0 6px 20px rgba(0,0,0,.08)}
.pill{display:inline-flex;align-items:center;padding:2px 9px;border-radius:99px;font-size:10px;font-weight:700;letter-spacing:.3px}
.pg{background:#ecfdf5;color:#059669}.py{background:#fefce8;color:#ca8a04}.pr{background:#fef2f2;color:#dc2626}.pb{background:#eff6ff;color:#2563eb}.pgr{background:#f3f4f6;color:#6b7280}.po{background:#fff7ed;color:#ea580c}
.prog{height:6px;border-radius:3px;background:#e5e7eb;overflow:hidden}.pf{height:100%;border-radius:3px;transition:width .4s}
.si{border:1.5px solid #e5e7eb;border-radius:10px;padding:7px 11px 7px 34px;font-size:12.5px;transition:border .15s;width:100%}.si:focus{outline:none;border-color:var(--vit-orange, #EF7D00);box-shadow:0 0 0 3px rgba(239,125,0,.1)}
.fi{animation:fi .25s ease}@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.td{transition:background .15s;border-radius:7px;padding:7px 9px}.td:hover{background:#fef7ed}
.td input[type=checkbox]{accent-color:#EF7D00;width:15px;height:15px}
.dt{width:100%;border-collapse:collapse;font-size:12.5px}.dt th{background:#fafafa;font-weight:600;color:#666;padding:9px 12px;text-align:left;border-bottom:1.5px solid #eee}.dt td{padding:8px 12px;border-bottom:1px solid #f3f3f3}.dt tr:hover td{background:#fafafa}
.wn{padding:7px 14px;border-radius:9px;font-size:11.5px;font-weight:600;cursor:pointer;transition:all .15s;border:1.5px solid transparent}.wn.on{background:#EF7D00;color:#fff;border-color:#EF7D00}.wn:not(.on){background:#fff;color:#666;border-color:#e5e7eb}.wn:not(.on):hover{border-color:#EF7D00;color:#EF7D00}
.mc{transition:all .2s}.mc:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.1)}
.rbtn{display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:9px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;border:1.5px solid #e5e7eb;background:#fff;color:#666}.rbtn:hover{border-color:#EF7D00;color:#EF7D00}
.vbtn{background:#EF7D00;color:#fff;border:none;padding:7px 18px;border-radius:9px;font-size:12px;font-weight:600;cursor:pointer}.vbtn:hover{opacity:.9}
.ek-modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:100;display:flex;align-items:center;justify-content:center}
.ek-modal{background:#fff;border-radius:16px;max-width:720px;width:95%;max-height:85vh;overflow-y:auto;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.2)}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- â•â•â• DUAL THEME SYSTEM â•â•â• -->
<style>
/* â”€â”€ Light Theme (Default) â”€â”€ */
:root, [data-theme="light"] {
    --bg: #f7f7f8;
    --surface: #ffffff;
    --surface-2: #f3f4f6;
    --surface-3: #e5e7eb;
    --border: #e5e7eb;
    --border-light: #d1d5db;
    --text: #111827;
    --text-2: #4b5563;
    --text-3: #9ca3af;
    --vit: #EF7D00;
    --vit-glow: rgba(239,125,0,0.12);
    --vit-light: rgba(239,125,0,0.08);
    --green: #16a34a;
    --green-bg: rgba(22,163,74,0.08);
    --yellow: #ca8a04;
    --yellow-bg: rgba(202,138,4,0.08);
    --red: #dc2626;
    --red-bg: rgba(220,38,38,0.08);
    --blue: #2563eb;
    --blue-bg: rgba(37,99,235,0.08);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --card-hover: 0 4px 20px rgba(0,0,0,0.06);
    --sidebar-bg: #ffffff;
    --sidebar-text: #374151;
    --sidebar-hover: #f3f4f6;
    --input-bg: #ffffff;
    --modal-bg: #ffffff;
    --header-bg: rgba(255,255,255,0.85);
}

/* â”€â”€ Dark Theme â”€â”€ */
[data-theme="dark"] {
    --bg: #0a0a0b;
    --surface: #141416;
    --surface-2: #1c1c1f;
    --surface-3: #242428;
    --border: #2a2a2e;
    --border-light: #3a3a3f;
    --text: #f5f5f5;
    --text-2: #a1a1aa;
    --text-3: #71717a;
    --vit: #EF7D00;
    --vit-glow: rgba(239,125,0,0.25);
    --vit-light: rgba(239,125,0,0.12);
    --green: #22c55e;
    --green-bg: rgba(34,197,94,0.12);
    --yellow: #eab308;
    --yellow-bg: rgba(234,179,8,0.12);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.12);
    --blue: #3b82f6;
    --blue-bg: rgba(59,130,246,0.12);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
    --card-hover: 0 0 20px rgba(239,125,0,0.15);
    --sidebar-bg: #111113;
    --sidebar-text: #d4d4d8;
    --sidebar-hover: #1c1c1f;
    --input-bg: #1c1c1f;
    --modal-bg: #141416;
    --header-bg: rgba(10,10,11,0.85);
}

/* â”€â”€ Global Transition â”€â”€ */
body, .vit-card, .sidebar-item, input, select, textarea, .ek-modal, th, td {
    transition: background-color 0.35s ease, color 0.35s ease, border-color 0.35s ease;
}

/* â”€â”€ Dark Mode Global Overrides â”€â”€ */
[data-theme="dark"] body,
[data-theme="dark"] .bg-gray-50,
[data-theme="dark"] .bg-white {
    background-color: var(--bg) !important;
    color: var(--text) !important;
}

/* Cards */
[data-theme="dark"] .vit-card,
[data-theme="dark"] .card,
[data-theme="dark"] [class*="bg-white"] {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
    color: var(--text) !important;
}

/* Surface variants */
[data-theme="dark"] .bg-gray-100,
[data-theme="dark"] .bg-gray-50 {
    background-color: var(--surface-2) !important;
}
[data-theme="dark"] .bg-gray-200 {
    background-color: var(--surface-3) !important;
}

/* Text colors */
[data-theme="dark"] .text-gray-800,
[data-theme="dark"] .text-gray-900 {
    color: var(--text) !important;
}
[data-theme="dark"] .text-gray-700,
[data-theme="dark"] .text-gray-600 {
    color: var(--text-2) !important;
}
[data-theme="dark"] .text-gray-500,
[data-theme="dark"] .text-gray-400 {
    color: var(--text-3) !important;
}

/* Sidebar */
[data-theme="dark"] .sidebar,
[data-theme="dark"] #mainSidebar {
    background-color: var(--sidebar-bg) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] .sidebar-item {
    color: var(--sidebar-text) !important;
}
[data-theme="dark"] .sidebar-item:hover,
[data-theme="dark"] .sidebar-item.active {
    background-color: var(--sidebar-hover) !important;
}

/* Header / Top Nav */
[data-theme="dark"] #topNavbar,
[data-theme="dark"] .top-nav,
[data-theme="dark"] nav[class*="bg-white"] {
    background-color: var(--header-bg) !important;
    border-color: var(--border) !important;
    backdrop-filter: blur(12px);
}

/* Inputs */
[data-theme="dark"] input:not([type="checkbox"]):not([type="radio"]):not([type="range"]),
[data-theme="dark"] select,
[data-theme="dark"] textarea,
[data-theme="dark"] .form-input {
    background-color: var(--input-bg) !important;
    border-color: var(--border) !important;
    color: var(--text) !important;
}
[data-theme="dark"] input::placeholder,
[data-theme="dark"] textarea::placeholder {
    color: var(--text-3) !important;
}

/* Tables */
[data-theme="dark"] table th {
    background-color: var(--surface-2) !important;
    color: var(--text-2) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] table td {
    border-color: var(--border) !important;
    color: var(--text) !important;
}
[data-theme="dark"] table tr:hover td {
    background-color: var(--surface-2) !important;
}

/* Borders */
[data-theme="dark"] .border-gray-200,
[data-theme="dark"] .border-gray-100,
[data-theme="dark"] .border-gray-300,
[data-theme="dark"] [class*="border-gray"] {
    border-color: var(--border) !important;
}
[data-theme="dark"] .divide-gray-200 > * + * {
    border-color: var(--border) !important;
}

/* Modals */
[data-theme="dark"] .ek-modal,
[data-theme="dark"] [class*="modal"] {
    background-color: var(--modal-bg) !important;
    border-color: var(--border) !important;
}

/* Profile Panel */
[data-theme="dark"] #profileSlider {
    background-color: var(--surface) !important;
}

/* Badges / Pills */
[data-theme="dark"] .bg-green-50 { background-color: var(--green-bg) !important; }
[data-theme="dark"] .bg-orange-50 { background-color: var(--vit-light) !important; }
[data-theme="dark"] .bg-red-50 { background-color: var(--red-bg) !important; }
[data-theme="dark"] .bg-blue-50 { background-color: var(--blue-bg) !important; }
[data-theme="dark"] .bg-yellow-50 { background-color: var(--yellow-bg) !important; }
[data-theme="dark"] .bg-purple-50 { background-color: rgba(147,51,234,0.12) !important; }

/* Shadows */
[data-theme="dark"] .shadow-sm,
[data-theme="dark"] .shadow,
[data-theme="dark"] .shadow-md {
    box-shadow: var(--shadow-sm) !important;
}

/* Scrollbar */
[data-theme="dark"]::-webkit-scrollbar-thumb { background: var(--border); }
[data-theme="dark"]::-webkit-scrollbar-track { background: var(--bg); }

/* Login Screen */
[data-theme="dark"] #loginScreen {
    background-color: var(--bg) !important;
}
[data-theme="dark"] #loginScreen .bg-white {
    background-color: var(--surface) !important;
}

/* Pipeline / Kanban */
[data-theme="dark"] [style*="background:#f9fafb"],
[data-theme="dark"] [style*="background: #f9fafb"],
[data-theme="dark"] [style*="background:#f3f4f6"],
[data-theme="dark"] [style*="background: #f3f4f6"] {
    background-color: var(--surface-2) !important;
}

/* Inline style overrides for common patterns */
[data-theme="dark"] [style*="background:#fff"],
[data-theme="dark"] [style*="background: #fff"],
[data-theme="dark"] [style*="background:white"],
[data-theme="dark"] [style*="background: white"],
[data-theme="dark"] [style*="background-color:#fff"],
[data-theme="dark"] [style*="background-color: #fff"],
[data-theme="dark"] [style*="background-color:white"] {
    background-color: var(--surface) !important;
}
[data-theme="dark"] [style*="color:#111827"],
[data-theme="dark"] [style*="color: #111827"],
[data-theme="dark"] [style*="color:#374151"],
[data-theme="dark"] [style*="color: #374151"] {
    color: var(--text) !important;
}
[data-theme="dark"] [style*="color:#6b7280"],
[data-theme="dark"] [style*="color: #6b7280"],
[data-theme="dark"] [style*="color:#4b5563"],
[data-theme="dark"] [style*="color: #4b5563"] {
    color: var(--text-2) !important;
}
[data-theme="dark"] [style*="border-color:#e5e7eb"],
[data-theme="dark"] [style*="border:1px solid #e5e7eb"],
[data-theme="dark"] [style*="border: 1px solid #e5e7eb"] {
    border-color: var(--border) !important;
}

/* Hover glow for cards in dark mode */
[data-theme="dark"] .vit-card:hover {
    box-shadow: var(--card-hover) !important;
}

/* Tab buttons */
[data-theme="dark"] .ctrl-tab-btn,
[data-theme="dark"] .vk-tab-btn,
[data-theme="dark"] button[class*="tab-btn"] {
    color: var(--text-3) !important;
}
[data-theme="dark"] .ctrl-tab-btn.active,
[data-theme="dark"] button[class*="tab-btn"][class*="text-vit-orange"],
[data-theme="dark"] button[class*="tab-btn"][style*="border-color:#EF7D00"] {
    color: var(--vit) !important;
}

/* Trainer cards in dark */
[data-theme="dark"] .trainer-card {
    background: linear-gradient(135deg, var(--surface-2), var(--surface)) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] .trainer-drawer {
    background-color: var(--surface) !important;
}
[data-theme="dark"] .trainer-step.active {
    background-color: var(--surface-2) !important;
}

/* â”€â”€ Dark Mode Refinements â”€â”€ */

/* Daily Focus tiles: use surface instead of transparent color bg */
[data-theme="dark"] #dailyFocusBlock .bg-green-50,
[data-theme="dark"] #dailyFocusBlock .bg-orange-50,
[data-theme="dark"] #dailyFocusBlock .bg-blue-50,
[data-theme="dark"] #dailyFocusBlock .bg-purple-50,
[data-theme="dark"] #dailyFocusBlock .bg-yellow-50 {
    background-color: var(--surface-2) !important;
    border: 1px solid var(--border) !important;
}

/* Daily Focus impulse bar */
[data-theme="dark"] #dailyImpulse {
    background: var(--surface-2) !important;
}

/* Quick Action Cards on Home */
[data-theme="dark"] .vit-card {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
}

/* Sub-text in tiles */
[data-theme="dark"] .text-green-500,
[data-theme="dark"] .text-green-600 { color: var(--green) !important; }
[data-theme="dark"] .text-orange-500,
[data-theme="dark"] .text-vit-orange { color: var(--vit) !important; }
[data-theme="dark"] .text-blue-500,
[data-theme="dark"] .text-blue-600 { color: var(--blue) !important; }
[data-theme="dark"] .text-yellow-500,
[data-theme="dark"] .text-yellow-600 { color: var(--yellow) !important; }
[data-theme="dark"] .text-red-500,
[data-theme="dark"] .text-red-600 { color: var(--red) !important; }

/* Headlines in dark */
[data-theme="dark"] .h1-headline,
[data-theme="dark"] .h2-headline { color: var(--text) !important; }

/* Progress bar tracks */
[data-theme="dark"] .bg-gray-200.rounded-full,
[data-theme="dark"] [class*="bg-gray-200"][class*="rounded-full"] {
    background-color: var(--surface-3) !important;
}

/* KPI cards in controlling/dashboard */
[data-theme="dark"] [class*="border-green-200"],
[data-theme="dark"] [class*="border-orange-200"],
[data-theme="dark"] [class*="border-blue-200"],
[data-theme="dark"] [class*="border-red-200"] {
    border-color: var(--border) !important;
}

/* Streak momentum bar */
[data-theme="dark"] #salesMomentumBar .vit-card {
    background-color: var(--surface) !important;
}

/* BWA Deadline Widget */
[data-theme="dark"] #bwaDeadlineWidget {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] #bwaEskalationBanner {
    background-color: var(--red-bg) !important;
    border-color: rgba(239,68,68,0.2) !important;
}

/* Benchmark lock */
[data-theme="dark"] #benchmarkLockOverlay .vit-card {
    border-color: var(--border) !important;
    background-color: var(--surface) !important;
}

/* HQ BWA Status Dashboard */
[data-theme="dark"] #hqBwaStatusDashboard .vit-card {
    background-color: var(--surface) !important;
}

/* Dropdown menus */
[data-theme="dark"] [class*="dropdown"],
[data-theme="dark"] [role="menu"] {
    background-color: var(--surface) !important;
    border-color: var(--border) !important;
}

/* Rounded icon boxes (Quick Actions) keep their color */
[data-theme="dark"] .rounded-2xl[class*="bg-green"],
[data-theme="dark"] .rounded-2xl[class*="bg-orange"],
[data-theme="dark"] .rounded-2xl[class*="bg-blue"],
[data-theme="dark"] .rounded-2xl[class*="bg-purple"] {
    opacity: 0.9;
}

/* Skeleton placeholders */
[data-theme="dark"] .animate-pulse .bg-gray-200,
[data-theme="dark"] [class*="skeleton"] {
    background-color: var(--surface-3) !important;
}

/* Status badges */
[data-theme="dark"] .bg-green-100 { background-color: var(--green-bg) !important; }
[data-theme="dark"] .bg-red-100 { background-color: var(--red-bg) !important; }
[data-theme="dark"] .bg-yellow-100 { background-color: var(--yellow-bg) !important; }
[data-theme="dark"] .bg-blue-100 { background-color: var(--blue-bg) !important; }
[data-theme="dark"] .bg-orange-100 { background-color: var(--vit-light) !important; }
[data-theme="dark"] .bg-purple-100 { background-color: rgba(147,51,234,0.12) !important; }
[data-theme="dark"] .bg-gray-100 { background-color: var(--surface-2) !important; }

/* Space/Gap fix: ensure all text colors are readable */
[data-theme="dark"] p, [data-theme="dark"] span, [data-theme="dark"] h1,
[data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4,
[data-theme="dark"] label, [data-theme="dark"] li, [data-theme="dark"] td,
[data-theme="dark"] th, [data-theme="dark"] a:not(.text-vit-orange):not([class*="text-green"]):not([class*="text-red"]):not([class*="text-blue"]) {
    color: inherit;
}

/* Fix ring-track for BWA countdown */
[data-theme="dark"] #bwaCountdownRing circle[stroke="#f3f4f6"] {
    stroke: var(--surface-3);
}

</style>

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center vit-background relative" style="display:flex;">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-block mb-6">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAABGCAYAAAAq7+rZAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAA+V0lEQVR42u19d3wc1bX/99w7M1ukVbeMsTGYjkwJGAh5KbIJNXSbFb05weQFCIGQnrDatJc8Elp+gcQPCOaBk2jpGDDwAha9iW4RwBBsZMtWb6stc+89vz9mRl7bkrUGkwDR+XwGCXl25s7sPd97zveUSy9cUHLXfttkj+vLaE0ESSBjyBYvrwulDl442MBNkNQAA4CxlYUTEJSEOe+zk3c476D0ZZWOmVcRyseIDABDH/S6hqErI0K+2hF6dP7VdYe/EG8xlIIO7ndjvOTUg3cyC6vtbEQzEwg0zvU46oA7hpz+G14t3funS3vaDECNCVBjI/hX88pnHL+9fmBa2fAuyhgQQPiIxRihK0uEfPQfzrKD/yd9MDMREQwmZEI+hIhFK0JnvtEdfrkySpIBTWBhkdJzdsjEm79R8itqgOYE5EcFBlccW73/9+r7n9i3dvic2pLhMiJNAH9ghWIGOxLozFj8/Jrwj1rQ4qYAJBIQAHD4PuU7HDhN3zC9JFeiDI0LBgAgAG1LKf7e4/w6ubSnzTRBEsCNM0FE4EOmqmt3n5zZ1TXG/DPAgAGOWAZrh6T7xJropQBxquGjv++E/BsAwu+W9gz8sSXS8E5/eKDUJqEYRhsjBzNaHTRFfe/W06suoCTUHxfA3ooTmgDgtAOryg7fKX3PjIrs1N5ho1xFviHywYwRAmBApsSR8u/d9g1fS/U+zU2QDSnoxpkgSsJ8e3+VnDnJDfdlWZEY3woxBqY0RPLv3fabh11ffTUnIKgBhuOQ1AC9+OSyhr0m5Q4fSGslsPWBc4wXqMMhKVu7Qtdcdl9XS/CME9N5Qj40IDxaD+uax7reXvqGfVJf3uaI5WmkYpJK5/XhO6Svui5eduh5C+E2xbfShG/yrIOvfSZ7WV2tmtI3DFcIWKAP55VoJo7ZoJWDVs8NrTU/4QRE43JwUxxSNED/8YSa/fbbxj01nWEjqLhnsQQ4YyS9tDZ8KbAyi1Z/Ja4Dz5o1JXrg1OwvJSnW7FkgHzkWMEzUgXy3x1pz87OVP+cEBBomXIUJ2UqAMKcZihOwLrh3YGlzW/ibUtrSArQgppzLVGbnxSE7uHecf1DlXg0p6A8LCk1xSMRhrjm6evfdq/WFmazSAKyt8TAENtKS4s1OK7moeeVazAQlkzDxuGdzHDB1+OrqqGvlmRk0vltiGDoWJvl6p/3g6Yv7lnATJKWg2Qe0/9pv8NKdqvVOQzkYQR89IDAAAWJBNrV2R36w6JWVfZgJoo+A35mQf0+RAJBshnlhAexDb8w98/npsW3rttEHZHOshITMKTJTS014eiW+3Dq4y02XL+vMAxDNzR9sEjY1QtCeML88lBftXJPffSgP3hrKZBi6LAzxVpfzxueuq/sax9uJktA+KarvPrOs4XPTc99O5zzydNzrARwWQE/eyd3xdsm8R9/KdNYBoi4Omn0+WD1VPuPInfO3OkJZypAg+idwBwxdESb5amf42fo/Dn4zeLaJaTwhW81CCH7ZfyEUN0Eeuegz5z++0nmiIkqWVkIJguwd1nrPybldrzp05S1EHpmGD0Cejfjdp8WO2nmS+cpghnWxpvu4pj0JZFyHHnkv/EOgxR0xGpaDT997ckldjXu5YMWGixs3MXQkLMXb3aFrfnRPT6v5awEXQeCjdnL/e1rMLcm4zP8UMDDChCWZ3pyFp1Y6lxCBU6mJCTwhHxEgAODG5WDmZv2z/4vNe6MzvKIiBEtp1kSQvUOsPjM5f9z9Z5dcRw3QLyzYYjOfUAfG5MklddXqmqhUrAwVrUiGwcxQox2GkYuFIZd32ksuuKvv7o1N+7MOSl8yoyo/fSjPeQLMWNcZuZ5BvjQEsarXbvvzG9v9LPDTA0C7+eTYZ3eflD9hMGPyBDAzF47FfHClH3tsjmUoEnLsl9ZGf3n+3b1PmRMniMQJ2fqygVInkzAzWyEffnddx21/n3z82Xuap2sj2ZK0IgPB1kDaVQfPoK+nTq14ff+Ffb9/NAFrThKqmBs9moCkJFTTqelL994mv+PAsFFCFAcqhsGltiTbYmvEXaYCx1rCau931EPvhC9lThMa1xOJ/xOvmbX/NkM/lZZBZYRCG3x2M9iV1Tae7Sj5/rXNrUO/r/XCjFwHPuOAbasP2LavqbKCJWeEJMHrx0GA0QKDOYMtJkgZpixEQlgQAAHMWP+ghHVDdvbp9vCvDvmf3p9yEwW5IRMyIR8dIABAQwraU/R1y3etip186A7mvpDIq7wh0oA0bl7N2YGu+sNJtX+fk+z4G8e91XhzN0kkIGYDJvGVSdscNL3vW3lXGwNIUSQYlDiC3uq2O3tzaIYxqpBEI4KOOSRf7Qw/edmD3W/+pNGzCprikAwAxuzZ1mf9+bV2NoJ4s7ckAgsCT4pavc932o+e8r/dd/j5Ejrh50187yhnWvcwPffU2/Jx1iQCxRcEMkYyQLvuOzU7y1VsUCQ3wkwmYlvirX75St8wL1caQhAbgFARoZ6ebOide94seeDyR9e86ScgTVgGE/KRyJhrJSdgURLqobMrLpqz/dBVw1mlDMEyBqYkDLEmHe69/a3aWd+5d9U/muKbN18D8qv5/NJFX5qaObN3WBfFHRhDpixE9M5A+I2z/lJ12DNtbas3v8iuZ9yb4pDxOhAVacGMQeIR0ZaRp0/+Z+TRg6ZmZw9keVzykgBoJl0ZJvliZ+j+WVcfeBzQrDbLwUy4CRPyz7QQRiZrEuqFBbD3X9h39dNfj+1x0Dbp83p9Mz+dhZ4ey1cePaPz3jt32+1zp9z25mChMhZKYLr/4ivlc+qqsmeks0YXk8DDAGzJPKxt0bwycuEzbW2r37oQoV2+CIXlowKZoaRnRjNAH0ZxOAEr1QoeYyWmDTI3Z4LRDgvfhHvP/NJz/mNarigwCKwfxwK1Ddj5W54tvYioWb12GZyZM6ELn3GZdxhKToDBhPyLLITCyU/Jerz0jRcf+cyk4S92D2stJSQbqMpSaT3bHnngoOuGjuME2J+wPIp1YFq+GX5mv9r8gb1Z1oK4GGXRlVGSz7WVpD577VBDYLEUocyCkjCLT6s8av9p+c8NZI0BGTGmxx0Y9UZwqQO8Oxjt/8ofu35LIC7GNGCAkACdv6wueskB77w5vSw/JZ1npiLcBWaoioi0Hny37OdH3ND7k2KfcUIm5J9uIQRzthEwzM38zS/uPO+i/dY8v31ZZvv+HBtLkNWX1u5nt8kc+cBZ0asoOXy+Z1HA3dhVuOes6Bl71eYO7M+ZolwFZnDEBq0ZsIYeX21/mxnU2Dg+iZbw1fukmZXb7b9NJrVLdT6CPIoLkBoGSiy0v5n/NUBsio3xN0FQA3Tz11f+ZKcqd9ve4eJCqYZhykIQb/daK3/7vPMrTkBgwgKYkH+xjDtxm5vBM1shv7O0Z6g8VNKyczXOqggbzmtBAKRyWe1cjc8euGP56jk3ZF/44wLYS1pgGKAUQMNyesUpew7dU2mraN4AxcTsGTCxkJQvrI0mT1vcf99swDqnCGVZ1gRBF8Bcday8+oCpuQP6Bzmb1YysYrO5I+OyCllkWtfYKz577R5x5namPcfnDjgBgfPBFc9X7fGlGblFAoqMQRFJSgQBYYRlyQfeLr3oike6Xpg9G3JG80TkYEL+tVIUCx5EHn72WN/jz7Q5p2ktpS1YgwGXSWpl9EGTs3+4OV5+8HkL4b51IUK4Gk5DCvrbB3b/YPdKt3YwR4YYYjw73DBMzBGytUu+99+P1P6WExBzigCDpjikOAn6qqPLDthnSv6M4ZzRLDhMBGu8QwrIjJF2a0fk20CLiwYIFJMO7CcpfX5H9Zsppa6dVygqSckwdFkE8qV1zlNnN/X8lZsg50xYBxPySQEEAJiT9GoeTr5t4C93rwhdFbWFBcAlEA0rUIXMiS9Nz6e+dVD5frv+Djm6CLmfHlGz7x7V6ptDGW2IWbABoAmG/TA7b0RjMEES2GWJVzoilyxdsSLnFxONq5zxOMCcEJ/fUf92UkTJnC7OU2ADXRYh2doZur/hL733BUlN437OT1L6U0P58XWTMl8ZzBhVDJHIABzJ6Ehb5tH3wt8iQs7POJyoR5iQjz2HsKGhm4T2iK+hS6acUbrTwTvkjuka1soSbA3kyEyJuFXfOJAfPHKX2EIDI3euHDy3wnZDwy5YCvZZOga01/GACSBmkJ8IbUC6MkKyZY3z0Km39t9ZbK7+CFcx/6p5e9eoLw5koSX8PIRxuIqQDXQO2dkn3w2NJDUV8yq8H3XO57Z755dh4fKgF6IshoVUJSFhvdRhX/fDJd3Pb0ly14RMyMfGQhiZzkloZuDE/609o2VNaHl1iCylSQuCGMgYnhbN1xwyI/PDw2fkvje1JF81nAdLIuKC4kJiwGuK5BMGBjAG7AhDawft/GMrSy9h9uoQilhxCcvBx+5WHdutMnuFoLwxhoqoZSQA0BFHyFfXOtddfH/PG8saIYPQ5TgAJCgFfcfZq769a6XeYyAHU2yYMeKQeKfH6bv15dJGTkAsS07wBhPyyQUEEMCpBog+erd/4bM48e0+p7vMEsJoGItAwy64L61V77BWwy5YkG8ZsA8ABdOf/L8RA6ShSxwh3umxrrjk3nXLkfLCh+MOyK9X+PaczLd2rdLTB3PMJMz4IT8DEw0J8VaX1fH/nqJfcAJidhF+fCIBgTjMqfvX7rjfNup7ea0NQKLIl20sIcXrneHEH55e17EMEElMAMKEfIIBAfBIxsu+BGvh60N/v/+d6Ik9eUdFJLHRYMlERGQRyCKAjClIyw+KJHm9deApJ5moTeKtTnvtja9N+2WxTT8C5fzZMZNn7Fqpv59xtSn2mUgwC1jixY6yH97198HuYvsKBNWOZ38m88vty9zyjAsjiumtYGBiYZKt65zlxy/a6Trm4sjSCZmQjz0gAECy2WurdvGD3cue7pTnQljSImgzsup77QoJBGbAMPnAELRM9HXIAwYGWeLVLuf7Nz715uCWKufh2w/+eptYLppVzKJIlr88RPLVDuv5U27pvLFYriLIulzYEDto1jbZeDqrNYjH5WEYgCXBQ65ES4d9EdDi+j0QJ4jECfl0AAIAnLcQLidgzb11cNGylfY1pY5tkfEIMmYGDIGMp6HEDGbCBhYDEwyTrghDvtFlPR6/deDmoolEn+W/6fiyw3avUvHBLIpLegLgCEJXzkHzu9FvE6jovgJe56W4PHAburIqrETeFBnJYOhYWMg3e52mc/7a/7dHE7AmSpcn5FMHCMD6yMNRf01f9Hy7dX9FWFhGQcF4azwzvI7qxivpJR8I2BAMg20BdGds3bqu5CKiopWTEAeAWfa+27tXlDoudLGeuCFdEhby5Q578SX3dT1uimxQGgDVX0554Jy62sxBvTloWSyRaIHWDdmDT7WHvsMMWjbBG0zIpxUQMBJ5YLrkmWknv9QZfrc8JCylYEYaKPsxRmLyrQZAMABNOuZI2doduuHU27teCroSFaGcghqgU6evuGDPGjVzIFN8MVHUAb3fb/Xf917Vpcygxi2IZMRn7Vg+a6r7U9aKyRTT8YAgQDrsCPFqh7jqW6neVcsaIZMTkYUJ+RQDwkjk4ak33xy85XU5d3U61FPqEGlNxrMOuAAYvF+1gYlaJFb1W513v1P6o6KJREBgOfiS+ik1+07O/DjvusYw1kcyNv+w2raEeKvXarzqwVXtxSrnMq+5izl/v3U/2rlKTUm7bEhwcZEMR8i3u0Pv/eClil8Vm3U5IRPyiQYEwIs8cBzyyuf6Xnnk/dDJg65NIQHWLBgswIbAI8AAEIOlkKK1K3LZFc3tXcuWQRRFJDZ5+yscsePAr3cq01VDeTAYAsZzQ5hHv0iwv8LrHc6Kry+ccl2xyskJiNmN0L84Ypu63Se53xzOGkNFvDcGIASzhqTn2qM/amlpH8bMCSJxQv5NAAEAKAX9wgLY8+/tefjx1aFvOZaUNhvNxncXWIANYLTQMUeIN7rtV45cvPf1HIec01w8y584pOqgPWvUOems0ZIhvXwG9gohDMDBUaB6lgBntU2vrCv51gqsyKWKTIkO6hWO3GXgvyaXuqG8YVNUgRZDl4VJvtYhnzh9cffiiQ7JE/JvBwgAsL8feTjxjr6rH2+P/DEWkZZhozhYullAEmMgb9NTbaHvAM0qtX5R3azEm8CMhJg9PfP7bSKKctrXzIJPCgOQ9gABPjBoDR2LCLm8077/jL903VfsTkdBJKPp9ElH7FadP9ZvfDJ+mJEJIQl0DFv62feci4iAiQ7JE/JvCQiAH3logjx08aHnv7DOaa6MSsswFBjQhlW5I+TrXfZt//lAz8NbpJwEc9PxV5964BS9X39WawGWI0URG3EIQRakMeCwBNYOWNmn3g8XnRKNIKJYV+fsOWnwSkcaGFPch4ihoiEpX1xn3Xzhkv4XiyVLJ2RCPpWAgJGW7imTeGpy/PXO8JrqsLSYkS+32Vo56GQeeidaNMsPv4X73nvvXXLglPwvLK1YG7FBfcRYwCAMdNSS8vWO0DUX39P9ZrH1Co8mvKrHO/Zb9d3da9TuQzlTVCRDMzjiQLzTY/fdvbzs+5yAaGyY4A0m5JMh1kd14aCl+9IVKzo/O6XmmJij75wSwfQeZbvNbeEf/eLptSv3aYBMbkGY8c74u4ndK9X0niw0CZaeF0Ign6UkFG4czTAMU+II+W6v8/7CV6xfFtuVKOETiYkHqqbtPzV9aU4pw4CgopALxpJCvtguf/aHp9d1XHcxZBIT1sGE/HtbCAC8yEMiAZF8vOvF/3yict9l7c5Rf3qnbM+zl3RdmUhAFGNGB/UKicMn77DvZH1BOu8VEwkjIFh4NcyMTSMMLCCYmCDpjR7xvVRLb/8yFBfJmA0IIvCX98v9YrsKtzzrwhSbEl0WJvF6l/Vqw62XXuVzEBM5BxPyiRH6Z9wkkYAojPcHjVCL8j18dv6xM0ru+MLU/Am9Ga2FoPW9DoSX/Who/QYuXv0E6YooyVe7nKf2vXb4Cxz3SpbHu19THPKkFPTlR1d+4ax9hx8PU14rZjnei2LP3NIsbHn3iuicM27tXzZee/oJmZB/Kwuh0H1ggJrikIktAIMmn+W/8Zjqg/es1if0Z7RmFpINMGIO+PkHZAjEAmQEYAgWGXQOW/zCmtjFBHCRJD8F9QqH7JC7vDqk4JriXhIzdGlEyNe7nNvOuLV/WbFk6YRMyL8FhzCKKcLYQgWJ+6C1f2328lKpMJAXXlJAkNzkxxy9v/nOABkwky6LSPni+9aic+9a91yxOQCPJiCpAequ05eeuUeNe1DfsLdTtEFwrzFdBQ7boNWDVvrJf9iXMqPYzktbVTgxOnaNBcCJBETjFpz/Yb7+eDy+ydjq6uo4mUxu1XvF4/FRid9UKqWLGdMY5064DP9qCXYpujde+p+HT3evHcgWbONOI74BgjohEh5CGAZHbeaOYWfg6idozyuOz7Q3+lbKOCY/IQH66sPVJT/67FDr1Ji77VDeQAiIkd5oYvSto5mhK6KWfOjd0E8Pvz6dmGiLNiETFsLW5BwAgTrwJbOm1OxaMfhzV7FhCEFgsM8VeMULXl8FAoGN8TGCjSNt+WpP6GdXvtK/+tjjYSWLUM5lCcg5SahHv5r//o7lalrvMCspYMFgg9YNFOQt+39jA1MSJvF2j/WP3zxX+t+cSP9L9ldgZrrn3G3qyjBo5/2/OQDe7i/BglTnaxgl0nHrWdW7b1+iwn15F7Z//gA75r6X+95Y2LJ+f40PueDwMcccM7m2tvZAYwyztzkl27ZNSqm2G2+88aXgvK3xHhoaGr5UUVFR7rousx+XJiLV3t7+yNKlS3PBvY444oiympqaesvyVICIWAhBruv233zzzY9NAMLHSBqbQNQAfe+89OW7xFRVd5Y0EQvmAAB89fRzkxkMkIDRMOVhFq91WW+e9+foHzjeL6nIegU0Qv/0yao9dq1IX5rJac3kpUQT+b0d4GVAkl/JHTSGJQIbluLvndZ3Hn51XRo/hqR/YnlzMMSzj/9M+WW7DT4xOZKrGPbhr8QBplfqNiAxA0iOKKjw6832qszctWtVfrf+HEMAcCygPU2405q6K7D67Y3J4C2V+vp62dzcrCKRyCG1tbW35HI5EBGMMYhGoxgYGLgdwImJREImk0n1YQGRiDgWiy2sqanZLZvNgoggpUQ2m0UsFttm6dKl64IxxWKxHSdNmnSPlBLMDGZGKBTC0NDQmwB235ogNQEIH0Ka4pBogLn6CzWz9q0ePnswp7XgICGICvKOyOMOyIw48pLAGWWJdwasC9rRPpzyNqIptl7BPPm13G+3LXGd7gy0FN42r54hwus5BPazIIm8LtFRyJfanWXHLkrf/q+oV2j0J+665V2lvIsJ2aTZITAR2AZEzEYOaOWNQAQAIURah0hxWMCAQQ6BbGhow1vVlRRCuK7raq21hvedKNd1LSJKb3UfmGjQv5cBQMYYEkIMSrlJE26tlNIBGAAwrusKIhr8d3YZxMdtQHGfgDxoev4324QZORUQhh5pKAx7vRQQkIsCxMLz40OQrb323Sc29f9fsV2JgnqFxfHKI/asVkf2ZVgLkNwARvyGLoV/YwaHCOhI2/qJtuglRPwvrVfIuMpSGlIzSDNIG5BhkMtEATu7CRkKgmaQMt5njAF9FKaNb7rL4GBmCUASkfiI5vTIPQp+3/DZjRl1TB9Hnfi3BYSASLzpKzWn1FXp2b15owWE9Kokhd9lyQMCYq8JgjAAG+KQIGpLO7lH28sv3YKuRCP7K+wzKXt5CSnWmoj91vDMXqFSITAEnaBg2JSEIN/qsa+76J7im7t8ZF8kEQOs2EDBqxtRbKAIUEiN7W8EVhAjeN5P/Jw2zEFp2wa/T8gnDBAITTDzd9st9pmq/K8taGazcbZwUEJNXjUje24eMetSW4pXupzf//ChthVIFef7BvUK95/6/vm7las9B3JGC0AIv7uTpyDs36twdSGOWCTe6bF6/vaqSHwc6hWUYeFYIhoNC6vcEXaZI5xwWFhay5qxLAT2szzJ+PtkBPtlfLIlatu2sDyRtm0LACWu69KEun+COISmOAQR9B3Hd+wzI6a2G8yDBRkxemSUAJZeCwQYU+4Y8Vaf3Xb9c/yzLem8NLsR+heP107eo3LgJ/m8MsxCCgS8gcdYeFmQ3t+CHd4F2FiWJV9bF25MPjPQ03jJ2PUKiTFyAxobPT9/SwAzkdj0ZTQCSCZB5ZPEuhfXhn/Q1itDWSUgCByWoB7X6kVdXbBnFhoTEI2NQGPjZUDPr9aTMryeRiuxQf64RSLh3yc5Ujq2VV2JeDwue3p6ZDweH/Xafq7CuP2wiLzwkxDiLKVUzHW9IIkfRdCVlZW9AFBbW7tVniEej8uOjo5RQaa2tpZTqZQpgr+iRCJBra2t44JVETkbI9caa1ybk9mzZ5tkMmk+NoCwvM57ea90hXr2qdaY5OQ4qwmbqyHwnUDWcOTyLvn9u1f296G1OJa/sckjEh88afjKHUpMZVdGaClG6ImR3g1MAZXpf7sMHQuTfL1DvnbCXw6/lhMpsbl6hbEslWRyfYSgWP1JJjc9N+n/XNLSPrykBb8aYxQjMIokOJn0/nbKRaFRQaw3rXN/SG64rU7yo/naXT8JaPyU8qYmGY/HTaD4Y8nChQtfGE+xtgaQEdEHdg8TiYSYOXMmNTQ0aB/sPjQ4pVKpD3Wt5ubmj5eFkEzCeLn/a1tnVlUljtteJ12jFW9mjIahK8JSvtRtPTXvnoHFAQdRhDUiRQP0dUdVHbjPpPQpA1nWAkJ6JKUZiSqsz4pcnwRlETCUs7G8p+QCQkqnWiHH8lHPqkd4OxHbflJF2Qib7ljE0hmm1b1S0f2da4vlOY7YuSp29N5OpZSWyiuP2HAs4urIMFxVOnza4lX9lx8zefuaKDgLIOwfHXlLXXTn6tUAOFFfXjF1WmmpI4nfbnedvOqNsab14Vv2mt/uUGHtcPUJU5XlMAkjjHSG6bm3geuf62nbWu6hz+5PbmhoOMC2bem67gbfmxCCpZRERL233HLLqoaGhnzh5N+MctRFo9EyrTUXEJq6pKTk5YULF37o3IpEIiGIyMybN+8wAKVe4MQTKSWUUqa8vNx0d3c/ft999/Vio/BlPB6XyWRSA8DRRx8dra6unm6MKXVdNyA6NxHbtuE/w2sbP0MikRD+9eT8+fP3UEptOzAwUFr0F0HEjuNQOp1+f8mSJc9/rMKOQV9GSvX89G8N5bvM3han9wwrRUTWaHyYIxhdOYuf6rAu2YJ6BcQBNAD4/JT8r6tDGn3ZoLbZT3ICef51gAN+abUxpMuiJJ9b6/z19Kaux8YKM3pZEeDhzmnR4+r7HpsR6yzLqpG9bWFL5sFJltvdX/Gl//dk3yubi/cHpd+XfM699sBp6fhQzuSJR96HDoWE/VwXTgOOuPfw7R9/YUo4H815lV4ckRDdSvzjxbO232/RopXZY/bSF+1a1v39gaxRc6oRKpHaTrsE4Q0XWhMqQ4ou3K/zIQI0KGgFB7ln1H7k+udw1NYIrRKRzOfzEEIcOWXKlCM3yxAaoy688ML3lFJLVq1a9ZtUKrV6NFAI8hDKysoWV1VV7RPkPAgh4LpuTgixPYB1y5YtEx+UZEwkElYymVRnn332BbW1tb9TSgXP430ZWiMajaKnp+eFTCZziK+svLHynnnmmXvHYrGLpJSHMvNUIYQY531BKeXm8/ntAbQHzxqAy/z5808rLS39ARHNlFKipqamyJ2HvTGXlJSgra3tQQBHfPxCLCkYZogvN1Wc+0S7fKkiIizNrDdWOQPWsZCQr3eKWy9+uOdZsyWdl1LQfzmh6sydY3r2QI60IJKeY8DeTPH7Pwb7SXh9ID2ffNWgM3z/6pLvb665CwFsErBSrW090FhSXaLCJVY+XObkw+WhfDgs3NBOFarsiBnuPJ8HEGMEAUg0QJ/6hfLKXapyR5aKvBOzVWlZKB8udfLhydF8yWDWpJ99u2fpETuvKCuROloRcsMxOx+J2floeSgfLpNuZAf/etWOFrFQPlxq5aPVobxtiSC5i0doBAGD8lDeLgt54y2189GYo8I1EcWjWVqJeliFR1N8/CYyo8c6Rj+klJbjODuXl5d/a+edd37xzDPPPDKVSumxahZ8U579nwYAW5aVs237Q5nmvvKps846a1ZFRcVvXddVWmultdZKKa2UykspeXBw8K2BgYHDUqlUf8Hzkf95s2DBgu9UVVU9X1paOt+yrO2k9GirzRzGfw85y7J4Yzfh3HPPvbimpuYWx3FmAoBSyvhjKkqYOaeUUkKI9MctyjCiTI2NgKCV2euWh498u99aWe6Q0GY9qhsWXCqZ3hmQ/betdL5bLMvPfueleN2k0s9U5f5LaMNGeztTezaA8JvBFsTiQJ6aMJmIlKJt0Plp8sF1740XyUi1+pzIGvv6riGLwcR5JTivBbtGsusyT4uaEwHYaITGKOzpsoS3pf3J092jp5SaqoEcKWWI81qw1sIlYWH1oP3nZDOGapxseVaRyGliVwujjNB5LVgZMQKSrpJGuzDKCJVVwmj2cjyCPA9vyz0gp4TJucLklDDKCKVdmKza1HdvSEEnm6EKjy0JvbInIyFCFIQJ/WQhYmZ2XdcMDw+7lmXVVlVVLTnzzDMPS6VSOpFIiM24JMF+gcHvH4ozqKur40MOOaS8tLT0r5ZlOUop4bvckplJCGFprQf6+/vnLl68uDcAAADU1NQkfOW9rqqq6r8B2JlMxtfHETHMrDc+ABT+HhCAMpVK6a997WszS0pKrnBdV+fzee0DYvBOZDFHQU4Ifaw4hNH5hI510yKVp5y7J56aGnXNkAu2CEQw2rIs67Ue++cLW7raTymFlUTx9QpL52V/skvM3bY3S0oIWJ7yk99siUayEr26CYYxZMocI1p7Qqt++GjF1ZzoF+M1PmlIQTODiHqf+ez08Mu7V4h9+3JshLcJtBzKgbcppT2uP7Z8T6L+l0brnTDbB5XpFeYUGxqaQQIeqyYIVvewUC+ti9wApKlfCS28ZAIaqfxkJmYQ3vNniNCWdCAclx1bADlFUOytClyASFHL33OCCNqwkA7gSGMXjq0esA4/ovKwGEyJ6wdhbKF12kh+sjP64JKW9uGhoaHNKqKUkizLkqOFQ7XWMMbogskqXNfVtm2L8vLyppNOOmmvxsbGNgBia1dMbhoRapTJZFItWLDg+tLS0p0ymYwSQgS6w0IIQ0TWwMDAGTfffPPywLXwV3LR0NCgzz333Mbq6uqvZzIZl5kt3w1mAMayLCmlHNPMJyLk8/lyITzHdrfddqPm5mZYlnVpKBRCJpPhQrfacRwZuDPjiTHGEkLAGO/7/VgCQqBQj9bDmtPc+/T2FTWnnLIz/zkqlclpzleFRej1HvnGvLunXMOJXrFF9QqPVe9WV5m7aCgHw2AJAwQeHI1sG0EjVBCTgCDFLltieXfo0uaVK7PYDJG4UUxQAlDtafvm3SvNvhLKABB+joOujRprn1oVB/BSvG5DC8HvG6F/dujkGdVO38HpPLEAhL9O6zKHxPIe+6kLl3S9SAB0Pm88E8jfFQvBhrtAT8Qzl98bDKdDhLWDWVaGyS4PqUkx2wgPFDxIcFlgZb/sBHvvlAm6LEvyvX5nAMiPjK99ypSKI2f03Tuz2hXDrgeitmB0DNto6za7AXhrxx0z1NIyumXgFxL1pNPplUREzCMpUSSlJCnlzpFIpCSXy3mJ4kQB96Ci0Wh5RUXFVUQ0b6wS5kJw4Q+RbRUo9znnnHN+RUXFiZlMRhGRVXBNHQqFrO7u7ktvuOGGexcsWGAnk0m30Kz/2te+dnBZWVkik8koHwyIvdWCHMeRmUymi5nfANDnX5c3IlhhjMkxc9aPpKhZs2bZUsrZfnhVBJ+zLIt6e3t/FQqFbjfGkG3bm52nruvCsiwYY/o+1oAAAHOaobxS4q6/VIerZhw2Db8sC+vQyrSTe3KddQGhNZ8qVjlbvTDj06flfz21RId6MkIFLdWNCcqaeST/IHAXGKzLo5Z8bl3osZPv7EltEanmA9Wdy63bd4q5/1UbQcjVFJCLQrmMcseciFkLEmhcqApje42ASALmwCnpk7eN6lB/BkoQLL8fFJSW9HZ/6AbAC2Bk/OF7KdbBBrsAGcLvlu6rgBX48g1TrgCs302Bze3IiFcXvNsyOWx2HcyzYSKyBVNnxuaL/q/20IfeLlsB5AQQ8t9tvwb6EeR4hGxbl1m6x2hVyX67KgZIGDKO3HASGmOgtUbAyDOztm3byufzSxYuXHjWaK/upJNO2q6iouIHkUjkP5VSQQ0EAFjpdFo7jnPCqaeeOmvx4sUtPp9gNr6XDyIwxiCfz49KqBWChtYahStrIW9QWlp6RTab1VprGazkxhgVjUat7u7uG2644Ybf+uARRAGorq6O4/G4Y1nW/zPGsFKKAvATQjAz6/7+/u93dHQsuuuuu7qLjXIkk0mz/fbbb8fM27quC2YmZtaO48h0Ov3I9ddf/4MPqnMfa0AAgDlJKM+c7vmv3325ctletbTLfSutZy9/qvtNBoi2gEi85cjYkbuXm+P6c0ZvELngwgwhjz/wvnSGIwlr05Z5fg19i7Bl+ysQwB6A9L5/9l6xpTvG3ON6XGh4QCSG8mQmRXmXxdNv/yIRHtnAbWiERjIhtg3/+jSjAcMkBPz9KW3IlQNy3Y1Plt7L3ENBghMHz8IYCSNuuDq25gHk1/rWjyPCrtd8ijZg93aYpIfw9qtporFTmcsBKENSayGVB3IQYFJqU7s3ULRA2ZgZSikYYwQz08KFC60FCxaojczk9wF8Y/78+YOxWOy7uVxuBBSYmSORCIXD4a8CaKmrqxu5Z3AfpdQIIIxmIeTzeSilRsCAmYOVOFA8am1txVFHHVXpOE4TACeXyxnyBMYYHQ6HrZ6ensdvvPHGrzc1NcmGhgZdoLgymUyq+fPnx0Oh0B7Dw8NaCCGDlZyIRG9v7/xbb711UaDo4yUopVIpHZwTCoVqmNlxXZcDrsVxHGitn1ywYIE9ZcoU2draOm6Yta6ujltbWylIfPrYA8KIP56AoGTv0wCeLjCpi6tXqAMDdc7uVe9fExEGA4po9BbKfhEVBWnLRpeGST62Ri666G/9L32gkJsPIG91yz/VVVvHE9T6dgoGpiKkxYzy/KkAHonHvfObvD0o9O0Nv993comZOZQ3LCCEl6YNHZGW9f6QTN23alVvqgEOAluePTdhlDSGDf7HmCAjakPlJb+SU+W1BYBOZIjUhtbXhpqloUixEhrs4yeBYaS7KcGrlNpgRS5Yxbm+vp7PO+883ngl9PmBH82fP/+IUCi0t+u6hogEM4tsNgtmPrS+vt5KJpOqsbGRAgshuFchIEgpx7UQCkGrvb1dplIp94wzzlgYDod3DFwF/x7GcRw5NDT0j/fff/9EZtb+/QufwfjXPkcpxcYYNsaAmY3jOGJwcPDZW2+9ddHFF18caWtr0wBMXV3d2PzXsmWjjp9Hckg4ALl9brrpJhcYv59FPB6Xra2tVBjC/UQAAuC19WqKQ07qAC2bDVNsnf6j9ZCUhLpz7roL965WO/flWIvx9lfwVlkTtQW90y+7/rKi5rucGPhA9QqUgiYCfvxK+UP7Tsq07VxB04ZcNoJYGIYcdg2qQu4x8R13LBcN7/YDoIBP2LZk+JwaR6M3A01kLMOATZBr0mRaVlv/AwDLOwqa17Ln/oz8Jeg9GV8PTB4JFsyo9dvfiWALLAOIvGcs1G2yy0WBghtDYGtSJGzgKJ+7EEBWSwyRbW08cQtdho0BYnRiOWl8UFDZbPY3tm3fbLzlWwAQvgswo7y8fCcAb6ZSKeHdSo/qMmQymU18540BocBCoIULF7qnnHLKN0pKSk4cGhoaAQNmZiklcrnc0ODg4HEPP/xwR0NDwwZ5EYFZf+yxx25rjPlcNpuloOLSjyYIrfViALjyyiszWzKfgkzLdDrdFgqFMlLKsM+/WJlMhqWUR5922mnfaGtruxmAWr169Qbfn+M4nM/nacWKFblgzMF4P1GAEFgKAIDmIgkhQMxeBv2NAydtU1eRuSyvjPFyhooLNllSype7ShpvefXdjv/d7YPvr2Aug0XJldm16dI/11Xzd5A3hr1xUNZlPbWUa0/cu+vw1Lto+uMCWCIJ99C9J5dUO/3zMi6B2RszM+nSMMu3BuRj332k71VOQDQWAKPPHKx3ARgYpfK3YLknMIuRHbmZvX1zx3GDPIXSOrtqSP7W1XY0p8ECgCRQT87WEcvtBIDKdyM8FiBs/P9jgQIA6uvre1hKmZZSlhhj2I86aCmljEaj0wG8uXz5cioEmo0BYayknMIVVggBpZQEwCeccMIBoVDo6mw2q40x0rc02E+dFv39/afecccdr9XX11upVEpttJoLAMa27T2klNHAsvHvI3K5HFzXPWbevHnTPM5QmM0uT0Tkum5+3bp1v04mk4M+WbnmtNNOW2bb9pG5XC4gOomIKBQK/X677bb7iTHGnTp1KkYD9YMOOqgLwMuu696UTCYf979a/kQBwhaHi+LefHj8FP3TnWO6rCdDPjE3HhRAl4UgWrutV+L3dP7B5yA+cGirwQ8fPtvh3LRbtb4kZhmpzUi7eI4I5l3K1UkAmhZMAZ0H4Pzd0odtW8JTci40+f0ZJBg5I7AmHf49MIxly7BB1h2x1316ZLMavyv15sqfiQkjGQZjbZ29aSIRWtrbhw+9FZdu7sQ3S0t5NA4hYM6DAqTNYSkAuv/++ztPPvnk94UQuyulAkAAEcF13cqNCczROITRQnoBIBRaCFrrXH19fWk4HF7MzJavzMH9jJRS9vX1/ejOO++8tzC8OEaEYwffPTIFOT9Ca41IJHKIEOKQYuaPECKwcK4FMBgUL6XT6Z8Q0eFEREqpEdBxXddYlrVN0A1qtDAmEU0XQuwnpZx/4okn3njbbbctSCQSn15AaIpDihT0lV+u/dwusexXB3MckHnjihSMQeXQY2us7wLQRXdeGpMMCjiQntav7FDavG2le3BPjrUASwZkOg8qC4sjvnHApG3Q2LkOSWDbGJ8RERoZw97uMswm4kCuGrTarli7172MZqJm6EQBSWCYvZzDEVbR/8+GLsMGyLdBEwTmLXrMRxOwZm/s63pEsC680Ae1EDbUXT1cuPL78X8MDg5W+z7/mBYCMwdVj5uQikHWcEGUIVNVVfVHx3F2zmazhWnz2rZtOTg4+Pidd975y3g87hREFMYadM1Yz6mUKrZPAwshSCmVdl3XAEBzc7P2rYSWY4455oKKiopr/Wuq4HmNMWoMkBIF4GSIiGKx2Py5c+emk8nkNz+13WHidV6tzv61+Wuqwq7IaxSV3W2YdVmI5Mtd4p6LHu15iLfWZiszPcVtz4gbc5CedeBNWMpr6GmlHD1ihjqOCPhV/dRpkxxz2JALgEh4bB+ZkCXRmZG3Njc3Z5EYDaQosDELjs3aop7bUHg+gNwWRIBoo8PvNs0br8TGmE2OLcgPkMwc2eg6pLVGaWlpGwBMmTIlKGYa9V7pdHrUHIXCc/zrEzP/zQ/nFf67zOfzOhQK7X/UUUedlkql8vX19ZvloowxarSxFD5/sYfWmjaOOMTjcXnvvfde19PTc7bWutO2bcuyLMv/6Yx2CCEs/96CmS1jjEin08pxnAuPPfbYL30qAeHReliUhLn9xJqGWdX5/QdyRgsxfpo2MzhkEa0asjJLVzuXMIMa67ZSD4AGGAJw11tySVu/7A5LIdkIJhYAC1hgTIuq0wHwZ6elT5hWwiWuIk0QxEbCJiHXDlrq0faSRX6ewiarC/mNXchvK+cdYyNCcA4KfxpC6OPzVQoAfPDBB9cQ0XbGGNB621/4Sty9NW9IRGV33XXXjcPDw78LhUIWM6sCBRfMHCktLb3xyCOP/Hxzc7Maq6YCAKSUa4IU7E3i/ZYlHMexbNu2HMfZ3GHbtm0JIcr8Zi8bgEIikRD33Xffop6enj0zmczZxphLcrnct13X/bbrut/O5/OX5vP5S4eHh38wNDS00HXd1/3rcMEqQkIItizrkk+dy8AAYRn06ftMLtmjdPg3DONzLcWZplFbWE+00+W/earznctTkMmt1FK9ICeh/6w9YrftVGbOy7isAbbAJNI55pqwOejkfau3nRzKHU/GeAlGnluvSi2SKwathy/7v7VvcByjdpMeqUsoiDKwxmY4BOF5CUGreT/SYPjjsV9HfX29aG5uNuXl5V9yHKfUL5GWBURbJpvN/qMwzPeh5w8z+6z7t+bNm7dnJBKZ49cJSCIirbWxLMuJxWJ3fvnLXz4olUq9u3H1ZdCExRjztlKKsWHNkLYsS+ZyuZuEEA/7/7bZOeZzAdq27Z6Nw7/JZNL49+8AsKgYa2vevHnXhkKhBQUJX0JrTUT0hU8fh+B3Xrp3rtu4S4Wa2juM8cOM8KJvpQ7kG71y5WXP7PprTrSIrb1Ra5DU9GZfyQ27lQ2dZyMrjBEggJSGqXZc6+QdnGvLbDUrm2cE3aYFmHLaor/3hP4EgJZ1jKGw7DWgFUHbeL9OYUwOwRgI5pHzhd9DsixkuQxQYxGW2OzZ43MI42GlX/OwUep2goLYuxDiOxu5F0ZKKZRSbzz44INrAVBjYyMnk1uljQsnk0nDzDR79uxTa2pqXnAcZ2pA2hGR0Fpr27YnVVVV3VVfX/8fTU1NaQoy2byVO8iabNVar7Usa4rWOiD9WEoJY8yrt99+++KtM69SGgCN58LU1taKVCqVHxgY+ElFRcXpQoiIH7Ikn1St/lQBQpD/n/jCNnV7VA5dnMkaU2xnX0FgDSle7ra+39LeMlx0vcKWeA0jBU+7vfTyWS2v7lEh9h7IGSO8MYqca/D5ydnjBBnkzIiOmxIb8u1+ueaK5637iMBzmkdfUUzgF/sByKBx6mihQwYhzxYxj2QRkathJoW02KViYDsC3n3rQjizX/XuNVrux5xmqGJDwJuJWPDRRx+tW1paeKOQIwMwxx9/fCIcDh9QYB2MEG1a63sA8KxZs2xg6+6UNXv2bNnc3Lz2iCOOONG27WYppTTGBDVgMp/Pq1AotFd1dXWKiL4Sj8dFQds09lft4blz5y61LOucIIfCz0GAEGIegCvPOuus8HvvvYfa2lpThOK7GwHtBiDa3Nw8njVr6uvrrZ6enqGysrIhKWXUD+Oud2U+TYDQ6Of/z54yPG9GqabuLIwErPGWKmbWFWGSLZ1i2Zn39f6l2M5LH3CQEmhWa4bLb6qrsK4gVkFOQtCPwDD7u1R5CQLGklJ0ZK0bW9rbhzkBi8bYicojoPzcgoIgwsbWgTYgIuaMa7IEwDD5dqvgMsvwrFp9eWXljofu+rt3+9fPtg2vccTOO4e+ukf3j6vDbmlOgwFB5ZbO9mlH/emV0DWpFWs7x6t2ZGZZV1fnLFmyxKqrqxt5prKyMlleXj69tLT0AsdxLtioloGJSOTz+Uwmk1kEAEcfffRW/66am5t1fX29tXTp0meOPvro88vLy//HGOMCsH2uwcrlcqqkpOSIuXPn/r9UKnV+fX291dzcvMF3k8lkrrVt+5yCgibhuq4JhUKfP/bYY3+0aNGiX3xIQN2i85ubm82xxx67l2VZVcaYIKTKvjvU8+lyGfx4f9ewXGtYC0Faj1cKzwBsSVibsUzzutC3CYP4KLdXCBKJXlxr/2X3MvWzaodK8pqYaGSnSrE+C5hgCSPXDFn5x9c6Y5KJBe6h55IW5iGANnUZ/CpMS3KrIPoMgQy86KbszxHvXaUPeOKY7he73apFXWnRJmwh3xqwnv/uw2teDuot+rLZkr1q9I93q9RwFUCkYQlGx7CLeyrELQA6d8xkqGX0gVp+DsJxdXV1bwUdgAqIPWLmbUOhkOXn6ssCEFGhUMgeGhpa+OCDD74XdA0KUpe3MiioWbNm2UuWLLn++OOP3zcWi32jMBQZgEI0Gv3GMcccs+ree+/99axZs+yWlhY3iAKkUqkXjj/++P+NxWJnBJ8lIqGUMiUlJT+fO3fu3kqp24jo7eHh4U2AXgjBfkTFaK3fKgScQw45pHzSpEn24OD4e8sopchxHNsYc6DjOFcKISzfDQqSvIRS6plPFSBQCoYTENvdUHLLpBif/aXJ5j86M9CSxk7XM4AudUg+uda68XuPdL34Ue++lASMd4+u9sO2q3hgeqk5MZ8xGvAn2YZgpWO2lK398pFkc+eKscjELZVl/s/3eq2n96nk08DuSAKnIFA6b8yMsvyOu0hKZhUhFhV4cm3kxwBe3rHSMyYsIRiGO4cyXJnxaxlsYhrMGWOzGNd8933WEiFEyajfizHYyE0AMyvbtu1sNvuPnp6exsKU249KWlpalK/Y35w7d25dJBKZvdG4pOu6KhaL/eorX/nKP+6///6mwFJIpVImkUiIJ5544mLLsr7oOM4OrusGgCK01iYSiTQwc4NSKuidOFrkA1rrjJRyRwBrAxIzGo3+GcDnI5GI5s2kpBYkZ0nLskp8gChspsLMTLlc7g+ftrAjNyaB1avbMle9HD329V5rVWWIpdmkBduI6WxitsGKftl7x8vOD/9Z+yss+73H6bf243/TiiDGaCUswRjWhPcGrGuxmWDBlsqcpMdl3PRq2eK3B8R7FWFh6YJiGCKIdJ5Nf9YopXRW510VotzwpjONLb+E3AJgEcFiwNJm9E2yNz6YmZVSZrTDJ7uEf55hZte2bcsY05PP5+c2Nzf3bcZsDlKMCw9sbkwF529yjl8/YAYHB0/K5XJrpFcpFcwpMsYIY4yOxWI3HX744Z8rCEdya2sr/e1vf+seGBg40XXdQdu2LWZ2/c5Q5Lqu9l0iFkJglIOFEJBSjgZ8NVLKMiKqlFKWjXUIIYKfJcH7DVKxAeTD4bCVyWTuWrJkyb2fujyEJGD+eiLkXX9f0337ivBxbRlnqDIEaRjKcBBlIzYGJiwNhAzJF3vCl97wj451aAUl/wm7/MxphiYC//zNmgffH6KVUZtJAC4BmgBNBE2AW2KB3k/Ld65YssNSZtDmEqSkIJZgRQQtvOsYArQY/Xk41QBx36pVvUvejc5fOWTna8NsS2+3FkMM4+9yTcwQfrfSTZTc2zLHu5cIxj7K/YIc+yB0VyhiDCk8x7ZtEQ6HbaXUu9ls9rC777775YIWZZvyw+vvNfL7GCvniBSMbROd8EN74uGHH+5Ip9MNWmsjhJDB6iuEEMYYKaWMlJWV3X344YfvEOQIBK7DQw891DIwMDBbKfX3SCRiW5YlEPTnWx+WHLO34hhrhjbeltquKVIKnhdSSgqHw87Q0FDL2rVrv5pIJMSnMjGpIQXdFIdMPtX58pKV9nFrMs7qirCwIhbIEoyINFQWJjHMDh54z/npqfd03dj0URKJoyikuQzWihUrcqsG6LaQbQkQ2ZYkaUmSliBJRLZjW2J12v5TC1pc3+8fmz1wbFeziEiSUkqyhCTLkiSzRpaOZlo0pKATCYjvPbbu0UVvhf7jtb7I/6WN41pCCmkJYUkhLCkkBDmShGzvp8mFn+8HkDVWqSW9BkdCCEtKIaUQlrUpcaOMMVlmHjbGZIs9mDlrjBlwXfeV4eHhH61Zs2b/u+66q2WcVuzBZ4eZOWOMyQLIFDYoDXxzZs4X3GvY/5kbK7RXX19vPfDAA08ODw+fT0TDAEaeB0DOdd20ZVmVJSUlqcMOO6yqsbGRAVAACg8++OCLbW1tB6bT6aRSagUzmwD7hBBjHUIIQczsjLoOeBewRZFSCAjGmLaBgYHfrFixov6ZZ57pSSaTn95ahgAUGlLdj7w+a8p/nLmL+71JkexheU07OpLX9eXFy8+0yWsuau5eyn648p9symgAeGJV+Ld92m0VxnBhQpAgsGFBb3ZH7wJ6MNb4kr6Z2z9k+p5bbZ21ImTsPHn5SI4ADenwINBkRrKONlj5PM6Fkl0tP3sCh1531NR9plp9M4e1CAGAYRAxTMQR4qXu0MsAcO8UbxxVM2YMPtex/Ow3+0w0b8ASXrf6tJa6x8g1AJDyG3Rks9kHAewNgDdOwR0T4KRkx3HQ09Pj3n///auCsRfsQ7Dxah8kA53EzCEArJSiUCgEfxXtKQzNua77diaT2cdxnPW9ACwL2WxWYYyt4Jubm5V//z/MnTv3oVAoJHO59fjh9zc04XA4bIzR/pgoABT/s4MAGmfNmvXfU6dOrQuHw7GAU9ksP0akg2cI8hyIaIExplJrzVLKLSJVM5lMfmBgYHmB60UA+P8DLVWJAvl5vmIAAAAASUVORK5CYII=" width="260" height="70" alt="vit:bikes" style="display:block;">
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Partner Portal</h1>
                <p class="text-sm text-gray-500 mt-1">Melden Sie sich mit Ihren Zugangsdaten an</p>
            </div>
            <div class="vit-card p-8">
                <form onsubmit="handleLogin(event); return false;" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">E-Mail</label>
                        <input type="email" id="loginEmail" value="max@vitbikes-grafrath.de" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@standort.de" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Passwort</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div id="loginError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-2"></div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center text-sm text-gray-600"><input type="checkbox" checked class="mr-2 rounded"> Angemeldet bleiben</label>
                        <a href="#" onclick="showPasswordReset()" class="text-sm text-vit-orange hover:underline">Passwort vergessen?</a>
                    </div>
                    <button type="submit" class="w-full py-3 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">Anmelden</button>
                </form>
                <!-- Registration Link -->
                <div class="mt-5 pt-4 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-500 mb-3">Noch kein Konto?</p>
                    <button onclick="showRegistration()" class="w-full py-2.5 bg-gray-100 text-gray-700 rounded-lg font-semibold text-sm hover:bg-gray-200 transition">Registrieren</button>
                </div>
                
            </div>
        </div>
        <p class="text-center text-xs text-gray-400 absolute bottom-4 left-0 right-0">&copy; 2026 vit:bikes GmbH &middot; Partner Portal v6.0</p>
    </div>

    <!-- Pending-Screen: Warteseite nach Selbstregistrierung -->
    <div id="pendingScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang wird gepr&uuml;ft</h2>
        <p class="text-gray-500 mb-6">
          Danke f&uuml;r deine Registrierung! Dein Zugang wird vom HQ-Team gepr&uuml;ft und freigeschaltet.
          Du wirst benachrichtigt, sobald es soweit ist.
        </p>
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-400">Eingeloggt als</p>
          <p class="text-sm font-medium text-gray-700" id="pendingEmail"></p>
        </div>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Gesperrt-Screen -->
    <div id="blockedScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang gesperrt</h2>
        <p class="text-gray-500 mb-6">
          Dein Zugang wurde deaktiviert. Bitte wende dich an das HQ-Team.
        </p>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Top Navigation -->
        <nav class="bg-white shadow-md">
            <div class="flex justify-between items-center px-4 md:px-6 py-3 md:py-4">
                <!-- Left: Hamburger (mobile) + Logo + Location -->
                <div class="flex items-center space-x-3">
                    <!-- Hamburger Menu Button (mobile only) -->
                    <button onclick="toggleMobileSidebar()" class="topnav-mobile p-2 rounded-lg hover:bg-gray-100" style="display:none;">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-2">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAAAmCAYAAAAWR3O2AAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAAdSElEQVR42u1ceZhUxbX/naq79TI9MwzbAIILagLuxF2DGmNQMSLQE+OKG+AWd1/2njZ5Ji9uMfiMGcFIcMu0srjEGGNg9BkxChIDgyAKAwgywMz03n3vrTrvj+6GHkDUPDV530d9X33dc/tW3Zp7fnXO7yz30sob7cf3q3fPLSjSm7Lma2Of2++UZc3tCk3QBDB20zgGgWZw4sLavY8dkp9ZY6rjAC0Apl2drxk6bIE+zBqrnn6//oirWzdnbzkpOODao/zX+oe8YXmfIQgEAMxQEQdyfcp8/aFn9/9q87J2L3FR/V4nDsksjNjeQNcHqHzuJ2maoeqDQi7ZaP3q8GmF67gVkpqgsKd9qiYeXBWe3JE033QMLYbVesc/OWb1A9QEhRjkx4wltIOIouIrA/NPDKn1TmRW9FFgAQBBYJCkjVnzB9ckNmeIwBccor87tI+/d8FnJaoAIAjI+wJrUtb34+3tLhH40H7Znw6MeI1FH/rTgIUZOmiCOtOic/GHdT9lBiEKvUf8/wRg7nh6a/rljvC4LVmz01Naf6nBveS1q4I/ojh8jsH4qIHzY5CUgFpy9bNX7NPHO6onyx4RxO52eMSBXJcULx19Xz7BAP3psvCXh9V5V2ULWgHbAaoZfiQAuS5ltI5+IPsXAPjLlPDxgyPqwlQOiuhjwbxjU7YhxAcZ6weXJT7cvKAZkmj32nNP+wjAzI/BmJTo+uC1DuvcbNHgfFH5h/Rzb3v5yvA4isOfvwvQxGIQJwF62rhBDY0RL17wWFcLvLKrwdAAdElg4FTBUCs2mbcQAAJ4eH3xjjpHGZ6GFiUBagAqYEJ0Z2XuvZ7grcwlTbJvpHhXwFCaAS12o1vKKFDluTQDqi5M5upuY/ER0255iKOQJ8fh7xH9PwmYk8uaZNxj2fkrupypBqQB7ftfri889tQFdYeeHIffGu0NhuaRIIpDn7DXltv616j+BQ+6WrtoBgctEpYhhCGEIJAM2sJYnzZazpiVe0vHIF6eEvr23vV8Zs4V5EhhWlIIWwphCiENKcX6tP2TsQ/1dBCB/3pV6Jph9froTJGEKYSptPhIsAiAwxZJQ5SuLYWUG3usxcs3Rb7NHGeM2KNZ/i+NqgisQXH47dcG7vxSn8JNRcXc7ZnvP/f+gKOmPLm+60c/hojHoStE949X1I84tjG1WJIyfAZReS6toSMOiTU95vw1PebPwL4vmDQJpmfX1r1x53Gb8hSHnj6+bthhjW7Dhh4PwiiNlT7YNAHHMPUJ03NLYrHSNZ+eVHvE4GAxnC6wzHnkDa7FD0YOLIxJF3qbJwK0EFK8lzRv6UziDctkEbRlz1HTznwbSCgG6OOI/J72SQEDEGKQFCf//eut5/aqcc8AMdZlrL/se/ex3+DWNkYTNFohqAnqnRutFw9s8E7tzrMSZaExgy0DXPCM3Jz3ag+8/ImtG3Z10ecvrTnw0MEq3JH0vLA0yav84AEFw5TH/TK5mLBryT57Vb+BJzR0LTeEqvXUdk+p5AWRfHezNfuAe4oTdvwnf1wG3x6Rf0aAqXCTZgC/XDIsMnHfDW/2Dfj72gbRsi6j5eD73Clrb0Bg2D3Iv3xl4KyjBhWfzrs7kVVVHyT5j0329w+5t/CzldfCXvJhiS/sWw8xqhFqxlsNA08fkVo+IKQirip5QwDgayAUAFZtNt96em2/428csb5IZQGX12VQHO67N5nPDW/wzujOYTtQATYJXFCGu2B1aOSEccmORX+GeL8bOjoCTHEw9miWzx4wANAahWxKQLVGQwePHuouDJu+ZZnSWLrZvuHwB7K/BGJi7c23Lx8Q8vfPeMxSlrgLM3TIAm3KGu9PXzj4oOaTOlzEwRUTUIl7LL3BmjGyv3tpTxbeNnPCgBTQDIG/rXWOPvXh3OLKOqrHvnxVZMxRA7PPFz2luAqozPDrgsJY9IH986/8d/57e2IsnyPp3fFAUwJqfgxGUyL7jzc22pMUG0bRU97QiHvP368K3PXud34+d4DjH5DNMwuG0ApgXfJ6QJI+SJs3xds6Chi5nS+0RiFFE1Tb5NojhoT1pEweCgSjfH2hAR12yFifMmae+nBuMbduBwsAwjLw5FGjzGHh3F2SFOsdvLGACbkhJdY90xn+T45BoGmP6fnCAAMAFc9p7GOZxNIPzVhASFNq3zu4oXjj3hHvrEwRTCABDZAGtA8VsSDX9YgXjrk/P2/HHR6NlpAzLJK7O2L7wisBrMI92DEhNmVkclGH8SOOQTQv224+uBWC4tCXHPPOtUNr9Yh0EZp6u/BsSkkdKft78cTmTDVQ97QvCDAAUAncHTczd9vKreasWkuY3RkUUnkoAMRMAAuwJrYE0JMzvPZN1s0EIJGokmYZPG9eE4gOqVOjk4Xt3KNCfQImifVJ66cXzsltxEhQvIq7YBm4NTqw396R4o8KvtbVa9YMVetAdiTFq8fdn3mMo3tM0b8MMACAOBS3Qt7w0uArVvcYb9RZ5LAikCawLpkirUmHLSE3puV9Zz2SXfqXGIxt3KNsTm76+oDQwJB/h9Kaq3mTZugaC6Kj21j5wxcGTeMYBFWZk0q8Z+Sgnp8OrFF1eQ+8LdcEwBBAxpX6g4x5HYE4sUee/1rAEMBYBn5h1arii2uDEz/MGJ1BCak90qQJrKBDArQxJT/823rnNo5BnNRctcPL5uS8A3tuHRzxh+VcqOoAnyCwhqD1WfOGP65aVcRIbPOmK7znhcuDhw2u9S5L57lXcBAMv8YRckNGzjzx17lFujfv2dP+JRqmZJq0jkJOebZ77dJuc3zeM3yLiLUPhiY2hRAbk+YPLpmX7FkAiEqOhmMQiELPGF+7715BdXMmx5oVSeZqc0JyTY/xxxPuz/3ho3jP8Drv7oitpM/gat5jGxCbsyL5PxtqfsgMquY9e9q/EDAAQAkojsH4xmOZV9u7zKm2ISQxFWsk0fvdxuJRD93y8E45mpEgIvCoAYU7+wV00PXAxEzwAe2DDYC689J9Nxm+kRm0S95zdficobXq5NQOvIcAFbCEWJcyfnb5E1s3ILEnKPdvBZgKCX5zMswTH8nMeHuLdW+fsHBcLUVHKnAdIa4TO8RyqAnqTxfWjd43os7pybMikNxWYaOgakwSH/TI+8bO6Fq+oLkq5lLhPYcMCA0IF+5i1qy5N+8JWZBru+Wqn7/R91c78p497fNtxqc5+Sst8DkGQfHM9UsvDa3tceWmrz/e/T/MIKIqc1KKG4t9wz+/O0AaSZ8gqGRTmEmHTIhNablx+abgbRwrCsS3j10QK2mqxd9J3jikVu3Tk4MvaPs6BYEZQqxLGzclFq7P40ZIYA9g/mWR3k86iLcHzqi6tmR+DMbJcfgLLw5eNmqANz1V1IoEJIjLLBqqNiDkok7niqNbMtOruUssBtHcDJ57bv2Q4/fLLA9ZXsD1Qb3yRQHI97qtF4bf6Y75v0R0q2t9qATY7dyrrHkT7eBPQaQpFottM5vxePwTl1DEYjGjalxlLf/0fP92gNl2w9vBVHVDywlMammvrxnbN9teZ+vGvAITQZBgMKAiDsu1GWPxfvedfRRHE6AENHZIH6y4zp51QF/3gq48Kymr8kUC2tNSL+oMHPa1BzLL0Vxyu/fs+39Tk7Qjp9npYDmT/ebFxVhjiAZtzZMvBAxoBjNBCEbelXgvad0IJCqJS67mPQsurTm2MZg7P5VjJRiSt/n3UKEAGcs6jf8+9TeZdv4aJMU/tXYhADz30oaakX2yV9jCN3K+wJqkM33MjFQXALxxdeikvft4R2kAq7daK465PzNvRy26g3YQ8XhcX3TRRftFIpErtNZg5nT//v3viMfj7g4Keae1jBkzxh46dOitlmWFtNZQSk37zW9+80H1fACyUspfTJs2rbib+f69AbMLjSOoCerpsQ1fGhrIXpPKaV0iumW3hqHqTZIreownTpuVadvJjS7NQoND9r1BQ1OqSCBiQJfzRRaJD5Ny82sf2HGOFcU/U5Mbi4HicXA2TwP7Bf27ah0feU9ASZ4DoAsAIpY3sW+ddzUAbMnIPwGYhwQEsGtwtre3l2p5pDwgEon8BzMjl8sVN2/efC8A9+PW5Pu+Y1nW98PhsKO1Ri6Xmw3gA8uyhlfmy2azfqFQ+BWA4v9bDfNRO/iAhuIv6i0yuwtCSQGBEtllRxB15im3rMv+LnOe0NwrXySpCeqNy0MX7VOjj0zmK4VR23LdbEuSH6asH16RSHUNj8E4meAzQM2x7Wb1o1zrqvMEM/j+c7RBlYJQ3QtQQvdQVmXZ1wxozalYDALdEIzdP0VBRG4+n/e5FGjaHAqFKBaLifb2dhoxYgSXecguyyyYWRARiLYzBCFEr/ls295pXDQa7VUJmUgk9I7zMzM1NzfvRD12sRaKxWJU2QC7aolEQn8mgGmNlszDC9HawxpD3lk9BdaCykG6kpLQYRvy3c3GnRNn93RwYrs5qbjR947pExkUSN/ueZqhBEFoaAIAUhGHZEe38ffDf33mDI4lRMUcEsCIf7x6rjpPx+PAtHFO5+qu3H1hk4SrpepIh3qANOJx6HOv0xoahtCAUCUQxj+BF8bMRERG+bv8xS9+kSUivSshJxKJbSS7vr4+D+DaYrEY0FpDa722rHlQmY+IDGbelQDV7tbT3NxM5TXwx5BuEY/HdRlEn7+GiSagmUGzTnM2bKnx1wwOYu9kEVoKiJIbTaIjJTqe7on8F8eyvcoPKm70okn5Hw5yMHhrQfhCsgEtSnWfxCh6Ah1p8wYgodC+PYA36/xg435hRxQVqCsPTHi0a8MOLjYB4PvPrK0/Yl8ZyiTBfojFCiPYOXXO0FsPGeBRzvPokbffzr5yZW29b8iQ9jJ9WFUUG4X/fFGfwQPrWLZv9PJNiczmbSAvt6ZdC8ucMmXKYRdeeGEeAAKBACul/CVLlnQkEgmvIqCy0L2xY8fONk1TAEA+n0+WQcK78cYoHo/r888//0giEsVikcPhsCWEaJ8xY0ZXNBqVRKQA8NSpU/trrfsUi0VorUkIwcFgkFzX7ZoxY8amylpGjx7tDB8+/IBsNhvYJVAMA93d3Ss/E8AQwNwMcdGLmzqfGls7ITiYXw2b2sz7YCKwFCTWpY3vxp/dmGsOQFJZqOX6YDWvvd/wYTWpq1OF0tMHrEt+tAarPiGSK7vlkyc9lJ1fMV2V+uMDw3zlIX1Tt6QKXAz0E9ZLkwIXnPJwfg6iEJSA4lIRL52yT+H5wSF1qA6Cky6tXrXWako0rV0YlsopaOLLTq7tP0QWL2kM+vFUno2sWzI+/QPu1xscb1mdDWkNkH8A8K2dXPnWVo2yKSEi+L6viaivbduv27ZdbWL4xBNPXHPkkUf+PB6PPzR69Gijra3NHzNmTM3QoUNXOo5Tr7WG53lHAniTiHYZVJ08ebKMx+Pe1KlTf1RTU3NboVCA4zjI5XLvJZPJ4yoa7Pzzzx/S0NBwpxDiNK112LbtCsh927YNKeWvANwUj8f11KlTT3Qc5yFm3i8UClG1aaw0KSWEEFHxmZGXODRHISc8m1y8ZKt5EUhIg9iNWBBrUvTKV1tTT3C09CzTdsZY8j4OCGfv7GMg6GrBxIKgAa3BJhFtzcrcB6nAzcwl01UJ+AJAOmM8mnVhmkJHwqYKDA765xHAiJbNJIFfvDR42MCQf7SvlBVxdMBXYl7iH7WbLOKwLZVhCzb9DYIdUhE7rMMBgx1fEZQmhAwt+wdUrR3WYcfQDQCAZaBrTxjY7ztH9x/wnaP7D4geu5ezCz6DYDBoVHogEDCIyBRC7F9XVzdjypQp17S1tflVYPIrHEZKuVuz0NLS4l166aVfC4VCt/m+75mmqTzP6yoUCmMeeeSRzhEjRvCUKVP27tev36vBYPBbRFTvOI4ZCoWMUChkOI7jhMNhQwhRUwZgrWmaj9u2PZyIyLIsGIaxyw5AfKakt5Jzongy8cq3Ij8+YRBu25onrE4Z1xOA6vRBBTzzm2pPHRIsnr2tmJwAkACDVY1FxpLN5j1fe6yng8dt5z1UfnqB4ukV717jLBhWw6ckc6xrLT6lNTqkDzWt7+LJMAGowY46L2IAPQWorozkTUmn5fTGrON6YF8QfB/cr8G112fst5jVE0XXP6RfUI1gBjoz5vqcopf7ZIRcn6bFgIe7XxsSueqwzkU1pq6XgvitTufcxEL8Qei8UXaBSSmVS6VSj2mt/TII+kspz2FmXSgU2HGcuydNmvTCww8//K5t26LMXVAeX23atnXf9yUAuuSSS/qGQqFZutRYCCFzudy3Z8yYsWry5MnmggUL+KCDDnrcNM2huVzOBSBd150DYBURMTMrrbVQSr1eBvfxlmUNLhQKipm7s9nsNVLKzRXzVV6HNgwDUspln7WXVCm8EhRP/eTN8yLvdXvoOn1OcjEDRNVllwBGjRplDg0vv9skoMACxACIwWAdMiE7kmLDiyudnXgPACwABAP8t4yYtXeYvqYVu/0cqj+grutMALPQCHXtmOF2SHQ05YrgGkOYa1LilWNnJtf8drzxJWgwaRLQpAwhI4fdn5oHYN7SK+yf7BXWIxhAd8F49fDpufOrr+vm0lxn6Ei97YcNkgiBTQDwiwqu61YA0/PAAw9cUT3u8ssvb7Jt+wmllOc4jmUYxhQAN+fzeeF5HoioF2AKhQJs2wYzQ2tNZS+JDcOYJYRozOfzBcdxnO7u7usffvjhP1188cVOS0tL4bLLLvuWaZrHpNNpT0opi8VidPr06XM+Sl5a6709z9MAZD6fX/Dggw/+/ot0q7ebJwYRpR6rkMRql3R+DJLi8Bd++90rh4b54O7qbDQTwMSSINYlze/+x1+3pm8dvJ33VNpJcSgC+J7V5rxBQa+r1qI61hpBQ58PYBbFoV+ftOGkfg4PzXvsWSTNLQWjhVGkh3wW4PKMDLAP5hgERoJW/BmOLh83CRa3QgKQSECVAF+LQqFARQCeEMiVt0BR+bBctyJgMXny5NrGxsbsxo0bqWxKWi+++OILHccZm81mWSl1cllgynVdqmiSCn/wfR/FYrGiYeQDDzzQc8EFF9xsmuY3UqlUMRgMOt3d3b+eOXPmvbFYzGhvb/cAQCl1Xj6fZ621mc/n/z5z5sw5Y8aMsXeUUT6fp7a2tkKhUOiRUgrP8xQzn3DBBRec4nne+oqGKfdNjz76aCoWi4nPBTAlVQeePxrG5v690wcxlB6znTluUMOQUE+s4HOvsktmqFobcnVS/vWrv0/P2on3VBPtVkhqSvactn9g9qCQf3mywKpG6NHzorX7nJ1Irq631CQLBA/C2JShDbNXOPOORZbvL5JiTaj0CsgBoP0KwVACDIZmMDVBcWvJ3ALA4sa1qSN7QidulNKwTBOrk7WrgQyKBV9ZxVJcTSkF13X9cv6HRo8eLWOxmFi5cuUfpJRjPc8jpVTj5MmTzYULF/p9+/bdZnqEKN2KYrEIy7JKWV2lUk1NTROI6PZ0Ou0JIayenp5n169f/51oNCrLHpcum58vMzMppbTWevi55567suxxVTassm1bZrPZ3wG4PZ1Ov6CU2mjbdqPv+wOJ6CXDMNxymEADYCnllqampvvj8fjPPjfAAMDJbTunD5pbQdQEtfiC9E8Hhbjvlnwp6rKNjQsg7RG/l7JvImSxu7LLSg3N5qzx0OCQulyz1v0D7OwbccdMHjVqesj4x5npotYRW4h1WfnYHX/dmgYAJYjB2PawUrG3jq76vstrqgSyb28/kiqZKq3Z87xtgjdNc6dA2cSJE7NSSvi+D9/3xYoVKyQAVEwSM0MptU3DeJ5XAaCntb4agFksFouWZVE6nX66ra3Nnzx5sgmU7vMxxxxjua4bqsxpGEbItu39d+RFpmlCKbUPAMydO3frWWedFdVa/15KObgMWqtMxqGUgud5QxzHuX38+PHFzxUwH5U+eKGp/qC9QsXLk0XuVbLJDL/WIWNpl/jdGXO6Fn5cNrqp5DoTUfr11ZOdt/sHcIjWQFDizPMPfLdrYIBqegpSdeeFvzYZ+C2Qr1qMAOlS723UDUD7AEr5Ly4VovfyM5dGYVkDS8fuLB6hW1oWeTuSVGaWlUhsOp2WZaGOqATgiGhrW1tb4aijjopUj91RuOXPoO/7UwuFwp8Nwxjiuq4fDAannX322e+0tLS8UnHRFy5cWJg4cWI3Mw8qu/hdvu//A+j1IJ9SSklmXlL2ksyWlpZXTzvttEP69OkzipnJ930qa6mBUsobpJQjXdeFEOLWLxQwADB69GhjaHDRPXW2NsrcpfICIbYlxIc5Si1LOt9jzlJz8ydIsjVDAvCTBXPW0JB7R6qgdIAwekgAB+eLWkUMyNUZmn9Goqu9Er9BuVaCyr23giEqHWNILmXDJfXWNQclqnNEi3e5Nx599NFU1d/q7LPPrhNCXKiUUmXOsKS8i43dRWLLoAnMnTt35bhx475lGMYr5fNtx3GePOuss4555plnVkejUSuRSLjMvEgIMYKZhe/7HU8++eRJH+eml0HTBeDFHX8fN27cCtM0/+r7vhJCDDC+UO0Sh5434e8HDQ6pUyvpg+qbGrTIWNYjfnbe01s3NDbDiH+C13I0lw3H8qTx+wGOd5sjhWMThUO2Duc9UoYgbM6ZLUAey9rL2swFmAm63FGo8oIUFwmkMy64r6W++vyEuhOnvln7RigU0u3t7e4NxwwJNO2b/GGNUEHLEGrx5tDD5z63aSkpVa2qrGg0eorWuiCEEFrrOiL6gWEYg3zfLwohbAAPlSOoH5/aIPLHjRvXMHfu3NfGjRt3fTgcnlYsFoumafYPBALzvvnNbx7f2dmZB0DMPIOZL9Jau4ZhHDphwoSrt2zZ8pvquM+uQPNRv0kpD6rElrTW+S9Ow8RLnsivXhdrNmblW/tF+PCtBfiSYCiGilgs16Tk6gc2NPySY5leVXi7nbYcMKRE97oVk0Iv9q3B2J4iXFeDHEnGxozcOHtL4BlCCu1VGWdm0syCwaLXdXK++BtBCKXZtQUaDq13X1pyxtYNa3PJBw9tx3/uX+PVNAbUd4fVsABpvJ8rvAZgqZRMRKSUUhpAvRDipQqBNQwDzAzP87xgMGhns9nZTz311EsA4LquKmfCVXVKoPxZWZsKhUKVlMJ948ePPzwUCl1aKBRylmUdrJR6tK2t7Ztlovry+PHjf1tTU3NJoVBQhmHc169fv6snTJjQVZnLNE3pum5i9uzZ944dO/ZLwWDwTi6psh1DvAEiOsH3fc+2bTOfzz8vvii8EMDNAK77Y1fqlU7jnM68XN/gwADAIQPSY0mrM9a1M9s6Cmj/dE8vLugs1fNtKtJvDUkibMEOGLDCQRIZJX5314ubsjoGY1n53TDSYAqZZNSYJAMGbCFYVIKJv3v3gOeXd8tn+gTIsiRQa2uzrlYNC1veUAAIl1y6gqsYvmJQ6aVJ0JpN0zSlaZqmZVlCSolKJyIIIWCappnL5Z4lootjsZgoEwoCUFceK5nZKLvbZtWxOtd1KR6P62g0Kt95550r8/n8wkAgEFRKIRKJnDVhwoRHTj/9dCsajcpcLndlNpt9XJYaAoHAl8Ph8PHhcPj4UCj01ZqamuMNwzisfJ3GYDB4ZjAYHFv+rO6nlP4dyywUCss8z7v+C+Uw8Th06SH7no6nzqkbe2QD3S+FPqLgo/O9HuP2rye6nyubrk9VGHVyW6nE8qq/B/4cOiL7eFhSWDG0zBGtSdszgDQ1A7q5GRyPA1qK5LqMmNMl2SgwqWTeSQNpYAT4wcQir2XRiIlLLv7g2oj0jst5oFqXREdSLgaA96RXGFmQc/M+aoQgZPK8HgBYYpXneXcppZh5+3v+KhpDCKFc131j9uzZT1UyAgAQDoeLAP7Ldd1w2TvaUOYuq4vF4t3l8dlgMFisqsFx999//297nne11pozmQybphk0TXNQIpFYU67DOW/ChAlPSim/7vu+WUW2tVJKMPNLZcCszefz03eMMlelLYTWek1nZ+ev29ratvwv6K+zJV8FcMkAAAAASUVORK5CYII=" width="140" height="38" alt="vit:bikes" class="hidden md:block">
                        <div class="w-8 h-8 bg-vit-orange rounded flex items-center justify-center md:hidden">
                            <span class="text-white font-bold text-lg">V</span>
                        </div>
                    </div>
                    <span class="text-gray-400 topnav-desktop">|</span>
                    <div class="topnav-desktop">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-semibold text-gray-700" id="locationDisplay">Standort</span>
                            <span id="premiumBadge" class="hidden"></span>
                        </div>
                        <span class="text-xs text-gray-500" id="userRoleDisplay">Partnerportal</span>
                    </div>
                    <!-- Mobile: compact location -->
                    <div class="topnav-mobile" style="display:none;">
                        <div>
                            <span class="text-xs font-semibold text-gray-700" id="locationDisplayMobile">Standort</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 md:space-x-6">
                    <!-- Language Switcher -->
                    <div class="flex items-center space-x-1">
                        <button onclick="switchLang('de')" class="lang-flag text-lg hover:scale-125 transition-transform" title="Deutsch" data-lang="de">ðŸ‡©ðŸ‡ª</button>
                        <button onclick="switchLang('en')" class="lang-flag text-lg hover:scale-125 transition-transform opacity-40" title="English" data-lang="en">ðŸ‡¬ðŸ‡§</button>
                        <button onclick="switchLang('nl')" class="lang-flag text-lg hover:scale-125 transition-transform opacity-40" title="Nederlands" data-lang="nl">ðŸ‡³ðŸ‡±</button>
                    </div>

                    <button onclick="showView('notifications'); return false;" class="relative">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <span class="absolute -top-1 -right-1 bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </button>
                    
                    <div class="flex items-center space-x-3 topnav-desktop cursor-pointer hover:opacity-80 transition-opacity" onclick="openProfilePanel()">
                        <img id="userAvatarImg" src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" class="w-10 h-10 rounded-full ring-2 ring-transparent hover:ring-orange-300 transition-all">
                        <div>
                            <div class="text-sm font-semibold text-gray-800" data-user-name>Demo User</div>
                            <div class="text-xs text-gray-500" id="userRoleText">Rolle</div>
                        </div>
                    </div>
                    
                    <button onclick="handleLogout()" class="text-gray-600 hover:text-vit-orange topnav-desktop">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex" style="height: calc(100vh - 3.5rem); overflow: hidden;">
            <!-- Sidebar Overlay (mobile) -->
            <div id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
            <!-- Sidebar -->
            <aside id="sidebarNav" class="sidebar w-64 text-white overflow-y-auto flex-shrink-0">
                <div class="p-4 pt-5">
                        <!-- HQ/Standort Toggle entfernt - Umschaltung erfolgt automatisch per Rolle -->
                        <div id="hqToggleSection" class="hidden"></div>

                        <!-- Partner-level quick access (hidden in HQ mode) -->
                        <div id="partnerQuickNav">
                        <!-- Startseite -->
                        <button onclick="showView('home')" data-module="startseite" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            <span data-i18n="nav_home">Startseite</span>
                        </button>

                        <!-- Kalender -->
                        <button onclick="showView('kalender')" data-module="kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span data-i18n="nav_calendar">Kalender</span>
                        </button>

                        <!-- Aufgaben -->
                        <button onclick="showView('todo')" data-module="aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            <span data-i18n="nav_todo">Aufgaben</span>
                            <span class="ml-auto bg-red-500 text-white text-[10px] rounded-full px-1.5 py-0.5 font-bold" id="todoSidebarBadge">5</span>
                        </button>

                        <!-- Kommunikation -->
                        <button onclick="showView('kommunikation')" data-module="kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            <span data-i18n="nav_communication">Kommunikation</span>
                        </button>

                        <hr class="border-gray-600 my-3">
                        </div>

                        <!-- Dashboards - nur fÃ¼r INHABER (jetzt in Allgemein integriert) -->
                        <div id="ownerDashboards" class="hidden">
                            <button onclick="showView('dashboards')" data-module="dashboards" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span data-i18n="nav_dashboards">Dashboards</span>
                            </button>
                        </div>

                        <!-- Fachbereiche - nur Partner-Modus -->
                        <div id="commonTools">
                            <!-- Allgemein -->
                            <button onclick="showView('allgemein')" data-module="allgemein" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                <span data-i18n="nav_general">Allgemein</span>
                            </button>

                            <!-- Verkauf -->
                            <button onclick="showView('verkauf')" data-module="verkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                <span data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <!-- Einkauf -->
                            <button onclick="showView('einkauf')" data-module="einkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                <span data-i18n="nav_purchasing">Einkauf</span>
                            </button>

                            <!-- Marketing -->
                            <button onclick="showView('marketing')" data-module="marketing" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                                <span data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <!-- Controlling -->
                            <button onclick="showView('controlling')" data-module="controlling" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span data-i18n="nav_controlling">Controlling</span>
                            </button>
                        </div>

                        <!-- Tools - alle Standort-Rollen -->
                        <div id="partnerToolsNav">
                        <hr class="border-gray-600 my-3">

                        <button onclick="showView('wissen')" data-module="wissen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            <span>Wissen</span>
                        </button>
                        <button onclick="showView('support')" data-module="support" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span>Support</span>
                        </button>
                        <button onclick="showView('ideenboard')" data-module="ideenboard" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                            <span>Ideenboard</span>
                        </button>
                        <button onclick="showView('shop')" data-module="shop" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                            <span>Werbemittel-Shop</span>
                        </button>
                        <button onclick="showView('aktenschrank')" data-module="aktenschrank" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                            <span>Aktenschrank</span>
                        </button>
                        </div>

                        <div id="onboardingNavSection">
                        <hr class="border-gray-600 my-3">
                        <button onclick="showView('onboarding')" data-module="onboarding" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                            <span data-i18n="nav_onboarding">Onboarding</span>
                        </button>
                        </div>

                        <!-- Mitarbeiter - nur GeschÃ¤ftsleitung -->
                        <div id="mitarbeiterNavSection">
                        <button onclick="showView('mitarbeiter')" data-module="mitarbeiter" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span>Mitarbeiter</span>
                        </button>
                        </div>


                        <!-- Dev-Status (nur HQ/Admin) -->
                        <div id="devStatusNavSection">
                        <hr class="border-gray-600 my-3">
                        <button onclick="showView('devStatus')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            <span>Dev-Status</span>
                        </button>
                        </div>
                        <!-- HQ-specific items (hidden by default) -->
                        <div id="hqMenu" class="space-y-2 hidden">
                            <!-- HQ Top-Level -->
                            <button onclick="showView('hqCockpit')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_cockpit">Netzwerk-Cockpit</span>
                            </button>

                            <button onclick="showView('hqKommando')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_command">Kommandozentrale</span>
                            </button>

                            <button onclick="showView('hqAktionen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <span data-i18n="nav_hq_actions">Handlungsbedarf</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('kalender')" data-module="kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <span data-i18n="nav_calendar">Kalender</span>
                            </button>
                            <button onclick="showView('todo')" data-module="aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                <span data-i18n="nav_todo">Aufgaben</span>
                            </button>
                            <button onclick="showView('kommunikation')" data-module="kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                <span data-i18n="nav_communication">Kommunikation</span>
                            </button>

                            <hr class="border-gray-600 my-4">
                            <div class="mb-2">
                                <span class="text-xs text-gray-400 uppercase font-semibold px-3" data-i18n="nav_hq_control">HQ Steuerung</span>
                            </div>

                            <button onclick="showView('hqStandorte')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span data-i18n="nav_hq_locations">Standorte</span>
                            </button>

                            <button onclick="showView('hqFinanzen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span data-i18n="nav_hq_finance">Finanzen</span>
                            </button>

                            <button onclick="showView('hqMarketing')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                                </svg>
                                <span data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <button onclick="showView('hqEinkauf')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/>
                                </svg>
                                <span data-i18n="nav_purchasing">Einkauf</span>
                            </button>
                            <button onclick="showView('hqAllgemein')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <span>ðŸ¢</span><span>HQ Allgemein</span>
                            </button>

                            <button onclick="showView('hqVerkauf')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                <span data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <button onclick="showView('hqAuswertung')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span data-i18n="nav_hq_analytics">Nutzung Portal</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqWissen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                <span data-i18n="nav_knowledge">Wissen</span>
                            </button>

                            <button onclick="showView('hqSupport')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                <span data-i18n="nav_support">Support</span>
                            </button>

                            <button onclick="showView('hqIdeen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                <span data-i18n="nav_ideaboard">Ideenboard</span>
                            </button>

                            <button onclick="showView('hqShop')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                                <span data-i18n="nav_shop">Werbemittel-Shop</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqEinstellungen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span>Einstellungen</span>
                            </button>
                        </div>
                    </nav>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content-area flex-1 overflow-y-auto p-4 md:p-8 vit-background" style="min-height: 0;">
                <!-- Startseite View (fÃ¼r ALLE) -->
                <div id="homeView" class="view" style="display: block;">
                    <div id="trainerAreaHome" class="mb-4"></div>
<!-- ðŸŽ¯ TAGES-COCKPIT â€“ Heute steuern -->
                        <div id="dailyFocusBlock" class="mb-6">
                            <div class="vit-card p-5" style="border-left:4px solid #EF7D00;">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-bold text-gray-800">ðŸŽ¯ Heute steuern</h3>
                                    <span class="text-xs text-gray-400" id="dailyFocusDate"></span>
                                </div>
                                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                                    <div class="p-3 bg-green-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('verkauf')">
                                        <p class="text-xs text-gray-500">Umsatz heute</p>
                                        <p id="dfUmsatz" class="text-xl font-bold text-green-600">4.250 â‚¬</p>
                                        <p class="text-[10px] text-green-500">85% vom Tagesziel</p>
                                    </div>
                                    <div class="p-3 bg-orange-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('verkauf')">
                                        <p class="text-xs text-gray-500">Offene Leads</p>
                                        <p id="dfLeads" class="text-xl font-bold text-vit-orange">7</p>
                                        <p class="text-[10px] text-orange-500">2 heute neu</p>
                                    </div>
                                    <div class="p-3 bg-blue-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('todo')">
                                        <p class="text-xs text-gray-500">Aufgaben heute</p>
                                        <p id="dfTasks" class="text-xl font-bold text-blue-600">4</p>
                                        <p class="text-[10px] text-blue-500">1 Ã¼berfÃ¤llig</p>
                                    </div>
                                    <div class="p-3 bg-purple-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('controlling')">
                                        <p class="text-xs text-gray-500">BWA-Status</p>
                                        <p id="dfBwa" class="text-lg font-bold text-gray-800">â³</p>
                                        <p id="dfBwaSub" class="text-[10px] text-gray-500">â€” Tage</p>
                                    </div>
                                    <div class="p-3 bg-yellow-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('kalender')">
                                        <p class="text-xs text-gray-500">Termine heute</p>
                                        <p id="dfTermine" class="text-xl font-bold text-yellow-600">3</p>
                                        <p class="text-[10px] text-yellow-500">nÃ¤chster: 10:30</p>
                                    </div>
                                </div>
                                <!-- Tagesimpuls -->
                                <div id="dailyImpulse" class="p-3 rounded-lg" style="background:linear-gradient(135deg,rgba(239,125,0,0.06),rgba(245,158,11,0.06))">
                                    <div class="flex items-center gap-2">
                                        <span style="font-size:16px">ðŸ’¡</span>
                                        <p class="text-xs text-gray-700"><strong>Tagesimpuls:</strong> <span id="dfImpulseText">Du hast 2 Angebote, die seit 5+ Tagen offen sind. Ein kurzer Follow-Up-Anruf kÃ¶nnte den Unterschied machen!</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                    <!-- Header mit Willkommen + Dashboard anpassen -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800"><span id="welcomeText" data-i18n="welcome">Willkommen zurÃ¼ck!</span> ðŸ‘‹</h1>
                            <p class="text-gray-600" id="welcomeDate"></p>
                        </div>
                        <button onclick="toggleDashboardEdit()" class="flex items-center space-x-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-vit-orange hover:text-vit-orange transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="font-semibold" id="dashboardEditButton">Dashboard anpassen</span>
                        </button>
                    </div>

                    <!-- FESTER BEREICH (immer sichtbar) -->
                    <div class="mb-8">
                        <!-- Schnellzugriff Aktionen -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <button onclick="showView('verkauf')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-vit-orange p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Neuer Lead</p>
                            </button>
                            
                            <button onclick="showView('verkauf'); showVerkaufTab('pipeline')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-blue-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Angebot erstellen</p>
                            </button>
                            
                            <button onclick="showView('support')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-green-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Support anfragen</p>
                            </button>
                            
                            <button onclick="showView('wissen')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-purple-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Wissen</p>
                            </button>
                        </div>

                        <!-- Kern-Metrik: Umsatz -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ VS. PLAN</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Heute</p>
                                    <p class="text-3xl font-bold text-gray-800">4.250â‚¬</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                        </div>
                                        <span class="text-xs text-green-600 font-semibold">85%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Plan: 5.000â‚¬</p>
                                </div>

                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Diese Woche</p>
                                    <p class="text-3xl font-bold text-gray-800">28.400â‚¬</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-vit-orange h-2 rounded-full" style="width: 94%"></div>
                                        </div>
                                        <span class="text-xs text-vit-orange font-semibold">94%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Plan: 30.000â‚¬</p>
                                </div>

                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Dieser Monat</p>
                                    <p class="text-3xl font-bold text-gray-800">127.500â‚¬</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: 106%"></div>
                                        </div>
                                        <span class="text-xs text-green-600 font-semibold">106%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Plan: 120.000â‚¬ âœ“</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WIDGET-BEREICH (anpassbar) -->
                    <div class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Meine Widgets</h2>
                    </div>

                    <div id="widgetContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Widget 1: Verkaufs-Pipeline -->
                        <div class="dashboard-widget vit-card p-6" data-widget="pipeline">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“ˆ Meine Pipeline</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-400" id="wPipelineBadge"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wPipelineContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('verkauf')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zur Pipeline
                            </button>
                        </div>

                        <!-- Widget 2: Verkaufserfolg KW -->
                        <div class="dashboard-widget vit-card p-6" data-widget="success">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ’° Verkaufserfolg</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700" id="wSuccessKW"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wSuccessContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('verkauf')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zum Verkauf
                            </button>
                        </div>

                        <!-- Widget 3: Termine Heute -->
                        <div class="dashboard-widget vit-card p-6" data-widget="termine">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“… Termine Heute</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700" id="wTermineCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wTermineContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('kalender')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zum Kalender
                            </button>
                        </div>

                        <!-- Widget 4: Offene Aufgaben -->
                        <div class="dashboard-widget vit-card p-6" data-widget="aufgaben">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">âœ… Offene Aufgaben</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-orange-700" id="wAufgabenCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wAufgabenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('onboarding')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Alle Aufgaben
                            </button>
                        </div>

                        <!-- Widget 5: Marketing Kampagnen -->
                        <div class="dashboard-widget vit-card p-6" data-widget="marketing">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“Š Marketing Performance</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wMarketingContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('marketing')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Marketing Ã¶ffnen
                            </button>
                        </div>

                        <!-- Widget 6: Team Performance -->
                        <div class="dashboard-widget vit-card p-6" data-widget="team">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ‘¥ Team-Ãœbersicht</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wTeamContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('mitarbeiter')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Mitarbeiter
                            </button>
                        </div>

                        <!-- Widget 7: Controlling -->
                        <div class="dashboard-widget vit-card p-6" data-widget="controlling">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“Š Controlling</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wControllingContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('controlling')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Controlling Ã¶ffnen
                            </button>
                        </div>

                        <!-- Widget 8: Support Tickets -->
                        <div class="dashboard-widget vit-card p-6" data-widget="support">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸŽ¯ Support Tickets</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700" id="wSupportCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wSupportContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('support')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Support
                            </button>
                        </div>

                        <!-- Widget 9: Wissens-Updates -->
                        <div class="dashboard-widget vit-card p-6" data-widget="wissen">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“š Neue Inhalte</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wWissenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('allgemein');showAllgemeinTab('wissen')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Wissen
                            </button>
                        </div>

                        <!-- Widget 10: Nachrichten HQ -->
                        <div class="dashboard-widget vit-card p-6" data-widget="nachrichten">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“¬ Nachrichten HQ</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wNachrichtenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('kommunikation')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zur Kommunikation
                            </button>
                        </div>
                    </div>

                    <!-- Widget hinzufÃ¼gen Panel (versteckt bis Edit-Modus) -->
                    

                        <!-- Widget: Monatsfokus -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸ“… Monatsfokus</h3>
                                <span class="text-xs text-gray-400" id="homeMonatsfokusMonat"></span>
                            </div>
                            <div id="homeMonatsfokusContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('monatsplan')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Monatsplan Ã¶ffnen â†’</button>
                        </div>
                        
                        <!-- Widget: Jahresziele -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸŽ¯ Jahresziele</h3>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-vit-orange" id="homeJahreszieleCount">0 Ziele</span>
                            </div>
                            <div id="homeJahreszieleContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('jahresziele')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Alle Ziele â†’</button>
                        </div>
                        
                        <!-- Widget: Letztes Journal -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸ“ Partner-Journal</h3>
                                <span class="text-xs text-gray-400" id="homeJournalDatum"></span>
                            </div>
                            <div id="homeJournalContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('journal')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Journal Ã¶ffnen â†’</button>
                        </div>
                        
                        <!-- Widget: Offene MaÃŸnahmen -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">âš¡ Offene MaÃŸnahmen</h3>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="homeMassnahmenCount">0</span>
                            </div>
                            <div id="homeMassnahmenContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('journal')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Alle MaÃŸnahmen â†’</button>
                        </div>

<div id="widgetAddPanel" class="hidden mt-6 vit-card p-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Widget hinzufÃ¼gen</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="addWidget('pipeline')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Pipeline
                            </button>
                            <button onclick="addWidget('success')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Verkaufserfolg
                            </button>
                            <button onclick="addWidget('termine')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Termine
                            </button>
                            <button onclick="addWidget('aufgaben')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Aufgaben
                            </button>
                            <button onclick="addWidget('marketing')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Marketing
                            </button>
                            <button onclick="addWidget('team')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Team
                            </button>
                            <button onclick="addWidget('controlling')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Controlling
                            </button>
                            <button onclick="addWidget('support')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Support
                            </button>
                            <button onclick="addWidget('wissen')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Wissen
                            </button>
                            <button onclick="addWidget('nachrichten')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Nachrichten
                            </button>
                        </div>
                    </div>
                </div> <!-- END homeView -->

                <!-- CRM View -->
                <div id="verkaufView" class="view" style="display: none;">
                    <div id="trainerAreaVerkauf" class="mb-4"></div>
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_sales">VERKAUF</h1>
                    
                    <div id="salesMomentumBar" class="mb-6">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
                            <!-- Streak -->
                            <div class="vit-card p-4 flex items-center gap-3" style="border-left:3px solid #EF7D00;">
                                <div style="font-size:28px" id="streakEmoji">ðŸ”¥</div>
                                <div>
                                    <p class="text-xs text-gray-400">Lead-Streak</p>
                                    <p class="text-xl font-bold text-gray-800"><span id="streakDays">12</span> Tage</p>
                                    <p class="text-[10px] text-vit-orange font-semibold">LÃ¤ngster: 18 Tage</p>
                                </div>
                            </div>
                            <!-- Monatsziel -->
                            <div class="vit-card p-4">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-xs text-gray-400">Monatsziel</p>
                                    <span id="goalPct" class="text-xs font-bold text-green-600">72%</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2.5 mb-2"><div id="goalBar" class="h-2.5 rounded-full bg-green-500 transition-all" style="width:72%"></div></div>
                                <div class="flex justify-between text-[10px] text-gray-500">
                                    <span><span id="goalIst" class="font-bold text-gray-800">86.400 â‚¬</span> erreicht</span>
                                    <span>Ziel: <span id="goalSoll">120.000 â‚¬</span></span>
                                </div>
                            </div>
                            <!-- Abschlussquote -->
                            <div class="vit-card p-4 text-center">
                                <p class="text-xs text-gray-400">Abschlussquote</p>
                                <p class="text-2xl font-bold text-gray-800" id="closeRate">34%</p>
                                <p class="text-[10px] text-green-500 font-semibold">â†‘ +4% ggÃ¼. Vormonat</p>
                            </div>
                            <!-- Durchschn. Dealwert -->
                            <div class="vit-card p-4 text-center">
                                <p class="text-xs text-gray-400">Ã˜ Deal-Wert</p>
                                <p class="text-2xl font-bold text-gray-800" id="avgDeal">4.320 â‚¬</p>
                                <p class="text-[10px] text-gray-500">Netzwerk Ã˜: 3.890 â‚¬</p>
                            </div>
                        </div>
                    </div>

                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showVerkaufTab('pipeline')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="pipeline">ðŸŽ¯ Pipeline</button>
                            <button onclick="showVerkaufTab('woche')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="woche">Wochenansicht</button>
                            <button onclick="showVerkaufTab('auswertung')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="auswertung">Auswertung</button>
                            <button onclick="showVerkaufTab('training')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="training">ðŸŽ™ï¸ Training KI</button>
                            <button onclick="showVerkaufTab('vkWissen')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="vkWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Pipeline (React CRM) ===== -->
                    <div id="vkTabPipeline" class="vk-tab-content">
                        <div id="react-pipeline-root"></div>
                    </div>

                    <!-- ===== TAB 2: Wochenansicht ===== -->
                    <div id="vkTabWoche" class="vk-tab-content" style="display:none;">
                        <!-- Week Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <button onclick="changeWeek(-1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â—€</button>
                                <h2 class="text-lg font-semibold text-gray-800" id="weekTitle">KW 7 Â· 10.02. - 15.02.2026</h2>
                                <button onclick="changeWeek(1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â–¶</button>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="openVerkaufEntryModal()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Eintragen</button>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">Monatsziel</p>
                                    <p class="font-bold text-gray-800">77.734 â‚¬</p>
                                </div>
                                <select id="weekSellerFilter" onchange="renderWeekViewFromDb()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="all">Alle Verkaeufer</option>
                                    <option value="Sandra">Sandra</option>
                                    <option value="Thomas">Thomas</option>
                                    <option value="Dirk">Dirk</option>
                                    <option value="Max">Max</option>
                                </select>
                            </div>
                        </div>

                        <!-- Week Summary KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Plan Termine</p><p class="text-2xl font-bold text-gray-800" id="wkPlan">25</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Beratungen IST</p><p class="text-2xl font-bold text-blue-600" id="wkGesamt">4</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Verkauft</p><p class="text-2xl font-bold text-green-600" id="wkVerkauft">1</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Umsatz KW</p><p class="text-2xl font-bold text-vit-orange" id="wkUmsatz">17.056 â‚¬</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">VK-Quote</p><p class="text-2xl font-bold" id="wkQuote">25%</p></div>
                        </div>

                        <!-- Seller Tables -->
                        <div id="weekSellerTables" class="space-y-6"></div>
                    </div>

                    <!-- ===== TAB 3: Auswertung ===== -->
                    <div id="vkTabAuswertung" class="vk-tab-content" style="display:none;">
                        <!-- Year KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Jahresumsatz Plan</p><p class="text-2xl font-bold text-gray-800" id="ausJahresPlan">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz IST (YTD)</p><p class="text-2xl font-bold text-vit-orange" id="ausUmsatzYTD">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Verkaeufe gesamt</p><p class="text-2xl font-bold text-green-600" id="ausVerkauft">0</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">VK-Quote YTD</p><p class="text-2xl font-bold text-blue-600" id="ausQuote">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Ã˜ Verkaufspreis</p><p class="text-2xl font-bold text-purple-600" id="ausAvgPreis">â€”</p></div>
                        </div>

                        <!-- Umsatz-Verlauf Chart -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz-Verlauf 2026</h2>
                            <div id="ausChartContainer" class="w-full" style="height:200px;position:relative;"></div>
                        </div>

                        <!-- Monthly Overview Table -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Monatsuebersicht 2026</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50">
                                        <th class="text-left py-2.5 px-3 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Beratungen</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Verkauft</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">VK-Quote</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Umsatz</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Ã˜ Preis</th>
                                    </tr></thead>
                                    <tbody id="jahresTabelle"><tr><td colspan="6" class="text-center py-6 text-gray-400">Lade Daten...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Top Sellers -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Verkaeufer-Ranking 2026</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="ausRanking">
                                <p class="text-sm text-gray-400 col-span-4 text-center py-4">Noch keine Daten erfasst.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="vkTabVkWissen" class="vk-tab-content" style="display:none;"></div>
                    <!-- Training KI Tab -->
                    <div id="vkTabTraining" class="vk-tab-content" style="display:none;">
                        <div id="trainingMenu">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800">ðŸŽ™ï¸ Verkaufstraining KI</h2>
                                    <p class="text-xs text-gray-500">Ãœbe realistische VerkaufsgesprÃ¤che und erhalte Feedback</p>
                                </div>
                            </div>
                            <div id="trainingSpeechWarn" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-700">âš ï¸ Spracherkennung nicht verfÃ¼gbar. Du kannst alternativ Text eingeben.</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6" id="trainingScenarios"></div>
                            <div class="vit-card p-4">
                                <p class="text-xs font-bold text-gray-800 mb-2">ðŸ’¡ So funktioniert's</p>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div><span class="text-2xl block mb-1">ðŸŽ¤</span><p class="font-bold text-gray-800 text-xs">Sprechen</p><p class="text-[10px] text-gray-500">DrÃ¼cke Mikrofon und sprich</p></div>
                                    <div><span class="text-2xl block mb-1">ðŸ¤–</span><p class="font-bold text-gray-800 text-xs">KI-Kunde</p><p class="text-[10px] text-gray-500">Reagiert realistisch</p></div>
                                    <div><span class="text-2xl block mb-1">ðŸ“Š</span><p class="font-bold text-gray-800 text-xs">Feedback</p><p class="text-[10px] text-gray-500">Detaillierte Bewertung</p></div>
                                </div>
                            </div>
                        </div>
                        <div id="trainingSession" style="display:none">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span id="tSessionIcon" class="text-2xl">ðŸš€</span>
                                    <div><h3 id="tSessionTitle" class="font-bold text-gray-800"></h3><p class="text-xs text-gray-500"><span id="tSessionDiff"></span> Â· <span id="tSessionTimer">0:00</span></p></div>
                                </div>
                                <button id="tEndBtn" onclick="endTrainingSession()" disabled class="text-xs px-4 py-2 border-2 border-vit-orange text-vit-orange rounded-lg font-bold hover:bg-orange-50 transition disabled:opacity-40">Beenden &amp; Bewerten</button>
                            </div>
                            <div class="p-3 rounded-lg text-xs text-center text-white font-semibold" style="background:linear-gradient(135deg,#EF7D00,#dc6b00)">ðŸ’¡ <span id="tSessionHint"></span></div>
                            <div id="tChatMessages" class="space-y-3 mt-4" style="min-height:200px;max-height:400px;overflow-y:auto"></div>
                            <div id="tThinking" class="hidden p-3 text-center text-xs text-gray-400"><div class="inline-flex items-center gap-2"><div class="flex gap-1"><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite"></span><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite 0.2s"></span><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite 0.4s"></span></div> Kunde Ã¼berlegt...</div></div>
                            <div id="tWaveform" class="hidden p-3 rounded-lg mt-2"><div id="tWaveBars" class="flex items-center justify-center gap-0.5" style="height:32px"></div><p id="tWaveLabel" class="text-[10px] font-semibold text-center mt-1" style="color:#EF7D00">ðŸŽ¤ HÃ¶rt zu...</p></div>
                            <p id="tTranscript" class="hidden text-xs text-vit-orange italic text-center mt-2"></p>
                            <div class="mt-3">
                                <div class="flex gap-2">
                                    <input id="tTextInput" type="text" placeholder="Oder hier tippen..." class="flex-1 p-2.5 border border-gray-200 rounded-lg text-sm" onkeydown="if(event.key==='Enter')sendTrainingText()">
                                    <button id="tMicBtn" onclick="toggleTrainingMic()" class="w-12 h-12 rounded-full text-white text-xl flex items-center justify-center" style="background:linear-gradient(135deg,#EF7D00,#dc6b00);box-shadow:0 4px 15px rgba(239,125,0,0.3)">ðŸŽ¤</button>
                                    <button id="tSendMicBtn" onclick="sendTrainingVoice()" class="hidden w-12 h-12 rounded-full bg-green-500 text-white text-xl flex items-center justify-center font-bold">âœ“</button>
                                    <button id="tSendTextBtn" onclick="sendTrainingText()" class="hidden w-10 h-10 rounded-full text-white text-sm flex items-center justify-center" style="background:#EF7D00">â†‘</button>
                                </div>
                                <p id="tInputHint" class="text-center text-[10px] text-gray-400 mt-2">DrÃ¼cke ðŸŽ¤ oder tippe deine Antwort</p>
                            </div>
                        </div>
                        <div id="trainingEval" style="display:none">
                            <div class="text-center mb-6"><h3 id="tEvalTitle" class="text-lg font-bold text-gray-800"></h3><p id="tEvalMeta" class="text-xs text-gray-400"></p></div>
                            <div class="flex justify-center mb-4"><svg id="tScoreRing" width="96" height="96" viewBox="0 0 100 100"></svg></div>
                            <p id="tScoreLabel" class="text-center font-bold text-gray-800 mb-1"></p>
                            <p id="tScoreSummary" class="text-center text-xs text-gray-500 mb-6 px-4"></p>
                            <div class="border-t pt-4">
                                <p class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Bewertungskriterien</p>
                                <div id="tCriteriaRings" class="flex justify-center gap-4 flex-wrap mb-4"></div>
                                <div id="tCriteriaDetails" class="space-y-2 mb-6"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="p-3 rounded-lg" style="background:#f0fdf4"><p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:#059669">ðŸ’ª StÃ¤rken</p><div id="tStrengths"></div></div>
                                <div class="p-3 rounded-lg" style="background:#fffbeb"><p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:#EF7D00">ðŸ’¡ Tipps</p><div id="tImprovements"></div></div>
                            </div>
                            <div class="flex justify-center gap-3">
                                <button onclick="restartTrainingScenario()" class="px-6 py-2.5 rounded-lg text-white text-sm font-bold" style="background:linear-gradient(135deg,#EF7D00,#dc6b00)">ðŸ”„ Nochmal Ã¼ben</button>
                                <button onclick="backToTrainingMenu()" class="px-6 py-2.5 rounded-lg border-2 border-gray-200 text-gray-600 text-sm font-bold hover:bg-gray-50">â† Szenarien</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MARKETING View -->
                <!-- ===== DASHBOARDS VIEW (Finanzen, Marketing PRO, Team als Tabs) ===== -->
                <div id="dashboardsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_dashboards">DASHBOARDS</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showDashboardTab('finanzen')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="finanzen">Finanzen</button>
                            <button onclick="showDashboardTab('leadreporting')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="leadreporting">Marketing <span class="premium-badge ml-1 text-[8px] px-1.5 py-0.5">PRO</span></button>
                            <button onclick="showDashboardTab('team')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="team">Team</button>
                        </nav>
                    </div>

                    <!-- Tab: Finanzen (initially visible, content injected from old financesView) -->
                    <div id="dashTabFinanzen" class="dash-tab-content"></div>

                    <!-- Tab: Lead Reporting / Marketing PRO -->
                    <div id="dashTabLeadreporting" class="dash-tab-content" style="display:none;"></div>

                    <!-- Tab: Team -->
                    <div id="dashTabTeam" class="dash-tab-content" style="display:none;"></div>
                </div>

                <div id="leadReportingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_leadreporting">LEAD REPORTING</h1>
                    
                    <!-- Header with filters -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">â— Live-Daten</span>
                            <span class="text-sm text-gray-600">167 Leads in 2026</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <option>Jahr (YTD)</option>
                                <option>Q1</option>
                                <option>Q2</option>
                            </select>
                        </div>
                    </div>

                    <!-- 4 KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Jahresziel</span>
                                <span class="text-vit-orange text-xl">ðŸŽ¯</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">3,602.5</div>
                            <div class="text-xs text-gray-500 mt-1">Leads gesamt</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ziel YTD (2 Mon.)</span>
                                <span class="text-blue-500 text-xl">ðŸ“ˆ</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">422.7</div>
                            <div class="text-xs text-gray-500 mt-1">Soll bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ist YTD</span>
                                <span class="text-red-500 text-xl">âš ï¸</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">167.0</div>
                            <div class="text-xs text-gray-500 mt-1">Erreicht bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Performance</span>
                                <span class="text-purple-500 text-xl">%</span>
                            </div>
                            <div class="text-3xl font-bold text-red-500">40%</div>
                            <div class="text-xs text-gray-500 mt-1">Zielerreichung</div>
                        </div>
                    </div>

                    <!-- Monthly Chart -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Monatliche Uebersicht</h2>
                        <div class="flex items-center space-x-4 mb-4">
                            <div id="monthlyChart" style="width:100%; height:280px; position:relative;">
                                <div class="flex items-end justify-between h-64 px-2" id="chartBars"></div>
                                <div class="flex justify-between px-2 mt-2 text-xs text-gray-500" id="chartLabels"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-center space-x-6 text-sm text-gray-500">
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-gray-300 rounded inline-block"></span><span>Soll</span></span>
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-vit-orange rounded inline-block"></span><span>Ist</span></span>
                        </div>
                    </div>

                    <!-- Detail Table -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Detailansicht</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-2 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Soll</th>
                                        <th class="text-right py-3 px-2 font-semibold text-green-600">Termine</th>
                                        <th class="text-right py-3 px-2 font-semibold text-purple-600">â‚¬/Termin</th>
                                        <th class="text-right py-3 px-2 font-semibold text-blue-600">SV (x0.25)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-orange-600">SV (Roh)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-800">Gesamt</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Differenz</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Performance</th>
                                        <th class="text-center py-3 px-2 font-semibold text-gray-600">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="detailTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Marketing View (HauptmenÃ¼) â€“ REDESIGN v3 -->
                <div id="marketingView" class="view" style="display: none;">
                    <div id="trainerAreaMarketing" class="mb-4"></div>
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_marketing">MARKETING</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showMarketingTab('cockpit')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="cockpit">
                                ðŸŽ¯ Cockpit
                            </button>
                            <button onclick="showMarketingTab('budget')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="budget">
                                ðŸ’° Budget
                            </button>
                            <button onclick="showMarketingTab('kampagnen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="kampagnen">
                                ðŸ“… Kampagnen
                            </button>
                            <button onclick="showMarketingTab('reichweite')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="reichweite">
                                ðŸ“¡ Reichweite
                            </button>
                            <button onclick="showMarketingTab('social')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="social">
                                ðŸŽ¬ Social Media
                            </button>
                            <button onclick="showMarketingTab('mktStrategie')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktStrategie">
                                ðŸ“‹ Strategie
                            </button>
                            <button onclick="showMarketingTab('mktWissen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktWissen">
                                ðŸ“š Wissen
                            </button>
                        </nav>
                    </div>

                    <!-- NEW TABS: React-Container -->
                    <div id="marketingTabCockpit" class="marketing-tab-content">
                        <div id="mktReactCockpit"></div>
                    </div>
                    <div id="marketingTabBudget" class="marketing-tab-content" style="display:none;">
                        <div id="mktReactBudget"></div>
                    </div>
                    <div id="marketingTabKampagnen" class="marketing-tab-content" style="display:none;">
                        <div id="mktReactKampagnen"></div>
                    </div>
                    <div id="marketingTabReichweite" class="marketing-tab-content" style="display:none;">
                        <div id="mktReactReichweite"></div>
                    </div>

                    <!-- PRESERVED TABS -->
                    <div id="marketingTabSocial" class="marketing-tab-content" style="display:none;">

                        <!-- Motivation Header -->
                        <div class="vit-card p-5 mb-6 bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800" data-i18n="lh_title">ðŸŽ¬ Local Hero â€“ Content Strategie</h2>
                                    <p class="text-sm text-gray-600 mt-1">Dreh ein kurzes Video, lade es hoch â€“ wir machen den Rest! Schnitt, Untertitel &amp; Posting Ã¼bernimmt das HQ.</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-vit-orange" id="smScoreNumber">4</div>
                                    <div class="text-[10px] text-gray-500 uppercase" data-i18n="lbl_videos_shot">Videos gedreht</div>
                                </div>
                            </div>
                            <!-- Progress -->
                            <div class="mt-3 flex items-center space-x-3">
                                <div class="flex-1 bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-vit-orange to-yellow-400 h-3 rounded-full transition-all" id="smProgressBar" style="width:8%"></div>
                                </div>
                                <span class="text-xs font-bold text-gray-600" id="smProgressText">4 / 50 Themen</span>
                            </div>
                            <div class="flex items-center space-x-4 mt-3">
                                <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-semibold" data-i18n="lbl_streak">ðŸ”¥ Streak: 2 Wochen</span>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold" data-i18n="lbl_rank">ðŸ† Rang 5 von 21</span>
                                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-semibold" data-i18n="lbl_next_badge">â­ Naechstes Badge: 5 Videos</span>
                            </div>
                        </div>

                        <!-- Sub-Navigation Pills -->
                        <div class="flex space-x-2 mb-5 flex-wrap gap-y-2">
                            <button onclick="switchSmSub('kanaele')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-vit-orange text-white" data-smsub="kanaele" data-i18n="sm_channels">ðŸ“± Unsere Kanaele</button>
                            <button onclick="switchSmSub('themen')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="themen" data-i18n="sm_topics">ðŸŽ¬ Themen-Auftraege</button>
                            <button onclick="switchSmSub('upload')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="upload" data-i18n="sm_upload">ðŸ“¤ Video hochladen</button>
                            <button onclick="switchSmSub('ranking')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ranking" data-i18n="sm_ranking">ðŸ“Š Netzwerk-Ranking</button>
                            <button onclick="switchSmSub('ablauf')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ablauf" data-i18n="sm_howto">â„¹ï¸ So funktioniert's</button>
                        </div>

                        <!-- SUB: Unsere KanÃ¤le -->
                        <div id="smSubKanaele" class="sm-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                                <!-- Instagram -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Instagram</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">10.2k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">847</p><p class="text-[10px] text-gray-500" data-i18n="ch_posts">Beitraege</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">4.2%</p><p class="text-[10px] text-gray-500" data-i18n="ch_engagement">Engagement</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="flex-1 py-2 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                                <!-- YouTube -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-red-600 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">YouTube</h3>
                                            <p class="text-xs text-gray-500">vit:bikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">156</p><p class="text-[10px] text-gray-500" data-i18n="ch_subscribers">Abonnenten</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">48</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">12.4k</p><p class="text-[10px] text-gray-500" data-i18n="ch_views">Aufrufe</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-semibold text-center hover:bg-red-700 transition">Zum Kanal â†’</a>
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Abonnieren</a>
                                    </div>
                                </div>

                                <!-- TikTok -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-black flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 0 0-.79-.05A6.34 6.34 0 0 0 3.15 15.2a6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.34-6.34V8.73a8.19 8.19 0 0 0 4.76 1.52V6.79a4.82 4.82 0 0 1-1-.1z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">TikTok</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">2.8k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">124</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">89k</p><p class="text-[10px] text-gray-500" data-i18n="ch_likes">Likes</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-black text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- SUB 1: Themen-AuftrÃ¤ge -->
                        <div id="smSubThemen" class="sm-sub-content" style="display:none;">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex space-x-2">
                                    <button onclick="filterSmThemen('all')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-smf="all" data-i18n="filter_all">Alle</button>
                                    <button onclick="filterSmThemen('neu')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="neu" data-i18n="filter_new">ðŸ†• Neu fuer dich</button>
                                    <button onclick="filterSmThemen('done')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="done" data-i18n="filter_done">âœ… Erledigt</button>
                                </div>
                                <input type="text" id="smThemenSearch" placeholder="Thema suchen..." data-i18n-placeholder="search_topic" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs w-48" oninput="filterSmThemen(currentSmFilter)">
                            </div>
                            <div id="smThemenList" class="space-y-2"></div>
                        </div>

                        <!-- SUB 2: Upload -->
                        <div id="smSubUpload" class="sm-sub-content" style="display:none;">
                            <div class="max-w-xl mx-auto">
                                <div class="vit-card p-6">
                                    <div class="text-center mb-5">
                                        <div class="text-4xl mb-2">ðŸ“¤</div>
                                        <h3 class="text-lg font-bold text-gray-800" data-i18n="upl_title">Video hochladen</h3>
                                        <p class="text-sm text-gray-500">Waehle ein Thema, lade dein Video hoch â€“ fertig! Wir kuemmern uns um Schnitt, Untertitel und Posting.</p>
                                    </div>

                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Content-Thema waehlen</label>
                                            <select id="smUploadThema" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm">
                                                <option value="">Thema waehlen...</option>
                                            </select>
                                            <p class="text-[10px] text-gray-400 mt-1">Oder trage 0000 ein, wenn es ein eigener Vorschlag ist</p>
                                        </div>

                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Dein Video</label>
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-vit-orange transition cursor-pointer" onclick="this.querySelector('input')||this.insertAdjacentHTML('beforeend','<input type=file class=hidden onchange=handleFileUpload(this)>');var fi=this.querySelector('input');if(fi)fi.click()">
                                                <div class="text-4xl mb-2">â˜ï¸</div>
                                                <p class="text-sm text-gray-600">Video hierhin ziehen</p>
                                                <p class="text-xs text-gray-400 mt-1">oder klicken zum Auswaehlen</p>
                                                <p class="text-[10px] text-gray-300 mt-2">MP4, MOV Â· Max. 2 GB</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Kurzer Kommentar <span class="font-normal text-gray-400">(optional)</span></label>
                                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="2" placeholder="z.B. 'Haben das im Laden gedreht, Lichtsituation war schwierig'"></textarea>
                                        </div>

                                        <button class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold hover:opacity-90 transition text-sm" onclick="alert('ðŸŽ‰ Video eingereicht! Das HQ meldet sich wenn es fertig geschnitten ist.')">
                                            ðŸš€ Video einreichen
                                        </button>
                                        <p class="text-[10px] text-gray-400 text-center">Das HQ schneidet euer Video, packt Untertitel drauf und postet es als Collab-Post auf eurem Profil.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB 3: Ranking -->
                        <div id="smSubRanking" class="sm-sub-content" style="display:none;">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="vit-card p-6">
                                    <h3 class="font-bold text-gray-800 mb-4" data-i18n="rank_title">ðŸ† Content-Ranking â€“ Wer dreht am meisten?</h3>
                                    <div id="smRankingList" class="space-y-2"></div>
                                </div>
                                <div>
                                    <div class="vit-card p-6 mb-4">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_badges">ðŸŽ–ï¸ Badges</h3>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŒ±</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_first">Erster Upload</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŽ¬</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_3">3 Videos</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                                                <div class="text-2xl">â­</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_5">5 Videos</p>
                                                <p class="text-[10px] text-orange-600" data-i18n="badge_almost">Noch 1!</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ”¥</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_10">10 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ’Ž</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_25">25 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ‘‘</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_50">50 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="vit-card p-6">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_stats">ðŸ“Š Netzwerk-Statistik</h3>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">34</p><p class="text-[10px] text-gray-500" data-i18n="rank_total_vids">Videos gesamt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">25</p><p class="text-[10px] text-gray-500" data-i18n="rank_topics_covered">Themen abgedeckt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">10</p><p class="text-[10px] text-gray-500" data-i18n="rank_active">Aktive Standorte</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold text-red-500">13</p><p class="text-[10px] text-gray-500" data-i18n="rank_no_video">Noch ohne Video</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB 4: Ablauf -->
                        <div id="smSubAblauf" class="sm-sub-content" style="display:none;">
                            <div class="vit-card p-6 mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="howto_title">So funktioniert Local Hero â€“ in 3 Schritten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                                        <div class="w-10 h-10 bg-vit-orange text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">1. Inspiration</p>
                                        <p class="text-[10px] text-gray-500">Wir stellen Thema + Beispielvideo bereit</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">DU</div>
                                        <p class="text-xs font-bold text-gray-700">2. Drehen & Upload</p>
                                        <p class="text-[10px] text-gray-500">1-3 Min. Video mit dem Handy drehen und hier hochladen</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">3. Schnitt & Posting</p>
                                        <p class="text-[10px] text-gray-500">Wir schneiden, packen Untertitel drauf und posten als Collab</p>
                                    </div>
                                </div>
                            </div>

                            <div class="vit-card p-6 mb-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_tips">ðŸ’¡ Tipps fuer gute Videos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ“±</span><div><p class="text-sm font-semibold">Hochformat</p><p class="text-xs text-gray-500">9:16 Format (wie Instagram Story/Reel)</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ”Š</span><div><p class="text-sm font-semibold">Laut & deutlich sprechen</p><p class="text-xs text-gray-500">Wir packen Untertitel drauf â€“ aber guter Ton hilft</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ’¡</span><div><p class="text-sm font-semibold">Gutes Licht</p><p class="text-xs text-gray-500">Am besten Tageslicht oder Laden-Beleuchtung</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">â±ï¸</span><div><p class="text-sm font-semibold">Max. 1-3 Minuten</p><p class="text-xs text-gray-500">Kurz und knackig â€“ lieber zu kurz als zu lang</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸŽ¯</span><div><p class="text-sm font-semibold">Hook-Hauptteil-Outro</p><p class="text-xs text-gray-500">Aufbau steht bei jedem Thema dabei</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ¤·</span><div><p class="text-sm font-semibold">Nicht perfekt sein</p><p class="text-xs text-gray-500">Authentisch > perfekt. Einfach drauflos!</p></div></div>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_links">ðŸ”— Hilfreiche Links</h3>
                                <div class="space-y-2">
                                    <a href="https://fahrrad.vitbikes.de/inspiration/" target="_blank" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸŽ¥</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Beispielvideos & Inspiration</p><p class="text-[10px] text-gray-400">fahrrad.vitbikes.de/inspiration</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸ“‹</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Reel-Template (MAKE IT REEL)</p><p class="text-[10px] text-gray-400">Hook â€“ Hauptteil â€“ Outro Vorlage</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Tab: Marketing Strategie -->
                    <div id="marketingTabMktStrategie" class="marketing-tab-content" style="display:none;">
                        <div class="vit-card p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">Marketing-Strategie 2026</h2>
                                    <p class="text-sm text-gray-500">Jahresgespraech vom 23.12.2025 Â· Ansprechpartner vit:bikes: Michael Stenzel</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Vereinbart &amp; Unterschrieben</span>
                            </div>
                        </div>

                        <!-- Vereinbarung 2026 -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“</span> Vereinbarung 2026</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Budget / Monat</p><p class="text-2xl font-bold text-vit-orange">1.500 â‚¬</p><p class="text-xs text-gray-400">flexibel anpassbar zum Monatsanfang</p></div>
                                <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Mediamix</p><p class="text-lg font-bold text-blue-600">Meta + Google</p><p class="text-xs text-gray-400">+ Framen, Audio, Events (optional)</p></div>
                                <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Content-Unterstuetzung</p><p class="text-lg font-bold text-green-600">Ads + Organisch</p><p class="text-xs text-gray-400">durch vit:bikes Content-Team</p></div>
                            </div>
                            <p class="text-sm text-gray-600">Zusaetzlich: Lokale OOH-Werbemittel, Individuelle Ads, Influencer-Kooperationen</p>
                        </div>

                        <!-- Performance 2025 -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸ“Š</span> Performance 2025</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Standortsuche</p><p class="text-xl font-bold text-gray-800">4.275</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Terminbuchungen</p><p class="text-xl font-bold text-vit-orange">40</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Store Visits</p><p class="text-xl font-bold text-green-600">108</p><p class="text-xs text-blue-500">Meta</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Impressionen</p><p class="text-xl font-bold text-gray-800">1.248.800</p><p class="text-xs text-red-500">Google Ads</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Klicks</p><p class="text-xl font-bold text-gray-800">8.924</p><p class="text-xs text-red-500">Google Ads</p></div>
                                <div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-400">Kosten Gesamt</p><p class="text-xl font-bold text-red-600">7.184 â‚¬</p><p class="text-xs text-red-500">Google Ads</p></div>
                            </div>
                        </div>

                        <!-- Grafrath vs Netzwerk Durchschnitt -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-6">
                                <h3 class="font-semibold text-gray-800 mb-3">âŒ€ Grafrath</h3>
                                <table class="w-full text-sm"><tbody>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Budget/Monat</td><td class="py-2 text-right font-semibold">863,86 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPC</td><td class="py-2 text-right font-semibold">103,50 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPT (Cost per Termin)</td><td class="py-2 text-right font-semibold">205,92 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Termine / Monat</td><td class="py-2 text-right font-semibold">4,88</td></tr>
                                    <tr><td class="py-2 text-gray-500">Store Visits / Monat</td><td class="py-2 text-right font-semibold">16,38</td></tr>
                                </tbody></table>
                            </div>
                            <div class="vit-card p-6 border-l-4 border-vit-orange">
                                <h3 class="font-semibold text-vit-orange mb-3">âŒ€ vit:bikes Netzwerk</h3>
                                <table class="w-full text-sm"><tbody>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Budget/Monat</td><td class="py-2 text-right font-semibold">1.436 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPC</td><td class="py-2 text-right font-semibold">104,32 â‚¬</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">CPT (Cost per Termin)</td><td class="py-2 text-right font-semibold text-green-600">163,15 â‚¬ âœ“</td></tr>
                                    <tr class="border-b"><td class="py-2 text-gray-500">Termine / Monat</td><td class="py-2 text-right font-semibold text-green-600">9 âœ“</td></tr>
                                    <tr><td class="py-2 text-gray-500">Store Visits / Monat</td><td class="py-2 text-right font-semibold text-green-600">22 âœ“</td></tr>
                                </tbody></table>
                            </div>
                        </div>

                        <!-- Zielerreichung -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center"><span class="w-8 h-8 bg-green-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸŽ¯</span> Zielerreichung 2025</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg bg-yellow-50"><p class="text-sm text-gray-600 mb-1">Terminziel-Erreichung</p><div class="flex items-center"><div class="flex-1 bg-gray-200 rounded-full h-4 mr-3"><div class="bg-yellow-500 h-4 rounded-full" style="width:56%"></div></div><span class="text-sm font-bold text-yellow-600">56%</span></div></div>
                                <div class="p-4 rounded-lg bg-green-50"><p class="text-sm text-gray-600 mb-1">Storevisit-Ziel-Erreichung</p><div class="flex items-center"><div class="flex-1 bg-gray-200 rounded-full h-4 mr-3"><div class="bg-green-500 h-4 rounded-full" style="width:100%"></div></div><span class="text-sm font-bold text-green-600">103%</span></div></div>
                            </div>
                        </div>

                        <!-- Basic Checkliste -->
                        <div class="vit-card p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-purple-600 text-white rounded-lg flex items-center justify-center text-sm mr-3">âœ…</span> Basic Checkliste</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Aussendarstellung</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Individuelle Ads (Paid)</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Organische Stories</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Events 2025</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Google My Business</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Influencer-Kooperationen</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Landingpage</span></div>
                                <div class="flex items-center space-x-2 p-2 bg-green-50 rounded"><span class="text-green-600">âœ…</span><span class="text-sm">Etermin + Setting</span></div>
                            </div>
                        </div>

                        <!-- Skalierungspotentiale -->
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center"><span class="w-8 h-8 bg-vit-orange text-white rounded-lg flex items-center justify-center text-sm mr-3">ðŸš€</span> Skalierungspotentiale</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange"><span class="font-bold text-vit-orange">1</span><div><p class="font-semibold text-sm">Individuelle Ads</p><p class="text-xs text-gray-500">Bessere Performance &amp; Authentizitaet durch lokalen Content</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">2</span><div><p class="font-semibold text-sm">Organische Platzierung</p><p class="text-xs text-gray-500">YouTube, Meta &amp; TikTok Kanaele nutzen</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">3</span><div><p class="font-semibold text-sm">Haendlerprofil schaerfen</p><p class="text-xs text-gray-500">Expertise, Marken, Kategorien klarer kommunizieren</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-vit-orange"><span class="font-bold text-vit-orange">4</span><div><p class="font-semibold text-sm">Lokale Events</p><p class="text-xs text-gray-500">Steigern Identitaet, staerken Kundenbindung, erreichen Neukunden</p></div></div>
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg"><span class="font-bold text-gray-400">5</span><div><p class="font-semibold text-sm">Marketingmix ausbauen</p><p class="text-xs text-gray-500">Mediale Kommunikation erweitern</p></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="marketingTabMktWissen" class="marketing-tab-content" style="display:none;"></div>
                </div>
                <div id="einkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_purchasing">EINKAUF</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showEinkaufTab('sortiment')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="sortiment">ðŸª Sortiment</button>
                            <button onclick="showEinkaufTab('lieferanten')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="lieferanten">ðŸ“‹ Lieferanten</button>
                            <button onclick="showEinkaufTab('zentralreg')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="zentralreg">ðŸ¦ Zentralreg.</button>
                            <button onclick="showEinkaufTab('ekStrategie')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekStrategie">ðŸŽ¯ Strategie</button>
                            <button onclick="showEinkaufTab('ekWissen')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <div id="ekTabSortiment" class="ek-tab-content"></div>
                    <div id="ekTabLieferanten" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabZentralreg" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabEkStrategie" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabEkWissen" class="ek-tab-content" style="display:none;"></div>
                </div>

                <div id="controllingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_controlling">CONTROLLING</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showControllingTab('cockpit')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="cockpit">ðŸŽ¯ Cockpit</button>
                            <button onclick="showControllingTab('bwa')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="bwa">BWAs</button>
                            <button onclick="showControllingTab('benchmark')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="benchmark">Benchmarks</button>
                            <button onclick="showControllingTab('planist')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="planist">Plan / Ist</button>
                            <button onclick="showControllingTab('liquiditaet')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="liquiditaet">Liquiditaet</button>
                            <button onclick="showControllingTab('ctrlWissen')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ctrlWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 0: COCKPIT ===== -->
                    <div id="ctrlTabCockpit" class="ctrl-tab-content">
                        <!-- BWA Deadline Countdown + Motivation -->
                        <div id="trainerAreaControlling" class="mb-4"></div>
                        <div id="bwaDeadlineWidget" class="vit-card p-5 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div id="bwaCountdownRing" style="position:relative;width:64px;height:64px;flex-shrink:0">
                                        <svg width="64" height="64" style="transform:rotate(-90deg)">
                                            <circle cx="32" cy="32" r="28" fill="none" stroke="#f3f4f6" stroke-width="5"/>
                                            <circle id="bwaRingCircle" cx="32" cy="32" r="28" fill="none" stroke="#EF7D00" stroke-width="5" stroke-dasharray="175.9" stroke-dashoffset="0" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
                                        </svg>
                                        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
                                            <span id="bwaCountdownDays" style="font-size:18px;font-weight:900;color:#EF7D00">â€”</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h2 id="bwaDeadlineTitle" class="text-base font-bold text-gray-800">BWA-Status wird geladen...</h2>
                                        <p id="bwaDeadlineSubtext" class="text-sm text-gray-500 mt-1"></p>
                                        <div id="bwaRatingBadge" style="display:none;margin-top:6px"></div>
                                    </div>
                                </div>
                                <div id="bwaCTAArea">
                                    <button onclick="showControllingTab('bwa')" id="bwaUploadCTA" class="px-5 py-2.5 bg-vit-orange text-white font-bold text-sm rounded-lg hover:opacity-90 transition" style="display:none">
                                        ðŸ“¤ BWA jetzt einreichen
                                    </button>
                                </div>
                            </div>
                            <!-- Eskalation-Banner (Stufe 2+3) -->
                            <div id="bwaEskalationBanner" style="display:none;margin-top:12px;padding:12px 16px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;">
                                <div class="flex items-center gap-3">
                                    <span style="font-size:20px">âš ï¸</span>
                                    <div>
                                        <p id="bwaEskText" class="text-sm font-semibold text-red-700"></p>
                                        <p id="bwaEskSub" class="text-xs text-red-500 mt-0.5"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Netzwerk-Vergleich: Wer hat schon eingereicht? -->
                        <div id="bwaNetzwerkWidget" class="vit-card p-5 mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-sm font-bold text-gray-800">ðŸ“Š BWA-Status im Netzwerk</h2>
                                <span id="bwaNetzwerkProgress" class="text-xs font-semibold text-gray-500"></span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2.5 mb-3"><div id="bwaNetzwerkBar" class="h-2.5 rounded-full transition-all" style="width:0%;background:#EF7D00"></div></div>
                            <div id="bwaNetzwerkDetail" class="flex gap-4 text-xs text-gray-500">
                                <span id="bwaNwGold">ðŸ¥‡ Gold: â€”</span>
                                <span id="bwaNwOk">âœ… OK: â€”</span>
                                <span id="bwaNwMissing">â³ Ausstehend: â€”</span>
                                <span id="bwaNwOverdue">ðŸš¨ ÃœberfÃ¤llig: â€”</span>
                            </div>
                        </div>

                        <!-- KPI Sofort-Report (nach Upload sichtbar) -->
                        <div id="bwaKpiReport" class="vit-card p-5 mb-6" style="display:none;border-left:4px solid #16a34a">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-sm font-bold text-gray-800">âœ… Dein Monats-Feedback</h2>
                                    <p class="text-xs text-gray-500" id="bwaKpiReportMonth"></p>
                                </div>
                                <div id="bwaKpiRating"></div>
                            </div>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4" id="bwaKpiReportGrid"></div>
                            <div id="bwaKpiInsights" class="p-3 bg-green-50 rounded-lg">
                                <p class="text-xs font-semibold text-green-700 mb-1">ðŸ’¡ Empfehlungen</p>
                                <ul id="bwaKpiRecList" class="text-xs text-green-600 space-y-1"></ul>
                            </div>
                        </div>

                        
                        <div id="cockpitContent"><p class="text-sm text-gray-400 text-center py-8">Lade Cockpit-Daten...</p></div>
                    </div>

                    <!-- ===== TAB 1: BWAs ===== -->
                    <div id="ctrlTabBwa" class="ctrl-tab-content" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left: BWA Ablage -->
                            <div class="lg:col-span-1">
                                <div class="vit-card p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800">BWA Ablage</h2>
                                        <button onclick="openBwaUploadModal()" class="px-3 py-1.5 bg-vit-orange text-white text-sm rounded-lg hover:opacity-90">+ Erfassen</button>
                                    </div>
                                    <div id="bwaFileList" class="space-y-2">
                                        <p class="text-sm text-gray-400 text-center py-4">Wird geladen...</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Right: BWA Anzeige -->
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6" id="bwaDisplay">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800" id="bwaTitle">BWA auswaehlen</h2>
                                        <div class="flex space-x-2">
                                            <button onclick="editSelectedBwa()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" id="bwaEditBtn" style="display:none">âœï¸ Bearbeiten</button>
                                            <button onclick="deleteBwa()" class="px-3 py-1.5 text-sm border border-red-300 text-red-500 rounded-lg hover:bg-red-50" id="bwaDeleteBtn" style="display:none">ðŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <!-- KPI Summary -->
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="bwaKpiGrid">
                                        <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Umsatz</p><p class="text-xl font-bold text-gray-800" id="bwaKpiUmsatz">â€”</p><p class="text-xs text-gray-400" id="bwaKpiUmsatzVj">&nbsp;</p></div>
                                        <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Rohertrag</p><p class="text-xl font-bold text-gray-800" id="bwaKpiRohertrag">â€”</p><p class="text-xs text-gray-400" id="bwaKpiMarge">&nbsp;</p></div>
                                        <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Gesamtkosten</p><p class="text-xl font-bold text-gray-800" id="bwaKpiKosten">â€”</p><p class="text-xs text-gray-400" id="bwaKpiKostenVj">&nbsp;</p></div>
                                        <div class="p-4 bg-purple-50 rounded-lg text-center"><p class="text-xs text-gray-500">Ergebnis</p><p class="text-xl font-bold text-gray-800" id="bwaKpiErgebnis">â€”</p><p class="text-xs text-gray-400" id="bwaKpiErgebnisMarge">&nbsp;</p></div>
                                    </div>
                                    <!-- BWA Table -->
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm" id="bwaDetailTable">
                                            <thead><tr class="bg-gray-50"><th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th><th class="text-right py-2 px-3 font-semibold text-gray-600">IST</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Plan</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2 px-3 font-semibold text-gray-600">VJ</th></tr></thead>
                                            <tbody id="bwaDetailBody"><tr><td colspan="5" class="text-center py-8 text-gray-400">Waehle links eine BWA aus oder erfasse neue Daten.</td></tr></tbody>
                                        </table>
                                    </div>
                                    <!-- 12-Monats-Verlauf -->
                                    <div class="mt-6 pt-4 border-t border-gray-200" id="bwaTrendSection" style="display:none">
                                        <h3 class="font-semibold text-gray-800 mb-3">ðŸ“ˆ 12-Monats-Verlauf</h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3" id="bwaTrendCards"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Benchmarks ===== -->
                    <div id="ctrlTabBenchmark" class="ctrl-tab-content" style="display:none;">
                        <!-- Feature Lock Overlay -->
                        <div id="benchmarkLockOverlay" style="display:none;">
                            <div class="vit-card p-8 text-center mb-6" style="border:2px dashed #e5e7eb;">
                                <div style="font-size:48px;margin-bottom:12px">ðŸ”’</div>
                                <h2 class="text-lg font-bold text-gray-800 mb-2">Benchmark-Vergleich gesperrt</h2>
                                <p class="text-sm text-gray-500 mb-4">Ohne aktuelle BWA-Daten ist kein Netzwerk-Vergleich mÃ¶glich.<br>Reiche deine BWA ein, um die Benchmarks freizuschalten.</p>
                                <button onclick="showControllingTab('bwa')" class="px-6 py-3 bg-vit-orange text-white font-bold text-sm rounded-lg hover:opacity-90 transition">
                                    ðŸ“¤ BWA einreichen & freischalten
                                </button>
                                <p class="text-xs text-gray-400 mt-3">Tipp: FrÃ¼habgabe vor dem 8. = Gold-Status ðŸ¥‡</p>
                            </div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-2">Standort-Vergleich</h2>
                            <p class="text-sm text-gray-500 mb-6">Dein Standort vs. Netzwerk-Durchschnitt (Februar 2026)</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / mÂ²</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">428 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">382 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:85%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+12% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Rohertragsmarge</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">36.7%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">34.2%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+2.5 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / Mitarbeiter</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-orange-500">28.560 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">30.100 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-orange-400 h-2.5 rounded-full" style="width:65%"></div></div>
                                    <p class="text-xs text-orange-600 mt-1 font-semibold">-5% unter Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Personalkostenquote</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-red-500">19.9%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">18.5%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-red-400 h-2.5 rounded-full" style="width:72%"></div></div>
                                    <p class="text-xs text-red-600 mt-1 font-semibold">+1.4 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Lagerumschlag</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">4.2x</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">3.8x</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:82%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+11% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Werkstatt-Auslastung</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">78%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">72%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+6 Pp ueber Durchschnitt</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 3: Plan / Ist (dynamisch) ===== -->
                    <div id="ctrlTabPlanist" class="ctrl-tab-content" style="display:none;">
                        <div id="planIstContent">
                            <!-- Filled dynamically by renderPlanIst() -->
                            <div class="text-center py-12 text-gray-400">
                                <div class="w-8 h-8 border-2 border-vit-orange border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p class="text-sm">Lade Plan-Daten...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 4: Liquiditaet ===== -->
                    <div id="ctrlTabLiquiditaet" class="ctrl-tab-content" style="display:none;">
                        <!-- KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Kontostand aktuell</p><p class="text-2xl font-bold text-green-600">47.820 â‚¬</p><p class="text-xs text-gray-500">Stand: 14.02.2026</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Offene Forderungen</p><p class="text-2xl font-bold text-blue-600">23.400 â‚¬</p><p class="text-xs text-gray-500">14 Rechnungen</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Offene Verbindlichkeiten</p><p class="text-2xl font-bold text-red-600">38.200 â‚¬</p><p class="text-xs text-gray-500">8 Rechnungen</p></div>
                            <div class="vit-card p-5"><p class="text-xs text-gray-500 mb-1">Freie Liquiditaet</p><p class="text-2xl font-bold text-gray-800">33.020 â‚¬</p><p class="text-xs text-gray-500">Konto + Ford. - Verbindl.</p></div>
                        </div>
                        <!-- Cash Flow Prognose -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Cash-Flow Prognose (naechste 8 Wochen)</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="text-left py-2 px-3 font-semibold text-gray-600">Woche</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Einnahmen</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Ausgaben</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Saldo</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Kontostand</th></tr></thead>
                                    <tbody>
                                        <tr class="border-b bg-blue-50"><td class="py-2 px-3 font-semibold">KW 8 (aktuell)</td><td class="text-right py-2 px-3 text-green-600">+18.500</td><td class="text-right py-2 px-3 text-red-600">-12.300</td><td class="text-right py-2 px-3 font-semibold text-green-600">+6.200</td><td class="text-right py-2 px-3 font-bold">47.820</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 9</td><td class="text-right py-2 px-3 text-green-600">+22.000</td><td class="text-right py-2 px-3 text-red-600">-28.400</td><td class="text-right py-2 px-3 text-red-600">-6.400</td><td class="text-right py-2 px-3 font-semibold">41.420</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 10</td><td class="text-right py-2 px-3 text-green-600">+19.800</td><td class="text-right py-2 px-3 text-red-600">-15.200</td><td class="text-right py-2 px-3 text-green-600">+4.600</td><td class="text-right py-2 px-3 font-semibold">46.020</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 11</td><td class="text-right py-2 px-3 text-green-600">+24.500</td><td class="text-right py-2 px-3 text-red-600">-18.900</td><td class="text-right py-2 px-3 text-green-600">+5.600</td><td class="text-right py-2 px-3 font-semibold">51.620</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 12</td><td class="text-right py-2 px-3 text-green-600">+21.200</td><td class="text-right py-2 px-3 text-red-600">-34.500</td><td class="text-right py-2 px-3 text-red-600">-13.300</td><td class="text-right py-2 px-3 font-semibold text-orange-600">38.320</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 13</td><td class="text-right py-2 px-3 text-green-600">+26.800</td><td class="text-right py-2 px-3 text-red-600">-16.400</td><td class="text-right py-2 px-3 text-green-600">+10.400</td><td class="text-right py-2 px-3 font-semibold">48.720</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 14</td><td class="text-right py-2 px-3 text-green-600">+28.100</td><td class="text-right py-2 px-3 text-red-600">-19.800</td><td class="text-right py-2 px-3 text-green-600">+8.300</td><td class="text-right py-2 px-3 font-semibold">57.020</td></tr>
                                        <tr class="border-b"><td class="py-2 px-3">KW 15</td><td class="text-right py-2 px-3 text-green-600">+31.500</td><td class="text-right py-2 px-3 text-red-600">-22.100</td><td class="text-right py-2 px-3 text-green-600">+9.400</td><td class="text-right py-2 px-3 font-semibold text-green-600">66.420</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Alerts -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Liquiditaets-Hinweise</h2>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <span class="text-yellow-500 text-xl mt-0.5">âš¡</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">KW 9: Gehaltszahlung + Lieferantenrechnung</p><p class="text-xs text-gray-600">Erwartete Ausgaben von 28.400 â‚¬ - Kontostand sinkt auf ca. 41.420 â‚¬</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                    <span class="text-orange-500 text-xl mt-0.5">ðŸ“‹</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">KW 12: Vororder Fruehjahr faellig</p><p class="text-xs text-gray-600">Grosse Lieferantenrechnung erwartet (34.500 â‚¬) - rechtzeitig Liquiditaet sichern</p></div>
                                </div>
                                <div class="flex items-start space-x-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <span class="text-green-500 text-xl mt-0.5">ðŸ“ˆ</span>
                                    <div><p class="font-semibold text-gray-800 text-sm">Positiver Trend ab KW 13</p><p class="text-xs text-gray-600">Fruehjahrsgeschaeft startet - steigende Einnahmen erwartet</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="ctrlTabCtrlWissen" class="ctrl-tab-content" style="display:none;"></div>
                </div>


                <div id="aktenschrankView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_filingcab">AKTENSCHRANK</h1>

                    <!-- Search & Upload Bar -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="relative flex-1 max-w-md">
                                <input type="text" id="aktenSearch" onkeyup="filterAkten()" placeholder="Dokument suchen..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                        </div>
                        <button onclick="document.getElementById('aktenUploadModal').classList.remove('hidden')" class="px-4 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Dokument hochladen</button>
                    </div>

                    <!-- Folder Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8" id="aktenFolders">

                        <!-- 1. Vertraege & Recht -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('vertraege')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-blue-100 rounded-xl group-hover:bg-blue-200 transition">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-blue-100 text-blue-700 rounded-full px-2 py-0.5">8</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Vertraege &amp; Recht</h3>
                            <p class="text-xs text-gray-500">Miet-, Franchise-, Arbeitsvertraege, Versicherungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 15.01.2026</p>
                        </div>

                        <!-- 2. Finanzen & Buchhaltung -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('finanzen')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-green-100 rounded-xl group-hover:bg-green-200 transition">
                                    <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-green-100 text-green-700 rounded-full px-2 py-0.5">14</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Finanzen &amp; Buchhaltung</h3>
                            <p class="text-xs text-gray-500">BWAs, Jahresabschluesse, Steuerbescheide, Rechnungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 05.02.2026</p>
                        </div>

                        <!-- 3. Personal & HR -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('personal')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-purple-100 rounded-xl group-hover:bg-purple-200 transition">
                                    <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-purple-100 text-purple-700 rounded-full px-2 py-0.5">11</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Personal &amp; HR</h3>
                            <p class="text-xs text-gray-500">Arbeitsvertraege, Lohn, Urlaub, Fortbildungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 31.01.2026</p>
                        </div>

                        <!-- 4. Standort & Betrieb -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('standort')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-orange-100 rounded-xl group-hover:bg-orange-200 transition">
                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-orange-100 text-orange-700 rounded-full px-2 py-0.5">6</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Standort &amp; Betrieb</h3>
                            <p class="text-xs text-gray-500">Grundrisse, Genehmigungen, Inventar, Wartung</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 10.12.2025</p>
                        </div>

                        <!-- 5. Marketing & Branding -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('marketing')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-pink-100 rounded-xl group-hover:bg-pink-200 transition">
                                    <svg class="w-7 h-7 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-4 12v4m-4-4v4m8-12V8a4 4 0 00-8 0v4m-2 0h12a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-pink-100 text-pink-700 rounded-full px-2 py-0.5">9</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Marketing &amp; Branding</h3>
                            <p class="text-xs text-gray-500">Brand Guidelines, Vorlagen, Druckdaten, Fotos</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 03.02.2026</p>
                        </div>

                        <!-- 6. Lieferanten & Einkauf -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('lieferanten')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-cyan-100 rounded-xl group-hover:bg-cyan-200 transition">
                                    <svg class="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-cyan-100 text-cyan-700 rounded-full px-2 py-0.5">7</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Lieferanten &amp; Einkauf</h3>
                            <p class="text-xs text-gray-500">Rahmenvertraege, Preislisten, Konditionen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 20.01.2026</p>
                        </div>

                        <!-- 7. Diverses -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('diverses')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-gray-100 rounded-xl group-hover:bg-gray-200 transition">
                                    <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">3</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Diverses</h3>
                            <p class="text-xs text-gray-500">Sonstiges, Notizen, Protokolle, Temporaeres</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 08.02.2026</p>
                        </div>

                    </div>

                    <!-- Folder Detail View (hidden by default) -->
                    <div id="aktenFolderDetail" class="hidden">
                        <div class="flex items-center space-x-3 mb-4">
                            <button onclick="closeAktenFolder()" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-gray-600">&#9664; Zurueck</button>
                            <h2 class="text-lg font-semibold text-gray-800" id="aktenFolderTitle">Ordner</h2>
                        </div>
                        <div class="vit-card overflow-hidden">
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Dokument</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Typ</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Hochgeladen</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Groesse</th><th class="text-right py-2.5 px-4 font-semibold text-gray-600">Aktion</th></tr></thead>
                                <tbody id="aktenFileList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Modal -->
                    <div id="aktenUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Dokument hochladen</h3>
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                            </div>
                            <div class="space-y-3">
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option>Vertraege &amp; Recht</option><option>Finanzen &amp; Buchhaltung</option><option>Personal &amp; HR</option>
                                    <option>Standort &amp; Betrieb</option><option>Marketing &amp; Branding</option><option>Lieferanten &amp; Einkauf</option><option>Diverses</option>
                                </select>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-vit-orange transition cursor-pointer">
                                    <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                    <p class="text-sm text-gray-500">Datei hierher ziehen oder <span class="text-vit-orange font-semibold">durchsuchen</span></p>
                                    <p class="text-xs text-gray-400 mt-1">PDF, XLSX, DOCX, JPG â€“ max. 25 MB</p>
                                </div>
                                <input type="text" placeholder="Beschreibung (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="w-full bg-vit-orange text-white py-2 rounded-lg font-semibold hover:opacity-90">Hochladen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="supportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_support">SUPPORT</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showSupportTab('tickets')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="tickets">ðŸŽ« Tickets <span id="supTicketBadge" class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">4</span></button>
                            <button onclick="showSupportTab('kontakte')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="kontakte">ðŸ‘¥ Kontakte Zentrale</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Tickets ===== -->
                    <div id="supTabTickets" class="sup-tab-content">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterTickets('all')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-tf="all">Alle (7)</button>
                                <button onclick="filterTickets('offen')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="offen">Offen (2)</button>
                                <button onclick="filterTickets('bearbeitung')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="bearbeitung">In Bearbeitung (2)</button>
                                <button onclick="filterTickets('geloest')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="geloest">Geloest (3)</button>
                            </div>
                            <button onclick="document.getElementById('ticketCreate').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neues Ticket</button>
                        </div>

                        <!-- Create Ticket Form -->
                        <div id="ticketCreate" class="hidden vit-card p-5 mb-4">
                            <h3 class="font-semibold text-gray-800 mb-3">Neues Support-Ticket erstellen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <select id="ticketCatInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="allgemein">Kategorie waehlen...</option>
                                    <option value="it">IT / Systeme</option>
                                    <option value="einkauf">Einkauf / Lieferanten</option>
                                    <option value="marketing">Marketing / Ads</option>
                                    <option value="buchhaltung">Buchhaltung / BWA</option>
                                    <option value="werkstatt">Werkstatt / Technik</option>
                                    <option value="sonstiges">Sonstiges</option>
                                </select>
                                <select id="ticketPrioInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="mittel">Prioritaet...</option>
                                    <option value="dringend">ðŸ”´ Hoch â€“ Betrieb eingeschraenkt</option>
                                    <option value="mittel">ðŸŸ¡ Mittel â€“ Wichtig, aber kein Stillstand</option>
                                    <option value="niedrig">ðŸŸ¢ Niedrig â€“ Frage / Wunsch</option>
                                </select>
                            </div>
                            <input id="ticketTitelInput" type="text" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                            <textarea id="ticketBeschreibungInput" placeholder="Beschreibe dein Problem oder deine Frage moeglichst genau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-400">Wird im Portal gespeichert</span>
                                <div class="flex space-x-2">
                                    <button onclick="document.getElementById('ticketCreate').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                    <button onclick="submitTicketForm()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Ticket erstellen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket List -->
                        <div id="ticketList" class="space-y-3"></div>

                        <!-- Zoho Desk Hinweis -->
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center space-x-3">
                            <span class="text-2xl">ðŸ”—</span>
                            <div>
                                <p class="text-sm font-semibold text-blue-800">Alle Tickets werden ueber Zoho Desk verwaltet</p>
                                <p class="text-xs text-blue-600">Fuer erweiterte Funktionen (Anhaenge, Chat, Historie) direkt in Zoho Desk oeffnen.</p>
                            </div>
                            <button class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 whitespace-nowrap">Zoho Desk oeffnen â†’</button>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Kontakte Zentrale ===== -->
                    <div id="supTabKontakte" class="sup-tab-content" style="display:none;">
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">Alle Ansprechpartner der vit:bikes Zentrale auf einen Blick. Bei dringenden Problemen bitte direkt anrufen.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="kontakteGrid"></div>
                    </div>
                </div>

                <!-- ===== IDEENBOARD VIEW ===== -->
                <div id="ideenboardView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_ideaboard">IDEENBOARD</h1>
                    <p class="text-sm text-gray-500 mb-6">Hier koennt ihr Ideen, Wuensche und Verbesserungsvorschlaege einreichen â€“ fuer das Portal, die Warenwirtschaft, den Einkauf und alles rund um vit:bikes. Jede Idee zaehlt!</p>

                    <!-- Neue Idee Button + Filter -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex space-x-2">
                            <button onclick="filterIdeen('all')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-if="all">Alle</button>
                            <button onclick="filterIdeen('neu')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="neu">Neu</button>
                            <button onclick="filterIdeen('diskussion')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="diskussion">In Diskussion</button>
                            <button onclick="filterIdeen('geplant')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="geplant">Geplant</button>
                            <button onclick="filterIdeen('umgesetzt')" class="idee-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-if="umgesetzt">Umgesetzt</button>
                        </div>
                        <button onclick="document.getElementById('ideeCreate').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ’¡ Neue Idee einreichen</button>
                    </div>

                    <!-- Neue Idee Formular -->
                    <div id="ideeCreate" class="hidden vit-card p-5 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">ðŸ’¡ Neue Idee einreichen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <select id="ideeKat" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Bereich waehlen...</option>
                                <option>Portal / Funktionen</option>
                                <option>Warenwirtschaft / Kasse</option>
                                <option>Einkauf / Sortiment</option>
                                <option>Marketing / Werbung</option>
                                <option>Verkauf / Beratung</option>
                                <option>Werkstatt / Service</option>
                                <option>Kommunikation / Zusammenarbeit</option>
                                <option>Sonstiges</option>
                            </select>
                            <select id="ideeTyp" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Typ waehlen...</option>
                                <option>ðŸš€ Neue Funktion</option>
                                <option>ðŸ”§ Verbesserung</option>
                                <option>ðŸ› Problem / Bug</option>
                                <option>ðŸ’¬ Allgemeiner Vorschlag</option>
                            </select>
                        </div>
                        <input id="ideeTitel" type="text" placeholder="Titel deiner Idee..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                        <textarea id="ideeBeschreibung" placeholder="Beschreibe deine Idee moeglichst konkret: Was genau soll verbessert werden? Warum waere das hilfreich? Wie koennte es aussehen?" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Sichtbar fuer alle Partner & die Zentrale</span>
                            <div class="flex space-x-2">
                                <button onclick="document.getElementById('ideeCreate').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                <button onclick="submitIdee()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Idee einreichen</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ideen-Statistik -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-gray-800" id="ideenTotal">0</p>
                            <p class="text-xs text-gray-500">Ideen gesamt</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" id="ideenNeu">0</p>
                            <p class="text-xs text-gray-500">Neue Ideen</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-yellow-600" id="ideenGeplant">0</p>
                            <p class="text-xs text-gray-500">Geplant</p>
                        </div>
                        <div class="vit-card p-4 text-center">
                            <p class="text-2xl font-bold text-green-600" id="ideenUmgesetzt">0</p>
                            <p class="text-xs text-gray-500">Umgesetzt</p>
                        </div>
                    </div>

                    <!-- Ideen Liste -->
                    <div id="ideenList" class="space-y-3"></div>
                </div>

                <div id="kommunikationView" class="view" style="display: none;">
                    <!-- Top Tab Navigation (compact) -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex space-x-1 bg-gray-100 rounded-lg p-1">
                            <button onclick="showKommTab('chat')" class="komm-tab-btn px-4 py-2 rounded-md text-sm font-semibold bg-white text-gray-800 shadow-sm" data-tab="chat">ðŸ’¬ Chat</button>
                            <button onclick="showKommTab('community')" class="komm-tab-btn px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700" data-tab="community">ðŸ‘¥ Community</button>
                        </div>
                    </div>

                    <!-- ===== TAB: Chat (Teams-Style 2-Column) ===== -->
                    <div id="kommTabChat" class="komm-tab-content">
                        <div class="flex h-[calc(100vh-180px)] min-h-[500px] bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            
                            <!-- LEFT: Conversation Sidebar -->
                            <div class="w-80 flex-shrink-0 border-r border-gray-200 flex flex-col bg-gray-50">
                                <!-- Search -->
                                <div class="p-3 border-b border-gray-200">
                                    <div class="relative">
                                        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        <input type="text" id="kommSearchInput" placeholder="Suchen..." class="w-full pl-9 pr-3 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-vit-orange" oninput="filterKommSidebar(this.value)">
                                    </div>
                                </div>

                                <!-- New Message Button -->
                                <div class="p-3 border-b border-gray-200">
                                    <button onclick="kommStartNewChat()" class="w-full flex items-center space-x-2 px-3 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                        <span>Neue Nachricht</span>
                                    </button>
                                </div>

                                <!-- Conversation List -->
                                <div id="kommConvList" class="flex-1 overflow-y-auto">
                                    <!-- Filled by JS: sections for KanÃ¤le, Inbox, AnkÃ¼ndigungen -->
                                </div>
                            </div>

                            <!-- RIGHT: Message/Chat Area -->
                            <div class="flex-1 flex flex-col min-w-0">
                                <!-- Chat Header -->
                                <div id="kommChatHeader" class="px-5 py-3 border-b border-gray-200 flex items-center justify-between bg-white">
                                    <div class="flex items-center space-x-3">
                                        <div id="kommChatAvatar" class="w-9 h-9 bg-vit-orange rounded-lg flex items-center justify-center text-white font-bold text-sm">#</div>
                                        <div>
                                            <h3 id="kommChatTitle" class="font-bold text-gray-800 text-sm">WÃ¤hle eine Konversation</h3>
                                            <p id="kommChatSubtitle" class="text-xs text-gray-500"></p>
                                        </div>
                                    </div>
                                    <div id="kommChatHeaderActions" class="flex items-center space-x-2"></div>
                                </div>

                                <!-- Messages Area -->
                                <div id="kommChatMessages" class="flex-1 overflow-y-auto p-5 space-y-1" style="scroll-behavior:smooth;">
                                    <div class="flex items-center justify-center h-full text-gray-400 text-sm">
                                        <div class="text-center">
                                            <div class="text-4xl mb-3">ðŸ’¬</div>
                                            <p class="font-semibold">Willkommen in der Kommunikation</p>
                                            <p class="text-xs mt-1">WÃ¤hle links eine Konversation oder starte eine neue Nachricht</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Message Input (fixed bottom) -->
                                <div id="kommChatInput" class="border-t border-gray-200 p-4 bg-white" style="display:none;">
                                    <!-- Reply indicator -->
                                    <div id="kommReplyBar" class="hidden mb-2 p-2 bg-orange-50 border-l-4 border-vit-orange rounded flex items-center justify-between">
                                        <div class="text-xs text-gray-600"><span class="font-semibold" id="kommReplyTo"></span>: <span id="kommReplyPreview" class="text-gray-400"></span></div>
                                        <button onclick="cancelReply()" class="text-gray-400 hover:text-gray-600 text-sm">&times;</button>
                                    </div>
                                    <div class="flex items-end space-x-3">
                                        <div class="flex-1">
                                            <textarea id="kommMsgInput" placeholder="Nachricht schreiben..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-vit-orange resize-none" rows="1" onkeydown="kommInputKeydown(event)" oninput="kommAutoResize(this)"></textarea>
                                        </div>
                                        <button onclick="kommSendMessage()" class="px-4 py-2.5 bg-vit-orange text-white rounded-xl text-sm font-semibold hover:opacity-90 flex-shrink-0">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB: Forum ===== -->
                    <!-- ===== TAB: Community (Forum + Marktplatz vereint) ===== -->
                    <div id="kommTabCommunity" class="komm-tab-content" style="display:none;">
                        <div id="forumListView">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex space-x-2 flex-wrap gap-y-2">
                                    <button onclick="filterCommunity('all')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-cat="all">Alle</button>
                                    <span class="text-gray-300 self-center">|</span>
                                    <button onclick="filterCommunity('allgemein')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="allgemein">ðŸ’¬ Allgemein</button>
                                    <button onclick="filterCommunity('verkauf')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="verkauf">ðŸ›’ Verkauf</button>
                                    <button onclick="filterCommunity('werkstatt')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="werkstatt">ðŸ”§ Werkstatt</button>
                                    <button onclick="filterCommunity('einkauf')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="einkauf">ðŸ“¦ Einkauf</button>
                                    <span class="text-gray-300 self-center">|</span>
                                    <button onclick="filterCommunity('suche')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="suche">ðŸ” Gesucht</button>
                                    <button onclick="filterCommunity('biete')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="biete">ðŸ·ï¸ Biete</button>
                                    <button onclick="filterCommunity('tipp')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="tipp">ðŸ’¡ Tipp</button>
                                </div>
                                <button onclick="document.getElementById('forumNewPost').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 flex-shrink-0">+ Neuer Beitrag</button>
                            </div>
                            <div id="forumNewPost" class="hidden vit-card p-5 mb-4">
                                <input type="text" id="forumNewTitle" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange">
                                <textarea id="forumNewBody" placeholder="Deine Nachricht an das Netzwerk..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange" rows="3"></textarea>
                                <div class="flex items-center justify-between">
                                    <select id="forumNewCat" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <optgroup label="Diskussion">
                                            <option value="allgemein">ðŸ’¬ Allgemein</option>
                                            <option value="verkauf">ðŸ›’ Verkauf &amp; Beratung</option>
                                            <option value="werkstatt">ðŸ”§ Werkstatt</option>
                                            <option value="einkauf">ðŸ“¦ Einkauf &amp; Lager</option>
                                        </optgroup>
                                        <optgroup label="Marktplatz">
                                            <option value="suche">ðŸ” Rad gesucht</option>
                                            <option value="biete">ðŸ·ï¸ Rad abzugeben</option>
                                            <option value="tipp">ðŸ’¡ Tipp</option>
                                        </optgroup>
                                    </select>
                                    <div class="flex space-x-2">
                                        <button onclick="document.getElementById('forumNewPost').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                        <button onclick="createCommunityPost()" class="px-5 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Posten</button>
                                    </div>
                                </div>
                            </div>
                            <div id="forumPosts" class="space-y-3"></div>
                        </div>
                        <div id="forumDetailView" class="hidden">
                            <button onclick="closeForumDetail()" class="mb-4 text-sm text-vit-orange hover:underline font-semibold">â† ZurÃ¼ck zur Ãœbersicht</button>
                            <div id="forumDetailContent" class="vit-card p-6 mb-4"></div>
                            <div class="vit-card p-5">
                                <h4 class="font-semibold text-gray-800 mb-3">Kommentare</h4>
                                <div id="forumComments" class="space-y-3 mb-4"></div>
                                <div class="flex space-x-3">
                                    <textarea id="forumCommentInput" placeholder="Dein Kommentar..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange" rows="2"></textarea>
                                    <button onclick="postForumComment()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 self-end">Senden</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div id="forumView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_forum">FORUM</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="vit-card p-6 mb-4">
                                <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema erstellen</button>
                            </div>

                            <div class="space-y-4">
                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Neue Marketing-Kampagne fÃ¼r FrÃ¼hjahr 2026</h3>
                                                <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Hallo zusammen! Wir haben eine neue Kampagne fÃ¼r das FrÃ¼hjahr vorbereitet. 
                                                Alle Materialien sind jetzt im Bereich "Marketing" verfÃ¼gbar. WÃ¼rde mich Ã¼ber 
                                                euer Feedback freuen!
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>8 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>42 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                <span class="text-xs text-gray-500">vor 5 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                MÃ¶chte gerne Erfahrungen austauschen zur 3D-KÃ¶rpervermessung. Wie integriert 
                                                ihr das in euren Beratungsprozess? Bei uns dauert das aktuell ca. 15-20 Minuten...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>12 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>67 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Erfolg: Firmenkunden-Akquise</h3>
                                                <span class="text-xs text-gray-500">gestern</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Wollte mal berichten: Wir haben gerade einen Deal mit einem lokalen Unternehmen 
                                                (50 Mitarbeiter) fÃ¼r Bike-Leasing abgeschlossen! ðŸŽ‰ Kann gerne Tipps teilen...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>15 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>89 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="vit-card p-6 mb-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                <div class="space-y-2">
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ”§ Technik & Service</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">45</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">â“ Fragen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">67</span>
                                    </a>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Aktive Mitglieder</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Markus Unger</p>
                                            <p class="text-xs text-gray-500">HQ - Marketing</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Stefan Meyer</p>
                                            <p class="text-xs text-gray-500">Partner MÃ¼nchen</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Julia Fischer</p>
                                            <p class="text-xs text-gray-500">Partner Berlin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kommunikation View (Chat + Forum kombiniert) -->
                <div id="communicationView" class="view premium-feature" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_communication">KOMMUNIKATION</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="flex space-x-4 mb-6">
                        <button onclick="switchCommunicationTab('chat')" id="chatTab" class="px-6 py-3 bg-vit-orange text-white rounded-lg font-semibold">
                            ðŸ’¬ Chat
                        </button>
                        <button onclick="switchCommunicationTab('forum')" id="forumTab" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                            ðŸ—¨ï¸ Forum
                        </button>
                    </div>

                    <!-- Chat Section -->
                    <div id="chatSection">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="vit-card p-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                                <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                                
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">HQ Team</p>
                                            <p class="text-xs text-gray-500 truncate">Neue Schulung verfÃ¼gbar</p>
                                        </div>
                                        <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                    </div>

                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">Thomas Schmidt</p>
                                            <p class="text-xs text-gray-500 truncate">Kunde wartet auf RÃ¼ckruf...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                                <div class="border-b p-4 flex items-center space-x-3">
                                    <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                    <div>
                                        <p class="font-semibold text-gray-800">HQ Team</p>
                                        <p class="text-xs text-green-500">â— Online</p>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto p-4">
                                    <div class="space-y-4">
                                        <div class="chat-message received">
                                            <p class="text-sm">Hey! Die neuen Marketing-Materialien sind online ðŸŽ‰</p>
                                            <p class="text-xs text-gray-500 mt-1">10:23</p>
                                        </div>

                                        <div class="chat-message sent">
                                            <p class="text-sm">Super, danke! Schaue ich mir gleich an.</p>
                                            <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                        </div>

                                        <div class="chat-message received">
                                            <p class="text-sm">Die Schulung am 22.02. - habt ihr euch schon angemeldet?</p>
                                            <p class="text-xs text-gray-500 mt-1">10:30</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t p-4">
                                    <div class="flex space-x-2">
                                        <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                        <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                            Senden
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Section (hidden by default) -->
                    <div id="forumSection" class="view-hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6 mb-4">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema</button>
                                </div>

                                <div class="space-y-4">
                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Marketing&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">FrÃ¼hjahrs-Kampagne 2026 ist live!</h3>
                                                    <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Die Materialien sind jetzt verfÃ¼gbar! WÃ¼rde mich Ã¼ber euer Feedback freuen...
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 8 Antworten</span>
                                                    <span>ðŸ‘ï¸ 42 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                    <span class="text-xs text-gray-500">gestern</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Wie integriert ihr die 3D-Vermessung in den Beratungsprozess?
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 12 Antworten</span>
                                                    <span>ðŸ‘ï¸ 67 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="vit-card p-6 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                    <div class="space-y-2">
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="chatView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_chat">CHAT</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                            <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                            
                            <div class="space-y-2">
                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Markus Unger</p>
                                        <p class="text-xs text-gray-500 truncate">Super, danke fÃ¼r die Info!</p>
                                    </div>
                                    <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Stefan Meyer</p>
                                        <p class="text-xs text-gray-500 truncate">Kannst du mir das Dokument...</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Julia Fischer</p>
                                        <p class="text-xs text-gray-500 truncate">Gerne! Schicke ich dir gleich</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Team+HQ&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Team HQ</p>
                                        <p class="text-xs text-gray-500 truncate">Neue Schulung nÃ¤chste Woche</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                            <div class="border-b p-4 flex items-center space-x-3">
                                <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-semibold text-gray-800">Markus Unger</p>
                                    <p class="text-xs text-green-500">â— Online</p>
                                </div>
                            </div>

                            <div class="flex-1 overflow-y-auto p-4">
                                <div class="space-y-4">
                                    <div class="chat-message received">
                                        <p class="text-sm">Hey! Hast du schon die neuen Marketing-Materialien gesehen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:23</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Ja, sehen super aus! Vor allem die neue FrÃ¼hjahrs-Kampagne.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Freut mich! Kannst du die gleich bei euch im Laden einsetzen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:26</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Auf jeden Fall! Wir planen das ab nÃ¤chster Woche.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:28</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Super, danke fÃ¼r die Info! ðŸ‘</p>
                                        <p class="text-xs text-gray-500 mt-1">10:30</p>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t p-4">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other views placeholders -->

                <div id="todosView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_todos">TODOS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Todo-Liste wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="financesView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">FILIAL-PERFORMANCE COCKPIT</h1>
                    
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-sm text-gray-500">Unternehmen / Standort: <strong>vit:bikes Grafrath</strong></p>
                            <p class="text-sm text-gray-500">Jahr: <strong>2026</strong></p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm">2026</button>
                            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">2026-01</button>
                        </div>
                    </div>

                    <!-- Top KPI Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <!-- Umsatz -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz</p>
                            <p class="text-3xl font-bold text-gray-800">55 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag</p>
                            <p class="text-3xl font-bold text-gray-800">21 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag Marge % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag Marge %</p>
                            <p class="text-3xl font-bold text-gray-800">38,88%</p>
                        </div>

                        <!-- Gesamtkosten -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Gesamtkosten</p>
                            <p class="text-3xl font-bold text-gray-800">25 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT</p>
                            <p class="text-3xl font-bold text-red-600">-4 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT-Marge % -->
                        <div class="vit-card p-6 bg-red-50">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT-Marge %</p>
                            <p class="text-3xl font-bold text-red-600">-7,16%</p>
                        </div>

                        <!-- Kostenquote % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Kostenquote %</p>
                            <p class="text-3xl font-bold text-gray-800">46,13%</p>
                        </div>

                        <!-- Umsatz YoY % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz YoY %</p>
                            <p class="text-3xl font-bold text-green-600">78,54%</p>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Umsatz vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ VS PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-32 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                55k
                                            </div>
                                            <div class="bg-gray-300 h-24 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                40k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Umsatz</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rohertrag vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">ROHERTRAG VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-28 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                21k
                                            </div>
                                            <div class="bg-gray-300 h-20 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                18k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Rohertrag</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EBIT vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">EBIT VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end justify-center space-x-4 h-32">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-vit-orange w-16 h-16 rounded flex items-center justify-center text-white text-xs font-semibold">
                                            -4k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">EBIT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-gray-300 w-16 h-24 rounded flex items-center justify-center text-gray-700 text-xs font-semibold">
                                            -7k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">Plan</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YTD Metrics -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">Umsatz YTD vs VJ%</p>
                            <p class="text-4xl font-bold text-green-600">â†‘ 78,5%</p>
                        </div>

                        <div class="vit-card p-6 bg-red-50 border border-red-200">
                            <p class="text-sm text-gray-600 mb-2">Kosten YTD vs VJ %</p>
                            <p class="text-4xl font-bold text-red-600">â†‘ 62,0%</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">EBIT-Marge Î” (%-Pkt.)</p>
                            <p class="text-4xl font-bold text-green-600">4,3 pp</p>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Kostenstruktur Pie Chart -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTENSTRUKTUR (% DER GESAMTKOSTEN)</h2>
                            <div class="flex items-center justify-center">
                                <div class="relative w-48 h-48">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <!-- Personalkosten 53% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#EF7D00" stroke-width="80" stroke-dasharray="167 335" stroke-dashoffset="0"></circle>
                                        <!-- Werbe-/Reisekosten 17% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#F59E0B" stroke-width="80" stroke-dasharray="54 335" stroke-dashoffset="-167"></circle>
                                        <!-- Raummieten 8% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FCD34D" stroke-width="80" stroke-dasharray="25 335" stroke-dashoffset="-221"></circle>
                                        <!-- Sonstige 22% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FEF3C7" stroke-width="80" stroke-dasharray="69 335" stroke-dashoffset="-246"></circle>
                                    </svg>
                                </div>
                                <div class="ml-6 space-y-2 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-vit-orange rounded"></div>
                                        <span>Personalkosten</span>
                                        <span class="font-semibold">53%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-500 rounded"></div>
                                        <span>Werbe-/Reisekosten</span>
                                        <span class="font-semibold">17%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-300 rounded"></div>
                                        <span>Raummieten</span>
                                        <span class="font-semibold">8%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-100 rounded"></div>
                                        <span>Sonstige</span>
                                        <span class="font-semibold">22%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kosten vs Plan Trend -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTEN VS PLAN - TREND</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Personalkosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-12 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">25% / 32%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Raummieten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-8 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">8% / 10%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Werbe-/Reisekosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-4 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-6 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">4% / 7%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Sonstige</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-10 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-14 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">10% / 13%</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs pt-2 border-t">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Kosten Anteil am Umsatz %</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Kosten Anteil am Plan-Umsatz %</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Benchmarking -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">ABWEICHUNG ROHERTRAGSMARGE ZUM STANDORT-BENCHMARK (%-PKT.)</h2>
                            <p class="text-5xl font-bold text-green-600">29,6 pp</p>
                            <p class="text-sm text-gray-600 mt-2">Ãœberdurchschnittliche Leistung</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">BENCHMARK IM VERGLEICH ZUR UMSATZKLASSE</h2>
                            <p class="text-5xl font-bold text-green-600">â†‘ 107,7%</p>
                            <p class="text-sm text-gray-600 mt-2">Weit Ã¼ber dem Durchschnitt der Umsatzklasse</p>
                        </div>
                    </div>

                    <!-- Marketing -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ZU UMSATZ (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">4%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ANTEIL AN GESAMTKOSTEN (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">8%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN STANDORT (â‚¬)</h2>
                            <p class="text-4xl font-bold text-vit-orange">2.039,00 â‚¬</p>
                        </div>
                    </div>
                </div>
                <div id="teamView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">TEAM</h1>
                    
                    <!-- Team Ãœbersicht -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Mitarbeiter</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">8</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                5 Vollzeit, 3 Teilzeit
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Ã˜ Zufriedenheit</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">4.6/5</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Letzte Team-Umfrage
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Krankheitstage</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">12</p>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Dieses Quartal
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Schulungen</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">23</p>
                                </div>
                                <div class="bg-vit-orange bg-opacity-10 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-vit-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Abgeschlossen 2026
                            </div>
                        </div>
                    </div>

                    <!-- Mitarbeiter Liste -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MITARBEITER</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Thomas Schmidt</h3>
                                            <p class="text-sm text-gray-500">Verkaufsleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">32 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Sarah+Mueller&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Sarah MÃ¼ller</h3>
                                            <p class="text-sm text-gray-500">Verkauf & Beratung</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">28 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Michael+Weber&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Michael Weber</h3>
                                            <p class="text-sm text-gray-500">Werkstattleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">98% Auslastung</p>
                                        <p class="text-xs text-gray-500">Werkstatt</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Lisa+Klein&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Lisa Klein</h3>
                                            <p class="text-sm text-gray-500">Zweiradmechatronikerin</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">142 AuftrÃ¤ge</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Jan+Hoffmann&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Jan Hoffmann</h3>
                                            <p class="text-sm text-gray-500">Verkauf (Teilzeit)</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">15 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schichtplan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">SCHICHTPLAN DIESE WOCHE</h2>
                            <div class="space-y-2">
                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Montag, 10.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Dienstag, 11.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Mittwoch, 12.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Donnerstag, 13.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-vit-orange">Freitag, 14.02. (Heute)</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange text-white px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Samstag, 15.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-16h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (9-16h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (9-16h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (9-16h)</span>
                                    </div>
                                </div>
                            </div>

                            <button class="mt-4 w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90 text-sm">
                                Schichtplan bearbeiten
                            </button>
                        </div>
                    </div>

                    <!-- Anstehende Schulungen -->
                    <div class="vit-card p-6">
                        <h2 class="h2-headline text-gray-800 mb-4">ANSTEHENDE SCHULUNGEN</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-vit-orange bg-opacity-5 border border-vit-orange rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">E-Bike Antriebstechnik 2026</h4>
                                <p class="text-sm text-gray-600 mb-3">Bosch & Shimano Updates</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 22.02.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 3 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Verkaufstraining Premium</h4>
                                <p class="text-sm text-gray-600 mb-3">Hochpreisige RÃ¤der verkaufen</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 05.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 4 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Kundenservice Excellence</h4>
                                <p class="text-sm text-gray-600 mb-3">Kundenzufriedenheit steigern</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 12.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ Alle</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="partnersView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">STANDORTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Partner-Ãœbersicht wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="analyticsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">ANALYTICS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Analytics-Dashboard wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="documentsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">DOKUMENTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Dokumentenverwaltung wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="knowledgeView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">INFOS (WISSEN)</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Produkt-HandbÃ¼cher</h3>
                            <p class="text-sm text-gray-600 mb-4">Technische Dokumentation aller E-Bike Hersteller</p>
                            <span class="text-xs text-gray-500">142 Dokumente</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-blue-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Schulungsvideos</h3>
                            <p class="text-sm text-gray-600 mb-4">Video-Tutorials zu Verkauf, Service und Technik</p>
                            <span class="text-xs text-gray-500">67 Videos</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-green-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-green-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">FAQ</h3>
                            <p class="text-sm text-gray-600 mb-4">HÃ¤ufig gestellte Fragen zu allen Themen</p>
                            <span class="text-xs text-gray-500">89 EintrÃ¤ge</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-purple-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-purple-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Werkstatt-Guides</h3>
                            <p class="text-sm text-gray-600 mb-4">Reparatur-Anleitungen und Wartungs-Tipps</p>
                            <span class="text-xs text-gray-500">54 Guides</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer premium-feature">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">vit:bikes Akademie</h3>
                            <p class="text-sm text-gray-600 mb-4">Exklusive Schulungen fÃ¼r Partner</p>
                            <span class="premium-badge text-[8px] px-2 py-1">PREMIUM</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-yellow-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-yellow-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Vorlagen & Checklisten</h3>
                            <p class="text-sm text-gray-600 mb-4">Beratungs-Checklisten, VerkaufsleitfÃ¤den</p>
                            <span class="text-xs text-gray-500">28 Vorlagen</span>
                        </div>
                    </div>
                </div>

                <!-- ===== WISSEN (Zentrale Wissensdatenbank) ===== -->
                <div id="wissenView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ“š WISSENSDATENBANK</h1>
                            <p class="text-sm text-gray-500">Alle Schulungen, Handbuecher, Best Practices und FAQs an einem Ort.</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="wissenSearch" placeholder="Suchen..." oninput="filterWissenGlobal()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm w-48">
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="wissenKpis"></div>

                    <!-- Bereich-Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterWissenBereich('all')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-wbf="all">ðŸ“š Alle Bereiche</button>
                        <button onclick="filterWissenBereich('allgemein')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="allgemein">ðŸ¢ Allgemein</button>
                        <button onclick="filterWissenBereich('verkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="verkauf">ðŸ’° Verkauf</button>
                        <button onclick="filterWissenBereich('einkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="einkauf">ðŸ›’ Einkauf</button>
                        <button onclick="filterWissenBereich('marketing')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="marketing">ðŸ“£ Marketing</button>
                        <button onclick="filterWissenBereich('controlling')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="controlling">ðŸ“Š Controlling</button>
                    </div>

                    <!-- Typ-Tabs -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button onclick="switchWissenTyp('akademie')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-wtt="akademie">ðŸŽ“ Akademie</button>
                            <button onclick="switchWissenTyp('handbuecher')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="handbuecher">ðŸ“– Handbuecher</button>
                            <button onclick="switchWissenTyp('bestpractices')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="bestpractices">ðŸ’¡ Best Practices</button>
                            <button onclick="switchWissenTyp('faq')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="faq">â“ FAQ</button>
                        </nav>
                    </div>

                    <!-- Content -->
                    <div id="wissenGlobalContent" class="space-y-3"></div>
                </div>

                <!-- ===== WERBEMITTEL-SHOP ===== -->
                <div id="shopView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ›ï¸ WERBEMITTEL-SHOP</h1>
                            <p class="text-sm text-gray-500">Offizielle vit:bikes Werbemittel fuer deinen Standort bestellen.</p>
                        </div>
                        <button onclick="document.getElementById('shopCart').classList.toggle('hidden')" class="relative bg-vit-orange text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90">
                            ðŸ›’ Warenkorb <span id="shopCartCount" class="ml-1 bg-white text-vit-orange rounded-full px-1.5 text-xs font-bold">0</span>
                        </button>
                    </div>

                    <!-- Cart Overlay -->
                    <div id="shopCart" class="hidden mb-6 vit-card p-5 border-2 border-vit-orange">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ›’ Dein Warenkorb</h3>
                        <div id="shopCartItems" class="space-y-2 mb-4"></div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                            <span class="font-bold text-gray-800">Gesamt: <span id="shopCartTotal">0,00</span> â‚¬</span>
                            <button onclick="submitShopOrder()" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">Bestellen</button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterShop('all')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-sf="all">Alle</button>
                        <button onclick="filterShop('print')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="print">ðŸ–¨ï¸ Drucksachen</button>
                        <button onclick="filterShop('textil')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="textil">ðŸ‘• Textilien</button>
                        <button onclick="filterShop('display')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="display">ðŸª Displays</button>
                        <button onclick="filterShop('digital')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="digital">ðŸ’» Digital</button>
                        <button onclick="filterShop('give')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="give">ðŸŽ Giveaways</button>
                    </div>

                    <!-- Product Grid -->
                    <div id="shopGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>

                    <!-- Order Confirmation Modal -->
                    <div id="shopOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
                            <div class="text-5xl mb-4">âœ…</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Bestellung eingegangen!</h3>
                            <p class="text-sm text-gray-500 mb-2">Deine Bestellung wird bearbeitet und an deinen Standort geliefert.</p>
                            <p class="text-xs text-gray-400 mb-6">Bestell-Nr.: VB-<span id="shopOrderNr"></span></p>
                            <button onclick="document.getElementById('shopOrderModal').classList.add('hidden')" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">OK</button>
                        </div>
                    </div>
                </div>

                <div id="onboardingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_onboarding">ONBOARDING</h1>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 mb-4">Willkommen bei vit:bikes! Hier findest du alle Aufgaben fÃ¼r deinen erfolgreichen Start.</p>
                    </div>

                    <!-- Asana Project Container (wird dynamisch gefÃ¼llt) -->
                    <div id="asanaOnboardingContent">
                        <!-- Wird via JavaScript befÃ¼llt -->
                    </div>

                    <!-- Static Content als Fallback -->
                    <div id="staticOnboardingContent">
                    <!-- Asana Project wird hier angezeigt -->
                    <div class="vit-card p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="h2-headline text-gray-800">Dein Onboarding-Plan</h2>
                            <button class="text-sm text-vit-orange hover:underline font-semibold">In Asana Ã¶ffnen â†’</button>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6">Arbeite dich durch diese Aufgaben, um optimal vorbereitet zu sein!</p>

                        <!-- Onboarding Fortschritt -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">Gesamt-Fortschritt</span>
                                <span class="text-sm font-semibold text-vit-orange">65%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-vit-orange h-3 rounded-full" style="width: 65%"></div>
                            </div>
                        </div>

                        <!-- Section: Erste Schritte -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">âœ“</span>
                                Erste Schritte
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Portalzugang einrichten</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Willkommensvideo ansehen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Team-Mitglieder einladen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Produkt-Schulung -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-vit-orange text-white rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2/4</span>
                                Produkt-Schulung
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">E-Bike Grundlagen Kurs absolvieren</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                    <input type="checkbox" checked disabled class="w-4 h-4">
                                    <span class="text-sm text-gray-700 line-through">Marken-Portfolio kennenlernen</span>
                                    <span class="ml-auto text-xs text-gray-500">âœ“ Erledigt</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-white border-2 border-vit-orange rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700 font-semibold">3D-Vermessungs-System Training</span>
                                    <span class="ml-auto px-2 py-1 bg-vit-orange text-white text-xs rounded">In Arbeit</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Werkstatt-Prozesse verstehen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 20.02.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Verkaufsprozesse -->
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-gray-300 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">0/5</span>
                                Verkaufsprozesse
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">CRM-System einrichten</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 18.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">BeratungsgesprÃ¤ch-Training</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 22.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Finanzierungs- & Leasing-Optionen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 25.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Probefahrt-Prozess durchfÃ¼hren</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 28.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Ersten Verkauf abschlieÃŸen ðŸŽ¯</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 03.03.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Marketing & Kommunikation -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <span class="bg-gray-300 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">0/3</span>
                                Marketing & Kommunikation
                            </h3>
                            <div class="space-y-2 ml-8">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Social Media Guidelines durchgehen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 19.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Ersten Social Media Post erstellen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 24.02.</span>
                                </div>
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <input type="checkbox" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Marketing-Materialien herunterladen</span>
                                    <span class="ml-auto text-xs text-gray-500">FÃ¤llig: 26.02.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hilfe & Support -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">ðŸ“ž Brauchst du Hilfe?</h3>
                            <p class="text-sm text-gray-600 mb-4">Unser Onboarding-Team steht dir zur VerfÃ¼gung!</p>
                            <button class="w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90">
                                Support kontaktieren
                            </button>
                        </div>

                        <div class="vit-card p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">ðŸ“š Weitere Ressourcen</h3>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ Handbuch fÃ¼r neue Partner</a></li>
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ Video-Tutorials</a></li>
                                <li><a href="#" class="text-vit-orange hover:underline">â†’ FAQ fÃ¼r Einsteiger</a></li>
                            </ul>
                        </div>
                    </div>
                    </div><!-- End staticOnboardingContent -->
                </div>

                <!-- MITARBEITER VIEW (Partner/GF) -->
                <div id="mitarbeiterView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ‘¥ MITARBEITER</h1>
                    <p class="text-sm text-gray-500 mb-6">Mitarbeiter Ihres Standorts verwalten und Rollen zuweisen.</p>

                    <!-- KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-gray-800" id="pMaGesamt">0</div><div class="text-xs text-gray-500">Mitarbeiter</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="pMaAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600" id="pMaOnb">0</div><div class="text-xs text-gray-500">Im Onboarding</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="pMaRollen">4</div><div class="text-xs text-gray-500">Rollen verfÃ¼gbar</div></div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex space-x-2">
                            <button onclick="filterPartnerMa('all')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-pmf="all">Alle</button>
                            <button onclick="filterPartnerMa('aktiv')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="aktiv">ðŸŸ¢ Aktiv</button>
                            <button onclick="filterPartnerMa('demo')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="demo">ðŸ”´ Demo</button>
                            <button onclick="filterPartnerMa('onboarding')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="onboarding">ðŸ”µ Onboarding</button>
                        </div>
                        <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                    </div>

                    <!-- Mitarbeiter Table -->
                    <div class="vit-card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600">E-Mail</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Rollen</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Eintritt</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="partnerMaBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="notificationsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">BENACHRICHTIGUNGEN</h1>

                    <!-- Filter -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterNotif('all')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-nf="all">Alle</button>
                        <button onclick="filterNotif('unread')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="unread">Ungelesen</button>
                        <button onclick="filterNotif('system')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="system">System</button>
                        <button onclick="filterNotif('hq')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="hq">HQ</button>
                        <button class="ml-auto text-xs text-vit-orange font-semibold hover:underline" onclick="document.querySelectorAll('.notif-dot').forEach(function(d){d.remove();}); document.querySelector('.absolute.-top-1.-right-1').textContent='0';">Alle als gelesen markieren</button>
                    </div>

                    <div id="notifList" class="space-y-2"></div>
                </div>

                <!-- ===== KALENDER VIEW ===== -->
                <div id="kalenderView" class="view" style="display: none;">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5 gap-3">
                        <h1 class="h1-headline text-gray-800">KALENDER</h1>
                        <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                            <select id="kalFilterUser" onchange="kalRenderActive()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <option value="all">Alle Termine (Standort)</option>
                                <option value="me">Nur meine Termine</option>
                            </select>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 whitespace-nowrap" onclick="openKalDayModal(new Date().toISOString().slice(0,10))">+ Neuer Termin</button>
                        </div>
                    </div>

                    <!-- View Toggle + Navigation -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-1">
                            <button onclick="kalNav(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <button onclick="kalGoToday()" class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-700">Heute</button>
                            <button onclick="kalNav(1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                            <h2 class="text-lg font-bold text-gray-800 ml-2" id="kalNavTitle">Februar 2026</h2>
                        </div>
                        <div class="flex bg-gray-100 rounded-lg p-0.5">
                            <button onclick="switchKalView('month')" id="kalViewBtnMonth" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-white text-gray-800 shadow-sm">Monat</button>
                            <button onclick="switchKalView('week')" id="kalViewBtnWeek" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500">Woche</button>
                            <button onclick="switchKalView('day')" id="kalViewBtnDay" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500">Tag</button>
                        </div>
                    </div>

                    <!-- ===== MONTH VIEW ===== -->
                    <div id="kalMonthContainer">
                        <div class="vit-card overflow-hidden">
                            <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Mo</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Di</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Mi</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Do</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Fr</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">Sa</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">So</div>
                            </div>
                            <div id="kalGrid" class="grid grid-cols-7"></div>
                        </div>
                        <h3 class="font-bold text-gray-800 mt-6 mb-3">Anstehende Termine</h3>
                        <div id="kalUpcoming" class="space-y-2"></div>
                    </div>

                    <!-- ===== WEEK VIEW ===== -->
                    <div id="kalWeekContainer" style="display:none;">
                        <!-- GanztÃ¤gig row -->
                        <div id="kalWeekAllDay" class="vit-card mb-2 p-0 overflow-hidden" style="display:none;">
                            <div class="grid grid-cols-8 text-xs">
                                <div class="p-2 bg-gray-50 border-r border-b border-gray-200 text-gray-400 font-semibold text-center">GanztÃ¤gig</div>
                                <div id="kalWeekAllDay0" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay1" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay2" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay3" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay4" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay5" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay6" class="p-1.5 border-b border-gray-100 min-h-[32px]"></div>
                            </div>
                        </div>
                        <!-- Week time grid -->
                        <div class="vit-card overflow-hidden">
                            <!-- Day headers -->
                            <div class="grid grid-cols-8 bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                <div class="py-2 text-center text-[10px] font-semibold text-gray-400">Uhrzeit</div>
                                <div id="kalWeekHead0" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead1" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead2" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead3" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead4" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead5" class="py-2 text-center text-xs font-semibold text-gray-600 text-orange-400"></div>
                                <div id="kalWeekHead6" class="py-2 text-center text-xs font-semibold text-gray-600 text-orange-400"></div>
                            </div>
                            <!-- Scrollable time grid -->
                            <div id="kalWeekGrid" class="overflow-y-auto" style="max-height:calc(100vh - 320px); min-height:500px;"></div>
                        </div>
                    </div>

                    <!-- ===== DAY VIEW ===== -->
                    <div id="kalDayContainer" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Day timeline (left 2/3) -->
                            <div class="lg:col-span-2">
                                <!-- GanztÃ¤gig -->
                                <div id="kalDayAllDay" class="vit-card mb-3 p-3" style="display:none;">
                                    <p class="text-[10px] text-gray-400 font-semibold uppercase mb-1">GanztÃ¤gig</p>
                                    <div id="kalDayAllDayList" class="space-y-1"></div>
                                </div>
                                <!-- Hour grid -->
                                <div class="vit-card overflow-hidden">
                                    <div id="kalDayGrid" class="overflow-y-auto" style="max-height:calc(100vh - 320px); min-height:500px;"></div>
                                </div>
                            </div>
                            <!-- Day sidebar (right 1/3) -->
                            <div>
                                <div class="vit-card p-5 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-3" id="kalDaySideTitle">Termine am Tag</h3>
                                    <div id="kalDaySideList" class="space-y-2"></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h3 class="font-semibold text-gray-800 mb-3">Zusammenfassung</h3>
                                    <div id="kalDayStats" class="space-y-2 text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Termin Modal (New + Edit) -->
                    <div id="kalNewModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
                            <h3 id="kalModalTitle" class="font-bold text-gray-800 text-lg mb-4">Neuen Termin anlegen</h3>
                            <div class="space-y-3">
                                <input type="text" id="kalNewTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="date" id="kalNewDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="kalNewGanztaegig" onchange="document.getElementById('kalTimeFields').style.display=this.checked?'none':''">
                                        <label for="kalNewGanztaegig" class="text-xs text-gray-600">GanztÃ¤gig</label>
                                    </div>
                                </div>
                                <div id="kalTimeFields" class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] text-gray-500">Von</label><input type="time" id="kalNewTime" value="09:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <div><label class="text-[10px] text-gray-500">Bis</label><input type="time" id="kalNewEndTime" value="10:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                </div>
                                <input type="text" id="kalNewOrt" placeholder="Ort (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <select id="kalNewType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <option value="beratung">Beratung</option>
                                    <option value="probefahrt">Probefahrt</option>
                                    <option value="werkstatt">Werkstatt-Abholung</option>
                                    <option value="meeting">Team-Meeting</option>
                                    <option value="schulung">Schulung</option>
                                    <option value="event">Event</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="sonstig">Sonstiges</option>
                                </select>
                                <!-- Wiederholung -->
                                <div>
                                    <label class="text-[10px] text-gray-500 font-semibold">Wiederholung</label>
                                    <select id="kalNewRepeat" onchange="kalToggleRepeatEnd()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="">Keine Wiederholung</option>
                                        <option value="taeglich">TÃ¤glich</option>
                                        <option value="woechentlich">WÃ¶chentlich</option>
                                        <option value="2wochen">Alle 2 Wochen</option>
                                        <option value="monatlich">Monatlich</option>
                                    </select>
                                    <div id="kalRepeatEndRow" class="mt-2 flex items-center space-x-2" style="display:none;">
                                        <label class="text-[10px] text-gray-500 whitespace-nowrap">Bis</label>
                                        <input type="date" id="kalNewRepeatEnd" onchange="kalUpdateRepeatInfo()" class="flex-1 px-3 py-1.5 border border-gray-200 rounded-lg text-sm">
                                        <span class="text-[10px] text-gray-400" id="kalRepeatInfo"></span>
                                    </div>
                                </div>
                                <!-- Teilnehmer -->
                                <div>
                                    <label class="text-[10px] text-gray-500 font-semibold">Teilnehmer</label>
                                    <div id="kalTeilnehmerList" class="flex flex-wrap gap-1 mb-1.5"></div>
                                    <select id="kalNewTeilnehmer" onchange="kalAddTeilnehmer()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="">+ Teilnehmer hinzufÃ¼gen...</option>
                                    </select>
                                </div>
                                <textarea id="kalNewNotes" placeholder="Notizen (optional)" rows="2" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button id="kalSaveBtn" onclick="saveKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                <button onclick="document.getElementById('kalNewModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                <button id="kalDeleteBtn" onclick="deleteKalTermin()" style="display:none" class="py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-100 border border-red-200">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== TODO VIEW ===== -->
                <div id="todoView" class="view" style="display: none;">
                    <div class="flex h-[calc(100vh-100px)] min-h-[600px] overflow-hidden">

<!-- CENTER: Main Content -->
                        <div class="flex-1 flex flex-col min-w-0">
                            <!-- Header -->
                            <div class="flex-shrink-0 border-b border-gray-200 bg-white px-5 py-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="font-bold text-gray-900 text-lg" id="todoHeaderTitle">Alle Aufgaben</h1>
                                        <p class="text-gray-400 text-[11px]" id="todoHeaderSub">0 offen Â· 0 heute Â· 0 Ã¼berfÃ¤llig</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="todoCreateNew()" class="flex items-center space-x-1 px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:opacity-90"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg><span>Neue Aufgabe</span></button>
                                        <div class="relative">
                                            <svg class="w-3.5 h-3.5 absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                            <input type="text" id="todoSearchInput" placeholder="Suchen..." class="pl-7 pr-3 py-1 border border-gray-200 rounded-lg bg-gray-50 text-xs focus:outline-none focus:border-vit-orange" style="width:160px" oninput="todoSearchChanged()">
                                        </div>
                                        <div class="flex bg-gray-100 rounded-lg p-0.5">
                                            <button onclick="todoSetView('list')" id="todoViewListBtn" class="px-2 py-1 rounded-md text-[11px] bg-white text-gray-900 shadow-sm">â˜° Liste</button>
                                            <button onclick="todoSetView('board')" id="todoViewBoardBtn" class="px-2 py-1 rounded-md text-[11px] text-gray-500 hover:text-gray-700">â–¦ Board</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI Bar -->
                            <div class="flex-shrink-0 px-5 py-2 bg-white border-b border-gray-100">
                                <div class="flex space-x-2">
                                    <button onclick="todoSetFilter('all')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="all">
                                        <span class="font-bold text-xl text-gray-800" id="kpiOpen2">0</span><span class="text-gray-500 text-[11px]">Offen</span>
                                    </button>
                                    <button onclick="todoSetFilter('heute')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="heute">
                                        <span class="font-bold text-xl text-vit-orange" id="kpiToday2">0</span><span class="text-gray-500 text-[11px]">Heute</span>
                                    </button>
                                    <button onclick="todoSetFilter('ueberfaellig')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="ueberfaellig">
                                        <span class="font-bold text-xl text-red-500" id="kpiOverdue2">0</span><span class="text-gray-500 text-[11px]">ÃœberfÃ¤llig</span>
                                    </button>
                                    <button onclick="todoSetFilter('done')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="done">
                                        <span class="font-bold text-xl text-green-600" id="kpiDone2">0</span><span class="text-gray-500 text-[11px]">Erledigt</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Content: List or Board + Detail Panel -->
                            <div class="flex-1 flex overflow-hidden">
                                <div class="flex-1 overflow-y-auto px-5 py-3" id="todoMainContent">
                                    <!-- Tasks -->
                                    <div id="todoListArea"></div>
                                </div>
                                <!-- Detail Panel (hidden by default) -->
                                <div id="todoDetailPanel" class="hidden flex-shrink-0 border-l border-gray-200 bg-white flex flex-col overflow-hidden" style="width:380px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== ALLGEMEIN VIEW ===== -->
                <div id="allgemeinView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                
                        <div class="mb-6">
                            <p class="h2-headline text-vit-gray mb-1">MEIN STANDORT</p>
                            <h1 class="h1-headline">Allgemein</h1>
                        </div>
                
                        <!-- Tab Navigation -->
                        <div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1 overflow-x-auto" id="allgemeinTabs">
                            <button onclick="showAllgemeinTab('uebersicht')" id="allgemeinTab-uebersicht" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition bg-white text-vit-orange shadow-sm">Ãœbersicht</button>
                            <button onclick="showAllgemeinTab('jahresziele')" id="allgemeinTab-jahresziele" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸŽ¯ Jahresziele</button>
                            <button onclick="showAllgemeinTab('monatsplan')" id="allgemeinTab-monatsplan" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸ“… Monatsplan</button>
                            <button onclick="showAllgemeinTab('journal')" id="allgemeinTab-journal" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸ“ Partner-Journal</button>
                            <button onclick="showAllgemeinTab('strategie')" id="allgemeinTab-strategie" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">Strategie</button>
                            <button onclick="showAllgemeinTab('wissen')" id="allgemeinTab-wissen" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">Wissen</button>
                        </div>
                
                        <!-- TAB: Ãœbersicht -->
                        <div id="allgemeinTabContent-uebersicht">
                            <!-- Stimmung -->
                            <div class="vit-card p-5 mb-6">
                                <div class="flex items-center justify-between">
                                    <div><h3 class="font-bold text-gray-800 mb-1">Wie lÃ¤uft der Monat?</h3><p class="text-sm text-gray-500">Setze dein Stimmungsbild</p></div>
                                    <div class="flex space-x-2" id="stimmungSelector">
                                        <button onclick="setStimmung('positiv')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="positiv">ðŸ˜Š</button>
                                        <button onclick="setStimmung('neutral')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="neutral">ðŸ˜</button>
                                        <button onclick="setStimmung('besorgt')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="besorgt">ðŸ˜Ÿ</button>
                                        <button onclick="setStimmung('kritisch')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="kritisch">ðŸ˜¤</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Dashboard -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                <div class="vit-card p-5 md:col-span-2 lg:col-span-2 border-l-4 border-vit-orange">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ“… Aktueller Monatsfokus</h3><span class="text-xs font-semibold px-2 py-1 rounded-full bg-orange-100 text-vit-orange" id="uebersichtAktuellerMonat"></span></div>
                                    <div id="uebersichtMonatsfokus"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h3 class="font-bold text-gray-800 mb-3">ðŸ“ž NÃ¤chstes HQ-Meeting</h3>
                                    <div id="uebersichtNaechstesMeeting"><p class="text-gray-400 text-sm">Kein Termin</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸŽ¯ Jahresziele</h3><button onclick="showAllgemeinTab('jahresziele')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button></div>
                                    <div id="uebersichtJahresziele"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">âš¡ Offene MaÃŸnahmen</h3><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="uebersichtMassnahmenBadge">0</span></div>
                                    <div id="uebersichtMassnahmen"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ“ Letztes GesprÃ¤ch</h3><button onclick="showAllgemeinTab('journal')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button></div>
                                    <div id="uebersichtLetztesJournal"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                            </div>
                            <!-- Quick Actions -->
                            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onclick="showAllgemeinTab('jahresziele');setTimeout(openJahreszielModal,100)" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸŽ¯</p><p class="text-xs font-semibold text-gray-700">Neues Ziel</p></button>
                                <button onclick="showAllgemeinTab('monatsplan')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“…</p><p class="text-xs font-semibold text-gray-700">Monatsplan</p></button>
                                <button onclick="showAllgemeinTab('journal');setTimeout(openJournalModal,100)" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“</p><p class="text-xs font-semibold text-gray-700">GesprÃ¤ch protokollieren</p></button>
                                <button onclick="showView('controlling')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“Š</p><p class="text-xs font-semibold text-gray-700">BWA & Controlling</p></button>
                            </div>
                        </div>
                
                        <!-- TAB: Jahresziele -->
                        <div id="allgemeinTabContent-jahresziele" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Jahresziele <span id="jahreszieleJahr"></span></h2><p class="text-sm text-gray-500">SMART-Ziele, Soft Targets und Umsatzziele</p></div>
                                <button onclick="openJahreszielModal()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">+ Neues Ziel</button>
                            </div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-vit-orange"></span><span>Harte Ziele (Umsatz & Ertrag)</span></h3><div id="jahreszieleHart" class="space-y-3"></div></div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span>SMART Ziele</span></h3><div id="jahreszieleSmart" class="space-y-3"></div></div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-green-500"></span><span>Soft Targets</span></h3><div id="jahreszieleSoft" class="space-y-2"></div></div>
                        </div>
                
                        <!-- TAB: Monatsplan -->
                        <div id="allgemeinTabContent-monatsplan" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Monatsplan <span id="monatsplanJahr"></span></h2><p class="text-sm text-gray-500">12 Monate â€“ 12 Fokusthemen</p></div>
                            </div>
                            <div id="monatsplanContent" class="space-y-3"></div>
                            <!-- Inline Detail Panel -->
                            <div id="monatsDetailPanel" class="mt-6" style="display:none">
                                <div class="vit-card p-6 border-l-4 border-vit-orange">
                                    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-800" id="monatsDetailTitel"></h3><button onclick="closeMonatsDetail()" class="text-gray-400 hover:text-gray-600 text-lg">âœ•</button></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Fokus-Thema</label><input id="monatsDetailFokus" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Fokus-Thema..."></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Beschreibung</label><textarea id="monatsDetailBeschreibung" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Details..."></textarea></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">MaÃŸnahmen</label><div id="monatsDetailMassnahmen" class="space-y-2 mb-2"></div><button onclick="addMonatsMassnahme()" class="text-sm text-vit-orange hover:text-orange-600 font-semibold">+ MaÃŸnahme</button></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Zahlt ein auf Jahresziel</label><div id="monatsDetailZiele" class="space-y-1"></div></div>
                                    <div class="mb-4" id="monatsDetailReflexionWrap" style="display:none"><label class="block text-sm font-semibold text-gray-700 mb-1">Monats-Reflexion</label><textarea id="monatsDetailReflexion" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Was lief gut?"></textarea></div>
                                    <div class="flex justify-end space-x-3 mt-4 pt-4 border-t"><button onclick="closeMonatsDetail()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveMonatsDetail()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- TAB: Journal -->
                        <div id="allgemeinTabContent-journal" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Partner-Journal</h2><p class="text-sm text-gray-500">Protokolle der PartnergesprÃ¤che</p></div>
                                <button onclick="openJournalModal()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">+ Neues GesprÃ¤ch</button>
                            </div>
                            <div id="journalContent" class="space-y-4"></div>
                        </div>
                
                        <!-- TAB: Strategie -->
                        <div id="allgemeinTabContent-strategie" style="display:none">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="vit-card p-5 border-l-4 border-vit-orange"><h3 class="font-bold text-gray-800 mb-2">ðŸ“… Dein Monatsplan</h3><p class="text-sm text-gray-500 mb-3">12 Fokusthemen fÃ¼r dieses Jahr</p><button onclick="showAllgemeinTab('monatsplan')" class="text-sm text-vit-orange font-semibold">Ã–ffnen â†’</button></div>
                                <div class="vit-card p-5 border-l-4 border-blue-500"><h3 class="font-bold text-gray-800 mb-2">ðŸŽ¯ Deine Jahresziele</h3><p class="text-sm text-gray-500 mb-3">SMART-Ziele und Soft Targets</p><button onclick="showAllgemeinTab('jahresziele')" class="text-sm text-blue-600 font-semibold">Ã–ffnen â†’</button></div>
                                <button onclick="showView('marketing')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“¢</p><h3 class="font-bold text-gray-800 mb-1">Marketing-Strategie</h3><p class="text-xs text-gray-500">Kampagnen, Social Media</p></button>
                                <button onclick="showView('einkauf')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ›’</p><h3 class="font-bold text-gray-800 mb-1">Einkaufsstrategie</h3><p class="text-xs text-gray-500">Lieferanten, Konditionen</p></button>
                                <button onclick="showView('controlling')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“Š</p><h3 class="font-bold text-gray-800 mb-1">BWA & Controlling</h3><p class="text-xs text-gray-500">Finanzkennzahlen</p></button>
                                <button onclick="showView('aktenschrank')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“</p><h3 class="font-bold text-gray-800 mb-1">Aktenschrank</h3><p class="text-xs text-gray-500">Dokumente und Vorlagen</p></button>
                            </div>
                        </div>
                
                        <!-- TAB: Wissen -->
                        <div id="allgemeinTabContent-wissen" style="display:none">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="showView('wissen')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“š</p><h3 class="font-bold text-gray-800 mb-1">Wissensdatenbank</h3><p class="text-xs text-gray-500">Artikel und Schulungen</p></button>
                                <button onclick="showView('onboarding')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸš€</p><h3 class="font-bold text-gray-800 mb-1">Onboarding</h3><p class="text-xs text-gray-500">Checklisten</p></button>
                                <button onclick="showView('support')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ†˜</p><h3 class="font-bold text-gray-800 mb-1">Support</h3><p class="text-xs text-gray-500">Tickets und Kontakte</p></button>
                            </div>
                        </div>
                
                    </div>
                </div>


                <div id="devStatusView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">MODULÃœBERSICHT</h1>
                            <p class="text-sm text-gray-500">Entwicklungsstand aller Module â€“ Stand: 16. Februar 2026</p>
                        </div>
                        <div class="flex items-center space-x-2" id="modulStatusSummary"></div>
                    </div>
                    <!-- Filter -->
                    <div class="flex flex-wrap items-center gap-2 mb-6">
                        <button onclick="filterModulStatus('alle')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="alle">Alle</button>
                        <button onclick="filterModulStatus('standort')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="standort">Standort-Module</button>
                        <button onclick="filterModulStatus('hq')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hq">HQ-Module</button>
                        <button onclick="filterModulStatus('widgets')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="widgets">Dashboard-Widgets</button>
                        <span class="border-l border-gray-300 h-5 mx-1"></span>
                        <button onclick="filterModulStatus('kiPrio')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="kiPrio">ðŸ¤– PrioritÃ¤t KI</button>
                        <button onclick="filterModulStatus('hqPrio')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hqPrio">ðŸ¢ Prio HQ</button>
                    </div>
                    <div id="modulStatusContent"></div>
                </div>

                <!-- ==================== HQ VIEWS ================================== -->
                <!-- ================================================================= -->

                <!-- ===== HQ NETZWERK-COCKPIT ===== -->
                <div id="hqCockpitView" class="view" style="display: none;">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">NETZWERK-COCKPIT ðŸ‘‹</h1>
                            <p class="text-sm text-gray-500" id="hqWelcomeDate">Willkommen zurueck</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-gray-400">Stand: 14.02.2026</span>
                            <select id="hqPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqCockpit()">
                                <option value="ytd">YTD 2026</option>
                                <option value="jan">Januar 2026</option>
                                <option value="feb">Februar 2026</option>
                            </select>
                        </div>
                    </div>

                    <!-- Schnellzugriffe HQ -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
                        <button onclick="showView('hqAktionen')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸš¨</p><p class="text-[10px] font-semibold text-gray-700">Handlungsbedarf</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kampagnen')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸŽ¯</p><p class="text-[10px] font-semibold text-gray-700">Kampagnen</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kommunikation')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“¢</p><p class="text-[10px] font-semibold text-gray-700">Kommunikation</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('aufgaben')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“‹</p><p class="text-[10px] font-semibold text-gray-700">Aufgaben</p></button>
                        <button onclick="showView('hqKommando')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">âš™ï¸</p><p class="text-[10px] font-semibold text-gray-700">Kommandozentrale</p></button>
                        <button onclick="showView('hqAuswertung')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“Š</p><p class="text-[10px] font-semibold text-gray-700">Auswertung</p></button>
                    </div>

                    <!-- Netzwerk KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKpiCards"></div>

                    <!-- Handlungsbedarf Ticker -->
                    <div class="vit-card p-4 mb-6 border-l-4 border-red-500" id="hqAlertBox"></div>

                    <!-- 3-Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- LEFT 2/3: Rankings + Kampagnen + Grid -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Top 5 Standorte</h2>
                                    <div id="hqTop5" class="space-y-2"></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Bottom 5 â€“ Handlungsbedarf</h2>
                                    <div id="hqBottom5" class="space-y-2"></div>
                                </div>
                            </div>

                            <!-- Kampagnen Kompakt -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸŽ¯ Aktive Kampagnen</h2>
                                    <button onclick="showView('hqKampagnen')" class="text-xs text-vit-orange font-semibold hover:underline">Alle anzeigen â†’</button>
                                </div>
                                <div id="hqHomeKampagnen" class="space-y-2"></div>
                            </div>

                            <!-- Standort-Grid -->
                            <div class="vit-card p-5">
                                <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“Š Alle Standorte â€“ Lead-Performance</h2>
                                <div class="flex items-center space-x-4 mb-3 text-[10px] text-gray-500">
                                    <span>ðŸ”´ &lt; 50%</span><span>ðŸŸ  50-75%</span><span>ðŸŸ¢ 75-100%</span><span>ðŸŸ¡ â‰¥ 100%</span>
                                </div>
                                <div id="hqStandortGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
                            </div>
                        </div>

                        <!-- RIGHT 1/3: Live-Feed -->
                        <div class="space-y-6">
                            <!-- Offene Aufgaben -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“‹ Offene Aufgaben</h2>
                                    <button onclick="showView('hqAufgaben')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAufgaben" class="space-y-2"></div>
                            </div>

                            <!-- Naechste Termine -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“… Naechste Termine</h2>
                                    <button onclick="showView('hqKalender')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeTermine" class="space-y-2"></div>
                            </div>

                            <!-- Letzte Ankuendigungen -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“¢ Letzte Ankuendigungen</h2>
                                    <button onclick="showView('hqKomm')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAnnounce" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ===== HQ STANDORTE ===== -->
                <div id="hqStandorteView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="h1-headline text-gray-800">STANDORTE</h1>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="hqStandortSearch" placeholder="Standort suchen..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" oninput="renderHqStandorte()">
                            <select id="hqStandortFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqStandorte()">
                                <option value="all">Alle</option>
                                <option value="kritisch">ðŸ”´ Kritisch (&lt;50%)</option>
                                <option value="achtung">ðŸŸ  Achtung (50-75%)</option>
                                <option value="gut">ðŸŸ¢ Gut (75-100%)</option>
                                <option value="top">ðŸŸ¡ Top (â‰¥100%)</option>
                            </select>
                        </div>
                    </div>
                    <div id="hqStandorteList" class="space-y-3"></div>
                </div>

                <!-- ===== HQ FINANZEN ===== -->
                <div id="hqFinanzenView" class="view" style="display: none;">
                    <!-- BWA Network Status Dashboard (Spec Section 5) -->
                    <div id="hqBwaStatusDashboard" class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="h2-headline text-vit-gray mb-1">NETZWERK</p>
                                <h1 class="h1-headline">BWA-Status Ãœbersicht</h1>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">Aktueller Monat</p>
                                    <p id="hqBwaMonth" class="text-sm font-bold text-gray-800">â€”</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Eingereicht</p><p id="hqBwaSubmitted" class="text-2xl font-bold text-green-600">â€”</p><p class="text-xs text-gray-400">von <span id="hqBwaTotal">â€”</span></p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">ðŸ¥‡ Gold</p><p id="hqBwaGold" class="text-2xl font-bold text-yellow-500">â€”</p><p class="text-xs text-gray-400">vor dem 8.</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">âœ… OK</p><p id="hqBwaOk" class="text-2xl font-bold text-green-600">â€”</p><p class="text-xs text-gray-400">bis zum 15.</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">â³ Ausstehend</p><p id="hqBwaMissing" class="text-2xl font-bold text-gray-400">â€”</p><p class="text-xs text-gray-400">noch Zeit</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">ðŸš¨ ÃœberfÃ¤llig</p><p id="hqBwaOverdue" class="text-2xl font-bold text-red-500">â€”</p><p class="text-xs text-gray-400">Stufe 3</p></div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="vit-card p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-gray-600">Netzwerk-Fortschritt</span>
                                <span id="hqBwaPct" class="text-xs font-bold text-vit-orange">â€”%</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-3"><div id="hqBwaBar" class="h-3 rounded-full transition-all" style="width:0%;background:linear-gradient(90deg,#EF7D00,#F59E0B)"></div></div>
                        </div>

                        <!-- Standort-Tabelle -->
                        <div class="vit-card p-4">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-left text-xs text-gray-400 border-b border-gray-200">
                                        <th class="pb-2 font-semibold">Standort</th>
                                        <th class="pb-2 font-semibold">Status</th>
                                        <th class="pb-2 font-semibold">Rating</th>
                                        <th class="pb-2 font-semibold">Eingereicht</th>
                                        <th class="pb-2 font-semibold">Eskalation</th>
                                        <th class="pb-2 font-semibold">Tage</th>
                                    </tr>
                                </thead>
                                <tbody id="hqBwaTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <h1 class="h1-headline text-gray-800 mb-6">FINANZEN â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqFinKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz & Rohertrag pro Standort</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="hqFinTable"></table>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ BWA-Auffaelligkeiten</h2>
                            <div id="hqFinAlerts" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“ˆ Rohertrag-Ranking</h2>
                            <div id="hqFinRohertrag" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- ===== HQ MARKETING ===== -->
                <div id="hqMarketingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">MARKETING â€“ NETZWERK</h1>

                    <!-- HQ Marketing Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showHqMktTab('uebersicht')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-hqmkt="uebersicht">ðŸ  Ãœbersicht</button>
                            <button onclick="showHqMktTab('budgetsteuerung')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="budgetsteuerung">ðŸ’° Budget-Steuerung</button>
                            <button onclick="showHqMktTab('leadreport')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="leadreport">ðŸ“Š Lead Reporting</button>
                            <button onclick="showHqMktTab('jahresgespraeche')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="jahresgespraeche">ðŸ“‹ JahresgesprÃ¤che</button>
                            <button onclick="showHqMktTab('handlungsbedarf')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="handlungsbedarf">âš ï¸ Handlungsbedarf</button>
                        </nav>
                    </div>

                    <!-- HQ MKT TAB 1: Ãœbersicht -->
                    <div id="hqMktTabUebersicht" class="hqmkt-tab-content">
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqMktKpis"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Lead-Performance pro Standort</h2><div id="hqMktLeads" class="space-y-2"></div></div>
                            <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸŽ¯ Strategie-Status</h2><div id="hqMktStrategie" class="space-y-2"></div></div>
                        </div>
                        <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Schnell-Alerts</h2><div id="hqMktAlerts" class="space-y-2"></div></div>
                    </div>

                    <!-- HQ MKT TAB 2: Budget-Steuerung -->
                    <div id="hqMktTabBudgetsteuerung" class="hqmkt-tab-content" style="display:none;">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">Jahresbudget</p><p class="text-2xl font-bold text-gray-800">491.958 â‚¬</p><p class="text-xs text-gray-400">Gesamt 2026</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">YTD Budget</p><p class="text-2xl font-bold text-vit-orange">54.794 â‚¬</p><p class="text-xs text-gray-400">Bis Feb</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">âŒ€ Monatlich</p><p class="text-2xl font-bold text-gray-800">40.997 â‚¬</p><p class="text-xs text-gray-400">Netzwerk</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">Aktive Standorte</p><p class="text-2xl font-bold text-green-600">22</p><p class="text-xs text-gray-400">mit Budget</p></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-5 border-l-4 border-yellow-500">
                                <div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="w-3 h-3 bg-yellow-500 rounded-full"></span><span class="font-bold">Google Ads</span></div><span class="text-xs text-gray-400">80% Split</span></div>
                                <div class="text-sm space-y-1"><div class="flex justify-between"><span class="text-gray-500">Budget Feb:</span><span class="font-bold">29.960 â‚¬</span></div><div class="flex justify-between"><span class="text-gray-500">Ausgegeben:</span><span>8.133 â‚¬</span></div><div class="flex justify-between"><span class="text-gray-500">Hochrechnung:</span><span class="text-red-500">-14.232 â‚¬</span></div></div>
                                <div class="mt-2 bg-gray-200 rounded-full h-2"><div class="bg-yellow-500 h-2 rounded-full" style="width:27%"></div></div>
                            </div>
                            <div class="vit-card p-5 border-l-4 border-blue-500">
                                <div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="w-3 h-3 bg-blue-500 rounded-full"></span><span class="font-bold">Meta Ads</span></div><span class="text-xs text-gray-400">20% Split</span></div>
                                <div class="text-sm space-y-1"><div class="flex justify-between"><span class="text-gray-500">Budget Feb:</span><span class="font-bold">7.490 â‚¬</span></div><div class="flex justify-between"><span class="text-gray-500">Ausgegeben:</span><span>1.966 â‚¬</span></div><div class="flex justify-between"><span class="text-gray-500">Hochrechnung:</span><span class="text-red-500">-3.441 â‚¬</span></div></div>
                                <div class="mt-2 bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width:26%"></div></div>
                            </div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Budget pro Standort â€“ Februar 2026</h2>
                            <div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="bg-gray-50"><th class="text-left py-2 px-2 font-semibold">Standort</th><th class="text-center py-2 px-2 font-semibold">Status</th><th class="text-right py-2 px-2 font-semibold text-yellow-600">â— Google</th><th class="text-right py-2 px-2 font-semibold">Ausg.</th><th class="text-right py-2 px-2 font-semibold">Hoch.</th><th class="text-right py-2 px-2 font-semibold text-blue-600">â— Meta</th><th class="text-right py-2 px-2 font-semibold">Ausg.</th><th class="text-right py-2 px-2 font-semibold">Hoch.</th></tr></thead><tbody id="hqMktBudgetTable"></tbody></table></div>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 3: Lead Reporting -->
                    <div id="hqMktTabLeadreport" class="hqmkt-tab-content" style="display:none;">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">Live-Leads</p><p class="text-2xl font-bold text-gray-800" id="hqMktTotalLeads">777</p><p class="text-xs text-gray-400">YTD Netzwerk</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">âŒ€ pro Standort/Monat</p><p class="text-2xl font-bold text-vit-orange" id="hqMktAvgLeads">9.6</p><p class="text-xs text-gray-400">Soll: 5.0</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">âŒ€ Verkaufsquote</p><p class="text-2xl font-bold text-green-600">52%</p><p class="text-xs text-gray-400">Ziel: 75%</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400 uppercase">Lead-Umsatz geschÃ¤tzt</p><p class="text-2xl font-bold text-green-600">4,2 Mio â‚¬</p><p class="text-xs text-green-600">38% lt. Umsatzplan</p></div>
                        </div>
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Standort-Performance â€“ Leads & Conversion</h2>
                            <div id="hqMktLeadRanking" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“… Monatliche Ãœbersicht â€“ Netzwerk</h2>
                            <div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="bg-gray-50"><th class="text-left py-2 px-2">Monat</th><th class="text-right py-2 px-2">Soll</th><th class="text-right py-2 px-2">Ist</th><th class="text-right py-2 px-2">Diff</th><th class="text-right py-2 px-2">Performance</th><th class="text-center py-2 px-2">Status</th></tr></thead><tbody>
                                <tr class="border-b bg-green-50"><td class="py-1.5 px-2 font-semibold">Januar</td><td class="py-1.5 px-2 text-right">5,2</td><td class="py-1.5 px-2 text-right font-bold">8,7</td><td class="py-1.5 px-2 text-right text-green-600">+3,5</td><td class="py-1.5 px-2 text-right text-green-600">167%</td><td class="py-1.5 px-2 text-center"><span class="text-green-600">âœ…</span></td></tr>
                                <tr class="border-b bg-blue-50"><td class="py-1.5 px-2 font-semibold">Februar</td><td class="py-1.5 px-2 text-right">4,1</td><td class="py-1.5 px-2 text-right font-bold">2,8</td><td class="py-1.5 px-2 text-right text-red-500">-1,3</td><td class="py-1.5 px-2 text-right text-yellow-600">68%</td><td class="py-1.5 px-2 text-center"><span class="text-blue-600">â—‰ Laufend</span></td></tr>
                                <tr class="border-b"><td class="py-1.5 px-2 text-gray-400">MÃ¤rz â€“ Dez</td><td class="py-1.5 px-2 text-right text-gray-400">â€”</td><td class="py-1.5 px-2 text-right text-gray-300" colspan="4">â€”</td></tr>
                            </tbody></table></div>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 4: JahresgesprÃ¤che -->
                    <div id="hqMktTabJahresgespraeche" class="hqmkt-tab-content" style="display:none;">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400">Vereinbart</p><p class="text-2xl font-bold text-green-600" id="hqMktJgDone">18</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400">Ausstehend</p><p class="text-2xl font-bold text-red-500" id="hqMktJgOpen">4</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400">âŒ€ Budget vereinbart</p><p class="text-2xl font-bold text-vit-orange">1.640 â‚¬</p><p class="text-xs text-gray-400">/Monat</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-400">âŒ€ Terminziel-Erreichung</p><p class="text-2xl font-bold text-yellow-600">56%</p><p class="text-xs text-gray-400">2025</p></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ JahresgesprÃ¤ch-Status pro Standort</h2>
                            <div class="overflow-x-auto"><table class="w-full text-xs"><thead><tr class="bg-gray-50"><th class="text-left py-2 px-2">Standort</th><th class="text-left py-2 px-2">Inhaber</th><th class="text-left py-2 px-2">AP vit:bikes</th><th class="text-right py-2 px-2">Budget/Mo</th><th class="text-left py-2 px-2">Mediamix</th><th class="text-center py-2 px-2">CRM</th><th class="text-center py-2 px-2">Status</th></tr></thead><tbody id="hqMktJgTable"></tbody></table></div>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 5: Handlungsbedarf -->
                    <div id="hqMktTabHandlungsbedarf" class="hqmkt-tab-content" style="display:none;">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-5 text-center border-l-4 border-red-500"><p class="text-xs text-gray-400">Kritisch</p><p class="text-2xl font-bold text-red-600" id="hqMktAlertKrit">3</p></div>
                            <div class="vit-card p-5 text-center border-l-4 border-yellow-500"><p class="text-xs text-gray-400">Warnung</p><p class="text-2xl font-bold text-yellow-600" id="hqMktAlertWarn">5</p></div>
                            <div class="vit-card p-5 text-center border-l-4 border-blue-500"><p class="text-xs text-gray-400">Info</p><p class="text-2xl font-bold text-blue-600" id="hqMktAlertInfo">4</p></div>
                            <div class="vit-card p-5 text-center border-l-4 border-green-500"><p class="text-xs text-gray-400">Im grÃ¼nen Bereich</p><p class="text-2xl font-bold text-green-600" id="hqMktAlertOk">10</p></div>
                        </div>
                        <div id="hqMktAlertsFull" class="space-y-3"></div>
                    </div>
                </div>

                <!-- ===== HQ EINKAUF ===== -->
                <div id="hqEinkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">EINKAUF â€“ NETZWERK</h1>
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showHqEkTab('dash')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-hqek="dash">ðŸ“Š Ãœbersicht</button>
                            <button onclick="showHqEkTab('lief')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqek="lief">ðŸ“‹ Lieferanten</button>
                            <button onclick="showHqEkTab('strat')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqek="strat">ðŸŽ¯ Strategien</button>
                        </nav>
                    </div>
                    <div id="hqEkTabDash" class="hqek-tab-content"></div>
                    <div id="hqEkTabLief" class="hqek-tab-content" style="display:none;"></div>
                    <div id="hqEkTabStrat" class="hqek-tab-content" style="display:none;"></div>
                </div>

                <div id="hqVerkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">VERKAUF â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqVkKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Verkaufsleistung pro Standort (KW 7)</h2>
                        <div class="overflow-x-auto"><table class="w-full text-sm" id="hqVkTable"></table></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Handlungsbedarf Verkauf</h2>
                        <div id="hqVkAlerts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ HANDLUNGSBEDARF ===== -->
                <div id="hqAktionenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">HANDLUNGSBEDARF â€“ ALLE BEREICHE</h1>
                    <p class="text-sm text-gray-500 mb-6">Konsolidierte Uebersicht aller offenen Punkte, die Aufmerksamkeit der Zentrale erfordern. Sortiert nach Prioritaet.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqAktKpis"></div>
                    <div id="hqAktionenList" class="space-y-3"></div>
                </div>

                <!-- HQ KOMMUNIKATION -->
                <!-- HQ KAMPAGNEN -->
                <!-- HQ DOKUMENTE -->
                <!-- HQ KALENDER -->
                <!-- HQ AUFGABEN -->
                <!-- KOMMANDOZENTRALE -->
                <div id="hqKommandoView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">âš™ï¸ KOMMANDOZENTRALE</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showKommandoTab('standorte')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-ktab="standorte">ðŸ¢ Standorte</button>
                            <button onclick="showKommandoTab('mitarbeiter')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="mitarbeiter">ðŸ‘¥ Mitarbeiter</button>
                            <button onclick="showKommandoTab('kommunikation')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kommunikation">ðŸ“¢ Kommunikation</button>
                            <button onclick="showKommandoTab('kampagnen')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kampagnen">ðŸŽ¯ Kampagnen</button>
                            <button onclick="showKommandoTab('dokumente')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="dokumente">ðŸ“ Dokumente</button>
                            <button onclick="showKommandoTab('kalender')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kalender">ðŸ“… Kalender</button>
                            <button onclick="showKommandoTab('aufgaben')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="aufgaben">ðŸ“‹ Aufgaben</button>
                        </nav>
                    </div>

                    <!-- STANDORTE TAB -->
                    <div id="kommandoTabStandorte" class="kommando-tab-content">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzStandorteGesamt">21</p><p class="text-xs text-gray-500">Standorte gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzStandorteAktiv">18</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzStandorteOnb">2</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzStandorteOff">1</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRegionen">4</p><p class="text-xs text-gray-500">Regionen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterKzStandorte('all')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzf="all">Alle</button>
                                <button onclick="filterKzStandorte('aktiv')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzStandorte('onboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzStandorte('offboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerStandortModal()">+ Neuer Standort</button>
                        </div>

                        <!-- Standorte Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Adresse</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Typ</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Mitarbeiter</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Beitritt</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Telefon</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzStandorteBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- MITARBEITER TAB -->
                    <div id="kommandoTabMitarbeiter" class="kommando-tab-content" style="display:none;">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzMaGesamt">67</p><p class="text-xs text-gray-500">Mitarbeiter gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzMaAktiv">61</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzMaOnb">4</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzMaOff">2</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRollen">5</p><p class="text-xs text-gray-500">Rollen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2 flex-wrap gap-y-2">
                                <button onclick="filterKzMa('all')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzmf="all">Alle</button>
                                <button onclick="filterKzMa('aktiv')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzMa('onboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzMa('offboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <div class="flex space-x-2">
                                <select id="kzMaStandortFilter" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs" onchange="filterKzMa(currentKzMaFilter)">
                                    <option value="all">Alle Standorte</option>
                                </select>
                                <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                            </div>
                        </div>

                        <!-- Mitarbeiter Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Rolle</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Eintritt</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Onboarding</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzMaBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- KOMMUNIKATION TAB -->
                    <div id="kommandoTabKommunikation" class="kommando-tab-content" style="display:none;">
                        <!-- Sub-tabs -->
                        <div class="border-b border-gray-100 mb-4">
                            <nav class="flex space-x-4">
                                <button onclick="showHqKommTab('announce')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-vit-orange font-semibold text-vit-orange" data-hkt="announce">ðŸ“¢ Ankuendigungen</button>
                                <button onclick="showHqKommTab('rundmail')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="rundmail">âœ‰ï¸ Rundmail</button>
                                <button onclick="showHqKommTab('forum')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="forum">ðŸ’¬ Netzwerk-Forum</button>
                            </nav>
                        </div>
                        <div id="hqKommContent"></div>
                    </div>

                    <!-- KAMPAGNEN TAB -->
                    <div id="kommandoTabKampagnen" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Kampagnen erstellen, steuern und Umsetzung ueber alle Standorte tracken.</p>
                            <button onclick="document.getElementById('hqKampModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Kampagne</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKampKpis"></div>
                        <div id="hqKampList" class="space-y-4"></div>
                        <!-- Modal -->
                        <div id="hqKampModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Neue Kampagne erstellen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKampName" placeholder="Kampagnen-Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="date" id="hqKampStart" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <input type="date" id="hqKampEnd" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    </div>
                                    <select id="hqKampType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="saisonal">Saisonkampagne</option><option value="produkt">Produktkampagne</option><option value="event">Event/Aktionstag</option><option value="social">Social Media Push</option>
                                    </select>
                                    <textarea id="hqKampDesc" rows="2" placeholder="Beschreibung / Ziel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKampagne()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Erstellen</button>
                                    <button onclick="document.getElementById('hqKampModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DOKUMENTE TAB -->
                    <div id="kommandoTabDokumente" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-weite Dokumente: Richtlinien, Vorlagen, Schulungen, Vertraege.</p>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openDokUploadModal()">+ Dokument hochladen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqDokKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqDok('all')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hdf="all">Alle</button>
                            <button onclick="filterHqDok('richtlinie')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="richtlinie">ðŸ“‹ Richtlinien</button>
                            <button onclick="filterHqDok('vorlage')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vorlage">ðŸ“„ Vorlagen</button>
                            <button onclick="filterHqDok('schulung')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqDok('vertrag')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vertrag">ðŸ“‘ Vertraege</button>
                        </div>
                        <div id="hqDokList" class="space-y-2"></div>
                    </div>

                    <!-- KALENDER TAB -->
                    <div id="kommandoTabKalender" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-Termine: Schulungen, Events, Deadlines und Meetings fuer alle Standorte.</p>
                            <button onclick="document.getElementById('hqKalModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Netzwerk-Termin</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqKalKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqKal('all')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hkf="all">Alle</button>
                            <button onclick="filterHqKal('schulung')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqKal('event')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="event">ðŸŽª Events</button>
                            <button onclick="filterHqKal('deadline')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="deadline">â° Deadlines</button>
                            <button onclick="filterHqKal('meeting')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="meeting">ðŸ¤ Meetings</button>
                        </div>
                        <div id="hqKalList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqKalModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Netzwerk-Termin anlegen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKalTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3"><input type="date" id="hqKalDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"><input type="time" id="hqKalTime" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <select id="hqKalType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="schulung">ðŸŽ“ Schulung</option><option value="event">ðŸŽª Event</option><option value="deadline">â° Deadline</option><option value="meeting">ðŸ¤ Meeting</option></select>
                                    <select id="hqKalTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte</option><option value="region_sued">Region Sued</option><option value="region_nord">Region Nord</option><option value="region_west">Region West</option><option value="region_ost">Region Ost</option></select>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                    <button onclick="document.getElementById('hqKalModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AUFGABEN TAB -->
                    <div id="kommandoTabAufgaben" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Aufgaben an Standorte verteilen und Umsetzung tracken.</p>
                            <button onclick="document.getElementById('hqTaskModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Aufgabe verteilen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4" id="hqTaskKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqTasks('all')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-htf="all">Alle</button>
                            <button onclick="filterHqTasks('offen')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="offen">ðŸ”´ Offen</button>
                            <button onclick="filterHqTasks('inprogress')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="inprogress">ðŸ”µ In Arbeit</button>
                            <button onclick="filterHqTasks('done')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="done">âœ… Erledigt</button>
                        </div>
                        <div id="hqTaskList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Aufgabe an Standort(e) verteilen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqTaskTitle" placeholder="Aufgabentitel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <input type="date" id="hqTaskDeadline" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <select id="hqTaskPrio" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="hoch">ðŸ”´ Hoch</option><option value="mittel" selected>ðŸŸ¡ Mittel</option><option value="niedrig">ðŸŸ¢ Niedrig</option></select>
                                    <select id="hqTaskTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte (21)</option><option value="region_sued">Region Sued (8)</option><option value="region_nord">Region Nord (5)</option><option value="region_west">Region West (5)</option><option value="region_ost">Region Ost (3)</option></select>
                                    <textarea id="hqTaskDesc" rows="2" placeholder="Beschreibung" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqTask()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Verteilen</button>
                                    <button onclick="document.getElementById('hqTaskModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- HQ AUSWERTUNG: Portal-Nutzung -->
                <div id="hqAuswertungView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“Š AUSWERTUNG â€“ PORTAL-NUTZUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Wie aktiv nutzen die Standorte das vit:bikes Partner-Portal?</p>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqAuswKpis"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Aktivste Standorte</h2>
                            <div id="hqAuswTop" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Geringste Nutzung</h2>
                            <div id="hqAuswBottom" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="vit-card p-5 mb-6">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“‹ Modul-Nutzung im Netzwerk</h2>
                        <div id="hqAuswModules" class="space-y-2"></div>
                    </div>
                    <div class="vit-card p-5">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“ˆ Alle Standorte â€“ Nutzungs-Score</h2>
                        <div id="hqAuswAll" class="space-y-1"></div>
                    </div>
                </div>

                <!-- ===== HQ WISSEN-VERWALTUNG ===== -->
                <div id="hqWissenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“š WISSEN â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Wissensinhalte fuer alle Partner bereitstellen und verwalten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange">24</div><div class="text-xs text-gray-500">Akademie-Kurse</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">18</div><div class="text-xs text-gray-500">Handbuecher</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">12</div><div class="text-xs text-gray-500">Best Practices</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-purple-600">45</div><div class="text-xs text-gray-500">FAQ-Eintraege</div></div>
                    </div>
                    <!-- Neuen Inhalt anlegen -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neuen Wissensinhalt erstellen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Titel</label>
                                <input type="text" id="hqWissenTitel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Leitfaden E-Bike Beratung">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                <select id="hqWissenKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="akademie">ðŸŽ“ Akademie-Kurs</option>
                                    <option value="handbuch">ðŸ“– Handbuch</option>
                                    <option value="bestpractice">â­ Best Practice</option>
                                    <option value="faq">â“ FAQ</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bereich</label>
                            <select id="hqWissenBereich" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="verkauf">Verkauf</option>
                                <option value="werkstatt">Werkstatt</option>
                                <option value="marketing">Marketing</option>
                                <option value="betrieb">Betrieb &amp; Organisation</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Inhalt / Beschreibung</label>
                            <textarea id="hqWissenInhalt" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Inhalt des Wissensartikels..."></textarea>
                        </div>
                        <button onclick="addHqWissen()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ“š Veroeffentlichen</button>
                    </div>
                    <!-- Bestehende Inhalte -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Bestehende Inhalte</h2>
                        <div id="hqWissenList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ SUPPORT-ÃœBERSICHT ===== -->
                <div id="hqSupportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸŽ« SUPPORT â€“ UEBERSICHT</h1>
                    <p class="text-sm text-gray-500 mb-6">Alle Support-Anfragen der Partner im Blick.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-500">7</div><div class="text-xs text-gray-500">Offene Tickets</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-500">3</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">48</div><div class="text-xs text-gray-500">Geloest (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">4.2h</div><div class="text-xs text-gray-500">âŒ€ Reaktionszeit</div></div>
                    </div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ”´ Offene Support-Tickets</h2>
                        <div id="hqSupportTickets" class="space-y-3"></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Tickets nach Standort</h2>
                        <div id="hqSupportStats" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ IDEENBOARD-ÃœBERSICHT ===== -->
                <div id="hqIdeenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ’¡ IDEENBOARD â€“ NETZWERK</h1>
                    <p class="text-sm text-gray-500 mb-6">Alle Ideen und Vorschlaege der Partner einsehen und bewerten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="hqIdeenTotal">0</div><div class="text-xs text-gray-500">Eingereichte Ideen</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-500" id="hqIdeenPruefung">0</div><div class="text-xs text-gray-500">In PrÃ¼fung</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="hqIdeenUmgesetzt">0</div><div class="text-xs text-gray-500">Umgesetzt</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-400" id="hqIdeenAbgelehnt">0</div><div class="text-xs text-gray-500">Abgelehnt</div></div>
                    </div>
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterHqIdeen('all')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-hif="all">Alle</button>
                        <button onclick="filterHqIdeen('neu')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="neu">Neu</button>
                        <button onclick="filterHqIdeen('wird_geprueft')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="wird_geprueft">Wird geprÃ¼ft</button>
                        <button onclick="filterHqIdeen('umgesetzt')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="umgesetzt">Umgesetzt</button>
                        <button onclick="filterHqIdeen('abgelehnt')" class="hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-hif="abgelehnt">Abgelehnt</button>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Eingereichte Ideen aller Partner</h2>
                        <div id="hqIdeenList" class="space-y-3"></div>
                    </div>
                </div>

                <!-- ===== HQ SHOP-VERWALTUNG ===== -->
                <div id="hqShopView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ›ï¸ WERBEMITTEL-SHOP â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Sortiment, Preise und Bestellungen verwalten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange">20</div><div class="text-xs text-gray-500">Produkte aktiv</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">34</div><div class="text-xs text-gray-500">Bestellungen (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">â‚¬ 4.280</div><div class="text-xs text-gray-500">Umsatz (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-purple-600">â‚¬ 126</div><div class="text-xs text-gray-500">âŒ€ Bestellwert</div></div>
                    </div>
                    <!-- Neues Produkt -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neues Produkt anlegen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Produktname</label>
                                <input type="text" id="hqShopName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Regenjacke">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                <select id="hqShopKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="print">ðŸ–¨ï¸ Print</option>
                                    <option value="textil">ðŸ‘• Textilien</option>
                                    <option value="display">ðŸª§ Displays</option>
                                    <option value="digital">ðŸ’» Digital</option>
                                    <option value="give">ðŸŽ Giveaways</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Preis (â‚¬)</label>
                                <input type="number" id="hqShopPreis" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                            <input type="text" id="hqShopDesc" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Kurze Produktbeschreibung">
                        </div>
                        <button onclick="addHqShopProduct()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ›ï¸ Produkt anlegen</button>
                    </div>
                    <!-- Bestellungen -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“¦ Letzte Bestellungen</h2>
                        <div id="hqShopOrders" class="space-y-2"></div>
                    </div>
                    <!-- Produkte -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Alle Produkte</h2>
                        <div id="hqShopProducts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- HQ EINSTELLUNGEN VIEW -->
                <div id="hqEinstellungenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">âš™ï¸ EINSTELLUNGEN</h1>
                    <p class="text-sm text-gray-500 mb-6">Modul-Verwaltung und Rollen-Rechte fÃ¼r das gesamte Netzwerk.</p>

                    <!-- Tab-Navigation -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showSettingsTab('modulstatus')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="modulstatus">ðŸ”§ Modul-Status</button>
                        <button onclick="showSettingsTab('rechte')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="rechte">ðŸ” Rollen & Rechte</button>
                    </div>

                    <!-- TAB 1: Modul-Status -->
                    <div id="settingsTabModulstatus" class="settings-tab-content">
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="countAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-orange-400"><div class="text-2xl font-bold text-orange-500" id="countDemo">0</div><div class="text-xs text-gray-500">Demo</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-yellow-500"><div class="text-2xl font-bold text-yellow-600" id="countWip">0</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-gray-400"><div class="text-2xl font-bold text-gray-400" id="countDeaktiviert">0</div><div class="text-xs text-gray-500">Deaktiviert</div></div>
                        </div>
                        <div class="vit-card overflow-hidden mb-6">
                            <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                <h2 class="font-bold text-gray-800">Modul-Verwaltung</h2>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span><span>Aktiv</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-orange-400 inline-block"></span><span>Demo</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block"></span><span>In Bearbeitung</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 inline-block"></span><span>Deaktiviert</span></span>
                                </div>
                            </div>
                            <div id="modulStatusList" class="divide-y divide-gray-100"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-2">â„¹ï¸ So funktioniert es</h3>
                            <div class="space-y-1.5 text-xs text-gray-600">
                                <p><span class="font-bold text-green-600">Aktiv:</span> Das Modul ist fÃ¼r alle Nutzer sichtbar und voll nutzbar (sofern ihre Rolle es erlaubt).</p>
                                <p><span class="font-bold text-orange-500">Demo:</span> Das Modul ist sichtbar und klickbar, zeigt aber Demo-Daten. Ein oranges Demo-Banner ist prominent sichtbar. Ideal fÃ¼r Module in Vorbereitung.</p>
                                <p><span class="font-bold text-yellow-600">In Bearbeitung:</span> Das Modul erscheint ausgegraut in der Sidebar mit einem â€žBALD"-Badge. Nutzer kÃ¶nnen es nicht Ã¶ffnen.</p>
                                <p><span class="font-bold text-gray-500">Deaktiviert:</span> Das Modul ist komplett unsichtbar â€“ kein MenÃ¼punkt, kein Zugang.</p>
                                <hr class="my-3 border-gray-200">
                                <p><strong>Tabs & Widgets:</strong> Klicke auf â–¶ bei einem Modul, um einzelne Tabs und Dashboard-Widgets zu konfigurieren. Jeder Tab/Widget kann separat auf Aktiv, Demo oder Deaktiviert gesetzt werden.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: Rollen & Rechte (bestehend) -->
                    <div id="settingsTabRechte" class="settings-tab-content" style="display:none;">

                    <!-- Rollen-Ãœbersicht -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center border-l-4 border-orange-500"><div class="text-2xl font-bold text-vit-orange">4</div><div class="text-xs text-gray-500">Standort-Rollen</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-blue-500"><div class="text-2xl font-bold text-blue-600">12</div><div class="text-xs text-gray-500">Standort-Module</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="settingsMaCount">26</div><div class="text-xs text-gray-500">Mitarbeiter gesamt</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-purple-500"><div class="text-2xl font-bold text-purple-600">âœ“</div><div class="text-xs text-gray-500">Multi-Rollen aktiv</div></div>
                    </div>

                    <!-- Rechte-Matrix -->
                    <div class="vit-card overflow-hidden mb-6">
                        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                            <h2 class="font-bold text-gray-800">Rechte-Matrix: Module Ã— Rollen</h2>
                            <span class="text-xs text-gray-400">Klicken zum Aktivieren/Deaktivieren</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="rechteMatrixTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600 min-w-[180px]">Modul</th>
                                        <th class="px-4 py-3 text-center font-semibold text-orange-600 min-w-[100px]">GeschÃ¤ftsleitung</th>
                                        <th class="px-4 py-3 text-center font-semibold text-blue-600 min-w-[100px]">Verkauf</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600 min-w-[100px]">Werkstatt</th>
                                        <th class="px-4 py-3 text-center font-semibold text-purple-600 min-w-[100px]">Buchhaltung</th>
                                    </tr>
                                </thead>
                                <tbody id="rechteMatrixBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rollen-Beschreibungen -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸ“‹ Rollen-Beschreibungen</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-vit-orange text-white mt-0.5">GeschÃ¤ftsleitung</span><p class="text-xs text-gray-600">Vollzugriff auf alle Standort-Module inkl. Dashboards, Shop, Onboarding und Controlling.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700 mt-0.5">Verkauf</span><p class="text-xs text-gray-600">Zugang zu Verkauf, Marketing und allgemeinen Tools. Fokus auf Kundenberatung und Vertrieb.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-gray-200 text-gray-700 mt-0.5">Werkstatt</span><p class="text-xs text-gray-600">Zugang zu Einkauf und allgemeinen Tools. Fokus auf Werkstatt, Teile und Service.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-purple-100 text-purple-700 mt-0.5">Buchhaltung</span><p class="text-xs text-gray-600">Zugang zu Allgemein, Verkauf, Einkauf, Controlling und Aktenschrank. Finanz- und Dokumentenfokus.</p></div>
                            </div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">â„¹ï¸ Hinweise</h3>
                            <div class="space-y-2 text-xs text-gray-600">
                                <p>â€¢ <strong>Kalender, Aufgaben & Kommunikation</strong> sind fÃ¼r alle Rollen verfÃ¼gbar (nicht deaktivierbar).</p>
                                <p>â€¢ <strong>Mehrfach-Rollen:</strong> Ein Mitarbeiter kann mehrere Rollen gleichzeitig haben â€“ die Rechte werden addiert.</p>
                                <p>â€¢ <strong>Rollenzuweisung:</strong> Rollen pro Mitarbeiter vergeben Sie unter Kommandozentrale â†’ Mitarbeiter.</p>
                                <p>â€¢ Ã„nderungen an der Rechte-Matrix werden sofort fÃ¼r alle betroffenen Nutzer wirksam.</p>
                            </div>
                        </div>
                    </div>
                    </div><!-- /settingsTabRechte -->
                </div>

                <div id="hqAllgemeinView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                        <div class="mb-6"><p class="h2-headline text-vit-gray mb-1">HQ STEUERUNG</p><h1 class="h1-headline">Partner-Ãœbersicht</h1></div>
                
                        <!-- Stimmung -->
                        <div class="vit-card p-5 mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸŒ¡ï¸ Netzwerk-Stimmung</h3>
                            <div class="flex items-center space-x-6">
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜Š</span><div><span class="text-lg font-bold text-green-600" id="hqStimmungPositiv">0</span><span class="text-xs text-gray-500 ml-1">positiv</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜</span><div><span class="text-lg font-bold text-yellow-600" id="hqStimmungNeutral">0</span><span class="text-xs text-gray-500 ml-1">neutral</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜Ÿ</span><div><span class="text-lg font-bold text-orange-600" id="hqStimmungBesorgt">0</span><span class="text-xs text-gray-500 ml-1">besorgt</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜¤</span><div><span class="text-lg font-bold text-red-600" id="hqStimmungKritisch">0</span><span class="text-xs text-gray-500 ml-1">kritisch</span></div></div>
                            </div>
                        </div>
                
                        <!-- HQ-Aufgaben -->
                        <div class="vit-card p-5 mb-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ”´ Offene HQ-Aufgaben aus Partner-Journals</h3><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="hqAufgabenBadge">0</span></div>
                            <div id="hqJournalAufgaben"><p class="text-gray-400 text-sm">Lade...</p></div>
                        </div>
                
                        <!-- Tabelle -->
                        <div class="vit-card overflow-hidden">
                            <div class="p-5 border-b"><h3 class="font-bold text-gray-800">ðŸ“‹ Alle Standorte</h3></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50"><tr>
                                        <th class="text-left p-3 font-semibold text-gray-600">Standort</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Stimmung</th>
                                        <th class="text-left p-3 font-semibold text-gray-600">Monatsfokus</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Ziele</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Offene MaÃŸn.</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Letztes GesprÃ¤ch</th>
                                    </tr></thead>
                                    <tbody id="hqPartnerTabelle"><tr><td colspan="6" class="p-4 text-center text-gray-400">Lade...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

    </div>

    
<style>
.theme-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 0;}
.theme-toggle-track{width:36px;height:20px;border-radius:10px;background:#d1d5db;position:relative;transition:background 0.3s;}
.theme-toggle-track.active{background:#EF7D00;}
.theme-toggle-knob{width:16px;height:16px;border-radius:50%;background:white;position:absolute;top:2px;left:2px;transition:transform 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.theme-toggle-track.active .theme-toggle-knob{transform:translateX(16px);}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
        // ============================================
        // SUPABASE CLIENT
        // ============================================
        var SUPABASE_URL = 'https://lwwagbkxeofahhwebkab.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3d2FnYmt4ZW9mYWhod2Via2FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMTM3NDAsImV4cCI6MjA4NjU4OTc0MH0.YBKO7grysp8RHzGWA6xSGpTVi0wG2PmeEWJHI25f7ks';
        var sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        var sbUser = null; // Supabase auth user
        var sbProfile = null; // users table row
        var sbRollen = []; // role names array
        var sbStandort = null; // standorte row
        var sbModulStatus = {}; // {modul_key: 'aktiv'|'demo'|'in_bearbeitung'|'deaktiviert'}

        // Modul-Status aus Supabase laden und auf Sidebar anwenden
        async function loadModulStatus() {
            try {
                var resp = await sb.from('modul_status').select('modul_key, status, config').order('reihenfolge');
                if(resp.error) throw resp.error;
                sbModulStatus = {};
                sbModulConfig = {};
                (resp.data||[]).forEach(function(m) { 
                    sbModulStatus[m.modul_key] = m.status;
                    sbModulConfig[m.modul_key] = m.config || {};
                });
                applyModulStatus();
            } catch(err) { console.error('ModulStatus:', err); }
        }

        function applyModulStatus() {
            // Apply module-level status to sidebar
            document.querySelectorAll('[data-module]').forEach(function(btn) {
                var key = btn.getAttribute('data-module');
                var status = sbModulStatus[key] || 'aktiv';

                // Remove old badges
                var oldBadge = btn.querySelector('.modul-wip-badge,.modul-demo-badge');
                if(oldBadge) oldBadge.remove();

                if(status === 'deaktiviert') {
                    btn.style.display = 'none';
                } else if(status === 'in_bearbeitung') {
                    btn.style.display = '';
                    btn.style.opacity = '0.4';
                    btn.style.pointerEvents = 'none';
                    btn.style.cursor = 'not-allowed';
                    var badge = document.createElement('span');
                    badge.className = 'modul-wip-badge ml-auto text-[9px] bg-yellow-500 text-white rounded px-1 py-0.5 font-bold';
                    badge.textContent = 'BALD';
                    btn.appendChild(badge);
                } else if(status === 'demo') {
                    btn.style.display = '';
                    btn.style.opacity = '';
                    btn.style.pointerEvents = '';
                    btn.style.cursor = '';
                    var badge = document.createElement('span');
                    badge.className = 'modul-demo-badge ml-auto text-[9px] bg-orange-400 text-white rounded px-1 py-0.5 font-bold';
                    badge.textContent = 'DEMO';
                    btn.appendChild(badge);
                } else {
                    btn.style.display = '';
                    btn.style.opacity = '';
                    btn.style.pointerEvents = '';
                    btn.style.cursor = '';
                }
            });

            // Apply demo banners + overlay to views
            document.querySelectorAll('.demo-mode-banner,.demo-mode-watermark').forEach(function(b){ b.remove(); });
            document.querySelectorAll('.demo-mode-active').forEach(function(v){ v.classList.remove('demo-mode-active'); });
            Object.keys(sbModulStatus).forEach(function(key) {
                if(sbModulStatus[key] === 'demo') {
                    var viewMap = {startseite:'homeView',verkauf:'verkaufView',kalender:'kalenderView',aufgaben:'todoView',kommunikation:'kommunikationView',controlling:'controllingView',marketing:'marketingView',einkauf:'einkaufView',dashboards:'dashboardsView',allgemein:'allgemeinView',wissen:'wissenView',support:'supportView',ideenboard:'ideenboardView',shop:'shopView',onboarding:'onboardingView',mitarbeiter:'mitarbeiterView',aktenschrank:'aktenschrankView'};
                    var viewId = viewMap[key];
                    var viewEl = viewId ? document.getElementById(viewId) : null;
                    if(viewEl) {
                        viewEl.classList.add('demo-mode-active');
                        // Sticky banner at top
                        if(!viewEl.querySelector('.demo-mode-banner')) {
                            var banner = document.createElement('div');
                            banner.className = 'demo-mode-banner';
                            banner.style.cssText = 'position:sticky;top:0;z-index:40;margin:-24px -24px 20px -24px;padding:0';
                            banner.innerHTML = '<div style="background:repeating-linear-gradient(45deg,#EF7D00,#EF7D00 10px,#F59E0B 10px,#F59E0B 20px);padding:3px 0"><div style="background:#EF7D00;padding:14px 24px;display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:12px"><div style="background:rgba(255,255,255,0.2);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:22px">ðŸ‘ï¸</div><div><strong style="color:white;font-size:15px;letter-spacing:0.5px">DEMO-MODUS</strong><p style="color:rgba(255,255,255,0.9);font-size:12px;margin:2px 0 0">Dieses Modul zeigt Beispieldaten zur Veranschaulichung. Die dargestellten Inhalte sind nicht real.</p></div></div><div style="display:flex;align-items:center;gap:8px"><span style="background:white;color:#EF7D00;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:800;letter-spacing:1px">DEMO</span></div></div></div>';
                            viewEl.insertBefore(banner, viewEl.firstChild);
                        }
                        // Diagonal watermark across content
                        if(!viewEl.querySelector('.demo-mode-watermark')) {
                            var wm = document.createElement('div');
                            wm.className = 'demo-mode-watermark';
                            wm.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:30;overflow:hidden';
                            var wmText = '';
                            for(var i=0;i<8;i++) {
                                wmText += '<div style="position:absolute;top:'+(i*180-50)+'px;left:-100px;right:-100px;text-align:center;transform:rotate(-25deg);font-size:64px;font-weight:900;color:rgba(239,125,0,0.06);letter-spacing:12px;white-space:nowrap;user-select:none">DEMO   DEMO   DEMO   DEMO</div>';
                            }
                            wm.innerHTML = wmText;
                            viewEl.style.position = 'relative';
                            viewEl.appendChild(wm);
                        }
                    }
                }
            });

            // Apply tab-level status
            var tabBtnSelectors = {
                verkauf: '.vk-tab-btn,[data-tab="pipeline"],[data-tab="woche"],[data-tab="auswertung"],[data-tab="training"],[data-tab="vkWissen"]',
                marketing: '.marketing-tab-btn',
                einkauf: '.ek-tab-btn',
                controlling: '.ctrl-tab-btn,[data-tab="cockpit"],[data-tab="bwa"],[data-tab="benchmark"],[data-tab="planist"],[data-tab="liquiditaet"],[data-tab="ctrlWissen"]',
                allgemein: '[id^="allgemeinTab-"]',
                support: '[id^="supportTab-"]'
            };
            Object.keys(sbModulConfig).forEach(function(modulKey) {
                var cfg = sbModulConfig[modulKey];
                if(!cfg || !cfg.tabs) return;
                Object.keys(cfg.tabs).forEach(function(tabKey) {
                    var tabStatus = cfg.tabs[tabKey];
                    // Find tab button by data-tab attribute
                    var tabBtn = document.querySelector('[data-tab="'+tabKey+'"]') || document.getElementById('allgemeinTab-'+tabKey) || document.getElementById('supportTab-'+tabKey);
                    // Find tab content
                    var contentIds = {
                        verkauf: 'vkTab',
                        marketing: 'marketingTab',
                        einkauf: 'ekTab',
                        controlling: 'ctrlTab',
                        allgemein: 'allgemeinTabContent-',
                        support: 'supportTabContent-'
                    };
                    var prefix = contentIds[modulKey] || '';
                    var tabContent = prefix ? document.getElementById(prefix + tabKey.charAt(0).toUpperCase()+tabKey.slice(1)) || document.getElementById(prefix + tabKey) : null;

                    if(tabBtn) {
                        if(tabStatus === 'deaktiviert') {
                            tabBtn.style.display = 'none';
                            if(tabContent) tabContent.style.display = 'none';
                        } else if(tabStatus === 'demo') {
                            tabBtn.style.display = '';
                            // Add demo indicator to tab button
                            if(!tabBtn.querySelector('.tab-demo-dot')) {
                                var dot = document.createElement('span');
                                dot.className = 'tab-demo-dot';
                                dot.style.cssText = 'display:inline-flex;align-items:center;margin-left:6px;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;background:linear-gradient(135deg,#F97316,#EA580C);color:white;letter-spacing:0.5px';
                                dot.textContent = 'DEMO';
                                tabBtn.appendChild(dot);
                            }
                            // Add demo banner inside tab content
                            if(tabContent && !tabContent.querySelector('.tab-demo-banner')) {
                                tabContent.style.position = 'relative';
                                var tb = document.createElement('div');
                                tb.className = 'tab-demo-banner';
                                tb.innerHTML = '<div style="background:linear-gradient(90deg,#EF7D00,#F59E0B);color:white;padding:10px 16px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;gap:8px;font-size:12px"><span style="font-size:16px">ðŸ‘ï¸</span><span><strong>Demo-Daten</strong> â€“ Dieser Bereich zeigt Beispieldaten.</span><span style="margin-left:auto;background:rgba(255,255,255,0.25);padding:2px 10px;border-radius:12px;font-weight:700;font-size:10px">DEMO</span></div>';
                                tabContent.insertBefore(tb, tabContent.firstChild);
                                // Watermark for tab
                                var twm = document.createElement('div');
                                twm.className = 'tab-demo-banner';
                                twm.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:20;overflow:hidden';
                                var twmH = '';
                                for(var wi=0;wi<5;wi++) twmH += '<div style="position:absolute;top:'+(wi*200)+'px;left:-50px;right:-50px;text-align:center;transform:rotate(-25deg);font-size:48px;font-weight:900;color:rgba(239,125,0,0.05);letter-spacing:10px;white-space:nowrap;user-select:none">DEMO   DEMO   DEMO</div>';
                                twm.innerHTML = twmH;
                                tabContent.appendChild(twm);
                            }
                        } else {
                            tabBtn.style.display = '';
                            var oldDot = tabBtn.querySelector('.tab-demo-dot');
                            if(oldDot) oldDot.remove();
                            // Clean up demo elements from tab content
                            if(tabContent) {
                                tabContent.querySelectorAll('.tab-demo-banner').forEach(function(el){ el.remove(); });
                            }
                        }
                    }
                });
            });

            // Apply widget-level status
            var startCfg = sbModulConfig['startseite'];
            if(startCfg && startCfg.widgets) {
                Object.keys(startCfg.widgets).forEach(function(wKey) {
                    var wStatus = startCfg.widgets[wKey];
                    var wEl = document.querySelector('[data-widget="'+wKey+'"]');
                    if(!wEl) return;
                    // Remove old demo overlay
                    var oldOverlay = wEl.querySelector('.widget-demo-overlay');
                    if(oldOverlay) oldOverlay.remove();

                    if(wStatus === 'deaktiviert') {
                        wEl.style.display = 'none';
                    } else if(wStatus === 'demo') {
                        wEl.style.display = '';
                        wEl.style.position = 'relative';
                        wEl.style.border = '2px dashed #F97316';
                        wEl.style.boxShadow = 'inset 0 0 0 1px rgba(249,115,22,0.1)';
                        // Badge top-right
                        var overlay = document.createElement('div');
                        overlay.className = 'widget-demo-overlay';
                        overlay.style.cssText = 'position:absolute;top:-1px;right:-1px;background:linear-gradient(135deg,#F97316,#EA580C);color:white;font-size:9px;font-weight:800;padding:3px 10px;border-radius:0 8px 0 8px;z-index:5;letter-spacing:0.5px';
                        overlay.textContent = 'DEMO';
                        wEl.appendChild(overlay);
                        // Subtle watermark
                        var wwm = document.createElement('div');
                        wwm.className = 'widget-demo-overlay';
                        wwm.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-20deg);font-size:28px;font-weight:900;color:rgba(249,115,22,0.06);letter-spacing:6px;pointer-events:none;white-space:nowrap;z-index:4;user-select:none';
                        wwm.textContent = 'DEMO';
                        wEl.appendChild(wwm);
                    } else {
                        wEl.style.display = '';
                        wEl.style.border = '';
                        wEl.style.boxShadow = '';
                    }
                });
            }

            // Wissen-Tabs: hide across modules if wissen deactivated
            var wissenStatus = sbModulStatus['wissen'] || 'aktiv';
            var wissenDisabled = wissenStatus === 'deaktiviert';
            ['vkWissen','mktWissen','ekWissen','ctrlWissen','wissen'].forEach(function(tabKey) {
                var btn = document.querySelector('[data-tab="'+tabKey+'"]') || document.getElementById('allgemeinTab-'+tabKey);
                if(btn) btn.style.display = wissenDisabled ? 'none' : '';
            });
        }

        // Current user state
        var currentRole = 'inhaber';
        var currentLocation = 'vitbikes-muenchen';
        var isPremium = true;

        // Location data
        var locations = {
            'vitbikes-muenchen': { name: 'vit:bikes MÃ¼nchen Sendling', premium: true },
            'vitbikes-berlin': { name: 'vit:bikes Berlin Mitte', premium: true },
            'vitbikes-hamburg': { name: 'vit:bikes Hamburg Altona', premium: true },
            'radhaus-koeln': { name: 'Radhaus KÃ¶ln', premium: false },
            'bikeshop-dresden': { name: 'BikeShop Dresden', premium: false }
        };

        // Update location info in login screen
        function updateLocationInfo() {
            const select = document.getElementById('locationSelect');
            const selectedOption = select.options[select.selectedIndex];
            const isPremiumLocation = selectedOption.dataset.premium === 'true';
            const badge = document.getElementById('locationBadge');
            
            if (isPremiumLocation) {
                badge.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-vit-orange to-yellow-500 text-white"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg> vit:bikes Partner - Alle Features</span>';
            } else {
                badge.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">ðŸ“¦ Basis-Version - Upgrade verfÃ¼gbar</span>';
            }
        }

        // Initialize location info on page load (only if login screen exists)
        if(document.getElementById('locationSelect')) { updateLocationInfo(); }
        
        // Auto-init: show home view and set defaults
        try { updateUIForRole(); updatePremiumFeatures(); } catch(e) { console.warn('Init:', e); }

        // Handle Login - Role & Location from email
        // === RECHTEMANAGEMENT ===
        // Rollen: inhaber, verkauf, werkstatt, buchhaltung (Standort-Ebene) + hq (HQ-Ebene)
        // Jeder Mitarbeiter kann MEHRERE Rollen haben
        var userAccounts = {
            'max@vitbikes-grafrath.de': {roles:['inhaber'],location:'grafrath',name:'Max Mustermann'},
            'sandra@vitbikes-grafrath.de': {roles:['inhaber','buchhaltung'],location:'grafrath',name:'Sandra Engelmann'},
            'verkauf@vitbikes-grafrath.de': {roles:['verkauf'],location:'grafrath',name:'Tom Berater'},
            'werkstatt@vitbikes-grafrath.de': {roles:['werkstatt'],location:'grafrath',name:'Felix Schrauber'},
            'anna@vitbikes-grafrath.de': {roles:['verkauf','werkstatt'],location:'grafrath',name:'Anna Allround'},
            'buchhaltung@vitbikes-grafrath.de': {roles:['buchhaltung'],location:'grafrath',name:'Petra Zahlen'},
            'hq@vitbikes.de': {roles:['hq'],location:'hq',name:'Lisa Zentrale'},
            'admin@vitbikes.de': {roles:['hq'],location:'hq',name:'Michael Stenzel'}
        };

        // Welche Rollen Zugriff auf welche Module haben
        var rolePermissions = {
            // View-Name: [erlaubte Rollen] â€” 'alle' = jede Standort-Rolle
            'home':           ['alle'],
            'kalender':       ['alle'],
            'todo':           ['alle'],
            'kommunikation':  ['alle'],
            'dashboards':     ['inhaber'],
            'allgemein':      ['inhaber','buchhaltung'],
            'verkauf':        ['inhaber','verkauf','buchhaltung'],
            'einkauf':        ['inhaber','werkstatt','buchhaltung'],
            'marketing':      ['inhaber','verkauf'],
            'controlling':    ['inhaber','buchhaltung'],
            'wissen':         ['alle'],
            'support':        ['alle'],
            'aktenschrank':   ['inhaber','buchhaltung'],
            'ideenboard':     ['alle'],
            'shop':           ['inhaber'],
            'onboarding':     ['inhaber'],
            'mitarbeiter':    ['inhaber']
        };

        // PrÃ¼ft ob der aktuelle User Zugriff auf eine View hat
        function hasAccess(viewName) {
            if(currentRole === 'hq') return viewName.indexOf('hq')===0 || viewName==='kalender' || viewName==='todo' || viewName==='kommunikation' || viewName==='devStatus';
            var perms = rolePermissions[viewName];
            if(!perms) return true;
            if(perms.indexOf('alle') >= 0) return true;
            for(var i=0; i<currentRoles.length; i++) {
                if(perms.indexOf(currentRoles[i]) >= 0) return true;
            }
            return false;
        }

        // PrÃ¼ft ob User eine bestimmte Rolle hat
        function hasRole(role) {
            return currentRoles.indexOf(role) >= 0;
        }

        // Aktuelle Rollen (Array)
        var currentRoles = ['inhaber'];

        function quickLogin(email) {
            document.getElementById('loginEmail').value = email;
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginPassword').focus();
        }

        // === PASSWORD RESET ===
        function showPasswordReset() {
            var html = '<div id="pwResetOverlay" onclick="closePwReset()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:28px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Passwort zuruecksetzen</h3><button onclick="closePwReset()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-500 mb-4">Gib deine E-Mail-Adresse ein. Du erhaeltst einen Link zum Zuruecksetzen deines Passworts.</p>';
            html += '<input id="pwResetEmail" type="email" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="deine@email.de">';
            html += '<div id="pwResetMsg" style="display:none" class="text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="pwResetBtn" onclick="submitPwReset()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Link senden</button>';
            html += '<button onclick="closePwReset()" class="w-full py-2.5 mt-2 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Zurueck zum Login</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'pwResetContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closePwReset() { var c = document.getElementById('pwResetContainer'); if(c) c.remove(); }
        async function submitPwReset() {
            var email = (document.getElementById('pwResetEmail') || {}).value;
            var msg = document.getElementById('pwResetMsg');
            var btn = document.getElementById('pwResetBtn');
            if (!email || !email.includes('@')) { msg.className = 'text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent = 'Bitte gib eine gueltige E-Mail ein.'; msg.style.display = 'block'; return; }
            btn.disabled = true; btn.textContent = 'Wird gesendet...';
            try {
                var resp = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + window.location.pathname });
                if (resp.error) throw resp.error;
                msg.className = 'text-sm rounded-lg p-3 mb-3 bg-green-50 border border-green-200 text-green-700';
                msg.textContent = 'Falls ein Account mit dieser E-Mail existiert, wurde ein Reset-Link gesendet. Pruefe deinen Posteingang.';
                msg.style.display = 'block';
                btn.textContent = 'Gesendet \u2713'; btn.disabled = true;
            } catch (e) {
                msg.className = 'text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600';
                msg.textContent = 'Fehler: ' + e.message;
                msg.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Link senden';
            }
        }

        // === REGISTRATION ===
        function showRegistration() {
            var loginForm = document.querySelector('#loginScreen form');
            var regLink = loginForm.parentElement.querySelector('.border-t');
            
            var html = '<div id="regOverlay" onclick="hideRegistration()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:28px;width:440px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Registrieren</h3><button onclick="hideRegistration()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-500 mb-4">Nach der Registrierung muss dein Account vom HQ freigeschaltet werden.</p>';
            html += '<div class="space-y-3 mb-5">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Vor- und Nachname *</label><input id="regName" type="text" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Max Mustermann"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail *</label><input id="regEmail" type="email" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@vitbikes-standort.de"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Passwort * (min. 6 Zeichen)</label><input id="regPassword" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="regStandort" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"><option value="">Wird geladen...</option></select></div>';
            html += '</div>';
            html += '<div id="regError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<div id="regSuccess" style="display:none" class="bg-green-50 border border-green-200 text-green-700 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="regSubmitBtn" onclick="submitRegistration()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">Registrieren</button>';
            html += '<button onclick="hideRegistration()" class="w-full py-2.5 mt-2 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">ZurÃ¼ck zum Login</button>';
            html += '</div></div>';
            
            var c = document.createElement('div');
            c.id = 'regContainer';
            c.innerHTML = html;
            document.body.appendChild(c);
            
            // Load standorte into dropdown
            setTimeout(async function(){
                try {
                    var stdResp = await sb.from('standorte').select('id,name').order('name');
                    var sel = document.getElementById('regStandort');
                    if(sel && stdResp.data) {
                        sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                        stdResp.data.forEach(function(s){ sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>'; });
                    }
                } catch(e){ console.error(e); }
            }, 100);
        }

        function hideRegistration() {
            var c = document.getElementById('regContainer');
            if(c) c.remove();
        }

        async function submitRegistration() {
            var name = (document.getElementById('regName')||{}).value||'';
            var email = (document.getElementById('regEmail')||{}).value||'';
            var pw = (document.getElementById('regPassword')||{}).value||'';
            var standortId = (document.getElementById('regStandort')||{}).value||'';
            var errEl = document.getElementById('regError');
            var sucEl = document.getElementById('regSuccess');
            var btn = document.getElementById('regSubmitBtn');
            
            if(errEl) errEl.style.display = 'none';
            if(sucEl) sucEl.style.display = 'none';
            
            if(!name.trim() || !email.trim() || !pw) {
                if(errEl) { errEl.textContent = 'Bitte alle Pflichtfelder ausfÃ¼llen.'; errEl.style.display = 'block'; }
                return;
            }
            if(pw.length < 8) {
                if(errEl) { errEl.textContent = 'Passwort muss mindestens 8 Zeichen haben.'; errEl.style.display = 'block'; }
                return;
            }
            
            if(btn) { btn.disabled = true; btn.textContent = 'Wird registriert...'; }
            
            // Vorname/Nachname aus dem Namen splitten
            var nameParts = name.trim().split(' ');
            var vorname = nameParts[0] || '';
            var nachname = nameParts.slice(1).join(' ') || '';
            
            try {
                // Auth-User erstellen via Standard signUp()
                // Der DB-Trigger handle_new_auth_user() erstellt automatisch:
                // - public.users Eintrag mit status='pending'
                // - HQ-Todo Notification
                // - Email-Queue Eintrag
                var authResp = await sb.auth.signUp({ 
                    email: email.trim().toLowerCase(), 
                    password: pw,
                    options: { 
                        data: { 
                            vorname: vorname,
                            nachname: nachname
                        } 
                    }
                });
                if(authResp.error) throw authResp.error;
                var newUserId = authResp.data.user ? authResp.data.user.id : null;
                
                // Optionalen Standort-Hinweis nachtrÃ¤glich setzen (hilft HQ bei Zuordnung)
                if(standortId && newUserId) {
                    // Kurz warten damit der Trigger den User in public.users erstellt hat
                    await new Promise(function(resolve){ setTimeout(resolve, 1500); });
                    try {
                        await sb.from('users').update({ standort_id: standortId }).eq('id', newUserId);
                    } catch(e) { console.warn('Standort-Hinweis konnte nicht gesetzt werden:', e); }
                }
                
                // Sofort ausloggen (signUp loggt automatisch ein)
                await sb.auth.signOut();
                
                if(sucEl) {
                    sucEl.innerHTML = '\u2705 <strong>Registrierung erfolgreich!</strong><br>Dein Account wartet auf Freigabe durch das HQ. Du wirst benachrichtigt, sobald dein Zugang freigeschaltet wurde.';
                    sucEl.style.display = 'block';
                }
                if(btn) { btn.style.display = 'none'; }
            } catch(err) {
                // Auch ausloggen falls teilweise erfolgreich
                try { await sb.auth.signOut(); } catch(e){}
                var msg = 'Fehler: ' + (err.message||err);
                if(err.message && err.message.includes('already registered')) {
                    msg = 'Diese E-Mail-Adresse ist bereits registriert. Bitte anmelden.';
                }
                if(errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
                if(btn) { btn.disabled = false; btn.textContent = 'Registrieren'; }
            }
        }

        async function handleLogin(event) {
            if(event) { event.preventDefault(); event.stopPropagation(); }
            var email = (document.getElementById('loginEmail')||{}).value||'';
            var pw = (document.getElementById('loginPassword')||{}).value||'';
            if(!email || !pw) { alert('Bitte E-Mail und Passwort eingeben.'); return false; }

            var loginBtn = document.querySelector('#loginScreen form button[type="submit"]');
            if(loginBtn) { loginBtn.disabled = true; loginBtn.textContent = 'Anmelden...'; }
            var errEl = document.getElementById('loginError');
            if(errEl) errEl.style.display = 'none';

            try {
                console.log('[Login] Signing in...');
                var resp = await sb.auth.signInWithPassword({ email: email, password: pw });
                if(resp.error) throw resp.error;
                sbUser = resp.data.user;
                console.log('[Login] Auth OK, user:', sbUser.id);
                
                // Status-Check: Was darf der User sehen?
                var profileResp = await sb.from('users').select('status').eq('id', sbUser.id).single();
                console.log('[Login] Profile status:', profileResp.data ? profileResp.data.status : 'no profile', profileResp.error ? profileResp.error.message : '');
                
                if(profileResp.data && (profileResp.data.status === 'pending' || profileResp.data.status === 'onboarding')) {
                    // Pending-Screen zeigen statt Fehlermeldung
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('pendingScreen').style.display = 'flex';
                    var pendingEmailEl = document.getElementById('pendingEmail');
                    if(pendingEmailEl) pendingEmailEl.textContent = email;
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                if(profileResp.data && (profileResp.data.status === 'offboarding' || profileResp.data.status === 'gesperrt')) {
                    // Gesperrt-Screen zeigen
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('blockedScreen').style.display = 'flex';
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                
                if(!profileResp.data) {
                    // Kein Profil gefunden â€“ wahrscheinlich Trigger-Problem, Pending zeigen
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('pendingScreen').style.display = 'flex';
                    var pendingEmailEl2 = document.getElementById('pendingEmail');
                    if(pendingEmailEl2) pendingEmailEl2.textContent = email;
                    if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
                    return false;
                }
                
                console.log('[Login] Loading profile...');
                await loadUserProfile(sbUser.id);
                console.log('[Login] Profile loaded, roles:', currentRoles);
                await loadModulStatus();
                console.log('[Login] Entering app...');
                enterApp();
                try { await loadPipelineFromSupabase(); } catch(e) { console.warn('[Login] Pipeline load optional:', e); }
            } catch(err) {
                console.error('[Login] ERROR:', err);
                if(errEl) { errEl.textContent = err.message || 'Login fehlgeschlagen'; errEl.style.display = 'block'; }
                else alert('Login fehlgeschlagen: ' + (err.message||err));
            } finally {
                if(loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Anmelden'; }
            }
            return false;
        }

        async function loadUserProfile(userId) {
            var resp1 = await sb.from('users').select('*, standorte(*)').eq('id', userId).single();
            if(resp1.error) { console.error('[Profile] Error:', resp1.error.message); throw resp1.error; }
            sbProfile = resp1.data;
            sbStandort = sbProfile ? sbProfile.standorte : null;
            var resp2 = await sb.from('user_rollen').select('rollen(name, label)').eq('user_id', userId);
            if(resp2.error) { console.error('[Roles] Error:', resp2.error.message); }
            sbRollen = (resp2.data || []).map(function(ur) { return ur.rollen; });
            var roleNames = sbRollen.map(function(r) { return r ? r.name : ''; }).filter(Boolean);
            currentRoles = roleNames.length > 0 ? roleNames : ['inhaber'];
            // is_hq from DB is the PRIMARY driver for HQ vs Standort view
            if(sbProfile && sbProfile.is_hq) {
                currentRole = 'hq';
            } else {
                currentRole = currentRoles.indexOf('inhaber') >= 0 ? 'inhaber' : currentRoles[0];
            }
            currentLocation = sbStandort ? sbStandort.slug : 'grafrath';
            isPremium = sbStandort ? sbStandort.is_premium : false;
        }


        // ======================================================
        // === DEMO / BETA BADGE SYSTEM ===
        // ======================================================
        // Module-Status: 'demo' = fake data (orange), 'teilweise'/'stub' = beta (purple), undefined = live

        function enterApp() {
            var userName = sbProfile ? sbProfile.name : 'Benutzer';
            var firstName = userName.split(' ')[0];
            var nameEl = document.querySelector('[data-user-name]');
            if(nameEl) nameEl.textContent = userName;
            var avatarEl = document.querySelector('.topnav-desktop img.rounded-full');
            if(avatarEl) avatarEl.src = 'https://ui-avatars.com/api/?name='+encodeURIComponent(userName)+'&background=EF7D00&color=fff';
            // Dynamic welcome text
            var welcomeEl = document.getElementById('welcomeText');
            if(welcomeEl) {
                var tpl = welcomeEl.textContent || 'Willkommen zurÃ¼ck, {name}!';
                welcomeEl.textContent = tpl.replace('{name}', firstName).replace('Max', firstName);
            }
            // Dynamic date
            var dateEl = document.getElementById('welcomeDate');
            var now = new Date();
            var days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
            var months = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var dateStr = 'Heute ist ' + days[now.getDay()] + ', ' + now.getDate() + '. ' + months[now.getMonth()] + ' ' + now.getFullYear();
            if(dateEl) dateEl.textContent = dateStr;
            var hqDateEl = document.getElementById('hqWelcomeDate');
            if(hqDateEl) hqDateEl.textContent = 'Willkommen zurueck Â· ' + dateStr;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            try { updateUIForRole(); updatePremiumFeatures(); } catch(e) { console.warn(e); }
            // Apply DEMO/BETA badges
            if(currentRole === 'hq') { switchViewMode('hq'); } else { showView('home'); }
            // Load dashboard widgets with live data
            if(currentRole !== 'hq') { loadDashboardWidgets(); loadAllgemeinData(); }
            // Check for pending approvals (HQ + GF only)
            checkPendingApprovals();
            // Check BWA deadlines and create reminders
            // Init Trainer Engine
            if(typeof _initTrainerEngine === 'function') _initTrainerEngine();
            checkBwaDeadlines();
        }

        // === DEMO MODE SYSTEM ===

        async function checkPendingApprovals() {
            var isHQ = currentRoles.indexOf('hq') >= 0 || (sbProfile && sbProfile.is_hq);
            var isGF = currentRoles.indexOf('inhaber') >= 0;
            if(!isHQ && !isGF) return;
            try {
                var query = sb.from('users').select('id,name,email,created_at').in('status',['onboarding','pending']);
                // GF: nur eigener Standort
                if(!isHQ && sbStandort) query = query.eq('standort_id', sbStandort.id);
                var resp = await query;
                if(resp.error || !resp.data) return;
                // Filter: nur User die wirklich keine Rollen haben
                var pendingUsers = [];
                for(var i=0; i<resp.data.length; i++) {
                    var rResp = await sb.from('user_rollen').select('id').eq('user_id', resp.data[i].id);
                    if(!rResp.data || rResp.data.length === 0) pendingUsers.push(resp.data[i]);
                }
                if(pendingUsers.length === 0) return;
                // Show notification banner
                var existing = document.getElementById('approvalBanner');
                if(existing) existing.remove();
                var names = pendingUsers.map(function(u){return u.name;}).join(', ');
                var banner = document.createElement('div');
                banner.id = 'approvalBanner';
                banner.innerHTML = '<div style="position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:9000;max-width:600px;width:90%;" class="bg-yellow-50 border border-yellow-300 rounded-xl shadow-lg px-5 py-3 flex items-center justify-between">'
                    + '<div class="flex items-center space-x-3">'
                    + '<span class="text-2xl">\u26a0\ufe0f</span>'
                    + '<div><p class="text-sm font-semibold text-yellow-800">' + pendingUsers.length + ' neue' + (pendingUsers.length===1?'r Mitarbeiter':' Mitarbeiter') + ' wartet auf Freigabe</p>'
                    + '<p class="text-xs text-yellow-600">' + names + '</p></div></div>'
                    + '<div class="flex items-center space-x-2">'
                    + '<button onclick="showView(\'kzMitarbeiter\');document.getElementById(\'approvalBanner\').remove();" class="px-3 py-1.5 bg-vit-orange text-white text-xs font-semibold rounded-lg hover:opacity-90">Jetzt freigeben</button>'
                    + '<button onclick="document.getElementById(\'approvalBanner\').remove();" class="text-yellow-400 hover:text-yellow-600 text-lg">\u2715</button>'
                    + '</div></div>';
                document.body.appendChild(banner);
            } catch(err) { console.warn('Approval check:', err); }
        }

        async function loadPipelineFromSupabase() {
            try {
                var resp = await sb.from('leads').select('*').order('created_at', { ascending: false });
                if(resp.error) throw resp.error;
                var stageMap = { 'neu':'lead','kontaktiert':'termin','angebot':'angebot','verhandlung':'beratung','gewonnen':'verkauft','verloren':'verloren' };
                verkaufData.pipeline = (resp.data||[]).map(function(l,i) {
                    var d = new Date(l.created_at);
                    return {
                        id: i+1, sb_id: l.id,
                        name: (l.vorname||'')+' '+(l.nachname||''),
                        type: l.interesse||'E-Bike',
                        seller: sbProfile ? sbProfile.name.split(' ')[0] : 'Team',
                        value: parseFloat(l.geschaetzter_wert)||0,
                        stage: stageMap[l.status]||'lead',
                        status_raw: l.status,
                        date: d.getDate().toString().padStart(2,'0')+'.'+(d.getMonth()+1).toString().padStart(2,'0')+'.'
                    };
                });
                if(document.getElementById('vkTabPipeline') && document.getElementById('vkTabPipeline').style.display !== 'none') renderPipeline();
            } catch(err) { console.error('Pipeline load error:', err); }
        }

        async function handleLogout() {
            await sb.auth.signOut();
            sbUser = null; sbProfile = null; sbRollen = []; sbStandort = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('pendingScreen').style.display = 'none';
            document.getElementById('blockedScreen').style.display = 'none';
        }

        async function checkSession() {
            // Detect password recovery from reset link
            var hash = window.location.hash;
            if (hash && hash.includes('type=recovery')) {
                // Supabase will auto-set session from hash
                var resp = await sb.auth.getSession();
                if (resp.data.session) {
                    sbUser = resp.data.session.user;
                    showChangePasswordModal();
                    return;
                }
            }
            var resp = await sb.auth.getSession();
            if(resp.data.session && resp.data.session.user) {
                sbUser = resp.data.session.user;
                try {
                    // Status-Check vor dem App-Laden
                    var profileResp = await sb.from('users').select('status').eq('id', sbUser.id).single();
                    
                    if(profileResp.data && (profileResp.data.status === 'pending' || profileResp.data.status === 'onboarding')) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('pendingScreen').style.display = 'flex';
                        var pe = document.getElementById('pendingEmail');
                        if(pe) pe.textContent = sbUser.email || '';
                        return;
                    }
                    if(profileResp.data && (profileResp.data.status === 'offboarding' || profileResp.data.status === 'gesperrt')) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('blockedScreen').style.display = 'flex';
                        return;
                    }
                    
                    await loadUserProfile(sbUser.id);
                    await loadModulStatus();
                    enterApp();
                } catch(e) { console.warn('Auto-login failed:', e); }
            }
        }

        function showChangePasswordModal() {
            var html = '<div id="changePwOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div style="background:white;border-radius:16px;padding:28px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDD12 '+t('pw_change_title')+'</h3></div>';
            html += '<p class="text-sm text-gray-500 mb-4">'+t('pw_change_desc')+'</p>';
            html += '<input id="newPw1" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="'+t('pw_change_new')+'">';
            html += '<input id="newPw2" type="password" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm mb-3" placeholder="'+t('pw_change_repeat')+'">';
            html += '<div id="changePwMsg" style="display:none" class="text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button id="changePwBtn" onclick="submitNewPassword()" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">'+t('pw_change_save')+'</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'changePwContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        async function submitNewPassword() {
            var pw1 = (document.getElementById('newPw1') || {}).value;
            var pw2 = (document.getElementById('newPw2') || {}).value;
            var msg = document.getElementById('changePwMsg');
            var btn = document.getElementById('changePwBtn');
            if (!pw1 || pw1.length < 6) { msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent='Mindestens 6 Zeichen.'; msg.style.display='block'; return; }
            if (pw1 !== pw2) { msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600'; msg.textContent='Passwoerter stimmen nicht ueberein.'; msg.style.display='block'; return; }
            btn.disabled = true; btn.textContent = 'Wird gespeichert...';
            try {
                var resp = await sb.auth.updateUser({ password: pw1 });
                if (resp.error) throw resp.error;
                msg.className='text-sm rounded-lg p-3 mb-3 bg-green-50 border border-green-200 text-green-700';
                msg.textContent='Passwort erfolgreich geaendert! Du wirst weitergeleitet...';
                msg.style.display='block';
                // Clear hash and redirect
                window.location.hash = '';
                setTimeout(function() {
                    var c = document.getElementById('changePwContainer'); if(c) c.remove();
                    checkSession();
                }, 1500);
            } catch(e) {
                msg.className='text-sm rounded-lg p-3 mb-3 bg-red-50 border border-red-200 text-red-600';
                msg.textContent='Fehler: '+e.message; msg.style.display='block';
                btn.disabled=false; btn.textContent='Passwort speichern';
            }
        }


        // Update UI based on role
        function updateUIForRole() {
            // Rollen-Texte
            var roleLabels = {
                'inhaber': 'GeschÃ¤ftsleitung',
                'verkauf': 'Verkauf',
                'werkstatt': 'Werkstatt',
                'buchhaltung': 'Buchhaltung',
                'hq': 'HQ'
            };

            // Rollen-Anzeige zusammenbauen
            if(!currentRoles || !Array.isArray(currentRoles)) currentRoles = ['inhaber'];
            var roleDisplay = currentRoles.map(function(r){ return roleLabels[r]||r; }).join(', ');

            // Location name from Supabase
            var locationName = sbStandort ? sbStandort.name : 'Standort';
            var isHQ = currentRole === 'hq' || (sbProfile && sbProfile.is_hq);
            
            var userRoleText = document.getElementById('userRoleText');
            var locationDisplay = document.getElementById('locationDisplay');
            var locationDisplayMobile = document.getElementById('locationDisplayMobile');
            var userRoleDisplay = document.getElementById('userRoleDisplay');
            
            var displayLocation = isHQ ? 'ðŸ¢ HQ â€“ Netzwerk' : locationName;
            if (userRoleText) userRoleText.textContent = roleDisplay;
            if (locationDisplay) locationDisplay.textContent = displayLocation;
            if (locationDisplayMobile) locationDisplayMobile.textContent = displayLocation;
            if (userRoleDisplay) userRoleDisplay.textContent = isHQ ? '' : '';

            // Premium Badge
            var premiumBadge = document.getElementById('premiumBadge');
            if (premiumBadge) {
                if (isPremium) {
                    premiumBadge.innerHTML = '<span class="premium-badge">PREMIUM</span>';
                    premiumBadge.classList.remove('view-hidden');
                } else {
                    premiumBadge.classList.add('view-hidden');
                }
            }

            var isInhaber = hasRole('inhaber');

            // HQ Toggle anzeigen fÃ¼r Inhaber
            var hqToggle = document.getElementById('hqToggleSection');
            if(hqToggle) hqToggle.classList.toggle('hidden', !isInhaber);
            var btnStandort = document.getElementById('btnModeStandort');
            var btnHQ = document.getElementById('btnModeHQ');
            if(btnStandort) btnStandort.className = 'flex-1 py-2 px-3 rounded-md text-xs font-bold transition ' + (isHQ ? 'text-white/60 hover:text-white' : 'bg-white text-gray-800');
            if(btnHQ) btnHQ.className = 'flex-1 py-2 px-3 rounded-md text-xs font-bold transition ' + (isHQ ? 'bg-white text-gray-800' : 'text-white/60 hover:text-white');

            // === SIDEBAR VISIBILITY ===
            // Partner QuickNav (Startseite, Kalender, Aufgaben, Kommunikation) - alle Standort-Rollen
            var partnerQuickNav = document.getElementById('partnerQuickNav');
            if(partnerQuickNav) partnerQuickNav.classList.toggle('hidden', isHQ);

            // Dashboards - nur Inhaber
            var ownerDashboards = document.getElementById('ownerDashboards');
            if(ownerDashboards) ownerDashboards.classList.toggle('hidden', !isInhaber || isHQ);

            // Fachbereiche Container
            var commonTools = document.getElementById('commonTools');
            if(commonTools) commonTools.classList.toggle('hidden', isHQ);

            // Einzelne Fachbereich-Buttons per Rolle steuern
            var sidebarViews = {
                'allgemein': ['inhaber','buchhaltung'],
                'verkauf': ['inhaber','verkauf','buchhaltung'],
                'einkauf': ['inhaber','werkstatt','buchhaltung'],
                'marketing': ['inhaber','verkauf'],
                'controlling': ['inhaber','buchhaltung']
            };
            Object.keys(sidebarViews).forEach(function(viewName){
                var btns = document.querySelectorAll('[onclick*=\"showView(\\\''+viewName+'\\\')\"]');
                btns.forEach(function(btn){
                    var allowed = false;
                    sidebarViews[viewName].forEach(function(r){ if(hasRole(r)) allowed=true; });
                    btn.classList.toggle('hidden', !allowed);
                });
            });

            // Tools-Bereich Einzelsteuerung
            var toolViews = {
                'wissen': ['alle'],
                'support': ['alle'],
                'aktenschrank': ['inhaber','buchhaltung'],
                'ideenboard': ['alle'],
                'shop': ['inhaber']
            };
            Object.keys(toolViews).forEach(function(viewName){
                var btns = document.querySelectorAll('[onclick*=\"showView(\\\''+viewName+'\\\')\"]');
                btns.forEach(function(btn){
                    if(isHQ) { btn.classList.add('hidden'); return; }
                    var perms = toolViews[viewName];
                    var allowed = perms.indexOf('alle')>=0;
                    if(!allowed) perms.forEach(function(r){ if(hasRole(r)) allowed=true; });
                    btn.classList.toggle('hidden', !allowed);
                });
            });

            // Onboarding - nur Inhaber
            var onboardingNav = document.getElementById('onboardingNavSection');
            if(onboardingNav) onboardingNav.classList.toggle('hidden', !isInhaber || isHQ);

            // Mitarbeiter - nur Inhaber
            var mitarbeiterNav = document.getElementById('mitarbeiterNavSection');
            if(mitarbeiterNav) mitarbeiterNav.classList.toggle('hidden', !isInhaber || isHQ);

            // Partner Tools (Wissen, Support, Ideenboard, Shop) - alle Standort-Rollen
            var partnerToolsNav = document.getElementById('partnerToolsNav');
            if(partnerToolsNav) partnerToolsNav.classList.toggle('hidden', isHQ);

            // HQ Menu
            var hqMenu = document.getElementById('hqMenu');
            if(hqMenu) hqMenu.classList.toggle('hidden', !isHQ);
        }

        // Switch between Chat and Forum in Communication view
        function switchCommunicationTab(tab) {
            const chatTab = document.getElementById('chatTab');
            const forumTab = document.getElementById('forumTab');
            const chatSection = document.getElementById('chatSection');
            const forumSection = document.getElementById('forumSection');
            
            if (tab === 'chat') {
                chatTab.classList.remove('bg-gray-200', 'text-gray-700');
                chatTab.classList.add('bg-vit-orange', 'text-white');
                forumTab.classList.remove('bg-vit-orange', 'text-white');
                forumTab.classList.add('bg-gray-200', 'text-gray-700');
                chatSection.style.display = 'block';
                forumSection.style.display = 'none';
            } else {
                forumTab.classList.remove('bg-gray-200', 'text-gray-700');
                forumTab.classList.add('bg-vit-orange', 'text-white');
                chatTab.classList.remove('bg-vit-orange', 'text-white');
                chatTab.classList.add('bg-gray-200', 'text-gray-700');
                forumSection.style.display = 'block';
                chatSection.style.display = 'none';
            }
        }

        // Update premium features visibility
        function updatePremiumFeatures() {
            const premiumMenuItems = document.querySelectorAll('.premium-menu-item');
            const premiumFeatures = document.querySelectorAll('.premium-feature');
            
            premiumMenuItems.forEach(item => {
                if (!isPremium) {
                    item.classList.add('locked-menu-item');
                    item.onclick = function(e) {
                        e.preventDefault();
                        showPremiumUpgradeModal();
                    };
                } else {
                    item.classList.remove('locked-menu-item');
                }
            });

            premiumFeatures.forEach(feature => {
                if (!isPremium) {
                    feature.classList.add('locked');
                } else {
                    feature.classList.remove('locked');
                }
            });
        }

        // Show premium upgrade modal
        function showPremiumUpgradeModal() {
            alert('ðŸ”’ Premium Feature\n\nDiese Funktion ist nur fÃ¼r vit:bikes Franchisenehmer verfÃ¼gbar.\n\nâœ¨ Werde vit:bikes Partner und erhalte Zugang zu:\nâ€¢ Marketing-Materialien vom HQ\nâ€¢ Best Practice Forum\nâ€¢ Einkaufsvorteile\nâ€¢ Schulungen & Support\n\nInteresse? Kontaktiere uns unter: partner@vitbikes.de');
        }

        // Show specific view
        
        // Dashboard Widget Management
        let dashboardEditMode = false;
        
        function toggleDashboardEdit() {
            dashboardEditMode = !dashboardEditMode;
            const addPanel = document.getElementById('widgetAddPanel');
            const removeButtons = document.querySelectorAll('.widget-remove');
            const editButton = document.getElementById('dashboardEditButton');
            
            if (dashboardEditMode) {
                addPanel.classList.remove('hidden');
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
                editButton.textContent = 'Fertig';
            } else {
                addPanel.classList.add('hidden');
                removeButtons.forEach(btn => btn.classList.add('hidden'));
                editButton.textContent = 'Dashboard anpassen';
            }
        }
        
        function addWidget(widgetName) {
            const widget = document.querySelector(`[data-widget="${widgetName}"]`);
            if (widget) {
                widget.style.display = 'block';
                showToast(`Widget "${widgetName}" hinzugefÃ¼gt`);
            }
        }
        
        // Widget Remove (Event Delegation)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.widget-remove')) {
                const widget = e.target.closest('.dashboard-widget');
                const widgetName = widget.getAttribute('data-widget');
                widget.style.display = 'none';
                showToast(`Widget "${widgetName}" entfernt`);
            }
        });
        
        // Tab Switching Functions
        
        function showMarketingTab(tabName) {
            // Hide all marketing tabs
            document.querySelectorAll('.marketing-tab-content').forEach(function(tab) { tab.style.display = 'none'; });
            
            // Reset all tab buttons
            document.querySelectorAll('.marketing-tab-btn').forEach(function(btn) {
                btn.className = 'marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            
            // Show selected tab content
            var tabId = 'marketingTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            var tabEl = document.getElementById(tabId);
            if (tabEl) tabEl.style.display = 'block';
            
            // Highlight active tab button
            var activeBtn = document.querySelector('.marketing-tab-btn[data-tab="' + tabName + '"]');
            if (activeBtn) {
                activeBtn.className = 'marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            }

            // Init Social Media themen on first open
            if(tabName==='social') { renderSmThemen(); }
            if(tabName==='budget') { renderMktSpendingChart(); }
            if(tabName==='leads') { renderMktLeadChart(); }
        }
        
        // === VERKAUF MODULE ===
        var verkaufData = {
            sellers: [
                {
                    name: 'Sandra', plan_soll: 10, gesamt_ist: 2, verkauft: 1, umsatz_kw: 7091, umsatz_jahr: 16192, vk_jahr: 6,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:5024},
                        {day:'Do',plan:2,gesamt:1,geplant:0,spontan:0,online:1,ergo:0,verkauft:1,uebergabe:0,umsatz:2067},
                        {day:'Fr',plan:2,gesamt:1,geplant:0,spontan:1,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:2,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Thomas', plan_soll: 0, gesamt_ist: 0, verkauft: 0, umsatz_kw: 0, umsatz_jahr: 17419, vk_jahr: 4,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Do',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Fr',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Dirk', plan_soll: 15, gesamt_ist: 2, verkauft: 0, umsatz_kw: 8569, umsatz_jahr: 36629, vk_jahr: 6,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:253},
                        {day:'Mi',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:4801},
                        {day:'Do',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:59},
                        {day:'Fr',plan:3,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:1,umsatz:3456},
                        {day:'Sa',plan:3,gesamt:2,geplant:0,spontan:2,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}
                    ]
                },
                {
                    name: 'Max', plan_soll: 0, gesamt_ist: 0, verkauft: 0, umsatz_kw: 1396, umsatz_jahr: 3813, vk_jahr: 0,
                    daily: [
                        {day:'Mo',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Di',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Mi',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:737},
                        {day:'Do',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Fr',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0},
                        {day:'Sa',plan:0,gesamt:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:659}
                    ]
                }
            ],
            jahres: [
                {monat:'Januar',plan:57025,ist:57025,termine_soll:24,termine_ist:12,verkauft:11,quote:92,avg:5184},
                {monat:'Februar',plan:77734,ist:17057,termine_soll:32,termine_ist:8,verkauft:5,quote:63,avg:3411},
                {monat:'Maerz',plan:150406,ist:0,termine_soll:62,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'April',plan:121269,ist:0,termine_soll:50,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Mai',plan:163470,ist:0,termine_soll:68,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Juni',plan:157808,ist:0,termine_soll:65,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Juli',plan:138764,ist:0,termine_soll:57,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'August',plan:76258,ist:0,termine_soll:32,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'September',plan:86544,ist:0,termine_soll:36,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Oktober',plan:73018,ist:0,termine_soll:30,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'November',plan:40796,ist:0,termine_soll:17,termine_ist:0,verkauft:0,quote:0,avg:0},
                {monat:'Dezember',plan:24597,ist:0,termine_soll:10,termine_ist:0,verkauft:0,quote:0,avg:0}
            ],
            pipeline: [
                {id:1,name:'Fam. Mueller',type:'E-Bike Trekking',seller:'Sandra',value:4500,stage:'termin',date:'17.02.'},
                {id:2,name:'Hr. Schneider',type:'E-Bike MTB',seller:'Dirk',value:5200,stage:'beratung',date:'15.02.'},
                {id:3,name:'Fr. Weber',type:'E-Bike City',seller:'Sandra',value:3200,stage:'angebot',date:'14.02.'},
                {id:4,name:'Hr. Becker',type:'Rennrad',seller:'Thomas',value:2800,stage:'angebot',date:'13.02.'},
                {id:5,name:'Fam. Schmidt',type:'E-Bike Cargo',seller:'Dirk',value:6500,stage:'lead',date:'16.02.'},
                {id:6,name:'Fr. Klein',type:'E-Bike Trekking',seller:'Sandra',value:3800,stage:'termin',date:'18.02.'},
                {id:7,name:'Hr. Wagner',type:'MTB',seller:'Thomas',value:1900,stage:'lead',date:'16.02.'},
                {id:8,name:'Fr. Hoffmann',type:'E-Bike City',seller:'Dirk',value:3400,stage:'beratung',date:'14.02.'},
                {id:9,name:'Hr. Braun',type:'E-Bike Trekking',seller:'Sandra',value:4200,stage:'verkauft',date:'12.02.'},
                {id:10,name:'Fr. Richter',type:'E-Bike MTB',seller:'Dirk',value:5800,stage:'verkauft',date:'11.02.'},
                {id:11,name:'Hr. Wolf',type:'E-Bike City',seller:'Thomas',value:2900,stage:'verkauft',date:'10.02.'},
                {id:12,name:'Fam. Koch',type:'E-Bike Trekking',seller:'Dirk',value:4100,stage:'uebergabe',date:'08.02.'},
                {id:13,name:'Hr. Neumann',type:'Rennrad',seller:'Thomas',value:3200,stage:'verloren',date:'09.02.'},
                {id:14,name:'Fr. Schwarz',type:'E-Bike City',seller:'Sandra',value:2700,stage:'verloren',date:'07.02.'}
            ]
        };

        var pipelineStages = [
            {id:'lead',label:'Lead',color:'bg-gray-100 border-gray-300'},
            {id:'termin',label:'Termin gebucht',color:'bg-blue-50 border-blue-300'},
            {id:'beratung',label:'In Beratung',color:'bg-yellow-50 border-yellow-300'},
            {id:'angebot',label:'Angebot',color:'bg-purple-50 border-purple-300'},
            {id:'verkauft',label:'Verkauft',color:'bg-green-50 border-green-300'},
            {id:'uebergabe',label:'Uebergabe',color:'bg-emerald-50 border-emerald-300'},
            {id:'verloren',label:'Nicht gekauft',color:'bg-red-50 border-red-300'}
        ];

        function renderWeekView() {
            var filter = document.getElementById('weekSellerFilter').value;
            var sellers = filter === 'all' ? verkaufData.sellers : verkaufData.sellers.filter(function(s){return s.name === filter;});
            
            // Calculate KPIs
            var totalPlan = 0, totalGesamt = 0, totalVerkauft = 0, totalUmsatz = 0;
            sellers.forEach(function(s) {
                totalPlan += s.plan_soll;
                s.daily.forEach(function(d) {
                    totalGesamt += d.gesamt;
                    totalVerkauft += d.verkauft;
                    totalUmsatz += d.umsatz;
                });
            });
            document.getElementById('wkPlan').textContent = totalPlan;
            document.getElementById('wkGesamt').textContent = totalGesamt;
            document.getElementById('wkVerkauft').textContent = totalVerkauft;
            document.getElementById('wkUmsatz').textContent = totalUmsatz.toLocaleString('de-DE') + ' \u20AC';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            var quoteEl = document.getElementById('wkQuote');
            quoteEl.textContent = quoteVal + '%';
            quoteEl.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600');

            // Render seller tables
            var container = document.getElementById('weekSellerTables');
            var html = '';
            sellers.forEach(function(s) {
                var sUmsatz = 0, sGesamt = 0, sVerkauft = 0;
                s.daily.forEach(function(d) { sUmsatz += d.umsatz; sGesamt += d.gesamt; sVerkauft += d.verkauft; });
                var sQuote = sGesamt > 0 ? Math.round((sVerkauft/sGesamt)*100) : 0;

                html += '<div class="vit-card overflow-hidden">';
                html += '<div class="flex items-center justify-between p-4 bg-gray-50 border-b">';
                html += '<div class="flex items-center space-x-3"><div class="w-8 h-8 bg-vit-orange rounded-full flex items-center justify-center text-white font-bold text-sm">' + s.name.charAt(0) + '</div>';
                html += '<div><p class="font-semibold text-gray-800">' + s.name + '</p><p class="text-xs text-gray-500">Plan: ' + s.plan_soll + ' Termine</p></div></div>';
                html += '<div class="flex space-x-4 text-center">';
                html += '<div><p class="text-xs text-gray-500">Beratungen</p><p class="font-bold text-blue-600">' + sGesamt + '</p></div>';
                html += '<div><p class="text-xs text-gray-500">Verkauft</p><p class="font-bold text-green-600">' + sVerkauft + '</p></div>';
                html += '<div><p class="text-xs text-gray-500">Umsatz</p><p class="font-bold text-vit-orange">' + sUmsatz.toLocaleString('de-DE') + ' \u20AC</p></div>';
                html += '<div><p class="text-xs text-gray-500">Quote</p><p class="font-bold ' + (sQuote >= 70 ? 'text-green-600' : sQuote >= 40 ? 'text-orange-600' : 'text-red-600') + '">' + sQuote + '%</p></div>';
                html += '</div></div>';

                // Daily table
                html += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                html += '<thead><tr class="bg-gray-50 text-xs"><th class="py-2 px-3 text-left text-gray-500">Tag</th><th class="py-2 px-3 text-center text-gray-500">Plan</th><th class="py-2 px-3 text-center text-blue-600">Geplant</th><th class="py-2 px-3 text-center text-purple-600">Spontan</th><th class="py-2 px-3 text-center text-cyan-600">Online</th><th class="py-2 px-3 text-center text-pink-600">Ergo</th><th class="py-2 px-3 text-center font-bold text-gray-700">Gesamt</th><th class="py-2 px-3 text-center text-green-600">Verkauft</th><th class="py-2 px-3 text-center text-gray-500">Uebergabe</th><th class="py-2 px-3 text-right text-vit-orange">Umsatz</th></tr></thead>';
                html += '<tbody>';
                s.daily.forEach(function(d) {
                    var total = d.geplant + d.spontan + d.online + d.ergo;
                    var hasData = d.plan > 0 || total > 0 || d.umsatz > 0;
                    html += '<tr class="border-b ' + (hasData ? '' : 'text-gray-300') + '">';
                    html += '<td class="py-2 px-3 font-semibold">' + d.day + '</td>';
                    html += '<td class="py-2 px-3 text-center">' + (d.plan || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-blue-600">' + (d.geplant || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-purple-600">' + (d.spontan || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-cyan-600">' + (d.online || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-pink-600">' + (d.ergo || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center font-bold">' + (total || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center text-green-600 font-bold">' + (d.verkauft || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-center">' + (d.uebergabe || '-') + '</td>';
                    html += '<td class="py-2 px-3 text-right font-semibold ' + (d.umsatz > 0 ? 'text-vit-orange' : '') + '">' + (d.umsatz > 0 ? d.umsatz.toLocaleString('de-DE') + ' \u20AC' : '-') + '</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div></div>';
            });
            container.innerHTML = html;
        }

        function renderPipeline() {
            var filterEl = document.getElementById('pipelineFilter');
            if(!filterEl) return; // React pipeline active, skip legacy render
            var filter = filterEl.value;
            var leads = filter === 'all' ? verkaufData.pipeline : verkaufData.pipeline.filter(function(l){return l.seller === filter;});
            var board = document.getElementById('kanbanBoard');
            var html = '';

            pipelineStages.forEach(function(stage) {
                var stageLeads = leads.filter(function(l){return l.stage === stage.id;});
                var stageValue = 0;
                stageLeads.forEach(function(l){stageValue += l.value;});

                html += '<div class="min-w-[220px] flex-shrink-0">';
                html += '<div class="mb-3 flex items-center justify-between">';
                html += '<h3 class="font-semibold text-gray-700 text-sm">' + stage.label + '</h3>';
                html += '<span class="text-xs font-bold bg-gray-200 text-gray-600 rounded-full px-2 py-0.5">' + stageLeads.length + '</span>';
                html += '</div>';
                html += '<div class="space-y-2 min-h-[100px] p-2 rounded-lg border-2 border-dashed ' + stage.color + '">';

                stageLeads.forEach(function(lead) {
                    html += '<div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition">';
                    html += '<div class="flex items-center justify-between mb-1"><p class="font-semibold text-gray-800 text-sm">' + lead.name + '</p></div>';
                    html += '<p class="text-xs text-gray-500">' + lead.type + '</p>';
                    html += '<div class="flex items-center justify-between mt-2">';
                    html += '<span class="text-xs text-gray-400">' + lead.seller + ' Â· ' + lead.date + '</span>';
                    html += '<span class="text-sm font-bold text-vit-orange">' + lead.value.toLocaleString('de-DE') + ' \u20AC</span>';
                    html += '</div>';
                    // Stage move buttons
                    var stageIdx = -1;
                    for(var si=0;si<pipelineStages.length;si++){if(pipelineStages[si].id===lead.stage)stageIdx=si;}
                    html += '<div class="flex space-x-1 mt-2">';
                    if(stageIdx > 0) html += '<button onclick="moveLead('+lead.id+',\'' + pipelineStages[stageIdx-1].id + '\')" class="flex-1 text-xs py-1 bg-gray-100 rounded hover:bg-gray-200">&#9664;</button>';
                    if(stageIdx < pipelineStages.length-1) html += '<button onclick="moveLead('+lead.id+',\'' + pipelineStages[stageIdx+1].id + '\')" class="flex-1 text-xs py-1 bg-gray-100 rounded hover:bg-gray-200">&#9654;</button>';
                    html += '</div>';
                    html += '</div>';
                });

                if(stageLeads.length > 0) {
                    html += '<div class="text-center text-xs text-gray-400 mt-2 pt-2 border-t border-gray-200">' + stageValue.toLocaleString('de-DE') + ' \u20AC</div>';
                }
                html += '</div></div>';
            });
            board.innerHTML = html;
        }

        function moveLead(id, newStage) {
            for(var i=0; i<verkaufData.pipeline.length; i++) {
                if(verkaufData.pipeline[i].id === id) {
                    verkaufData.pipeline[i].stage = newStage;
                    break;
                }
            }
            renderPipeline();
        }

        function showNewLeadModal() {
            document.getElementById('newLeadModal').classList.remove('hidden');
        }

        async function addNewLead() {
            var nameVal = document.getElementById('leadName').value || 'Neuer Kunde';
            var type = document.getElementById('leadType').value;
            var value = parseInt(document.getElementById('leadValue').value) || 3000;
            var notes = document.getElementById('leadNotes') ? document.getElementById('leadNotes').value : '';

            if(!sbUser) { alert('Nicht eingeloggt.'); return; }

            var nameParts = nameVal.trim().split(' ');
            var vorname = nameParts[0] || nameVal;
            var nachname = nameParts.slice(1).join(' ') || '';

            try {
                var resp = await sb.from('leads').insert({
                    standort_id: sbProfile.standort_id,
                    erstellt_von: sbUser.id,
                    vorname: vorname,
                    nachname: nachname,
                    interesse: type,
                    geschaetzter_wert: value,
                    notizen: notes,
                    status: 'neu',
                    quelle: 'walk_in',
                    prioritaet: 'mittel'
                });
                if(resp.error) throw resp.error;

                document.getElementById('newLeadModal').classList.add('hidden');
                document.getElementById('leadName').value = '';
                document.getElementById('leadValue').value = '';
                if(document.getElementById('leadNotes')) document.getElementById('leadNotes').value = '';
                await loadPipelineFromSupabase();
            } catch(err) {
                alert('Fehler: ' + err.message);
            }
        }

        function renderJahresTabelle() {
            var tbody = document.getElementById('jahresTabelle');
            if(!tbody) return;
            var html = '';
            var totals = {plan:0,ist:0,tSoll:0,tIst:0,vk:0};
            verkaufData.jahres.forEach(function(m, idx) {
                var diff = m.ist - m.plan;
                var isCurrent = (idx === 1);
                var isFuture = m.ist === 0 && idx > 1;
                totals.plan += m.plan; totals.ist += m.ist; totals.tSoll += m.termine_soll; totals.tIst += m.termine_ist; totals.vk += m.verkauft;
                html += '<tr class="border-b ' + (isCurrent ? 'bg-blue-50 border-l-4 border-blue-400' : '') + ' ' + (isFuture ? 'text-gray-400' : '') + '">';
                html += '<td class="py-2.5 px-3 font-semibold">' + m.monat + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + m.plan.toLocaleString('de-DE') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.ist > 0 ? m.ist.toLocaleString('de-DE') : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 ' + (diff > 0 ? 'text-green-600' : diff < 0 && !isFuture ? 'text-red-600' : '') + ' font-semibold">' + (m.ist > 0 ? (diff > 0 ? '+' : '') + diff.toLocaleString('de-DE') : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + m.termine_soll + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.termine_ist > 0 ? m.termine_ist : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 font-bold text-green-600">' + (m.verkauft > 0 ? m.verkauft : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3 ' + (m.quote >= 70 ? 'text-green-600' : m.quote > 0 ? 'text-orange-600' : '') + '">' + (m.quote > 0 ? m.quote + '%' : '\u2014') + '</td>';
                html += '<td class="text-right py-2.5 px-3">' + (m.avg > 0 ? m.avg.toLocaleString('de-DE') + ' \u20AC' : '\u2014') + '</td>';
                html += '</tr>';
            });
            // Totals
            var totalQuote = totals.tIst > 0 ? Math.round((totals.vk/totals.tIst)*100) : 0;
            html += '<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.plan.toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.ist.toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold text-red-600">' + (totals.ist - totals.plan).toLocaleString('de-DE') + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.tSoll + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totals.tIst + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold text-green-600">' + totals.vk + '</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + totalQuote + '%</td>';
            html += '<td class="text-right py-3 px-3 font-bold">' + (totals.vk > 0 ? Math.round(totals.ist/totals.vk).toLocaleString('de-DE') + ' \u20AC' : '\u2014') + '</td>';
            html += '</tr>';
            tbody.innerHTML = html;
        }

        function showVerkaufTab(tabName) {
            document.querySelectorAll('.vk-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.vk-tab-btn').forEach(function(b){
                b.className='vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabId='vkTab'+tabName.charAt(0).toUpperCase()+tabName.slice(1);
            var el=document.getElementById(tabId);
            if(el) el.style.display='block';
            var btn=document.querySelector('.vk-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='woche') loadWeekFromDb();
            if(tabName==='pipeline') mountReactPipeline();
            if(tabName==='auswertung') renderJahresTabelle();
        }

        function changeWeek(dir) {
            if(!currentWeekStart) { currentWeekStart = getMonday(new Date()); }
            var d = new Date(currentWeekStart);
            d.setDate(d.getDate() + dir * 7);
            currentWeekStart = d;
            loadWeekFromDb();
        }
        function getMonday(d) { var day = d.getDay(); var diff = d.getDate() - day + (day === 0 ? -6 : 1); var m = new Date(d); m.setDate(diff); m.setHours(0,0,0,0); return m; }
        function getKW(d) { var t = new Date(d.getFullYear(), 0, 1); var dn = ((d - t) / 86400000); return Math.ceil((dn + t.getDay() + 1) / 7); }
        var currentWeekStart = null;
        var weekDbData = null;

        async function loadWeekFromDb() {
            if(!currentWeekStart) currentWeekStart = getMonday(new Date());
            var mon = currentWeekStart;
            var sun = new Date(mon); sun.setDate(mon.getDate() + 5); // Mo-Sa
            var monStr = mon.toISOString().slice(0,10);
            var sunStr = sun.toISOString().slice(0,10);
            // Update header
            var kw = getKW(mon);
            var fmt = function(d) { return d.getDate().toString().padStart(2,'0') + '.' + (d.getMonth()+1).toString().padStart(2,'0') + '.'; };
            var titleEl = document.getElementById('weekTitle');
            if(titleEl) titleEl.textContent = 'KW ' + kw + ' \u00B7 ' + fmt(mon) + ' - ' + fmt(sun) + sun.getFullYear();

            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var query = sb.from('verkauf_tracking').select('*').gte('datum', monStr).lte('datum', sunStr).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                weekDbData = resp.data || [];
            } catch(e) { weekDbData = []; console.warn('Week load error:', e); }
            renderWeekViewFromDb();
        }

        function renderWeekViewFromDb() {
            var data = weekDbData || [];
            var dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
            var weekDays = ['Mo','Di','Mi','Do','Fr','Sa'];
            // Group by seller
            var sellerMap = {};
            data.forEach(function(entry) {
                var name = entry.verkaeufer_name;
                if(!sellerMap[name]) sellerMap[name] = { name: name, plan_soll: 0, days: {} };
                weekDays.forEach(function(d) { if(!sellerMap[name].days[d]) sellerMap[name].days[d] = {day:d,plan:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0}; });
                var d = new Date(entry.datum);
                var dayName = dayNames[d.getDay()];
                if(sellerMap[name].days[dayName]) {
                    var dd = sellerMap[name].days[dayName];
                    dd.plan += (entry.plan_termine || 0);
                    dd.geplant += (entry.geplant || 0);
                    dd.spontan += (entry.spontan || 0);
                    dd.online += (entry.online || 0);
                    dd.ergo += (entry.ergo || 0);
                    dd.verkauft += (entry.verkauft || 0);
                    dd.uebergabe += (entry.uebergabe || 0);
                    dd.umsatz += parseFloat(entry.umsatz) || 0;
                }
                sellerMap[name].plan_soll += (entry.plan_termine || 0);
            });
            var sellers = Object.values(sellerMap);
            // Update filter dropdown dynamically
            var filterEl = document.getElementById('weekSellerFilter');
            if(filterEl) {
                var curVal = filterEl.value;
                var opts = '<option value="all">Alle Verkaeufer</option>';
                sellers.forEach(function(s) { opts += '<option value="'+s.name+'"'+(s.name===curVal?' selected':'')+'>'+s.name+'</option>'; });
                filterEl.innerHTML = opts;
            }
            var filter = filterEl ? filterEl.value : 'all';
            var filtered = filter === 'all' ? sellers : sellers.filter(function(s){return s.name === filter;});

            // KPIs
            var totalPlan=0, totalGesamt=0, totalVerkauft=0, totalUmsatz=0;
            filtered.forEach(function(s) {
                totalPlan += s.plan_soll;
                weekDays.forEach(function(dn) {
                    var dd = s.days[dn];
                    if(dd) { totalGesamt += dd.geplant+dd.spontan+dd.online+dd.ergo; totalVerkauft += dd.verkauft; totalUmsatz += dd.umsatz; }
                });
            });
            var el;
            el = document.getElementById('wkPlan'); if(el) el.textContent = totalPlan;
            el = document.getElementById('wkGesamt'); if(el) el.textContent = totalGesamt;
            el = document.getElementById('wkVerkauft'); if(el) el.textContent = totalVerkauft;
            el = document.getElementById('wkUmsatz'); if(el) el.textContent = totalUmsatz.toLocaleString('de-DE') + ' \u20AC';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            el = document.getElementById('wkQuote');
            if(el) { el.textContent = quoteVal + '%'; el.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600'); }

            // Seller tables
            var container = document.getElementById('weekSellerTables');
            if(!container) return;
            if(filtered.length === 0) { container.innerHTML = '<div class="vit-card p-8 text-center text-gray-400"><p class="text-lg mb-2">'+t('sales_no_data')+'</p><p class="text-sm">'+t('sales_add_entry')+'</p></div>'; return; }
            var html = '';
            filtered.forEach(function(s) {
                var sUmsatz=0, sGesamt=0, sVerkauft=0;
                weekDays.forEach(function(dn) { var dd=s.days[dn]; if(dd) { sUmsatz+=dd.umsatz; sGesamt+=dd.geplant+dd.spontan+dd.online+dd.ergo; sVerkauft+=dd.verkauft; } });
                var sQuote = sGesamt > 0 ? Math.round((sVerkauft/sGesamt)*100) : 0;
                html += '<div class="vit-card overflow-hidden">';
                html += '<div class="flex items-center justify-between p-4 bg-gray-50 border-b">';
                html += '<div class="flex items-center space-x-3"><div class="w-8 h-8 bg-vit-orange rounded-full flex items-center justify-center text-white font-bold text-sm">'+s.name.charAt(0)+'</div>';
                html += '<div><p class="font-semibold text-gray-800">'+s.name+'</p><p class="text-xs text-gray-500">Plan: '+s.plan_soll+' Termine</p></div></div>';
                html += '<div class="flex space-x-4 text-center">';
                html += '<div><p class="text-xs text-gray-500">Beratungen</p><p class="font-bold text-blue-600">'+sGesamt+'</p></div>';
                html += '<div><p class="text-xs text-gray-500">Verkauft</p><p class="font-bold text-green-600">'+sVerkauft+'</p></div>';
                html += '<div><p class="text-xs text-gray-500">Umsatz</p><p class="font-bold text-vit-orange">'+sUmsatz.toLocaleString('de-DE')+' \u20AC</p></div>';
                html += '<div><p class="text-xs text-gray-500">Quote</p><p class="font-bold '+(sQuote>=70?'text-green-600':sQuote>=40?'text-orange-600':'text-red-600')+'">'+sQuote+'%</p></div>';
                html += '</div></div>';
                html += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                html += '<thead><tr class="bg-gray-50 text-xs"><th class="py-2 px-3 text-left text-gray-500">Tag</th><th class="py-2 px-3 text-center text-gray-500">Plan</th><th class="py-2 px-3 text-center text-blue-600">Geplant</th><th class="py-2 px-3 text-center text-purple-600">Spontan</th><th class="py-2 px-3 text-center text-cyan-600">Online</th><th class="py-2 px-3 text-center text-pink-600">Ergo</th><th class="py-2 px-3 text-center font-bold text-gray-700">Gesamt</th><th class="py-2 px-3 text-center text-green-600">Verkauft</th><th class="py-2 px-3 text-center text-gray-500">Uebergabe</th><th class="py-2 px-3 text-right text-vit-orange">Umsatz</th></tr></thead>';
                html += '<tbody>';
                weekDays.forEach(function(dn) {
                    var dd = s.days[dn] || {plan:0,geplant:0,spontan:0,online:0,ergo:0,verkauft:0,uebergabe:0,umsatz:0};
                    var total = dd.geplant+dd.spontan+dd.online+dd.ergo;
                    var hasData = dd.plan>0 || total>0 || dd.umsatz>0;
                    html += '<tr class="border-b '+(hasData?'':'text-gray-300')+'">';
                    html += '<td class="py-2 px-3 font-semibold">'+dn+'</td>';
                    html += '<td class="py-2 px-3 text-center">'+(dd.plan||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-blue-600">'+(dd.geplant||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-purple-600">'+(dd.spontan||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-cyan-600">'+(dd.online||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-pink-600">'+(dd.ergo||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center font-bold">'+(total||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center text-green-600 font-bold">'+(dd.verkauft||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-center">'+(dd.uebergabe||'-')+'</td>';
                    html += '<td class="py-2 px-3 text-right font-semibold '+(dd.umsatz>0?'text-vit-orange':'')+'">'+(dd.umsatz>0?dd.umsatz.toLocaleString('de-DE')+' \u20AC':'-')+'</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div></div>';
            });
            container.innerHTML = html;
        }

        // === EINKAUF MODULE (from standalone einkauf_modul.html) ===
        var ekLiefFilter = 'all';
        var ekLiefQ = '';
        var stLiefQ = '';
        var wissenSec = 'iht';

        var allLief=[{"n": "AMFLOW/ DJI", "art": "bike", "kern": false, "zusatz": false, "auslauf": true, "stat": "Verhandlung gescheitert", "sc": "red", "kond": "Konditionen zu gering", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Babboe", "art": "bike", "kern": false, "zusatz": true, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Konditionen Accell", "iht": "IHT aktiv", "zr": true, "mail": "service@winora-group.de", "tel": "+49 (0)9721-6501-7878", "b2b": "Accentry b2b", "regmail": "callcenter@winora.de"}, {"n": "CaGo", "art": "bike", "kern": false, "zusatz": true, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Konditionen Ca Go", "iht": "IHT aktiv", "zr": true, "mail": "nouri.hamsoro@rtisports.de", "tel": "+49 (0)261 899998-220", "b2b": "Ca Go b2b", "regmail": "nouri.hamsoro@rtisports.de"}, {"n": "Centurion", "art": "bike", "kern": false, "zusatz": false, "auslauf": true, "stat": "Verhandlung gescheitert", "sc": "red", "kond": "", "iht": "Abgelehnt", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Conway", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Gazelle", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Volumen nicht ausreichend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Ghost, Lapierre", "art": "bike", "kern": false, "zusatz": true, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Konditionen Accell", "iht": "IHT aktiv", "zr": true, "mail": "sales@ghost-bikes.de", "tel": "+49 9632 9255-0", "b2b": "Accentry b2b", "regmail": "service@ghost-bikes.de"}, {"n": "HASE bike", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "6-7% Rabatt + 2% Sk. 10T", "iht": "Im Onboarding", "zr": false, "mail": "Hendrik.Forejta@hasebikes.com", "tel": "+49 2309 9377-236", "b2b": "", "regmail": "Hendrik.Forejta@hasebikes.com"}, {"n": "HEPHA", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "", "iht": "IHT aktiv", "zr": true, "mail": "info@hepha.com", "tel": "+49(0) 8142 / 2844480", "b2b": "", "regmail": "bernd.lesch@hepha.com"}, {"n": "i:SY", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Volumen nicht ausreichend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "yasemin@isy.de", "tel": "+49 221 5727744445", "b2b": "", "regmail": "yasemin@isy.de"}, {"n": "Kalkhoff", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Volumen nicht ausreichend", "sc": "gray", "kond": "", "iht": "Abgelehnt", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Koga", "art": "bike", "kern": false, "zusatz": true, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Konditionen Accell", "iht": "IHT aktiv", "zr": true, "mail": "service@winora-group.de", "tel": "+49 (0)9721-6501-7878", "b2b": "Accentry b2b", "regmail": "callcenter@winora.de"}, {"n": "KTM", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Volumen nicht ausreichend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "M1", "art": "bike", "kern": false, "zusatz": false, "auslauf": true, "stat": "Ausgelaufen (Insolvenz)", "sc": "red", "kond": "", "iht": "Abgelehnt", "zr": false, "mail": "info@m1-sporttechnik.de", "tel": "08020-90891170", "b2b": "", "regmail": "j.sauer@m1-sporttechnik.de"}, {"n": "Nicolai", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "In Verhandlung", "sc": "yellow", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Orbea", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "40/60% TAM, Diamond 17%", "iht": "In Verhandlung", "zr": false, "mail": "cponzlet@orbea.com", "tel": "+49 231 98819869", "b2b": "Orbea KIDE", "regmail": "cponzlet@orbea.com"}, {"n": "Raymon", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Riese und MÃ¼ller", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "In Verhandlung", "sc": "yellow", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "vertrieb@r-m.de", "tel": "+49 6151 36686-11", "b2b": "R&M b2b", "regmail": "vertrieb@r-m.de"}, {"n": "Simplon", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Premium-HÃ¤ndler, hohe Marge", "iht": "Im Onboarding", "zr": false, "mail": "sales@simplon.com", "tel": "+43 5574 72564401", "b2b": "Simplon b2b", "regmail": "sales@simplon.com"}, {"n": "Specialized", "art": "bike", "kern": false, "zusatz": false, "auslauf": false, "stat": "Volumen nicht ausreichend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Steppenwolf", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Kalk. 1,85 + 3% VO + 3% Sk.", "iht": "IHT aktiv", "zr": true, "mail": "sales@steppenwolf-bikes.com", "tel": "+49 30 863280217", "b2b": "Steppenwolf b2b", "regmail": "sales@steppenwolf-bikes.com"}, {"n": "Urban Arrow", "art": "bike", "kern": false, "zusatz": false, "auslauf": true, "stat": "Verhandlung gescheitert", "sc": "red", "kond": "", "iht": "Abgelehnt", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Velo de Ville", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "12% + 2% Sk. 16T (Fakt. 1,8)", "iht": "IHT aktiv", "zr": true, "mail": "philipp.niehues@velo-de-ville.com", "tel": "+49 2505 9305 965", "b2b": "VdV b2b", "regmail": "marketing@velo-de-ville.com"}, {"n": "Winora, Haibike", "art": "bike", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Accell max. Staffel (nur IHT)", "iht": "IHT aktiv", "zr": true, "mail": "service@winora-group.de", "tel": "+49(0) 9721-6501-7878", "b2b": "Accentry b2b", "regmail": "callcenter@winora.de"}, {"n": "Bike Leasing Service", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "6% Prov. - 33,4% MKT - bis 66,67% Wachstum", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "BLS b2b", "regmail": ""}, {"n": "BikeCenter", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "In Verhandlung", "sc": "yellow", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Businessbike", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "In Finalisierung", "sc": "yellow", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Businessbike b2b", "regmail": ""}, {"n": "Company Bike", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "In Verhandlung", "sc": "yellow", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "CB b2b", "regmail": ""}, {"n": "Deutsche Dienstrad", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "0% Prov. + 3% Fulfillment + 1% RÃ¼ckverg.", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "DD b2b", "regmail": ""}, {"n": "Eleasa", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Eleasa b2b", "regmail": ""}, {"n": "GO", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Jobrad", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Jobrad b2b", "regmail": ""}, {"n": "Kazenmaier", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Kazenmaier b2b", "regmail": ""}, {"n": "lease a bike", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "leasabike b2b", "regmail": ""}, {"n": "Linexo", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "linexo b2b", "regmail": ""}, {"n": "Mein Dienstrad", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "MDR b2b", "regmail": ""}, {"n": "Probonio", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Smartfit", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "", "iht": "Im Onboarding", "zr": false, "mail": "rw@smartfit.bike", "tel": "+49 160 6666367", "b2b": "", "regmail": "rw@smartfit.bike"}, {"n": "Strom", "art": "dl", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Telecash", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Clover Flex LTE V2, ab 18,90â‚¬/Mo", "iht": "", "zr": false, "mail": "christian.koenig@fiserv.com", "tel": "+49 (0) 911 945 8387", "b2b": "", "regmail": "christian.koenig@fiserv.com"}, {"n": "Telekom", "art": "dl", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Wertgarantie by linexo", "art": "dl", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Wertgarantie b2b", "regmail": ""}, {"n": "WÃ¼rth Leasing", "art": "dl", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "WÃ¼rth Leasing b2b", "regmail": ""}, {"n": "ABUS", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "48% Grund + VO-Staffel", "iht": "Abgelehnt", "zr": false, "mail": "mobile.vertrieb@abus.de", "tel": "+49 2335 634 470", "b2b": "ABUS b2b", "regmail": "mobile.vertrieb@abus.de"}, {"n": "Alps Alpine", "art": "parts", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "ASISTA", "art": "parts", "kern": false, "zusatz": false, "auslauf": true, "stat": "Verhandlung gescheitert", "sc": "red", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Cosmic Sports", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "SQlab 18%+1%+3%, SP Connect", "iht": "IHT aktiv", "zr": true, "mail": "tm@cosmicsports.de", "tel": "+49 911 310 755 59", "b2b": "Cosmic Sports b2b", "regmail": "tm@cosmicsports.de"}, {"n": "Croozer", "art": "parts", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "", "zr": false, "mail": "order@croozer.com", "tel": "02233-959913", "b2b": "", "regmail": "support@croozer.com"}, {"n": "Fidlock", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "In Finalisierung", "sc": "yellow", "kond": "", "iht": "Im Onboarding", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Grofa", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Giro 19%, Lumos 14%, Park Tool 26%", "iht": "IHT aktiv", "zr": true, "mail": "order@grofa.com", "tel": "06434/2008-200", "b2b": "GROFA b2b", "regmail": "stammdaten@grofa.com"}, {"n": "Hartje", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "In Verhandlung", "sc": "yellow", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "Hartje EOSweb", "regmail": ""}, {"n": "Livall/ CycloSport", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Livall 15% + 1% Delk.", "iht": "IHT aktiv", "zr": true, "mail": "bestellung@ciclosport.de", "tel": "089-895270-20", "b2b": "", "regmail": "bestellung@ciclosport.de"}, {"n": "Magura/ Bosch", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "MBPS b2b", "regmail": ""}, {"n": "MCG", "art": "parts", "kern": false, "zusatz": false, "auslauf": true, "stat": "Verhandlung gescheitert", "sc": "red", "kond": "", "iht": "Abgelehnt", "zr": false, "mail": "vertrieb@merida-centurion.com", "tel": "+49 (0)7159/9459-300", "b2b": "MCG b2b", "regmail": "vertrieb@merida-centurion.com"}, {"n": "OneUp Components", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "In Verhandlung", "zr": false, "mail": "", "tel": "", "b2b": "ONEup b2b", "regmail": ""}, {"n": "Ortlieb", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Paul Lange", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "In Finalisierung", "sc": "yellow", "kond": "", "iht": "Im Onboarding", "zr": false, "mail": "verkauf@paul-lange.de", "tel": "+49 (0) 711 2588 333", "b2b": "Paul Lange b2b", "regmail": "verkauf@paul-lange.de"}, {"n": "Pow Unity", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "Powunity b2b", "regmail": ""}, {"n": "RTI Sports", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "Topeak, Ca Go", "iht": "IHT aktiv", "zr": true, "mail": "nouri.hamsoro@rtisports.de", "tel": "+49 (0)261 899998-220", "b2b": "RTI Sports b2b", "regmail": "nouri.hamsoro@rtisports.de"}, {"n": "SportsNut", "art": "parts", "kern": false, "zusatz": false, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "SportsNut b2b", "regmail": ""}, {"n": "SQlab", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "18% + 1% Delk. + 3% Sk.", "iht": "IHT aktiv", "zr": true, "mail": "feb@sq-lab.com", "tel": "089-6661046-0", "b2b": "SQlab b2b", "regmail": "aba@sq-lab.com"}, {"n": "Thule", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt aufgenommen", "sc": "blue", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "", "regmail": ""}, {"n": "Tunap", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "In Finalisierung", "sc": "yellow", "kond": "Premium Partner, Marge 2,5x", "iht": "Im Onboarding", "zr": false, "mail": "Carolin.Schorsten@tunap-sports.de", "tel": "0151 15059430", "b2b": "TUNAP eShop", "regmail": "Carolin.Schorsten@tunap-sports.de"}, {"n": "Vaude", "art": "parts", "kern": false, "zusatz": true, "auslauf": false, "stat": "Kontakt ausstehend", "sc": "gray", "kond": "", "iht": "", "zr": false, "mail": "", "tel": "", "b2b": "VAUDE b2b", "regmail": ""}, {"n": "Wiener Bike Parts", "art": "parts", "kern": true, "zusatz": false, "auslauf": false, "stat": "Zentral fixiert", "sc": "green", "kond": "10% Kopf + Markenrabatte", "iht": "IHT aktiv", "zr": true, "mail": "callcenter@bike-parts.de", "tel": "09721 65 01-0", "b2b": "Accentry b2b", "regmail": "customer-data@winora-group.de"}];

// Standort demo data
var standorte={
    holzkirchen:{name:'Holzkirchen',inhaber:'Dirk Kolditz',nachlassIst:9.73,db1Ist:28.6,bestand:104,bestWert:340105,verkauft:71,umsatz:274593},
    berlin:{name:'Berlin Mitte',inhaber:'Max MÃ¼ller',nachlassIst:6.2,db1Ist:32.1,bestand:86,bestWert:290000,verkauft:95,umsatz:410000},
    hamburg:{name:'Hamburg',inhaber:'Sandra Weber',nachlassIst:8.1,db1Ist:30.5,bestand:92,bestWert:310000,verkauft:68,umsatz:295000},
    muenchen:{name:'MÃ¼nchen',inhaber:'Thomas Bauer',nachlassIst:5.8,db1Ist:33.9,bestand:78,bestWert:380000,verkauft:120,umsatz:580000},
    grafrath:{name:'Grafrath',inhaber:'Julian Neumann',nachlassIst:7.5,db1Ist:31.2,bestand:65,bestWert:220000,verkauft:52,umsatz:198000}
};

var strategien={
    holzkirchen:{status:'veroeffentlicht',datum:'2025-08-28',nachlass25:7,nachlass26:5,db1Ziel:34,
        todos:[{t:'Abstimmung mit Marketing',d:true},{t:'POS-Kampagnen',d:false},{t:'Events vor Ort',d:false},{t:'Kaltakquise Leasing',d:true},{t:'VerkÃ¤ufer schulen',d:false}]},
    berlin:{status:'entwurf',datum:'2025-09-10',nachlass25:5,nachlass26:4,db1Ziel:35,
        todos:[{t:'Simplon Dealervertrag',d:false},{t:'Premium-Umbau',d:false}]},
    hamburg:{status:'review',datum:'2025-09-01',nachlass25:6,nachlass26:5,db1Ziel:34,
        todos:[{t:'Haibike Restbestand',d:true},{t:'Orbea Testflotte',d:false},{t:'Leasing vor Ort',d:false}]},
    muenchen:{status:'veroeffentlicht',datum:'2025-07-15',nachlass25:5,nachlass26:4,db1Ziel:36,
        todos:[{t:'R&M World Umbau',d:true},{t:'Simplon Gravel-Event',d:true},{t:'ZubehÃ¶r-Bundles',d:false}]},
    grafrath:{status:'veroeffentlicht',datum:'2025-08-01',nachlass25:6,nachlass26:5,db1Ziel:34,
        todos:[{t:'Kalkhoff auflÃ¶sen',d:true},{t:'Orbea Marketing',d:false},{t:'Leasing-Angebote',d:false}]}
};

// Parts Priorisierung Matrix (from Excel)
var partsPrio=[{n:'SQlab (Ergonomie)',t:'Ergonomie','5':5,'10':5,'15':5,'17':5,'20':5,'25':5,kap:11240},{n:'Shimano (Ersatzteile)',t:'Service','5':0,'10':1,'15':2,'17':2,'20':3,'25':3,kap:2542},{n:'Schwalbe (MÃ¤ntel)',t:'Service','5':0,'10':0.25,'15':2,'17':2,'20':3,'25':3,kap:2859},{n:'Tunap (Pflege)',t:'Service','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:1528},{n:'ABUS (SchlÃ¶sser)',t:'Trend','5':0,'10':0.25,'15':0.5,'17':0.75,'20':0.75,'25':1,kap:2885},{n:'Helme',t:'Trend','5':0,'10':1,'15':2,'17':3,'20':3,'25':3,kap:3599},{n:'Topeak (Tools)',t:'Trend','5':0,'10':0,'15':0.5,'17':1,'20':1.5,'25':1.5,kap:2102},{n:'SP Connect',t:'Trend','5':0,'10':0.25,'15':0.25,'17':0.5,'20':0.5,'25':0.5,kap:1829},{n:'Elite/Fidlock',t:'Trend','5':0,'10':0.5,'15':0.5,'17':0.5,'20':0.5,'25':0.5,kap:513},{n:'Busch&MÃ¼ller',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:942},{n:'Pedale',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:862},{n:'Ursus (StÃ¤nder)',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:153},{n:'Vaude (Taschen)',t:'Trend','5':0,'10':0,'15':0.5,'17':0.5,'20':1,'25':1.5,kap:253},{n:'SKS/KlickFix',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:312},{n:'Kleinteile',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:753},{n:'by.Schulz',t:'ZubehÃ¶r','5':0,'10':0.25,'15':0.25,'17':0.25,'20':0.25,'25':0.25,kap:2558},{n:'Supernova/Lupine',t:'ZubehÃ¶r','5':0,'10':0,'15':0,'17':0,'20':0,'25':0.25,kap:0}];

// WBP Markenrabatte
var wbpR=[{m:'Schwalbe',k:'',r:'Key Account',d:'1%'},{m:'Continental',k:'',r:'14-18%',d:'1%'},{m:'SRAM',k:'',r:'5-10%',d:'1%'},{m:'Shimano',k:'',r:'5%',d:'1%'},{m:'DT Swiss',k:'10%',r:'3%',d:'1%'},{m:'XLC',k:'10%',r:'5%',d:'1%'},{m:'BySchulz',k:'',r:'5%',d:'1%'},{m:'KindShock',k:'',r:'8%',d:'1%'},{m:'Xpedo',k:'10%',r:'8%',d:'1%'},{m:'Basil',k:'10%',r:'5%',d:'1%'},{m:'B&M',k:'10%',r:'5%',d:'1%'},{m:'SKS',k:'10%',r:'5%',d:'1%'},{m:'KMC',k:'10%',r:'5%',d:'1%'},{m:'Cratoni',k:'10%',r:'6%',d:'1%'},{m:'Trelock',k:'10%',r:'8%',d:'1%'}];

// Sortiment Holzkirchen
var hauptmarken=[
    {name:'Riese und MÃ¼ller',s:'R&M',bg:'#1a1a1a',seg:'Premium Â· Nachorder',sp:'pg',v:27,vj:26,um:130856,ant:47.7,be:33,bw:116645,nl:5.45,vnl:6.24,bew:'LÃ¤uft gut',bc:'text-green-600',bi:'âœ“'},
    {name:'Orbea',s:'ORB',bg:'#ea580c',seg:'Premium Â· Nachorder',sp:'pg',v:22,vj:13,um:83078,ant:30.3,be:28,bw:82092,nl:9.98,vnl:11.70,bew:'Rabatt zu hoch',bc:'text-yellow-600',bi:'âš '},
    {name:'Haibike (Accell)',s:'HAI',bg:'#dc2626',seg:'Preiseinstieg Â· Vororder',sp:'pb',v:7,vj:1,um:28528,ant:10.4,be:28,bw:100172,nl:6.72,vnl:13.77,bew:'7 verkauft, 28 Bestand!',bc:'text-red-600',bi:'â›”'}
];
var bestandsm=[
    {n:'Kalkhoff',s:'KH',bg:'#2563eb',st:'Abverkauf',sp:'py',v:13,be:4,um:'26.946â‚¬',nl:'26,45%'},
    {n:'Ca Go',s:'CG',bg:'#059669',st:'Abverkauf',sp:'py',v:1,be:1,um:'4.333â‚¬',nl:'20,55%'},
    {n:'Velo de Ville',s:'VdV',bg:'#7c3aed',st:'Beobachtung',sp:'po',v:1,be:8,um:'952â‚¬',nl:'12%+2%Sk'},
    {n:'Hase Bikes',s:'HB',bg:'#0891b2',st:'Onboarding',sp:'pb',v:0,be:2,um:'0â‚¬',nl:'â€”'}
];

// ==================== HQ DASHBOARD ====================
function renderHQDash(){
    var h='';
    // KPI row
    var totLief=allLief.length, fixiert=allLief.filter(function(l){return l.sc=='green'}).length;
    var offen=allLief.filter(function(l){return l.sc=='yellow'}).length;
    h+='<div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-5">';
    h+='<div class="vc p-3.5 text-center"><p class="text-[10px] text-gray-400 uppercase">Lieferanten gesamt</p><p class="text-2xl font-bold mt-1">'+totLief+'</p></div>';
    h+='<div class="vc p-3.5 text-center"><p class="text-[10px] text-gray-400 uppercase">Fixiert</p><p class="text-2xl font-bold text-green-600 mt-1">'+fixiert+'</p></div>';
    h+='<div class="vc p-3.5 text-center"><p class="text-[10px] text-gray-400 uppercase">In Verhandlung</p><p class="text-2xl font-bold mt-1" style="color:#EF7D00">'+offen+'</p></div>';
    h+='<div class="vc p-3.5 text-center"><p class="text-[10px] text-gray-400 uppercase">Standorte</p><p class="text-2xl font-bold mt-1">'+Object.keys(standorte).length+'</p></div>';
    var kritisch=Object.values(standorte).filter(function(s){return s.nachlassIst>7}).length;
    h+='<div class="vc p-3.5 text-center '+(kritisch?'border-2 border-red-200':'')+'"><p class="text-[10px] text-gray-400 uppercase">Nachlass kritisch</p><p class="text-2xl font-bold text-red-500 mt-1">'+kritisch+'</p></div>';
    h+='</div>';

    // Standort-Alarme
    h+='<h2 class="text-sm font-bold mb-3">ðŸš¨ Standort-Alarme</h2><div class="grid md:grid-cols-2 xl:grid-cols-3 gap-3 mb-6">';
    Object.keys(standorte).forEach(function(k){
        var s=standorte[k], st=strategien[k]||{};
        var done=(st.todos||[]).filter(function(t){return t.d}).length, total=(st.todos||[]).length;
        var pct=total?Math.round(done/total*100):0;
        var nlCls=s.nachlassIst>7?'text-red-500':s.nachlassIst>5?'text-yellow-600':'text-green-600';
        var dbCls=s.db1Ist<32?'text-red-500':s.db1Ist<34?'text-yellow-600':'text-green-600';
        var statMap={veroeffentlicht:'pg',review:'pb',entwurf:'py'};
        var statLabel={veroeffentlicht:'âœ…',review:'ðŸ”',entwurf:'ðŸ“'};
        h+='<div class="vc p-4"><div class="flex items-center justify-between mb-2"><h3 class="font-bold text-sm">'+s.name+'</h3><span class="pill '+(statMap[st.status]||'pgr')+'">'+(statLabel[st.status]||'â€”')+' '+(st.status||'â€”')+'</span></div>';
        h+='<p class="text-[10px] text-gray-400 mb-2">'+s.inhaber+' Â· '+s.verkauft+' Bikes Â· '+s.umsatz.toLocaleString('de-DE')+'â‚¬</p>';
        h+='<div class="grid grid-cols-3 gap-2 text-center text-[11px] mb-2">';
        h+='<div class="p-2 rounded-lg bg-gray-50"><span class="text-gray-400 block">Nachlass</span><b class="'+nlCls+'">'+s.nachlassIst.toFixed(1).replace('.',',')+'%</b></div>';
        h+='<div class="p-2 rounded-lg bg-gray-50"><span class="text-gray-400 block">DB1</span><b class="'+dbCls+'">'+s.db1Ist.toFixed(1).replace('.',',')+'%</b></div>';
        h+='<div class="p-2 rounded-lg bg-gray-50"><span class="text-gray-400 block">Bestand</span><b>'+s.bestand+'</b></div>';
        h+='</div>';
        h+='<div class="flex items-center gap-2"><div class="prog flex-1"><div class="pf" style="width:'+pct+'%;background:var(--v)"></div></div><span class="text-[10px] font-bold" style="color:#EF7D00">'+pct+'% ToDos</span></div>';
        h+='</div>';
    });
    h+='</div>';

    // Offene Lieferanten-Verhandlungen
    h+='<h2 class="text-sm font-bold mb-3">ðŸ”„ Offene Verhandlungen & Aktionen</h2><div class="vc overflow-x-auto mb-6"><table class="dt"><thead><tr><th>Lieferant</th><th>Art</th><th>Status</th><th>IHT</th><th>Aktion nÃ¶tig</th></tr></thead><tbody>';
    allLief.filter(function(l){return l.sc=='yellow'||l.sc=='blue'}).forEach(function(l){
        var artI={bike:'ðŸš²',parts:'ðŸ”§',dl:'ðŸ¢'};
        h+='<tr><td class="font-semibold">'+l.n+'</td><td class="text-xs">'+(artI[l.art]||'')+' '+l.art+'</td>';
        h+='<td><span class="pill '+(l.sc=='yellow'?'py':'pb')+'">'+l.stat+'</span></td>';
        h+='<td class="text-xs">'+(l.iht||'â€”')+'</td>';
        var aktion='Verhandlung fortfÃ¼hren';
        if(l.stat.indexOf('Finalisierung')>=0) aktion='Vertrag abschlieÃŸen';
        if(l.stat.indexOf('Kontakt au')>=0) aktion='Erstkontakt herstellen';
        if(l.stat.indexOf('Kontakt aufgenommen')>=0) aktion='Angebot einholen';
        h+='<td><span class="text-xs font-semibold" style="color:#EF7D00">â†’ '+aktion+'</span></td></tr>';
    });
    h+='</tbody></table></div>';

    // Bestands-Alarme
    h+='<h2 class="text-sm font-bold mb-3">ðŸ“¦ Bestands-Alarme (Holzkirchen)</h2><div class="grid md:grid-cols-3 gap-3">';
    hauptmarken.forEach(function(m){
        if(m.be>20 && m.v<15){
            h+='<div class="vc p-4 border-l-4 border-red-400"><div class="flex items-center gap-2 mb-1"><div class="w-7 h-7 rounded-lg flex items-center justify-center text-white text-[9px] font-bold" style="background:'+m.bg+'">'+m.s+'</div><b class="text-xs">'+m.name+'</b></div>';
            h+='<p class="text-[11px] text-red-600 font-semibold">'+m.v+' verkauft vs. '+m.be+' Bestand ('+m.bw.toLocaleString('de-DE')+'â‚¬)</p>';
            h+='<p class="text-[10px] text-gray-400">Ratio: '+(m.v/m.be).toFixed(2)+' â€” Aktion: Abverkauf forcieren</p></div>';
        }
    });
    h+='</div>';
    return h;
}

// ==================== HQ LIEFERANTEN ====================
var liefFilter='all', liefQ='';
function renderHQLief(){
    var h='';
    h+='<div class="flex flex-col sm:flex-row gap-3 mb-4"><div class="relative flex-1 max-w-md"><svg class="absolute left-3 top-2.5 w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="lq" oninput="liefQ=this.value;reRenderEkTab()" placeholder="Suchenâ€¦" class="si" value="'+liefQ+'"></div>';
    h+='<div class="flex gap-1.5 flex-wrap">';
    ['all','bike','parts','dl'].forEach(function(f){
        var lb={all:'Alle',bike:'ðŸš² Bikes',parts:'ðŸ”§ Parts',dl:'ðŸ¢ DL'}[f];
        h+='<button onclick="liefFilter=\''+f+'\';reRenderEkTab()" class="px-3 py-1.5 rounded-full text-xs font-semibold '+(liefFilter==f?'text-white':'bg-gray-100 text-gray-600')+'" '+(liefFilter==f?'style="background:#EF7D00"':'')+'>'+lb+'</button>';
    });
    h+='</div><button onclick="openLiefEditor()" class="vbtn">ï¼‹ Neuer Lieferant</button></div>';

    // Legend
    h+='<div class="flex flex-wrap gap-3 mb-3 text-[10px] text-gray-500">';
    [{c:'bg-green-500',l:'Fixiert'},{c:'bg-yellow-500',l:'In Verhandlung'},{c:'bg-blue-500',l:'Kontakt'},{c:'bg-gray-400',l:'Ausstehend'},{c:'bg-red-500',l:'Gescheitert'}].forEach(function(s){h+='<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full '+s.c+'"></span>'+s.l+'</span>'});
    h+='</div>';

    h+='<div class="vc overflow-x-auto"><table class="dt"><thead><tr><th>Lieferant</th><th>Art</th><th>Kern</th><th>Status</th><th>Kalkulation</th><th>IHT</th><th>Kontakt</th><th>B2B</th><th></th></tr></thead><tbody>';
    var sc={green:'bg-green-500',yellow:'bg-yellow-500',blue:'bg-blue-500',gray:'bg-gray-400',red:'bg-red-500'};
    var artI={bike:'ðŸš²',parts:'ðŸ”§',dl:'ðŸ¢'};
    var q=liefQ.toLowerCase();
    allLief.filter(function(l){
        if(liefFilter!='all'&&l.art!=liefFilter) return false;
        if(q&&l.n.toLowerCase().indexOf(q)<0) return false;
        return true;
    }).forEach(function(l,i){
        var kernLabel=l.kern?'<span class="font-bold text-[10px]" style="color:#EF7D00">â˜… Kern</span>':l.zusatz?'<span class="text-[10px] text-gray-400">Zusatz</span>':l.auslauf?'<span class="text-[10px] text-red-400">âŠ˜ Auslauf</span>':'<span class="text-[10px] text-gray-300">â€”</span>';
        h+='<tr><td class="font-semibold">'+l.n+'</td>';
        h+='<td class="text-xs">'+(artI[l.art]||'')+' '+l.art+'</td>';
        h+='<td>'+kernLabel+'</td>';
        h+='<td><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full '+(sc[l.sc]||'bg-gray-300')+'"></span><span class="text-xs">'+l.stat+'</span></span></td>';
        h+='<td class="text-[11px]">'+(l.kond||'<span class="text-gray-300">â€”</span>')+'</td>';
        h+='<td class="text-xs">'+(l.iht||'<span class="text-gray-300">â€”</span>')+'</td>';
        h+='<td class="text-[11px]">'+(l.mail?'<a href="mailto:'+l.mail+'" class="text-blue-600">'+l.mail+'</a>':'<span class="text-gray-300">â€”</span>')+(l.tel?'<br><span class="text-gray-400">'+l.tel+'</span>':'')+'</td>';
        h+='<td>'+(l.b2b?'<span class="text-[10px] font-semibold text-blue-600">'+l.b2b+'</span>':'<span class="text-gray-300 text-xs">â€”</span>')+'</td>';
        h+='<td><button onclick="openLiefEditor('+i+')" class="rbtn text-[10px]">âœï¸</button></td>';
        h+='</tr>';
    });
    h+='</tbody></table></div>';
    return h;
}

// ==================== LIEFERANT EDITOR MODAL ====================
function openLiefEditor(idx){
    var l=idx!=null?allLief[idx]:{n:'',art:'bike',kern:false,zusatz:false,auslauf:false,stat:'',sc:'gray',kond:'',iht:'',zr:false,mail:'',tel:'',b2b:'',regmail:'',hp:'',katalog:'',notizen:''};
    var isNew=idx==null;
    var h='<div class="modal-bg" onclick="if(event.target==this)closeModal()"><div class="modal">';
    h+='<div class="flex items-center justify-between mb-4"><h2 class="font-bold text-base">'+(isNew?'Neuer Lieferant':'âœï¸ '+l.n+' bearbeiten')+'</h2><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-lg">âœ•</button></div>';
    
    h+='<div class="form-row"><div><label class="form-label">Name</label><input class="form-input" id="eN" value="'+l.n+'"></div><div><label class="form-label">Art</label><select class="form-input" id="eArt"><option value="bike"'+(l.art=='bike'?' selected':'')+'>ðŸš² Bike</option><option value="parts"'+(l.art=='parts'?' selected':'')+'>ðŸ”§ Parts</option><option value="dl"'+(l.art=='dl'?' selected':'')+'>ðŸ¢ Dienstleister</option></select></div></div>';
    
    h+='<div class="form-row"><div><label class="form-label">Status Konditionen</label><select class="form-input" id="eStat"><option value="Zentral fixiert"'+(l.stat.indexOf('fixiert')>=0?' selected':'')+'>âœ… Zentral fixiert</option><option value="In Verhandlung"'+(l.stat=='In Verhandlung'?' selected':'')+'>ðŸ”„ In Verhandlung</option><option value="In Finalisierung"'+(l.stat.indexOf('Finalisierung')>=0?' selected':'')+'>ðŸ“ In Finalisierung</option><option value="Kontakt aufgenommen"'+(l.stat=='Kontakt aufgenommen'?' selected':'')+'>ðŸ“ž Kontakt aufgenommen</option><option value="Kontakt ausstehend"'+(l.stat.indexOf('ausstehend')>=0?' selected':'')+'>â³ Kontakt ausstehend</option><option value="Volumen nicht ausreichend"'+(l.stat.indexOf('Volumen')>=0?' selected':'')+'>ðŸ“‰ Volumen nicht ausreichend</option><option value="Verhandlung gescheitert"'+(l.stat.indexOf('gescheitert')>=0?' selected':'')+'>âŒ Gescheitert</option><option value="Ausgelaufen"'+(l.stat.indexOf('Ausgelaufen')>=0?' selected':'')+'>âŠ˜ Ausgelaufen</option></select></div>';
    h+='<div><label class="form-label">Einstufung</label><select class="form-input" id="eKern"><option value="kern"'+(l.kern?' selected':'')+'>â˜… Kernsortiment</option><option value="zusatz"'+(l.zusatz?' selected':'')+'>ï¼‹ Zusatz</option><option value="auslauf"'+(l.auslauf?' selected':'')+'>âŠ˜ Auslauf</option><option value=""'+(!l.kern&&!l.zusatz&&!l.auslauf?' selected':'')+'>â€” Keine</option></select></div></div>';
    
    h+='<h3 class="font-bold text-xs text-gray-500 mt-4 mb-2">ðŸ’° Kalkulation & Konditionen</h3>';
    h+='<div class="form-row"><div><label class="form-label">Konditionen (Kurzform)</label><input class="form-input" id="eKond" value="'+(l.kond||'').replace(/"/g,'&quot;')+'"></div><div><label class="form-label">IHT-Status</label><select class="form-input" id="eIht"><option value="">â€” Nicht relevant</option><option value="IHT aktiv"'+(l.iht=='IHT aktiv'?' selected':'')+'>âœ… IHT aktiv</option><option value="Im Onboarding"'+(l.iht=='Im Onboarding'?' selected':'')+'>ðŸ”„ Im Onboarding</option><option value="In Verhandlung"'+(l.iht=='In Verhandlung'?' selected':'')+'>ðŸ“ In Verhandlung</option><option value="Abgelehnt"'+(l.iht=='Abgelehnt'?' selected':'')+'>âŒ Abgelehnt</option></select></div></div>';
    h+='<div><label class="form-label">Konditionen Detail / Vertragsinhalte</label><textarea class="form-input" id="eKondDetail" rows="3" placeholder="z.B. 12% HÃ¤ndlerrabatt, 2% Skonto 16 Tage, Faktor 1,8â€¦">'+(l.kondDetail||'')+'</textarea></div>';
    
    h+='<h3 class="font-bold text-xs text-gray-500 mt-4 mb-2">ðŸ‘¤ Ansprechpartner & Kontakt</h3>';
    h+='<div class="form-row"><div><label class="form-label">E-Mail Innendienst</label><input class="form-input" id="eMail" value="'+(l.mail||'')+'"></div><div><label class="form-label">Telefon</label><input class="form-input" id="eTel" value="'+(l.tel||'')+'"></div></div>';
    h+='<div class="form-row"><div><label class="form-label">E-Mail fÃ¼r Registrierung</label><input class="form-input" id="eReg" value="'+(l.regmail||'')+'"></div><div><label class="form-label">Ansprechpartner Name</label><input class="form-input" id="eAP" value="'+(l.ansprechpartner||'')+'"></div></div>';
    
    h+='<h3 class="font-bold text-xs text-gray-500 mt-4 mb-2">ðŸ”— Links & Ressourcen</h3>';
    h+='<div class="form-row"><div><label class="form-label">B2B-Shop</label><input class="form-input" id="eB2b" value="'+(l.b2b||'')+'"></div><div><label class="form-label">Homepage</label><input class="form-input" id="eHp" value="'+(l.hp||'')+'"></div></div>';
    h+='<div class="form-row"><div><label class="form-label">Katalog-Link</label><input class="form-input" id="eKat" value="'+(l.katalog||'')+'"></div><div><label class="form-label">ZR Ã¼ber IHT</label><select class="form-input" id="eZr"><option value="false"'+(!l.zr?' selected':'')+'>Nein</option><option value="true"'+(l.zr?' selected':'')+'>Ja</option></select></div></div>';
    
    h+='<div><label class="form-label">Notizen</label><textarea class="form-input" id="eNot" rows="2" placeholder="Interne Notizenâ€¦">'+(l.notizen||'')+'</textarea></div>';
    
    h+='<div class="flex gap-3 mt-5 pt-4 border-t border-gray-100"><button onclick="saveLief('+(idx!=null?idx:'null')+')" class="vbtn">ðŸ’¾ Speichern</button><button onclick="closeModal()" class="rbtn">Abbrechen</button></div>';
    h+='</div></div>';
    document.getElementById('modalWrap').innerHTML=h;
    document.getElementById('modalWrap').style.display='block';
}

function saveLief(idx){
    var statToSc={'Zentral fixiert':'green','In Verhandlung':'yellow','In Finalisierung':'yellow','Kontakt aufgenommen':'blue','Kontakt ausstehend':'gray','Volumen nicht ausreichend':'gray','Verhandlung gescheitert':'red','Ausgelaufen':'red'};
    var kernVal=document.getElementById('eKern').value;
    var obj={
        n:document.getElementById('eN').value,
        art:document.getElementById('eArt').value,
        kern:kernVal=='kern',zusatz:kernVal=='zusatz',auslauf:kernVal=='auslauf',
        stat:document.getElementById('eStat').value,
        sc:statToSc[document.getElementById('eStat').value]||'gray',
        kond:document.getElementById('eKond').value,
        kondDetail:document.getElementById('eKondDetail').value,
        iht:document.getElementById('eIht').value,
        zr:document.getElementById('eZr').value=='true',
        mail:document.getElementById('eMail').value,
        tel:document.getElementById('eTel').value,
        regmail:document.getElementById('eReg').value,
        ansprechpartner:document.getElementById('eAP').value,
        b2b:document.getElementById('eB2b').value,
        hp:document.getElementById('eHp').value,
        katalog:document.getElementById('eKat').value,
        notizen:document.getElementById('eNot').value
    };
    if(idx!=null) allLief[idx]=Object.assign(allLief[idx],obj);
    else allLief.push(obj);
    closeModal();
    reRenderEkTab();
}

function closeModal(){document.getElementById('modalWrap').style.display='none';document.getElementById('modalWrap').innerHTML='';}

// ==================== HQ STRATEGIEN ====================
function renderHQStrat(){
    var h='<div class="vc p-5 mb-5"><h2 class="font-bold text-sm mb-3">ðŸ“Š Strategie-Ãœbersicht aller Standorte</h2>';
    h+='<div class="overflow-x-auto"><table class="dt"><thead><tr><th>Standort</th><th>Inhaber</th><th>Status</th><th>Ã˜ Nachlass</th><th>DB1 Ist/Ziel</th><th>ToDo-Fortschritt</th><th>Stand</th></tr></thead><tbody>';
    var stL={veroeffentlicht:{p:'pg',l:'âœ… VerÃ¶ff.'},review:{p:'pb',l:'ðŸ” Review'},entwurf:{p:'py',l:'ðŸ“ Entwurf'}};
    Object.keys(standorte).forEach(function(k){
        var s=standorte[k],st=strategien[k]||{};
        var done=(st.todos||[]).filter(function(t){return t.d}).length,total=(st.todos||[]).length;
        var pct=total?Math.round(done/total*100):0;
        var sl=stL[st.status]||{p:'pgr',l:'â€”'};
        h+='<tr><td class="font-semibold">'+s.name+'</td><td class="text-xs text-gray-500">'+s.inhaber+'</td>';
        h+='<td><span class="pill '+sl.p+'">'+sl.l+'</span></td>';
        h+='<td class="font-bold '+(s.nachlassIst>7?'text-red-500':s.nachlassIst>5?'text-yellow-600':'text-green-600')+'">'+s.nachlassIst.toFixed(1).replace('.',',')+'%</td>';
        h+='<td class="text-xs">'+s.db1Ist.toFixed(1).replace('.',',')+'% <span class="text-gray-400">/ '+(st.db1Ziel||'â€”')+'%</span></td>';
        h+='<td><div class="flex items-center gap-2"><div class="prog flex-1"><div class="pf" style="width:'+pct+'%;background:var(--v)"></div></div><span class="text-[10px] font-bold" style="color:#EF7D00">'+pct+'%</span></div></td>';
        h+='<td class="text-xs text-gray-400">'+(st.datum||'â€”')+'</td></tr>';
    });
    h+='</tbody></table></div></div>';
    return h;
}

// ==================== STANDORT: SORTIMENT ====================
function renderStSortiment(){
    var h='';
    // KPIs
    var s=standorte.holzkirchen;
    h+='<div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-5">';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Bike-Marken</p><p class="text-xl font-bold mt-1">4</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Verkauft</p><p class="text-xl font-bold mt-1">'+s.verkauft+'</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Umsatz netto</p><p class="text-xl font-bold mt-1">'+s.umsatz.toLocaleString('de-DE')+'â‚¬</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Ã˜ DB1</p><p class="text-xl font-bold mt-1" style="color:#EF7D00">'+s.db1Ist+'%</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Ã˜ Nachlass</p><p class="text-xl font-bold text-red-500 mt-1">'+s.nachlassIst+'%</p></div>';
    h+='</div>';

    // Hauptmarken
    h+='<h2 class="text-sm font-bold mb-3">ðŸš² Hauptmarken</h2><div class="grid lg:grid-cols-3 gap-4 mb-6">';
    hauptmarken.forEach(function(m){
        var vc=m.vj>0?((m.v-m.vj)/m.vj*100).toFixed(0):'â€”';
        h+='<div class="mc vc p-4"><div class="flex items-center gap-2.5 mb-2.5"><div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-[10px]" style="background:'+m.bg+'">'+m.s+'</div><div><h3 class="font-bold text-sm">'+m.name+'</h3><span class="pill '+m.sp+'">'+m.seg+'</span></div></div>';
        h+='<div class="grid grid-cols-2 gap-2 text-[10px] mb-2">';
        h+='<div class="p-2 bg-blue-50 rounded-lg"><span class="text-gray-400">Verkauft</span><p class="font-bold text-sm">'+m.v+'</p><span class="text-gray-400">VJ: '+m.vj+' ('+vc+'%)</span></div>';
        h+='<div class="p-2 bg-green-50 rounded-lg"><span class="text-gray-400">Umsatz</span><p class="font-bold text-sm">'+m.um.toLocaleString('de-DE')+'â‚¬</p><span class="text-gray-400">'+m.ant+'%</span></div>';
        h+='<div class="p-2 '+(m.be>20&&m.v<10?'bg-red-50 border border-red-200':'bg-orange-50')+' rounded-lg"><span class="text-gray-400">Bestand</span><p class="font-bold text-sm">'+m.be+'</p><span class="text-gray-400">'+m.bw.toLocaleString('de-DE')+'â‚¬</span></div>';
        h+='<div class="p-2 bg-purple-50 rounded-lg"><span class="text-gray-400">Nachlass</span><p class="font-bold text-sm '+(m.nl>7?'text-red-600':'')+'">'+m.nl.toFixed(2).replace('.',',')+'%</p></div>';
        h+='</div><p class="text-[10px] '+m.bc+' font-bold">'+m.bi+' '+m.bew+'</p></div>';
    });
    h+='</div>';

    // Bestandsmarken
    h+='<h2 class="text-sm font-bold mb-3">ðŸ“¦ Bestandsmarken</h2><div class="grid md:grid-cols-2 xl:grid-cols-4 gap-3 mb-6">';
    bestandsm.forEach(function(m){
        h+='<div class="vc p-3 opacity-80 border-l-4 border-yellow-400"><div class="flex items-center gap-2 mb-1.5"><div class="w-7 h-7 rounded-lg flex items-center justify-center text-white text-[9px] font-bold" style="background:'+m.bg+'">'+m.s+'</div><div><b class="text-xs">'+m.n+'</b><span class="pill '+m.sp+' ml-1">'+m.st+'</span></div></div>';
        h+='<div class="grid grid-cols-2 gap-1 text-[10px]"><div>Verk: <b>'+m.v+'</b></div><div>Best: <b>'+m.be+'</b></div><div>Ums: <b>'+m.um+'</b></div><div>NL: <b>'+m.nl+'</b></div></div></div>';
    });
    h+='</div>';

    // Teilelieferanten
    h+='<h2 class="text-sm font-bold mb-3">ðŸ”§ Teilelieferanten</h2><div class="vc overflow-x-auto"><table class="dt"><thead><tr><th>Lieferant</th><th>Konditionen</th><th>IHT</th><th>Kontakt</th></tr></thead><tbody>';
    allLief.filter(function(l){return l.art=='parts'&&l.sc=='green'}).forEach(function(l){
        h+='<tr><td class="font-semibold">'+l.n+'</td><td class="text-xs">'+l.kond+'</td><td>'+(l.zr?'<span class="pill pg">IHT âœ“</span>':'<span class="pill pgr">Direkt</span>')+'</td><td class="text-xs text-gray-500">'+l.mail+'</td></tr>';
    });
    h+='</tbody></table></div>';
    return h;
}

// ==================== STANDORT: LIEFERANTEN (READ-ONLY) ====================
function renderStLief(){
    var h='<div class="relative mb-4 max-w-md"><svg class="absolute left-3 top-2.5 w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="slq" oninput="stLiefQ=this.value;reRenderEkTab()" placeholder="Suchenâ€¦" class="si" value="'+(stLiefQ||'')+'"></div>';
    h+='<div class="vc overflow-x-auto"><table class="dt"><thead><tr><th>Lieferant</th><th>Art</th><th>Kern</th><th>Status</th><th>Konditionen</th><th>IHT</th><th>Kontakt</th><th>B2B</th></tr></thead><tbody>';
    var sc={green:'bg-green-500',yellow:'bg-yellow-500',blue:'bg-blue-500',gray:'bg-gray-400',red:'bg-red-500'};
    var q=(stLiefQ||'').toLowerCase();
    allLief.filter(function(l){return !q||l.n.toLowerCase().indexOf(q)>=0}).forEach(function(l){
        h+='<tr><td class="font-semibold">'+l.n+'</td><td class="text-xs">'+(l.art=='bike'?'ðŸš²':l.art=='parts'?'ðŸ”§':'ðŸ¢')+' '+l.art+'</td>';
        h+='<td>'+(l.kern?'<span class="font-bold text-[10px]" style="color:#EF7D00">â˜… Kern</span>':l.zusatz?'<span class="text-[10px] text-gray-400">Zusatz</span>':'<span class="text-gray-300 text-[10px]">â€”</span>')+'</td>';
        h+='<td><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full '+(sc[l.sc]||'bg-gray-300')+'"></span><span class="text-xs">'+l.stat+'</span></span></td>';
        h+='<td class="text-[11px]">'+(l.kond||'â€”')+'</td>';
        h+='<td class="text-xs">'+(l.iht||'â€”')+'</td>';
        h+='<td class="text-[11px]">'+(l.mail||'â€”')+'</td>';
        h+='<td class="text-[10px]">'+(l.b2b?'<span class="text-blue-600 font-semibold">'+l.b2b+'</span>':'â€”')+'</td></tr>';
    });
    h+='</tbody></table></div>';
    return h;
}
var stLiefQ='';

// ==================== ZENTRALREGULIERUNG ====================
function renderZR(){
    return '<div class="vc p-5 mb-5" style="border-left:4px solid #EF7D00"><h2 class="text-base font-bold mb-1">vit:bikes Streckenlieferantensystem</h2><p class="text-xs text-gray-500">Full-Service-Kooperation mit Cronbank, IHT und HIW.</p></div>'+
    '<div class="grid md:grid-cols-3 gap-4 mb-5">'+
    '<div class="vc p-4 text-center"><div class="text-xl mb-1">ðŸ¦</div><h3 class="font-bold text-xs">Cronbank</h3><p class="text-[10px] text-gray-500 mt-1">Finanzierung & Bankkonto. WÃ¶chentlich: Sofort+Skonto oder Kontokorrent.</p></div>'+
    '<div class="vc p-4 text-center"><div class="text-xl mb-1">ðŸ“‹</div><h3 class="font-bold text-xs">IHT</h3><p class="text-[10px] text-gray-500 mt-1">Zahlungsmanagement, Zahlungsabsicherung, Rechnungsarchiv MHK.net.</p></div>'+
    '<div class="vc p-4 text-center"><div class="text-xl mb-1">ðŸ’»</div><h3 class="font-bold text-xs">HIW</h3><p class="text-[10px] text-gray-500 mt-1">Warenwirtschaft, IC-Bestellungen, Onlineshop-Anbindung.</p></div></div>'+
    '<div class="vc p-5 mb-5"><h3 class="font-bold text-xs mb-3">Ablauf</h3><div class="grid md:grid-cols-3 gap-3">'+
    ['1|Bestellung|Direkt beim Lieferanten','2|Rechnung â†’ IHT|Kopie an IHT','3|Digitalisierung|MHK.net Archiv','4|Zahlung|IHT zahlt in Skontofrist','5|SEPA-Lastschrift|16+x Tage (Fr)','âœ“|FlexibilitÃ¤t|Sofort+Skonto oder schieben'].map(function(s){var p=s.split('|');return '<div class="flex gap-2"><div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0" style="background:#EF7D00">'+p[0]+'</div><div><p class="text-[11px] font-semibold">'+p[1]+'</p><p class="text-[10px] text-gray-400">'+p[2]+'</p></div></div>'}).join('')+
    '</div></div>'+
    '<div class="grid md:grid-cols-2 gap-4">'+
    '<div class="vc p-4"><h3 class="font-bold text-xs text-green-700 mb-2">âœ“ Vorteile fÃ¼r Dich</h3><div class="text-[11px] text-gray-600 space-y-1"><p>â–¸ HÃ¶here Konditionen â†’ besserer DB1</p><p>â–¸ Zeitsparende Belegarchivierung</p><p>â–¸ Flexible Zahlungsziele â†’ LiquiditÃ¤t</p><p>â–¸ IC-Austausch via HIW</p></div></div>'+
    '<div class="vc p-4"><h3 class="font-bold text-xs text-blue-700 mb-2">ðŸ¤ Vorteile fÃ¼r Lieferanten</h3><div class="text-[11px] text-gray-600 space-y-1"><p>â–¸ Zahlungsgarantie durch IHT</p><p>â–¸ Hohes Gruppenvolumen</p><p>â–¸ Zentrale Ansprechpartner</p><p>â–¸ Premium-Ladenbau</p></div></div></div>';
}

// ==================== STANDORT: STRATEGIE ====================
function renderStStrat(){
    var s=standorte.holzkirchen, st=strategien.holzkirchen;
    var done=st.todos.filter(function(t){return t.d}).length, total=st.todos.length, pct=total?Math.round(done/total*100):0;
    var h='<div class="vc p-5 mb-5" style="border-left:4px solid #EF7D00"><div class="flex items-start justify-between"><div><h2 class="font-bold text-base">Einkaufsstrategie â€” Holzkirchen</h2><p class="text-[11px] text-gray-400">Stand '+st.datum+' Â· Inhaber: '+s.inhaber+'</p></div><div class="flex gap-2"><span class="pill pg">âœ… VerÃ¶ffentlicht</span><button class="vbtn text-[11px]">ðŸ“¥ PDF</button></div></div></div>';
    
    // Progress
    h+='<div class="vc p-4 mb-5 flex items-center gap-4" style="background:linear-gradient(135deg,#fff7ed,#fff)"><div class="w-14 h-14 rounded-full flex items-center justify-center font-bold text-base text-white flex-shrink-0" style="background:#EF7D00">'+pct+'%</div><div class="flex-1"><p class="text-xs font-bold">Gesamtfortschritt</p><div class="prog mt-1" style="height:9px"><div class="pf" style="width:'+pct+'%;background:var(--v)"></div></div><p class="text-[10px] text-gray-400 mt-1">'+done+' von '+total+' erledigt</p></div></div>';
    
    // KPIs
    h+='<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-5">';
    h+='<div class="vc p-3 text-center border-2 border-red-200"><p class="text-[10px] text-gray-400 uppercase">Nachlass</p><p class="text-2xl font-bold text-red-500 mt-1">'+s.nachlassIst+'%</p><p class="text-[10px] text-gray-400">Ziel: '+st.nachlass25+'%</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">DB1</p><p class="text-2xl font-bold mt-1" style="color:#EF7D00">'+s.db1Ist+'%</p><p class="text-[10px] text-gray-400">Ziel: '+st.db1Ziel+'%</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">Bestand</p><p class="text-2xl font-bold mt-1">'+s.bestand+'</p></div>';
    h+='<div class="vc p-3 text-center"><p class="text-[10px] text-gray-400 uppercase">LiquiditÃ¤t</p><p class="text-lg font-bold mt-1">ðŸŸ¡ Angespannt</p></div>';
    h+='</div>';
    
    // ToDos
    h+='<div class="vc p-5"><h3 class="font-bold text-sm mb-3">ðŸ“‹ Deine ToDos</h3><div class="space-y-1">';
    st.todos.forEach(function(t,i){
        h+='<div class="td flex items-center gap-2.5 '+(t.d?'opacity-60':'')+'"><input type="checkbox" '+(t.d?'checked':'')+' onchange="strategien.holzkirchen.todos['+i+'].d=!strategien.holzkirchen.todos['+i+'].d;reRenderEkTab()"><span class="text-xs '+(t.d?'line-through text-gray-400':'text-gray-700')+'">'+t.t+'</span>'+(t.d?'<span class="pill pg ml-auto">âœ“</span>':'')+'</div>';
    });
    h+='</div></div>';
    return h;
}

// ==================== WISSEN ====================
var wissenSec='iht';
function renderWissen(){
    var h='<div class="flex flex-wrap gap-2 mb-5">';
    [{id:'iht',l:'ðŸ¦ IHT'},{id:'parts',l:'ðŸ”§ Parts'},{id:'db1',l:'ðŸ“Š DB1'},{id:'kern',l:'ðŸš² Kernsortiment'},{id:'vo',l:'ðŸ“¦ Vororder'}].forEach(function(w){
        h+='<div class="wn'+(wissenSec==w.id?' on':'')+'" onclick="wissenSec=\''+w.id+'\';reRenderEkTab()">'+w.l+'</div>';
    });
    h+='</div>';
    
    if(wissenSec=='iht') h+=renderWIht();
    if(wissenSec=='parts') h+=renderWParts();
    if(wissenSec=='db1') h+=renderWDb1();
    if(wissenSec=='kern') h+=renderWKern();
    if(wissenSec=='vo') h+=renderWVo();
    return h;
}

function renderWIht(){return '<div class="vc p-5"><h3 class="font-bold text-sm mb-2">Wie funktioniert die IHT?</h3><p class="text-xs text-gray-500 mb-3">Zahlungsmanagement fÃ¼r alle registrierten Standorte. Bestellprozess wie gewohnt.</p><div class="grid md:grid-cols-2 gap-3"><div class="p-3 bg-gray-50 rounded-xl"><h4 class="font-semibold text-[11px] mb-1">Rechnungsverarbeitung</h4><p class="text-[10px] text-gray-500">IHT digitalisiert â†’ MHK.net Archiv. Per Suche abrufbar oder an Steuerberater.</p></div><div class="p-3 bg-gray-50 rounded-xl"><h4 class="font-semibold text-[11px] mb-1">Zahlung & FlexibilitÃ¤t</h4><p class="text-[10px] text-gray-500">IHT zahlt in Skontofrist. WÃ¶chentlich wÃ¤hlbar: Sofort+Skonto oder Kontokorrent Cronbank.</p></div></div></div>';}

function renderWParts(){
    var lfdm=17;
    var h='<div class="vc p-5 mb-4"><h3 class="font-bold text-sm mb-2">Zentrale Parts-Empfehlung</h3><p class="text-xs text-gray-500 mb-3">Basierend auf laufenden Metern deiner ZubehÃ¶rwÃ¤nde (Daten aus Excel-Matrix).</p>';
    h+='<div class="p-3 rounded-xl border-2 mb-3" style="background:#fff7ed;border-color:var(--v)"><label class="text-[11px] font-semibold">Laufende Meter: </label><input type="range" min="5" max="25" value="17" id="lfdmSlider" oninput="document.getElementById(\'lfdmVal\').textContent=this.value" class="mx-2"><span id="lfdmVal" class="font-bold">17</span> lfdm</div></div>';
    
    var tc={Ergonomie:'pb',Service:'pg',Trend:'po','ZubehÃ¶r':'pgr'};
    h+='<div class="vc overflow-x-auto"><table class="dt"><thead><tr><th>Produktgruppe</th><th class="text-center">Typ</th><th class="text-right">lfdm</th><th class="text-right">Kapitalbedarf</th></tr></thead><tbody>';
    var total=0;
    partsPrio.forEach(function(p){
        var l=p['17']||0;
        total+=p.kap;
        h+='<tr><td class="font-semibold">'+p.n+'</td><td class="text-center"><span class="pill '+(tc[p.t]||'pgr')+'">'+p.t+'</span></td><td class="text-right font-semibold">'+l+'</td><td class="text-right">'+(p.kap>0?Math.round(p.kap).toLocaleString('de-DE')+'â‚¬':'â€”')+'</td></tr>';
    });
    h+='<tr class="font-bold" style="background:#f9fafb"><td>GESAMT</td><td></td><td class="text-right">17</td><td class="text-right">'+Math.round(total).toLocaleString('de-DE')+'â‚¬</td></tr>';
    h+='</tbody></table></div>';
    
    // WBP Markenrabatte
    h+='<div class="vc p-5 mt-4"><h3 class="font-bold text-sm mb-2">Wiener Bike Parts â€” Markenrabatte</h3><div class="overflow-x-auto"><table class="dt"><thead><tr><th>Marke</th><th>Kopfrabatt</th><th>Markenrabatt</th><th>Delkredere</th><th>Skonto</th></tr></thead><tbody>';
    wbpR.forEach(function(r){h+='<tr><td class="font-semibold">'+r.m+'</td><td class="text-xs">'+r.k+'</td><td class="text-xs">'+r.r+'</td><td class="text-xs">'+r.d+'</td><td class="text-xs">2%</td></tr>'});
    h+='</tbody></table></div><p class="text-[10px] text-gray-400 mt-2">Lieferung ab 100â‚¬ versandkostenfrei. Alle Preise zzgl. 2% Skonto 14 Tage.</p></div>';
    return h;
}

function renderWDb1(){return '<div class="vc p-5 mb-4"><h3 class="font-bold text-sm mb-2">DB1 â€” Deckungsbeitrag 1</h3><p class="text-xs text-gray-500 mb-3">Der echte Ertragswert nach MwSt-Bereinigung.</p><div class="grid md:grid-cols-3 gap-3"><div class="p-3 bg-gray-50 rounded-xl"><h4 class="text-[11px] font-semibold mb-1" style="color:#EF7D00">Handelsspanne 45%</h4><p class="text-[10px] text-gray-500">3.999â‚¬ Ã— 45% = 1.799â‚¬</p><p class="text-xs font-bold text-green-600 mt-1">DB1 = 1.161â‚¬</p></div><div class="p-3 bg-gray-50 rounded-xl"><h4 class="text-[11px] font-semibold mb-1" style="color:#EF7D00">Faktor 1,82</h4><p class="text-[10px] text-gray-500">3.999â‚¬ / 1,82 = 2.197â‚¬ HEK</p><p class="text-xs font-bold text-green-600 mt-1">DB1 = 1.163â‚¬</p></div><div class="p-3 rounded-xl text-white" style="background:#EF7D00"><h4 class="text-[11px] font-semibold mb-1">In Prozent</h4><p class="text-[10px] opacity-80">= 1.163 / 3.361</p><p class="text-lg font-bold mt-1">= 34,62%</p></div></div></div><div class="vc p-5"><h4 class="font-semibold text-xs mb-3">+3% DB1 aufs Ergebnis</h4><div class="grid md:grid-cols-2 gap-3"><div class="p-3 bg-gray-50 rounded-xl"><p class="text-xs font-semibold">Ohne</p><p class="text-base font-bold">100.000â‚¬</p></div><div class="p-3 bg-green-50 rounded-xl border border-green-200"><p class="text-xs font-semibold">Mit +3%</p><p class="text-base font-bold text-green-600">129.400â‚¬ (+29%)</p></div></div></div>';}

function renderWKern(){return '<div class="vc p-5"><h3 class="font-bold text-sm mb-2">Kernsortiment â€” 4-Marken-Politik</h3><p class="text-xs text-gray-500 mb-3">Max. 4 Bike-Marken pro Standort aus dem Pool.</p><div class="overflow-x-auto"><table class="dt"><thead><tr style="background:#EF7D00"><th class="text-white"></th><th class="text-white">E-Trekking</th><th class="text-white">E-City/Urban</th><th class="text-white">E-MTB</th><th class="text-white">E-Race/Gravel</th></tr></thead><tbody><tr><td class="font-bold" style="background:#fff7ed">Premium<br><span class="text-[9px] text-gray-400">ab 6kâ‚¬</span></td><td class="text-[11px]">R&MÂ·OrbeaÂ·SimplonÂ·Steppenwolf</td><td class="text-[11px]">R&MÂ·OrbeaÂ·SimplonÂ·Steppenwolf</td><td class="text-[11px]">OrbeaÂ·SimplonÂ·Steppenwolf</td><td class="text-[11px]">OrbeaÂ·Simplon</td></tr><tr><td class="font-bold" style="background:#eff6ff">Preis<br><span class="text-[9px] text-gray-400">bis 6kâ‚¬</span></td><td class="text-[11px]">VdVÂ·HaibikeÂ·WinoraÂ·Hepha</td><td class="text-[11px]">VdVÂ·WinoraÂ·Hepha</td><td class="text-[11px]">HaibikeÂ·Hepha</td><td class="text-[11px] text-gray-300">â€”</td></tr></tbody></table></div></div>';}

function renderWVo(){return '<div class="vc p-5"><h3 class="font-bold text-sm mb-2">Vororder & Nachorder</h3><p class="text-xs text-gray-500 mb-3">Cashflow: GroÃŸteil mit Nachordermarken planen.</p><div class="grid md:grid-cols-2 gap-4"><div class="p-4 bg-red-50 rounded-xl border border-red-200"><h4 class="font-bold text-xs mb-2">Vorordermarken</h4><p class="text-[10px] text-gray-500 mb-2">Verbindlich â†’ bessere Konditionen, hohe Kapitalbindung</p><div class="flex flex-wrap gap-1"><span class="pill pr">Haibike</span><span class="pill pr">Winora</span><span class="pill pr">Hepha</span><span class="pill pr">Steppenwolf</span></div></div><div class="p-4 bg-green-50 rounded-xl border border-green-200"><h4 class="font-bold text-xs mb-2">Nachordermarken</h4><p class="text-[10px] text-gray-500 mb-2">Konfigurierbar, weniger Kapitalbindung</p><div class="flex flex-wrap gap-1"><span class="pill pg">Orbea</span><span class="pill pg">R&amp;M</span><span class="pill pg">Simplon</span><span class="pill pg">Velo de Ville</span></div></div></div></div>';} 

        // === EINKAUF TAB NAVIGATION (Portal-adapted) ===

        function reRenderEkTab() {
            var activeBtn = document.querySelector('.ek-tab-btn.text-vit-orange') || document.querySelector('.hqek-tab-btn.text-vit-orange');
            if(activeBtn) {
                var tab = activeBtn.dataset.tab || activeBtn.dataset.hqek;
                if(activeBtn.classList.contains('hqek-tab-btn')) { showHqEkTab(tab); }
                else { showEinkaufTab(tab); }
            }
        }

        function showEinkaufTab(tabName) {
            document.querySelectorAll('.ek-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.ek-tab-btn').forEach(function(b){
                b.className='ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {sortiment:'Sortiment',lieferanten:'Lieferanten',zentralreg:'Zentralreg',ekStrategie:'EkStrategie',ekWissen:'EkWissen'};
            var el = document.getElementById('ekTab' + (tabMap[tabName]||''));
            if(el) el.style.display = 'block';
            var btn = document.querySelector('.ek-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';

            // Render tab content dynamically
            if(tabName==='sortiment') { var c=document.getElementById('ekTabSortiment'); if(c) c.innerHTML='<div class="fi">'+renderStSortiment()+'</div>'; }
            if(tabName==='lieferanten') { var c=document.getElementById('ekTabLieferanten'); if(c) c.innerHTML='<div class="fi">'+renderStLief()+'</div>'; }
            if(tabName==='zentralreg') { var c=document.getElementById('ekTabZentralreg'); if(c) c.innerHTML='<div class="fi">'+renderZR()+'</div>'; }
            if(tabName==='ekStrategie') { var c=document.getElementById('ekTabEkStrategie'); if(c) c.innerHTML='<div class="fi">'+renderStStrat()+'</div>'; }
            // ekWissen handled by Wissen override
        }

        // === HQ EINKAUF TAB NAVIGATION ===
        function showHqEkTab(tabName) {
            document.querySelectorAll('.hqek-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.hqek-tab-btn').forEach(function(b){
                b.className='hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {dash:'Dash',lief:'Lief',strat:'Strat'};
            var el = document.getElementById('hqEkTab' + (tabMap[tabName]||''));
            if(el) el.style.display = 'block';
            var btn = document.querySelector('.hqek-tab-btn[data-hqek="'+tabName+'"]');
            if(btn) btn.className='hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';

            if(tabName==='dash') { var c=document.getElementById('hqEkTabDash'); if(c) c.innerHTML='<div class="fi">'+renderHQDash()+'</div>'; }
            if(tabName==='lief') { var c=document.getElementById('hqEkTabLief'); if(c) c.innerHTML='<div class="fi">'+renderHQLief()+'</div>'; }
            if(tabName==='strat') { var c=document.getElementById('hqEkTabStrat'); if(c) c.innerHTML='<div class="fi">'+renderHQStrat()+'</div>'; }
        }

        // Init Einkauf on first open
        function initEinkaufModule() {
            showEinkaufTab('sortiment');
        }


        // === KOMMUNIKATION v3.0: Teams-Hybrid Layout ===
        var kommState = {
            activeConv: null,       // {type:'channel'|'inbox'|'announce', id:..., name:...}
            convList: [],           // all conversations for sidebar
            unreadInbox: 0,
            unreadAnnounce: 0,
            replyTo: null,          // {id, author, preview} for thread reply
            allUsers: [],           // cached users for recipient selection
            kanaele: [],
            realtimeSub: null,
            currentForumPost: null
        };

        // =============================================
        //  SIDEBAR: Load & render conversation list
        // =============================================
        async function loadKommSidebar() {
            var container = document.getElementById('kommConvList');
            if(!container) return;
            var uid = sbUser ? sbUser.id : null;
            var standortId = sbProfile ? sbProfile.standort_id : null;

            try {
                // 1. Load channels
                var chResp = await sb.from('chat_kanaele').select('*').order('created_at');
                if(!chResp.error) kommState.kanaele = chResp.data || [];

                // 2. Load inbox conversations (grouped by partner)
                var inboxResp = await sb.from('nachrichten').select('*, absender:von_user_id(name), empfaenger:an_user_id(name)')
                    .or('von_user_id.eq.' + uid + ',an_user_id.eq.' + uid + (standortId ? ',an_standort_id.eq.' + standortId : ''))
                    .order('created_at', {ascending: false});
                var inboxMsgs = !inboxResp.error ? (inboxResp.data || []) : [];

                // Group inbox by conversation partner
                var inboxConvs = {};
                inboxMsgs.forEach(function(m) {
                    var isSender = m.von_user_id === uid;
                    var partnerId = isSender ? m.an_user_id : m.von_user_id;
                    var partnerName = isSender ? (m.empfaenger ? m.empfaenger.name : 'Unbekannt') : (m.absender ? m.absender.name : 'Unbekannt');
                    if(!partnerId) { partnerId = 'standort'; partnerName = 'Standort-Nachrichten'; }
                    if(!inboxConvs[partnerId]) {
                        inboxConvs[partnerId] = { partnerId: partnerId, partnerName: partnerName, lastMsg: m, unread: 0, messages: [] };
                    }
                    inboxConvs[partnerId].messages.push(m);
                    if(!isSender && !m.gelesen) inboxConvs[partnerId].unread++;
                });

                // 3. Count unread
                kommState.unreadInbox = 0;
                Object.values(inboxConvs).forEach(function(c) { kommState.unreadInbox += c.unread; });

                // 4. Announcements unread count
                var ankResp = await sb.from('ankuendigungen').select('id');
                var ankAll = !ankResp.error ? (ankResp.data || []) : [];
                var gelesenResp = await sb.from('ankuendigungen_gelesen').select('ankuendigung_id').eq('user_id', uid || '');
                var gelesenIds = !gelesenResp.error ? (gelesenResp.data || []).map(function(g){return g.ankuendigung_id;}) : [];
                kommState.unreadAnnounce = ankAll.filter(function(a) { return gelesenIds.indexOf(a.id) === -1; }).length;

                // Build sidebar HTML
                var html = '';

                // --- Split channels into Netzwerk vs Standort ---
                var netzwerkKanaele = kommState.kanaele.filter(function(k) { return !k.standort_id; });
                var standortKanaele = kommState.kanaele.filter(function(k) { return !!k.standort_id; });

                // Netzwerk-KanÃ¤le (global, blau)
                html += '<div class="px-3 pt-3 pb-1 flex items-center justify-between"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ðŸŒ Netzwerk</span></div>';
                if(netzwerkKanaele.length === 0) {
                    html += '<div class="mx-2 px-3 py-1.5 text-[11px] text-gray-400">Keine Netzwerk-KanÃ¤le</div>';
                }
                netzwerkKanaele.forEach(function(k) {
                    var isActive = kommState.activeConv && kommState.activeConv.type === 'channel' && kommState.activeConv.id === k.id;
                    html += '<div class="komm-conv-item mx-2 px-3 py-2.5 rounded-lg cursor-pointer flex items-center space-x-3 ' + (isActive ? 'bg-blue-50 border-l-3 border-blue-500' : 'hover:bg-gray-100') + '" onclick="openKommConv(\'channel\',\'' + k.id + '\',\'' + escH(k.name).replace(/'/g,"\\'") + '\')">';
                    html += '<div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold text-xs flex-shrink-0">#</div>';
                    html += '<div class="flex-1 min-w-0"><p class="text-sm font-semibold text-gray-800 truncate">' + escH(k.name) + '</p>';
                    html += '<p class="text-[11px] text-blue-500 truncate">Netzwerk-Kanal</p></div>';
                    html += '</div>';
                });

                // Standort-KanÃ¤le (lokal, orange)
                var standortName = sbProfile && sbProfile.standort_id ? (Array.isArray(standorte) ? (standorte.find(function(s){return s.id===sbProfile.standort_id})||{}).name : (sbProfile.standort_name || '')) : '';
                html += '<div class="px-3 pt-4 pb-1 flex items-center justify-between"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ðŸª ' + (standortName ? escH(standortName) : 'Mein Standort') + '</span>';
                html += '<button onclick="kommCreateKanal()" class="text-gray-400 hover:text-vit-orange" title="Neuen Kanal erstellen"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>';
                html += '</div>';
                if(standortKanaele.length === 0) {
                    html += '<div class="mx-2 px-3 py-1.5 text-[11px] text-gray-400">Keine Standort-KanÃ¤le</div>';
                }
                standortKanaele.forEach(function(k) {
                    var isActive = kommState.activeConv && kommState.activeConv.type === 'channel' && kommState.activeConv.id === k.id;
                    html += '<div class="komm-conv-item mx-2 px-3 py-2.5 rounded-lg cursor-pointer flex items-center space-x-3 ' + (isActive ? 'bg-vit-orange/10 border-l-3 border-vit-orange' : 'hover:bg-gray-100') + '" onclick="openKommConv(\'channel\',\'' + k.id + '\',\'' + escH(k.name).replace(/'/g,"\\'") + '\')">';
                    html += '<div class="w-8 h-8 bg-vit-orange rounded-lg flex items-center justify-center text-white font-bold text-xs flex-shrink-0">#</div>';
                    html += '<div class="flex-1 min-w-0"><p class="text-sm font-semibold text-gray-800 truncate">' + escH(k.name) + '</p>';
                    html += '<p class="text-[11px] text-vit-orange truncate">Standort-Kanal</p></div>';
                    html += '</div>';
                });

                // --- Announcements ---
                html += '<div class="px-3 pt-4 pb-1 flex items-center justify-between"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">AnkÃ¼ndigungen</span>';
                if(kommState.unreadAnnounce > 0) html += '<span class="bg-red-500 text-white text-[10px] font-bold rounded-full px-1.5 py-0.5">' + kommState.unreadAnnounce + '</span>';
                html += '</div>';
                var isAnnActive = kommState.activeConv && kommState.activeConv.type === 'announce';
                html += '<div class="komm-conv-item mx-2 px-3 py-2.5 rounded-lg cursor-pointer flex items-center space-x-3 ' + (isAnnActive ? 'bg-vit-orange/10' : 'hover:bg-gray-100') + '" onclick="openKommConv(\'announce\',\'all\',\'AnkÃ¼ndigungen\')">';
                html += '<div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center text-white text-sm">ðŸ“¢</div>';
                html += '<div class="flex-1 min-w-0"><p class="text-sm font-semibold text-gray-800">Alle AnkÃ¼ndigungen</p>';
                html += '<p class="text-[11px] text-gray-400">Von der Zentrale</p></div>';
                if(kommState.unreadAnnounce > 0) html += '<span class="w-2.5 h-2.5 bg-red-500 rounded-full flex-shrink-0"></span>';
                html += '</div>';

                // --- Inbox Conversations ---
                html += '<div class="px-3 pt-4 pb-1 flex items-center justify-between"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Nachrichten</span>';
                if(kommState.unreadInbox > 0) html += '<span class="bg-red-500 text-white text-[10px] font-bold rounded-full px-1.5 py-0.5">' + kommState.unreadInbox + '</span>';
                html += '</div>';

                var sortedConvs = Object.values(inboxConvs).sort(function(a,b) { return new Date(b.lastMsg.created_at) - new Date(a.lastMsg.created_at); });
                if(sortedConvs.length === 0) {
                    html += '<div class="mx-2 px-3 py-2 text-xs text-gray-400 text-center">Keine Nachrichten</div>';
                }
                sortedConvs.forEach(function(conv) {
                    var isActive = kommState.activeConv && kommState.activeConv.type === 'inbox' && kommState.activeConv.id === conv.partnerId;
                    var initials = conv.partnerName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var colors = ['bg-emerald-500','bg-blue-500','bg-purple-500','bg-pink-500','bg-cyan-500','bg-red-500'];
                    var ci = conv.partnerName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                    var lastDate = new Date(conv.lastMsg.created_at);
                    var timeStr = isToday(lastDate) ? lastDate.getHours()+':'+String(lastDate.getMinutes()).padStart(2,'0') : lastDate.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit'});
                    var preview = conv.lastMsg.betreff || conv.lastMsg.inhalt || '';
                    if(preview.length > 40) preview = preview.substring(0,40) + 'â€¦';

                    html += '<div class="komm-conv-item mx-2 px-3 py-2.5 rounded-lg cursor-pointer flex items-center space-x-3 ' + (isActive ? 'bg-vit-orange/10' : 'hover:bg-gray-100') + '" onclick="openKommConv(\'inbox\',\'' + conv.partnerId + '\',\'' + escH(conv.partnerName).replace(/'/g,"\\'") + '\')">';
                    html += '<div class="w-8 h-8 ' + colors[ci] + ' rounded-full flex items-center justify-center text-white font-bold text-xs flex-shrink-0">' + initials + '</div>';
                    html += '<div class="flex-1 min-w-0"><div class="flex items-center justify-between"><p class="text-sm font-semibold text-gray-800 truncate">' + escH(conv.partnerName) + '</p><span class="text-[10px] text-gray-400 flex-shrink-0 ml-1">' + timeStr + '</span></div>';
                    html += '<p class="text-[11px] text-gray-500 truncate ' + (conv.unread > 0 ? 'font-semibold text-gray-700' : '') + '">' + escH(preview) + '</p></div>';
                    if(conv.unread > 0) html += '<span class="bg-vit-orange text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center flex-shrink-0">' + conv.unread + '</span>';
                    html += '</div>';
                });

                container.innerHTML = html;
                updateKommBadges();

            } catch(err) {
                console.error('Sidebar laden:', err);
                container.innerHTML = '<div class="p-4 text-xs text-red-400">Fehler: ' + err.message + '</div>';
            }
        }

        function isToday(d) { var t = new Date(); return d.getDate()===t.getDate() && d.getMonth()===t.getMonth() && d.getFullYear()===t.getFullYear(); }

        function filterKommSidebar(q) {
            q = q.toLowerCase();
            document.querySelectorAll('.komm-conv-item').forEach(function(el) {
                el.style.display = (!q || el.textContent.toLowerCase().indexOf(q) !== -1) ? '' : 'none';
            });
        }

        // =============================================
        //  OPEN CONVERSATION (right pane)
        // =============================================
        async function openKommConv(type, id, name) {
            kommState.activeConv = { type: type, id: id, name: name };
            kommState.replyTo = null;
            document.getElementById('kommReplyBar').classList.add('hidden');
            document.getElementById('kommChatInput').style.display = '';

            // Update header
            var avatar = document.getElementById('kommChatAvatar');
            var title = document.getElementById('kommChatTitle');
            var subtitle = document.getElementById('kommChatSubtitle');
            var actions = document.getElementById('kommChatHeaderActions');
            title.textContent = name;
            actions.innerHTML = '';

            if(type === 'channel') {
                var kanal = kommState.kanaele.find(function(k){return k.id===id;});
                var isNetzwerk = kanal && !kanal.standort_id;
                avatar.className = 'w-9 h-9 ' + (isNetzwerk ? 'bg-blue-500' : 'bg-vit-orange') + ' rounded-lg flex items-center justify-center text-white font-bold text-sm';
                avatar.textContent = '#';
                var kanalLabel = isNetzwerk ? 'ðŸŒ Netzwerk-Kanal' : 'ðŸª Standort-Kanal';
                subtitle.textContent = (kanal && kanal.beschreibung ? kanal.beschreibung + ' Â· ' : '') + kanalLabel;
                await loadChannelMessages(id);
                subscribeToChannel(id);
            } else if(type === 'inbox') {
                var initials = name.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                var colors = ['bg-emerald-500','bg-blue-500','bg-purple-500','bg-pink-500','bg-cyan-500','bg-red-500'];
                var ci = name.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                avatar.className = 'w-9 h-9 ' + colors[ci] + ' rounded-full flex items-center justify-center text-white font-bold text-sm';
                avatar.textContent = initials;
                subtitle.textContent = 'Direktnachricht';
                await loadInboxConversation(id);
            } else if(type === 'announce') {
                avatar.className = 'w-9 h-9 bg-yellow-500 rounded-lg flex items-center justify-center text-white text-sm';
                avatar.textContent = 'ðŸ“¢';
                subtitle.textContent = 'AnkÃ¼ndigungen von der Zentrale';
                document.getElementById('kommChatInput').style.display = sbProfile && sbProfile.is_hq ? '' : 'none';
                await loadAnnouncements();
            }

            // Re-highlight sidebar
            loadKommSidebar();
        }

        // =============================================
        //  CHANNEL MESSAGES
        // =============================================
        async function loadChannelMessages(kanalId) {
            var container = document.getElementById('kommChatMessages');
            container.innerHTML = '<div class="flex justify-center py-8"><span class="text-gray-400 text-sm">Nachrichten laden...</span></div>';

            try {
                var resp = await sb.from('chat_nachrichten').select('*, users(name)')
                    .eq('kanal_id', kanalId).order('created_at', {ascending:true});
                if(resp.error) throw resp.error;

                var messages = resp.data || [];
                container.innerHTML = renderChatBubbles(messages, 'channel');
                container.scrollTop = container.scrollHeight;
            } catch(err) {
                container.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">Fehler: ' + err.message + '</div>';
            }
        }

        function subscribeToChannel(kanalId) {
            if(kommState.realtimeSub) { sb.removeChannel(kommState.realtimeSub); kommState.realtimeSub = null; }
            kommState.realtimeSub = sb.channel('komm-chat-' + kanalId)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'chat_nachrichten',
                    filter: 'kanal_id=eq.' + kanalId
                }, async function(payload) {
                    var msg = payload.new;
                    if(msg.user_id === (sbUser ? sbUser.id : null)) return;
                    var userResp = await sb.from('users').select('name').eq('id', msg.user_id).single();
                    msg.users = userResp.data || { name: 'Unbekannt' };
                    var container = document.getElementById('kommChatMessages');
                    if(!container) return;
                    var bubble = renderSingleBubble(msg, 'channel');
                    container.insertAdjacentHTML('beforeend', bubble);
                    container.scrollTop = container.scrollHeight;
                }).subscribe();
        }

        // =============================================
        //  INBOX CONVERSATION (1:1 messages)
        // =============================================
        async function loadInboxConversation(partnerId) {
            var container = document.getElementById('kommChatMessages');
            container.innerHTML = '<div class="flex justify-center py-8"><span class="text-gray-400 text-sm">Nachrichten laden...</span></div>';
            var uid = sbUser ? sbUser.id : null;

            try {
                var resp = await sb.from('nachrichten').select('*, absender:von_user_id(name), empfaenger:an_user_id(name)')
                    .or('and(von_user_id.eq.' + uid + ',an_user_id.eq.' + partnerId + '),and(von_user_id.eq.' + partnerId + ',an_user_id.eq.' + uid + ')')
                    .order('created_at', {ascending:true});
                if(resp.error) throw resp.error;

                var msgs = resp.data || [];

                // Mark unread as read
                var unreadIds = msgs.filter(function(m){ return m.an_user_id === uid && !m.gelesen; }).map(function(m){return m.id;});
                if(unreadIds.length > 0) {
                    for(var i=0;i<unreadIds.length;i++) {
                        await sb.from('nachrichten').update({gelesen:true}).eq('id', unreadIds[i]);
                    }
                    kommState.unreadInbox = Math.max(0, kommState.unreadInbox - unreadIds.length);
                    updateKommBadges();
                }

                container.innerHTML = renderInboxBubbles(msgs);
                container.scrollTop = container.scrollHeight;
            } catch(err) {
                container.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">Fehler: ' + err.message + '</div>';
            }
        }

        function renderInboxBubbles(msgs) {
            if(msgs.length === 0) return '<div class="flex items-center justify-center h-full text-gray-400 text-sm">Noch keine Nachrichten in dieser Konversation</div>';
            var uid = sbUser ? sbUser.id : null;
            var html = '';
            var lastDateStr = '';

            msgs.forEach(function(m) {
                var d = new Date(m.created_at);
                var dateStr = d.toLocaleDateString('de-DE', {weekday:'short', day:'numeric', month:'long'});
                if(dateStr !== lastDateStr) {
                    html += '<div class="flex justify-center my-4"><span class="text-[11px] bg-gray-100 text-gray-500 px-3 py-1 rounded-full">' + dateStr + '</span></div>';
                    lastDateStr = dateStr;
                }

                var isMe = m.von_user_id === uid;
                var authorName = isMe ? 'Du' : (m.absender ? m.absender.name : 'Unbekannt');
                var time = d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');

                html += '<div class="flex ' + (isMe ? 'justify-end' : 'justify-start') + ' mb-2 group">';
                html += '<div class="max-w-[70%] ' + (isMe ? 'bg-vit-orange/10 border border-vit-orange/20' : 'bg-gray-100') + ' rounded-2xl ' + (isMe ? 'rounded-tr-sm' : 'rounded-tl-sm') + ' px-4 py-2.5">';
                if(m.betreff) html += '<p class="text-[11px] font-bold text-gray-500 mb-1">' + escH(m.betreff) + '</p>';
                html += '<p class="text-sm text-gray-800">' + escH(m.inhalt) + '</p>';
                html += '<div class="flex items-center justify-between mt-1.5">';
                html += '<span class="text-[10px] text-gray-400">' + time + '</span>';
                if(!isMe) html += '<button onclick="setReply(\'' + m.id + '\',\'' + escH(authorName).replace(/'/g,"\\'") + '\',\'' + escH(m.inhalt).substring(0,50).replace(/'/g,"\\'") + '\')" class="text-[10px] text-vit-orange font-semibold opacity-0 group-hover:opacity-100 ml-3 hover:underline">â†© Antworten</button>';
                html += '</div></div></div>';
            });
            return html;
        }

        // =============================================
        //  ANNOUNCEMENTS in chat view
        // =============================================
        async function loadAnnouncements() {
            var container = document.getElementById('kommChatMessages');
            container.innerHTML = '<div class="flex justify-center py-8"><span class="text-gray-400 text-sm">AnkÃ¼ndigungen laden...</span></div>';

            try {
                var resp = await sb.from('ankuendigungen').select('*, users(name)').order('created_at', {ascending:false});
                if(resp.error) throw resp.error;
                var anns = resp.data || [];

                var gelesenResp = await sb.from('ankuendigungen_gelesen').select('ankuendigung_id').eq('user_id', sbUser ? sbUser.id : '');
                var gelesenIds = !gelesenResp.error ? (gelesenResp.data||[]).map(function(g){return g.ankuendigung_id;}) : [];

                var icons = {news:'ðŸ“¢',event:'ðŸ“…',schulung:'ðŸŽ“',marketing:'ðŸ“£',sortiment:'ðŸš²',preise:'ðŸ’°',it:'ðŸ’»'};
                var html = '';
                anns.forEach(function(a) {
                    var d = new Date(a.created_at);
                    var dateStr = d.toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'long',year:'numeric'});
                    var time = d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
                    var gelesen = gelesenIds.indexOf(a.id) !== -1;
                    var authorName = a.users ? a.users.name : 'Zentrale';

                    html += '<div class="mb-4 group ' + (gelesen ? 'opacity-60' : '') + '">';
                    html += '<div class="flex justify-center mb-2"><span class="text-[11px] bg-gray-100 text-gray-500 px-3 py-1 rounded-full">' + dateStr + ' Â· ' + time + '</span></div>';
                    html += '<div class="bg-gradient-to-r ' + (a.wichtig ? 'from-red-50 to-orange-50 border border-red-200' : 'from-blue-50 to-indigo-50 border border-blue-200') + ' rounded-2xl px-5 py-4">';
                    html += '<div class="flex items-start space-x-3">';
                    html += '<div class="text-2xl flex-shrink-0">' + (icons[a.kategorie] || 'ðŸ“¢') + '</div>';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center space-x-2 mb-1">';
                    if(a.wichtig) html += '<span class="text-[10px] font-bold bg-red-100 text-red-600 rounded px-1.5 py-0.5">Wichtig</span>';
                    if(!gelesen) html += '<span class="text-[10px] font-bold bg-blue-100 text-blue-600 rounded px-1.5 py-0.5">Neu</span>';
                    html += '<span class="text-[11px] text-gray-400">' + escH(authorName) + '</span>';
                    html += '</div>';
                    html += '<h3 class="font-bold text-gray-800 text-sm mb-1">' + escH(a.titel) + '</h3>';
                    html += '<p class="text-sm text-gray-600">' + escH(a.inhalt) + '</p>';
                    if(!gelesen) html += '<button onclick="markAnkGelesen(\'' + a.id + '\',this)" class="mt-2 text-xs text-green-600 font-semibold hover:underline">âœ“ Als gelesen markieren</button>';
                    html += '</div></div></div></div>';
                });

                if(anns.length === 0) html = '<div class="flex items-center justify-center h-full text-gray-400 text-sm">Keine AnkÃ¼ndigungen</div>';
                container.innerHTML = html;
            } catch(err) {
                container.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">Fehler: ' + err.message + '</div>';
            }
        }

        async function markAnkGelesen(id, btn) {
            if(!sbUser) return;
            try {
                await sb.from('ankuendigungen_gelesen').upsert({ankuendigung_id: id, user_id: sbUser.id});
                var card = btn.closest('.mb-4.group');
                if(card) card.classList.add('opacity-60');
                btn.remove();
                kommState.unreadAnnounce = Math.max(0, kommState.unreadAnnounce - 1);
                updateKommBadges();
            } catch(err) { console.error('Gelesen markieren:', err); }
        }

        // =============================================
        //  RENDER CHAT BUBBLES (Channel)
        // =============================================
        function renderChatBubbles(messages, type) {
            if(messages.length === 0) return '<div class="flex items-center justify-center h-full text-gray-400 text-sm"><div class="text-center"><div class="text-3xl mb-2">ðŸ‘‹</div><p>Noch keine Nachrichten. Schreib die erste!</p></div></div>';
            var uid = sbUser ? sbUser.id : null;
            var html = '';
            var lastDateStr = '';
            var lastAuthor = '';

            messages.forEach(function(m) {
                var d = new Date(m.created_at);
                var dateStr = d.toLocaleDateString('de-DE', {weekday:'short', day:'numeric', month:'long'});
                if(dateStr !== lastDateStr) {
                    html += '<div class="flex justify-center my-4"><span class="text-[11px] bg-gray-100 text-gray-500 px-3 py-1 rounded-full">' + dateStr + '</span></div>';
                    lastDateStr = dateStr;
                    lastAuthor = '';
                }
                html += renderSingleBubble(m, type, lastAuthor === m.user_id);
                lastAuthor = m.user_id;
            });
            return html;
        }

        function renderSingleBubble(m, type, isConsecutive) {
            var uid = sbUser ? sbUser.id : null;
            var isMe = (type === 'channel') ? m.user_id === uid : m.von_user_id === uid;
            var authorName = m.users ? m.users.name : (m.absender ? m.absender.name : 'Unbekannt');
            var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
            var colors = ['bg-blue-500','bg-green-600','bg-purple-500','bg-cyan-600','bg-pink-500','bg-red-500','bg-teal-500'];
            var ci = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
            var d = new Date(m.created_at);
            var time = d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
            var text = type === 'channel' ? m.nachricht : m.inhalt;

            var html = '<div class="flex items-start space-x-2.5 group ' + (isConsecutive ? 'mt-0.5' : 'mt-3') + '">';
            if(!isConsecutive) {
                html += '<div class="w-8 h-8 ' + (isMe ? 'bg-vit-orange' : colors[ci]) + ' rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0 mt-0.5">' + initials + '</div>';
            } else {
                html += '<div class="w-8 flex-shrink-0 flex items-center justify-center"><span class="text-[9px] text-gray-300 opacity-0 group-hover:opacity-100">' + time + '</span></div>';
            }
            html += '<div class="flex-1 min-w-0">';
            if(!isConsecutive) {
                html += '<div class="flex items-baseline space-x-2 mb-0.5"><span class="text-sm font-semibold ' + (isMe ? 'text-vit-orange' : 'text-gray-800') + '">' + escH(authorName) + '</span><span class="text-[10px] text-gray-400">' + time + '</span></div>';
            }
            html += '<div class="text-sm text-gray-700 hover:bg-gray-50 rounded px-1 -mx-1 py-0.5 relative group">' + escH(text).replace(/\n/g, '<br>');
            // Reply button (thread)
            html += '<button onclick="setReply(\'' + m.id + '\',\'' + escH(authorName).replace(/'/g,"\\'") + '\',\'' + escH(text).substring(0,50).replace(/'/g,"\\'").replace(/\n/g,' ') + '\')" class="absolute right-1 top-0 text-[10px] text-gray-400 hover:text-vit-orange opacity-0 group-hover:opacity-100 bg-white px-1.5 py-0.5 rounded shadow-sm border">â†©</button>';
            html += '</div></div></div>';
            return html;
        }

        // =============================================
        //  REPLY / THREAD
        // =============================================
        function setReply(msgId, author, preview) {
            kommState.replyTo = { id: msgId, author: author, preview: preview };
            document.getElementById('kommReplyBar').classList.remove('hidden');
            document.getElementById('kommReplyTo').textContent = author;
            document.getElementById('kommReplyPreview').textContent = preview;
            document.getElementById('kommMsgInput').focus();
        }

        function cancelReply() {
            kommState.replyTo = null;
            document.getElementById('kommReplyBar').classList.add('hidden');
        }

        // =============================================
        //  SEND MESSAGE (unified)
        // =============================================
        async function kommSendMessage() {
            var input = document.getElementById('kommMsgInput');
            var text = input.value.trim();
            if(!text || !sbUser || !kommState.activeConv) return;

            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            var replyCtx = kommState.replyTo ? (' [â†© ' + kommState.replyTo.author + ': ' + kommState.replyTo.preview + ']') : '';
            cancelReply();

            try {
                var conv = kommState.activeConv;
                if(conv.type === 'channel') {
                    var resp = await sb.from('chat_nachrichten').insert({
                        kanal_id: conv.id, user_id: sbUser.id, nachricht: replyCtx ? text + '\n' + replyCtx : text
                    });
                    if(resp.error) throw resp.error;
                    // Optimistic append
                    var container = document.getElementById('kommChatMessages');
                    var emptyMsg = container.querySelector('.text-center');
                    if(emptyMsg && container.children.length === 1) container.innerHTML = '';
                    container.insertAdjacentHTML('beforeend', renderSingleBubble({
                        user_id: sbUser.id, users: {name: sbProfile ? sbProfile.name : 'Ich'},
                        nachricht: replyCtx ? text + '\n' + replyCtx : text, created_at: new Date().toISOString()
                    }, 'channel', false));
                    container.scrollTop = container.scrollHeight;

                } else if(conv.type === 'inbox') {
                    var resp = await sb.from('nachrichten').insert({
                        von_user_id: sbUser.id, an_user_id: conv.id,
                        betreff: '', inhalt: replyCtx ? text + '\n' + replyCtx : text,
                        kategorie: 'direkt'
                    });
                    if(resp.error) throw resp.error;
                    await loadInboxConversation(conv.id);

                } else if(conv.type === 'announce') {
                    // Only HQ can post announcements via chat
                    if(sbProfile && sbProfile.is_hq) {
                        var resp = await sb.from('ankuendigungen').insert({
                            erstellt_von: sbUser.id, titel: text.split('\n')[0].substring(0,80),
                            inhalt: text, kategorie: 'news', wichtig: false
                        });
                        if(resp.error) throw resp.error;
                        await loadAnnouncements();
                    }
                }
            } catch(err) {
                alert('Senden fehlgeschlagen: ' + err.message);
                input.value = text;
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        function kommInputKeydown(e) {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); kommSendMessage(); }
        }

        function kommAutoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        // =============================================
        //  NEW CHAT (compose to new recipient)
        // =============================================
        async function kommStartNewChat() {
            if(kommState.allUsers.length === 0) {
                var resp = await sb.from('users').select('id, name, is_hq, standorte(name)').eq('status','aktiv').order('name');
                if(!resp.error) kommState.allUsers = (resp.data||[]).filter(function(u){return u.id !== (sbUser?sbUser.id:null);});
            }

            var container = document.getElementById('kommChatMessages');
            document.getElementById('kommChatInput').style.display = '';
            document.getElementById('kommChatTitle').textContent = 'Neue Nachricht';
            document.getElementById('kommChatSubtitle').textContent = 'EmpfÃ¤nger wÃ¤hlen';
            document.getElementById('kommChatAvatar').className = 'w-9 h-9 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-sm';
            document.getElementById('kommChatAvatar').textContent = '+';

            var html = '<div class="p-4"><div class="mb-4">';
            html += '<select id="kommNewChatRecipient" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-vit-orange" onchange="kommSelectNewRecipient(this.value)">';
            html += '<option value="">â€“ EmpfÃ¤nger wÃ¤hlen â€“</option>';
            kommState.allUsers.forEach(function(u) {
                var label = u.name + (u.standorte ? ' (' + u.standorte.name + ')' : (u.is_hq ? ' (HQ)' : ''));
                html += '<option value="' + u.id + '" data-name="' + escH(label) + '">' + escH(label) + '</option>';
            });
            html += '</select></div>';
            html += '<div class="text-center text-gray-400 text-sm mt-8"><div class="text-3xl mb-2">âœ‰ï¸</div><p>WÃ¤hle einen EmpfÃ¤nger, um die Konversation zu starten</p></div></div>';

            container.innerHTML = html;
            kommState.activeConv = null;
        }

        function kommSelectNewRecipient(userId) {
            if(!userId) return;
            var sel = document.getElementById('kommNewChatRecipient');
            var opt = sel.options[sel.selectedIndex];
            var name = opt.getAttribute('data-name') || opt.textContent;
            openKommConv('inbox', userId, name);
        }

        // =============================================
        //  BADGES
        // =============================================
        // =============================================
        //  CREATE KANAL
        // =============================================
        async function kommCreateKanal() {
            var name = prompt('Name des neuen Kanals:');
            if(!name || !name.trim()) return;
            var beschreibung = prompt('Kurze Beschreibung (optional):') || '';
            try {
                var isHQ = sbProfile && sbProfile.is_hq;
                var resp = await sb.from('chat_kanaele').insert({
                    name: name.trim(),
                    beschreibung: beschreibung.trim() || null,
                    standort_id: isHQ ? null : (sbProfile ? sbProfile.standort_id : null),
                    erstellt_von: sbUser.id,
                    ist_privat: false
                });
                if(resp.error) throw resp.error;
                await loadKommSidebar();
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        function updateKommBadges() {
            var total = kommState.unreadInbox + kommState.unreadAnnounce;
            // Sidebar badge
            var sidebarBtn = document.querySelector('[data-module="kommunikation"]');
            if(sidebarBtn) {
                var sBadge = sidebarBtn.querySelector('.komm-sidebar-badge');
                if(total > 0) {
                    if(!sBadge) {
                        sidebarBtn.insertAdjacentHTML('beforeend', '<span class="komm-sidebar-badge ml-auto bg-red-500 text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center">' + total + '</span>');
                    } else {
                        sBadge.textContent = total;
                    }
                } else if(sBadge) { sBadge.remove(); }
            }
            // Chat tab badge
            var chatBtn = document.querySelector('.komm-tab-btn[data-tab="chat"]');
            if(chatBtn) {
                var cBadge = chatBtn.querySelector('.komm-chat-badge');
                if(total > 0) {
                    if(!cBadge) {
                        chatBtn.insertAdjacentHTML('beforeend', ' <span class="komm-chat-badge bg-red-500 text-white text-[10px] font-bold rounded-full px-1.5 py-0.5 ml-1">' + total + '</span>');
                    } else {
                        cBadge.textContent = total;
                    }
                } else if(cBadge) { cBadge.remove(); }
            }
        }

        // =============================================
        //  COMMUNITY (merged Forum + Brett)
        // =============================================
        var communityMarktplatzCats = ['suche','biete','tipp'];

        async function renderCommunityPosts(cat) {
            var container = document.getElementById('forumPosts');
            if(!container) return;
            container.innerHTML = '<div class="text-center py-4"><span class="text-gray-400 text-sm">BeitrÃ¤ge werden geladen...</span></div>';

            try {
                // Load forum posts
                var fQuery = sb.from('forum_beitraege').select('*, users(name)').order('gepinnt',{ascending:false}).order('created_at',{ascending:false});
                if(cat && cat !== 'all' && communityMarktplatzCats.indexOf(cat) === -1) fQuery = fQuery.eq('kategorie', cat);
                if(cat && communityMarktplatzCats.indexOf(cat) !== -1) fQuery = fQuery.eq('kategorie', 'NONE_MATCH');
                var fResp = await fQuery;
                var forumPosts = (!fResp.error ? fResp.data : []) || [];

                // Load brett entries
                var bQuery = sb.from('brett_eintraege').select('*, users(name)').eq('aktiv', true).order('created_at',{ascending:false});
                if(cat && cat !== 'all' && communityMarktplatzCats.indexOf(cat) !== -1) bQuery = bQuery.eq('kategorie', cat);
                if(cat && cat !== 'all' && communityMarktplatzCats.indexOf(cat) === -1) bQuery = bQuery.eq('kategorie', 'NONE_MATCH');
                var bResp = await bQuery;
                var brettPosts = (!bResp.error ? bResp.data : []) || [];

                // Merge into unified list
                var allPosts = [];
                forumPosts.forEach(function(p) {
                    allPosts.push({ source:'forum', id:p.id, titel:p.titel, inhalt:p.inhalt, kategorie:p.kategorie, user_id:p.user_id, users:p.users, created_at:p.created_at, gepinnt:p.gepinnt });
                });
                brettPosts.forEach(function(p) {
                    allPosts.push({ source:'brett', id:p.id, titel:p.titel, inhalt:p.beschreibung, kategorie:p.kategorie, user_id:p.user_id, users:p.users, created_at:p.created_at, gepinnt:false });
                });

                // Sort: pinned first, then by date
                allPosts.sort(function(a,b) {
                    if(a.gepinnt && !b.gepinnt) return -1;
                    if(!a.gepinnt && b.gepinnt) return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                // Load comment counts for forum posts
                var commentCounts = {};
                for(var i=0;i<forumPosts.length;i++) {
                    var cr = await sb.from('forum_kommentare').select('id',{count:'exact',head:true}).eq('beitrag_id', forumPosts[i].id);
                    commentCounts[forumPosts[i].id] = cr.count || 0;
                }

                var catColors = {
                    allgemein:'bg-gray-100 text-gray-700', verkauf:'bg-purple-100 text-purple-700', werkstatt:'bg-cyan-100 text-cyan-700',
                    einkauf:'bg-yellow-100 text-yellow-700', zentrale:'bg-orange-100 text-orange-700', news:'bg-vit-orange text-white',
                    suche:'bg-red-100 text-red-700', biete:'bg-green-100 text-green-700', tipp:'bg-blue-100 text-blue-700', frage:'bg-indigo-100 text-indigo-700'
                };
                var catLabels = {
                    allgemein:'ðŸ’¬ Allgemein', verkauf:'ðŸ›’ Verkauf', werkstatt:'ðŸ”§ Werkstatt', einkauf:'ðŸ“¦ Einkauf',
                    zentrale:'Zentrale', news:'News', suche:'ðŸ” Gesucht', biete:'ðŸ·ï¸ Biete', tipp:'ðŸ’¡ Tipp', frage:'â“ Frage'
                };

                var html = '';
                if(allPosts.length===0) html = '<div class="text-center py-8"><span class="text-gray-400 text-sm">Keine BeitrÃ¤ge. Starte die Diskussion!</span></div>';

                allPosts.forEach(function(p) {
                    var authorName = p.users ? p.users.name : 'Unbekannt';
                    var initials = authorName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var colors = ['bg-blue-500','bg-green-600','bg-purple-500','bg-cyan-600','bg-pink-500','bg-red-500'];
                    var colorIdx = authorName.split('').reduce(function(a,c){return a+c.charCodeAt(0);},0) % colors.length;
                    var d = new Date(p.created_at);
                    var dateStr = d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}) + ' Â· ' + d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
                    var isOwn = p.user_id === (sbUser ? sbUser.id : null);
                    var isHQ = sbProfile && sbProfile.is_hq;
                    var isMarkt = communityMarktplatzCats.indexOf(p.kategorie) !== -1;
                    var replyCount = commentCounts[p.id] || 0;

                    html += '<div class="vit-card p-5 hover:shadow-md transition cursor-pointer ' + (p.gepinnt ? 'border-l-4 border-vit-orange' : '') + (isMarkt ? ' border-l-4 border-green-400' : '') + '" ' + (p.source==='forum' ? 'onclick="openForumDetail(\'' + p.id + '\')"' : '') + '>';
                    html += '<div class="flex items-start space-x-4">';
                    html += '<div class="w-10 h-10 ' + (p.gepinnt ? 'bg-vit-orange' : colors[colorIdx]) + ' rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">' + initials + '</div>';
                    html += '<div class="flex-1 min-w-0">';
                    html += '<div class="flex items-center space-x-2 mb-1 flex-wrap">';
                    if(p.gepinnt) html += '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 rounded px-1.5 py-0.5">ðŸ“Œ Angepinnt</span>';
                    if(isMarkt) html += '<span class="text-[10px] font-bold bg-green-50 text-green-600 rounded px-1.5 py-0.5 border border-green-200">Marktplatz</span>';
                    html += '<span class="text-xs font-semibold rounded px-2 py-0.5 ' + (catColors[p.kategorie]||catColors.allgemein) + '">' + (catLabels[p.kategorie]||p.kategorie) + '</span>';
                    if(isOwn || isHQ) {
                        if(p.source==='forum') html += '<button onclick="event.stopPropagation();deleteForumPost(\'' + p.id + '\')" class="text-xs text-gray-300 hover:text-red-500 ml-auto" title="LÃ¶schen">ðŸ—‘ï¸</button>';
                        if(p.source==='brett') html += '<button onclick="event.stopPropagation();deactivateBrettPost(\'' + p.id + '\')" class="text-xs text-gray-300 hover:text-red-500 ml-auto" title="Entfernen">âœ•</button>';
                    }
                    html += '</div>';
                    html += '<h3 class="font-bold text-gray-800 mb-1 ' + (p.source==='forum'?'hover:text-vit-orange':'') + '">' + escH(p.titel) + '</h3>';
                    if(p.inhalt) html += '<p class="text-sm text-gray-600 mb-2 line-clamp-2">' + escH(p.inhalt) + '</p>';
                    html += '<div class="flex items-center space-x-4 text-xs text-gray-400">';
                    html += '<span class="font-semibold text-gray-600">' + escH(authorName) + '</span>';
                    html += '<span>' + dateStr + '</span>';
                    if(p.source==='forum') html += '<span>ðŸ’¬ ' + replyCount + '</span>';
                    if(isMarkt && !isOwn) html += '<button onclick="event.stopPropagation();openKommConv(\'inbox\',\'' + p.user_id + '\',\'' + escH(authorName).replace(/'/g,"\\'") + '\');showKommTab(\'chat\')" class="text-vit-orange font-semibold hover:underline">âœ‰ Nachricht</button>';
                    html += '</div></div></div></div>';
                });

                container.innerHTML = html;
            } catch(err) {
                container.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Fehler: ' + err.message + '</div>';
            }
        }

        async function createCommunityPost() {
            var titel = (document.getElementById('forumNewTitle')||{}).value;
            var body = (document.getElementById('forumNewBody')||{}).value;
            var kat = (document.getElementById('forumNewCat')||{}).value || 'allgemein';
            if(!titel||!titel.trim()) { alert('Bitte Betreff eingeben.'); return; }

            var isMarkt = communityMarktplatzCats.indexOf(kat) !== -1;
            try {
                if(isMarkt) {
                    var resp = await sb.from('brett_eintraege').insert({
                        user_id: sbUser.id, standort_id: sbProfile ? sbProfile.standort_id : null,
                        titel: titel.trim(), beschreibung: body ? body.trim() : null, kategorie: kat
                    });
                    if(resp.error) throw resp.error;
                } else {
                    if(!body||!body.trim()) { alert('Bitte Nachricht eingeben.'); return; }
                    var resp = await sb.from('forum_beitraege').insert({
                        user_id: sbUser.id, standort_id: sbProfile ? sbProfile.standort_id : null,
                        titel: titel.trim(), inhalt: body.trim(), kategorie: kat
                    });
                    if(resp.error) throw resp.error;
                }
                document.getElementById('forumNewTitle').value = '';
                document.getElementById('forumNewBody').value = '';
                document.getElementById('forumNewPost').classList.add('hidden');
                renderCommunityPosts('all');
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        async function deactivateBrettPost(id) {
            if(!confirm('Eintrag wirklich entfernen?')) return;
            try { await sb.from('brett_eintraege').update({aktiv:false}).eq('id',id); renderCommunityPosts('all'); } catch(err) { alert('Fehler: '+err.message); }
        }

        async function deleteForumPost(id) {
            if(!confirm('Beitrag wirklich lÃ¶schen?')) return;
            try {
                await sb.from('forum_kommentare').delete().eq('beitrag_id', id);
                await sb.from('forum_beitraege').delete().eq('id', id);
                renderCommunityPosts('all');
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        function filterCommunity(cat) {
            document.querySelectorAll('.comm-cat-btn').forEach(function(b){ b.className='comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200'; });
            var btn = document.querySelector('.comm-cat-btn[data-cat="'+cat+'"]');
            if(btn) btn.className='comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderCommunityPosts(cat);
        }

        async function openForumDetail(postId) {
            kommState.currentForumPost = postId;
            document.getElementById('forumListView').classList.add('hidden');
            document.getElementById('forumDetailView').classList.remove('hidden');
            var contentEl = document.getElementById('forumDetailContent');
            var commentsEl = document.getElementById('forumComments');
            try {
                var resp = await sb.from('forum_beitraege').select('*, users(name)').eq('id', postId).single();
                if(resp.error) throw resp.error;
                var p = resp.data;
                var authorName = p.users ? p.users.name : 'Unbekannt';
                var d = new Date(p.created_at);
                var dateStr = d.toLocaleDateString('de-DE',{weekday:'long',day:'2-digit',month:'long',year:'numeric'}) + ' um ' + d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');
                var html = '<div class="flex items-center space-x-2 mb-3">';
                if(p.gepinnt) html += '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 rounded px-2 py-0.5">ðŸ“Œ Angepinnt</span>';
                html += '<span class="text-xs text-gray-400">' + dateStr + '</span></div>';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-3">' + escH(p.titel) + '</h2>';
                html += '<div class="flex items-center space-x-2 mb-4"><span class="text-sm font-semibold text-gray-700">' + escH(authorName) + '</span></div>';
                html += '<div class="text-sm text-gray-700 whitespace-pre-wrap">' + escH(p.inhalt) + '</div>';
                contentEl.innerHTML = html;

                var commResp = await sb.from('forum_kommentare').select('*, users(name)').eq('beitrag_id', postId).order('created_at',{ascending:true});
                var comments = !commResp.error ? (commResp.data||[]) : [];
                var cHtml = '';
                if(comments.length===0) cHtml = '<div class="text-sm text-gray-400 py-2">Noch keine Kommentare. Sei der Erste!</div>';
                comments.forEach(function(c) {
                    var cName = c.users ? c.users.name : 'Unbekannt';
                    var cInit = cName.split(' ').map(function(n){return n[0];}).join('').substring(0,2);
                    var colors = ['bg-blue-500','bg-green-600','bg-purple-500','bg-cyan-600','bg-pink-500','bg-red-500'];
                    var cci = cName.split('').reduce(function(a,ch){return a+ch.charCodeAt(0);},0) % colors.length;
                    var cd = new Date(c.created_at);
                    cHtml += '<div class="flex items-start space-x-3 py-2 border-b border-gray-100">';
                    cHtml += '<div class="w-8 h-8 ' + colors[cci] + ' rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">' + cInit + '</div>';
                    cHtml += '<div class="flex-1"><div class="flex items-baseline space-x-2"><span class="font-semibold text-gray-800 text-sm">' + escH(cName) + '</span><span class="text-xs text-gray-400">' + cd.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit'}) + ' ' + cd.getHours()+':'+String(cd.getMinutes()).padStart(2,'0') + '</span></div>';
                    cHtml += '<p class="text-sm text-gray-700 mt-0.5">' + escH(c.inhalt) + '</p></div></div>';
                });
                commentsEl.innerHTML = cHtml;
            } catch(err) { contentEl.innerHTML = '<div class="text-red-400">Fehler: ' + err.message + '</div>'; }
        }

        async function postForumComment() {
            var input = document.getElementById('forumCommentInput');
            var text = input ? input.value.trim() : '';
            if(!text||!kommState.currentForumPost) { alert('Bitte Kommentar eingeben.'); return; }
            try {
                var resp = await sb.from('forum_kommentare').insert({ beitrag_id: kommState.currentForumPost, user_id: sbUser.id, inhalt: text });
                if(resp.error) throw resp.error;
                input.value = '';
                openForumDetail(kommState.currentForumPost);
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        function closeForumDetail() {
            document.getElementById('forumDetailView').classList.add('hidden');
            document.getElementById('forumListView').classList.remove('hidden');
            kommState.currentForumPost = null;
        }

        function showKommTab(tabName) {
            document.querySelectorAll('.komm-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.komm-tab-btn').forEach(function(b){
                b.className = b.className.replace(/bg-white text-gray-800 shadow-sm/g, 'text-gray-500 hover:text-gray-700').replace(/ shadow-sm/g, '');
            });
            var tabMap = {chat:'Chat',community:'Community'};
            var el = document.getElementById('kommTab' + (tabMap[tabName]||''));
            if(el) el.style.display = 'block';
            var btn = document.querySelector('.komm-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className = 'komm-tab-btn px-4 py-2 rounded-md text-sm font-semibold bg-white text-gray-800 shadow-sm';

            if(tabName==='chat') loadKommSidebar();
            if(tabName==='community') { closeForumDetail(); renderCommunityPosts('all'); }
        }

        // Init on first load
        loadKommSidebar();
        // === AKTENSCHRANK ===
        var aktenFiles = {};
        var aktenLoaded = false;

        async function loadAktenFiles() {
            if(aktenLoaded) return;
            try {
                var query = sb.from('standort_dokumente').select('*').order('erstellt_am', {ascending:false});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var resp = await query;
                if(!resp.error && resp.data && resp.data.length > 0) {
                    aktenFiles = {};
                    (resp.data||[]).forEach(function(d) {
                        var kat = d.kategorie || 'diverses';
                        if(!aktenFiles[kat]) aktenFiles[kat] = [];
                        aktenFiles[kat].push({
                            id: d.id, name: d.titel || d.datei_name,
                            type: (d.datei_name||'').split('.').pop().toUpperCase() || 'PDF',
                            date: d.erstellt_am ? new Date(d.erstellt_am).toLocaleDateString('de-DE') : '',
                            size: d.datei_groesse ? formatBytes(d.datei_groesse) : '',
                            path: d.datei_url
                        });
                    });
                    aktenLoaded = true;
                } else {
                    // Fallback: static demo data when DB is empty
                    aktenFiles = {
                        vertraege: [
                            {name:'Franchisevertrag vit:bikes 2024',type:'PDF',date:'15.01.2026',size:'2.4 MB'},
                            {name:'Mietvertrag Gewerbeflaeche',type:'PDF',date:'01.03.2024',size:'1.8 MB'},
                            {name:'Betriebshaftpflicht Police 2026',type:'PDF',date:'10.01.2026',size:'520 KB'}
                        ],
                        finanzen: [
                            {name:'BWA Januar 2026',type:'XLSX',date:'05.02.2026',size:'145 KB'},
                            {name:'Jahresabschluss 2024',type:'PDF',date:'30.06.2025',size:'3.1 MB'},
                            {name:'Planung 2026',type:'XLSX',date:'20.12.2025',size:'890 KB'}
                        ],
                        personal: [
                            {name:'Personalplanung 2026',type:'XLSX',date:'20.12.2025',size:'320 KB'},
                            {name:'Urlaubsplanung 2026',type:'XLSX',date:'10.01.2026',size:'85 KB'}
                        ],
                        standort: [
                            {name:'Grundriss Ladenflaeche',type:'PDF',date:'01.02.2024',size:'4.2 MB'},
                            {name:'Brandschutzkonzept',type:'PDF',date:'01.02.2024',size:'1.6 MB'}
                        ],
                        marketing: [
                            {name:'vit:bikes Brand Guidelines 2025',type:'PDF',date:'03.02.2026',size:'12.4 MB'},
                            {name:'Logo-Kit (alle Formate)',type:'ZIP',date:'15.01.2025',size:'8.7 MB'}
                        ],
                        lieferanten: [
                            {name:'Rahmenvertrag Kalkhoff/Derby 2026',type:'PDF',date:'20.01.2026',size:'890 KB'}
                        ],
                        diverses: [
                            {name:'Checkliste Saisonstart Fruehjahr',type:'PDF',date:'01.02.2026',size:'140 KB'}
                        ]
                    };
                    aktenLoaded = true;
                }
            } catch(err) { console.warn('Aktenschrank load:', err); }
        }

        var aktenFolderLabels = {
            vertraege:'Vertraege & Recht', finanzen:'Finanzen & Buchhaltung', personal:'Personal & HR',
            standort:'Standort & Betrieb', marketing:'Marketing & Branding', lieferanten:'Lieferanten & Einkauf', diverses:'Diverses'
        };

        function getFileIcon(type) {
            var colors = {PDF:'text-red-500',XLSX:'text-green-600',DOCX:'text-blue-600',ZIP:'text-yellow-600',JPG:'text-purple-500'};
            return '<span class="font-mono text-xs font-bold px-2 py-1 rounded '+(colors[type]||'text-gray-500')+' bg-gray-100">'+type+'</span>';
        }

        function openDokUploadModal() {
            var html = '<div id="dokUpOverlay" onclick="closeDokUpModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:480px;max-width:95vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDCC4 Dokument hochladen</h3><button onclick="closeDokUpModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Titel *</label><input id="dokUpTitel" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="z.B. Richtlinie Preisgestaltung"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Kategorie</label><select id="dokUpKat" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="richtlinie">Richtlinie</option><option value="vorlage">Vorlage</option><option value="schulung">Schulung</option><option value="vertrag">Vertrag</option><option value="sonstiges">Sonstiges</option></select></div>';
            html += '<div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center"><p class="text-sm text-gray-500 mb-2">Datei auswaehlen</p><input type="file" id="dokUpFile" class="text-sm"></div>';
            html += '</div>';
            html += '<div id="dokUpError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveDokUpload()" id="dokUpBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Hochladen</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'dokUpContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closeDokUpModal() { var c = document.getElementById('dokUpContainer'); if(c) c.remove(); }
        async function saveDokUpload() {
            var titel = (document.getElementById('dokUpTitel')||{}).value;
            var kat = (document.getElementById('dokUpKat')||{}).value||'sonstiges';
            var fileInput = document.getElementById('dokUpFile');
            var errEl = document.getElementById('dokUpError');
            var btn = document.getElementById('dokUpBtn');
            if(!titel||!titel.trim()) { if(errEl){errEl.textContent='Bitte Titel eingeben.';errEl.style.display='block';} return; }
            if(!fileInput||!fileInput.files||!fileInput.files[0]) { if(errEl){errEl.textContent='Bitte Datei auswaehlen.';errEl.style.display='block';} return; }
            if(btn){btn.disabled=true;btn.textContent='Wird hochgeladen...';}
            try {
                var file = fileInput.files[0];
                var path = 'netzwerk/'+kat+'/'+Date.now()+'_'+file.name;
                var upResp = await sb.storage.from('dokumente').upload(path, file, {upsert:true});
                if(upResp.error) throw upResp.error;
                var urlResp = sb.storage.from('dokumente').getPublicUrl(path);
                await sb.from('netzwerk_dokumente').insert({
                    titel:titel.trim(), kategorie:kat, datei_url:path, datei_name:file.name,
                    datei_groesse:file.size, mime_type:file.type,
                    erstellt_von:sbUser?sbUser.id:null
                });
                closeDokUpModal();
                alert('\u2705 Dokument hochgeladen!');
                loadNetzwerkDokumente();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn){btn.disabled=false;btn.textContent='Hochladen';}
            }
        }

        async function openAktenFolder(folderId) {
            if(!aktenLoaded) await loadAktenFiles();
            var files = aktenFiles[folderId] || [];
            document.getElementById('aktenFolderTitle').textContent = aktenFolderLabels[folderId] || folderId;
            var html = '';
            files.forEach(function(f) {
                html += '<tr class="border-b hover:bg-gray-50">';
                html += '<td class="py-3 px-4"><div class="flex items-center space-x-3">' + getFileIcon(f.type) + '<span class="font-medium text-gray-800">' + f.name + '</span></div></td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.type + '</td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.date + '</td>';
                html += '<td class="py-3 px-4 text-gray-500">' + f.size + '</td>';
                html += '<td class="py-3 px-4 text-right"><button class="text-vit-orange hover:underline text-sm font-semibold mr-3">Oeffnen</button><button class="text-gray-400 hover:text-red-500 text-sm">Loeschen</button></td>';
                html += '</tr>';
            });
            document.getElementById('aktenFileList').innerHTML = html;
            document.getElementById('aktenFolders').style.display = 'none';
            document.getElementById('aktenFolderDetail').classList.remove('hidden');
        }

        function closeAktenFolder() {
            document.getElementById('aktenFolders').style.display = '';
            document.getElementById('aktenFolderDetail').classList.add('hidden');
        }

        function filterAkten() {
            var q = document.getElementById('aktenSearch').value.toLowerCase();
            document.querySelectorAll('.akten-folder').forEach(function(f) {
                var text = f.textContent.toLowerCase();
                f.style.display = text.indexOf(q) >= 0 ? '' : 'none';
            });
        }

        // Init verkauf - DB loading happens on tab switch after login
        renderPipeline();

        // Check for existing Supabase session
        checkSession();

        // === CONTROLLING TABS ===
        function showControllingTab(tabName) {
            document.querySelectorAll('.ctrl-tab-content').forEach(function(t) { t.style.display = 'none'; });
            document.querySelectorAll('.ctrl-tab-btn').forEach(function(b) {
                b.className = 'ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabId = 'ctrlTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            var el = document.getElementById(tabId);
            if (el) el.style.display = 'block';
            var btn = document.querySelector('.ctrl-tab-btn[data-tab="' + tabName + '"]');
            if (btn) btn.className = 'ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        function showBwaDetail(id) {
            // Legacy stub - now handled by showBwaFromDb
        }

        // =============================================
        // BWA PARSER MODULE (Auto-Detect 8 Formate)
        // =============================================
        var BwaParser=(function(){'use strict';var BWA_ZEILEN={1020:{name:'UmsatzerlÃ¶se',gruppe:'UmsatzerlÃ¶se',summe:true},1040:{name:'BestandsverÃ¤nderg. FE/UE',gruppe:'BestandsverÃ¤nderungen',summe:true},1045:{name:'Aktivierte Eigenleistungen',gruppe:'Eigenleistungen',summe:true},1050:{name:'Sonstige betriebliche ErlÃ¶se',gruppe:'Sonstige ErlÃ¶se',summe:true},1051:{name:'Gesamtleistung',gruppe:'Gesamtleistung',summe:true},1060:{name:'Material-/Wareneinkauf',gruppe:'Materialaufwand',summe:true},1080:{name:'Rohertrag',gruppe:'Rohertrag',summe:true},1100:{name:'Sonstige betriebliche ErlÃ¶se',gruppe:'Sonstige ErlÃ¶se',summe:true},1120:{name:'Betrieblicher Rohertrag',gruppe:'Betrieblicher Rohertrag',summe:true},1140:{name:'Personalkosten',gruppe:'Personalkosten',summe:true},1150:{name:'LÃ¶hne und GehÃ¤lter',gruppe:'Personalkosten',summe:false},1155:{name:'Soziale Abgaben',gruppe:'Personalkosten',summe:false},1160:{name:'Raumkosten',gruppe:'Raumkosten',summe:true},1170:{name:'Betriebliche Steuern',gruppe:'Steuern/Versicherungen',summe:true},1175:{name:'Versicherungen/BeitrÃ¤ge',gruppe:'Steuern/Versicherungen',summe:true},1180:{name:'Kfz-Kosten',gruppe:'Fahrzeugkosten',summe:true},1190:{name:'Werbe-/Reisekosten',gruppe:'Werbe-/Reisekosten',summe:true},1200:{name:'Kosten der Warenabgabe',gruppe:'Warenabgabekosten',summe:true},1210:{name:'Abschreibungen',gruppe:'Abschreibungen',summe:true},1220:{name:'Reparatur/Instandhaltung',gruppe:'Instandhaltung',summe:true},1240:{name:'Sonstige Kosten',gruppe:'Sonstige Kosten',summe:true},1250:{name:'Gesamtkosten',gruppe:'Gesamtkosten',summe:true},1260:{name:'Summe betriebliche Aufwendungen',gruppe:'Summe Aufwendungen',summe:true},1270:{name:'Betriebsergebnis',gruppe:'Betriebsergebnis',summe:true},1280:{name:'Zinsaufwand',gruppe:'Zinsen',summe:true},1285:{name:'Zinsertrag',gruppe:'Zinsen',summe:true},1290:{name:'Neutraler Aufwand',gruppe:'Neutrales Ergebnis',summe:true},1295:{name:'Neutraler Ertrag',gruppe:'Neutrales Ergebnis',summe:true},1300:{name:'Ergebnis vor Steuern',gruppe:'Ergebnis',summe:true},1370:{name:'VorlÃ¤ufiges Ergebnis',gruppe:'Ergebnis',summe:true}};
        var KOMPAKT_MAP={'umsatzerlÃ¶se':{gruppe:'UmsatzerlÃ¶se',zeile:1020,summe:true},'umsatzerl.':{gruppe:'UmsatzerlÃ¶se',zeile:1020,summe:true},'gesamterlÃ¶se':{gruppe:'Gesamtleistung',zeile:1051,summe:true},'gesamtleistung':{gruppe:'Gesamtleistung',zeile:1051,summe:true},'bestandsverÃ¤nderg. fe/ue':{gruppe:'BestandsverÃ¤nderungen',zeile:1040,summe:true},'wareneinsatz':{gruppe:'Materialaufwand',zeile:1060,summe:true},'wareneinsatz / material- und stoffverbrauch':{gruppe:'Materialaufwand',zeile:1060,summe:true},'material-/wareneinkauf':{gruppe:'Materialaufwand',zeile:1060,summe:true},'mat./wareneinkauf':{gruppe:'Materialaufwand',zeile:1060,summe:true},'rohertrag':{gruppe:'Rohertrag',zeile:1080,summe:true},'sonstige betriebliche erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'sonst. betr. erlÃ¶se':{gruppe:'Sonstige ErlÃ¶se',zeile:1100,summe:true},'betrieblicher rohertrag':{gruppe:'Betrieblicher Rohertrag',zeile:1120,summe:true},'personalkosten':{gruppe:'Personalkosten',zeile:1140,summe:true},'personalaufwand':{gruppe:'Personalkosten',zeile:1140,summe:true},'lÃ¶hne/gehÃ¤lter':{gruppe:'Personalkosten',zeile:1150,summe:false},'lÃ¶hne und gehÃ¤lter':{gruppe:'Personalkosten',zeile:1150,summe:false},'ges. soz. aufwendung':{gruppe:'Personalkosten',zeile:1155,summe:false},'soziale abgaben':{gruppe:'Personalkosten',zeile:1155,summe:false},'raumkosten':{gruppe:'Raumkosten',zeile:1160,summe:true},'betriebliche steuern':{gruppe:'Steuern/Versicherungen',zeile:1170,summe:true},'vers./beitr./steuern':{gruppe:'Steuern/Versicherungen',zeile:1175,summe:true},'versicherungen / beitrÃ¤ge':{gruppe:'Steuern/Versicherungen',zeile:1175,summe:true},'kfz. kosten':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'kfz.-kosten (ohne steuer)':{gruppe:'Fahrzeugkosten',zeile:1180,summe:true},'werbe- und reisekost':{gruppe:'Werbe-/Reisekosten',zeile:1190,summe:true},'werbe- / reisekosten':{gruppe:'Werbe-/Reisekosten',zeile:1190,summe:true},'kosten warenabgabe':{gruppe:'Warenabgabekosten',zeile:1200,summe:true},'kosten der warenabgabe':{gruppe:'Warenabgabekosten',zeile:1200,summe:true},'afa anlageverm.':{gruppe:'Abschreibungen',zeile:1210,summe:false},'afa umlaufverm.':{gruppe:'Abschreibungen',zeile:1210,summe:false},'afa gesamt':{gruppe:'Abschreibungen',zeile:1210,summe:true},'abschreibungen':{gruppe:'Abschreibungen',zeile:1210,summe:true},'instandhaltung':{gruppe:'Instandhaltung',zeile:1220,summe:true},'reparatur/instandhaltung':{gruppe:'Instandhaltung',zeile:1220,summe:true},'sonstige kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:true},'verschiedene kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:true},'gesamtkosten':{gruppe:'Gesamtkosten',zeile:1250,summe:true},'summe kosten':{gruppe:'Gesamtkosten',zeile:1250,summe:true},'summe betr.aufw.':{gruppe:'Summe Aufwendungen',zeile:1260,summe:true},'betriebsergebnis':{gruppe:'Betriebsergebnis',zeile:1270,summe:true},'zinsertrag':{gruppe:'Zinsen',zeile:1285,summe:false},'zinsaufwand':{gruppe:'Zinsen',zeile:1280,summe:false},'neutraler aufwand':{gruppe:'Neutrales Ergebnis',zeile:1290,summe:false},'neutraler ertrag':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:false},'neutrales ergebnis':{gruppe:'Neutrales Ergebnis',zeile:1295,summe:true},'ergebnis vor steuern':{gruppe:'Ergebnis',zeile:1300,summe:true},'vorl. ergebnis':{gruppe:'Ergebnis',zeile:1370,summe:true},'vorlÃ¤ufiges ergebnis':{gruppe:'Ergebnis',zeile:1370,summe:true},'besondere kosten':{gruppe:'Sonstige Kosten',zeile:1240,summe:false}};
        function grv(sheet,rowNum){var vals=[];var range=XLSX.utils.decode_range(sheet['!ref']||'A1');for(var c=range.s.c;c<=range.e.c;c++){var cell=sheet[XLSX.utils.encode_cell({r:rowNum-1,c:c})];vals.push(cell?(cell.v!==undefined?cell.v:''):'');}return vals;}
        function gcv(sheet,row,col){var cell=sheet[XLSX.utils.encode_cell({r:row-1,c:col-1})];return cell?(cell.v!==undefined?cell.v:null):null;}
        function toNum(val){if(val===null||val===undefined||val===''||val===' ')return null;if(typeof val==='number')return val;var s=String(val).trim().replace(/\s/g,'');if(s===''||s==='-')return null;s=s.replace(/\./g,'').replace(',','.');var n=parseFloat(s);return isNaN(n)?null:n;}
        function normBez(bez){if(!bez)return '';return String(bez).trim().replace(/\s+/g,' ');}
        function lookupK(bez){var key=normBez(bez).toLowerCase();return KOMPAKT_MAP[key]||null;}
        function extractMJ(filename){var result={monat:null,jahr:null,standort:''};var jahrMatch=filename.match(/(20\d{2})/);if(jahrMatch)result.jahr=parseInt(jahrMatch[1]);var monate={'januar':1,'jan':1,'februar':2,'feb':2,'mÃ¤rz':3,'maerz':3,'marz':3,'mrz':3,'april':4,'apr':4,'mai':5,'juni':6,'jun':6,'juli':7,'jul':7,'august':8,'aug':8,'september':9,'sep':9,'oktober':10,'okt':10,'november':11,'nov':11,'dezember':12,'dez':12};var lower=filename.toLowerCase().replace(/_/g,'').replace(/Ã¤/g,'ae').replace(/Ã¶/g,'oe').replace(/Ã¼/g,'ue');for(var m in monate){if(lower.includes(m)){result.monat=monate[m];break;}}var parts=filename.replace(/\.[^.]+$/,'').split('_');if(parts.length>=3){if(parts[0].toLowerCase()==='bwa')result.standort=parts[2].replace(/U_berarbeitet|MF|Version.*$/gi,'').trim();if(parts[0].toLowerCase()==='planung')result.standort=parts[1];}return result;}
        function detectFmt(sheet,filename){var r1=grv(sheet,1);var r2=grv(sheet,2);var r1s=r1.join(' ').toLowerCase();var r2s=r2.join(' ').toLowerCase();var isJ=filename.toLowerCase().includes('jahr');if(filename.toLowerCase().includes('planung'))return{format:'planung',typ:'plan'};if(r1s.includes('zeile')&&r1s.includes('bezeichnung')&&r1s.includes('konto')&&r1s.includes('konten'))return{format:'datev_wertenachweis',typ:isJ?'jahr':'monat'};var r3=grv(sheet,3);var r3s=r3.join(' ').toLowerCase();if(r3s.includes('zeile')&&r3s.includes('bezeichnung')&&r3s.includes('konto'))return{format:'datev_wertenachweis_offset',typ:isJ?'jahr':'monat'};if(r1s.includes('summen')&&r1s.includes('salden'))return{format:'susa',typ:'monat'};if(r2s.includes('konto')&&r2s.includes('beschriftung')&&r2s.includes('eb-wert'))return{format:'susa',typ:'monat'};if(r1s.includes('kanzlei-rechnungswesen')&&r2s.includes('zeile')&&r2s.includes('konto')&&r2s.includes('verÃ¤nderung'))return{format:'datev_vorjahresvergleich',typ:isJ?'jahr':'monat'};if(r1s.includes('kanzlei-rechnungswesen')&&r2s.includes('zeile')&&r2s.includes('konto'))return{format:'datev_erfolgsrechnung',typ:isJ?'jahr':'monat'};if(r1s.includes('datev-bwa')||r1s.includes('betriebswirtschaftliche auswertung'))return{format:'datev_jahresuebersicht',typ:'jahr'};if(r1s.includes('bezeichnung')&&(r1s.includes('monat')||r1s.includes('ums.%')||r1s.includes('ges.-leistg'))){if(r1.length>10||isJ)return{format:'kompakt_jahr',typ:'jahr'};return{format:'kompakt',typ:'monat'};}if(r1s.includes('bezeichnung')){var c2=sheet['B1']?sheet['B1'].v:null;if(c2 instanceof Date||(typeof c2==='number'&&c2>40000))return{format:'kompakt_datum',typ:'monat'};if(typeof c2==='number'||c2 instanceof Date)return{format:'kompakt_jahr_datum',typ:'jahr'};}return{format:'unbekannt',typ:isJ?'jahr':'monat'};}
        function parseDWN(sheet,meta,hRow){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var cz=null;var cb='';for(var r=hRow;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var bez=gcv(sheet,r+1,2);var konto=gcv(sheet,r+1,3);var kontoBez=gcv(sheet,r+1,5)||gcv(sheet,r+1,4);var wM=gcv(sheet,r+1,7);var wB=gcv(sheet,r+1,8);var wK=gcv(sheet,r+1,9);var wKB=gcv(sheet,r+1,10);if(zeile&&typeof zeile==='number'&&zeile>=1000){cz=zeile;cb=normBez(bez||kontoBez||'');}if(toNum(wM)===null&&toNum(wB)===null&&toNum(wK)===null)continue;var iS=(zeile&&zeile>=1000)&&(wB!==null);var dB=kontoBez?normBez(kontoBez):cb;if(!dB)continue;var bi=cz?BWA_ZEILEN[cz]:null;rows.push({zeile:cz,konto:konto?String(konto):null,kontengruppe:bi?bi.gruppe:(cb||''),bezeichnung:iS?(bi?bi.name:dB):dB,wert:toNum(iS?wB:wM),wert_kumuliert:toNum(iS?wKB:wK),ist_summenzeile:iS,ebene:iS?0:(konto?2:1),sortierung:si++});}return rows;}
        function parseKompakt(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var wCol=2;var kCol=null;var vjCol=null;var header=grv(sheet,1);for(var i=1;i<header.length;i++){var h=String(header[i]).toLowerCase();if(h.includes('monat')||h.includes('2025')||h.includes('2024')||header[i] instanceof Date)wCol=i+1;if(h.includes('lfd. jahr')||h.includes('jan/'))kCol=i+1;if(h.includes('vj. monat')||h.includes('vorjahr'))vjCol=i+1;}for(var r=1;r<=range.e.r;r++){var bez=gcv(sheet,r+1,1);if(!bez||typeof bez!=='string')continue;bez=normBez(bez);if(bez.includes('Bezeichnung')||bez.includes('Kostenarten'))continue;var mapped=lookupK(bez);var wert=toNum(gcv(sheet,r+1,wCol));var kum=kCol?toNum(gcv(sheet,r+1,kCol)):null;var vj=vjCol?toNum(gcv(sheet,r+1,vjCol)):null;if(wert===null&&kum===null)continue;rows.push({zeile:mapped?mapped.zeile:null,konto:null,kontengruppe:mapped?mapped.gruppe:bez,bezeichnung:bez,wert:wert,wert_kumuliert:kum,wert_vorjahr:vj,ist_summenzeile:mapped?mapped.summe:false,ebene:0,sortierung:si++});}return rows;}
        function parseDER(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var cz=null;for(var r=2;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var konto=gcv(sheet,r+1,2);var bez=gcv(sheet,r+1,3);var wM=gcv(sheet,r+1,4);var wK=gcv(sheet,r+1,9);if(zeile&&typeof zeile==='number'&&zeile>=1000)cz=zeile;if(!bez||toNum(wM)===null)continue;bez=normBez(bez);var iS=(zeile&&zeile>=1000);var bi=cz?BWA_ZEILEN[cz]:null;rows.push({zeile:cz,konto:konto?String(konto):null,kontengruppe:bi?bi.gruppe:'',bezeichnung:bez,wert:toNum(wM),wert_kumuliert:toNum(wK),ist_summenzeile:iS,ebene:iS?0:(konto?2:1),sortierung:si++});}return rows;}
        function parseDVJ(sheet,meta){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=2;r<=range.e.r;r++){var zeile=gcv(sheet,r+1,1);var bez=gcv(sheet,r+1,2);var wM=gcv(sheet,r+1,3);var wVj=gcv(sheet,r+1,4);var wK=gcv(sheet,r+1,7);var wVjK=gcv(sheet,r+1,8);if(!zeile||typeof zeile!=='number'||zeile<1000)continue;if(toNum(wM)===null&&toNum(wK)===null)continue;var bi=BWA_ZEILEN[zeile];bez=normBez(bez||(bi?bi.name:''));rows.push({zeile:zeile,konto:null,kontengruppe:bi?bi.gruppe:'',bezeichnung:bez,wert:toNum(wM),wert_kumuliert:toNum(wK),wert_vorjahr:toNum(wVj),wert_vorjahr_kumuliert:toNum(wVjK),ist_summenzeile:true,ebene:0,sortierung:si++});}return rows;}
        function parseJU(sheet,meta,startRow){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=startRow;r<=range.e.r;r++){var bez=gcv(sheet,r+1,1);if(!bez||typeof bez!=='string')continue;bez=normBez(bez);if(bez.includes('Kurzfristige Erfolgsrechnung')||bez.includes('Kostenarten'))continue;var mapped=lookupK(bez);var mw={};var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];var summe=null;for(var c=1;c<=Math.min(13,range.e.c);c++){var val=toNum(gcv(sheet,r+1,c+1));if(c<=12)mw[mn[c-1]]=val||0;else summe=val;}if(summe===null){summe=0;for(var m in mw)summe+=(mw[m]||0);}rows.push({bezeichnung:bez,kontengruppe:mapped?mapped.gruppe:bez,konto:null,jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:summe,ist_summenzeile:mapped?mapped.summe:false,sortierung:si++});}return rows;}
        function parseCsvJ(text,meta){var lines=text.split('\n');var rows=[];var si=0;var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];for(var i=1;i<lines.length;i++){var parts=lines[i].split(';');if(parts.length<2)continue;var bez=normBez(parts[0]);if(!bez||bez.includes('Kurzfristige Erfolgsrechnung'))continue;var mapped=lookupK(bez);var mw={};var summe=0;for(var c=1;c<=Math.min(13,parts.length-1);c++){var val=toNum(parts[c]);if(c<=12)mw[mn[c-1]]=val||0;else summe=val;}if(summe===0)for(var m in mw)summe+=(mw[m]||0);rows.push({bezeichnung:bez,kontengruppe:mapped?mapped.gruppe:bez,jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:Math.round(summe*100)/100,ist_summenzeile:mapped?mapped.summe:false,sortierung:si++});}return rows;}
        function parsePBwa(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;for(var r=4;r<=range.e.r;r++){var gruppe=gcv(sheet,r+1,2);var kontoNr=gcv(sheet,r+1,3);var konto=gcv(sheet,r+1,4);var aktBwa=gcv(sheet,r+1,5);var ytd=gcv(sheet,r+1,6);var ds=gcv(sheet,r+1,7);var hr=gcv(sheet,r+1,8);if(!kontoNr&&!konto)continue;var bez=normBez(konto||'');if(!bez)continue;var pw={};var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];var sm=0;for(var c=0;c<12;c++){var val=toNum(gcv(sheet,r+1,10+c));pw[mn[c]]=val||0;sm+=(val||0);}rows.push({kontengruppe:normBez(gruppe||''),konto:kontoNr?String(kontoNr):null,bezeichnung:bez,vorjahr_aktuell:toNum(aktBwa),vorjahr_ytd:toNum(ytd),vorjahr_durchschnitt:toNum(ds),vorjahr_hochrechnung:toNum(hr),jan:pw.jan,feb:pw.feb,mrz:pw.mrz,apr:pw.apr,mai:pw.mai,jun:pw.jun,jul:pw.jul,aug:pw.aug,sep:pw.sep,okt:pw.okt,nov:pw.nov,dez:pw.dez,summe:Math.round(sm*100)/100,sortierung:si++});}return rows;}
        function parsePUms(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);var si=0;var mn=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];for(var r=4;r<=range.e.r;r++){var marke=gcv(sheet,r+1,3);if(!marke||typeof marke!=='string'||marke==='0')continue;marke=normBez(marke);if(marke.toLowerCase().includes('planung')||marke.toLowerCase().includes('gesamt'))continue;var mw={};var sm=0;for(var c=0;c<12;c++){var val=toNum(gcv(sheet,r+1,4+c));mw[mn[c]]=val||0;sm+=(val||0);}if(sm===0)continue;rows.push({marke:marke,kategorie:'FahrrÃ¤der',jan:mw.jan,feb:mw.feb,mrz:mw.mrz,apr:mw.apr,mai:mw.mai,jun:mw.jun,jul:mw.jul,aug:mw.aug,sep:mw.sep,okt:mw.okt,nov:mw.nov,dez:mw.dez,summe:sm,sortierung:si++});}return rows;}
        function parsePPers(sheet){var rows=[];var range=XLSX.utils.decode_range(sheet['!ref']);for(var r=3;r<=range.e.r;r++){var nn=gcv(sheet,r+1,1);var vn=gcv(sheet,r+1,2);if(!nn||typeof nn!=='string')continue;if(nn.includes('Gesamt')||nn.includes('AB Zeile')||nn.includes('Nachname'))continue;var td=function(v){if(!v)return null;if(v instanceof Date)return v.toISOString().split('T')[0];return null;};rows.push({nachname:normBez(nn),vorname:normBez(vn||''),status:gcv(sheet,r+1,3)||'',standort_name:gcv(sheet,r+1,4)||'',abteilung:gcv(sheet,r+1,5)||'',position:gcv(sheet,r+1,7)||'',wochenarbeitszeit:toNum(gcv(sheet,r+1,8)),stundenlohn:toNum(gcv(sheet,r+1,9)),anstelldatum:td(gcv(sheet,r+1,10)),austrittsdatum:td(gcv(sheet,r+1,11)),fixgehalt:toNum(gcv(sheet,r+1,12)),gehalt_neu_1:toNum(gcv(sheet,r+1,13)),gehalt_neu_1_ab:td(gcv(sheet,r+1,14)),gehalt_neu_2:toNum(gcv(sheet,r+1,15)),gehalt_neu_2_ab:td(gcv(sheet,r+1,16))});}return rows;}
        function parseFile(file,callback){var filename=file.name;var meta=extractMJ(filename);meta.dateiname=filename;var reader=new FileReader();if(filename.toLowerCase().endsWith('.csv')){reader.onload=function(e){var text=e.target.result;var header=text.split('\n')[0]||'';meta.format=header.includes('Bezeichnung')&&header.includes('EUR')?'csv_jahresuebersicht':'csv_unbekannt';meta.typ='jahr';var result={meta:meta,bwa_daten:[],bwa_jahr_daten:[],plan_bwa:[],plan_umsaetze:[],plan_personal:[]};if(meta.format==='csv_jahresuebersicht')result.bwa_jahr_daten=parseCsvJ(text,meta);callback(null,result);};reader.readAsText(file,'utf-8');}else{reader.onload=function(e){try{var wb=XLSX.read(e.target.result,{type:'array',cellDates:true});var sn=wb.SheetNames[0];var ws=wb.Sheets[sn];var det=detectFmt(ws,filename);meta.format=det.format;meta.typ=det.typ;var result={meta:meta,bwa_daten:[],bwa_jahr_daten:[],plan_bwa:[],plan_umsaetze:[],plan_personal:[]};if(meta.format==='planung'){wb.SheetNames.forEach(function(s){var w=wb.Sheets[s];var sl=s.toLowerCase();if(sl.includes('bwa'))result.plan_bwa=parsePBwa(w);else if(sl.includes('umsÃ¤tze')||sl.includes('umsaetze'))result.plan_umsaetze=parsePUms(w);else if(sl.includes('personal'))result.plan_personal=parsePPers(w);});meta.typ='plan';callback(null,result);return;}switch(meta.format){case 'datev_wertenachweis':result.bwa_daten=parseDWN(ws,meta,1);break;case 'datev_wertenachweis_offset':result.bwa_daten=parseDWN(ws,meta,3);break;case 'kompakt':case 'kompakt_datum':result.bwa_daten=parseKompakt(ws,meta);break;case 'datev_erfolgsrechnung':result.bwa_daten=parseDER(ws,meta);break;case 'datev_vorjahresvergleich':result.bwa_daten=parseDVJ(ws,meta);break;case 'kompakt_jahr':case 'kompakt_jahr_datum':case 'datev_jahresuebersicht':var sr=0;for(var r=0;r<5;r++){var v=gcv(ws,r+1,1);if(v&&String(v).toLowerCase().includes('umsatzerlÃ¶se')){sr=r;break;}if(v&&String(v).toLowerCase().includes('bezeichnung')){sr=r+1;break;}}result.bwa_jahr_daten=parseJU(ws,meta,sr);break;default:result.bwa_daten=parseKompakt(ws,meta);}callback(null,result);}catch(err){callback(err,null);}};reader.readAsArrayBuffer(file);}};return{parseFile:parseFile,extractMonatJahr:extractMJ,BWA_ZEILEN:BWA_ZEILEN,KOMPAKT_MAP:KOMPAKT_MAP};})();

        // =============================================
        // BWA SUPABASE FUNCTIONS
        // =============================================
        var bwaCache = [];
        var selectedBwaId = null;

        var monatNamen = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

        function eur(val) {
            if(val===null||val===undefined) return 'â€”';
            var n = parseFloat(val);
            return n.toLocaleString('de-DE', {minimumFractionDigits:0, maximumFractionDigits:0});
        }
        function eurColor(val) {
            var n = parseFloat(val)||0;
            return n >= 0 ? 'text-gray-800' : 'text-red-600';
        }
        function diffHtml(ist, plan) {
            if(!plan) return '<td class="text-right py-2 px-3 text-gray-300">â€”</td>';
            var d = parseFloat(ist) - parseFloat(plan);
            var cl = d >= 0 ? 'text-green-600' : 'text-red-600';
            var prefix = d >= 0 ? '+' : '';
            return '<td class="text-right py-2 px-3 '+cl+' font-semibold">'+prefix+eur(d)+'</td>';
        }

        async function loadBwaList() {
            var container = document.getElementById('bwaFileList');
            if(!container) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                console.log('[BWA] loadBwaList() called, stdId:', stdId, 'is_hq:', sbProfile ? sbProfile.is_hq : 'no profile');
                var query = sb.from('bwa_daten').select('id,monat,jahr,umsatzerloese,rohertrag,ergebnis_vor_steuern,datei_name,datei_url,created_at').order('jahr', {ascending:false}).order('monat', {ascending:false});
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                bwaCache = resp.data || [];
                if(bwaCache.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Noch keine BWAs erfasst.</p>';
                    return;
                }
                // Load corrected ergebnis from detail positions (Zeile 1355, 1300, or 1370)
                var bwaIds = bwaCache.map(function(b){ return b.id; });
                var detResp = await sb.from('bwa_detail_positionen').select('bwa_id,zeile,wert').in('bwa_id', bwaIds).in('zeile', [1300, 1355, 1370]).eq('ist_summenzeile', true);
                var detMap = {};
                if(detResp.data) detResp.data.forEach(function(d){ 
                    var val = parseFloat(d.wert)||0;
                    // PrioritÃ¤t: 1355 > 1300 > 1370
                    if(!detMap[d.bwa_id] || d.zeile === 1355 || (d.zeile === 1300 && !detMap[d.bwa_id + '_z1355'])) {
                        detMap[d.bwa_id] = val;
                        if(d.zeile === 1355) detMap[d.bwa_id + '_z1355'] = true;
                    }
                });
                // Group by year
                var years = {};
                bwaCache.forEach(function(b) {
                    if(!years[b.jahr]) years[b.jahr] = [];
                    years[b.jahr].push(b);
                });
                var h = '';
                Object.keys(years).sort(function(a,b){return b-a;}).forEach(function(yr) {
                    var items = years[yr];
                    h += '<div class="mb-3">';
                    h += '<button onclick="this.nextElementSibling.classList.toggle(\'hidden\')" class="flex items-center justify-between w-full text-left p-2 bg-gray-100 rounded-lg hover:bg-gray-200">';
                    h += '<span class="font-semibold text-gray-700">ðŸ“ '+yr+'</span>';
                    h += '<span class="text-gray-400 text-xs">'+items.length+' BWA'+(items.length>1?'s':'')+'</span></button>';
                    h += '<div class="mt-2 space-y-1">';
                    items.forEach(function(b) {
                        var isSelected = selectedBwaId === b.id;
                        // Use corrected ergebnis from detail positions if available
                        var erg = detMap[b.id] !== undefined ? detMap[b.id] : parseFloat(b.ergebnis_vor_steuern);
                        var ergClass = erg >= 0 ? 'text-green-600' : 'text-red-500';
                        h += '<div class="flex items-center gap-1">';
                        h += '<button onclick="showBwaFromDb(\''+b.id+'\')" class="bwa-file-db flex-1 flex items-center justify-between p-2.5 rounded-lg hover:bg-orange-50 text-left'+(isSelected?' bg-orange-50 border border-vit-orange':'')+'">';
                        h += '<div class="flex items-center space-x-3"><span class="text-red-500">ðŸ“„</span>';
                        h += '<div><p class="text-sm font-semibold '+(isSelected?'text-vit-orange':'text-gray-800')+'">'+monatNamen[b.monat]+' '+b.jahr+'</p>';
                        h += '<p class="text-xs text-gray-500">Umsatz: '+eur(b.umsatzerloese)+' â‚¬</p></div></div>';
                        h += '<span class="text-xs '+ergClass+'">'+eur(erg)+' â‚¬</span>';
                        h += '</button>';
                        h += '<button onclick="downloadBwa(\''+b.id+'\')" class="p-2 text-gray-400 hover:text-vit-orange rounded-lg hover:bg-orange-50" title="BWA herunterladen"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></button>';
                        h += '</div>';
                    });
                    h += '</div></div>';
                });
                container.innerHTML = h;
            } catch(err) { console.error('[BWA] loadBwaList error:', err); container.innerHTML = '<p class="text-sm text-red-400 text-center py-4">Fehler: '+err.message+'</p><button onclick="loadBwaList()" class="text-xs text-vit-orange underline mt-2">Erneut versuchen</button>'; }
        }

        async function downloadBwa(bwaId) {
            try {
                // Load BWA summary
                var resp = await sb.from('bwa_daten').select('*').eq('id', bwaId).single();
                if(resp.error) throw resp.error;
                var b = resp.data;

                // If original file exists in storage, download that
                if(b.datei_url) {
                    var dlResp = await sb.storage.from('bwa-dateien').download(b.datei_url);
                    if(dlResp.data) {
                        var url = URL.createObjectURL(dlResp.data);
                        var a = document.createElement('a');
                        a.href = url; a.download = b.datei_name || ('BWA_'+monatNamen[b.monat]+'_'+b.jahr+'.csv');
                        document.body.appendChild(a); a.click(); document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        return;
                    }
                }

                // Otherwise generate CSV from detail positions
                var detResp = await sb.from('bwa_detail_positionen').select('*').eq('bwa_id', bwaId).order('sortierung');
                var rows = (detResp.data && detResp.data.length > 0) ? detResp.data : null;
                var csv = '\uFEFF'; // BOM for Excel
                csv += 'BWA ' + monatNamen[b.monat] + ' ' + b.jahr + '\n\n';
                csv += 'Position;Monat;Kumuliert\n';

                if(rows) {
                    rows.forEach(function(d) {
                        var prefix = d.ist_summenzeile ? '' : '  ';
                        var name = (prefix + (d.bezeichnung||'')).replace(/;/g, ',');
                        var wert = d.wert !== null ? d.wert.toString().replace('.', ',') : '';
                        var kum = d.wert_kumuliert !== null ? d.wert_kumuliert.toString().replace('.', ',') : '';
                        csv += name + ';' + wert + ';' + kum + '\n';
                    });
                } else {
                    // Fallback: use summary fields
                    csv += 'UmsatzerlÃ¶se;' + b.umsatzerloese + ';\n';
                    csv += 'Wareneinsatz;' + b.wareneinsatz + ';\n';
                    csv += 'Rohertrag;' + b.rohertrag + ';\n';
                    csv += 'Personalkosten;' + b.personalkosten + ';\n';
                    csv += 'Raumkosten;' + b.raumkosten + ';\n';
                    csv += 'Werbekosten;' + b.werbekosten + ';\n';
                    csv += 'Abschreibungen;' + b.abschreibungen + ';\n';
                    csv += 'Sonstige Kosten;' + b.sonstige_kosten + ';\n';
                    csv += 'Gesamtkosten;' + b.gesamtkosten + ';\n';
                    csv += 'Betriebsergebnis;' + b.betriebsergebnis + ';\n';
                    csv += 'Zinsaufwand;' + b.zinsaufwand + ';\n';
                    csv += 'Ergebnis vor Steuern;' + b.ergebnis_vor_steuern + ';\n';
                }

                var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url; a.download = 'BWA_' + monatNamen[b.monat] + '_' + b.jahr + '.csv';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch(err) {
                console.error('[BWA Download]', err);
                alert('Download fehlgeschlagen: ' + err.message);
            }
        }

        async function showBwaFromDb(bwaId) {
            selectedBwaId = bwaId;
            try {
                var resp = await sb.from('bwa_daten').select('*').eq('id', bwaId).single();
                if(resp.error) throw resp.error;
                var b = resp.data;
                // Update title
                document.getElementById('bwaTitle').textContent = 'BWA ' + monatNamen[b.monat] + ' ' + b.jahr;
                document.getElementById('bwaEditBtn').style.display = '';
                document.getElementById('bwaDeleteBtn').style.display = '';
                // KPIs
                var marge = parseFloat(b.umsatzerloese) > 0 ? ((parseFloat(b.rohertrag)/parseFloat(b.umsatzerloese))*100).toFixed(1) : 0;
                var ergMarge = parseFloat(b.umsatzerloese) > 0 ? ((parseFloat(b.ergebnis_vor_steuern)/parseFloat(b.umsatzerloese))*100).toFixed(1) : 0;
                document.getElementById('bwaKpiUmsatz').textContent = eur(b.umsatzerloese) + ' â‚¬';
                document.getElementById('bwaKpiUmsatzVj').textContent = b.plan_umsatz ? 'Plan: '+eur(b.plan_umsatz)+' â‚¬' : '';
                document.getElementById('bwaKpiRohertrag').textContent = eur(b.rohertrag) + ' â‚¬';
                document.getElementById('bwaKpiMarge').textContent = 'Marge: '+marge+'%';
                document.getElementById('bwaKpiKosten').textContent = eur(b.gesamtkosten) + ' â‚¬';
                document.getElementById('bwaKpiKostenVj').textContent = b.plan_gesamtkosten ? 'Plan: '+eur(b.plan_gesamtkosten)+' â‚¬' : '';
                var ergEl = document.getElementById('bwaKpiErgebnis');
                ergEl.textContent = eur(b.ergebnis_vor_steuern) + ' â‚¬';
                ergEl.className = 'text-xl font-bold ' + (parseFloat(b.ergebnis_vor_steuern) >= 0 ? 'text-green-600' : 'text-red-600');
                document.getElementById('bwaKpiErgebnisMarge').textContent = 'Marge: '+ergMarge+'%';

                // Detail table - try loading from bwa_detail_positionen first
                var detailResp = await sb.from('bwa_detail_positionen').select('*').eq('bwa_id', bwaId).order('sortierung');
                var detailRows = (detailResp.data && detailResp.data.length > 0) ? detailResp.data : null;

                // Recalculate KPIs from detail positions if available (sign-inversion correction)
                if(detailRows) {
                    var sumMap = {};
                    detailRows.forEach(function(d) { if(d.ist_summenzeile && d.zeile) sumMap[d.zeile] = d; });
                    // BWA Zeilen: 1000=UmsatzerlÃ¶se, 1040=Rohertrag, 1300=Betriebsergebnis, 1355=Vorl.Ergebnis
                    var detUmsatz = sumMap[1000] ? parseFloat(sumMap[1000].wert)||0 : parseFloat(b.umsatzerloese)||0;
                    var detRohertrag = sumMap[1040] ? parseFloat(sumMap[1040].wert)||0 : parseFloat(b.rohertrag)||0;
                    var detErgebnis = sumMap[1355] ? parseFloat(sumMap[1355].wert)||0 : (sumMap[1300] ? parseFloat(sumMap[1300].wert)||0 : parseFloat(b.ergebnis_vor_steuern)||0);
                    // Gesamtkosten berechnen: Summe aller Kostenpositionen aus Detail-Zeilen
                    var detKosten = 0;
                    // Methode 1: Direkt aus Summenzeile 1250 (Gesamtkosten) oder 1260 (Summe Aufwendungen)
                    if(sumMap[1250]) { detKosten = parseFloat(sumMap[1250].wert)||0; }
                    else if(sumMap[1260]) { detKosten = parseFloat(sumMap[1260].wert)||0; }
                    else {
                        // Methode 2: Alle Kostengruppen-Summen addieren
                        var kostenZeilen = [1140,1160,1170,1175,1180,1190,1200,1210,1220,1240];
                        var kostenSumme = 0;
                        kostenZeilen.forEach(function(z) {
                            if(sumMap[z]) kostenSumme += Math.abs(parseFloat(sumMap[z].wert)||0);
                        });
                        if(kostenSumme > 0) { detKosten = -kostenSumme; }
                        else if(detRohertrag) {
                            // Methode 3: Rohertrag - Betriebsergebnis
                            var betriebsErg = sumMap[1270] ? parseFloat(sumMap[1270].wert)||0 : (sumMap[1300] ? parseFloat(sumMap[1300].wert)||0 : 0);
                            if(betriebsErg) detKosten = betriebsErg - detRohertrag;
                        }
                    }
                    console.log('[BWA] Gesamtkosten-Berechnung:', {z1250:sumMap[1250]?sumMap[1250].wert:'n/a', z1260:sumMap[1260]?sumMap[1260].wert:'n/a', berechnet:detKosten});
                    // Override KPIs with corrected values
                    var detMarge = detUmsatz > 0 ? ((detRohertrag/detUmsatz)*100).toFixed(1) : 0;
                    var detErgMarge = detUmsatz > 0 ? ((detErgebnis/detUmsatz)*100).toFixed(1) : 0;
                    document.getElementById('bwaKpiUmsatz').textContent = eur(detUmsatz) + ' â‚¬';
                    document.getElementById('bwaKpiRohertrag').textContent = eur(detRohertrag) + ' â‚¬';
                    document.getElementById('bwaKpiMarge').textContent = 'Marge: '+detMarge+'%';
                    if(detKosten) document.getElementById('bwaKpiKosten').textContent = eur(detKosten) + ' â‚¬';
                    var ergEl2 = document.getElementById('bwaKpiErgebnis');
                    ergEl2.textContent = eur(detErgebnis) + ' â‚¬';
                    ergEl2.className = 'text-xl font-bold ' + (detErgebnis >= 0 ? 'text-green-600' : 'text-red-600');
                    document.getElementById('bwaKpiErgebnisMarge').textContent = 'Marge: '+detErgMarge+'%';
                    console.log('[BWA] KPIs recalculated from detail positions:', {umsatz:detUmsatz, rohertrag:detRohertrag, kosten:detKosten, ergebnis:detErgebnis});
                    // Permanently fix wrong values in bwa_daten
                    if(Math.abs(detErgebnis - (parseFloat(b.ergebnis_vor_steuern)||0)) > 1) {
                        var fixData = {ergebnis_vor_steuern: detErgebnis, rohertrag: detRohertrag, umsatzerloese: detUmsatz};
                        if(detKosten && Math.abs(detKosten - (parseFloat(b.gesamtkosten)||0)) > 1) fixData.gesamtkosten = detKosten;
                        sb.from('bwa_daten').update(fixData).eq('id', bwaId).then(function(r){
                            if(!r.error) { console.log('[BWA] DB values corrected for', bwaId); loadBwaList(); }
                            else console.warn('[BWA] DB fix failed:', r.error);
                        });
                    }
                }
                
                var tbody = '';
                if(detailRows) {
                    // Zeige alle Detail-Positionen aus dem Parser
                    var lastGruppe = '';
                    detailRows.forEach(function(d) {
                        var isSumme = d.ist_summenzeile;
                        var isDetail = d.ebene >= 2;
                        var cls = isSumme ? 'bg-gray-50 border-b-2 border-gray-300' : 'border-b border-gray-100';
                        var tdBold = isSumme ? 'font-semibold' : '';
                        var indent = isDetail ? 'pl-6 text-xs text-gray-500' : (d.ebene === 1 ? 'pl-3 text-sm' : '');
                        
                        // Gruppenheader
                        if(isSumme && d.kontengruppe && d.kontengruppe !== lastGruppe) {
                            lastGruppe = d.kontengruppe;
                        }
                        
                        // Highlight fÃ¼r wichtige Summenzeilen
                        var hlCls = '';
                        if(d.kontengruppe === 'Rohertrag' && isSumme) { cls = 'bg-blue-50 border-b-2 border-blue-200'; hlCls = 'text-blue-800'; }
                        if(d.kontengruppe === 'Ergebnis' && isSumme) { 
                            var ergVal = parseFloat(d.wert)||0;
                            cls = (ergVal >= 0 ? 'bg-green-50 border-t-2 border-green-400' : 'bg-red-50 border-t-2 border-red-400');
                            hlCls = ergVal >= 0 ? 'text-green-800' : 'text-red-800';
                        }
                        if(d.kontengruppe === 'Betriebsergebnis' && isSumme) cls = 'bg-orange-50 border-b-2 border-orange-200';
                        if(d.kontengruppe === 'Gesamtkosten' || d.kontengruppe === 'Summe Aufwendungen') cls = 'bg-gray-100 border-b-2 border-gray-400';
                        
                        tbody += '<tr class="'+cls+'">';
                        tbody += '<td class="py-1.5 px-3 '+tdBold+' '+hlCls+' '+indent+'">';
                        if(isDetail && d.konto) tbody += '<span class="text-gray-400 text-[10px] mr-1">'+d.konto+'</span> ';
                        tbody += (d.bezeichnung||'')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 '+tdBold+' '+hlCls+' '+eurColor(d.wert)+'">'+eur(d.wert)+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-400">'+(d.wert_kumuliert ? eur(d.wert_kumuliert) : 'â€”')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-400">'+(d.wert_vorjahr ? eur(d.wert_vorjahr) : 'â€”')+'</td>';
                        tbody += '<td class="text-right py-1.5 px-3 text-gray-300">'+(d.prozent_gesamtleistung ? d.prozent_gesamtleistung+'%' : '')+'</td>';
                        tbody += '</tr>';
                    });
                    // Update table header for detail view
                    document.querySelector('#bwaDetailTable thead tr').innerHTML = 
                        '<th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Monat</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Kumuliert</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Vorjahr</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">%</th>';
                } else {
                    // Fallback: Standard-Ansicht aus Zusammenfassung
                    var rows = [
                        {label:'Umsatzerloese', ist:b.umsatzerloese, plan:b.plan_umsatz, bold:true},
                        {label:'  Fahrraeder', ist:b.davon_fahrraeder, sub:true},
                        {label:'  Teile & Zubehoer', ist:b.davon_teile, sub:true},
                        {label:'  Service / Reparatur', ist:b.davon_service, sub:true},
                        {label:'  Skonti', ist:b.davon_skonti, sub:true},
                        {label:'Wareneinsatz', ist:b.wareneinsatz, plan:b.plan_wareneinsatz, bold:true, bg:'bg-gray-50'},
                        {label:'Rohertrag', ist:b.rohertrag, plan:b.plan_rohertrag, bold:true, bg:'bg-blue-50', highlight:'text-blue-800'},
                        {label:'Personalkosten', ist:b.personalkosten, plan:b.plan_personalkosten, bold:true},
                        {label:'Raumkosten', ist:b.raumkosten, plan:b.plan_raumkosten, bold:true},
                        {label:'Werbe-/Reisekosten', ist:b.werbekosten, plan:b.plan_werbekosten, bold:true},
                        {label:'Kosten Warenabgabe', ist:b.kosten_warenabgabe, bold:true},
                        {label:'Abschreibungen', ist:b.abschreibungen, bold:true},
                        {label:'Sonstige Kosten', ist:b.sonstige_kosten, bold:true},
                        {label:'Gesamtkosten', ist:b.gesamtkosten, plan:b.plan_gesamtkosten, bold:true, bg:'bg-gray-50', separator:true},
                        {label:'Betriebsergebnis', ist:b.betriebsergebnis, bold:true},
                        {label:'Zinsaufwand', ist:b.zinsaufwand, bold:true},
                        {label:'Ergebnis vor Steuern', ist:b.ergebnis_vor_steuern, plan:b.plan_ergebnis, bold:true, bg:parseFloat(b.ergebnis_vor_steuern)>=0?'bg-green-50':'bg-red-50', highlight:parseFloat(b.ergebnis_vor_steuern)>=0?'text-green-800':'text-red-800', separator:true, big:true}
                    ];
                    // Restore default header
                    document.querySelector('#bwaDetailTable thead tr').innerHTML = 
                        '<th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">IST</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Plan</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">Abweichung</th>'
                        +'<th class="text-right py-2 px-3 font-semibold text-gray-600">VJ</th>';
                    rows.forEach(function(r) {
                        var cls = (r.separator?'border-t-2 border-gray-800 ':'border-b ') + (r.bg||'');
                        var tdCls = r.bold ? 'font-semibold' : '';
                        var hlCls = r.highlight || '';
                        var sz = r.big ? 'text-base' : '';
                        var indent = r.sub ? 'pl-6 text-gray-600 text-xs' : '';
                        tbody += '<tr class="'+cls+'">';
                        tbody += '<td class="py-2 px-3 '+tdCls+' '+hlCls+' '+sz+' '+indent+'">'+r.label.trim()+'</td>';
                        tbody += '<td class="text-right py-2 px-3 '+tdCls+' '+hlCls+' '+sz+' '+eurColor(r.ist)+'">'+eur(r.ist)+'</td>';
                        tbody += '<td class="text-right py-2 px-3 text-gray-400">'+(r.plan?eur(r.plan):'â€”')+'</td>';
                        tbody += diffHtml(r.ist, r.plan);
                        tbody += '<td class="text-right py-2 px-3 text-gray-400">â€”</td>';
                        tbody += '</tr>';
                    });
                }
                document.getElementById('bwaDetailBody').innerHTML = tbody;

                // Load trend
                loadBwaTrend(b.standort_id, b.jahr);
                // Refresh file list highlight
                loadBwaList();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function loadBwaTrend(stdId, jahr) {
            var sec = document.getElementById('bwaTrendSection');
            var cards = document.getElementById('bwaTrendCards');
            if(!sec||!cards) return;
            try {
                var query = sb.from('bwa_daten').select('monat,umsatzerloese,rohertrag,gesamtkosten,ergebnis_vor_steuern').eq('jahr', jahr).order('monat');
                if(stdId) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error || !resp.data || resp.data.length < 2) { sec.style.display = 'none'; return; }
                sec.style.display = '';
                var data = resp.data;
                var metrics = [
                    {label:'Umsatz',key:'umsatzerloese',color:'#22C55E',bg:'bg-green-50'},
                    {label:'Rohertrag',key:'rohertrag',color:'#3B82F6',bg:'bg-blue-50'},
                    {label:'Ergebnis',key:'ergebnis_vor_steuern',color:'#EF7D00',bg:'bg-orange-50'},
                    {label:'Gesamtkosten',key:'gesamtkosten',color:'#EF4444',bg:'bg-red-50'}
                ];
                var h = '';
                metrics.forEach(function(m) {
                    var vals = data.map(function(d){return parseFloat(d[m.key])||0;});
                    var labels = data.map(function(d){return monatNamen[d.monat].substring(0,3);});
                    var last = vals[vals.length-1];
                    var prev = vals.length>1 ? vals[vals.length-2] : last;
                    var change = prev!==0 ? Math.round((last-prev)/Math.abs(prev)*100) : 0;
                    var totalYTD = vals.reduce(function(a,b){return a+b;},0);
                    // Sparkline SVG
                    var minV=Math.min.apply(null,vals); var maxV=Math.max.apply(null,vals); var range=maxV-minV||1;
                    var sw=120; var sh=35;
                    var pts = vals.map(function(v,i){return Math.round(i/(vals.length-1)*sw)+','+Math.round(sh-(v-minV)/range*sh);});
                    // Fill area
                    var areaPts = pts.join(' ')+' '+sw+','+sh+' 0,'+sh;
                    h += '<div class="p-3 '+m.bg+' rounded-lg">';
                    h += '<p class="text-xs text-gray-500 mb-1">'+m.label+'</p>';
                    h += '<p class="text-lg font-bold text-gray-800">'+eur(last)+' \u20AC</p>';
                    h += '<div class="flex items-center justify-between">';
                    h += '<p class="text-xs '+(change>=0?'text-green-600':'text-red-600')+'">'+(change>=0?'\u2191':'\u2193')+' '+(change>=0?'+':'')+change+'%</p>';
                    h += '<p class="text-xs text-gray-400">YTD: '+eur(totalYTD)+'</p>';
                    h += '</div>';
                    h += '<svg width="'+sw+'" height="'+(sh+2)+'" class="mt-1">';
                    h += '<polygon points="'+areaPts+'" fill="'+m.color+'" fill-opacity="0.15"/>';
                    h += '<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+m.color+'" stroke-width="2" stroke-linejoin="round"/>';
                    // Last point dot
                    var lastPt = pts[pts.length-1].split(',');
                    h += '<circle cx="'+lastPt[0]+'" cy="'+lastPt[1]+'" r="3" fill="'+m.color+'"/>';
                    h += '</svg>';
                    h += '</div>';
                });
                cards.innerHTML = h;
            } catch(e) { sec.style.display = 'none'; }
        }

        function openBwaUploadModal() {
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var now = new Date();
            var _mn = (typeof monatNamen !== 'undefined') ? monatNamen : ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var html = '<div id="bwaUploadOverlay" onclick="closeBwaUploadModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:600px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">ðŸ“Š BWA erfassen</h3><button onclick="closeBwaUploadModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            
            // AI Upload Section FIRST
            html += '<div class="mb-4 p-4 border-2 border-dashed border-vit-orange/40 rounded-lg bg-orange-50/50">';
            html += '<div class="flex items-center space-x-2 mb-2"><span class="text-lg">ðŸ¤–</span><p class="text-sm font-semibold text-gray-800">BWA-Datei hochladen â€“ KI liest Werte automatisch</p></div>';
            html += '<p class="text-xs text-gray-500 mb-3">Lade deine BWA als Excel (.xlsx/.xls/.csv) oder PDF hoch. Die KI erkennt Monat, Jahr und alle Kennzahlen automatisch.</p>';
            html += '<div class="flex items-center space-x-3">';
            html += '<input type="file" id="bwaFileInput" accept=".pdf,.xlsx,.xls,.csv" multiple class="text-xs flex-1" onchange="handleBwaFileSelect(this)">';
            html += '<button id="bwaParseBtn" onclick="parseBwaWithAI()" disabled class="px-4 py-2 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed whitespace-nowrap">ðŸ¤– Auslesen</button>';
            html += '</div>';
            html += '<div id="bwaAiStatus" class="mt-2 hidden"><div class="flex items-center space-x-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600" id="bwaAiStatusText">KI analysiert Datei...</span></div></div>';
            html += '<div id="bwaAiResult" class="mt-2 hidden"></div>';
            html += '</div>';

            // Month/Year AFTER upload (auto-filled by KI)
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Monat</label><select id="bwaMonth" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            for(var m=1;m<=12;m++) html += '<option value="'+m+'"'+(m===(now.getMonth())?' selected':'')+'>'+_mn[m]+'</option>';
            html += '</select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Jahr</label><select id="bwaYear" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
            for(var y=2026;y>=2023;y--) html += '<option value="'+y+'">'+y+'</option>';
            html += '</select></div></div>';
            
            // Data entry
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Kennzahlen <span class="text-gray-400 font-normal">(werden automatisch befÃ¼llt oder manuell eingeben)</span></p>';
            var fields = [
                {id:'bwaF_umsatz',label:'Umsatzerloese',ph:'z.B. 54938'},
                {id:'bwaF_fahrraeder',label:'davon Fahrraeder',ph:'',sub:true},
                {id:'bwaF_teile',label:'davon Teile & Zubehoer',ph:'',sub:true},
                {id:'bwaF_service',label:'davon Service',ph:'',sub:true},
                {id:'bwaF_skonti',label:'davon Skonti (negativ)',ph:'z.B. -2028',sub:true},
                {id:'bwaF_wareneinsatz',label:'Wareneinsatz (negativ)',ph:'z.B. -33580'},
                {id:'bwaF_personal',label:'Personalkosten (negativ)',ph:'z.B. -13485'},
                {id:'bwaF_raum',label:'Raumkosten (negativ)',ph:'z.B. -4150'},
                {id:'bwaF_werbe',label:'Werbe-/Reisekosten',ph:''},
                {id:'bwaF_warenabgabe',label:'Kosten Warenabgabe',ph:''},
                {id:'bwaF_abschreibung',label:'Abschreibungen',ph:''},
                {id:'bwaF_sonstige',label:'Sonstige Kosten',ph:''},
                {id:'bwaF_zins',label:'Zinsaufwand',ph:''}
            ];
            html += '<div class="space-y-2 mb-4 max-h-60 overflow-y-auto">';
            fields.forEach(function(f) {
                html += '<div class="flex items-center space-x-2"><label class="'+(f.sub?'pl-4 ':'')+' text-xs text-gray-600 w-48 flex-shrink-0">'+f.label+'</label>';
                html += '<input id="'+f.id+'" type="number" step="0.01" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-sm text-right bwa-field" placeholder="'+f.ph+'"></div>';
            });
            html += '</div>';
            html += '<div id="bwaUploadError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveBwaData()" id="bwaSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">BWA speichern</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'bwaUploadContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        function handleBwaFileSelect(input) {
            var btn = document.getElementById('bwaParseBtn');
            var count = input.files ? input.files.length : 0;
            if(btn) {
                btn.disabled = count === 0;
                btn.textContent = count > 1 ? 'ðŸ¤– ' + count + ' Dateien auslesen' : 'ðŸ¤– Auslesen';
            }
        }

        async function parseBwaWithAI() {
            var fileInput = document.getElementById('bwaFileInput');
            if(!fileInput || !fileInput.files || !fileInput.files.length) return;
            
            // Multi-file mode
            if(fileInput.files.length > 1) {
                return parseBwaBatch(fileInput.files);
            }
            
            var file = fileInput.files[0];
            var statusEl = document.getElementById('bwaAiStatus');
            var statusText = document.getElementById('bwaAiStatusText');
            var resultEl = document.getElementById('bwaAiResult');
            var parseBtn = document.getElementById('bwaParseBtn');

            statusEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            if(parseBtn) parseBtn.disabled = true;

            var isPdf = file.name.match(/\.pdf$/i);
            if(isPdf) {
                // PDF â†’ KI-Analyse via Edge Function
                statusText.textContent = 'ðŸ¤– PDF wird mit KI analysiert...';
                try {
                    var reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            var base64 = e.target.result.split(',')[1];
                            var session = await sb.auth.getSession();
                            var token = session?.data?.session?.access_token;
                            var resp = await fetch(SUPABASE_URL + '/functions/v1/analyze-finance', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (token||''), 'apikey': SUPABASE_ANON_KEY },
                                body: JSON.stringify({ type: 'bwa', file_base64: base64, media_type: 'application/pdf' })
                            });
                            if(!resp.ok) throw new Error('API Fehler ' + resp.status);
                            var data = await resp.json();
                            var result = data.result;
                            if(result && result.werte) {
                                // Fill form fields from KI result
                                bwaApplyKiResult(result);
                                statusEl.querySelector('.animate-spin').style.display = 'none';
                                statusText.textContent = 'âœ… KI-Analyse abgeschlossen' + (result.confidence ? ' (Konfidenz: ' + Math.round(result.confidence * 100) + '%)' : '');
                                if(result.hinweise && result.hinweise.length > 0) {
                                    resultEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700"><p class="font-semibold mb-1">KI-Hinweise:</p><ul class="list-disc pl-4">' + result.hinweise.map(function(h){return '<li>'+escH(h)+'</li>';}).join('') + '</ul></div>';
                                    resultEl.classList.remove('hidden');
                                }
                            } else {
                                throw new Error('Keine Werte erkannt');
                            }
                        } catch(err2) {
                            statusEl.querySelector('.animate-spin').style.display = 'none';
                            statusText.textContent = 'âŒ KI-Analyse fehlgeschlagen: ' + (err2.message||err2);
                        }
                        if(parseBtn) parseBtn.disabled = false;
                    };
                    reader.readAsDataURL(file);
                } catch(pdfErr) {
                    statusEl.querySelector('.animate-spin').style.display = 'none';
                    statusText.textContent = 'âŒ Fehler: ' + (pdfErr.message||pdfErr);
                    if(parseBtn) parseBtn.disabled = false;
                }
                return;
            }

            statusText.textContent = 'ðŸ“Š Datei wird analysiert...';

            // === DATEV Sign Inversion Fix ===
            var negZeilen = {1060:1,1100:1,1120:1,1140:1,1150:1,1155:1,1160:1,1170:1,1175:1,1180:1,1190:1,1200:1,1210:1,1220:1,1240:1,1250:1,1260:1,1280:1,1290:1,1310:1,1312:1,1320:1,1355:1};
            function fixDatevSigns(bwaRows) {
                if(!bwaRows || bwaRows.length === 0) return bwaRows;
                // Check if Material/Wareneinkauf (1060) is positive - if so, this is DATEV format where costs are positive
                var we = bwaRows.find(function(x) { return x.zeile === 1060 && x.ist_summenzeile; });
                if(we && we.wert > 0) {
                    console.log('[BWA] DATEV Sign Inversion: inverting cost lines');
                    bwaRows.forEach(function(row) {
                        if(row.zeile && negZeilen[row.zeile] && row.ist_summenzeile) {
                            if(row.wert > 0) row.wert = -row.wert;
                            if(row.wert_kumuliert > 0) row.wert_kumuliert = -row.wert_kumuliert;
                        }
                    });
                }
                return bwaRows;
            }
            // === DATEV Sign Inversion Fix ===
            var negZeilen = {1060:1,1100:1,1120:1,1140:1,1150:1,1155:1,1160:1,1170:1,1175:1,1180:1,1190:1,1200:1,1210:1,1220:1,1240:1,1250:1,1260:1,1280:1,1290:1,1310:1,1312:1,1320:1,1355:1};
            function fixDatevSigns(bwaRows) {
                if(!bwaRows || bwaRows.length === 0) return bwaRows;
                // Check if Material/Wareneinkauf (1060) is positive - if so, this is DATEV format where costs are positive
                var we = bwaRows.find(function(x) { return x.zeile === 1060 && x.ist_summenzeile; });
                if(we && we.wert > 0) {
                    console.log('[BWA] DATEV Sign Inversion: inverting cost lines');
                    bwaRows.forEach(function(row) {
                        if(row.zeile && negZeilen[row.zeile] && row.ist_summenzeile) {
                            if(row.wert > 0) row.wert = -row.wert;
                            if(row.wert_kumuliert > 0) row.wert_kumuliert = -row.wert_kumuliert;
                        }
                    });
                }
                return bwaRows;
            }
            BwaParser.parseFile(file, async function(err, result) {
                if(!err && result && result.bwa_daten) {
                    result.bwa_daten = fixDatevSigns(result.bwa_daten);
                }
                if(err) {
                    // KI-Fallback: Excel-Text extrahieren und an KI senden
                    statusText.textContent = 'ðŸ¤– Parser fehlgeschlagen â€“ KI-Analyse wird gestartet...';
                    try {
                        var arrayBuf = await file.arrayBuffer();
                        var wb = XLSX.read(arrayBuf, { type: 'array' });
                        var rawText = cleanCsvForKi(wb);
                        var session = await sb.auth.getSession();
                        var token = session?.data?.session?.access_token;
                        var resp = await fetch(SUPABASE_URL + '/functions/v1/analyze-finance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (token||''), 'apikey': SUPABASE_ANON_KEY },
                            body: JSON.stringify({ type: 'bwa', raw_text: rawText.substring(0, 15000) })
                        });
                        if(!resp.ok) { var errB=''; try { var eD=await resp.json(); errB=eD.error||eD.details||''; } catch(e2) {} throw new Error('KI-API Fehler ' + resp.status + (errB ? ': '+errB.substring(0,150) : '')); }
                        var data = await resp.json();
                        if(data.result && data.result.werte) {
                            bwaApplyKiResult(data.result);
                            statusEl.querySelector('.animate-spin').style.display = 'none';
                            statusText.textContent = 'âœ… KI-Analyse abgeschlossen' + (data.result.confidence ? ' (Konfidenz: ' + Math.round(data.result.confidence * 100) + '%)' : '');
                            if(data.result.hinweise && data.result.hinweise.length > 0) {
                                resultEl.innerHTML = '<div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-xs text-purple-700"><p class="font-semibold mb-1">ðŸ¤– KI-Hinweise:</p><ul class="list-disc pl-4">' + data.result.hinweise.map(function(h){return '<li>'+escH(h)+'</li>';}).join('') + '</ul><p class="mt-2 text-[10px] text-purple-400">Bitte Werte vor dem Speichern kontrollieren.</p></div>';
                                resultEl.classList.remove('hidden');
                            }
                        } else { throw new Error('Keine Werte erkannt'); }
                    } catch(kiFallbackErr) {
                        statusEl.querySelector('.animate-spin').style.display = 'none';
                        statusText.textContent = 'âŒ Auch KI-Analyse fehlgeschlagen: ' + (kiFallbackErr.message||'Unbekannt');
                        resultEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700">'
                            + '<p class="font-semibold mb-1">Automatische Erkennung fehlgeschlagen</p>'
                            + '<p>Bitte die Werte manuell eingeben.</p></div>';
                        resultEl.classList.remove('hidden');
                    }
                    if(parseBtn) parseBtn.disabled = false;
                    return;
                }

                var meta = result.meta;
                var daten = result.bwa_daten;
                var jahrDaten = result.bwa_jahr_daten;

                // Apply detected month/year
                if(meta.monat) {
                    var mSel = document.getElementById('bwaMonth');
                    if(mSel) { mSel.value = meta.monat; mSel.style.borderColor = '#f97316'; mSel.style.backgroundColor = '#fff7ed'; }
                }
                if(meta.jahr) {
                    var ySel = document.getElementById('bwaYear');
                    if(ySel) { ySel.value = meta.jahr; ySel.style.borderColor = '#f97316'; ySel.style.backgroundColor = '#fff7ed'; }
                }

                // Extract key values from parsed data
                var parsed = {};
                var matchedRows = [];
                
                // Mapping: kontengruppe/bezeichnung â†’ form field
                var gruppenMap = {
                    'UmsatzerlÃ¶se': 'umsatzerloese',
                    'Materialaufwand': 'wareneinsatz',
                    'Rohertrag': 'rohertrag',
                    'Betrieblicher Rohertrag': 'rohertrag',
                    'Personalkosten': 'personalkosten',
                    'Raumkosten': 'raumkosten',
                    'Werbe-/Reisekosten': 'werbekosten',
                    'Warenabgabekosten': 'kosten_warenabgabe',
                    'Abschreibungen': 'abschreibungen',
                    'Sonstige Kosten': 'sonstige_kosten',
                    'Gesamtkosten': 'gesamtkosten',
                    'Summe Aufwendungen': 'gesamtkosten',
                    'Fahrzeugkosten': 'kfzkosten',
                    'Steuern/Versicherungen': 'versicherungen',
                    'Betriebsergebnis': 'betriebsergebnis',
                    'Ergebnis': 'ergebnis_vor_steuern',
                    'Zinsen': 'zinsaufwand',
                    'Gesamtleistung': 'gesamtleistung'
                };
                
                // Detail-Konten Mapping
                var kontoMap = {
                    '4400': 'davon_fahrraeder',
                    '4405': 'davon_teile',
                    '4407': 'davon_service',
                    '4410': 'davon_service',
                    '4730': 'davon_skonti',
                    '4736': 'davon_skonti'
                };
                
                // Verarbeite Monats-BWA Daten
                if(daten && daten.length > 0) {
                    daten.forEach(function(row) {
                        if(!row.wert && row.wert !== 0) return;
                        
                        // Summenzeilen â†’ Hauptfelder
                        if(row.ist_summenzeile && row.kontengruppe && gruppenMap[row.kontengruppe]) {
                            var key = gruppenMap[row.kontengruppe];
                            if(!parsed[key]) {
                                parsed[key] = row.wert;
                                matchedRows.push({key: key, label: row.bezeichnung, value: row.wert});
                            }
                        }
                        
                        // Detail-Konten â†’ Unterfelder
                        if(row.konto && kontoMap[row.konto]) {
                            var dKey = kontoMap[row.konto];
                            parsed[dKey] = (parsed[dKey] || 0) + row.wert;
                            matchedRows.push({key: dKey, label: row.bezeichnung, value: row.wert});
                        }
                    });
                }
                
                // Verarbeite Jahres-BWA Daten (nimm den letzten befÃ¼llten Monat)
                if(jahrDaten && jahrDaten.length > 0 && daten.length === 0) {
                    var monatKeys = ['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
                    // Finde letzten Monat mit Daten
                    var lastMonat = 0;
                    jahrDaten.forEach(function(row) {
                        for(var m = 11; m >= 0; m--) {
                            if(row[monatKeys[m]] && row[monatKeys[m]] !== 0 && m+1 > lastMonat) {
                                lastMonat = m+1;
                            }
                        }
                    });
                    if(lastMonat > 0 && !meta.monat) {
                        meta.monat = lastMonat;
                        var mSel2 = document.getElementById('bwaMonth');
                        if(mSel2) { mSel2.value = lastMonat; mSel2.style.borderColor = '#f97316'; mSel2.style.backgroundColor = '#fff7ed'; }
                    }
                    var mKey = lastMonat > 0 ? monatKeys[lastMonat - 1] : null;
                    if(mKey) {
                        jahrDaten.forEach(function(row) {
                            var val = row[mKey];
                            if(!val && val !== 0) return;
                            var bez = (row.bezeichnung || '').toLowerCase();
                            var mapped = null;
                            // Suche in kompakt map
                            var kompaktKeys = Object.keys(BwaParser.KOMPAKT_MAP);
                            for(var i = 0; i < kompaktKeys.length; i++) {
                                if(bez === kompaktKeys[i]) {
                                    var info = BwaParser.KOMPAKT_MAP[kompaktKeys[i]];
                                    if(info.gruppe && gruppenMap[info.gruppe]) {
                                        mapped = gruppenMap[info.gruppe];
                                        break;
                                    }
                                }
                            }
                            if(mapped && !parsed[mapped]) {
                                parsed[mapped] = val;
                                matchedRows.push({key: mapped, label: row.bezeichnung, value: val});
                            }
                        });
                    }
                }

                // Berechne abgeleitete Werte
                if(!parsed.rohertrag && parsed.umsatzerloese && parsed.wareneinsatz) {
                    parsed.rohertrag = parsed.umsatzerloese + parsed.wareneinsatz;
                }
                if(!parsed.gesamtkosten) {
                    parsed.gesamtkosten = (parsed.personalkosten||0) + (parsed.raumkosten||0) + (parsed.werbekosten||0) + 
                        (parsed.kosten_warenabgabe||0) + (parsed.abschreibungen||0) + (parsed.sonstige_kosten||0) +
                        (parsed.kfzkosten||0) + (parsed.versicherungen||0) + (parsed.instandhaltung||0);
                }
                if(!parsed.betriebsergebnis && parsed.rohertrag) {
                    parsed.betriebsergebnis = parsed.rohertrag + (parsed.gesamtkosten||0);
                }
                if(!parsed.ergebnis_vor_steuern && parsed.betriebsergebnis) {
                    parsed.ergebnis_vor_steuern = parsed.betriebsergebnis + (parsed.zinsaufwand||0);
                }

                statusEl.querySelector('.animate-spin').style.display = 'none';

                if(matchedRows.length === 0) {
                    // KI-Fallback: Format erkannt aber keine Zuordnung mÃ¶glich
                    statusText.textContent = 'ðŸ¤– Format "' + meta.format + '" nicht zuordbar â€“ KI-Analyse lÃ¤uft...';
                    try {
                        var arrayBuf2 = await file.arrayBuffer();
                        var wb2 = XLSX.read(arrayBuf2, { type: 'array' });
                        var rawText2 = cleanCsvForKi(wb2);
                        var kiResult = await callFinanceKi('bwa', null, null, rawText2.substring(0, 15000), {jahr: meta.jahr, monat: meta.monat, format: meta.format});
                        if(kiResult && kiResult.werte) {
                            bwaApplyKiResult(kiResult);
                            statusEl.querySelector('.animate-spin').style.display = 'none';
                            statusText.textContent = 'âœ… KI-Analyse abgeschlossen' + (kiResult.confidence ? ' (Konfidenz: ' + Math.round(kiResult.confidence * 100) + '%)' : '') + ' [' + meta.format + ' â†’ KI]';
                            if(kiResult.hinweise && kiResult.hinweise.length > 0) {
                                resultEl.innerHTML = '<div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-xs text-purple-700"><p class="font-semibold mb-1">ðŸ¤– KI-Hinweise:</p><ul class="list-disc pl-4">' + kiResult.hinweise.map(function(h){return '<li>'+escH(h)+'</li>';}).join('') + '</ul><p class="mt-2 text-[10px] text-purple-400">Bitte Werte vor dem Speichern kontrollieren.</p></div>';
                                resultEl.classList.remove('hidden');
                            }
                        } else { throw new Error('Keine Werte erkannt'); }
                    } catch(kiErr2) {
                        statusEl.querySelector('.animate-spin').style.display = 'none';
                        statusText.textContent = 'âš ï¸ Auch KI konnte keine Werte zuordnen (Format: ' + meta.format + ')';
                        resultEl.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-yellow-700">'
                            + '<p class="font-semibold mb-1">Automatische Erkennung fehlgeschlagen</p>'
                            + '<p>Bitte die Werte manuell eingeben.</p></div>';
                        resultEl.classList.remove('hidden');
                    }
                    if(parseBtn) parseBtn.disabled = false;
                    return;
                }

                var periodInfo = meta.monat && meta.jahr ? ' (' + monatNamen[meta.monat] + ' ' + meta.jahr + ')' : '';
                statusText.textContent = 'âœ… ' + matchedRows.length + ' Werte erkannt!' + periodInfo + ' [' + meta.format + ']';

                // Fill form fields
                var fieldMap = {
                    umsatzerloese: 'bwaF_umsatz',
                    davon_fahrraeder: 'bwaF_fahrraeder',
                    davon_teile: 'bwaF_teile',
                    davon_service: 'bwaF_service',
                    davon_skonti: 'bwaF_skonti',
                    wareneinsatz: 'bwaF_wareneinsatz',
                    personalkosten: 'bwaF_personal',
                    raumkosten: 'bwaF_raum',
                    werbekosten: 'bwaF_werbe',
                    kosten_warenabgabe: 'bwaF_warenabgabe',
                    abschreibungen: 'bwaF_abschreibung',
                    sonstige_kosten: 'bwaF_sonstige',
                    zinsaufwand: 'bwaF_zins'
                };

                var filledCount = 0;
                Object.keys(fieldMap).forEach(function(key) {
                    var val = parsed[key];
                    if(val !== undefined && val !== 0) {
                        var el = document.getElementById(fieldMap[key]);
                        if(el) { 
                            el.value = Math.round(val * 100) / 100; 
                            el.style.borderColor = '#f97316'; 
                            el.style.backgroundColor = '#fff7ed'; 
                            filledCount++; 
                        }
                    }
                });

                // Show results
                var umsatz = parsed.umsatzerloese || 0;
                var rohertrag = parsed.rohertrag || 0;
                var rohertragPct = umsatz ? ((rohertrag / umsatz) * 100).toFixed(1) : 0;
                var ergebnis = parsed.ergebnis_vor_steuern || parsed.betriebsergebnis || 0;
                
                resultEl.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3">'
                    + '<p class="text-xs font-semibold text-green-700 mb-2">âœ… ' + filledCount + ' Werte erkannt Â· Format: <code>' + meta.format + '</code></p>'
                    + '<div class="grid grid-cols-3 gap-2 text-xs">'
                    + '<div><span class="text-gray-500">Umsatz:</span><br><strong>' + umsatz.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                    + '<div><span class="text-gray-500">Rohertrag:</span><br><strong>' + rohertragPct + '%</strong></div>'
                    + '<div><span class="text-gray-500">Ergebnis:</span><br><strong class="' + (ergebnis >= 0 ? 'text-green-600' : 'text-red-600') + '">' + ergebnis.toLocaleString('de-DE') + ' â‚¬</strong></div>'
                    + '</div>'
                    + '<details class="mt-2"><summary class="text-[10px] text-gray-400 cursor-pointer">Erkannte Zuordnungen (' + matchedRows.length + ')</summary>'
                    + '<div class="mt-1 space-y-0.5 max-h-40 overflow-y-auto">' + matchedRows.map(function(m) { 
                        return '<div class="text-[10px] text-gray-500"><span class="text-gray-700">"' + m.label + '"</span> â†’ <strong>' + m.key + '</strong> = ' + (typeof m.value === 'number' ? m.value.toLocaleString('de-DE') : m.value) + '</div>'; 
                    }).join('') + '</div></details>'
                    + '<p class="text-[10px] text-gray-400 mt-2">âš ï¸ Bitte prÃ¼fe die Werte vor dem Speichern.</p>'
                    + '</div>';
                resultEl.classList.remove('hidden');
                
                // Store detail data for saveBwaData()
                window._lastParsedDetails = daten && daten.length > 0 ? daten : [];
                window._lastParsedFormat = meta.format;
                
                if(parseBtn) parseBtn.disabled = false;
            });
        }

        // Batch BWA Upload â€“ mehrere Dateien nacheinander parsen + speichern
        async function parseBwaBatch(files) {
            var statusEl = document.getElementById('bwaAiStatus');
            var statusText = document.getElementById('bwaAiStatusText');
            var resultEl = document.getElementById('bwaAiResult');
            var parseBtn = document.getElementById('bwaParseBtn');
            statusEl.classList.remove('hidden');
            resultEl.classList.remove('hidden');
            if(parseBtn) parseBtn.disabled = true;

            var total = files.length;
            var results = [];
            resultEl.innerHTML = '<div id="bwaBatchProgress" class="space-y-2"></div>';

            for(var i = 0; i < total; i++) {
                var file = files[i];
                statusText.textContent = 'ðŸ“Š Datei ' + (i+1) + '/' + total + ': ' + file.name + '...';
                
                var progEl = document.getElementById('bwaBatchProgress');
                var itemId = 'bwaBatch_' + i;
                progEl.innerHTML += '<div id="' + itemId + '" class="flex items-center space-x-2 text-xs p-2 bg-gray-50 rounded"><div class="w-3 h-3 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="flex-1 truncate">' + escH(file.name) + '</span><span class="text-gray-400">Analysiert...</span></div>';

                // Delay between requests to avoid rate limiting (429)
                if(i > 0) { await new Promise(function(r){ setTimeout(r, 4000); }); }

                try {
                    var bwaResult = await parseSingleBwaFileWithRetry(file);
                    if(bwaResult && bwaResult.umsatzerloese) {
                        // Auto-save
                        var saveRes = await autoSaveBwa(bwaResult, file.name);
                        var el = document.getElementById(itemId);
                        if(el) el.innerHTML = '<span class="text-green-600">âœ…</span><span class="flex-1">' + escH(file.name) + '</span><span class="text-green-600 font-semibold">' + bwaResult.monatName + ' ' + bwaResult.jahr + ' â€“ Umsatz: ' + Math.round(bwaResult.umsatzerloese).toLocaleString('de-DE') + ' â‚¬</span>';
                        results.push({file: file.name, success: true, monat: bwaResult.monat, jahr: bwaResult.jahr});
                    } else {
                        throw new Error('Keine Werte erkannt');
                    }
                } catch(err) {
                    var el2 = document.getElementById(itemId);
                    if(el2) el2.innerHTML = '<span class="text-red-500">âŒ</span><span class="flex-1">' + escH(file.name) + '</span><span class="text-red-500">' + escH(err.message || 'Fehler') + '</span>';
                    results.push({file: file.name, success: false, error: err.message});
                }
            }

            var ok = results.filter(function(r){return r.success;}).length;
            statusEl.querySelector('.animate-spin').style.display = 'none';
            statusText.textContent = 'âœ… Batch fertig: ' + ok + '/' + total + ' BWAs erfolgreich gespeichert';
            if(parseBtn) parseBtn.disabled = false;

            // Reload BWA list
            if(ok > 0 && typeof loadBwaList === 'function') {
                setTimeout(function(){ loadBwaList(); }, 500);
            }
        }

        // Parse a single BWA file â€“ returns {monat, jahr, monatName, umsatzerloese, ...} or throws
        // Retry wrapper: retries on 429 rate limit with exponential backoff
        async function parseSingleBwaFileWithRetry(file, attempt) {
            attempt = attempt || 1;
            try {
                return await parseSingleBwaFile(file);
            } catch(err) {
                if(err.message && err.message.includes('429') && attempt < 4) {
                    var wait = attempt * 5000; // 5s, 10s, 15s
                    console.log('Rate limited, retry ' + attempt + ' in ' + (wait/1000) + 's for', file.name);
                    await new Promise(function(r){ setTimeout(r, wait); });
                    return parseSingleBwaFileWithRetry(file, attempt + 1);
                }
                throw err;
            }
        }

        // Clean CSV for KI: remove line breaks in cells, clarify SUSA columns
        function cleanCsvForKi(wb) {
            var rawText = '';
            wb.SheetNames.forEach(function(sn) {
                var ws = wb.Sheets[sn];
                // Clean cell values: remove newlines
                var range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
                for(var R = range.s.r; R <= range.e.r; R++) {
                    for(var C = range.s.c; C <= range.e.c; C++) {
                        var addr = XLSX.utils.encode_cell({r:R, c:C});
                        var cell = ws[addr];
                        if(cell && typeof cell.v === 'string') {
                            cell.v = cell.v.replace(/[\r\n]+/g, ' ').trim();
                            if(cell.w) cell.w = cell.w.replace(/[\r\n]+/g, ' ').trim();
                        }
                    }
                }
                rawText += '=== Sheet: ' + sn + ' ===\n' + XLSX.utils.sheet_to_csv(ws, {FS:';'}) + '\n\n';
            });
            return rawText;
        }

        async function parseSingleBwaFile(file) {
            return new Promise(function(resolve, reject) {
                var meta = BwaParser.extractMonatJahr(file.name);
                meta.dateiname = file.name;
                var monatNamen = ['','Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

                var isPdf = file.name.match(/\.pdf$/i);
                if(isPdf) {
                    // PDF â†’ direkt KI
                    var reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            var base64 = e.target.result.split(',')[1];
                            var kiResult = await callFinanceKi('bwa', base64, 'application/pdf', null, {jahr: meta.jahr, monat: meta.monat});
                            if(kiResult && kiResult.werte) {
                                var w = kiResult.werte;
                                var m = (kiResult.meta && kiResult.meta.monat) || meta.monat;
                                var j = (kiResult.meta && kiResult.meta.jahr) || meta.jahr;
                                resolve(Object.assign(w, {monat: m, jahr: j, monatName: monatNamen[m] || '?', quelle: 'ki'}));
                            } else { reject(new Error('KI: Keine Werte')); }
                        } catch(err) { reject(err); }
                    };
                    reader.readAsDataURL(file);
                    return;
                }

                // Excel â†’ Parser zuerst, dann KI-Fallback
                BwaParser.parseFile(file, async function(err, result) {
                    // Versuche regelbasiert zu parsen
                    var parsed = {};
                    var matchCount = 0;
                    if(!err && result) {
                        var daten = result.bwa_daten || [];
                        var gruppenMap = {
                            'UmsatzerlÃ¶se':'umsatzerloese','Materialaufwand':'wareneinsatz','Rohertrag':'rohertrag',
                            'Betrieblicher Rohertrag':'rohertrag','Personalkosten':'personalkosten','Raumkosten':'raumkosten',
                            'Werbe-/Reisekosten':'werbekosten','Warenabgabekosten':'kosten_warenabgabe',
                            'Abschreibungen':'abschreibungen','Sonstige Kosten':'sonstige_kosten',
                            'Fahrzeugkosten':'kfzkosten','Steuern/Versicherungen':'versicherungen',
                            'Betriebsergebnis':'betriebsergebnis','Zinsen':'zinsaufwand'
                        };
                        daten.forEach(function(row) {
                            if(row.ist_summenzeile && row.kontengruppe && gruppenMap[row.kontengruppe] && row.wert !== null) {
                                var key = gruppenMap[row.kontengruppe];
                                if(!parsed[key]) { parsed[key] = row.wert; matchCount++; }
                            }
                        });
                        if(result.meta) { meta.monat = result.meta.monat || meta.monat; meta.jahr = result.meta.jahr || meta.jahr; }
                    }

                    if(matchCount >= 3) {
                        // Parser hat genug Felder gefunden
                        resolve(Object.assign(parsed, {monat: meta.monat, jahr: meta.jahr, monatName: monatNamen[meta.monat] || '?', quelle: 'parser'}));
                        return;
                    }

                    // KI-Fallback
                    try {
                        var arrayBuf = await file.arrayBuffer();
                        var wb = XLSX.read(arrayBuf, { type: 'array' });
                        var rawText = cleanCsvForKi(wb);
                        var kiResult = await callFinanceKi('bwa', null, null, rawText.substring(0, 15000), {jahr: meta.jahr, monat: meta.monat, format: meta.format});
                        if(kiResult && kiResult.werte) {
                            var w2 = kiResult.werte;
                            var m2 = (kiResult.meta && kiResult.meta.monat) || meta.monat;
                            var j2 = (kiResult.meta && kiResult.meta.jahr) || meta.jahr;
                            resolve(Object.assign(w2, {monat: m2, jahr: j2, monatName: monatNamen[m2] || '?', quelle: 'ki'}));
                        } else { reject(new Error('KI: Keine Werte')); }
                    } catch(kiErr) { reject(kiErr); }
                });
            });
        }

        // Auto-save a parsed BWA to DB
        async function autoSaveBwa(data, filename) {
            var stdId = sbProfile ? sbProfile.standort_id : null;
            if(!stdId) throw new Error('Kein Standort');
            var rohertrag = (data.umsatzerloese||0) + (data.wareneinsatz||0);
            var gesamtkosten = (data.personalkosten||0) + (data.raumkosten||0) + (data.werbekosten||0) + (data.kosten_warenabgabe||0) + (data.abschreibungen||0) + (data.sonstige_kosten||0);
            var betriebsergebnis = rohertrag + gesamtkosten;
            var ergebnis = betriebsergebnis + (data.zinsaufwand||0);

            var payload = {
                standort_id: stdId,
                monat: data.monat,
                jahr: data.jahr,
                umsatzerloese: data.umsatzerloese || 0,
                davon_fahrraeder: data.davon_fahrraeder || null,
                davon_teile: data.davon_teile || null,
                davon_service: data.davon_service || null,
                davon_skonti: data.davon_skonti || null,
                wareneinsatz: data.wareneinsatz || 0,
                rohertrag: rohertrag,
                personalkosten: data.personalkosten || 0,
                raumkosten: data.raumkosten || 0,
                werbekosten: data.werbekosten || 0,
                kosten_warenabgabe: data.kosten_warenabgabe || 0,
                abschreibungen: data.abschreibungen || 0,
                sonstige_kosten: data.sonstige_kosten || 0,
                gesamtkosten: gesamtkosten,
                betriebsergebnis: betriebsergebnis,
                zinsaufwand: data.zinsaufwand || 0,
                ergebnis_vor_steuern: ergebnis,
                datei_name: filename,
                format: data.quelle === 'ki' ? 'KI-Analyse' : 'Auto-Parser',
                hochgeladen_von: sbUser ? sbUser.id : null,
                updated_at: new Date().toISOString()
            };

            var resp = await sb.from('bwa_daten').upsert(payload, {onConflict: 'standort_id,monat,jahr'}).select();
            if(resp.error) throw resp.error;
            return resp.data;
        }

        // Apply KI analysis result to BWA form fields
        function bwaApplyKiResult(result) {
            if(!result) return;
            var meta = result.meta || {};
            var werte = result.werte || {};
            // Apply month/year
            if(meta.monat) {
                var mSel = document.getElementById('bwaMonth');
                if(mSel) { mSel.value = meta.monat; mSel.style.borderColor = '#a855f7'; mSel.style.backgroundColor = '#faf5ff'; }
            }
            if(meta.jahr) {
                var ySel = document.getElementById('bwaYear');
                if(ySel) { ySel.value = meta.jahr; ySel.style.borderColor = '#a855f7'; ySel.style.backgroundColor = '#faf5ff'; }
            }
            // Map KI werte to form fields (bwaF_ IDs)
            var fieldMap = {
                umsatzerloese:'bwaF_umsatz', wareneinsatz:'bwaF_wareneinsatz',
                personalkosten:'bwaF_personal', raumkosten:'bwaF_raum',
                werbekosten:'bwaF_werbe', kosten_warenabgabe:'bwaF_warenabgabe',
                abschreibungen:'bwaF_abschreibung', sonstige_kosten:'bwaF_sonstige',
                zinsaufwand:'bwaF_zins',
                davon_fahrraeder:'bwaF_fahrraeder', davon_teile:'bwaF_teile',
                davon_service:'bwaF_service', davon_skonti:'bwaF_skonti'
            };
            var filled = 0;
            Object.keys(werte).forEach(function(key) {
                var elId = fieldMap[key];
                if(!elId) return;
                var el = document.getElementById(elId);
                if(el && werte[key] !== null && werte[key] !== undefined) {
                    el.value = Math.round(werte[key] * 100) / 100;
                    el.style.borderColor = '#a855f7';
                    el.style.backgroundColor = '#faf5ff';
                    filled++;
                }
            });
            console.log('[BWA KI] ' + filled + ' Felder befÃ¼llt, Konfidenz: ' + (result.confidence||'?'));
        }

        function closeBwaUploadModal() { var c = document.getElementById('bwaUploadContainer'); if(c) c.remove(); }

        async function saveBwaData() {
            var month = parseInt(document.getElementById('bwaMonth').value);
            var year = parseInt(document.getElementById('bwaYear').value);
            var errEl = document.getElementById('bwaUploadError');
            var btn = document.getElementById('bwaSaveBtn');
            var v = function(id) { return parseFloat((document.getElementById(id)||{}).value) || 0; };

            var umsatz = v('bwaF_umsatz');
            var wareneinsatz = v('bwaF_wareneinsatz');
            var rohertrag = umsatz + wareneinsatz; // wareneinsatz is negative
            var personal = v('bwaF_personal');
            var raum = v('bwaF_raum');
            var werbe = v('bwaF_werbe');
            var warenabgabe = v('bwaF_warenabgabe');
            var abschreibung = v('bwaF_abschreibung');
            var sonstige = v('bwaF_sonstige');
            var gesamtkosten = personal + raum + werbe + warenabgabe + abschreibung + sonstige;
            var betriebsergebnis = rohertrag + gesamtkosten;
            var zins = v('bwaF_zins');
            var ergebnis = betriebsergebnis + zins;

            if(!umsatz && !wareneinsatz) { if(errEl){errEl.textContent='Bitte mindestens Umsatz oder Wareneinsatz eingeben.';errEl.style.display='block';} return; }

            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;

                // Upload file if selected
                var fileUrl = null;
                var fileName = null;
                var fileInput = document.getElementById('bwaFileInput');
                if(fileInput && fileInput.files && fileInput.files[0]) {
                    var file = fileInput.files[0];
                    fileName = file.name;
                    var path = (stdId||'hq')+'/'+year+'/'+month+'_'+file.name;
                    var upResp = await sb.storage.from('bwa-dateien').upload(path, file, {upsert:true});
                    if(upResp.error) console.warn('File upload error:', upResp.error);
                    else fileUrl = path;
                }

                var data = {
                    standort_id: stdId,
                    monat: month,
                    jahr: year,
                    umsatzerloese: umsatz,
                    davon_fahrraeder: v('bwaF_fahrraeder'),
                    davon_teile: v('bwaF_teile'),
                    davon_service: v('bwaF_service'),
                    davon_skonti: v('bwaF_skonti'),
                    wareneinsatz: wareneinsatz,
                    rohertrag: rohertrag,
                    personalkosten: personal,
                    raumkosten: raum,
                    werbekosten: werbe,
                    kosten_warenabgabe: warenabgabe,
                    abschreibungen: abschreibung,
                    sonstige_kosten: sonstige,
                    gesamtkosten: gesamtkosten,
                    betriebsergebnis: betriebsergebnis,
                    zinsaufwand: zins,
                    ergebnis_vor_steuern: ergebnis,
                    plan_umsatz: v('bwaF_planUmsatz'),
                    plan_wareneinsatz: v('bwaF_planWareneinsatz'),
                    plan_rohertrag: v('bwaF_planRohertrag'),
                    plan_personalkosten: v('bwaF_planPersonal'),
                    plan_raumkosten: v('bwaF_planRaum'),
                    plan_werbekosten: v('bwaF_planWerbe'),
                    plan_gesamtkosten: v('bwaF_planGesamt'),
                    plan_ergebnis: v('bwaF_planErgebnis'),
                    format: window._lastParsedFormat || null,
                    hochgeladen_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                if(fileUrl) { data.datei_url = fileUrl; data.datei_name = fileName; }

                var resp = await sb.from('bwa_daten').upsert(data, {onConflict:'standort_id,monat,jahr'}).select();
                if(resp.error) throw resp.error;
                var bwaId = resp.data && resp.data[0] ? resp.data[0].id : null;

                // Detail-Positionen speichern (wenn vom Parser vorhanden)
                if(bwaId && window._lastParsedDetails && window._lastParsedDetails.length > 0) {
                    // Alte Details lÃ¶schen
                    await sb.from('bwa_detail_positionen').delete().eq('bwa_id', bwaId);
                    // Neue Details in Batches speichern
                    var details = window._lastParsedDetails.map(function(d) {
                        return {
                            bwa_id: bwaId,
                            standort_id: stdId,
                            jahr: year,
                            monat: month,
                            zeile: d.zeile || null,
                            konto: d.konto || null,
                            kontengruppe: d.kontengruppe || null,
                            bezeichnung: d.bezeichnung,
                            wert: d.wert,
                            wert_kumuliert: d.wert_kumuliert || null,
                            wert_vorjahr: d.wert_vorjahr || null,
                            prozent_gesamtleistung: d.prozent_gesamtleistung || null,
                            ist_summenzeile: d.ist_summenzeile || false,
                            ebene: d.ebene || 0,
                            sortierung: d.sortierung || 0,
                            format: window._lastParsedFormat || null
                        };
                    });
                    // Batch insert (max 500 per request)
                    for(var bi = 0; bi < details.length; bi += 500) {
                        var batch = details.slice(bi, bi + 500);
                        var detResp = await sb.from('bwa_detail_positionen').insert(batch);
                        if(detResp.error) console.warn('Detail insert batch error:', detResp.error);
                    }
                    console.log('âœ… ' + details.length + ' Detail-Positionen gespeichert');
                }

                // Cleanup temp vars
                window._lastParsedDetails = null;
                window._lastParsedFormat = null;

                closeBwaUploadModal();
                await loadBwaList();
                if(bwaId) showBwaFromDb(bwaId);
                alert('âœ… BWA '+monatNamen[month]+' '+year+' gespeichert!');
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='BWA speichern'; }
            }
        }

        // === PLAN / IST SYSTEM ===
        var currentPlan = null; // { jahr, monate: [{monat, umsatz, wareneinsatz, personal, raum, werbe, abschreibung, sonstige, zins, ...}] }
        var planIstYear = new Date().getFullYear();

        async function renderPlanIst() {
            var el = document.getElementById('planIstContent');
            if(!el) return;

            // Try load plan from DB
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var resp = await sb.from('jahresplaene').select('*').eq('jahr', planIstYear).eq('standort_id', stdId).single();
                if(!resp.error && resp.data) {
                    currentPlan = resp.data;
                }
            } catch(e) { /* no plan yet */ }

            if(!currentPlan || !currentPlan.plan_daten) {
                renderPlanUploadScreen(el);
            } else {
                await renderPlanVergleich(el);
            }
        }

        function renderPlanUploadScreen(el) {
            var h = '';
            h += '<div class="text-center py-8">';
            h += '<div class="max-w-lg mx-auto">';
            h += '<div class="text-6xl mb-4">ðŸ“‹</div>';
            h += '<h2 class="text-xl font-bold text-gray-800 mb-2">Jahresplan '+planIstYear+' hochladen</h2>';
            h += '<p class="text-sm text-gray-500 mb-6">Um den Plan/Ist-Vergleich nutzen zu kÃ¶nnen, lade zuerst deinen Jahresplan als Excel-Datei hoch. Das Portal liest die monatlichen Plan-Werte automatisch aus.</p>';
            h += '<div class="vit-card p-6 text-left">';
            h += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Schritt 1: Plan-Datei hochladen</p>';
            h += '<div class="p-4 border-2 border-dashed border-vit-orange/40 rounded-lg bg-orange-50/50 mb-4">';
            h += '<p class="text-xs text-gray-500 mb-2">Erwartetes Format: Excel oder PDF mit Monatszeilen und Spalten fÃ¼r Umsatz, Wareneinsatz, Personalkosten, etc.</p>';
            h += '<input type="file" id="planFileInput" accept=".xlsx,.xls,.csv,.pdf" class="text-xs" onchange="document.getElementById(\'planParseBtn\').disabled=!this.files.length">';
            h += '</div>';
            h += '<button id="planParseBtn" onclick="parsePlanFile()" disabled class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed mb-3">ðŸ“Š Plan auslesen & speichern</button>';
            h += '<div id="planParseStatus" class="hidden"></div>';
            h += '<div id="planParseResult" class="hidden"></div>';
            h += '</div>';
            // Manual entry option
            h += '<details class="vit-card p-6 text-left mt-4"><summary class="text-xs font-semibold text-gray-500 cursor-pointer">Alternativ: Plan manuell eingeben</summary>';
            h += '<div class="mt-4 space-y-2">';
            var mNamen = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            for(var m=1;m<=12;m++) {
                h += '<div class="flex items-center space-x-2"><label class="text-xs text-gray-600 w-24 flex-shrink-0">'+mNamen[m]+'</label>';
                h += '<input id="planM_umsatz_'+m+'" type="number" placeholder="Umsatz" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_we_'+m+'" type="number" placeholder="Wareneins." class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_pk_'+m+'" type="number" placeholder="Personal" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '<input id="planM_rk_'+m+'" type="number" placeholder="Raum" class="flex-1 px-2 py-1.5 border border-gray-200 rounded text-xs text-right">';
                h += '</div>';
            }
            h += '<button onclick="saveManualPlan()" class="w-full mt-3 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Plan speichern</button>';
            h += '</div></details>';
            h += '</div></div>';
            el.innerHTML = h;
        }

        async function parsePlanFile() {
            var fileInput = document.getElementById('planFileInput');
            if(!fileInput || !fileInput.files[0]) return;
            var file = fileInput.files[0];
            var statusEl = document.getElementById('planParseStatus');
            var resultEl = document.getElementById('planParseResult');
            statusEl.classList.remove('hidden');

            var isPdf = file.name.match(/\.pdf$/i);

            // PDF â†’ direkt KI-Analyse
            if(isPdf) {
                statusEl.innerHTML = '<div class="flex items-center space-x-2 mt-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600">ðŸ¤– PDF wird mit KI analysiert...</span></div>';
                try {
                    var reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            var base64 = e.target.result.split(',')[1];
                            var kiResult = await callFinanceKi('jahresplan', base64, 'application/pdf', null, {jahr: planIstYear});
                            applyPlanKiResult(kiResult, statusEl, resultEl);
                        } catch(err) {
                            statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ KI-Analyse fehlgeschlagen: ' + escH(err.message||'Unbekannt') + '</p>';
                        }
                    };
                    reader.readAsDataURL(file);
                } catch(pdfErr) {
                    statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Fehler: ' + escH(pdfErr.message||pdfErr) + '</p>';
                }
                return;
            }

            statusEl.innerHTML = '<div class="flex items-center space-x-2 mt-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600">Excel wird analysiert...</span></div>';

            // Try BwaParser first for structured Planung files
            BwaParser.parseFile(file, async function(err, result) {
                if(err) {
                    // KI-Fallback bei Parse-Fehler
                    statusEl.innerHTML = '<div class="flex items-center space-x-2 mt-2"><div class="w-4 h-4 border-2 border-vit-orange border-t-transparent rounded-full animate-spin"></div><span class="text-xs text-gray-600">ðŸ¤– Parser fehlgeschlagen â€“ KI-Analyse...</span></div>';
                    try {
                        var arrayBuf = await file.arrayBuffer();
                        var wb = XLSX.read(arrayBuf, { type: 'array' });
                        var rawText = cleanCsvForKi(wb);
                        var kiResult = await callFinanceKi('jahresplan', null, null, rawText.substring(0, 15000), {jahr: planIstYear});
                        applyPlanKiResult(kiResult, statusEl, resultEl);
                    } catch(kiErr) {
                        statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Auch KI-Analyse fehlgeschlagen: ' + escH(kiErr.message||kiErr) + '</p>';
                    }
                    return;
                }

                var planMonths = {};
                var meta = result.meta;

                // If it's a structured Planung file with plan_bwa data
                if(result.plan_bwa && result.plan_bwa.length > 0) {
                    var mn = ['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
                    // Find key BWA rows
                    var umsatzRow = result.plan_bwa.find(function(r) { return r.kontengruppe && r.kontengruppe.includes('UmsatzerlÃ¶se') && !r.konto; }) 
                        || result.plan_bwa.find(function(r) { return r.bezeichnung && r.bezeichnung.toLowerCase().includes('umsatzerlÃ¶se'); });
                    var weRow = result.plan_bwa.find(function(r) { return r.kontengruppe && (r.kontengruppe.includes('Wareneinsatz') || r.kontengruppe.includes('Materialaufwand')); });
                    var pkRow = result.plan_bwa.find(function(r) { return r.kontengruppe && r.kontengruppe.includes('Personalkosten'); });
                    var rkRow = result.plan_bwa.find(function(r) { return r.kontengruppe && r.kontengruppe.includes('Raumkosten'); });
                    
                    for(var m=0; m<12; m++) {
                        var mKey = mn[m];
                        planMonths[m+1] = {
                            monat: m+1,
                            umsatz: umsatzRow ? (umsatzRow[mKey]||0) : 0,
                            wareneinsatz: weRow ? (weRow[mKey]||0) : 0,
                            personalkosten: pkRow ? (pkRow[mKey]||0) : 0,
                            raumkosten: rkRow ? (rkRow[mKey]||0) : 0
                        };
                        // Calculate rohertrag + ergebnis
                        var pm = planMonths[m+1];
                        pm.rohertrag = pm.umsatz + pm.wareneinsatz;
                        pm.ergebnis = pm.rohertrag + pm.personalkosten + pm.raumkosten;
                    }
                    statusEl.innerHTML = '<p class="text-xs text-green-600 mt-2">âœ… Planung erkannt! ('+result.plan_bwa.length+' Konten, Format: '+meta.format+')</p>';
                } 
                // Fallback: old parsing logic for simple plan files
                else {
                    try {
                        var arrayBuf = await file.arrayBuffer();
                        var wb = XLSX.read(arrayBuf, { type: 'array' });
                        var sheet = wb.Sheets[wb.SheetNames[0]];
                        var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        var mNamen = {januar:1,jan:1,february:2,februar:2,feb:2,maerz:3,mÃ¤rz:3,mar:3,april:4,apr:4,mai:5,may:5,juni:6,jun:6,juli:7,jul:7,august:8,aug:8,september:9,sep:9,oktober:10,okt:10,oct:10,november:11,nov:11,dezember:12,dez:12,dec:12};
                        rows.forEach(function(row) {
                            if(!row || row.length < 2) return;
                            var label = String(row[0]||'').trim().toLowerCase().replace(/[^a-zÃ¤Ã¶Ã¼]/g,'');
                            var monat = mNamen[label];
                            if(!monat) return;
                            var nums = [];
                            for(var c=1; c<row.length; c++) {
                                var v = typeof row[c]==='number' ? row[c] : parseFloat(String(row[c]).replace(/\./g,'').replace(',','.').replace(/[â‚¬%\s]/g,''));
                                if(!isNaN(v)) nums.push(v);
                            }
                            if(nums.length > 0) planMonths[monat] = {monat:monat,umsatz:nums[0]||0,wareneinsatz:nums[1]||0,rohertrag:nums[2]||0,personalkosten:nums[3]||0,raumkosten:nums[4]||0,ergebnis:nums[7]||0};
                        });
                        statusEl.innerHTML = '<p class="text-xs text-green-600 mt-2">âœ… '+Object.keys(planMonths).length+' Monate erkannt!</p>';
                    } catch(e2) {
                        statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Fehler: '+(e2.message||e2)+'</p>';
                        return;
                    }
                }

                var count = Object.keys(planMonths).length;
                if(count < 1) {
                    statusEl.innerHTML = '<p class="text-xs text-red-600 mt-2">âŒ Keine Monatsdaten erkannt. Bitte prÃ¼fe das Format deiner Excel-Datei.</p>';
                    return;
                }

                // Show preview
                var mLabels = ['','Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
                var ph = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-3">';
                ph += '<p class="text-xs font-semibold text-green-700 mb-2">Erkannte Plan-Werte:</p>';
                ph += '<div class="grid grid-cols-6 gap-1 text-[10px]">';
                for(var mm=1;mm<=12;mm++) {
                    var pd = planMonths[mm];
                    ph += '<div class="text-center p-1 '+(pd?'bg-white rounded':'text-gray-300')+'"><div class="font-semibold">'+mLabels[mm]+'</div>';
                    ph += '<div>'+(pd ? Math.round(pd.umsatz).toLocaleString('de-DE') : 'â€”')+'</div></div>';
                }
                ph += '</div>';
                ph += '<button onclick="saveParsedPlan()" class="w-full mt-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:opacity-90">âœ… Plan fÃ¼r '+planIstYear+' speichern</button>';
                ph += '</div>';
                resultEl.innerHTML = ph;
                resultEl.classList.remove('hidden');

                // Store for saving
                window._parsedPlanMonths = planMonths;
            });
        }

        // Shared KI-Finance helper
        async function callFinanceKi(type, fileBase64, mediaType, rawText, meta) {
            var session = await sb.auth.getSession();
            var token = session?.data?.session?.access_token;
            var payload = { type: type };
            if(fileBase64) { payload.file_base64 = fileBase64; payload.media_type = mediaType || 'application/pdf'; }
            if(rawText) { payload.raw_text = rawText; }
            if(meta) { payload.meta = meta; }
            var resp = await fetch(SUPABASE_URL + '/functions/v1/analyze-finance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (token||''), 'apikey': SUPABASE_ANON_KEY },
                body: JSON.stringify(payload)
            });
            if(!resp.ok) { var errB=''; try { var eD=await resp.json(); errB=eD.error||eD.details||''; } catch(e2) {} throw new Error('KI-API Fehler ' + resp.status + (errB ? ': '+errB.substring(0,150) : '')); }
            var data = await resp.json();
            if(!data.result) throw new Error('Keine Ergebnisse');
            return data.result;
        }

        // Apply KI Jahresplan result to the plan preview
        function applyPlanKiResult(result, statusEl, resultEl) {
            if(!result || !result.monate) throw new Error('Keine Monatsdaten erkannt');
            var planMonths = {};
            Object.keys(result.monate).forEach(function(m) {
                var md = result.monate[m];
                if(!md) return;
                var monat = parseInt(m);
                planMonths[monat] = {
                    monat: monat,
                    umsatz: md.umsatz || 0,
                    wareneinsatz: md.wareneinsatz || 0,
                    personalkosten: md.personalkosten || 0,
                    raumkosten: md.raumkosten || 0,
                    rohertrag: (md.umsatz||0) + (md.wareneinsatz||0),
                    ergebnis: (md.umsatz||0) + (md.wareneinsatz||0) + (md.personalkosten||0) + (md.raumkosten||0)
                };
            });
            var count = Object.keys(planMonths).length;
            if(count < 1) throw new Error('Keine Monatsdaten erkannt');

            statusEl.innerHTML = '<p class="text-xs text-green-600 mt-2">âœ… KI-Analyse: ' + count + ' Monate erkannt' + (result.confidence ? ' (Konfidenz: ' + Math.round(result.confidence * 100) + '%)' : '') + '</p>';

            // Show preview (same format as normal parser)
            var mLabels = ['','Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var ph = '<div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mt-3">';
            ph += '<p class="text-xs font-semibold text-purple-700 mb-2">ðŸ¤– KI-erkannte Plan-Werte:</p>';
            ph += '<div class="grid grid-cols-6 gap-1 text-[10px]">';
            for(var mm=1;mm<=12;mm++) {
                var pd = planMonths[mm];
                ph += '<div class="text-center p-1 '+(pd?'bg-white rounded':'text-gray-300')+'"><div class="font-semibold">'+mLabels[mm]+'</div>';
                ph += '<div>'+(pd ? Math.round(pd.umsatz).toLocaleString('de-DE') : 'â€”')+'</div></div>';
            }
            ph += '</div>';
            if(result.hinweise && result.hinweise.length > 0) {
                ph += '<div class="mt-2 text-[10px] text-purple-600">' + result.hinweise.map(function(h){return 'âš ï¸ '+escH(h);}).join('<br>') + '</div>';
            }
            ph += '<p class="mt-2 text-[10px] text-purple-400">Bitte Werte vor dem Speichern kontrollieren.</p>';
            ph += '<button onclick="saveParsedPlan()" class="w-full mt-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:opacity-90">âœ… Plan fÃ¼r '+planIstYear+' speichern</button>';
            ph += '</div>';
            resultEl.innerHTML = ph;
            resultEl.classList.remove('hidden');

            window._parsedPlanMonths = planMonths;
        }

        async function saveParsedPlan() {
            var planMonths = window._parsedPlanMonths;
            if(!planMonths) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var payload = {
                    standort_id: stdId,
                    jahr: planIstYear,
                    plan_daten: planMonths,
                    erstellt_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                var resp = await sb.from('jahresplaene').upsert(payload, {onConflict:'standort_id,jahr'}).select();
                if(resp.error) throw resp.error;
                currentPlan = resp.data[0] || payload;
                alert('âœ… Jahresplan '+planIstYear+' gespeichert!');
                renderPlanIst();
            } catch(err) { alert('Fehler: '+(err.message||err)); }
        }

        async function saveManualPlan() {
            var planMonths = {};
            for(var m=1;m<=12;m++) {
                var u = parseFloat((document.getElementById('planM_umsatz_'+m)||{}).value) || 0;
                var we = parseFloat((document.getElementById('planM_we_'+m)||{}).value) || 0;
                var pk = parseFloat((document.getElementById('planM_pk_'+m)||{}).value) || 0;
                var rk = parseFloat((document.getElementById('planM_rk_'+m)||{}).value) || 0;
                if(u || we || pk || rk) {
                    planMonths[m] = { monat:m, umsatz:u, wareneinsatz:we, personalkosten:pk, raumkosten:rk };
                }
            }
            if(Object.keys(planMonths).length < 1) { alert('Bitte mindestens einen Monat ausfÃ¼llen.'); return; }
            window._parsedPlanMonths = planMonths;
            await saveParsedPlan();
        }

        async function renderPlanVergleich(el) {
            // Load all BWAs for this year
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var bwaResp = await sb.from('bwa_daten').select('*').eq('standort_id', stdId).eq('jahr', planIstYear).order('monat');
            var bwas = bwaResp.data || [];
            var bwaByMonth = {};
            bwas.forEach(function(b) { bwaByMonth[b.monat] = b; });

            var plan = currentPlan.plan_daten;
            var mLabels = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var currentMonth = new Date().getMonth() + 1;

            // Find selected month for detail view (default: latest with BWA data)
            var detailMonth = 0;
            for(var dm=12;dm>=1;dm--) { if(bwaByMonth[dm]) { detailMonth = dm; break; } }

            // KPIs: YTD totals
            var ytdPlanUmsatz = 0, ytdIstUmsatz = 0, ytdPlanErgebnis = 0, ytdIstErgebnis = 0;
            for(var k=1;k<=12;k++) {
                var p = plan[String(k)] || plan[k] || {};
                ytdPlanUmsatz += (p.umsatz||0);
                ytdPlanErgebnis += (p.ergebnis||0);
                if(bwaByMonth[k]) {
                    ytdIstUmsatz += (parseFloat(bwaByMonth[k].umsatzerloese)||0);
                    ytdIstErgebnis += (parseFloat(bwaByMonth[k].ergebnis_vor_steuern)||0);
                }
            }

            var h = '';
            // Year selector + reupload button
            h += '<div class="flex items-center justify-between mb-4">';
            h += '<div class="flex items-center space-x-3"><h2 class="text-lg font-bold text-gray-800">Plan / Ist Vergleich</h2>';
            h += '<select id="planIstYearSel" onchange="planIstYear=parseInt(this.value);currentPlan=null;renderPlanIst()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm">';
            for(var yy=2026;yy>=2024;yy--) h += '<option value="'+yy+'"'+(yy===planIstYear?' selected':'')+'>'+yy+'</option>';
            h += '</select></div>';
            h += '<button onclick="currentPlan=null;renderPlanIst()" class="text-xs text-vit-orange font-semibold hover:underline">ðŸ“„ Neuen Plan hochladen</button>';
            h += '</div>';

            // KPIs
            var diffUmsatz = ytdIstUmsatz - ytdPlanUmsatz;
            var pctUmsatz = ytdPlanUmsatz ? Math.round(ytdIstUmsatz/ytdPlanUmsatz*100) : 0;
            h += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz Plan YTD</p><p class="text-2xl font-bold text-blue-600">'+ytdPlanUmsatz.toLocaleString('de-DE')+' â‚¬</p></div>';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz Ist YTD</p><p class="text-2xl font-bold '+(ytdIstUmsatz>=ytdPlanUmsatz?'text-green-600':'text-red-500')+'">'+ytdIstUmsatz.toLocaleString('de-DE')+' â‚¬</p><p class="text-xs '+(diffUmsatz>=0?'text-green-600':'text-red-500')+'">'+(diffUmsatz>=0?'+':'')+diffUmsatz.toLocaleString('de-DE')+' â‚¬ ('+pctUmsatz+'%)</p></div>';
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">BWAs eingereicht</p><p class="text-2xl font-bold text-gray-800">'+bwas.length+' / '+(currentMonth-1)+'</p><p class="text-xs text-gray-500">Monate</p></div>';
            var missing = [];
            for(var mm=1;mm<currentMonth;mm++) { if(!bwaByMonth[mm]) missing.push(mLabels[mm]); }
            h += '<div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Fehlend</p><p class="text-2xl font-bold '+(missing.length>0?'text-red-500':'text-green-600')+'">'+(missing.length||'âœ…')+'</p>'+(missing.length?'<p class="text-[10px] text-red-400">'+missing.join(', ')+'</p>':'')+'</div>';
            h += '</div>';

            // Monthly overview table
            h += '<div class="vit-card p-6 mb-6">';
            h += '<h3 class="font-semibold text-gray-800 mb-3">MonatsÃ¼bersicht '+planIstYear+'</h3>';
            h += '<div class="overflow-x-auto"><table class="w-full text-sm">';
            h += '<thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-3 font-semibold text-gray-600">Monat</th><th class="text-right py-2.5 px-3 font-semibold text-blue-600">Plan Umsatz</th><th class="text-right py-2.5 px-3 font-semibold text-vit-orange">Ist Umsatz</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">ErfÃ¼llung</th><th class="text-center py-2.5 px-3 font-semibold text-gray-600">Status</th></tr></thead>';
            h += '<tbody>';
            var sumPlan=0,sumIst=0;
            for(var m=1;m<=12;m++) {
                var p = plan[String(m)] || plan[m] || {};
                var b = bwaByMonth[m];
                var pu = p.umsatz || 0;
                var iu = b ? (parseFloat(b.umsatzerloese)||0) : 0;
                sumPlan += pu; sumIst += iu;
                var diff = iu - pu;
                var pct = pu ? Math.round(iu/pu*100) : 0;
                var hasBwa = !!b;
                var isPast = m < currentMonth;
                var isCurrent = m === currentMonth;
                var status = hasBwa ? (pct>=100?'ðŸŸ¢':pct>=75?'ðŸŸ¡':'ðŸ”´') : (isPast?'âš ï¸':'â³');
                var rowCls = hasBwa ? (pct>=100?'bg-green-50 border-l-4 border-green-400':'bg-orange-50 border-l-4 border-orange-400') : (isCurrent?'bg-blue-50 border-l-4 border-blue-400':'text-gray-400');
                h += '<tr class="border-b '+rowCls+'" '+(hasBwa?'onclick="showMonthDetail('+m+')" class="cursor-pointer hover:bg-gray-100"':'')+'>';
                h += '<td class="py-2.5 px-3 font-semibold">'+mLabels[m]+(isCurrent?' <span class="text-[10px] text-blue-500">(aktuell)</span>':'')+'</td>';
                h += '<td class="text-right py-2.5 px-3 text-blue-600">'+pu.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 font-bold '+(hasBwa?'text-vit-orange':'')+'">'+( hasBwa ? iu.toLocaleString('de-DE') : 'â€”')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(hasBwa?(diff>=0?'text-green-600 font-semibold':'text-red-600 font-semibold'):'')+'">'+( hasBwa ? (diff>=0?'+':'')+diff.toLocaleString('de-DE') : 'â€”')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(hasBwa?(pct>=100?'text-green-600 font-bold':'text-red-600 font-bold'):'')+'">'+( hasBwa ? pct+'%' : 'â€”')+'</td>';
                h += '<td class="text-center py-2.5 px-3">'+status+'</td>';
                h += '</tr>';
            }
            var totalDiff = sumIst-sumPlan; var totalPct = sumPlan?Math.round(sumIst/sumPlan*100):0;
            h += '<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT '+planIstYear+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold text-blue-600">'+sumPlan.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold text-vit-orange">'+sumIst.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold '+(totalDiff>=0?'text-green-600':'text-red-600')+'">'+(totalDiff>=0?'+':'')+totalDiff.toLocaleString('de-DE')+'</td>';
            h += '<td class="text-right py-3 px-3 font-bold">'+totalPct+'%</td><td class="text-center">ðŸ“Š</td></tr>';
            h += '</tbody></table></div></div>';

            // Detail view for selected month
            if(detailMonth && bwaByMonth[detailMonth]) {
                var b = bwaByMonth[detailMonth];
                var p = plan[String(detailMonth)] || plan[detailMonth] || {};
                h += '<div class="vit-card p-6" id="planIstDetail">';
                h += '<div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-gray-800">Plan / Ist Detail â€“ '+mLabels[detailMonth]+' '+planIstYear+'</h3>';
                h += '<select onchange="showMonthDetail(parseInt(this.value))" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm">';
                for(var ms=1;ms<=12;ms++) {
                    var hasBwa2 = !!bwaByMonth[ms];
                    h += '<option value="'+ms+'"'+(ms===detailMonth?' selected':'')+(hasBwa2?'':' disabled')+'>'+mLabels[ms]+(hasBwa2?'':' (keine BWA)')+'</option>';
                }
                h += '</select></div>';
                h += buildPlanIstTable(p, b);
                h += '</div>';
            }

            el.innerHTML = h;
        }

        function buildPlanIstTable(plan, bwa) {
            var rows = [
                {label:'UmsatzerlÃ¶se', plan: plan.umsatz, ist: parseFloat(bwa.umsatzerloese)||0, bold:true},
                {label:'Wareneinsatz', plan: plan.wareneinsatz, ist: parseFloat(bwa.wareneinsatz)||0, bold:true},
                {label:'Rohertrag', plan: (plan.umsatz||0)+(plan.wareneinsatz||0), ist: parseFloat(bwa.rohertrag)||0, highlight:'blue'},
                {label:'Personalkosten', plan: plan.personalkosten, ist: parseFloat(bwa.personalkosten)||0, bold:true},
                {label:'Raumkosten', plan: plan.raumkosten, ist: parseFloat(bwa.raumkosten)||0},
                {label:'Werbe-/Reisekosten', plan: plan.werbekosten, ist: parseFloat(bwa.werbekosten)||0},
                {label:'Abschreibungen', plan: plan.abschreibungen||plan.abschreibung, ist: parseFloat(bwa.abschreibungen)||0},
                {label:'Sonstige Kosten', plan: plan.sonstige, ist: parseFloat(bwa.sonstige_kosten)||0},
                {label:'Gesamtkosten', plan: (plan.personalkosten||0)+(plan.raumkosten||0)+(plan.werbekosten||0)+(plan.sonstige||0), ist: parseFloat(bwa.gesamtkosten)||0, highlight:'gray'},
                {label:'Betriebsergebnis', plan: plan.ergebnis||((plan.umsatz||0)+(plan.wareneinsatz||0)+(plan.personalkosten||0)+(plan.raumkosten||0)+(plan.sonstige||0)), ist: parseFloat(bwa.betriebsergebnis)||0, highlight:'yellow'},
                {label:'Zinsaufwand', plan: plan.zins||plan.zinsaufwand, ist: parseFloat(bwa.zinsaufwand)||0},
                {label:'Ergebnis vor Steuern', plan: plan.ergebnis, ist: parseFloat(bwa.ergebnis_vor_steuern)||0, highlight:'result'}
            ];

            var h = '<div class="overflow-x-auto"><table class="w-full text-sm">';
            h += '<thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-3 font-semibold text-gray-600 w-1/4">Position</th><th class="text-right py-2.5 px-3 font-semibold text-blue-600">Plan</th><th class="text-right py-2.5 px-3 font-semibold text-vit-orange">Ist (BWA)</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2.5 px-3 font-semibold text-gray-600">%</th></tr></thead>';
            h += '<tbody>';
            rows.forEach(function(r) {
                var pv = r.plan || 0;
                var iv = r.ist || 0;
                var diff = iv - pv;
                var isGood = r.label.match(/Umsatz|Rohertrag|Ergebnis/) ? diff >= 0 : diff <= 0;
                var pct = pv ? Math.round(Math.abs(iv/pv)*100) : (iv?'â€”':'â€”');
                var bgCls = '';
                if(r.highlight==='blue') bgCls = 'bg-blue-50 border-b-2 border-gray-800';
                else if(r.highlight==='yellow') bgCls = 'bg-yellow-50 border-b-2 border-gray-600';
                else if(r.highlight==='gray') bgCls = 'bg-gray-100 border-t-2';
                else if(r.highlight==='result') bgCls = (iv>=0?'bg-green-50':'bg-red-50')+' border-t-2 border-gray-800';
                h += '<tr class="border-b '+bgCls+'">';
                h += '<td class="py-2.5 px-3 '+(r.bold||r.highlight?'font-bold':'font-semibold')+' text-gray-800 '+(r.highlight?'text-base':'')+'">'+r.label+'</td>';
                h += '<td class="text-right py-2.5 px-3 text-blue-600 '+(r.highlight?'font-bold':'')+'">'+pv.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(r.highlight?'font-bold text-base':'font-semibold')+' text-vit-orange">'+iv.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 font-semibold '+(isGood?'text-green-600':'text-red-600')+'">'+(diff>=0?'+':'')+diff.toLocaleString('de-DE')+'</td>';
                h += '<td class="text-right py-2.5 px-3 '+(isGood?'text-green-600':'text-red-600')+'">'+pct+'%</td>';
                h += '</tr>';
            });
            h += '</tbody></table></div>';
            // Rohertragsmarge
            var planMarge = (rows[0].plan||1) ? (((rows[2].plan||0)/(rows[0].plan||1))*100).toFixed(1) : 0;
            var istMarge = (rows[0].ist||1) ? (((rows[2].ist||0)/(rows[0].ist||1))*100).toFixed(1) : 0;
            h += '<div class="mt-3 flex items-center space-x-4 text-xs text-gray-500"><span>Rohertragsmarge: <strong class="text-blue-600">Plan '+planMarge+'%</strong></span><span>|</span><span><strong class="text-vit-orange">Ist '+istMarge+'%</strong></span><span>|</span><span class="'+(parseFloat(istMarge)>=parseFloat(planMarge)?'text-green-600':'text-red-500')+'">Differenz: '+(parseFloat(istMarge)-parseFloat(planMarge)).toFixed(1)+' Pp</span></div>';
            return h;
        }

        function showMonthDetail(m) {
            // Re-render detail only - we need to reload
            renderPlanIst();
        }

        function editSelectedBwa() {
            if(!selectedBwaId) return;
            // Find in cache and open modal pre-filled
            var b = bwaCache.find(function(x){return x.id===selectedBwaId;});
            if(!b) { openBwaUploadModal(); return; }
            openBwaUploadModal();
            // Pre-fill after modal renders
            setTimeout(async function(){
                try {
                    var resp = await sb.from('bwa_daten').select('*').eq('id', selectedBwaId).single();
                    if(resp.error) return;
                    var d = resp.data;
                    document.getElementById('bwaMonth').value = d.monat;
                    document.getElementById('bwaYear').value = d.jahr;
                    var map = {
                        'bwaF_umsatz':d.umsatzerloese,'bwaF_fahrraeder':d.davon_fahrraeder,'bwaF_teile':d.davon_teile,
                        'bwaF_service':d.davon_service,'bwaF_skonti':d.davon_skonti,'bwaF_wareneinsatz':d.wareneinsatz,
                        'bwaF_personal':d.personalkosten,'bwaF_raum':d.raumkosten,'bwaF_werbe':d.werbekosten,
                        'bwaF_warenabgabe':d.kosten_warenabgabe,'bwaF_abschreibung':d.abschreibungen,'bwaF_sonstige':d.sonstige_kosten,
                        'bwaF_zins':d.zinsaufwand,'bwaF_planUmsatz':d.plan_umsatz,'bwaF_planWareneinsatz':d.plan_wareneinsatz,
                        'bwaF_planRohertrag':d.plan_rohertrag,'bwaF_planPersonal':d.plan_personalkosten,'bwaF_planRaum':d.plan_raumkosten,
                        'bwaF_planWerbe':d.plan_werbekosten,'bwaF_planGesamt':d.plan_gesamtkosten,'bwaF_planErgebnis':d.plan_ergebnis
                    };
                    Object.keys(map).forEach(function(id) { var el = document.getElementById(id); if(el && map[id]) el.value = map[id]; });
                } catch(e) {}
            }, 200);
        }

        async function deleteBwa() {
            if(!selectedBwaId) return;
            if(!confirm('BWA wirklich loeschen?')) return;
            try {
                var resp = await sb.from('bwa_daten').delete().eq('id', selectedBwaId);
                if(resp.error) throw resp.error;
                selectedBwaId = null;
                document.getElementById('bwaTitle').textContent = 'BWA auswaehlen';
                document.getElementById('bwaDetailBody').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">BWA geloescht.</td></tr>';
                document.getElementById('bwaEditBtn').style.display = 'none';
                document.getElementById('bwaDeleteBtn').style.display = 'none';
                document.getElementById('bwaTrendSection').style.display = 'none';
                document.getElementById('bwaKpiUmsatz').textContent = 'â€”';
                document.getElementById('bwaKpiRohertrag').textContent = 'â€”';
                document.getElementById('bwaKpiKosten').textContent = 'â€”';
                document.getElementById('bwaKpiErgebnis').textContent = 'â€”';
                loadBwaList();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // =============================================
        // VERKAUFSERFOLG TRACKING - SUPABASE
        // =============================================
        var vtCache = [];

        async function loadVerkaufTracking() {
            var stdId = sbProfile ? sbProfile.standort_id : null;
            var now = new Date();
            // Get Monday of current week
            var day = now.getDay(); var diff = now.getDate() - day + (day===0?-6:1);
            var monday = new Date(now); monday.setDate(diff); monday.setHours(0,0,0,0);
            var sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
            var monStr = monday.toISOString().slice(0,10);
            var sunStr = sunday.toISOString().slice(0,10);
            try {
                var query = sb.from('verkauf_tracking').select('*').gte('datum', monStr).lte('datum', sunStr).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                vtCache = resp.data || [];
                renderVerkaufFromDb();
            } catch(err) { console.error('VT load error:', err); }
        }

        function renderVerkaufFromDb() {
            // Aggregate data by seller
            var sellerMap = {};
            vtCache.forEach(function(entry) {
                var name = entry.verkaeufer_name;
                if(!sellerMap[name]) sellerMap[name] = {name:name,total:0,verkauft:0,umsatz:0,daily:{}};
                var s = sellerMap[name];
                var d = new Date(entry.datum);
                var dayNames = ['So','Mo','Di','Mi','Do','Fr','Sa'];
                var dayName = dayNames[d.getDay()];
                s.daily[dayName] = entry;
                var gesamt = (entry.geplant||0) + (entry.spontan||0) + (entry.online||0) + (entry.ergo||0);
                s.total += gesamt;
                s.verkauft += (entry.verkauft||0);
                s.umsatz += parseFloat(entry.umsatz)||0;
            });

            // Update KPIs
            var totalPlan=0,totalGesamt=0,totalVerkauft=0,totalUmsatz=0;
            Object.values(sellerMap).forEach(function(s) {
                totalGesamt += s.total;
                totalVerkauft += s.verkauft;
                totalUmsatz += s.umsatz;
            });
            var el;
            el = document.getElementById('wkGesamt'); if(el) el.textContent = totalGesamt;
            el = document.getElementById('wkVerkauft'); if(el) el.textContent = totalVerkauft;
            el = document.getElementById('wkUmsatz'); if(el) el.textContent = totalUmsatz.toLocaleString('de-DE') + ' â‚¬';
            var quoteVal = totalGesamt > 0 ? Math.round((totalVerkauft/totalGesamt)*100) : 0;
            el = document.getElementById('wkQuote');
            if(el) { el.textContent = quoteVal + '%'; el.className = 'text-2xl font-bold ' + (quoteVal >= 70 ? 'text-green-600' : quoteVal >= 40 ? 'text-orange-600' : 'text-red-600'); }
        }

        function openVerkaufEntryModal() {
            var now = new Date();
            var today = now.toISOString().slice(0,10);
            var html = '<div id="vtEntryOverlay" onclick="closeVtModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">ðŸ’° Verkaufserfolg eintragen</h3><button onclick="closeVtModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Datum</label><input id="vtDate" type="date" value="'+today+'" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Verkaeufer</label><input id="vtSeller" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Name" value="'+(sbProfile?sbProfile.name:'')+'"></div>';
            html += '</div>';
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Beratungen</p>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            var vtFields = [
                {id:'vtPlan',label:'Plan-Termine',ph:'0'},
                {id:'vtGeplant',label:'Geplant',ph:'0'},
                {id:'vtSpontan',label:'Spontan',ph:'0'},
                {id:'vtOnline',label:'Online',ph:'0'},
                {id:'vtErgo',label:'Ergo-Beratung',ph:'0'},
                {id:'vtVerkauft',label:'Verkauft âœ…',ph:'0'}
            ];
            vtFields.forEach(function(f) {
                html += '<div><label class="block text-xs text-gray-600 mb-1">'+f.label+'</label>';
                html += '<input id="'+f.id+'" type="number" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-center" placeholder="'+f.ph+'" value="0"></div>';
            });
            html += '</div>';
            html += '<div class="grid grid-cols-2 gap-3 mb-4">';
            html += '<div><label class="block text-xs text-gray-600 mb-1">Uebergaben</label><input id="vtUebergabe" type="number" min="0" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-center" value="0"></div>';
            html += '<div><label class="block text-xs text-gray-600 mb-1">Umsatz (â‚¬)</label><input id="vtUmsatz" type="number" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-right" placeholder="0"></div>';
            html += '</div>';
            html += '<div class="mb-3"><label class="block text-xs text-gray-600 mb-1">Notizen</label><textarea id="vtNotizen" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" rows="2" placeholder="z.B. Kunde kommt naechste Woche wieder..."></textarea></div>';
            html += '<div id="vtError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveVtEntry()" id="vtSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'vtEntryContainer'; c.innerHTML = html; document.body.appendChild(c);
        }

        function closeVtModal() { var c = document.getElementById('vtEntryContainer'); if(c) c.remove(); }

        // =============================================
        // AUSWERTUNG TAB - Yearly Analysis from DB
        // =============================================
        async function loadAuswertung() {
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var year = new Date().getFullYear();
                var startDate = year+'-01-01';
                var endDate = year+'-12-31';
                var query = sb.from('verkauf_tracking').select('*').gte('datum', startDate).lte('datum', endDate).order('datum');
                if(stdId && !sbProfile.is_hq) query = query.eq('standort_id', stdId);
                var resp = await query;
                if(resp.error) throw resp.error;
                var data = resp.data || [];
                renderAuswertung(data, year);
            } catch(e) { console.error('Auswertung load:', e); }
        }

        function renderAuswertung(data, year) {
            var mn = ['','Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var mnFull = ['','Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var nowMonth = new Date().getMonth()+1;
            // Aggregate by month
            var months = {};
            for(var m=1;m<=12;m++) months[m]={beratungen:0,verkauft:0,umsatz:0,plan:0};
            var sellerMap = {};
            data.forEach(function(d){
                var dm = new Date(d.datum).getMonth()+1;
                var ges = (d.geplant||0)+(d.spontan||0)+(d.online||0)+(d.ergo||0);
                months[dm].beratungen += ges;
                months[dm].verkauft += (d.verkauft||0);
                months[dm].umsatz += parseFloat(d.umsatz)||0;
                months[dm].plan += (d.plan_termine||0);
                // Seller aggregation
                var n = d.verkaeufer_name||'Unbekannt';
                if(!sellerMap[n]) sellerMap[n]={name:n,umsatz:0,verkauft:0,beratungen:0};
                sellerMap[n].umsatz += parseFloat(d.umsatz)||0;
                sellerMap[n].verkauft += (d.verkauft||0);
                sellerMap[n].beratungen += ges;
            });
            // Year totals
            var totBer=0,totVk=0,totUms=0;
            for(var m=1;m<=12;m++){totBer+=months[m].beratungen;totVk+=months[m].verkauft;totUms+=months[m].umsatz;}
            var ytdQuote = totBer>0?Math.round(totVk/totBer*100):0;
            var avgPreis = totVk>0?Math.round(totUms/totVk):0;
            // Update KPIs
            var el;
            el=document.getElementById('ausUmsatzYTD'); if(el) el.textContent=eur(totUms)+' \u20AC';
            el=document.getElementById('ausVerkauft'); if(el) el.textContent=totVk;
            el=document.getElementById('ausQuote'); if(el) el.textContent=ytdQuote+'%';
            el=document.getElementById('ausAvgPreis'); if(el) el.textContent=eur(avgPreis)+' \u20AC';

            // SVG Chart
            var chartEl = document.getElementById('ausChartContainer');
            if(chartEl) {
                var w=chartEl.offsetWidth||600; var h=180; var pad=40;
                var vals=[]; for(var m=1;m<=12;m++) vals.push(months[m].umsatz);
                var maxV=Math.max.apply(null,vals.concat([1]));
                var barW=Math.floor((w-pad*2)/12)-8;
                var svg='<svg width="'+w+'" height="'+(h+30)+'" style="display:block">';
                // Grid lines
                for(var g=0;g<=4;g++){
                    var gy=pad+g*(h-pad)/4;
                    var label=eur(Math.round(maxV*(4-g)/4));
                    svg+='<line x1="'+pad+'" y1="'+gy+'" x2="'+(w-10)+'" y2="'+gy+'" stroke="#e5e7eb" stroke-width="1"/>';
                    svg+='<text x="'+(pad-5)+'" y="'+(gy+4)+'" text-anchor="end" fill="#9ca3af" font-size="9">'+label+'</text>';
                }
                // Bars
                for(var m=1;m<=12;m++){
                    var x=pad+(m-1)*((w-pad*2)/12)+4;
                    var val=vals[m-1];
                    var barH=maxV>0?(val/maxV)*(h-pad):0;
                    var color=m<=nowMonth?(val>0?'#EF7D00':'#D1D5DB'):'#E5E7EB';
                    svg+='<rect x="'+x+'" y="'+(h-barH)+'" width="'+barW+'" height="'+Math.max(barH,1)+'" rx="3" fill="'+color+'"/>';
                    if(val>0) svg+='<text x="'+(x+barW/2)+'" y="'+(h-barH-4)+'" text-anchor="middle" fill="#374151" font-size="9" font-weight="bold">'+eur(val)+'</text>';
                    svg+='<text x="'+(x+barW/2)+'" y="'+(h+15)+'" text-anchor="middle" fill="#6B7280" font-size="10">'+mn[m]+'</text>';
                }
                svg+='</svg>';
                chartEl.innerHTML=svg;
            }

            // Monthly table
            var tbody=document.getElementById('jahresTabelle');
            if(tbody){
                var h='';
                for(var m=1;m<=12;m++){
                    var md=months[m];
                    var q=md.beratungen>0?Math.round(md.verkauft/md.beratungen*100):0;
                    var avg=md.verkauft>0?Math.round(md.umsatz/md.verkauft):0;
                    var isCur=m===nowMonth; var isPast=m<nowMonth; var hasDat=md.beratungen>0||md.umsatz>0;
                    var rc=isCur?'bg-blue-50 border-l-4 border-blue-400':hasDat?'':'text-gray-400';
                    h+='<tr class="border-b '+rc+'">';
                    h+='<td class="py-2.5 px-3 '+(isCur?'font-semibold':'')+'">'+mnFull[m]+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.beratungen>0?'text-blue-600 font-semibold':'')+'">'+( md.beratungen>0?md.beratungen:'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.verkauft>0?'text-green-600 font-bold':'')+'">'+( md.verkauft>0?md.verkauft:'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(q>=70?'text-green-600':q>=40?'text-orange-600':q>0?'text-red-600':'')+'">'+( q>0?q+'%':'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3 '+(md.umsatz>0?'font-bold text-vit-orange':'')+'">'+( md.umsatz>0?eur(md.umsatz)+' \u20AC':'\u2014')+'</td>';
                    h+='<td class="text-right py-2.5 px-3">'+( avg>0?eur(avg)+' \u20AC':'\u2014')+'</td>';
                    h+='</tr>';
                }
                h+='<tr class="bg-gray-100 border-t-2"><td class="py-3 px-3 font-bold">GESAMT '+year+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-blue-600">'+totBer+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-green-600">'+totVk+'</td>';
                h+='<td class="text-right py-3 px-3 font-bold">'+ytdQuote+'%</td>';
                h+='<td class="text-right py-3 px-3 font-bold text-vit-orange">'+eur(totUms)+' \u20AC</td>';
                h+='<td class="text-right py-3 px-3 font-bold">'+eur(avgPreis)+' \u20AC</td></tr>';
                tbody.innerHTML=h;
            }

            // Ranking
            var sellers=Object.values(sellerMap).sort(function(a,b){return b.umsatz-a.umsatz;});
            var rankEl=document.getElementById('ausRanking');
            if(rankEl && sellers.length>0){
                var medals=['\ud83e\udd47','\ud83e\udd48','\ud83e\udd49'];
                var colors=['border-2 border-yellow-400 bg-yellow-50','border-2 border-gray-300 bg-gray-50','border-2 border-orange-300 bg-orange-50'];
                var rh='';
                sellers.slice(0,8).forEach(function(s,i){
                    var cls=i<3?colors[i]:'border border-gray-200';
                    var q=s.beratungen>0?Math.round(s.verkauft/s.beratungen*100):0;
                    rh+='<div class="p-4 '+cls+' rounded-xl text-center">';
                    rh+='<p class="text-3xl mb-1">'+(i<3?medals[i]:(i+1))+'</p>';
                    rh+='<p class="font-bold text-gray-800">'+s.name+'</p>';
                    rh+='<p class="text-xl font-bold text-vit-orange">'+eur(s.umsatz)+' \u20AC</p>';
                    rh+='<p class="text-xs text-gray-500">'+s.verkauft+' Verkaeufe Â· Quote: '+q+'%</p>';
                    rh+='</div>';
                });
                rankEl.innerHTML=rh;
            } else if(rankEl) {
                rankEl.innerHTML='<p class="text-sm text-gray-400 col-span-4 text-center py-4">Noch keine Verkaufsdaten erfasst. Nutze "+ Eintragen" in der Wochenansicht.</p>';
            }
        }

        async function saveVtEntry() {
            var datum = (document.getElementById('vtDate')||{}).value;
            var seller = (document.getElementById('vtSeller')||{}).value;
            var errEl = document.getElementById('vtError');
            var btn = document.getElementById('vtSaveBtn');
            if(!datum || !seller.trim()) { if(errEl){errEl.textContent='Bitte Datum und Verkaeufer eingeben.';errEl.style.display='block';} return; }
            var vi = function(id) { return parseInt((document.getElementById(id)||{}).value) || 0; };
            var vf = function(id) { return parseFloat((document.getElementById(id)||{}).value) || 0; };

            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var data = {
                    standort_id: stdId,
                    datum: datum,
                    verkaeufer_name: seller.trim(),
                    plan_termine: vi('vtPlan'),
                    geplant: vi('vtGeplant'),
                    spontan: vi('vtSpontan'),
                    online: vi('vtOnline'),
                    ergo: vi('vtErgo'),
                    verkauft: vi('vtVerkauft'),
                    uebergabe: vi('vtUebergabe'),
                    umsatz: vf('vtUmsatz'),
                    notizen: (document.getElementById('vtNotizen')||{}).value || null,
                    erfasst_von: sbUser ? sbUser.id : null,
                    updated_at: new Date().toISOString()
                };
                var resp = await sb.from('verkauf_tracking').upsert(data, {onConflict:'standort_id,datum,verkaeufer_name'}).select();
                if(resp.error) throw resp.error;
                closeVtModal();
                alert('âœ… Verkaufsdaten gespeichert!');
                loadVerkaufTracking();
                loadWeekFromDb();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Speichern'; }
            }
        }

        // Load BWA on controlling tab open
        var origShowControllingTab = showControllingTab;
        showControllingTab = function(t) {
            origShowControllingTab(t);
            if(t === 'bwa') loadBwaList();
            if(t === 'planist') renderPlanIst();
            if(t === 'ctrlWissen') renderWissenTab('controlling','ctrlTabCtrlWissen');
        };

        // === LEAD REPORTING DASHBOARD (computed from hqStandorte) ===
        function getLeadData() {
            // Standorte performance sorted
            var standorte = hqStandorte.map(function(s) {
                return { name: s.name, perf: s.leadPerf };
            }).sort(function(a,b) { return a.perf - b.perf; });

            // Monthly data - use actual data from DB where available
            var monate = [
                { name: 'Jan', soll: 135.3 }, { name: 'Feb', soll: 287.4 },
                { name: 'Maerz', soll: 363.4 }, { name: 'Apr', soll: 397.3 },
                { name: 'Mai', soll: 432.9 }, { name: 'Jun', soll: 397.3 },
                { name: 'Jul', soll: 396.2 }, { name: 'Aug', soll: 359.7 },
                { name: 'Sep', soll: 324.0 }, { name: 'Okt', soll: 218.8 },
                { name: 'Nov', soll: 182.0 }, { name: 'Dez', soll: 108.2 }
            ];
            // Calculate actual totals from standorte
            var totalIst = hqStandorte.reduce(function(a,s){ return a + s.umsatzIst; }, 0);
            var totalLeads = hqStandorte.reduce(function(a,s){ return a + s.leads; }, 0);
            var currentMonth = new Date().getMonth();
            if(currentMonth >= 0 && totalIst > 0) monate[0].ist = Math.round(totalIst * 0.4 / 1000);
            if(currentMonth >= 1 && totalIst > 0) monate[1].ist = Math.round(totalIst * 0.6 / 1000);

            return { standorte: standorte, monate: monate };
        }

        function getPerformanceColor(perf) {
            if (perf >= 100) return 'bg-yellow-400';
            if (perf >= 75) return 'bg-green-500';
            if (perf >= 50) return 'bg-orange-500';
            return 'bg-red-500';
        }

        function getPerformanceDot(perf) {
            if (perf >= 100) return '#FBBF24';
            if (perf >= 75) return '#22C55E';
            if (perf >= 50) return '#F97316';
            return '#EF4444';
        }

        async function renderLeadDashboard() {
            try { if(hqStandorte.length === 0) await loadHqStandorte(); } catch(e) { console.warn('Lead dashboard: no HQ data'); }
            var leadData = getLeadData();
            if(!leadData || !leadData.monate) return;
            // Chart Bars
            var chartBars = document.getElementById('chartBars');
            var chartLabels = document.getElementById('chartLabels');
            if (!chartBars) return;
            var maxVal = 600;
            var barsHtml = '';
            var labelsHtml = '';
            leadData.monate.forEach(function(m) {
                var sollH = (m.soll / maxVal) * 100;
                var istH = m.ist ? (m.ist / maxVal) * 100 : 0;
                barsHtml += '<div class="flex-1 flex items-end justify-center space-x-1">' +
                    '<div class="w-5 bg-gray-300 rounded-t" style="height:' + sollH + '%;"></div>';
                if (m.ist) {
                    barsHtml += '<div class="w-5 bg-vit-orange rounded-t" style="height:' + istH + '%;"></div>';
                }
                barsHtml += '</div>';
                labelsHtml += '<span class="flex-1 text-center">' + m.name + '</span>';
            });
            chartBars.innerHTML = barsHtml;
            chartLabels.innerHTML = labelsHtml;

            // Detail Table
            var tbody = document.getElementById('detailTableBody');
            if (!tbody) return;
            var rowsHtml = '';
            leadData.monate.forEach(function(m, i) {
                var isCurrent = (i === 1);
                var rowClass = isCurrent ? 'bg-blue-50 border-l-4 border-blue-400' : '';
                var statusIcon = 'â³';
                if (m.perf) {
                    statusIcon = m.perf >= 100 ? 'âœ…' : 'âŒ';
                }
                rowsHtml += '<tr class="border-b border-gray-100 ' + rowClass + '">' +
                    '<td class="py-3 px-2 font-semibold text-gray-800">' + m.name + '</td>' +
                    '<td class="py-3 px-2 text-right text-gray-700">' + m.soll.toFixed(1) + '</td>' +
                    '<td class="py-3 px-2 text-right text-green-600 font-semibold">' + (m.ist || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-purple-600">' + (m.termin_cost ? m.termin_cost + ' â‚¬' : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-blue-600">' + (m.sv025 || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right text-orange-600">' + (m.sv_roh || 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right font-bold text-gray-800">' + (m.gesamt ? m.gesamt.toFixed(1) : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right ' + (m.diff > 0 ? 'text-green-600' : m.diff < 0 ? 'text-red-600' : 'text-gray-400') + ' font-semibold">' + (m.diff ? (m.diff > 0 ? '+' : '') + m.diff.toFixed(1) : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-right font-bold ' + (m.perf >= 100 ? 'text-green-600' : m.perf ? 'text-red-600' : 'text-gray-400') + '">' + (m.perf ? m.perf + '%' : 'â€”') + '</td>' +
                    '<td class="py-3 px-2 text-center">' + statusIcon + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = rowsHtml;
        }

        // Render on load
        renderLeadDashboard();

        // === WISSEN MODULE ===
        function showWissenTab(tabName) {
            document.querySelectorAll('.wissen-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.wissen-tab-btn').forEach(function(b){
                b.className='wissen-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {akademie:'Akademie',handbuecher:'Handbuecher',bestpractices:'Bestpractices',faq:'Faq'};
            var el = document.getElementById('wissenTab' + (tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.wissen-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='wissen-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        // --- AKADEMIE DATA ---
        var akademieKurse = [
            {id:1, title:'Verkaufsgespraech E-Bike', desc:'Bedarfsermittlung, Einwandbehandlung, Abschluss-Techniken fuer E-Bike Beratung', cat:'verkauf', pflicht:true, dauer:'45 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:2, title:'Ergonomie-Beratung im Laden', desc:'Koerperanalyse, Sitzposition, Rahmengroesse bestimmen â€“ mit SQlab Methodik', cat:'verkauf', pflicht:true, dauer:'60 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:3, title:'Leasing richtig erklaeren', desc:'JobRad, Dienstrad, Bikeleasing â€“ Unterschiede, Rechenbeispiele, Einwaende', cat:'verkauf', pflicht:true, dauer:'30 Min.', progress:75, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:4, title:'Bosch Diagnose-Tool', desc:'Smart System, Fehlercode-Auslesen, Software-Updates, Kundenkommunikation', cat:'allgemein', pflicht:true, dauer:'90 Min.', progress:100, zertifikat:true, format:'ðŸ›  Workshop'},
            {id:5, title:'Shimano Steps Technik', desc:'Di2, EP8 Motor, Fehlerdiagnose, Firmware-Updates', cat:'allgemein', pflicht:false, dauer:'60 Min.', progress:50, zertifikat:false, format:'ðŸ›  Workshop'},
            {id:6, title:'vit:bikes Kassensystem Schulung', desc:'Tagesabschluss, Retouren, Gutscheine, Lagerbuchungen im POS', cat:'allgemein', pflicht:true, dauer:'40 Min.', progress:100, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:7, title:'Social Media fuer Partner', desc:'Reels erstellen, Story-Formate, Hashtag-Strategie, Content-Kalender', cat:'marketing', pflicht:false, dauer:'35 Min.', progress:30, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:8, title:'Google My Business optimieren', desc:'Fotos, Beitraege, Rezensionen beantworten, Insights nutzen', cat:'marketing', pflicht:false, dauer:'25 Min.', progress:100, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:9, title:'Event-Planung &amp; Durchfuehrung', desc:'Testivals, Grillvents, Schluesselaktionen â€“ von der Idee bis zur Nachbereitung', cat:'marketing', pflicht:false, dauer:'50 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:10, title:'Vororder richtig planen', desc:'Bedarfsanalyse, Saisonplanung, Verhandlung mit Lieferanten, Blockorder-Strategie', cat:'einkauf', pflicht:true, dauer:'55 Min.', progress:100, zertifikat:true, format:'ðŸŽ¬ Video'},
            {id:11, title:'Rohertrag optimieren', desc:'Rabatt-Strategie, Dreingaben statt Nachlass, Marken-Mix fuer maximalen DB', cat:'einkauf', pflicht:false, dauer:'30 Min.', progress:60, zertifikat:false, format:'ðŸ“Š Case Study'},
            {id:12, title:'Lagermanagement &amp; Umschlag', desc:'Bestandsoptimierung, Slow-Mover erkennen, Abverkaufsstrategien', cat:'einkauf', pflicht:false, dauer:'40 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:13, title:'BWA lesen &amp; verstehen', desc:'Umsatzerloese, Rohertrag, Kostenarten, Betriebsergebnis â€“ Praxis fuer Nicht-Kaufleute', cat:'controlling', pflicht:true, dauer:'45 Min.', progress:100, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:14, title:'Plan/Ist-Analyse durchfuehren', desc:'Monatliche Abweichungen erkennen, Massnahmen ableiten, Benchmarks nutzen', cat:'controlling', pflicht:false, dauer:'35 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:15, title:'Liquiditaetsplanung Basics', desc:'Cashflow verstehen, Zahlungsziele nutzen, saisonale Engpaesse vorbeugen', cat:'controlling', pflicht:false, dauer:'30 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'},
            {id:16, title:'Pipeline-Management im Portal', desc:'Leads erfassen, Kanban nutzen, Wiedervorlage, Conversion-Tracking', cat:'verkauf', pflicht:false, dauer:'20 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:17, title:'Reklamation &amp; Garantie', desc:'Ablauf Garantiefall, Hersteller-Kontakt, Dokumentation, Kulanz-Regeln', cat:'allgemein', pflicht:false, dauer:'35 Min.', progress:0, zertifikat:false, format:'ðŸ“„ Anleitung'},
            {id:18, title:'Personalfuehrung im Fachhandel', desc:'Teamgespraeche, Zielvereinbarungen, Motivation, Feedback-Kultur', cat:'allgemein', pflicht:false, dauer:'50 Min.', progress:0, zertifikat:false, format:'ðŸŽ¬ Video'}
        ];
        var akdFilterCat = 'all';
        function filterAkademie(cat) {
            akdFilterCat = cat;
            document.querySelectorAll('.akd-filter-btn').forEach(function(b){ b.className='akd-filter-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.akd-filter-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='akd-filter-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderAkademie();
        }
        function renderAkademie() {
            var g = document.getElementById('akademieGrid'); if(!g) return;
            var filtered = akademieKurse.filter(function(k){ return akdFilterCat==='all' || k.cat===akdFilterCat; });
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var h = '';
            filtered.forEach(function(k){
                var pColor = k.progress>=100?'bg-green-500':k.progress>=50?'bg-vit-orange':'bg-gray-300';
                var statusText = k.progress>=100?'<span class="text-green-600 text-xs font-bold">âœ“ Abgeschlossen</span>':k.progress>0?'<span class="text-vit-orange text-xs font-bold">In Bearbeitung</span>':'<span class="text-gray-400 text-xs">Nicht gestartet</span>';
                h += '<div class="vit-card p-5">' +
                    '<div class="flex items-start justify-between mb-2">' +
                        '<div class="flex items-center space-x-2">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[k.cat]+'">'+catLabels[k.cat]+'</span>' +
                            (k.pflicht?'<span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-700">Pflicht</span>':'') +
                            '<span class="text-xs text-gray-400">'+k.format+'</span>' +
                        '</div>' +
                        (k.zertifikat?'<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-semibold">ðŸ† Zertifikat</span>':'') +
                    '</div>' +
                    '<h4 class="font-semibold text-gray-800 mb-1">'+k.title+'</h4>' +
                    '<p class="text-xs text-gray-500 mb-3">'+k.desc+'</p>' +
                    '<div class="flex items-center justify-between">' +
                        '<div class="flex-1 mr-4"><div class="w-full bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div></div>' +
                        '<span class="text-xs text-gray-500 mr-3">'+k.progress+'%</span>' +
                        '<span class="text-xs text-gray-400">'+k.dauer+'</span>' +
                    '</div>' +
                    '<div class="mt-2">'+statusText+'</div>' +
                '</div>';
            });
            g.innerHTML = h || '<p class="text-gray-400 text-sm py-8 text-center">Keine Kurse in dieser Kategorie.</p>';
        }
        renderAkademie();

        // --- HANDBUECHER DATA ---
        var handbuecher = [
            {title:'Bosch Smart System â€“ Einrichtung &amp; Diagnose', cat:'allgemein', marke:'Bosch', typ:'PDF', seiten:42, aktualisiert:'01/2026'},
            {title:'Shimano Steps EP8 â€“ Fehlercodes &amp; Loesungen', cat:'allgemein', marke:'Shimano', typ:'PDF', seiten:28, aktualisiert:'11/2025'},
            {title:'Shimano Di2 â€“ Einstellungen &amp; Updates', cat:'allgemein', marke:'Shimano', typ:'PDF', seiten:35, aktualisiert:'09/2025'},
            {title:'Kalkhoff Garantieabwicklung â€“ Prozesshandbuch', cat:'einkauf', marke:'Kalkhoff', typ:'PDF', seiten:18, aktualisiert:'03/2025'},
            {title:'Haibike Modellkatalog 2026', cat:'einkauf', marke:'Haibike', typ:'Katalog', seiten:64, aktualisiert:'10/2025'},
            {title:'Orbea MyO Konfigurator â€“ Haendler-Guide', cat:'verkauf', marke:'Orbea', typ:'PDF', seiten:12, aktualisiert:'06/2025'},
            {title:'Simplon Bestellprozess B2B-Portal', cat:'einkauf', marke:'Simplon', typ:'PDF', seiten:8, aktualisiert:'08/2025'},
            {title:'vit:bikes Kassensystem â€“ Benutzerhandbuch', cat:'allgemein', marke:'vit:bikes', typ:'PDF', seiten:55, aktualisiert:'01/2026'},
            {title:'vit:bikes CI-Guide â€“ Logo, Farben, Vorlagen', cat:'marketing', marke:'vit:bikes', typ:'PDF', seiten:24, aktualisiert:'04/2025'},
            {title:'Meta Business Suite â€“ Anleitung fuer Partner', cat:'marketing', marke:'Meta', typ:'PDF', seiten:32, aktualisiert:'02/2026'},
            {title:'Google Ads â€“ Kampagnen-Setup Leitfaden', cat:'marketing', marke:'Google', typ:'PDF', seiten:20, aktualisiert:'12/2025'},
            {title:'JobRad Haendler-Handbuch', cat:'verkauf', marke:'JobRad', typ:'PDF', seiten:38, aktualisiert:'01/2026'},
            {title:'Bikeleasing â€“ Vertragsprozess A-Z', cat:'verkauf', marke:'Bikeleasing', typ:'PDF', seiten:15, aktualisiert:'11/2025'},
            {title:'DATEV-Schnittstelle â€“ BWA-Export Anleitung', cat:'controlling', marke:'DATEV', typ:'PDF', seiten:10, aktualisiert:'01/2026'},
            {title:'Liquiditaetsplanung â€“ Excel-Vorlage &amp; Erklaerung', cat:'controlling', marke:'vit:bikes', typ:'Excel', seiten:5, aktualisiert:'09/2025'},
            {title:'SQlab Ergonomie-Messung â€“ Leitfaden', cat:'verkauf', marke:'SQlab', typ:'PDF', seiten:22, aktualisiert:'07/2025'},
            {title:'Velo de Ville â€“ Konfigurator &amp; Bestellprozess', cat:'einkauf', marke:'Velo de Ville', typ:'PDF', seiten:14, aktualisiert:'10/2025'},
            {title:'etermin â€“ Terminbuchung Setup', cat:'allgemein', marke:'etermin', typ:'PDF', seiten:9, aktualisiert:'05/2025'}
        ];
        var hbFilterCat = 'all';
        function filterHbCat(cat) {
            hbFilterCat = cat;
            document.querySelectorAll('.hb-cat-btn').forEach(function(b){ b.className='hb-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.hb-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='hb-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderHandbuecher();
        }
        function filterHandbuecher() { renderHandbuecher(); }
        function renderHandbuecher() {
            var g = document.getElementById('handbuchGrid'); if(!g) return;
            var q = (document.getElementById('hbSearch')||{}).value||'';
            q = q.toLowerCase();
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var typIcons = {PDF:'ðŸ“„',Katalog:'ðŸ“•',Excel:'ðŸ“Š'};
            var filtered = handbuecher.filter(function(h){
                var catOk = hbFilterCat==='all' || h.cat===hbFilterCat;
                var searchOk = !q || h.title.toLowerCase().indexOf(q)>-1 || h.marke.toLowerCase().indexOf(q)>-1 || h.cat.indexOf(q)>-1;
                return catOk && searchOk;
            });
            var html = '';
            filtered.forEach(function(h){
                html += '<div class="vit-card p-4 flex items-center justify-between">' +
                    '<div class="flex items-center space-x-4">' +
                        '<span class="text-2xl">'+(typIcons[h.typ]||'ðŸ“„')+'</span>' +
                        '<div>' +
                            '<p class="font-semibold text-sm text-gray-800">'+h.title+'</p>' +
                            '<div class="flex items-center space-x-2 mt-1">' +
                                '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[h.cat]+'">'+catLabels[h.cat]+'</span>' +
                                '<span class="text-xs text-gray-400">'+h.marke+'</span>' +
                                '<span class="text-xs text-gray-400">Â·</span>' +
                                '<span class="text-xs text-gray-400">'+h.seiten+' Seiten</span>' +
                                '<span class="text-xs text-gray-400">Â·</span>' +
                                '<span class="text-xs text-gray-400">Aktualisiert: '+h.aktualisiert+'</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<button class="px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:bg-orange-600">Oeffnen</button>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine Handbuecher gefunden.</p>';
        }
        renderHandbuecher();

        // --- BEST PRACTICES DATA ---
        var bestPractices = [
            {title:'So hat Hamburg seinen Rohertrag um 4 Pp gesteigert', cat:'einkauf', standort:'Hamburg', datum:'01/2026', desc:'Durch konsequentes Anbieten von Orbea und Simplon statt Kalkhoff-Einstiegsmodellen konnte Hamburg den durchschnittlichen DB1 von 31% auf 35% steigern.', likes:24, typ:'ðŸ“ˆ Erfolgsgeschichte'},
            {title:'Werkstatt-Auslastung auf 92% optimiert', cat:'allgemein', standort:'Muenchen-Thal.', datum:'11/2025', desc:'Durch Einfuehrung fester Werkstatt-Slots via etermin und Vorab-Diagnose am Telefon konnte die Durchlaufzeit pro Rad um 25% gesenkt werden.', likes:31, typ:'âš™ï¸ Prozess'},
            {title:'Erfolgreiche Event-Formate: Testival + Grillevent', cat:'marketing', standort:'Grafrath', datum:'05/2025', desc:'Kombination aus Probefahrten und lockerer Atmosphaere mit Waffeln und Getraenken. 108 Store Visits, 40 Terminbuchungen. Benefit statt Rabatt in den Vordergrund stellen.', likes:18, typ:'ðŸŽª Event'},
            {title:'Sqlab-Sattel statt Rabatt: 50% weniger Rohertragsverlust', cat:'verkauf', standort:'Zentrale', datum:'09/2025', desc:'100â‚¬ Sqlab Sattel als Dreingabe statt 100â‚¬ Rabatt: Kunde erhaelt gefuehlt gleichen Vorteil, Rohertragsverlust nur 50â‚¬ netto statt 100â‚¬.', likes:42, typ:'ðŸ’° Tipp'},
            {title:'Leasing-Anteil auf 38% gesteigert', cat:'verkauf', standort:'Wesel', datum:'12/2025', desc:'Durch aktive Ansprache und eine Leasing-Vergleichstabelle am Beratungsplatz konnten wir den Leasing-Anteil von 22% auf 38% steigern. Hoehere Durchschnittspreise als Effekt.', likes:27, typ:'ðŸ“ˆ Erfolgsgeschichte'},
            {title:'Google My Business: Von 4.2 auf 4.8 Sterne', cat:'marketing', standort:'Reutlingen', datum:'10/2025', desc:'Systematisches Ansprechen zufriedener Kunden bei Raduebergabe. QR-Code auf Kassenbon. Jede Rezension innerhalb 24h beantworten â€“ auch negative.', likes:35, typ:'â­ Tipp'},
            {title:'BWA monatlich im Team besprechen', cat:'controlling', standort:'Holzkirchen', datum:'02/2026', desc:'Jeden 10. des Monats 30-Min-Meeting mit allen Verkaeufern. Umsatz, Rohertrag, Nachlass-Quote transparent machen. Bewusstsein fuer Kosten schaerfen.', likes:19, typ:'ðŸ“Š Prozess'},
            {title:'Vororder-Planung mit Verkaufsdaten', cat:'einkauf', standort:'Karlsdorf-Neuth.', datum:'08/2025', desc:'Statt nach Bauchgefuehl zu ordern: Top-10-Modelle des Vorjahres als Basis, +10% Puffer fuer Wachstumsmarken, -20% fuer ruecklaeufige Kategorien.', likes:22, typ:'ðŸ“¦ Prozess'},
            {title:'Personalgespraeche alle 6 Wochen', cat:'allgemein', standort:'Muenster', datum:'01/2026', desc:'Kurze 20-Min-Check-ins mit jedem Mitarbeiter. Keine grossen Ueberraschungen bei Jahresgespraechen. Motivation und Bindung deutlich gestiegen.', likes:15, typ:'ðŸ‘¥ Fuehrung'},
            {title:'Plan/Ist-Abgleich als Fruehwarnsystem', cat:'controlling', standort:'Weilheim', datum:'11/2025', desc:'Wenn Umsatz in KW4 unter 80% des Plans liegt, sofort Gegenmassnahmen einleiten: Aktionen, Kundenkontakt, Social Media Push. Nicht bis Monatsende warten.', likes:28, typ:'ðŸš¨ Tipp'}
        ];
        var bpFilterCat = 'all';
        function filterBP(cat) {
            bpFilterCat = cat;
            document.querySelectorAll('.bp-cat-btn').forEach(function(b){ b.className='bp-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.bp-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='bp-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderBP();
        }
        function renderBP() {
            var g = document.getElementById('bpGrid'); if(!g) return;
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var filtered = bestPractices.filter(function(b){ return bpFilterCat==='all' || b.cat===bpFilterCat; });
            var html = '';
            filtered.forEach(function(b){
                html += '<div class="vit-card p-5">' +
                    '<div class="flex items-center justify-between mb-2">' +
                        '<div class="flex items-center space-x-2">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[b.cat]+'">'+catLabels[b.cat]+'</span>' +
                            '<span class="text-xs text-gray-400">'+b.typ+'</span>' +
                        '</div>' +
                        '<span class="text-xs text-gray-400">'+b.standort+' Â· '+b.datum+'</span>' +
                    '</div>' +
                    '<h4 class="font-semibold text-gray-800 mb-2">'+b.title+'</h4>' +
                    '<p class="text-sm text-gray-600 mb-3">'+b.desc+'</p>' +
                    '<div class="flex items-center justify-between">' +
                        '<span class="text-xs text-gray-400">ðŸ‘ '+b.likes+' Partner fanden das hilfreich</span>' +
                        '<button class="text-xs text-vit-orange font-semibold hover:text-orange-600">Hilfreich ðŸ‘</button>' +
                    '</div>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine Best Practices in dieser Kategorie.</p>';
        }
        renderBP();

        // --- FAQ DATA ---
        var faqItems = [
            {q:'Wie funktioniert die Garantieabwicklung bei Kalkhoff?', a:'Defektes Teil fotografieren, im Kalkhoff B2B-Portal Garantieantrag stellen (unter Service > Garantie). Bearbeitungszeit ca. 5-7 Werktage. Bei Rahmenbruch immer zuerst vit:bikes Einkauf kontaktieren.', cat:'einkauf'},
            {q:'Welche Leasing-Anbieter sind zugelassen?', a:'JobRad, Deutsche Dienstrad, Bikeleasing, Businessbike und Lease-a-Bike. Alle Anbieter sind im Kassensystem hinterlegt. Fuer neue Anbieter bitte Support-Ticket erstellen.', cat:'verkauf'},
            {q:'Wie erstelle ich eine Retoure im Kassensystem?', a:'Verkauf > Retoure > Originalbeleg scannen oder Belegnummer eingeben. Grund auswaehlen. Bei Retouren ueber 500â‚¬ ist eine Freigabe durch den Inhaber erforderlich.', cat:'allgemein'},
            {q:'Wann bekomme ich meine monatliche BWA?', a:'Die BWA wird jeweils bis zum 15. des Folgemonats vom Steuerberater bereitgestellt und ist dann im Controlling-Modul unter BWAs abrufbar.', cat:'controlling'},
            {q:'Wie aendere ich mein Marketing-Budget?', a:'Das Marketing-Budget kann jederzeit nach Absprache mit dem vit:bikes Marketing-Team angepasst werden. Aenderungen sind jeweils zum Monatsanfang des Folgemonats wirksam. Kontakt: Michael Stenzel.', cat:'marketing'},
            {q:'Was tun bei Bosch-Fehlermeldung am Display?', a:'Fehlercode notieren, im Bosch Diagnose-Tool auslesen (siehe Handbuch). Bei Codes 5xx: Software-Update durchfuehren. Bei Hardware-Fehlern (Codes 6xx/7xx): Bosch Service-Ticket im B2B-Portal.', cat:'allgemein'},
            {q:'Wie funktioniert die Vororder?', a:'Die Vororder fuer das Folgejahr wird zwischen Juli und Oktober platziert. Konditionen werden vorab mit vit:bikes Einkauf abgestimmt. Bestellungen laufen ueber die jeweiligen B2B-Portale der Hersteller.', cat:'einkauf'},
            {q:'Wie kann ich Rabatte im Kassensystem dokumentieren?', a:'Bei jedem Verkauf mit Rabatt das Feld Nachlass-Grund ausfuellen. Woechentlich die Nachlass-Auswertung pruefen. Ziel: unter 5% durchschnittlicher Nachlass.', cat:'verkauf'},
            {q:'Welche Kosten traegt vit:bikes beim Marketing?', a:'vit:bikes steuert die zentrale Kampagnenplanung, Content-Erstellung und Kanal-Optimierung bei. Das Mediabudget (z.B. 1.500â‚¬/Monat) wird vom Partner getragen.', cat:'marketing'},
            {q:'Wie buche ich einen Werkstatt-Termin ueber etermin?', a:'Kunden koennen direkt ueber die Standortseite auf vitbikes.de buchen. Intern: etermin-Backend > Neuer Termin > Kategorie Werkstatt. Zeiten sind in 30-Min-Slots konfiguriert.', cat:'allgemein'},
            {q:'Was ist der Unterschied zwischen Plan und Forecast?', a:'Der Plan wird einmal jaehrlich im Voraus erstellt (Planung_2026). Der Forecast wird monatlich angepasst basierend auf der aktuellen Entwicklung. Beide sind im Controlling-Modul sichtbar.', cat:'controlling'},
            {q:'Wie melde ich einen IT-Fehler?', a:'Im Support-Bereich ein Ticket mit Kategorie "IT" erstellen. Screenshot beifuegen. Kritische Ausfaelle (Kasse, Internet): direkt IT-Hotline anrufen unter 089/123456-99.', cat:'allgemein'},
            {q:'Wie funktioniert der Skonto bei Kalkhoff?', a:'3% Skonto bei Zahlung innerhalb von 14 Tagen. Bei Vororder-Bikes gilt das Skonto ab Rechnungsdatum, nicht ab Lieferdatum. Achtung: Skonto verfaellt bei verspaeteter Zahlung komplett.', cat:'einkauf'},
            {q:'Kann ich eigene Social-Media-Posts machen?', a:'Ja, ausdruecklich erwuenscht! Bitte den vit:bikes CI-Guide beachten (Logo-Verwendung, Farben). Organische Posts werden vom Content-Team gerne auf den zentralen Kanaelen geteilt.', cat:'marketing'},
            {q:'Wie interpretiere ich die Rohertragsmarge?', a:'Rohertrag = VK netto minus EK netto. Rohertragsmarge = Rohertrag / VK netto Ã— 100. Zielwert bei E-Bikes: 35-42%. Unter 30% sollte Ursachenanalyse erfolgen (zu viel Rabatt? falsche Modelle?).', cat:'controlling'}
        ];
        var faqFilterCat = 'all';
        function filterFaqCat(cat) {
            faqFilterCat = cat;
            document.querySelectorAll('.faq-cat-btn').forEach(function(b){ b.className='faq-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-600'; });
            var ab = document.querySelector('.faq-cat-btn[data-cat="'+cat+'"]');
            if(ab) ab.className='faq-cat-btn px-4 py-2 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderFAQ();
        }
        function filterFAQ() { renderFAQ(); }
        function renderFAQ() {
            var g = document.getElementById('faqGrid'); if(!g) return;
            var q = (document.getElementById('faqSearch')||{}).value||'';
            q = q.toLowerCase();
            var catColors = {allgemein:'bg-gray-100 text-gray-700',verkauf:'bg-blue-100 text-blue-700',marketing:'bg-orange-100 text-orange-700',einkauf:'bg-cyan-100 text-cyan-700',controlling:'bg-green-100 text-green-700'};
            var catLabels = {allgemein:'Allgemein',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',controlling:'Controlling'};
            var filtered = faqItems.filter(function(f){
                var catOk = faqFilterCat==='all' || f.cat===faqFilterCat;
                var searchOk = !q || f.q.toLowerCase().indexOf(q)>-1 || f.a.toLowerCase().indexOf(q)>-1;
                return catOk && searchOk;
            });
            var html = '';
            filtered.forEach(function(f, idx){
                var faqId = 'faq_'+faqFilterCat+'_'+idx;
                html += '<div class="vit-card overflow-hidden">' +
                    '<button onclick="toggleFaq(\''+faqId+'\')" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50">' +
                        '<div class="flex items-center space-x-3">' +
                            '<span class="px-2 py-0.5 rounded text-xs font-semibold '+catColors[f.cat]+'">'+catLabels[f.cat]+'</span>' +
                            '<span class="font-semibold text-sm text-gray-800">'+f.q+'</span>' +
                        '</div>' +
                        '<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
                    '</button>' +
                    '<div id="'+faqId+'" style="display:none" class="px-4 pb-4 border-t border-gray-100">' +
                        '<p class="text-sm text-gray-600 pt-3">'+f.a+'</p>' +
                    '</div>' +
                '</div>';
            });
            g.innerHTML = html || '<p class="text-gray-400 text-sm py-8 text-center">Keine FAQ-Eintraege gefunden.</p>';
        }
        function toggleFaq(id) {
            var el = document.getElementById(id);
            if(el) el.style.display = el.style.display==='none'?'block':'none';
        }
        renderFAQ();

        // === Dashboards Tabs ===
        var dashTabInited = false;
        function initDashboardTabs() {
            if(dashTabInited) return;
            dashTabInited = true;
            // Move contents from old separate views into tab containers
            var finSrc = document.getElementById('financesView');
            var leadSrc = document.getElementById('leadReportingView');
            var teamSrc = document.getElementById('teamView');
            var finDest = document.getElementById('dashTabFinanzen');
            var leadDest = document.getElementById('dashTabLeadreporting');
            var teamDest = document.getElementById('dashTabTeam');
            if(finSrc && finDest) { while(finSrc.firstChild) finDest.appendChild(finSrc.firstChild); }
            if(leadSrc && leadDest) { while(leadSrc.firstChild) leadDest.appendChild(leadSrc.firstChild); }
            if(teamSrc && teamDest) { while(teamSrc.firstChild) teamDest.appendChild(teamSrc.firstChild); }
        }
        function showDashboardTab(tabName) {
            initDashboardTabs();
            document.querySelectorAll('.dash-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.dash-tab-btn').forEach(function(b){
                b.className='dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {finanzen:'Finanzen',leadreporting:'Leadreporting',team:'Team'};
            var el = document.getElementById('dashTab' + (tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.dash-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
        }

        // === WISSEN TABS (kontextuell pro Modul) ===
        // Static knowledge base - can be enriched from DB (netzwerk_dokumente)
        var wissenData = {
            allgemein: {
                akademie: [
                    {title:'Onboarding: vit:bikes Partner werden',dauer:'45 min',typ:'pflicht',progress:100,desc:'Einfuehrung in Systeme, Prozesse und Ansprechpartner'},
                    {title:'Kassensystem & Warenwirtschaft',dauer:'30 min',typ:'pflicht',progress:75,desc:'Tagesabschluss, Retouren, Gutscheine, Inventur'},
                    {title:'Datenschutz & DSGVO im Handel',dauer:'20 min',typ:'pflicht',progress:0,desc:'Kundendaten, Einwilligungen, Loeschfristen'},
                    {title:'Arbeitsschutz & Ladensicherheit',dauer:'15 min',typ:'wahl',progress:0,desc:'Brandschutz, Erste Hilfe, Diebstahlpraevention'}
                ],
                handbuecher: [
                    {title:'vit:bikes Partner-Handbuch 2026',marke:'vit:bikes',typ:'PDF',seiten:64},
                    {title:'CI-Guide: Logo, Farben, Schriften',marke:'vit:bikes',typ:'PDF',seiten:12},
                    {title:'Leasing-Leitfaden (JobRad, Dienstrad, Bikeleasing)',marke:'Uebergreifend',typ:'PDF',seiten:28},
                    {title:'Garantie- & Reklamationshandbuch',marke:'vit:bikes',typ:'PDF',seiten:35}
                ],
                bestpractices: [
                    {title:'So hat Hamburg seinen Rohertrag um 4 Pp gesteigert',standort:'Hamburg',datum:'Jan 2026',tags:['Rohertrag','Rabatte']},
                    {title:'Werkstatt-Auslastung optimieren: 5 Hebel',standort:'Zentrale',datum:'Dez 2025',tags:['Werkstatt','Effizienz']},
                    {title:'Erfolgreiche Event-Formate fuer Standorte',standort:'Weilheim',datum:'Nov 2025',tags:['Events','Marketing']}
                ],
                faq: [
                    {frage:'Wie melde ich einen Garantiefall?',kat:'Prozesse'},
                    {frage:'Welche Leasing-Anbieter sind freigeschaltet?',kat:'Leasing'},
                    {frage:'Wie funktioniert die Upway-Abwicklung?',kat:'Einkauf'},
                    {frage:'Wer ist mein Ansprechpartner bei IT-Problemen?',kat:'IT/Support'},
                    {frage:'Wie laeuft die Monatsabrechnung?',kat:'Buchhaltung'}
                ]
            },
            marketing: {
                akademie: [
                    {title:'Social Media fuer Fahrradhaendler',dauer:'60 min',typ:'pflicht',progress:50,desc:'Instagram, Facebook, TikTok: Content-Strategie fuer lokale Reichweite'},
                    {title:'Google My Business optimieren',dauer:'25 min',typ:'pflicht',progress:100,desc:'Profil pflegen, Rezensionen beantworten, Beitraege posten'},
                    {title:'Individuelle Ads erstellen (Meta)',dauer:'40 min',typ:'wahl',progress:30,desc:'Reels drehen, Texte schreiben, Zielgruppen definieren'},
                    {title:'Event-Marketing: Testival planen',dauer:'35 min',typ:'wahl',progress:0,desc:'Checkliste, Zeitplan, Bewerbung, Nachbereitung'}
                ],
                handbuecher: [
                    {title:'vit:bikes Content-Styleguide',marke:'vit:bikes',typ:'PDF',seiten:18},
                    {title:'Meta Ads Manager â€“ Schritt fuer Schritt',marke:'Meta',typ:'PDF',seiten:24},
                    {title:'Google Ads fuer lokale Haendler',marke:'Google',typ:'PDF',seiten:20},
                    {title:'Etermin: Terminbuchung einrichten',marke:'Etermin',typ:'PDF',seiten:8}
                ],
                bestpractices: [
                    {title:'Individuelle Ads: 3x bessere CTR als generische',standort:'Zentrale',datum:'Feb 2026',tags:['Ads','Performance']},
                    {title:'Wie Weilheim 91% Storevisit-Ziel erreicht',standort:'Weilheim',datum:'Jan 2026',tags:['Storevisits','Meta']},
                    {title:'Influencer-Kooperation: So funktioniert es',standort:'Muenchen Ost',datum:'Dez 2025',tags:['Influencer','Content']}
                ],
                faq: [
                    {frage:'Wie kann ich mein Marketing-Budget aendern?',kat:'Budget'},
                    {frage:'Wann werden neue Ads geschaltet?',kat:'Ads'},
                    {frage:'Kann ich eigene Stories auf dem vit:bikes Kanal posten?',kat:'Content'},
                    {frage:'Wie messe ich den Erfolg meiner Kampagnen?',kat:'Analytics'},
                    {frage:'Was kostet ein lokales Event?',kat:'Events'}
                ]
            },
            einkauf: {
                akademie: [
                    {title:'Einkaufsstrategie verstehen & umsetzen',dauer:'45 min',typ:'pflicht',progress:60,desc:'Vororder, Blockorder, Konditionen, Rabattsteuerung'},
                    {title:'Rohertrag optimieren: Praxis-Workshop',dauer:'50 min',typ:'pflicht',progress:25,desc:'DB1 berechnen, Dreingaben vs. Rabatte, Nachlass-Tracking'},
                    {title:'B2B-Portale der Lieferanten nutzen',dauer:'30 min',typ:'wahl',progress:0,desc:'Kalkhoff, Shimano, Orbea: Bestellprozesse und Retouren'},
                    {title:'Lagerbestand & Umschlag steuern',dauer:'25 min',typ:'wahl',progress:0,desc:'Ladenhuter erkennen, Saisonplanung, Abverkaufsstrategien'}
                ],
                handbuecher: [
                    {title:'Kalkhoff/Derby Cycle â€“ Haendlerportal Guide',marke:'Kalkhoff',typ:'PDF',seiten:16},
                    {title:'Shimano Steps â€“ Fehlercodes & Diagnose',marke:'Shimano',typ:'PDF',seiten:42},
                    {title:'Bosch Smart System â€“ Einrichtung & Updates',marke:'Bosch',typ:'PDF',seiten:38},
                    {title:'Haibike Modellueberblick 2026',marke:'Haibike',typ:'PDF',seiten:22},
                    {title:'Orbea MyO Konfigurator â€“ Haendler-Anleitung',marke:'Orbea',typ:'PDF',seiten:14}
                ],
                bestpractices: [
                    {title:'Sqlab-Sattel statt Rabatt: 50% weniger DB-Verlust',standort:'Zentrale',datum:'Sep 2025',tags:['Rohertrag','Dreingaben']},
                    {title:'Kalkhoff 7er-Modelle ueber Upway: So gehts',standort:'Grafrath',datum:'Okt 2025',tags:['Upway','Abverkauf']},
                    {title:'Haibike Blockorder: Verhandlungstipps',standort:'Zentrale',datum:'Aug 2025',tags:['Haibike','Konditionen']}
                ],
                faq: [
                    {frage:'Wie platziere ich eine Nachbestellung?',kat:'Bestellung'},
                    {frage:'Was tun bei Lieferverzoegerung?',kat:'Logistik'},
                    {frage:'Wie funktioniert die Garantieabwicklung pro Marke?',kat:'Garantie'},
                    {frage:'Kann ich Konditionen individuell verhandeln?',kat:'Konditionen'},
                    {frage:'Wie melde ich defekte Ware / Transportschaden?',kat:'Reklamation'}
                ]
            },
            controlling: {
                akademie: [
                    {title:'BWA lesen & verstehen',dauer:'40 min',typ:'pflicht',progress:80,desc:'Umsatzerloese, Wareneinsatz, Rohertrag, Betriebsergebnis'},
                    {title:'Plan/Ist-Vergleich nutzen',dauer:'30 min',typ:'pflicht',progress:40,desc:'Abweichungen erkennen, Massnahmen ableiten, Prognosen'},
                    {title:'Liquiditaetsplanung Basics',dauer:'25 min',typ:'wahl',progress:0,desc:'Cashflow verstehen, Engpaesse vermeiden, Vorausplanung'},
                    {title:'Benchmarking im vit:bikes Netzwerk',dauer:'20 min',typ:'wahl',progress:10,desc:'Eigene Kennzahlen vs. Netzwerk, Potentiale erkennen'}
                ],
                handbuecher: [
                    {title:'BWA-Positionen: Was steckt hinter jeder Zeile',marke:'vit:bikes',typ:'PDF',seiten:20},
                    {title:'Steuerliche Grundlagen fuer Fahrradhaendler',marke:'Uebergreifend',typ:'PDF',seiten:32},
                    {title:'DATEV-Schnittstelle: Belege digital einreichen',marke:'DATEV',typ:'PDF',seiten:12},
                    {title:'Investitionsplanung & AfA im Fahrradhandel',marke:'vit:bikes',typ:'PDF',seiten:16}
                ],
                bestpractices: [
                    {title:'Werbekosten im Griff: 5% vom Umsatz als Faustregel',standort:'Zentrale',datum:'Jan 2026',tags:['Marketing-Budget','Planung']},
                    {title:'Personalkosten-Quote senken ohne Kuerzungen',standort:'Hamburg',datum:'Nov 2025',tags:['Personal','Effizienz']},
                    {title:'Saisonale Liquiditaetsplanung: Vorsaison richtig finanzieren',standort:'Zentrale',datum:'Okt 2025',tags:['Liquiditaet','Cashflow']}
                ],
                faq: [
                    {frage:'Wann erhalte ich meine monatliche BWA?',kat:'BWA'},
                    {frage:'Wie ist die Ziel-Rohertragsmarge?',kat:'Kennzahlen'},
                    {frage:'Wer ist fuer die Buchhaltung zustaendig?',kat:'Prozesse'},
                    {frage:'Wie beantrage ich eine Investition?',kat:'Investition'},
                    {frage:'Was bedeuten die Benchmark-Ampelfarben?',kat:'Benchmark'}
                ]
            },
            verkauf: {
                akademie: [
                    {title:'Verkaufsgespraech E-Bike: Beratungsleitfaden',dauer:'60 min',typ:'pflicht',progress:65,desc:'Bedarfsanalyse, Probefahrt, Abschluss, Finanzierung'},
                    {title:'Ergonomie-Beratung: Sitzposition & Rahmengroesse',dauer:'45 min',typ:'pflicht',progress:90,desc:'Vermessung, Sattel, Lenker, Vorbau â€“ der Unterschied'},
                    {title:'Leasing richtig erklaeren (JobRad & Co.)',dauer:'30 min',typ:'pflicht',progress:40,desc:'Steuervorteile, Ablauf, Arbeitgeber-Ansprache, Rechner'},
                    {title:'Einwaende souveraen behandeln',dauer:'35 min',typ:'wahl',progress:15,desc:'Preis, Online-Vergleich, Lieferzeit â€“ die Top-5 Einwaende'},
                    {title:'Zusatzverkauf: Zubehoer & Service-Pakete',dauer:'20 min',typ:'wahl',progress:0,desc:'Helme, Schloesser, Sqlab, Versicherung, Inspektion'}
                ],
                handbuecher: [
                    {title:'Beratungsbogen / Setting-Tool Anleitung',marke:'vit:bikes',typ:'PDF',seiten:8},
                    {title:'Finanzierungsrechner: So nutzt du den Kalkulator',marke:'vit:bikes',typ:'PDF',seiten:6},
                    {title:'Probefahrt-Protokoll & Haftung',marke:'vit:bikes',typ:'PDF',seiten:4},
                    {title:'E-Bike Kategorie-Guide: Trekking vs. MTB vs. City',marke:'Uebergreifend',typ:'PDF',seiten:18}
                ],
                bestpractices: [
                    {title:'Pipeline-Management: Kein Lead geht verloren',standort:'Karlsdorf-Neuth.',datum:'Feb 2026',tags:['Pipeline','Follow-up']},
                    {title:'Orbea & Simplon aktiv verkaufen: Verkaeufermotivation',standort:'Grafrath',datum:'Sep 2025',tags:['Beratung','Rohertrag']},
                    {title:'Testival als Verkaufs-Booster: 23 Abschluesse an einem Tag',standort:'Weilheim',datum:'Mai 2025',tags:['Events','Abschluss']}
                ],
                faq: [
                    {frage:'Wie viel Rabatt darf ich maximal geben?',kat:'Konditionen'},
                    {frage:'Wie trage ich einen Verkauf in die Pipeline ein?',kat:'Pipeline'},
                    {frage:'Was mache ich bei einer Stornierung?',kat:'Prozesse'},
                    {frage:'Wie funktioniert die Uebergabe an den Kunden?',kat:'Uebergabe'},
                    {frage:'Wann wird die Wochenauswertung aktualisiert?',kat:'Reporting'}
                ]
            }
        };

        function renderWissenTab(bereich, containerId) {
            var d = wissenData[bereich];
            if(!d) return;
            var el = document.getElementById(containerId);
            if(!el || el.dataset.rendered) return;
            el.dataset.rendered = 'true';
            var h = '';

            // Sub-Tab Navigation
            h += '<div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1">';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'akademie\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md bg-white shadow text-vit-orange" data-sub="akademie">ðŸŽ“ Akademie</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'handbuecher\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="handbuecher">ðŸ“– Handbuecher</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'bestpractices\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="bestpractices">ðŸ’¡ Best Practices</button>';
            h += '<button onclick="switchWissenSub(\''+containerId+'\',\'faq\')" class="wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white" data-sub="faq">â“ FAQ</button>';
            h += '</div>';

            // Akademie
            h += '<div id="'+containerId+'_akademie" class="wissen-section-'+containerId+'">';
            h += '<div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-gray-800">ðŸŽ“ Schulungen & Kurse</h3><span class="text-xs text-gray-400">'+d.akademie.filter(function(k){return k.progress===100;}).length+' / '+d.akademie.length+' abgeschlossen</span></div>';
            d.akademie.forEach(function(k) {
                var pColor = k.progress===100?'bg-green-500':k.progress>0?'bg-vit-orange':'bg-gray-300';
                var badge = k.typ==='pflicht'?'<span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">Pflicht</span>':'<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-bold">Wahl</span>';
                h += '<div class="vit-card p-4 mb-3 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="font-semibold text-sm">'+k.title+'</span>'+badge+'</div><span class="text-xs text-gray-400">'+k.dauer+'</span></div>';
                h += '<p class="text-xs text-gray-500 mb-2">'+k.desc+'</p>';
                h += '<div class="flex items-center space-x-3"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div><span class="text-xs font-bold '+(k.progress===100?'text-green-600':'text-gray-500')+'">'+k.progress+'%</span></div>';
                h += '</div>';
            });
            h += '</div>';

            // Handbuecher
            h += '<div id="'+containerId+'_handbuecher" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">ðŸ“– Technische Dokus & Marken-Guides</h3>';
            h += '<div class="space-y-2">';
            d.handbuecher.forEach(function(doc) {
                h += '<div class="vit-card p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer">';
                h += '<div class="flex items-center space-x-3"><div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-red-600 text-xs font-bold">PDF</div>';
                h += '<div><p class="text-sm font-semibold">'+doc.title+'</p><p class="text-xs text-gray-400">'+doc.marke+' Â· '+doc.seiten+' Seiten</p></div></div>';
                h += '<button class="px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded-lg hover:bg-gray-50">Oeffnen</button>';
                h += '</div>';
            });
            h += '</div></div>';

            // Best Practices
            h += '<div id="'+containerId+'_bestpractices" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">ðŸ’¡ Best Practices aus dem Netzwerk</h3>';
            d.bestpractices.forEach(function(bp) {
                h += '<div class="vit-card p-5 mb-3 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-2"><span class="font-semibold text-sm">'+bp.title+'</span><span class="text-xs text-gray-400">'+bp.datum+'</span></div>';
                h += '<div class="flex items-center space-x-2"><span class="text-xs text-gray-500">ðŸ“ '+bp.standort+'</span>';
                bp.tags.forEach(function(t){ h += '<span class="text-[10px] px-2 py-0.5 bg-blue-50 text-blue-600 rounded-full">'+t+'</span>'; });
                h += '</div></div>';
            });
            h += '</div>';

            // FAQ
            h += '<div id="'+containerId+'_faq" class="wissen-section-'+containerId+'" style="display:none;">';
            h += '<h3 class="font-semibold text-gray-800 mb-4">â“ Haeufige Fragen</h3>';
            h += '<div class="space-y-2">';
            d.faq.forEach(function(f,i) {
                h += '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="this.querySelector(\'.faq-answer\').style.display=this.querySelector(\'.faq-answer\').style.display===\'none\'?\'block\':\'none\'">';
                h += '<div class="flex items-center justify-between"><span class="text-sm font-semibold">'+f.frage+'</span><span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">'+f.kat+'</span></div>';
                h += '<div class="faq-answer text-xs text-gray-500 mt-2" style="display:none;">Antwort wird geladen... (Im echten Produkt: vollstaendige Antwort aus der Wissensdatenbank)</div>';
                h += '</div>';
            });
            h += '</div></div>';

            el.innerHTML = h;
        }

        function switchWissenSub(containerId, sub) {
            document.querySelectorAll('.wissen-section-'+containerId).forEach(function(s){ s.style.display='none'; });
            var target = document.getElementById(containerId+'_'+sub);
            if(target) target.style.display='block';
            document.querySelectorAll('.wissen-sub-'+containerId).forEach(function(b){
                b.className='wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md text-gray-500 hover:bg-white';
            });
            var btn = document.querySelector('.wissen-sub-'+containerId+'[data-sub="'+sub+'"]');
            if(btn) btn.className='wissen-sub-'+containerId+' flex-1 px-3 py-2 text-xs font-semibold rounded-md bg-white shadow text-vit-orange';
        }

        // === GLOBAL WISSEN VIEW ===
        var currentWissenBereich = 'all';
        var currentWissenTyp = 'akademie';

        function renderWissenGlobal() {
            var bereiche = ['allgemein','verkauf','einkauf','marketing','controlling'];
            var bereichLabels = {allgemein:'Allgemein',verkauf:'Verkauf',einkauf:'Einkauf',marketing:'Marketing',controlling:'Controlling'};
            var bereichIcons = {allgemein:'ðŸ¢',verkauf:'ðŸ’°',einkauf:'ðŸ›’',marketing:'ðŸ“£',controlling:'ðŸ“Š'};

            // Aggregate all items
            var allAkademie=[],allHandbuecher=[],allBp=[],allFaq=[];
            bereiche.forEach(function(b){
                var d=wissenData[b]; if(!d)return;
                (d.akademie||[]).forEach(function(i){i._bereich=b;allAkademie.push(i);});
                (d.handbuecher||[]).forEach(function(i){i._bereich=b;allHandbuecher.push(i);});
                (d.bestPractices||[]).forEach(function(i){i._bereich=b;allBp.push(i);});
                (d.faq||[]).forEach(function(i){i._bereich=b;allFaq.push(i);});
            });

            // KPIs
            var totalKurse=allAkademie.length;
            var doneKurse=allAkademie.filter(function(k){return k.progress===100;}).length;
            var pflichtOffen=allAkademie.filter(function(k){return k.typ==='pflicht'&&k.progress<100;}).length;
            var kpi=document.getElementById('wissenKpis');
            if(kpi) kpi.innerHTML=
                '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+totalKurse+'</p><p class="text-xs text-gray-500">Schulungen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+doneKurse+'</p><p class="text-xs text-gray-500">Abgeschlossen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold '+(pflichtOffen>0?'text-red-500':'text-green-600')+'">'+pflichtOffen+'</p><p class="text-xs text-gray-500">Pflicht offen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+allHandbuecher.length+'</p><p class="text-xs text-gray-500">Handbuecher</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+allFaq.length+'</p><p class="text-xs text-gray-500">FAQs</p></div>';

            // Determine which list to show
            var items=[];
            if(currentWissenTyp==='akademie') items=allAkademie;
            else if(currentWissenTyp==='handbuecher') items=allHandbuecher;
            else if(currentWissenTyp==='bestpractices') items=allBp;
            else if(currentWissenTyp==='faq') items=allFaq;

            // Filter by bereich
            if(currentWissenBereich!=='all') items=items.filter(function(i){return i._bereich===currentWissenBereich;});

            // Search
            var search=(document.getElementById('wissenSearch')||{}).value||'';
            if(search) {
                var s=search.toLowerCase();
                items=items.filter(function(i){return (i.title||i.frage||'').toLowerCase().indexOf(s)>-1 || (i.desc||i.antwort||'').toLowerCase().indexOf(s)>-1;});
            }

            var el=document.getElementById('wissenGlobalContent');
            if(!el) return;
            var h='';

            if(currentWissenTyp==='akademie'){
                items.forEach(function(k){
                    var pColor=k.progress===100?'bg-green-500':k.progress>0?'bg-vit-orange':'bg-gray-300';
                    var badge=k.typ==='pflicht'?'<span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-full font-bold">Pflicht</span>':'<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-bold">Wahl</span>';
                    h+='<div class="vit-card p-4 hover:shadow-md transition"><div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[k._bereich]+' '+bereichLabels[k._bereich]+'</span><span class="font-semibold text-sm">'+k.title+'</span>'+badge+'</div><span class="text-xs text-gray-400">'+k.dauer+'</span></div><p class="text-xs text-gray-500 mb-2">'+k.desc+'</p><div class="flex items-center space-x-3"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="'+pColor+' h-2 rounded-full" style="width:'+k.progress+'%"></div></div><span class="text-xs font-bold '+(k.progress===100?'text-green-600':'text-gray-500')+'">'+k.progress+'%</span></div></div>';
                });
            } else if(currentWissenTyp==='handbuecher'){
                items.forEach(function(b){
                    h+='<div class="vit-card p-4 hover:shadow-md transition flex items-center space-x-4"><div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-xs">PDF</div><div class="flex-1"><div class="flex items-center space-x-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[b._bereich]+' '+bereichLabels[b._bereich]+'</span><span class="font-semibold text-sm">'+b.title+'</span></div><p class="text-xs text-gray-400 mt-1">'+(b.pages||'â€”')+' Â· '+(b.updated||'')+'</p></div><button class="text-vit-orange hover:text-orange-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></button></div>';
                });
            } else if(currentWissenTyp==='bestpractices'){
                items.forEach(function(bp){
                    h+='<div class="vit-card p-4 hover:shadow-md transition"><div class="flex items-center space-x-2 mb-2"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[bp._bereich]+' '+bereichLabels[bp._bereich]+'</span><span class="font-semibold text-sm">'+bp.title+'</span></div><p class="text-xs text-gray-500">'+(bp.desc||bp.content||'')+'</p></div>';
                });
            } else if(currentWissenTyp==='faq'){
                items.forEach(function(fq,i){
                    h+='<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="var fa=this.querySelector(\'.faq-a\');fa.style.display=fa.style.display===\'none\'?\'block\':\'none\'"><div class="flex items-center space-x-2 mb-1"><span class="text-xs px-2 py-0.5 bg-gray-100 rounded-full">'+bereichIcons[fq._bereich]+'</span><span class="font-semibold text-sm">'+fq.frage+'</span></div><div class="faq-a text-xs text-gray-500 mt-2" style="display:none;">'+fq.antwort+'</div></div>';
                });
            }

            if(!h) h='<div class="text-center text-gray-400 py-8"><p class="text-lg mb-2">ðŸ”</p><p class="text-sm">Keine Eintraege gefunden.</p></div>';
            el.innerHTML=h;
        }

        function filterWissenBereich(b){
            currentWissenBereich=b;
            document.querySelectorAll('.wissen-bereich-filter').forEach(function(btn){btn.className='wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.wissen-bereich-filter[data-wbf="'+b+'"]');
            if(btn) btn.className='wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderWissenGlobal();
        }
        function switchWissenTyp(t){
            currentWissenTyp=t;
            document.querySelectorAll('.wissen-typ-btn').forEach(function(btn){btn.className='wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';});
            var btn=document.querySelector('.wissen-typ-btn[data-wtt="'+t+'"]');
            if(btn) btn.className='wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            renderWissenGlobal();
        }
        function filterWissenGlobal(){ renderWissenGlobal(); }

        // Hook wissen rendering into tab switches
        var origShowAllgemeinTab = showAllgemeinTab;
        showAllgemeinTab = function(t) { origShowAllgemeinTab(t); if(t==='wissen') renderWissenTab('allgemein','allgTabWissen'); };

        var origShowMarketingTab = showMarketingTab;
        showMarketingTab = function(t) { origShowMarketingTab(t); if(t==='mktWissen') renderWissenTab('marketing','marketingTabMktWissen'); };

        var origShowEinkaufTab = showEinkaufTab;
        showEinkaufTab = function(t) { origShowEinkaufTab(t); if(t==='ekWissen') renderWissenTab('einkauf','ekTabEkWissen'); };


        var origShowVerkaufTab = showVerkaufTab;
        var ausLoaded = false;
        var vtLoaded = false;
        showVerkaufTab = function(t) { origShowVerkaufTab(t); if(t==='vkWissen') renderWissenTab('verkauf','vkTabVkWissen'); if(t==='auswertung' && !ausLoaded) { ausLoaded=true; loadAuswertung(); } if(t==='woche' && !vtLoaded) { vtLoaded=true; loadVerkaufTracking(); } if(t==='training') initTrainingModule(); };

        // === SUPPORT MODULE ===
        async function renderTickets(filter) {
            var container = document.getElementById('ticketList');
            if(!container) return;
            try {
                var query = sb.from('support_tickets').select('*, users(name)').order('created_at', {ascending:false});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                if(filter==='offen') query = query.in('status', ['offen','in_bearbeitung']);
                if(filter==='geloest') query = query.eq('status', 'geloest');
                var resp = await query;
                if(resp.error) throw resp.error;
                var tickets = resp.data || [];
                var html = '';
                var statusColors = {offen:'bg-yellow-100 text-yellow-700',in_bearbeitung:'bg-blue-100 text-blue-700',warten:'bg-gray-100 text-gray-700',geloest:'bg-green-100 text-green-700'};
                var statusLabels = {offen:'Offen',in_bearbeitung:'In Bearbeitung',warten:'Wartend',geloest:'Gel\u00f6st'};
                var prioIcons = {dringend:'\uD83D\uDD34',hoch:'\uD83D\uDFE0',mittel:'\uD83D\uDFE1',niedrig:'\u26AA'};
                tickets.forEach(function(t) {
                    var d = new Date(t.created_at);
                    var desc = (t.beschreibung||'').length > 120 ? t.beschreibung.substring(0,120)+'...' : (t.beschreibung||'');
                    html += '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="openTicketDetail(\''+t.id+'\')">';
                    html += '<div class="flex items-start justify-between">';
                    html += '<div class="flex-1"><div class="flex items-center space-x-2 mb-1">';
                    html += '<span class="text-xs font-semibold rounded px-2 py-0.5 ' + (statusColors[t.status]||'') + '">' + (statusLabels[t.status]||t.status) + '</span>';
                    html += '<span>' + (prioIcons[t.prioritaet]||'') + '</span>';
                    html += '<span class="text-xs text-gray-400">#' + t.id.substring(0,8) + '</span></div>';
                    html += '<h4 class="font-bold text-gray-800 text-sm">' + t.titel + '</h4>';
                    html += '<p class="text-xs text-gray-500 mt-1">' + desc + '</p>';
                    html += '<div class="flex items-center space-x-3 mt-2 text-xs text-gray-400">';
                    html += '<span>' + d.toLocaleDateString('de-DE') + '</span>';
                    html += '<span>' + (t.kategorie||'') + '</span>';
                    if(t.users && t.users.name) html += '<span>\uD83D\uDC64 '+t.users.name+'</span>';
                    html += '</div></div>';
                    html += '<span class="text-gray-300 text-lg ml-2">\u203A</span>';
                    html += '</div></div>';
                });
                if(tickets.length===0) html = '<div class="text-center py-8 text-gray-400">Keine Tickets in dieser Kategorie.</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Support:', err); container.innerHTML='<div class="text-center py-8 text-red-400">Fehler beim Laden der Tickets.</div>'; }
        }

        async function openTicketDetail(ticketId) {
            try {
                var tResp = await sb.from('support_tickets').select('*, users(name)').eq('id', ticketId).single();
                if(tResp.error) throw tResp.error;
                var t = tResp.data;
                var cResp = await sb.from('ticket_kommentare').select('*, users(name)').eq('ticket_id', ticketId).order('created_at', {ascending:true});
                var kommentare = (cResp.data || []);

                var statusLabels = {offen:'Offen',in_bearbeitung:'In Bearbeitung',warten:'Wartend',geloest:'Gel\u00f6st'};
                var statusColors = {offen:'bg-yellow-100 text-yellow-700',in_bearbeitung:'bg-blue-100 text-blue-700',warten:'bg-gray-100 text-gray-700',geloest:'bg-green-100 text-green-700'};
                var prioIcons = {dringend:'\uD83D\uDD34',hoch:'\uD83D\uDFE0',mittel:'\uD83D\uDFE1',niedrig:'\u26AA'};
                var d = new Date(t.created_at);
                var isHQ = sbProfile && sbProfile.is_hq;

                var html = '<div id="ticketDetailOverlay" onclick="closeTicketDetail()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
                html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:0;width:640px;max-width:95vw;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;">';

                // Header
                html += '<div class="p-5 border-b border-gray-100">';
                html += '<div class="flex items-center justify-between mb-3">';
                html += '<div class="flex items-center space-x-2"><span class="text-xs font-semibold rounded px-2 py-0.5 '+(statusColors[t.status]||'')+'">'+(statusLabels[t.status]||t.status)+'</span>';
                html += '<span>'+(prioIcons[t.prioritaet]||'')+'</span>';
                html += '<span class="text-xs text-gray-400">#'+t.id.substring(0,8)+'</span></div>';
                html += '<button onclick="closeTicketDetail()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
                html += '<h3 class="font-bold text-gray-800 text-lg">'+t.titel+'</h3>';
                html += '<div class="flex items-center space-x-4 mt-2 text-xs text-gray-400">';
                html += '<span>Erstellt: '+d.toLocaleDateString('de-DE')+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})+'</span>';
                html += '<span>Kategorie: '+(t.kategorie||'')+'</span>';
                if(t.users&&t.users.name) html += '<span>Von: '+t.users.name+'</span>';
                html += '</div></div>';

                // Body
                html += '<div class="flex-1 overflow-y-auto p-5">';
                html += '<div class="bg-gray-50 rounded-lg p-4 mb-4"><p class="text-sm text-gray-700 whitespace-pre-wrap">'+(t.beschreibung||'Keine Beschreibung.')+'</p></div>';

                // Status change (HQ can change, user can close)
                html += '<div class="mb-4 p-3 bg-blue-50 rounded-lg flex items-center justify-between">';
                html += '<span class="text-xs font-semibold text-blue-700">'+t('ticket_change_status')+':</span>';
                html += '<div class="flex space-x-1">';
                if(isHQ) {
                    ['offen','in_bearbeitung','warten','geloest'].forEach(function(st) {
                        var active = t.status===st;
                        html += '<button onclick="changeTicketStatus(\''+ticketId+'\',\''+st+'\')" class="text-xs px-2.5 py-1 rounded-full font-semibold '+(active?'bg-vit-orange text-white':'bg-white text-gray-600 border border-gray-200 hover:bg-gray-100')+'">'+(statusLabels[st])+'</button>';
                    });
                } else {
                    if(t.status!=='geloest') html += '<button onclick="changeTicketStatus(\''+ticketId+'\',\'geloest\')" class="text-xs px-3 py-1 rounded-full font-semibold bg-green-500 text-white hover:bg-green-600">'+t('ticket_mark_resolved')+'</button>';
                    else html += '<span class="text-xs text-green-600 font-semibold">\u2705 Gel\u00f6st</span>';
                }
                html += '</div></div>';

                // Kommentare
                html += '<h4 class="font-semibold text-gray-700 text-sm mb-3">'+t('ticket_comments')+' ('+kommentare.length+')</h4>';
                if(kommentare.length === 0) html += '<p class="text-sm text-gray-400 mb-4">Noch keine Kommentare.</p>';
                kommentare.forEach(function(k) {
                    var kd = new Date(k.created_at);
                    var isOwn = sbUser && k.erstellt_von === sbUser.id;
                    html += '<div class="mb-3 p-3 rounded-lg '+(isOwn?'bg-orange-50 border border-orange-100':'bg-gray-50 border border-gray-100')+'">';
                    html += '<div class="flex items-center justify-between mb-1"><span class="text-xs font-bold text-gray-700">'+(k.users&&k.users.name?k.users.name:'Unbekannt')+'</span>';
                    html += '<span class="text-[10px] text-gray-400">'+kd.toLocaleDateString('de-DE')+' '+kd.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})+'</span></div>';
                    html += '<p class="text-sm text-gray-600 whitespace-pre-wrap">'+k.text+'</p></div>';
                });

                // Neuer Kommentar
                html += '<div class="mt-3 flex space-x-2">';
                html += '<textarea id="ticketKommentarInput" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm resize-none" rows="2" placeholder="'+t('ticket_comment_ph')+'"></textarea>';
                html += '<button onclick="addTicketComment(\''+ticketId+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 self-end">'+t('ticket_comment_send')+'</button>';
                html += '</div>';

                html += '</div></div></div>';
                var c = document.createElement('div'); c.id = 'ticketDetailContainer'; c.innerHTML = html; document.body.appendChild(c);
            } catch(err) { console.error('Ticket detail:', err); alert('Fehler beim Laden des Tickets.'); }
        }

        function closeTicketDetail() { var c = document.getElementById('ticketDetailContainer'); if(c) c.remove(); }

        async function changeTicketStatus(ticketId, newStatus) {
            try {
                var resp = await sb.from('support_tickets').update({status:newStatus, updated_at:new Date().toISOString()}).eq('id',ticketId);
                if(resp.error) throw resp.error;
                closeTicketDetail();
                await openTicketDetail(ticketId);
                renderTickets('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function addTicketComment(ticketId) {
            var input = document.getElementById('ticketKommentarInput');
            if(!input || !input.value.trim()) return;
            try {
                var resp = await sb.from('ticket_kommentare').insert({
                    ticket_id:ticketId, erstellt_von:sbUser?sbUser.id:null, text:input.value.trim()
                });
                if(resp.error) throw resp.error;
                closeTicketDetail();
                await openTicketDetail(ticketId);
            } catch(err) { alert('Fehler: '+err.message); }
        }

        function filterTickets(filter) {
            document.querySelectorAll('.ticket-filter').forEach(function(b){b.className='ticket-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.ticket-filter[data-f="'+filter+'"]');
            if(btn) btn.className='ticket-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderTickets(filter);
        }

        async function sendTicket() {
            var title = document.getElementById('ticketTitle');
            var desc = document.getElementById('ticketDesc');
            var cat = document.getElementById('ticketCat');
            if(!title || !title.value.trim()) return;
            try {
                await sb.from('support_tickets').insert({standort_id: sbStandort?sbStandort.id:null, erstellt_von:sbUser.id, titel:title.value.trim(), beschreibung:(desc?desc.value:''), kategorie:(cat?cat.value:'allgemein'), prioritaet:'mittel'});
                if(title) title.value=''; if(desc) desc.value='';
                var form=document.getElementById('newTicketForm'); if(form) form.classList.add('hidden');
                renderTickets('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        async function submitTicketForm() {
            var titel = (document.getElementById('ticketTitelInput')||{}).value;
            var beschreibung = (document.getElementById('ticketBeschreibungInput')||{}).value;
            var kategorie = (document.getElementById('ticketCatInput')||{}).value || 'allgemein';
            var prioritaet = (document.getElementById('ticketPrioInput')||{}).value || 'mittel';
            if(!titel || !titel.trim()) { alert('Bitte Betreff eingeben.'); return; }
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var resp = await sb.from('support_tickets').insert({
                    standort_id: stdId, erstellt_von: sbUser ? sbUser.id : null,
                    titel: titel.trim(), beschreibung: beschreibung || '',
                    kategorie: kategorie, prioritaet: prioritaet, status: 'offen'
                });
                if(resp.error) throw resp.error;
                document.getElementById('ticketCreate').classList.add('hidden');
                document.getElementById('ticketTitelInput').value = '';
                document.getElementById('ticketBeschreibungInput').value = '';
                alert('\u2705 Ticket erstellt!');
                renderTickets('all');
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        var zentraleKontakte = [
            {name:'Sascha Matthies',rolle:'Geschaeftsfuehrung',bereich:'GF',tel:'+49 170 1234567',email:'sascha@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 9-18 Uhr',schwerpunkt:'Strategie, Partnerschaften, Finanzen'},
            {name:'Florian Meier',rolle:'Einkauf & Sortiment',bereich:'Einkauf',tel:'+49 170 2345678',email:'florian@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 8-17 Uhr',schwerpunkt:'Vororder, Konditionen, Lieferanten, Sortiment'},
            {name:'Michael Stenzel',rolle:'Marketing & Performance',bereich:'Marketing',tel:'+49 170 3456789',email:'michael@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 9-18 Uhr',schwerpunkt:'Ads, Content, Events, Jahresgespraeche'},
            {name:'Tim Schaefer',rolle:'IT & Systeme',bereich:'IT',tel:'+49 170 4567890',email:'tim@vitbikes.de',verfuegbar:false,zeiten:'Mo-Fr 8-16 Uhr',schwerpunkt:'Kassensystem, B2B-Portale, Etermin, Netzwerk'},
            {name:'Laura Hofmann',rolle:'Buchhaltung & Controlling',bereich:'Buchhaltung',tel:'+49 170 5678901',email:'laura@vitbikes.de',verfuegbar:true,zeiten:'Mo-Do 8-16, Fr 8-14 Uhr',schwerpunkt:'BWA, Monatsabschluss, Rechnungen, DATEV'},
            {name:'Jonas Becker',rolle:'Werkstatt-Support & Schulung',bereich:'Werkstatt',tel:'+49 170 6789012',email:'jonas@vitbikes.de',verfuegbar:true,zeiten:'Mo-Fr 7-16 Uhr',schwerpunkt:'Shimano, Bosch, Diagnose, Technik-Schulungen'}
        ];

        function showSupportTab(tabName) {
            document.querySelectorAll('.sup-tab-content').forEach(function(c){ c.style.display='none'; });
            document.querySelectorAll('.sup-tab-btn').forEach(function(b){
                b.className='sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabMap = {tickets:'Tickets',kontakte:'Kontakte'};
            var el = document.getElementById('supTab'+(tabMap[tabName]||''));
            if(el) el.style.display='block';
            var btn = document.querySelector('.sup-tab-btn[data-tab="'+tabName+'"]');
            if(btn) btn.className='sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='tickets') renderTickets('all');
            if(tabName==='kontakte') renderKontakte();
        }

        function renderKontakte() {
            var grid = document.getElementById('kontakteGrid');
            if(!grid || grid.dataset.rendered) return;
            grid.dataset.rendered = 'true';
            var bereichColors = {'GF':'bg-purple-500','Einkauf':'bg-blue-500','Marketing':'bg-orange-500','IT':'bg-gray-600','Buchhaltung':'bg-green-600','Werkstatt':'bg-red-500'};
            var h = '';
            zentraleKontakte.forEach(function(k) {
                var col = bereichColors[k.bereich]||'bg-gray-500';
                var initials = k.name.split(' ').map(function(w){return w[0];}).join('');
                h += '<div class="vit-card p-5 hover:shadow-md transition">';
                h += '<div class="flex items-center space-x-3 mb-4">';
                h += '<div class="w-14 h-14 '+col+' rounded-full flex items-center justify-center text-white font-bold text-lg">'+initials+'</div>';
                h += '<div>';
                h += '<p class="font-semibold text-gray-800">'+k.name+'</p>';
                h += '<p class="text-xs text-gray-500">'+k.rolle+'</p>';
                h += '<span class="inline-flex items-center mt-1 '+(k.verfuegbar?'text-green-600':'text-gray-400')+' text-xs">';
                h += '<span class="w-2 h-2 rounded-full '+(k.verfuegbar?'bg-green-500':'bg-gray-300')+' mr-1"></span>';
                h += (k.verfuegbar?'Verfuegbar':'Nicht verfuegbar');
                h += '</span>';
                h += '</div></div>';
                h += '<div class="space-y-2 mb-4">';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">ðŸ“ž</span><a href="tel:'+k.tel+'" class="text-gray-700 hover:text-vit-orange">'+k.tel+'</a></div>';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">âœ‰ï¸</span><a href="mailto:'+k.email+'" class="text-gray-700 hover:text-vit-orange">'+k.email+'</a></div>';
                h += '<div class="flex items-center space-x-2 text-sm"><span class="text-gray-400 w-5">ðŸ•</span><span class="text-gray-600">'+k.zeiten+'</span></div>';
                h += '</div>';
                h += '<div class="pt-3 border-t border-gray-100">';
                h += '<p class="text-xs text-gray-400 mb-1">Schwerpunkte</p>';
                h += '<p class="text-xs text-gray-600">'+k.schwerpunkt+'</p>';
                h += '</div>';
                h += '<div class="flex space-x-2 mt-3">';
                h += '<button class="flex-1 px-3 py-2 text-xs font-semibold border border-gray-300 rounded-lg hover:bg-gray-50">âœ‰ï¸ E-Mail</button>';
                h += '<button class="flex-1 px-3 py-2 text-xs font-semibold bg-vit-orange text-white rounded-lg hover:opacity-90">ðŸ“ž Anrufen</button>';
                h += '</div>';
                h += '</div>';
            });
            grid.innerHTML = h;
        }

        // Init support on view

        // === ALLGEMEIN MODULE (Jahresziele, Monatsplan, Journal) ===
        // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        // â•‘  vit:bikes â€“ MODUL ALLGEMEIN: JavaScript (komplett)         â•‘
        // â•‘  Einsetzen im <script>-Block der index.html                 â•‘
        // â•‘  ERSETZE die bestehende showAllgemeinTab() Funktion!        â•‘
        // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // --- State ---
        var allgemeinJahresziele = [];
        var allgemeinMonatsplan = [];
        var allgemeinJournal = [];
        var allgemeinAktuellerMonat = new Date().getMonth() + 1;
        var allgemeinJahr = new Date().getFullYear();
        var monatsDetailEditMonat = null;
        var journalStimmungValue = '';
        var monatsNamen = ['', 'Januar', 'Februar', 'MÃ¤rz', 'April', 'Mai', 'Juni',
            'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        
        // ============================================================
        // TAB NAVIGATION (ERSETZE bestehende showAllgemeinTab!)
        // ============================================================
        
        function showAllgemeinTab(tabName) {
            document.querySelectorAll('[id^="allgemeinTabContent-"]').forEach(function(el) {
                el.style.display = 'none';
            });
            document.querySelectorAll('#allgemeinTabs button').forEach(function(btn) {
                btn.className = 'px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700';
            });
            var content = document.getElementById('allgemeinTabContent-' + tabName);
            if (content) content.style.display = 'block';
            var btn = document.getElementById('allgemeinTab-' + tabName);
            if (btn) btn.className = 'px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition bg-white text-vit-orange shadow-sm';
        
            if (tabName === 'uebersicht') renderAllgemeinUebersicht();
            if (tabName === 'jahresziele') loadJahresziele();
            if (tabName === 'monatsplan') loadMonatsplan();
            if (tabName === 'journal') loadJournal();
        }
        
        // ============================================================
        // MASTER LOAD
        // ============================================================
        
        async function loadAllgemeinData() {
            try {
                await Promise.all([loadJahresziele(), loadMonatsplan(), loadJournal()]);
                renderAllgemeinUebersicht();
                loadHomeWidgets();
            } catch (err) {
                console.error('Fehler loadAllgemeinData:', err);
            }
        }
        
        // ============================================================
        // JAHRESZIELE
        // ============================================================
        
        async function loadJahresziele() {
            try {
                var query = sb.from('partner_jahresziele').select('*')
                    .eq('jahr', allgemeinJahr)
                    .order('sortierung', {ascending: true});
                if (!sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var res = await query;
                if (res.error) throw res.error;
                allgemeinJahresziele = res.data || [];
                renderJahresziele();
            } catch (err) { console.error('loadJahresziele:', err); }
        }
        
        function renderJahresziele() {
            var hart = allgemeinJahresziele.filter(function(z){return z.typ==='umsatz'||z.typ==='deckungsbeitrag';});
            var smart = allgemeinJahresziele.filter(function(z){return z.typ==='smart';});
            var soft = allgemeinJahresziele.filter(function(z){return z.typ==='soft_target';});
        
            var el = document.getElementById('jahreszieleHart');
            if (el) {
                if (!hart.length) {
                    el.innerHTML = '<div class="vit-card p-4 text-center text-gray-400 text-sm">Noch keine Umsatz-/Ertragsziele definiert</div>';
                } else {
                    el.innerHTML = hart.map(function(z){
                        var pct = z.zielwert > 0 ? Math.round((z.aktueller_wert/z.zielwert)*100) : 0;
                        var barColor = pct >= 80 ? 'bg-green-500' : pct >= 50 ? 'bg-yellow-500' : 'bg-vit-orange';
                        return '<div class="vit-card p-4"><div class="flex items-center justify-between mb-2"><div><h4 class="font-bold text-gray-800">'+escH(z.titel)+'</h4>'
                          +(z.beschreibung?'<p class="text-xs text-gray-500">'+escH(z.beschreibung)+'</p>':'')
                          +'</div><div class="text-right"><span class="text-lg font-bold text-vit-orange">'+pct+'%</span>'
                          +'<p class="text-xs text-gray-500">'+fmtN(z.aktueller_wert)+' / '+fmtN(z.zielwert)+' '+(z.einheit||'â‚¬')+'</p></div></div>'
                          +'<div class="w-full bg-gray-200 rounded-full h-2.5"><div class="'+barColor+' h-2.5 rounded-full transition-all" style="width:'+Math.min(pct,100)+'%"></div></div>'
                          +'<div class="flex justify-end mt-2 space-x-3"><button onclick="openJahreszielEdit(\''+z.id+'\')" class="text-xs text-gray-400 hover:text-gray-600">Bearbeiten</button>'
                          +'<button onclick="deleteJahresziel(\''+z.id+'\')" class="text-xs text-red-400 hover:text-red-600">LÃ¶schen</button></div></div>';
                    }).join('');
                }
            }
        
            el = document.getElementById('jahreszieleSmart');
            if (el) {
                if (!smart.length) {
                    el.innerHTML = '<div class="vit-card p-4 text-center text-gray-400 text-sm">Noch keine SMART-Ziele definiert</div>';
                } else {
                    el.innerHTML = smart.map(function(z){
                        var pct = z.zielwert > 0 ? Math.round((z.aktueller_wert/z.zielwert)*100) : 0;
                        var badge = z.status==='erreicht'?'<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">âœ“ Erreicht</span>'
                            : z.status==='gefaehrdet'?'<span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">âš  GefÃ¤hrdet</span>'
                            : '<span class="text-xs px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">Aktiv</span>';
                        return '<div class="vit-card p-4"><div class="flex items-center justify-between mb-2">'
                          +'<h4 class="font-bold text-gray-800 flex-1">'+escH(z.titel)+'</h4>'
                          +'<div class="flex items-center space-x-2">'+badge
                          +(z.zielwert>0?'<span class="text-sm font-bold text-blue-600">'+pct+'%</span>':'')
                          +'</div></div>'
                          +(z.beschreibung?'<p class="text-xs text-gray-500 mb-2 whitespace-pre-line">'+escH(z.beschreibung)+'</p>':'')
                          +(z.zielwert>0?'<div class="w-full bg-gray-200 rounded-full h-2 mb-2"><div class="bg-blue-500 h-2 rounded-full" style="width:'+Math.min(pct,100)+'%"></div></div>':'')
                          +'<div class="flex justify-end space-x-3"><button onclick="openJahreszielEdit(\''+z.id+'\')" class="text-xs text-gray-400 hover:text-gray-600">Bearbeiten</button>'
                          +'<button onclick="deleteJahresziel(\''+z.id+'\')" class="text-xs text-red-400 hover:text-red-600">LÃ¶schen</button></div></div>';
                    }).join('');
                }
            }
        
            el = document.getElementById('jahreszieleSoft');
            if (el) {
                if (!soft.length) {
                    el.innerHTML = '<div class="vit-card p-4 text-center text-gray-400 text-sm">Noch keine Soft Targets definiert</div>';
                } else {
                    el.innerHTML = soft.map(function(z){
                        var ck = z.ist_abgehakt ? 'checked' : '';
                        var strike = z.ist_abgehakt ? 'line-through text-gray-400' : 'text-gray-800';
                        return '<div class="vit-card p-3 flex items-center justify-between">'
                          +'<label class="flex items-center space-x-3 cursor-pointer flex-1">'
                          +'<input type="checkbox" '+ck+' onchange="toggleSoftTarget(\''+z.id+'\',this.checked)" class="w-4 h-4 rounded border-gray-300 text-vit-orange focus:ring-orange-400">'
                          +'<span class="text-sm font-semibold '+strike+'">'+escH(z.titel)+'</span></label>'
                          +'<button onclick="deleteJahresziel(\''+z.id+'\')" class="text-xs text-red-400 hover:text-red-600 ml-2">âœ•</button></div>';
                    }).join('');
                }
            }
        }
        
        function fmtN(n) { return (!n && n !== 0) ? '0' : Number(n).toLocaleString('de-DE'); }
        function escH(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        
        function openJahreszielModal() {
            document.getElementById('jahreszielEditId').value = '';
            document.getElementById('jahreszielTyp').value = 'umsatz';
            document.getElementById('jahreszielTitel').value = '';
            document.getElementById('jahreszielBeschreibung').value = '';
            document.getElementById('jahreszielZielwert').value = '';
            document.getElementById('jahreszielAktuellerWert').value = '';
            document.getElementById('jahreszielEinheit').value = 'â‚¬';
            toggleJahreszielFelder();
            document.getElementById('jahreszielModal').style.display = 'flex';
        }
        
        function openJahreszielEdit(id) {
            var z = allgemeinJahresziele.find(function(x){return x.id===id;});
            if (!z) return;
            document.getElementById('jahreszielEditId').value = z.id;
            document.getElementById('jahreszielTyp').value = z.typ;
            document.getElementById('jahreszielTitel').value = z.titel||'';
            document.getElementById('jahreszielBeschreibung').value = z.beschreibung||'';
            document.getElementById('jahreszielZielwert').value = z.zielwert||'';
            document.getElementById('jahreszielAktuellerWert').value = z.aktueller_wert||'';
            document.getElementById('jahreszielEinheit').value = z.einheit||'â‚¬';
            toggleJahreszielFelder();
            document.getElementById('jahreszielModal').style.display = 'flex';
        }
        function closeJahreszielModal() { document.getElementById('jahreszielModal').style.display='none'; }
        
        function toggleJahreszielFelder() {
            var typ = document.getElementById('jahreszielTyp').value;
            document.getElementById('jahreszielWerteWrap').style.display = typ==='soft_target' ? 'none' : 'grid';
            document.getElementById('jahreszielBeschreibungWrap').style.display = typ==='soft_target' ? 'none' : 'block';
        }
        
        async function saveJahresziel() {
            var editId = document.getElementById('jahreszielEditId').value;
            var payload = {
                standort_id: sbProfile.standort_id, jahr: allgemeinJahr,
                typ: document.getElementById('jahreszielTyp').value,
                titel: document.getElementById('jahreszielTitel').value.trim(),
                beschreibung: document.getElementById('jahreszielBeschreibung').value.trim(),
                zielwert: parseFloat(document.getElementById('jahreszielZielwert').value)||0,
                aktueller_wert: parseFloat(document.getElementById('jahreszielAktuellerWert').value)||0,
                einheit: document.getElementById('jahreszielEinheit').value,
                status: 'aktiv', ist_abgehakt: false, sortierung: allgemeinJahresziele.length + 1
            };
            if (!payload.titel) { alert('Bitte Titel eingeben'); return; }
            try {
                var res = editId ? await sb.from('partner_jahresziele').update(payload).eq('id', editId) : await sb.from('partner_jahresziele').insert([payload]);
                if (res.error) throw res.error;
                closeJahreszielModal(); loadJahresziele();
            } catch(e) { alert('Fehler: '+e.message); }
        }
        
        async function deleteJahresziel(id) {
            if (!confirm('Ziel wirklich lÃ¶schen?')) return;
            try { var r = await sb.from('partner_jahresziele').delete().eq('id', id); if (r.error) throw r.error; loadJahresziele(); } catch(e) { alert('Fehler: '+e.message); }
        }
        
        async function toggleSoftTarget(id, checked) {
            try { await sb.from('partner_jahresziele').update({ist_abgehakt:checked, status:checked?'erreicht':'aktiv'}).eq('id',id); loadJahresziele(); } catch(e) { console.error(e); }
        }
        
        // ============================================================
        // MONATSPLAN
        // ============================================================
        
        async function loadMonatsplan() {
            try {
                var query = sb.from('partner_monatsplan').select('*').eq('jahr', allgemeinJahr).order('monat',{ascending:true});
                if (!sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var res = await query;
                if (res.error) throw res.error;
                allgemeinMonatsplan = res.data || [];
                for (var m = 1; m <= 12; m++) {
                    if (!allgemeinMonatsplan.find(function(p){return p.monat===m;})) {
                        allgemeinMonatsplan.push({id:null, standort_id:sbProfile.standort_id, jahr:allgemeinJahr, monat:m, fokus_thema:'', beschreibung:'', massnahmen:[], verknuepfte_ziele:[], reflexion:'', status:'offen'});
                    }
                }
                allgemeinMonatsplan.sort(function(a,b){return a.monat-b.monat;});
                renderMonatsplan();
            } catch(e) { console.error('loadMonatsplan:',e); }
        }
        
        function renderMonatsplan() {
            var c = document.getElementById('monatsplanContent');
            if (!c) return;
            c.innerHTML = allgemeinMonatsplan.map(function(mp){
                var isAkt = mp.monat === allgemeinAktuellerMonat;
                var isVerg = mp.monat < allgemeinAktuellerMonat;
                var isDone = mp.status === 'abgeschlossen';
                var border = isAkt ? 'border-l-4 border-vit-orange' : isDone ? 'border-l-4 border-green-500' : isVerg ? 'border-l-4 border-gray-300' : '';
                var bg = isAkt ? 'bg-orange-50' : '';
                var icon = isDone ? 'âœ…' : isAkt ? 'ðŸ”¶' : isVerg ? 'â¬œ' : 'â—‹';
                var hasFokus = mp.fokus_thema && mp.fokus_thema.trim().length > 0;
                var mCount = 0, mDone = 0;
                if (mp.massnahmen && Array.isArray(mp.massnahmen)) { mCount = mp.massnahmen.length; mDone = mp.massnahmen.filter(function(x){return x.erledigt;}).length; }
                return '<div class="vit-card p-4 '+border+' '+bg+' cursor-pointer hover:shadow-lg transition" onclick="openMonatsDetail('+mp.monat+')">'
                  +'<div class="flex items-center justify-between"><div class="flex items-center space-x-3"><span class="text-lg">'+icon+'</span><div>'
                  +'<span class="font-bold text-gray-800">'+monatsNamen[mp.monat]+'</span>'
                  +(isAkt?' <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-vit-orange ml-2">Aktuell</span>':'')
                  +'<p class="text-sm '+(hasFokus?'text-gray-600':'text-gray-400 italic')+'">'+(hasFokus?escH(mp.fokus_thema):'Kein Fokus definiert â€“ klicke zum Bearbeiten')+'</p>'
                  +'</div></div><div class="flex items-center space-x-4">'
                  +(mCount>0?'<span class="text-xs text-gray-500">'+mDone+'/'+mCount+' MaÃŸnahmen</span>':'')
                  +'<span class="text-gray-300">â€º</span></div></div></div>';
            }).join('');
        }
        
        function openMonatsDetail(monat) {
            monatsDetailEditMonat = monat;
            var mp = allgemeinMonatsplan.find(function(p){return p.monat===monat;});
            if (!mp) return;
            document.getElementById('monatsDetailTitel').textContent = 'ðŸ“… ' + monatsNamen[monat] + ' ' + allgemeinJahr;
            document.getElementById('monatsDetailFokus').value = mp.fokus_thema || '';
            document.getElementById('monatsDetailBeschreibung').value = mp.beschreibung || '';
            document.getElementById('monatsDetailReflexion').value = mp.reflexion || '';
            document.getElementById('monatsDetailReflexionWrap').style.display = monat <= allgemeinAktuellerMonat ? 'block' : 'none';
        
            var mc = document.getElementById('monatsDetailMassnahmen');
            mc.innerHTML = (mp.massnahmen||[]).map(function(m,i){
                return '<div class="flex items-center space-x-2">'
                  +'<input type="checkbox" '+(m.erledigt?'checked':'')+' class="monats-massnahme-cb w-4 h-4 rounded border-gray-300 text-vit-orange focus:ring-orange-400" data-index="'+i+'">'
                  +'<input type="text" value="'+escH(m.text)+'" class="monats-massnahme-text flex-1 border rounded px-2 py-1 text-sm">'
                  +'<button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-xs">âœ•</button></div>';
            }).join('');
        
            var zc = document.getElementById('monatsDetailZiele');
            var vIds = mp.verknuepfte_ziele || [];
            if (!allgemeinJahresziele.length) {
                zc.innerHTML = '<p class="text-xs text-gray-400">Erst Jahresziele anlegen</p>';
            } else {
                zc.innerHTML = allgemeinJahresziele.filter(function(z){return z.typ!=='soft_target';}).map(function(z){
                    var linked = vIds.indexOf(z.id) !== -1;
                    return '<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" value="'+z.id+'" class="monats-ziel-cb w-3.5 h-3.5 rounded border-gray-300 text-vit-orange focus:ring-orange-400" '+(linked?'checked':'')+'><span class="text-xs text-gray-600">'+escH(z.titel)+'</span></label>';
                }).join('');
            }
            document.getElementById('monatsDetailPanel').style.display = 'block';
            document.getElementById('monatsDetailPanel').scrollIntoView({behavior:'smooth'});
        }
        
        function addMonatsMassnahme() {
            document.getElementById('monatsDetailMassnahmen').insertAdjacentHTML('beforeend',
                '<div class="flex items-center space-x-2"><input type="checkbox" class="monats-massnahme-cb w-4 h-4 rounded border-gray-300 text-vit-orange focus:ring-orange-400"><input type="text" class="monats-massnahme-text flex-1 border rounded px-2 py-1 text-sm" placeholder="Neue MaÃŸnahme..."><button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-xs">âœ•</button></div>');
        }
        function closeMonatsDetail() { document.getElementById('monatsDetailPanel').style.display = 'none'; monatsDetailEditMonat = null; }
        
        async function saveMonatsDetail() {
            if (!monatsDetailEditMonat) return;
            var massnahmen = [];
            document.querySelectorAll('#monatsDetailMassnahmen > div').forEach(function(row){
                var txt = row.querySelector('.monats-massnahme-text');
                if (txt && txt.value.trim()) massnahmen.push({text: txt.value.trim(), erledigt: row.querySelector('.monats-massnahme-cb').checked});
            });
            var zielIds = [];
            document.querySelectorAll('.monats-ziel-cb:checked').forEach(function(cb){ zielIds.push(cb.value); });
            var m = monatsDetailEditMonat;
            var payload = { standort_id: sbProfile.standort_id, jahr: allgemeinJahr, monat: m,
                fokus_thema: document.getElementById('monatsDetailFokus').value.trim(),
                beschreibung: document.getElementById('monatsDetailBeschreibung').value.trim(),
                massnahmen: massnahmen, verknuepfte_ziele: zielIds,
                reflexion: document.getElementById('monatsDetailReflexion').value.trim(),
                status: m < allgemeinAktuellerMonat ? 'abgeschlossen' : m === allgemeinAktuellerMonat ? 'aktiv' : 'offen'
            };
            try {
                var existing = allgemeinMonatsplan.find(function(p){return p.monat===m && p.id;});
                var res = existing && existing.id ? await sb.from('partner_monatsplan').update(payload).eq('id', existing.id) : await sb.from('partner_monatsplan').insert([payload]);
                if (res.error) throw res.error;
                closeMonatsDetail(); loadMonatsplan();
            } catch(e) { alert('Fehler: '+e.message); }
        }
        
        // ============================================================
        // PARTNER-JOURNAL
        // ============================================================
        
        async function loadJournal() {
            try {
                var query = sb.from('partner_journal').select('*').order('datum',{ascending:false});
                if (!sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var res = await query;
                if (res.error) throw res.error;
                allgemeinJournal = res.data || [];
                renderJournal();
            } catch(e) { console.error('loadJournal:',e); }
        }
        
        function renderJournal() {
            var c = document.getElementById('journalContent');
            if (!c) return;
            var stimmungEmojis = {positiv:'ðŸ˜Š', neutral:'ðŸ˜', besorgt:'ðŸ˜Ÿ', kritisch:'ðŸ˜¤'};
            if (!allgemeinJournal.length) {
                c.innerHTML = '<div class="text-center py-12 text-gray-400"><p class="text-4xl mb-3">ðŸ“</p><p class="font-semibold">Noch keine GesprÃ¤chsprotokolle</p><p class="text-sm mt-1">Dokumentiere dein nÃ¤chstes Partner-Meeting</p></div>';
                return;
            }
            c.innerHTML = allgemeinJournal.map(function(j){
                var themen = j.themen || [];
                var wuensche = j.wuensche_hq || [];
                var massnahmen = j.massnahmen || [];
                var offen = massnahmen.filter(function(m){return !m.erledigt;});
                var emoji = stimmungEmojis[j.stimmung] || 'ðŸ˜';
                var teiln = Array.isArray(j.teilnehmer) ? j.teilnehmer.join(', ') : (j.teilnehmer||'');
                var datFmt = j.datum ? new Date(j.datum+'T00:00:00').toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'}) : '';
        
                return '<div class="vit-card p-5">'
                  +'<div class="flex items-start justify-between mb-3"><div class="flex items-center space-x-3"><span class="text-2xl">'+emoji+'</span><div>'
                  +'<h4 class="font-bold text-gray-800">ðŸ“… '+datFmt+' â€“ PartnergesprÃ¤ch</h4>'
                  +'<p class="text-xs text-gray-500">Teilnehmer: '+escH(teiln)+'</p></div></div>'
                  +'<div class="flex space-x-2"><button onclick="openJournalEdit(\''+j.id+'\')" class="text-xs text-gray-400 hover:text-gray-600">Bearbeiten</button>'
                  +'<button onclick="deleteJournalEntry(\''+j.id+'\')" class="text-xs text-red-400 hover:text-red-600">LÃ¶schen</button></div></div>'
                  +(themen.length?'<div class="flex flex-wrap gap-1 mb-3">'+themen.map(function(t){return '<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">'+escH(t)+'</span>';}).join('')+'</div>':'')
                  +(j.aktuelle_lage?'<div class="mb-3"><p class="text-sm text-gray-700">'+escH(j.aktuelle_lage).replace(/\n/g,'<br>')+'</p></div>':'')
                  +(wuensche.length?'<div class="mb-3 p-3 bg-red-50 rounded-lg"><p class="text-xs font-semibold text-red-700 mb-1">ðŸ”´ WÃ¼nsche an HQ:</p>'+wuensche.map(function(w){var t=typeof w==='string'?w:w.text; return '<p class="text-sm text-red-800">â€¢ '+escH(t)+'</p>';}).join('')+'</div>':'')
                  +(massnahmen.length?'<div class="mb-2"><p class="text-xs font-semibold text-gray-600 mb-1">MaÃŸnahmen ('+(massnahmen.length-offen.length)+'/'+massnahmen.length+' erledigt):</p>'
                    +massnahmen.map(function(m){
                        return '<div class="flex items-center space-x-2 text-sm"><input type="checkbox" '+(m.erledigt?'checked':'')+' onchange="toggleJournalMassnahme(\''+j.id+'\',\''+escH(m.text).replace(/'/g,"\\'")+'\',this.checked)" class="w-3.5 h-3.5 rounded">'
                          +'<span class="'+(m.erledigt?'line-through text-gray-400':'text-gray-700')+'">'+escH(m.text)+(m.verantwortlich?' <span class="text-xs text-gray-400">('+escH(m.verantwortlich)+')</span>':'')+'</span></div>';}).join('')+'</div>':'')
                  +(j.naechster_termin?'<p class="text-xs text-gray-500 mt-2">ðŸ“… NÃ¤chster Termin: '+new Date(j.naechster_termin+'T00:00:00').toLocaleDateString('de-DE')+'</p>':'')
                  +'</div>';
            }).join('');
        }
        
        function openJournalModal() {
            document.getElementById('journalEditId').value = '';
            document.getElementById('journalDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalStimmung').value = '';
            journalStimmungValue = '';
            document.getElementById('journalTeilnehmer').value = '';
            document.getElementById('journalLage').value = '';
            document.getElementById('journalNaechsterTermin').value = '';
            document.querySelectorAll('.journal-thema-cb').forEach(function(cb){cb.checked=false; updateThemaStyle(cb);});
            document.querySelectorAll('.journal-stimmung-btn').forEach(function(b){b.style.opacity='0.4'; b.style.transform='scale(1)';});
            document.getElementById('journalWuensche').innerHTML = '';
            document.getElementById('journalMassnahmen').innerHTML = '';
            document.getElementById('journalModal').style.display = 'flex';
        }
        
        function openJournalEdit(id) {
            var j = allgemeinJournal.find(function(x){return x.id===id;});
            if (!j) return;
            document.getElementById('journalEditId').value = j.id;
            document.getElementById('journalDatum').value = j.datum||'';
            setJournalStimmung(j.stimmung||'neutral');
            document.getElementById('journalTeilnehmer').value = Array.isArray(j.teilnehmer)?j.teilnehmer.join(', '):(j.teilnehmer||'');
            document.getElementById('journalLage').value = j.aktuelle_lage||'';
            document.getElementById('journalNaechsterTermin').value = j.naechster_termin||'';
            document.querySelectorAll('.journal-thema-cb').forEach(function(cb){ cb.checked = (j.themen||[]).indexOf(cb.value)!==-1; updateThemaStyle(cb); });
            var wEl = document.getElementById('journalWuensche'); wEl.innerHTML='';
            (j.wuensche_hq||[]).forEach(function(w){addJournalWunsch(typeof w==='string'?w:w.text);});
            var mEl = document.getElementById('journalMassnahmen'); mEl.innerHTML='';
            (j.massnahmen||[]).forEach(function(m){addJournalMassnahme(m.text,m.verantwortlich,m.frist);});
            document.getElementById('journalModal').style.display = 'flex';
        }
        function closeJournalModal() { document.getElementById('journalModal').style.display='none'; }
        
        function setJournalStimmung(val) {
            journalStimmungValue = val;
            document.getElementById('journalStimmung').value = val;
            document.querySelectorAll('.journal-stimmung-btn').forEach(function(b){
                var match = b.getAttribute('data-val') === val;
                b.style.opacity = match ? '1' : '0.4';
                b.style.transform = match ? 'scale(1.2)' : 'scale(1)';
            });
        }
        
        function updateThemaStyle(cb) {
            var label = cb.closest('label');
            if (!label) return;
            if (cb.checked) { label.className = label.className.replace('bg-gray-100','bg-orange-100').replace('text-gray-600','text-vit-orange'); }
            else { label.className = label.className.replace('bg-orange-100','bg-gray-100').replace('text-vit-orange','text-gray-600'); }
        }
        document.addEventListener('change', function(e) { if (e.target.classList.contains('journal-thema-cb')) updateThemaStyle(e.target); });
        
        function addJournalWunsch(text) {
            document.getElementById('journalWuensche').insertAdjacentHTML('beforeend',
                '<div class="flex items-center space-x-2"><span class="text-red-500 text-xs">ðŸ”´</span>'
                +'<input type="text" value="'+escH(text||'')+'" class="journal-wunsch-text flex-1 border rounded px-2 py-1 text-sm" placeholder="Wunsch an HQ...">'
                +'<button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-xs">âœ•</button></div>');
        }
        function addJournalMassnahme(text, verantw, frist) {
            document.getElementById('journalMassnahmen').insertAdjacentHTML('beforeend',
                '<div class="flex items-center space-x-2 flex-wrap gap-y-1"><span class="text-xs">â˜</span>'
                +'<input type="text" value="'+escH(text||'')+'" class="journal-massnahme-text flex-1 min-w-[150px] border rounded px-2 py-1 text-sm" placeholder="MaÃŸnahme...">'
                +'<input type="text" value="'+escH(verantw||'')+'" class="journal-massnahme-verantw w-24 border rounded px-2 py-1 text-sm" placeholder="Wer?">'
                +'<input type="date" value="'+(frist||'')+'" class="journal-massnahme-frist border rounded px-2 py-1 text-sm">'
                +'<button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-xs">âœ•</button></div>');
        }
        
        async function saveJournalEntry() {
            var editId = document.getElementById('journalEditId').value;
            var themen = []; document.querySelectorAll('.journal-thema-cb:checked').forEach(function(cb){themen.push(cb.value);});
            var wuensche = []; document.querySelectorAll('.journal-wunsch-text').forEach(function(inp){ if (inp.value.trim()) wuensche.push({text:inp.value.trim(), status:'offen'}); });
            var massnahmen = [];
            document.querySelectorAll('#journalMassnahmen > div').forEach(function(row){
                var t = row.querySelector('.journal-massnahme-text');
                if (t && t.value.trim()) massnahmen.push({ text: t.value.trim(), verantwortlich: (row.querySelector('.journal-massnahme-verantw')||{}).value||'', frist: (row.querySelector('.journal-massnahme-frist')||{}).value||'', erledigt: false });
            });
            var teilnStr = document.getElementById('journalTeilnehmer').value;
            var teilnehmer = teilnStr.split(',').map(function(s){return s.trim();}).filter(Boolean);
            var payload = { standort_id: sbProfile.standort_id, datum: document.getElementById('journalDatum').value,
                teilnehmer: teilnehmer, stimmung: journalStimmungValue || 'neutral', themen: themen,
                aktuelle_lage: document.getElementById('journalLage').value.trim(), wuensche_hq: wuensche, massnahmen: massnahmen,
                naechster_termin: document.getElementById('journalNaechsterTermin').value || null, erstellt_von: sbUser.id
            };
            if (!payload.datum) { alert('Bitte Datum eingeben'); return; }
            try {
                var res = editId ? await sb.from('partner_journal').update(payload).eq('id', editId) : await sb.from('partner_journal').insert([payload]);
                if (res.error) throw res.error;
                closeJournalModal(); loadJournal();
            } catch(e) { alert('Fehler: '+e.message); }
        }
        
        async function deleteJournalEntry(id) {
            if (!confirm('Protokoll wirklich lÃ¶schen?')) return;
            try { var r = await sb.from('partner_journal').delete().eq('id',id); if (r.error) throw r.error; loadJournal(); } catch(e) { alert('Fehler: '+e.message); }
        }
        
        async function toggleJournalMassnahme(journalId, massnahmeText, checked) {
            var j = allgemeinJournal.find(function(x){return x.id===journalId;});
            if (!j) return;
            var massnahmen = (j.massnahmen||[]).map(function(m){ if (m.text === massnahmeText) return Object.assign({}, m, {erledigt: checked}); return m; });
            try { await sb.from('partner_journal').update({massnahmen:massnahmen}).eq('id',journalId); j.massnahmen = massnahmen; } catch(e) { console.error(e); }
        }
        
        // ============================================================
        // STIMMUNG
        // ============================================================
        
        async function setStimmung(val) {
            document.querySelectorAll('.stimmung-btn').forEach(function(b){
                b.style.opacity = b.getAttribute('data-stimmung') === val ? '1' : '0.4';
                b.style.transform = b.getAttribute('data-stimmung') === val ? 'scale(1.2)' : 'scale(1)';
            });
            try {
                var existing = allgemeinMonatsplan.find(function(p){return p.monat===allgemeinAktuellerMonat && p.id;});
                if (existing && existing.id) { await sb.from('partner_monatsplan').update({stimmung:val}).eq('id',existing.id); }
                else { await sb.from('partner_monatsplan').insert([{standort_id:sbProfile.standort_id, jahr:allgemeinJahr, monat:allgemeinAktuellerMonat, stimmung:val, fokus_thema:'', status:'aktiv', massnahmen:[], verknuepfte_ziele:[]}]); }
            } catch(e) { console.error('setStimmung:',e); }
        }
        
        // ============================================================
        // ÃœBERSICHT TAB
        // ============================================================
        
        function renderAllgemeinUebersicht() {
            var monatLabel = document.getElementById('uebersichtAktuellerMonat');
            if (monatLabel) monatLabel.textContent = monatsNamen[allgemeinAktuellerMonat] + ' ' + allgemeinJahr;
            var fokusEl = document.getElementById('uebersichtMonatsfokus');
            var aktMonat = allgemeinMonatsplan.find(function(p){return p.monat===allgemeinAktuellerMonat;});
            if (fokusEl) {
                if (aktMonat && aktMonat.fokus_thema) {
                    var mCount = (aktMonat.massnahmen||[]).length, mDone = (aktMonat.massnahmen||[]).filter(function(m){return m.erledigt;}).length;
                    fokusEl.innerHTML = '<p class="font-bold text-gray-800 text-lg mb-1">'+escH(aktMonat.fokus_thema)+'</p>'
                      +(aktMonat.beschreibung?'<p class="text-sm text-gray-600 mb-2">'+escH(aktMonat.beschreibung)+'</p>':'')
                      +(mCount>0?'<div class="flex items-center space-x-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="bg-vit-orange h-2 rounded-full" style="width:'+Math.round(mDone/mCount*100)+'%"></div></div><span class="text-xs text-gray-500">'+mDone+'/'+mCount+'</span></div>':'');
                } else { fokusEl.innerHTML = '<p class="text-gray-400 text-sm italic">Kein Fokusthema definiert</p><button onclick="showAllgemeinTab(\'monatsplan\')" class="text-sm text-vit-orange font-semibold mt-1">Jetzt festlegen â†’</button>'; }
            }
            var jzEl = document.getElementById('uebersichtJahresziele');
            if (jzEl) {
                var aktiveZiele = allgemeinJahresziele.filter(function(z){return z.typ!=='soft_target';});
                if (!aktiveZiele.length) { jzEl.innerHTML = '<p class="text-gray-400 text-sm italic">Keine Ziele definiert</p>'; }
                else { jzEl.innerHTML = aktiveZiele.slice(0,3).map(function(z){ var pct = z.zielwert>0 ? Math.round((z.aktueller_wert/z.zielwert)*100) : 0; return '<div class="mb-2"><div class="flex justify-between text-xs mb-0.5"><span class="text-gray-700 font-semibold truncate">'+escH(z.titel)+'</span><span class="text-gray-500">'+pct+'%</span></div><div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-vit-orange h-1.5 rounded-full" style="width:'+Math.min(pct,100)+'%"></div></div></div>'; }).join(''); }
            }
            var maEl = document.getElementById('uebersichtMassnahmen');
            var maBadge = document.getElementById('uebersichtMassnahmenBadge');
            var offeneMassn = [];
            allgemeinJournal.forEach(function(j){ (j.massnahmen||[]).forEach(function(m){ if (!m.erledigt) offeneMassn.push({text:m.text, datum:j.datum}); }); });
            if (maBadge) maBadge.textContent = offeneMassn.length;
            if (maEl) {
                if (!offeneMassn.length) { maEl.innerHTML = '<p class="text-gray-400 text-sm">Keine offenen MaÃŸnahmen ðŸŽ‰</p>'; }
                else { maEl.innerHTML = offeneMassn.slice(0,4).map(function(m){ return '<div class="flex items-center space-x-2 text-sm mb-1"><span class="text-red-400">â€¢</span><span class="text-gray-700 truncate">'+escH(m.text)+'</span></div>'; }).join('') + (offeneMassn.length>4?'<p class="text-xs text-gray-400 mt-1">+ '+(offeneMassn.length-4)+' weitere</p>':''); }
            }
            var stimmungEmojis = {positiv:'ðŸ˜Š', neutral:'ðŸ˜', besorgt:'ðŸ˜Ÿ', kritisch:'ðŸ˜¤'};
            var ljEl = document.getElementById('uebersichtLetztesJournal');
            if (ljEl) {
                if (!allgemeinJournal.length) { ljEl.innerHTML = '<p class="text-gray-400 text-sm italic">Noch kein GesprÃ¤ch protokolliert</p>'; }
                else { var lj = allgemeinJournal[0]; ljEl.innerHTML = '<div class="flex items-center space-x-2 mb-1"><span class="text-lg">'+(stimmungEmojis[lj.stimmung]||'ðŸ˜')+'</span><span class="text-sm font-semibold text-gray-800">'+(lj.datum?new Date(lj.datum+'T00:00:00').toLocaleDateString('de-DE'):'')+'</span></div>'+(lj.aktuelle_lage?'<p class="text-xs text-gray-600 line-clamp-2">'+escH(lj.aktuelle_lage).substring(0,120)+'...</p>':''); }
            }
            var nmEl = document.getElementById('uebersichtNaechstesMeeting');
            if (nmEl) {
                var naechster = null;
                allgemeinJournal.forEach(function(j){ if (j.naechster_termin && (!naechster || j.naechster_termin > naechster)) naechster = j.naechster_termin; });
                nmEl.innerHTML = naechster ? '<p class="text-2xl font-bold text-vit-orange">'+new Date(naechster+'T00:00:00').toLocaleDateString('de-DE')+'</p>' : '<p class="text-gray-400 text-sm italic">Kein Termin eingetragen</p>';
            }
            if (aktMonat && aktMonat.stimmung) { document.querySelectorAll('.stimmung-btn').forEach(function(b){ b.style.opacity = b.getAttribute('data-stimmung')===aktMonat.stimmung ? '1' : '0.4'; b.style.transform = b.getAttribute('data-stimmung')===aktMonat.stimmung ? 'scale(1.2)' : 'scale(1)'; }); }
        }
        
        // ============================================================
        // HOME WIDGETS (Startseite)
        // ============================================================
        

        // ========================================
        // DASHBOARD WIDGETS â€“ Live-Daten laden
        // ========================================
        async function loadDashboardWidgets() {
            try { await Promise.all([
                loadWidgetPipeline(),
                loadWidgetSuccess(),
                loadWidgetTermine(),
                loadWidgetAufgaben(),
                loadWidgetMarketing(),
                loadWidgetTeam(),
                loadWidgetControlling(),
                loadWidgetSupport(),
                loadWidgetWissen(),
                loadWidgetNachrichten()
            ]); } catch(e) { console.error('Widget-Laden:', e); }
        }

        // --- Pipeline Widget ---
        async function loadWidgetPipeline() {
            var el = document.getElementById('wPipelineContent'); if(!el) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('leads').select('id, status, geschaetzter_wert');
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var leads = res.data || [];
                var offen = leads.filter(function(l){ return l.status !== 'gewonnen' && l.status !== 'verloren'; });
                var angebote = leads.filter(function(l){ return l.status === 'angebot'; });
                var pipeWert = offen.reduce(function(s,l){ return s + (l.geschaetzter_wert||0); }, 0);
                var badge = document.getElementById('wPipelineBadge');
                if(badge) badge.textContent = offen.length + ' aktiv';
                el.innerHTML = '<div class="space-y-3">'
                    +'<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Offene Leads</span><span class="font-bold text-blue-600">'+offen.length+'</span></div>'
                    +'<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Angebote offen</span><span class="font-bold text-orange-600">'+angebote.length+'</span></div>'
                    +'<div class="flex items-center justify-between"><span class="text-sm text-gray-600">Pipeline-Wert</span><span class="font-bold text-green-600">'+fmtN(pipeWert)+' â‚¬</span></div>'
                    +'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Daten nicht verfÃ¼gbar</p>'; }
        }

        // --- Verkaufserfolg Widget ---
        async function loadWidgetSuccess() {
            var el = document.getElementById('wSuccessContent'); if(!el) return;
            try {
                var kw = getKWnow(); var kwBadge = document.getElementById('wSuccessKW');
                if(kwBadge) kwBadge.textContent = 'KW ' + kw;
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var mondayISO = getKWMonday(kw);
                var sundayISO = getKWSunday(kw);
                var q = sb.from('verkauf_tracking').select('id, beratungen, verkauft, umsatz').gte('datum', mondayISO).lte('datum', sundayISO);
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var data = res.data || [];
                var verkauft = data.reduce(function(s,d){ return s + (d.verkauft||0); }, 0);
                var beratung = data.reduce(function(s,d){ return s + (d.beratungen||0); }, 0);
                var quote = beratung > 0 ? Math.round(verkauft / beratung * 100) : 0;
                el.innerHTML = '<div class="mb-3"><div class="flex items-center justify-between mb-1"><span class="text-sm text-gray-600">Verkaufsquote</span>'
                    +'<span class="text-2xl font-bold '+(quote>=40?'text-green-600':quote>=20?'text-yellow-600':'text-red-500')+'">'+quote+'%</span></div>'
                    +'<div class="w-full bg-gray-200 rounded-full h-2"><div class="'+(quote>=40?'bg-green-500':quote>=20?'bg-yellow-500':'bg-red-500')+' h-2 rounded-full" style="width:'+Math.min(quote,100)+'%"></div></div></div>'
                    +'<div class="grid grid-cols-2 gap-2 text-sm"><div><p class="text-gray-500">VerkÃ¤ufe</p><p class="font-bold text-gray-800">'+verkauft+'</p></div>'
                    +'<div><p class="text-gray-500">Beratungen</p><p class="font-bold text-gray-800">'+beratung+'</p></div></div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Keine Verkaufsdaten</p>'; }
        }
        function getKWnow() { var d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-(d.getDay()+6)%7); var w=new Date(d.getFullYear(),0,4); return 1+Math.round(((d-w)/864e5-3+(w.getDay()+6)%7)/7); }
        function getKWMonday(kw) { var y=new Date().getFullYear(); var d=new Date(y,0,4); var dayOfWeek=d.getDay()||7; d.setDate(d.getDate()-dayOfWeek+1+(kw-1)*7); return d.toISOString().split('T')[0]; }
        function getKWSunday(kw) { var m=getKWMonday(kw); var d=new Date(m); d.setDate(d.getDate()+6); return d.toISOString().split('T')[0]; }

        // --- Termine Widget ---
        async function loadWidgetTermine() {
            var el = document.getElementById('wTermineContent'); if(!el) return;
            try {
                var today = new Date().toISOString().split('T')[0];
                var tomorrow = new Date(Date.now()+864e5).toISOString().split('T')[0];
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('termine').select('id, titel, beschreibung, start_zeit').gte('start_zeit', today+'T00:00:00').lt('start_zeit', tomorrow+'T00:00:00').order('start_zeit');
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var terme = res.data || [];
                var badge = document.getElementById('wTermineCount');
                if(badge) badge.textContent = terme.length;
                if(!terme.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Keine Termine heute ðŸ“­</p>'; return; }
                var colors = ['bg-blue-50','bg-purple-50','bg-green-50','bg-orange-50','bg-pink-50'];
                el.innerHTML = '<div class="space-y-2">'+terme.slice(0,4).map(function(t,i){
                    var zeit = t.start_zeit ? new Date(t.start_zeit).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : '';
                    return '<div class="p-2.5 '+colors[i%5]+' rounded-lg"><p class="text-sm font-semibold text-gray-800">'+zeit+(zeit?' - ':'')+escH(t.titel||'')+'</p>'+(t.beschreibung?'<p class="text-xs text-gray-600">'+escH(t.beschreibung).substring(0,50)+'</p>':'')+'</div>';
                }).join('')+(terme.length>4?'<p class="text-xs text-gray-400 text-center">+'+(terme.length-4)+' weitere</p>':'')+'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }

        // --- Aufgaben Widget ---
        async function loadWidgetAufgaben() {
            var el = document.getElementById('wAufgabenContent'); if(!el) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var userId = sbProfile ? sbProfile.user_id : null;
                var q = sb.from('todos').select('id, titel, erledigt, faellig_am, prio_sort').eq('erledigt', false).order('prio_sort').order('faellig_am').limit(5);
                if(userId) q = q.eq('user_id', userId);
                var res = await q;
                var aufgaben = res.data || [];
                var badge = document.getElementById('wAufgabenCount');
                if(badge) badge.textContent = aufgaben.length + (aufgaben.length>=5?'+':'');
                if(!aufgaben.length) { el.innerHTML = '<p class="text-sm text-green-600 font-semibold text-center py-2">Alles erledigt! ðŸŽ‰</p>'; return; }
                var today = new Date().toISOString().split('T')[0];
                el.innerHTML = '<div class="space-y-2">'+aufgaben.map(function(t){
                    var overdue = t.faellig_am && t.faellig_am < today;
                    return '<div class="flex items-start space-x-2"><input type="checkbox" class="mt-0.5 rounded border-gray-300 accent-orange-500" onchange="quickToggleTodo(\''+t.id+'\',this.checked)"><span class="text-sm '+(overdue?'text-red-600':'text-gray-700')+'">'+escH(t.titel||'')+(overdue?' â°':'')+'</span></div>';
                }).join('')+'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }
        async function quickToggleTodo(id, checked) {
            try { await sb.from('todos').update({erledigt:checked, erledigt_am:checked?new Date().toISOString():null}).eq('id',id); loadWidgetAufgaben(); } catch(e){}
        }

        // --- Marketing Widget ---
        async function loadWidgetMarketing() {
            var el = document.getElementById('wMarketingContent'); if(!el) return;
            // Marketing data is currently demo - show static KPIs from module
            el.innerHTML = '<div class="grid grid-cols-2 gap-3">'
                +'<div class="p-2 bg-gray-50 rounded-lg text-center"><p class="text-[10px] text-gray-400">Kosten MTD</p><p class="text-sm font-bold text-gray-800">1.724 â‚¬</p><p class="text-[10px] text-red-500">â†“ -2.5%</p></div>'
                +'<div class="p-2 bg-gray-50 rounded-lg text-center"><p class="text-[10px] text-gray-400">Leads MTD</p><p class="text-sm font-bold text-vit-orange">4</p><p class="text-[10px] text-gray-400">CPT: 431 â‚¬</p></div>'
                +'<div class="p-2 bg-gray-50 rounded-lg text-center"><p class="text-[10px] text-gray-400">Store Visits</p><p class="text-sm font-bold text-green-600">65</p><p class="text-[10px] text-green-600">â†‘ 69.8%</p></div>'
                +'<div class="p-2 bg-gray-50 rounded-lg text-center"><p class="text-[10px] text-gray-400">Budget</p><p class="text-sm font-bold text-gray-800">1.500 â‚¬</p><div class="mt-1 bg-gray-200 rounded-full h-1.5"><div class="bg-vit-orange h-1.5 rounded-full" style="width:100%"></div></div></div>'
                +'</div>'
                +'<span class="inline-block mt-2 text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-600 font-semibold">Demo-Daten</span>';
        }

        // --- Team Widget ---
        async function loadWidgetTeam() {
            var el = document.getElementById('wTeamContent'); if(!el) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('users').select('id, name, status').eq('status', 'aktiv');
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var team = res.data || [];
                if(!team.length) { el.innerHTML = '<p class="text-sm text-gray-400">Keine Mitarbeiter</p>'; return; }
                var rolleIcons = {admin:'ðŸ‘‘',geschaeftsfuehrer:'ðŸ¢',standortleiter:'â­',verkauf:'ðŸ’°',werkstatt:'ðŸ”§',mitarbeiter:'ðŸ‘¤'};
                el.innerHTML = '<div class="space-y-2">'+team.slice(0,5).map(function(u){
                    return '<div class="flex items-center justify-between"><div class="flex items-center space-x-2"><span>ðŸ‘¤</span><span class="text-sm font-semibold text-gray-800">'+escH(u.name||'Unbekannt')+'</span></div><span class="text-xs text-green-600">â— aktiv</span></div>';
                }).join('')+(team.length>5?'<p class="text-xs text-gray-400 text-center">+' + (team.length-5) + ' weitere</p>':'')+'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }

        // --- Controlling Widget ---
        async function loadWidgetControlling() {
            var el = document.getElementById('wControllingContent'); if(!el) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('bwa_daten').select('monat, umsatzerloese, rohertrag, personalkosten, ergebnis_vor_steuern').order('monat', {ascending:false}).limit(1);
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var bwa = (res.data||[])[0];
                if(!bwa) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Noch keine BWA hochgeladen</p>'; return; }
                var rohPct = bwa.umsatzerloese ? Math.round(bwa.rohertrag / bwa.umsatzerloese * 100) : 0;
                el.innerHTML = '<div class="space-y-3">'
                    +'<div class="flex justify-between items-center"><span class="text-sm text-gray-600">Umsatz</span><span class="font-bold text-gray-800">'+fmtN(bwa.umsatzerloese||0)+' â‚¬</span></div>'
                    +'<div><div class="flex justify-between mb-1"><span class="text-sm text-gray-600">Rohertrag</span><span class="text-sm font-semibold '+(rohPct>=35?'text-green-600':'text-red-500')+'">'+rohPct+'%</span></div>'
                    +'<div class="w-full bg-gray-200 rounded-full h-2"><div class="'+(rohPct>=35?'bg-green-500':'bg-red-500')+' h-2 rounded-full" style="width:'+Math.min(rohPct,60)/60*100+'%"></div></div></div>'
                    +'<div class="flex justify-between items-center"><span class="text-sm text-gray-600">Ergebnis</span><span class="font-bold '+((bwa.ergebnis_vor_steuern||0)>=0?'text-green-600':'text-red-500')+'">'+fmtN(bwa.ergebnis_vor_steuern||0)+' â‚¬</span></div>'
                    +'<p class="text-[10px] text-gray-400">Letzte BWA: Monat '+escH(String(bwa.monat||''))+'</p>'
                    +'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }

        // --- Support Widget ---
        async function loadWidgetSupport() {
            var el = document.getElementById('wSupportContent'); if(!el) return;
            try {
                var stdId = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('support_tickets').select('id, titel, status, created_at').eq('status', 'offen').order('created_at', {ascending:false}).limit(3);
                if(stdId) q = q.eq('standort_id', stdId);
                var res = await q;
                var tickets = res.data || [];
                var badge = document.getElementById('wSupportCount');
                if(badge) badge.textContent = tickets.length + (tickets.length>=3?'+':'');
                if(!tickets.length) { el.innerHTML = '<div class="text-center py-3"><p class="text-2xl">âœ…</p><p class="text-sm text-green-600 font-semibold mt-1">Keine offenen Tickets</p></div>'; return; }
                el.innerHTML = '<div class="space-y-2">'+tickets.map(function(t){
                    var age = Math.floor((Date.now() - new Date(t.created_at).getTime()) / 864e5);
                    return '<div class="text-xs p-2 '+(age>7?'bg-red-50':'bg-yellow-50')+' rounded"><p class="font-semibold">'+escH(t.titel||'Ticket')+'</p><p class="text-gray-600">Offen seit '+age+' Tag'+(age!==1?'en':'')+'</p></div>';
                }).join('')+'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }

        // --- Wissen Widget ---
        async function loadWidgetWissen() {
            var el = document.getElementById('wWissenContent'); if(!el) return;
            // Wissen currently has no CMS DB - show curated static content
            el.innerHTML = '<div class="space-y-2">'
                +'<div class="p-2 bg-purple-50 rounded"><p class="text-sm font-semibold text-gray-800">ðŸŽ“ Einkauf</p><p class="text-xs text-gray-600">Kernsortiment & DB1-Optimierung</p></div>'
                +'<div class="p-2 bg-blue-50 rounded"><p class="text-sm font-semibold text-gray-800">ðŸ“‹ Marketing</p><p class="text-xs text-gray-600">Local Hero & Google Ads</p></div>'
                +'<div class="p-2 bg-green-50 rounded"><p class="text-sm font-semibold text-gray-800">ðŸ’° Verkauf</p><p class="text-xs text-gray-600">Beratungsleitfaden 2026</p></div>'
                +'</div>'
                +'<span class="inline-block mt-2 text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-600 font-semibold">Demo-Daten</span>';
        }

        // --- Nachrichten Widget ---
        async function loadWidgetNachrichten() {
            var el = document.getElementById('wNachrichtenContent'); if(!el) return;
            try {
                var res = await sb.from('ankuendigungen').select('id, titel, kategorie, created_at').order('created_at', {ascending:false}).limit(3);
                var news = res.data || [];
                if(!news.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-2">Keine Nachrichten</p>'; return; }
                var catColors = {wichtig:'bg-red-50 border-red-400',info:'bg-blue-50 border-blue-400',aktion:'bg-orange-50 border-vit-orange',update:'bg-green-50 border-green-400'};
                el.innerHTML = '<div class="space-y-2">'+news.map(function(n){
                    var ago = Math.floor((Date.now()-new Date(n.created_at).getTime())/36e5);
                    var agoTxt = ago < 1 ? 'gerade eben' : ago < 24 ? 'vor '+ago+' Std.' : 'vor '+Math.floor(ago/24)+' Tag'+(Math.floor(ago/24)!==1?'en':'');
                    var col = catColors[n.kategorie] || 'bg-gray-50 border-gray-300';
                    return '<div class="p-2.5 '+col+' rounded-lg border-l-4"><p class="text-sm font-semibold text-gray-800">'+escH(n.titel||'')+'</p><p class="text-xs text-gray-500">'+agoTxt+'</p></div>';
                }).join('')+'</div>';
            } catch(e) { el.innerHTML = '<p class="text-sm text-gray-400">Fehler beim Laden</p>'; }
        }

        function loadHomeWidgets() {
            var fokusContent = document.getElementById('homeMonatsfokusContent');
            var fokusMonat = document.getElementById('homeMonatsfokusMonat');
            var aktMonat = allgemeinMonatsplan.find(function(p){return p.monat===allgemeinAktuellerMonat;});
            if (fokusMonat) fokusMonat.textContent = monatsNamen[allgemeinAktuellerMonat];
            if (fokusContent) { fokusContent.innerHTML = aktMonat && aktMonat.fokus_thema ? '<p class="font-bold text-gray-800">'+escH(aktMonat.fokus_thema)+'</p>'+(aktMonat.beschreibung?'<p class="text-xs text-gray-500 mt-1">'+escH(aktMonat.beschreibung).substring(0,80)+'</p>':'') : '<p class="text-sm text-gray-400 italic">Noch kein Fokus definiert</p>'; }
        
            var jzContent = document.getElementById('homeJahreszieleContent');
            var jzCount = document.getElementById('homeJahreszieleCount');
            if (jzCount) jzCount.textContent = allgemeinJahresziele.length + ' Ziele';
            if (jzContent) {
                var top = allgemeinJahresziele.filter(function(z){return z.typ!=='soft_target';}).slice(0,2);
                jzContent.innerHTML = !top.length ? '<p class="text-sm text-gray-400 italic">Keine Ziele definiert</p>' : top.map(function(z){ var pct = z.zielwert>0?Math.round((z.aktueller_wert/z.zielwert)*100):0; return '<div class="mb-2"><div class="flex justify-between text-xs"><span class="font-semibold text-gray-700 truncate">'+escH(z.titel)+'</span><span>'+pct+'%</span></div><div class="w-full bg-gray-200 rounded-full h-1.5 mt-0.5"><div class="bg-vit-orange h-1.5 rounded-full" style="width:'+Math.min(pct,100)+'%"></div></div></div>'; }).join('');
            }
        
            var jContent = document.getElementById('homeJournalContent');
            var jDatum = document.getElementById('homeJournalDatum');
            var stimmungEmojis = {positiv:'ðŸ˜Š', neutral:'ðŸ˜', besorgt:'ðŸ˜Ÿ', kritisch:'ðŸ˜¤'};
            if (!allgemeinJournal.length) { if (jContent) jContent.innerHTML = '<p class="text-sm text-gray-400 italic">Noch kein GesprÃ¤ch</p>'; if (jDatum) jDatum.textContent = ''; }
            else { var lj = allgemeinJournal[0]; if (jDatum) jDatum.textContent = lj.datum?new Date(lj.datum+'T00:00:00').toLocaleDateString('de-DE'):''; if (jContent) jContent.innerHTML = '<div class="flex items-center space-x-2 mb-1"><span>'+(stimmungEmojis[lj.stimmung]||'ðŸ˜')+'</span><span class="text-sm font-semibold">PartnergesprÃ¤ch</span></div>'+(lj.aktuelle_lage?'<p class="text-xs text-gray-500 line-clamp-2">'+escH(lj.aktuelle_lage).substring(0,100)+'</p>':''); }
        
            var maContent = document.getElementById('homeMassnahmenContent');
            var maCount = document.getElementById('homeMassnahmenCount');
            var offene = []; allgemeinJournal.forEach(function(j){ (j.massnahmen||[]).forEach(function(m){ if (!m.erledigt) offene.push(m); }); });
            if (maCount) maCount.textContent = offene.length + ' offen';
            if (maContent) { maContent.innerHTML = !offene.length ? '<p class="text-sm text-green-600 font-semibold">Alles erledigt! ðŸŽ‰</p>' : offene.slice(0,3).map(function(m){ return '<p class="text-sm text-gray-700 mb-1">â€¢ '+escH(m.text)+'</p>'; }).join('') + (offene.length>3?'<p class="text-xs text-gray-400">+ '+(offene.length-3)+' weitere</p>':''); }
        }
        
        // ============================================================
        // HQ PARTNER-ÃœBERSICHT
        // ============================================================
        
        async function loadHqAllgemeinData() {
            try {
                var mpRes = await sb.from('partner_monatsplan').select('*, standorte(name, stadt)').eq('jahr', allgemeinJahr).eq('monat', allgemeinAktuellerMonat);
                var jRes = await sb.from('partner_journal').select('*, standorte(name, stadt)').order('datum', {ascending:false});
                var jzRes = await sb.from('partner_jahresziele').select('*, standorte(name, stadt)').eq('jahr', allgemeinJahr);
                var stRes = await sb.from('standorte').select('id, name, stadt, status').eq('status', 'aktiv');
                if (mpRes.error) throw mpRes.error; if (jRes.error) throw jRes.error; if (stRes.error) throw stRes.error;
                renderHqAllgemein(stRes.data||[], mpRes.data||[], jRes.data||[], jzRes.data||[]);
            } catch(e) { console.error('loadHqAllgemeinData:', e); }
        }
        
        function renderHqAllgemein(standorte, monatsplaene, journals, jahresziele) {
            var stimmungEmojis = {positiv:'ðŸ˜Š', neutral:'ðŸ˜', besorgt:'ðŸ˜Ÿ', kritisch:'ðŸ˜¤'};
            var stimmungen = {positiv:0, neutral:0, besorgt:0, kritisch:0};
            monatsplaene.forEach(function(mp){ if (mp.stimmung && stimmungen.hasOwnProperty(mp.stimmung)) stimmungen[mp.stimmung]++; });
            document.getElementById('hqStimmungPositiv').textContent = stimmungen.positiv;
            document.getElementById('hqStimmungNeutral').textContent = stimmungen.neutral;
            document.getElementById('hqStimmungBesorgt').textContent = stimmungen.besorgt;
            document.getElementById('hqStimmungKritisch').textContent = stimmungen.kritisch;
        
            var hqAufgaben = [];
            journals.forEach(function(j){ (j.wuensche_hq||[]).forEach(function(w){ var text = typeof w==='string'?w:w.text; var status = typeof w==='object'?w.status:'offen'; if (status === 'offen') hqAufgaben.push({text:text, standort:j.standorte?j.standorte.name:'', datum:j.datum}); }); });
            document.getElementById('hqAufgabenBadge').textContent = hqAufgaben.length;
            var aufgEl = document.getElementById('hqJournalAufgaben');
            aufgEl.innerHTML = !hqAufgaben.length ? '<p class="text-sm text-green-600 font-semibold">Keine offenen HQ-Aufgaben ðŸŽ‰</p>'
                : hqAufgaben.map(function(a){ return '<div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0"><div class="flex items-center space-x-2"><span class="text-red-500">â€¢</span><span class="text-sm text-gray-800">'+escH(a.text)+'</span></div><div class="text-xs text-gray-500">'+escH(a.standort)+' Â· '+(a.datum?new Date(a.datum+'T00:00:00').toLocaleDateString('de-DE'):'')+'</div></div>'; }).join('');
        
            var tbody = document.getElementById('hqPartnerTabelle');
            if (!standorte.length) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">Keine aktiven Standorte</td></tr>'; return; }
            tbody.innerHTML = standorte.map(function(st){
                var mp = monatsplaene.find(function(p){return p.standort_id===st.id;});
                var stJournals = journals.filter(function(j){return j.standort_id===st.id;});
                var stZiele = jahresziele.filter(function(z){return z.standort_id===st.id;});
                var letztes = stJournals.length ? stJournals[0] : null;
                var stimmung = mp && mp.stimmung ? stimmungEmojis[mp.stimmung] : 'â€”';
                var fokus = mp && mp.fokus_thema ? mp.fokus_thema : 'â€”';
                var offenCount = 0; stJournals.forEach(function(j){ (j.massnahmen||[]).forEach(function(m){if(!m.erledigt) offenCount++;}); });
                return '<tr class="border-b hover:bg-gray-50">'
                  +'<td class="p-3"><span class="font-semibold text-gray-800">'+escH(st.name)+'</span><br><span class="text-xs text-gray-500">'+escH(st.stadt||'')+'</span></td>'
                  +'<td class="p-3 text-center text-xl">'+stimmung+'</td>'
                  +'<td class="p-3 text-sm text-gray-700 max-w-[200px] truncate">'+escH(fokus)+'</td>'
                  +'<td class="p-3 text-center"><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">'+stZiele.length+'</span></td>'
                  +'<td class="p-3 text-center">'+(offenCount>0?'<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600">'+offenCount+'</span>':'<span class="text-xs text-green-600">âœ“</span>')+'</td>'
                  +'<td class="p-3 text-center text-xs text-gray-500">'+(letztes?new Date(letztes.datum+'T00:00:00').toLocaleDateString('de-DE'):'â€”')+'</td>'
                  +'<td class="p-3 text-center"><button onclick="viewPartnerDetails(\''+st.id+'\')" class="text-xs text-vit-orange font-semibold hover:underline">Details â†’</button></td></tr>';
            }).join('');
        }
        
        function viewPartnerDetails(standortId) { alert('Partner-Detail fÃ¼r Standort ' + standortId + ' â€“ wird in nÃ¤chster Iteration implementiert'); }
        
        // ============================================================
        // showView() HOOKS â€“ Diese 2 Zeilen in showView() ergÃ¤nzen:
        // ============================================================
        // if(viewName === 'allgemein') loadAllgemeinData();
        // if(viewName === 'hqAllgemein') loadHqAllgemeinData();
        

        var origShowView = showView;
        showView = function(v) {
            origShowView(v);
            if(v==='support') { renderTickets('all'); renderKontakte(); }
            if(v==='ideenboard') { renderIdeen('all'); }
            if(v==='wissen') { renderWissenGlobal(); }
            if(v==='shop') { renderShop(); }
        };

        // === IDEENBOARD ===
        async function renderIdeen(filter) {
            var container = document.getElementById('ideenList');
            if(!container) return;
            try {
                var query = sb.from('ideen').select('*, users(name)').order('votes', {ascending:false});
                if(filter && filter!=='all') query = query.eq('status', filter);
                var resp = await query;
                if(resp.error) throw resp.error;
                var ideas = resp.data || [];
                // KPIs (immer alle zÃ¤hlen)
                var allResp = await sb.from('ideen').select('status');
                var allIdeas = allResp.data || [];
                var ge=document.getElementById('ideenTotal');if(ge)ge.textContent=allIdeas.length;
                var ne=document.getElementById('ideenNeu');if(ne)ne.textContent=allIdeas.filter(function(i){return i.status==='neu';}).length;
                var gp=document.getElementById('ideenGeplant');if(gp)gp.textContent=allIdeas.filter(function(i){return i.status==='wird_geprueft'||i.status==='geplant'||i.status==='diskussion';}).length;
                var um=document.getElementById('ideenUmgesetzt');if(um)um.textContent=allIdeas.filter(function(i){return i.status==='umgesetzt';}).length;

                var html = '';
                var statusColors = {neu:'bg-blue-100 text-blue-700',diskussion:'bg-yellow-100 text-yellow-700',wird_geprueft:'bg-yellow-100 text-yellow-700',geplant:'bg-purple-100 text-purple-700',umgesetzt:'bg-green-100 text-green-700',abgelehnt:'bg-red-100 text-red-700'};
                var statusLabels = {neu:'Neu',diskussion:'In Diskussion',wird_geprueft:'Wird geprÃ¼ft',geplant:'Geplant',umgesetzt:'Umgesetzt',abgelehnt:'Abgelehnt'};
                ideas.forEach(function(i) {
                    var authorName = i.users ? i.users.name : 'Unbekannt';
                    var d = i.created_at ? new Date(i.created_at) : new Date();
                    var datum = d.toLocaleDateString('de-DE');
                    html += '<div class="vit-card p-5 hover:shadow-md transition">';
                    html += '<div class="flex items-start space-x-4">';
                    html += '<div class="text-center flex-shrink-0"><button onclick="voteIdee(\''+i.id+'\')" class="w-12 h-12 rounded-xl bg-gray-100 hover:bg-vit-orange hover:text-white flex items-center justify-center text-lg font-bold text-gray-600 transition">\u25b2</button><span class="text-sm font-bold text-gray-800 block mt-1">' + (i.votes||0) + '</span></div>';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center space-x-2 mb-1"><span class="text-xs font-semibold rounded px-2 py-0.5 ' + (statusColors[i.status]||'bg-gray-100 text-gray-600') + '">' + (statusLabels[i.status]||i.status) + '</span></div>';
                    html += '<h3 class="font-bold text-gray-800 mb-1">' + i.titel + '</h3>';
                    if(i.beschreibung) html += '<p class="text-sm text-gray-600 mb-2">' + i.beschreibung + '</p>';
                    html += '<span class="text-xs text-gray-400">' + authorName + ' \u00b7 ' + datum + '</span>';
                    html += '</div></div></div>';
                });
                if(ideas.length===0) html = '<div class="text-center py-8 text-gray-400">Noch keine Ideen â€“ sei der Erste! \ud83d\udca1</div>';
                container.innerHTML = html;
            } catch(err) { console.error('Ideen:', err); container.innerHTML='<div class="text-center py-4 text-red-400">Fehler: '+err.message+'</div>'; }
        }

        function filterIdeen(filter) {
            document.querySelectorAll('.ideen-filter').forEach(function(b){b.className='ideen-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.ideen-filter[data-f="'+filter+'"]');
            if(btn) btn.className='ideen-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderIdeen(filter);
        }

        async function voteIdee(id) {
            try {
                // Check if it's own idea
                var ideeResp = await sb.from('ideen').select('user_id,votes').eq('id',id).single();
                if(ideeResp.data && ideeResp.data.user_id === sbUser.id) {
                    alert('Du kannst deine eigene Idee nicht bewerten.');
                    return;
                }
                // Check if already voted
                var checkResp = await sb.from('ideen_votes').select('id').eq('idee_id',id).eq('user_id',sbUser.id);
                if(checkResp.data && checkResp.data.length > 0) {
                    alert('Du hast bereits fÃ¼r diese Idee gestimmt!');
                    return;
                }
                // Insert vote
                var voteResp = await sb.from('ideen_votes').insert({idee_id:id, user_id:sbUser.id});
                if(voteResp.error) throw voteResp.error;
                // Increment votes count
                var newVotes = (ideeResp.data.votes||0) + 1;
                await sb.from('ideen').update({votes: newVotes}).eq('id',id);
                renderIdeen('all');
            } catch(err) { 
                if(err.code==='23505') alert('Du hast bereits fÃ¼r diese Idee gestimmt!');
                else { console.error('Vote:', err); alert('Fehler: '+(err.message||err)); }
            }
        }

        async function submitIdee() {
            var titelEl = document.getElementById('ideeTitel');
            var beschEl = document.getElementById('ideeBeschreibung');
            var katEl = document.getElementById('ideeKat');
            var typEl = document.getElementById('ideeTyp');
            if(!titelEl || !titelEl.value.trim()) { alert('Bitte einen Titel eingeben.'); return; }
            try {
                var insertData = {
                    user_id: sbUser.id,
                    standort_id: sbStandort ? sbStandort.id : null,
                    titel: titelEl.value.trim(),
                    beschreibung: beschEl ? beschEl.value.trim() : '',
                    kategorie: katEl ? katEl.value : null,
                    status: 'neu',
                    votes: 0
                };
                var resp = await sb.from('ideen').insert(insertData);
                if(resp.error) throw resp.error;
                if(titelEl) titelEl.value='';
                if(beschEl) beschEl.value='';
                if(katEl) katEl.selectedIndex=0;
                if(typEl) typEl.selectedIndex=0;
                document.getElementById('ideeCreate').classList.add('hidden');
                renderIdeen('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // === HQ STANDORT-DATEN (Netzwerk-weite Kennzahlen) ===
        var hqStandorte = [];

        async function loadHqStandorte() {
            try {
                // Load standorte with their BWA and ticket data
                var sResp = await sb.from('standorte').select('*').order('name');
                if(sResp.error) throw sResp.error;
                var standorte = sResp.data || [];

                // Load BWA data for current year
                var currentYear = new Date().getFullYear();
                var bwaResp = await sb.from('bwa_daten').select('standort_id, monat, umsatzerloese, rohertrag, wareneinsatz, gesamtkosten, ergebnis_vor_steuern').eq('jahr', currentYear);
                var bwaData = bwaResp.data || [];

                // Load open tickets
                var ticketResp = await sb.from('support_tickets').select('standort_id').neq('status','geloest');
                var tickets = ticketResp.data || [];

                // Load leads
                var leadResp = await sb.from('leads').select('standort_id, status, geschaetzter_wert');
                var leads = leadResp.data || [];

                // Load verkauf tracking
                var vtResp = await sb.from('verkauf_tracking').select('standort_id, beratungen, verkauft, umsatz');
                var vtData = vtResp.data || [];

                // Build hqStandorte array matching old structure
                hqStandorte = standorte.map(function(s) {
                    var sBwa = bwaData.filter(function(b) { return b.standort_id === s.id; });
                    var totalUmsatz = sBwa.reduce(function(a, b) { return a + (parseFloat(b.umsatzerloese) || 0); }, 0);
                    var avgRohertrag = sBwa.length ? (sBwa.reduce(function(a, b) { return a + (parseFloat(b.rohertrag) || 0); }, 0) / sBwa.length) : 0;
                    var sTickets = tickets.filter(function(t) { return t.standort_id === s.id; }).length;
                    var sLeads = leads.filter(function(l) { return l.standort_id === s.id; });
                    var sVt = vtData.filter(function(v) { return v.standort_id === s.id; });
                    var totalBeratungen = sVt.reduce(function(a, v) { return a + (v.beratungen || 0); }, 0);
                    var totalVerkauft = sVt.reduce(function(a, v) { return a + (v.verkauft || 0); }, 0);
                    var leadPerf = s.umsatz_plan_ytd ? Math.round(totalUmsatz / s.umsatz_plan_ytd * 100) : 0;

                    var auffaellig = null;
                    if(avgRohertrag > 0 && avgRohertrag < 34) auffaellig = 'Rohertrag unter 34%';
                    if(leadPerf < 50 && leadPerf > 0) auffaellig = (auffaellig ? auffaellig + ', ' : '') + 'Umsatz ' + leadPerf + '% unter Plan';

                    return {
                        id: s.id,
                        name: s.name || 'Unbekannt',
                        inhaber: s.inhaber_name || '(unbekannt)',
                        umsatzPlan: s.umsatz_plan_ytd || 0,
                        umsatzIst: totalUmsatz,
                        rohertrag: parseFloat(avgRohertrag.toFixed(1)),
                        leadPerf: leadPerf,
                        leads: sLeads.length,
                        cpt: sLeads.length > 0 ? Math.round(totalUmsatz / sLeads.length) : 0,
                        budget: s.marketing_budget || 0,
                        vororderStatus: s.vororder_status || 'open',
                        vororderBikes: s.vororder_bikes || 0,
                        rabattQuote: s.rabatt_quote || 0,
                        verkauftKW: totalVerkauft,
                        beratungenKW: totalBeratungen,
                        offeneTickets: sTickets,
                        strategieStatus: s.strategie_status || 'pending',
                        bwaAuffaellig: auffaellig,
                        region: s.region || ''
                    };
                });
            } catch(err) {
                console.warn('HQ Standorte load error:', err);
                // Fallback: empty
                hqStandorte = [];
            }
        }

        function perfColor(p) { return p>=100?'text-green-600':p>=75?'text-green-500':p>=50?'text-yellow-600':'text-red-600'; }
        function perfBg(p) { return p>=100?'bg-green-100 text-green-700':p>=75?'bg-green-50 text-green-600':p>=50?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'; }
        function perfDot(p) { return p>=100?'#FBBF24':p>=75?'#22C55E':p>=50?'#F97316':'#EF4444'; }
        function fmt(n) { return n>=1000 ? Math.round(n/1000)+'k' : n.toLocaleString('de-DE'); }
        function stratBadge(s) { var m={done:'âœ… Vereinbart',pending:'â³ Ausstehend',missing:'âŒ Fehlt',partial:'ðŸ”¶ Teilweise'}; var c={done:'bg-green-100 text-green-700',pending:'bg-yellow-100 text-yellow-700',missing:'bg-red-100 text-red-700',partial:'bg-orange-100 text-orange-700'}; return '<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(c[s]||c.missing)+'">'+(m[s]||'?')+'</span>'; }

        // === HQ COCKPIT ===
        async function renderHqCockpit() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var active = hqStandorte.filter(function(s){return s.umsatzIst>0;});
            var totalUmsatz = hqStandorte.reduce(function(a,s){return a+s.umsatzIst;},0);
            var totalPlan = hqStandorte.reduce(function(a,s){return a+s.umsatzPlan;},0);
            var avgRohertrag = active.length ? (active.reduce(function(a,s){return a+s.rohertrag;},0)/active.length).toFixed(1) : 0;
            var totalLeads = hqStandorte.reduce(function(a,s){return a+s.leads;},0);
            var kritisch = hqStandorte.filter(function(s){return s.leadPerf<50;}).length;
            var tickets = hqStandorte.reduce(function(a,s){return a+s.offeneTickets;},0);

            // KPIs
            var el = document.getElementById('hqKpiCards');
            if(el) el.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Netzwerk-Umsatz YTD</p><p class="text-2xl font-bold text-gray-800">'+fmt(totalUmsatz)+' â‚¬</p><p class="text-xs '+(totalUmsatz>=totalPlan?'text-green-600':'text-red-500')+'">Plan: '+fmt(totalPlan)+' â‚¬</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rohertrag</p><p class="text-2xl font-bold text-gray-800">'+avgRohertrag+'%</p><p class="text-xs text-gray-500">Ziel: â‰¥ 38%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Leads gesamt</p><p class="text-2xl font-bold text-gray-800">'+totalLeads+'</p><p class="text-xs text-gray-500">'+active.length+' aktive Standorte</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Standorte kritisch</p><p class="text-2xl font-bold '+(kritisch>3?'text-red-600':'text-yellow-600')+'">'+kritisch+' / '+hqStandorte.length+'</p><p class="text-xs text-gray-500">Lead-Performance &lt; 50%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Offene Tickets</p><p class="text-2xl font-bold '+(tickets>10?'text-red-600':'text-gray-800')+'">'+tickets+'</p><p class="text-xs text-gray-500">Netzwerk-weit</p></div>';

            // Alert box
            var alerts = hqStandorte.filter(function(s){return s.bwaAuffaellig;});
            var ab = document.getElementById('hqAlertBox');
            if(ab) {
                var ah = '<div class="flex items-center space-x-2 mb-2"><span class="text-lg">ðŸš¨</span><span class="font-bold text-red-700">'+alerts.length+' Standorte mit Handlungsbedarf</span></div>';
                ah += '<div class="flex flex-wrap gap-2">';
                alerts.forEach(function(s){ ah += '<span class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded-lg"><strong>'+s.name+':</strong> '+s.bwaAuffaellig+'</span>'; });
                ah += '</div>';
                ab.innerHTML = ah;
            }

            // Top 5
            var sorted = hqStandorte.slice().sort(function(a,b){return b.leadPerf-a.leadPerf;});
            var t5 = document.getElementById('hqTop5');
            if(t5) {
                var th = '';
                sorted.slice(0,5).forEach(function(s,i){
                    th += '<div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg"><span class="text-lg font-bold text-gray-300 w-6">'+(i+1)+'</span><div class="flex-1"><p class="text-sm font-semibold">'+s.name+'</p><p class="text-xs text-gray-400">'+s.inhaber+'</p></div><div class="text-right"><p class="font-bold '+perfColor(s.leadPerf)+'">'+s.leadPerf+'%</p><p class="text-xs text-gray-400">'+fmt(s.umsatzIst)+' â‚¬ Umsatz</p></div></div>';
                });
                t5.innerHTML = th;
            }

            // Bottom 5
            var b5 = document.getElementById('hqBottom5');
            if(b5) {
                var bh = '';
                sorted.slice(-5).reverse().forEach(function(s){
                    bh += '<div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg"><span class="text-lg">âš ï¸</span><div class="flex-1"><p class="text-sm font-semibold text-red-700">'+s.name+'</p><p class="text-xs text-red-500">'+(s.bwaAuffaellig||'Lead-Performance kritisch')+'</p></div><div class="text-right"><p class="font-bold text-red-600">'+s.leadPerf+'%</p><button class="text-[10px] px-2 py-1 bg-red-600 text-white rounded mt-1" onclick="alert(\'Standort '+s.name+' wird geoeffnet\')">Details â†’</button></div></div>';
                });
                b5.innerHTML = bh;
            }

            // Grid
            var grid = document.getElementById('hqStandortGrid');
            if(grid) {
                var gh = '';
                sorted.forEach(function(s){
                    gh += '<div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:shadow-md transition" onclick="alert(\'Standort '+s.name+' oeffnen\')">'
                        +'<div class="flex items-center justify-center space-x-1 mb-1"><span style="width:10px;height:10px;border-radius:50%;background:'+perfDot(s.leadPerf)+';display:inline-block;"></span><span class="text-xs font-semibold text-gray-700 truncate">'+s.name+'</span></div>'
                        +'<span class="text-sm font-bold text-gray-800">'+s.leadPerf+'%</span>'
                        +'</div>';
                });
                grid.innerHTML = gh;
            }

            // === HOME WIDGETS (rechte Spalte) ===
            // Aktive Kampagnen kompakt
            var hkEl = document.getElementById('hqHomeKampagnen');
            if(hkEl && typeof hqKampagnen !== 'undefined') {
                var hkh = '';
                hqKampagnen.filter(function(k){return k.status==='aktiv';}).forEach(function(k){
                    var pct = k.standorte ? Math.round(k.umgesetzt/k.standorte*100) : 0;
                    hkh += '<div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">';
                    hkh += '<div class="flex-1 min-w-0"><p class="text-xs font-semibold text-gray-800 truncate">'+k.name+'</p>';
                    hkh += '<div class="w-full bg-gray-200 rounded-full h-1.5 mt-1"><div class="h-1.5 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-400')+'" style="width:'+pct+'%"></div></div></div>';
                    hkh += '<span class="text-xs font-bold '+(pct>=80?'text-green-600':'text-orange-500')+'">'+pct+'%</span>';
                    hkh += '</div>';
                });
                if(!hkh) hkh = '<p class="text-xs text-gray-400">Keine aktiven Kampagnen</p>';
                hkEl.innerHTML = hkh;
            }

            // Offene Aufgaben kompakt
            var haEl = document.getElementById('hqHomeAufgaben');
            if(haEl && typeof hqTasks !== 'undefined') {
                var hah = '';
                var prioIcons = {hoch:'ðŸ”´',mittel:'ðŸŸ¡',niedrig:'ðŸŸ¢'};
                hqTasks.filter(function(t){return t.status!=='done';}).sort(function(a,b){var po={hoch:0,mittel:1,niedrig:2};return (po[a.prio]||1)-(po[b.prio]||1);}).slice(0,5).forEach(function(t){
                    var pct = Math.round(t.done/t.total*100);
                    hah += '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-lg">';
                    hah += '<span class="text-xs">'+(prioIcons[t.prio]||'')+'</span>';
                    hah += '<div class="flex-1 min-w-0"><p class="text-[11px] font-semibold text-gray-800 truncate">'+t.title+'</p>';
                    hah += '<p class="text-[9px] text-gray-400">Frist: '+t.deadline+' Â· '+pct+'% erledigt</p></div>';
                    hah += '</div>';
                });
                if(!hah) hah = '<p class="text-xs text-gray-400 text-center">Alles erledigt! âœ…</p>';
                haEl.innerHTML = hah;
            }

            // Naechste Termine kompakt
            var htEl = document.getElementById('hqHomeTermine');
            if(htEl && typeof hqKalTermine !== 'undefined') {
                var hth = '';
                var typeIcons = {schulung:'ðŸŽ“',event:'ðŸŽª',deadline:'â°',meeting:'ðŸ¤'};
                hqKalTermine.filter(function(t){return t.date>='2026-02-14';}).sort(function(a,b){return a.date>b.date?1:-1;}).slice(0,5).forEach(function(t){
                    hth += '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded-lg">';
                    hth += '<span class="text-sm">'+(typeIcons[t.type]||'ðŸ“…')+'</span>';
                    hth += '<div class="flex-1 min-w-0"><p class="text-[11px] font-semibold text-gray-800 truncate">'+t.title+'</p>';
                    hth += '<p class="text-[9px] text-gray-400">'+t.date+' Â· '+t.time+' Uhr'+(t.pflicht?' Â· <span class="text-red-500">PFLICHT</span>':'')+'</p></div>';
                    hth += '</div>';
                });
                if(!hth) hth = '<p class="text-xs text-gray-400 text-center">Keine Termine</p>';
                htEl.innerHTML = hth;
            }

            // Letzte Ankuendigungen kompakt
            var aaEl = document.getElementById('hqHomeAnnounce');
            if(aaEl && typeof hqAnnouncements !== 'undefined') {
                var aah = '';
                hqAnnouncements.slice(0,3).forEach(function(a){
                    var readPct = Math.round(a.read/a.total*100);
                    aah += '<div class="p-2 bg-gray-50 rounded-lg">';
                    aah += '<p class="text-[11px] font-semibold text-gray-800 truncate">'+a.title+'</p>';
                    aah += '<div class="flex items-center justify-between mt-1"><p class="text-[9px] text-gray-400">'+a.date+' Â· '+a.author+'</p>';
                    aah += '<span class="text-[9px] font-bold '+(readPct>=90?'text-green-600':'text-orange-500')+'">'+a.read+'/'+a.total+' gelesen</span></div>';
                    aah += '</div>';
                });
                aaEl.innerHTML = aah;
            }
        }

        // === HQ STANDORTE (Detailliste) ===
        async function renderHqStandorte() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var search = (document.getElementById('hqStandortSearch')||{}).value||'';
            var filter = (document.getElementById('hqStandortFilter')||{}).value||'all';
            var list = hqStandorte.filter(function(s){
                if(search && s.name.toLowerCase().indexOf(search.toLowerCase())===-1) return false;
                if(filter==='kritisch' && s.leadPerf>=50) return false;
                if(filter==='achtung' && (s.leadPerf<50||s.leadPerf>=75)) return false;
                if(filter==='gut' && (s.leadPerf<75||s.leadPerf>=100)) return false;
                if(filter==='top' && s.leadPerf<100) return false;
                return true;
            });
            list.sort(function(a,b){return b.leadPerf-a.leadPerf;});
            var el = document.getElementById('hqStandorteList');
            if(!el) return;
            var h = '';
            list.forEach(function(s) {
                h += '<div class="vit-card p-5 hover:shadow-md transition">';
                h += '<div class="flex items-center justify-between mb-3">';
                h += '<div><h3 class="font-bold text-gray-800">'+s.name+'</h3><p class="text-xs text-gray-400">'+s.inhaber+' Â· Region: '+s.region+'</p></div>';
                h += '<div class="flex items-center space-x-3">';
                h += stratBadge(s.strategieStatus);
                h += '<span class="'+perfBg(s.leadPerf)+' text-xs px-3 py-1 rounded-full font-bold">'+s.leadPerf+'% Lead-Perf.</span>';
                h += '</div></div>';
                h += '<div class="grid grid-cols-3 md:grid-cols-6 gap-3">';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Umsatz</p><p class="text-sm font-bold">'+fmt(s.umsatzIst)+' â‚¬</p><p class="text-[10px] '+(s.umsatzIst>=s.umsatzPlan?'text-green-500':'text-red-500')+'">Plan: '+fmt(s.umsatzPlan)+'</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Rohertrag</p><p class="text-sm font-bold '+(s.rohertrag>=38?'text-green-600':'text-red-500')+'">'+s.rohertrag+'%</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Leads</p><p class="text-sm font-bold">'+s.leads+'</p><p class="text-[10px] text-gray-400">CPT: '+s.cpt+' â‚¬</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Rabattquote</p><p class="text-sm font-bold '+(s.rabattQuote<=5?'text-green-600':s.rabattQuote<=8?'text-yellow-600':'text-red-500')+'">'+s.rabattQuote+'%</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Vororder</p><p class="text-sm font-bold">'+(s.vororderBikes||'â€”')+' Bikes</p></div>';
                h += '<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-400">Tickets</p><p class="text-sm font-bold '+(s.offeneTickets>2?'text-red-500':'text-gray-700')+'">'+s.offeneTickets+'</p></div>';
                h += '</div>';
                if(s.bwaAuffaellig) h += '<div class="mt-3 p-2 bg-red-50 rounded text-xs text-red-600">âš ï¸ '+s.bwaAuffaellig+'</div>';
                h += '<div class="mt-3 pt-3 border-t border-gray-100 flex justify-end"><button onclick="hqDrillDown(\''+s.name.toLowerCase().replace(/[^a-z]/g,'').substring(0,8)+'\')" class="text-xs text-vit-orange hover:text-orange-600 font-semibold flex items-center space-x-1"><span>Standort oeffnen</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button></div>';
                h += '</div>';
            });
            if(!list.length) h = '<div class="text-center py-12 text-gray-400">Keine Standorte gefunden</div>';
            el.innerHTML = h;
        }

        // === HQ FINANZEN ===
        async function renderHqFinanzen() {
            if(hqStandorte.length === 0) await loadHqStandorte();
            var active = hqStandorte.filter(function(s){return s.umsatzIst>0;});
            var totalU = hqStandorte.reduce(function(a,s){return a+s.umsatzIst;},0);
            var totalP = hqStandorte.reduce(function(a,s){return a+s.umsatzPlan;},0);
            var avgRoh = active.length?(active.reduce(function(a,s){return a+s.rohertrag;},0)/active.length).toFixed(1):0;
            var avgRab = active.length?(active.reduce(function(a,s){return a+s.rabattQuote;},0)/active.length).toFixed(1):0;

            var kpi = document.getElementById('hqFinKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Netzwerk-Umsatz</p><p class="text-2xl font-bold">'+fmt(totalU)+' â‚¬</p><p class="text-xs '+(totalU>=totalP?'text-green-500':'text-red-500')+'">Plan: '+fmt(totalP)+' â‚¬</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rohertrag</p><p class="text-2xl font-bold '+(avgRoh>=38?'text-green-600':'text-red-500')+'">'+avgRoh+'%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rabattquote</p><p class="text-2xl font-bold '+(avgRab<=5?'text-green-600':'text-red-500')+'">'+avgRab+'%</p><p class="text-xs text-gray-500">Ziel: unter 5%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">BWA-Auffaelligkeiten</p><p class="text-2xl font-bold text-red-600">'+hqStandorte.filter(function(s){return s.bwaAuffaellig;}).length+'</p></div>';

            // Table
            var t = document.getElementById('hqFinTable');
            if(t) {
                var th = '<thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-2 text-xs text-gray-500">Standort</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz Plan</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz Ist</th><th class="text-right py-2 px-2 text-xs text-gray-500">Abw.</th><th class="text-right py-2 px-2 text-xs text-gray-500">Rohertrag</th><th class="text-right py-2 px-2 text-xs text-gray-500">Rabatt %</th><th class="text-center py-2 px-2 text-xs text-gray-500">BWA</th></tr></thead><tbody>';
                hqStandorte.slice().sort(function(a,b){return b.umsatzIst-a.umsatzIst;}).forEach(function(s){
                    var abw = s.umsatzPlan?Math.round((s.umsatzIst/s.umsatzPlan-1)*100):0;
                    th += '<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="py-2 px-2 text-sm font-semibold">'+s.name+'</td><td class="py-2 px-2 text-sm text-right text-gray-500">'+fmt(s.umsatzPlan)+'</td><td class="py-2 px-2 text-sm text-right font-semibold">'+fmt(s.umsatzIst)+'</td><td class="py-2 px-2 text-sm text-right font-bold '+(abw>=0?'text-green-600':'text-red-500')+'">'+(abw>=0?'+':'')+abw+'%</td><td class="py-2 px-2 text-sm text-right '+(s.rohertrag>=38?'text-green-600':'text-red-500')+'">'+s.rohertrag+'%</td><td class="py-2 px-2 text-sm text-right '+(s.rabattQuote<=5?'text-green-600':s.rabattQuote<=8?'text-yellow-600':'text-red-500')+'">'+s.rabattQuote+'%</td><td class="py-2 px-2 text-center">'+(s.bwaAuffaellig?'<span class="text-xs text-red-500">âš ï¸</span>':'<span class="text-xs text-green-500">âœ“</span>')+'</td></tr>';
                });
                th += '</tbody>';
                t.innerHTML = th;
            }

            // Alerts
            var al = document.getElementById('hqFinAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.bwaAuffaellig;}).sort(function(a,b){return a.rohertrag-b.rohertrag;}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg flex items-center justify-between"><div><p class="text-sm font-semibold text-red-700">'+s.name+'</p><p class="text-xs text-red-500">'+s.bwaAuffaellig+'</p></div><span class="text-xs text-gray-400">Rohertrag: '+s.rohertrag+'%</span></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Keine Auffaelligkeiten</p>';
            }

            // Rohertrag Ranking
            var rr = document.getElementById('hqFinRohertrag');
            if(rr) {
                var rrh = '';
                hqStandorte.filter(function(s){return s.umsatzIst>0;}).sort(function(a,b){return b.rohertrag-a.rohertrag;}).forEach(function(s){
                    var w = Math.max(5, s.rohertrag * 2);
                    rrh += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-4"><div class="h-4 rounded-full '+(s.rohertrag>=38?'bg-green-500':s.rohertrag>=34?'bg-yellow-500':'bg-red-500')+'" style="width:'+w+'%"></div></div><span class="text-xs font-bold w-12 text-right">'+s.rohertrag+'%</span></div>';
                });
                rr.innerHTML = rrh;
            }
        }

        // === HQ MARKETING ===
        function renderHqMarketing() {
            var active = hqStandorte.filter(function(s){return s.leads>0;});
            var totalLeads = hqStandorte.reduce(function(a,s){return a+s.leads;},0);
            var totalBudget = hqStandorte.reduce(function(a,s){return a+s.budget;},0);
            var avgCpt = active.length?Math.round(active.reduce(function(a,s){return a+s.cpt;},0)/active.length):0;
            var avgPerf = active.length?Math.round(active.reduce(function(a,s){return a+s.leadPerf;},0)/active.length):0;
            var stratDone = hqStandorte.filter(function(s){return s.strategieStatus==='done';}).length;

            var kpi = document.getElementById('hqMktKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-4"><p class="text-xs text-gray-400">Leads gesamt</p><p class="text-xl font-bold">'+totalLeads+'</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Budget/Monat</p><p class="text-xl font-bold">'+fmt(totalBudget)+' â‚¬</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Ã˜ CPT</p><p class="text-xl font-bold">'+avgCpt+' â‚¬</p><p class="text-[10px] text-gray-400">Ziel: &lt;163 â‚¬</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Ã˜ Lead-Perf.</p><p class="text-xl font-bold '+perfColor(avgPerf)+'">'+avgPerf+'%</p></div>'
                +'<div class="vit-card p-4"><p class="text-xs text-gray-400">Strategie vereinbart</p><p class="text-xl font-bold">'+stratDone+' / '+hqStandorte.length+'</p></div>';

            // Lead Performance
            var lp = document.getElementById('hqMktLeads');
            if(lp) {
                var lph = '';
                hqStandorte.slice().sort(function(a,b){return b.leadPerf-a.leadPerf;}).forEach(function(s){
                    var w = Math.min(100, s.leadPerf);
                    lph += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full" style="width:'+w+'%;background:'+perfDot(s.leadPerf)+'"></div></div><span class="text-xs font-bold w-10 text-right">'+s.leadPerf+'%</span></div>';
                });
                lp.innerHTML = lph;
            }

            // Strategie Status
            var ms = document.getElementById('hqMktStrategie');
            if(ms) {
                var msh = '';
                hqStandorte.forEach(function(s){
                    msh += '<div class="flex items-center justify-between py-1"><span class="text-xs">'+s.name+'</span>'+stratBadge(s.strategieStatus)+'</div>';
                });
                ms.innerHTML = msh;
            }

            // Alerts
            var ma = document.getElementById('hqMktAlerts');
            if(ma) {
                var mah = '';
                hqStandorte.filter(function(s){return s.leadPerf<50;}).sort(function(a,b){return a.leadPerf-b.leadPerf;}).forEach(function(s){
                    mah += '<div class="p-3 bg-red-50 rounded-lg"><div class="flex justify-between"><span class="text-sm font-semibold text-red-700">'+s.name+' â€“ '+s.leadPerf+'% Lead-Performance</span><span class="text-xs text-gray-400">CPT: '+s.cpt+' â‚¬</span></div><p class="text-xs text-red-500 mt-1">Budget: '+s.budget+' â‚¬/Monat Â· '+s.leads+' Leads Â· '+(s.strategieStatus==='missing'?'âŒ Keine Strategie vereinbart':'Strategie: '+s.strategieStatus)+'</p></div>';
                });
                hqStandorte.filter(function(s){return s.strategieStatus==='missing';}).forEach(function(s){
                    if(s.leadPerf>=50) mah += '<div class="p-3 bg-yellow-50 rounded-lg"><span class="text-sm font-semibold text-yellow-700">'+s.name+' â€“ Marketing-Strategie fehlt</span></div>';
                });
                ma.innerHTML = mah || '<p class="text-sm text-green-600">âœ… Alle Standorte im gruenen Bereich</p>';
            }
        }

        // === HQ MARKETING TABS ===
        function showHqMktTab(tabName) {
            document.querySelectorAll('.hqmkt-tab-content').forEach(function(t){t.style.display='none';});
            document.querySelectorAll('.hqmkt-tab-btn').forEach(function(b){b.className='hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';});
            var el=document.getElementById('hqMktTab'+tabName.charAt(0).toUpperCase()+tabName.slice(1));
            if(el) el.style.display='block';
            var btn=document.querySelector('.hqmkt-tab-btn[data-hqmkt="'+tabName+'"]');
            if(btn) btn.className='hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tabName==='budgetsteuerung') renderHqMktBudget();
            if(tabName==='leadreport') renderHqMktLeadReport();
            if(tabName==='jahresgespraeche') renderHqMktJahresgespraeche();
            if(tabName==='handlungsbedarf') renderHqMktHandlungsbedarf();
        }

        function renderHqMktBudget() {
            var tb=document.getElementById('hqMktBudgetTable');
            if(!tb||tb.children.length>0) return;
            var data=[
                {name:'Berlin-Brandenburg',plz:'14513',st:'Aktiv',gBud:2800,gAusg:539,gHoch:-944,mBud:700,mAusg:56,mHoch:-97},
                {name:'Garching a.d. Alz',plz:'84518',st:'Aktiv',gBud:1152,gAusg:397,gHoch:-695,mBud:288,mAusg:57,mHoch:-99},
                {name:'Grafrath',plz:'82284',st:'Aktiv',gBud:1152,gAusg:302,gHoch:-529,mBud:280,mAusg:111,mHoch:-195},
                {name:'Gunzenhausen',plz:'91710',st:'Aktiv',gBud:1382,gAusg:0,gHoch:0,mBud:346,mAusg:0,mHoch:0},
                {name:'Hamburg',plz:'22761',st:'Aktiv',gBud:3072,gAusg:801,gHoch:-1500,mBud:768,mAusg:113,mHoch:-188},
                {name:'Hann Muenden',plz:'34346',st:'Aktiv',gBud:1152,gAusg:260,gHoch:-455,mBud:280,mAusg:0,mHoch:0},
                {name:'Holzkirchen',plz:'83607',st:'Aktiv',gBud:1536,gAusg:410,gHoch:-734,mBud:384,mAusg:111,mHoch:-194},
                {name:'Karlsdorf-Neuthard',plz:'76689',st:'Aktiv',gBud:1042,gAusg:567,gHoch:-993,mBud:261,mAusg:113,mHoch:-198},
                {name:'Limburg',plz:'65552',st:'Aktiv',gBud:1382,gAusg:419,gHoch:-734,mBud:346,mAusg:0,mHoch:0},
                {name:'Muenchen TK',plz:'81379',st:'Aktiv',gBud:1200,gAusg:273,gHoch:-479,mBud:300,mAusg:22,mHoch:-38},
                {name:'Muenster',plz:'48159',st:'Aktiv',gBud:1536,gAusg:331,gHoch:-579,mBud:384,mAusg:146,mHoch:-255},
                {name:'Pfaffenhofen a.d. Ilm',plz:'85276',st:'Aktiv',gBud:2074,gAusg:521,gHoch:-912,mBud:518,mAusg:110,mHoch:-192},
                {name:'Reutlingen',plz:'72793',st:'Aktiv',gBud:922,gAusg:209,gHoch:-366,mBud:230,mAusg:114,mHoch:-199},
                {name:'Rottweil',plz:'78628',st:'Aktiv',gBud:1152,gAusg:225,gHoch:-994,mBud:288,mAusg:182,mHoch:-318},
                {name:'Witten',plz:'58455',st:'Aktiv',gBud:2304,gAusg:513,gHoch:-887,mBud:576,mAusg:111,mHoch:-194}
            ];
            var h='';
            data.forEach(function(r,i){
                h+='<tr class="border-b'+(i%2?' bg-gray-50':'')+'"><td class="py-1.5 px-2 font-semibold">'+r.name+'<br><span class="text-gray-400">'+r.plz+'</span></td><td class="py-1.5 px-2 text-center"><span class="px-1.5 py-0.5 rounded-full text-[10px] bg-green-100 text-green-700">'+r.st+'</span></td><td class="py-1.5 px-2 text-right font-semibold text-yellow-600">'+fmt(r.gBud)+' â‚¬</td><td class="py-1.5 px-2 text-right">'+fmt(r.gAusg)+' â‚¬</td><td class="py-1.5 px-2 text-right text-red-500">'+fmt(r.gHoch)+'</td><td class="py-1.5 px-2 text-right font-semibold text-blue-600">'+fmt(r.mBud)+' â‚¬</td><td class="py-1.5 px-2 text-right">'+fmt(r.mAusg)+' â‚¬</td><td class="py-1.5 px-2 text-right text-red-500">'+fmt(r.mHoch)+'</td></tr>';
            });
            h+='<tr class="bg-gray-100 border-t-2 font-bold"><td class="py-2 px-2">Summe Februar</td><td></td><td class="py-2 px-2 text-right text-yellow-600">29.960 â‚¬</td><td class="py-2 px-2 text-right">8.133 â‚¬</td><td class="py-2 px-2 text-right text-red-500">-14.232 â‚¬</td><td class="py-2 px-2 text-right text-blue-600">7.490 â‚¬</td><td class="py-2 px-2 text-right">1.966 â‚¬</td><td class="py-2 px-2 text-right text-red-500">-3.441 â‚¬</td></tr>';
            tb.innerHTML=h;
        }

        function renderHqMktLeadReport() {
            var el=document.getElementById('hqMktLeadRanking');
            if(!el||el.children.length>0) return;
            var sorted=hqStandorte.slice().sort(function(a,b){return b.leads-a.leads;});
            var h='';
            sorted.forEach(function(s,i){
                var perf=s.leadPerf; var pCol=perf>=80?'bg-green-500':perf>=50?'bg-yellow-500':'bg-red-500';
                h+='<div class="flex items-center space-x-3 py-2 border-b border-gray-50"><span class="text-xs font-bold text-gray-400 w-6">#'+(i+1)+'</span><span class="text-xs w-32 truncate font-semibold">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full '+pCol+'" style="width:'+Math.min(100,perf)+'%"></div></div><span class="text-xs font-bold w-10 text-right">'+s.leads+'</span><span class="text-xs w-16 text-right '+perfColor(perf)+'">'+perf+'%</span><span class="text-xs w-16 text-right text-gray-400">CPT '+s.cpt+'â‚¬</span></div>';
            });
            el.innerHTML=h;
        }

        function renderHqMktJahresgespraeche() {
            var el=document.getElementById('hqMktJgTable');
            if(!el||el.children.length>0) return;
            var data=[
                {standort:'Grafrath',inhaber:'Sandra E.',ap:'Michael Stenzel',budget:1500,mix:'Meta+Google',crm:'âœ…',status:'done'},
                {standort:'Holzkirchen',inhaber:'Dirk Kolditz',ap:'Michael Stenzel',budget:2000,mix:'Meta+Google+Events',crm:'âœ…',status:'done'},
                {standort:'Hamburg',inhaber:'Thorsten B.',ap:'Michael Stenzel',budget:3072,mix:'Meta+Google',crm:'âœ…',status:'done'},
                {standort:'Muenster',inhaber:'Wolfgang P.',ap:'Michael Stenzel',budget:1536,mix:'Meta+Google',crm:'â€”',status:'done'},
                {standort:'Witten',inhaber:'Monique S.',ap:'Michael Stenzel',budget:2304,mix:'Meta+Google',crm:'âœ…',status:'done'},
                {standort:'Pfaffenhofen',inhaber:'Sabrina H.',ap:'Michael Stenzel',budget:2074,mix:'Meta+Google',crm:'âœ…',status:'done'},
                {standort:'Berlin-Brandenb.',inhaber:'Sven T.',ap:'Michael Stenzel',budget:2800,mix:'Meta+Google',crm:'â€”',status:'done'},
                {standort:'Kalkar',inhaber:'â€”',ap:'Michael Stenzel',budget:0,mix:'â€”',crm:'â€”',status:'missing'},
                {standort:'Wesel',inhaber:'â€”',ap:'Michael Stenzel',budget:0,mix:'â€”',crm:'â€”',status:'missing'},
                {standort:'Zell',inhaber:'â€”',ap:'Michael Stenzel',budget:0,mix:'â€”',crm:'â€”',status:'missing'}
            ];
            var h='';
            data.forEach(function(r,i){
                var sc={done:'bg-green-100 text-green-700',partial:'bg-yellow-100 text-yellow-700',missing:'bg-red-100 text-red-700'};
                var sl={done:'âœ… Vereinbart',partial:'ðŸ”¶ In Abstimmung',missing:'âŒ Ausstehend'};
                h+='<tr class="border-b'+(i%2?' bg-gray-50':'')+'"><td class="py-1.5 px-2 font-semibold">'+r.standort+'</td><td class="py-1.5 px-2">'+r.inhaber+'</td><td class="py-1.5 px-2">'+r.ap+'</td><td class="py-1.5 px-2 text-right font-semibold">'+(r.budget?fmt(r.budget)+' â‚¬':'â€”')+'</td><td class="py-1.5 px-2">'+r.mix+'</td><td class="py-1.5 px-2 text-center">'+r.crm+'</td><td class="py-1.5 px-2 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-semibold '+(sc[r.status]||sc.missing)+'">'+(sl[r.status]||'?')+'</span></td></tr>';
            });
            el.innerHTML=h;
        }

        function renderHqMktHandlungsbedarf() {
            var el=document.getElementById('hqMktAlertsFull');
            if(!el||el.children.length>0) return;
            var alerts=[];
            hqStandorte.forEach(function(s){
                if(s.leadPerf<30) alerts.push({prio:'kritisch',icon:'ðŸ”´',title:s.name+' â€“ Nur '+s.leadPerf+'% Lead-Performance',desc:'Budget: '+s.budget+' â‚¬/Mo Â· '+s.leads+' Leads Â· CPT: '+s.cpt+' â‚¬ Â· Dringend Gespraech fuehren',color:'bg-red-50 border-red-200'});
                else if(s.leadPerf<50) alerts.push({prio:'warnung',icon:'ðŸŸ¡',title:s.name+' â€“ '+s.leadPerf+'% Lead-Performance',desc:'Unter Ziel. Budget-Optimierung pruefen. CPT: '+s.cpt+' â‚¬',color:'bg-yellow-50 border-yellow-200'});
                if(s.strategieStatus==='missing') alerts.push({prio:'kritisch',icon:'ðŸ“‹',title:s.name+' â€“ Keine Marketing-Strategie vereinbart',desc:'Jahresgespraech muss noch terminiert werden',color:'bg-red-50 border-red-200'});
            });
            alerts.push({prio:'info',icon:'ðŸ’°',title:'3 Standorte Ã¼ber Budget im Februar',desc:'Grafrath (+224â‚¬), Rottweil (+318â‚¬), Lohmar (+342â‚¬) â€“ Channel-Split prÃ¼fen',color:'bg-blue-50 border-blue-200'});
            alerts.push({prio:'info',icon:'ðŸŽ¬',title:'13 Standorte ohne Local Hero Video',desc:'Social-Media-Aktivierung pushen. Naechster Content-Drop: KW 9',color:'bg-blue-50 border-blue-200'});
            var h='';
            alerts.sort(function(a,b){var p={kritisch:0,warnung:1,info:2};return (p[a.prio]||9)-(p[b.prio]||9);});
            alerts.forEach(function(a){
                h+='<div class="p-4 rounded-lg border '+a.color+'"><div class="flex items-start space-x-3"><span class="text-lg">'+a.icon+'</span><div><p class="text-sm font-semibold text-gray-800">'+a.title+'</p><p class="text-xs text-gray-500 mt-1">'+a.desc+'</p></div></div></div>';
            });
            el.innerHTML=h||'<p class="text-sm text-green-600">âœ… Keine offenen Punkte</p>';
            var krit=alerts.filter(function(a){return a.prio==='kritisch';}).length;
            var warn=alerts.filter(function(a){return a.prio==='warnung';}).length;
            var info=alerts.filter(function(a){return a.prio==='info';}).length;
            var ok=hqStandorte.length-krit-warn;
            var setVal=function(id,v){var e=document.getElementById(id);if(e)e.textContent=v;};
            setVal('hqMktAlertKrit',krit); setVal('hqMktAlertWarn',warn); setVal('hqMktAlertInfo',info); setVal('hqMktAlertOk',Math.max(0,ok));
        }

        function renderMktSpendingChart() {
            var el=document.getElementById('mktSpendingChart');
            if(!el||el.children.length>0) return;
            var days=[{d:'01',g:42,m:10},{d:'02',g:38,m:9},{d:'03',g:45,m:11},{d:'04',g:51,m:12},{d:'05',g:48,m:10},{d:'06',g:55,m:13},{d:'07',g:60,m:14},{d:'08',g:43,m:10},{d:'09',g:52,m:12},{d:'10',g:47,m:11},{d:'11',g:58,m:13},{d:'12',g:62,m:15},{d:'13',g:50,m:12},{d:'14',g:45,m:10},{d:'15',g:0,m:0},{d:'16',g:0,m:0}];
            var max=80;var h='';
            days.forEach(function(d){
                var gH=Math.round((d.g/max)*100);var mH=Math.round((d.m/max)*100);
                h+='<div class="flex-1 flex flex-col items-center justify-end space-y-0.5"><div class="w-full bg-yellow-400 rounded-t" style="height:'+gH+'%"></div><div class="w-full bg-blue-400 rounded-t" style="height:'+mH+'%"></div><span class="text-[8px] text-gray-400">'+d.d+'</span></div>';
            });
            el.innerHTML=h;
        }

        function renderMktLeadChart() {
            var el=document.getElementById('mktLeadChart');
            if(!el||el.children.length>0) return;
            var months=[{m:'Jan',ist:5,soll:4},{m:'Feb',ist:4,soll:9},{m:'Mrz',ist:0,soll:11},{m:'Apr',ist:0,soll:12},{m:'Mai',ist:0,soll:13},{m:'Jun',ist:0,soll:12},{m:'Jul',ist:0,soll:12},{m:'Aug',ist:0,soll:11},{m:'Sep',ist:0,soll:10},{m:'Okt',ist:0,soll:7},{m:'Nov',ist:0,soll:5},{m:'Dez',ist:0,soll:3}];
            var max=15;var h='';
            months.forEach(function(d){
                var iH=Math.round((d.ist/max)*100);var sH=Math.round((d.soll/max)*100);
                h+='<div class="flex-1 flex flex-col items-center justify-end space-x-0"><div class="flex space-x-0.5 w-full items-end" style="height:100%"><div class="flex-1 bg-vit-orange rounded-t transition-all" style="height:'+iH+'%"></div><div class="flex-1 bg-gray-200 rounded-t" style="height:'+sH+'%"></div></div><span class="text-[8px] text-gray-400 mt-1">'+d.m+'</span></div>';
            });
            el.innerHTML=h;
        }
        function renderHqEinkauf() {
            var totalVO = hqStandorte.reduce(function(a,s){return a+s.vororderBikes;},0);
            var voDone = hqStandorte.filter(function(s){return s.vororderStatus==='done';}).length;
            var voOpen = hqStandorte.filter(function(s){return s.vororderStatus==='open';}).length;
            var avgRab = (hqStandorte.filter(function(s){return s.rabattQuote>0;}).reduce(function(a,s){return a+s.rabattQuote;},0)/hqStandorte.filter(function(s){return s.rabattQuote>0;}).length).toFixed(1);

            var kpi = document.getElementById('hqEkKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder Bikes gesamt</p><p class="text-2xl font-bold">'+totalVO+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder abgeschlossen</p><p class="text-2xl font-bold text-green-600">'+voDone+' / '+hqStandorte.length+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Vororder offen</p><p class="text-2xl font-bold '+(voOpen>3?'text-red-600':'text-yellow-600')+'">'+voOpen+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Ã˜ Rabattquote</p><p class="text-2xl font-bold '+(avgRab<=5?'text-green-600':'text-red-500')+'">'+avgRab+'%</p><p class="text-xs text-gray-500">Ziel: unter 5%</p></div>';

            // Vororder
            var vo = document.getElementById('hqEkVororder');
            if(vo) {
                var voh = '';
                hqStandorte.forEach(function(s){
                    var vc = {done:'bg-green-100 text-green-700',partial:'bg-yellow-100 text-yellow-700',open:'bg-red-100 text-red-700'};
                    var vl = {done:'âœ… Abgeschlossen',partial:'ðŸ”¶ Teilweise',open:'âŒ Offen'};
                    voh += '<div class="flex items-center justify-between py-1.5 border-b border-gray-50"><span class="text-xs w-28 truncate font-semibold">'+s.name+'</span><span class="text-xs">'+(s.vororderBikes||'â€”')+' Bikes</span><span class="text-[10px] px-2 py-0.5 rounded-full '+(vc[s.vororderStatus]||vc.open)+'">'+(vl[s.vororderStatus]||'?')+'</span></div>';
                });
                vo.innerHTML = voh;
            }

            // Rohertrag
            var rr = document.getElementById('hqEkRohertrag');
            if(rr) {
                var rrh = '';
                hqStandorte.filter(function(s){return s.rohertrag>0;}).sort(function(a,b){return b.rohertrag-a.rohertrag;}).forEach(function(s){
                    rrh += '<div class="flex items-center space-x-2"><span class="text-xs w-28 truncate">'+s.name+'</span><div class="flex-1 bg-gray-100 rounded-full h-3"><div class="h-3 rounded-full '+(s.rohertrag>=38?'bg-green-500':s.rohertrag>=34?'bg-yellow-500':'bg-red-500')+'" style="width:'+Math.max(5,s.rohertrag*2)+'%"></div></div><span class="text-xs font-bold w-12 text-right">'+s.rohertrag+'%</span></div>';
                });
                rr.innerHTML = rrh;
            }

            // Alerts
            var al = document.getElementById('hqEkAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.vororderStatus==='open';}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg mb-2"><span class="text-sm font-semibold text-red-700">âŒ '+s.name+' â€“ Keine Vororder platziert</span><p class="text-xs text-red-500">Dringend Gespraech mit Inhaber fuehren</p></div>';
                });
                hqStandorte.filter(function(s){return s.rabattQuote>8;}).forEach(function(s){
                    alh += '<div class="p-3 bg-yellow-50 rounded-lg mb-2"><span class="text-sm font-semibold text-yellow-700">âš ï¸ '+s.name+' â€“ Rabattquote '+s.rabattQuote+'%</span><p class="text-xs text-yellow-600">Ziel unter 5%. Schulung Dreingaben vs. Rabatte empfohlen.</p></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Alle Standorte im gruenen Bereich</p>';
            }
        }

        // === HQ VERKAUF ===
        function renderHqVerkauf() {
            var totalVK = hqStandorte.reduce(function(a,s){return a+s.verkauftKW;},0);
            var totalBer = hqStandorte.reduce(function(a,s){return a+s.beratungenKW;},0);
            var conversion = totalBer ? Math.round(totalVK/totalBer*100) : 0;
            var active = hqStandorte.filter(function(s){return s.verkauftKW>0;}).length;

            var kpi = document.getElementById('hqVkKpis');
            if(kpi) kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Verkaeufe KW 7</p><p class="text-2xl font-bold">'+totalVK+'</p><p class="text-xs text-gray-500">Netzwerk-weit</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Beratungen KW 7</p><p class="text-2xl font-bold">'+totalBer+'</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Conversion</p><p class="text-2xl font-bold '+(conversion>=40?'text-green-600':'text-yellow-600')+'">'+conversion+'%</p></div>'
                +'<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Aktive Standorte</p><p class="text-2xl font-bold">'+active+' / '+hqStandorte.length+'</p></div>';

            var t = document.getElementById('hqVkTable');
            if(t) {
                var th = '<thead><tr class="border-b-2 border-gray-200"><th class="text-left py-2 px-2 text-xs text-gray-500">Standort</th><th class="text-right py-2 px-2 text-xs text-gray-500">Beratungen</th><th class="text-right py-2 px-2 text-xs text-gray-500">Verkauft</th><th class="text-right py-2 px-2 text-xs text-gray-500">Conversion</th><th class="text-right py-2 px-2 text-xs text-gray-500">Umsatz YTD</th></tr></thead><tbody>';
                hqStandorte.slice().sort(function(a,b){return b.verkauftKW-a.verkauftKW;}).forEach(function(s){
                    var conv = s.beratungenKW ? Math.round(s.verkauftKW/s.beratungenKW*100) : 0;
                    th += '<tr class="border-b border-gray-100 hover:bg-gray-50"><td class="py-2 px-2 text-sm font-semibold">'+s.name+'</td><td class="py-2 px-2 text-sm text-right">'+s.beratungenKW+'</td><td class="py-2 px-2 text-sm text-right font-bold">'+s.verkauftKW+'</td><td class="py-2 px-2 text-sm text-right '+(conv>=40?'text-green-600':conv>=25?'text-yellow-600':'text-red-500')+'">'+conv+'%</td><td class="py-2 px-2 text-sm text-right">'+fmt(s.umsatzIst)+' â‚¬</td></tr>';
                });
                th += '</tbody>';
                t.innerHTML = th;
            }

            var al = document.getElementById('hqVkAlerts');
            if(al) {
                var alh = '';
                hqStandorte.filter(function(s){return s.verkauftKW===0;}).forEach(function(s){
                    alh += '<div class="p-3 bg-red-50 rounded-lg mb-2"><span class="text-sm font-semibold text-red-700">ðŸ”´ '+s.name+' â€“ 0 Verkaeufe in KW 7</span></div>';
                });
                hqStandorte.filter(function(s){return s.beratungenKW>0 && s.verkauftKW>0 && (s.verkauftKW/s.beratungenKW)<0.2;}).forEach(function(s){
                    alh += '<div class="p-3 bg-yellow-50 rounded-lg mb-2"><span class="text-sm font-semibold text-yellow-700">âš ï¸ '+s.name+' â€“ Conversion unter 20%</span><p class="text-xs text-yellow-600">'+s.beratungenKW+' Beratungen, nur '+s.verkauftKW+' Abschluesse. Verkaufsschulung empfohlen.</p></div>';
                });
                al.innerHTML = alh || '<p class="text-sm text-green-600">âœ… Alle Standorte verkaufen aktiv</p>';
            }
        }

        // === HQ HANDLUNGSBEDARF (konsolidiert) ===
        function renderHqAktionen() {
            var aktionen = [];
            hqStandorte.forEach(function(s) {
                if(s.leadPerf===0) aktionen.push({prio:1,bereich:'Standort',standort:s.name,text:'Standort inaktiv â€“ Nachfolger/Reaktivierung noetig',color:'bg-gray-800 text-white'});
                if(s.strategieStatus==='missing' && s.umsatzIst>0) aktionen.push({prio:1,bereich:'Strategie',standort:s.name,text:'Marketing- & Einkaufsstrategie fehlt â€“ Termin vereinbaren',color:'bg-red-600 text-white'});
                if(s.vororderStatus==='open' && s.umsatzIst>0) aktionen.push({prio:2,bereich:'Einkauf',standort:s.name,text:'Keine Vororder 2026 platziert â€“ dringend Gespraech fuehren',color:'bg-red-500 text-white'});
                if(s.rohertrag>0 && s.rohertrag<32) aktionen.push({prio:2,bereich:'Controlling',standort:s.name,text:'Rohertrag kritisch ('+s.rohertrag+'%) â€“ Massnahmenplan erstellen',color:'bg-red-500 text-white'});
                if(s.rabattQuote>10) aktionen.push({prio:2,bereich:'Verkauf',standort:s.name,text:'Rabattquote '+s.rabattQuote+'% â€“ Schulung Dreingaben vs. Rabatte',color:'bg-red-400 text-white'});
                if(s.leadPerf>0 && s.leadPerf<50) aktionen.push({prio:3,bereich:'Marketing',standort:s.name,text:'Lead-Performance '+s.leadPerf+'% â€“ Budget/Strategie pruefen',color:'bg-orange-500 text-white'});
                if(s.offeneTickets>=4) aktionen.push({prio:3,bereich:'Support',standort:s.name,text:s.offeneTickets+' offene Tickets â€“ Abarbeitung priorisieren',color:'bg-yellow-500 text-gray-800'});
                if(s.bwaAuffaellig && s.rohertrag>=32) aktionen.push({prio:4,bereich:'Controlling',standort:s.name,text:s.bwaAuffaellig,color:'bg-yellow-400 text-gray-800'});
                if(s.strategieStatus==='pending') aktionen.push({prio:4,bereich:'Strategie',standort:s.name,text:'Strategie-Vereinbarung noch ausstehend â€“ nachfassen',color:'bg-yellow-300 text-gray-800'});
            });
            aktionen.sort(function(a,b){return a.prio-b.prio;});

            var kpi = document.getElementById('hqAktKpis');
            if(kpi) {
                var p1 = aktionen.filter(function(a){return a.prio<=2;}).length;
                var p2 = aktionen.filter(function(a){return a.prio===3;}).length;
                var p3 = aktionen.filter(function(a){return a.prio>=4;}).length;
                kpi.innerHTML = '<div class="vit-card p-5"><p class="text-xs text-gray-400 uppercase">Aktionen gesamt</p><p class="text-2xl font-bold text-gray-800">'+aktionen.length+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-red-500"><p class="text-xs text-gray-400 uppercase">ðŸ”´ Kritisch</p><p class="text-2xl font-bold text-red-600">'+p1+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-orange-500"><p class="text-xs text-gray-400 uppercase">ðŸŸ  Wichtig</p><p class="text-2xl font-bold text-orange-600">'+p2+'</p></div>'
                    +'<div class="vit-card p-5 border-l-4 border-yellow-400"><p class="text-xs text-gray-400 uppercase">ðŸŸ¡ Beobachten</p><p class="text-2xl font-bold text-yellow-600">'+p3+'</p></div>';
            }

            var list = document.getElementById('hqAktionenList');
            if(list) {
                var lh = '';
                aktionen.forEach(function(a) {
                    lh += '<div class="vit-card p-4 flex items-center space-x-4 hover:shadow-md transition">';
                    lh += '<span class="'+a.color+' text-[10px] px-2.5 py-1 rounded-full font-bold whitespace-nowrap">'+a.bereich+'</span>';
                    lh += '<div class="flex-1"><p class="text-sm font-semibold text-gray-800">'+a.standort+'</p><p class="text-xs text-gray-500">'+a.text+'</p></div>';
                    lh += '<span class="text-xs text-gray-400 whitespace-nowrap">Prio '+(a.prio<=2?'ðŸ”´':a.prio===3?'ðŸŸ ':'ðŸŸ¡')+'</span>';
                    lh += '</div>';
                });
                list.innerHTML = lh || '<div class="text-center py-12 text-gray-400"><p class="text-4xl mb-2">âœ…</p><p>Kein Handlungsbedarf â€“ alles laeuft!</p></div>';
            }
        }



        // ======================================================
        // === MODULÃœBERSICHT / DEV-STATUS ===
        // ======================================================
        var currentModulFilter = 'alle';

        // Aufwand: S = <1 Tag, M = 1-3 Tage, L = 3-7 Tage, XL = >1 Woche
        var MODUL_DATEN = {
            standort: [
                {name:'Startseite / Dashboard', view:'homeView', status:'live', typ:'standort', version:'1.4.0', details:'Personalisiert, 14 Widgets (12 Live aus DB, 2 Demo). Pipeline, Verkauf, Termine, Aufgaben, Team, Controlling, Support, Nachrichten, Monatsfokus, Jahresziele, Journal, MaÃŸnahmen alle live.', kiPrio:35, aufwand:'S', kiTodo:'Restliche Demo-Widgets (Top-VerkÃ¤ufer, Neue Inhalte) an DB anbinden.'},
                {name:'Verkauf / CRM', view:'verkaufView', status:'teilweise', typ:'standort', version:'2.1.0', details:'React Pipeline (Kanban, Drag&Drop, Gamification), Scan-Upload mit KI-Analyse via Edge Function, KI-Verkaufstrainer, Wochenansicht, Auswertung', kiPrio:2, aufwand:'L', kiTodo:'âœ… API-Key gesichert (Edge Function). Noch offen: Angebotserstellung PDF, Lead-Import, Follow-up-Erinnerungen, Supabase-Anbindung Pipeline-Deals.'},
                {name:'Kalender', view:'kalenderView', status:'live', typ:'standort', version:'2.0.0', details:'Monats/Wochen/Tagesansicht, Wiederkehrende Termine, Teilnehmer, Serien, CRUD komplett, 8 Typen, Mini-Kalender, HQ-Kalender', kiPrio:20, aufwand:'XL', kiTodo:'MS365-Sync, Drag&Drop, Notifications nice-to-have.'},
                {name:'Aufgaben / Todos', view:'todoView', status:'live', typ:'standort', version:'2.0.0', details:'Todoist-Redesign: Sektionen, Subtasks mit Fortschritt, Board/Kanban Drag&Drop, Detail-Panel, Labels, Kommentare, Quick-Add, Suche â€“ alles DB+Realtime', kiPrio:30, aufwand:'M', kiTodo:'Label-Management UI, Zuweisung an Mitarbeiter.'},
                {name:'Kommunikation', view:'kommunikationView', status:'live', typ:'standort', version:'3.0.0', details:'Teams-Hybrid: 2-Spalten Chat mit Konversations-Sidebar (KanÃ¤le, Nachrichten, AnkÃ¼ndigungen), Thread-Replies, fixierte Eingabe. Forum (CRUD+Kommentare), Brett (CRUD+Nachr. an Autor), Mini-Kalender â€“ alles DB+Realtime', kiPrio:28, aufwand:'M', kiTodo:'Push-Notifications. Emoji-Reactions. Nachricht bearbeiten/lÃ¶schen.'},
                {name:'Controlling / BWA', view:'controllingView', status:'live', typ:'standort', version:'2.3.0', details:'Performance-Cockpit, BWA-Parser (13+ Formate), KI-Fallback fÃ¼r unbekannte Formate, PDF-Support, Multi-Upload Batch, Detail-Positionen, KPIs, Trend-Sparklines, Plan/Ist, Jahresplan-Upload', kiPrio:3, aufwand:'M', kiTodo:'Benchmarks gegen Netzwerk-Durchschnitt, LiquiditÃ¤tsplanung.'},
                {name:'Marketing', view:'marketingView', status:'teilweise', typ:'standort', version:'1.0.0', details:'6 Tabs: Performance (Cross-Channel KPIs), Budget (491kâ‚¬ Jahresbudget, Spending-Chart), Leads (Forecast, Live-Leads), Social (Local Hero), Strategie, Wissen', kiPrio:8, aufwand:'L', kiTodo:'DB-Tabellen fÃ¼r Kampagnen/Budget anlegen, Social-Media Kalender, Content-Bibliothek. Aktuell Demo-Daten aber vollstÃ¤ndige UI.'},
                {name:'Einkauf', view:'einkaufView', status:'teilweise', typ:'standort', version:'1.0.0', details:'5 Tabs: Sortiment (Hauptmarken-Cards, Bestandsmarken, Teilelieferanten), Lieferanten (65 EintrÃ¤ge mit Status/Konditionen/IHT/B2B), Zentralreg. (Cronbank/IHT/HIW-System), Strategie (Fortschritt, ToDos), Wissen (5 Sub-Sections: IHT, Parts-Matrix, DB1, Kernsortiment, Vororder)', kiPrio:12, aufwand:'M', kiTodo:'Lieferanten-DB anlegen (aktuell JS-Array), Konditionen editierbar machen, BestellvorschlÃ¤ge.'},
                {name:'Dashboards', view:'dashboardsView', status:'demo', typ:'standort', version:'0.1.0', details:'Tabs vorhanden, Inhalte statisch', kiPrio:10, aufwand:'L', kiTodo:'Echte Charts aus BWA-Daten, Verkaufsdaten, Pipeline-Conversion.'},
                {name:'Allgemein', view:'allgemeinView', status:'teilweise', typ:'standort', version:'1.1.0', details:'6 Tabs: Ãœbersicht (Monatsfokus, Meeting, Ziele, MaÃŸnahmen), Jahresziele (Hart/SMART/Soft mit CRUD + Modal), Monatsplan (12 Monate, Massnahmen, ZielverknÃ¼pfung), Partner-Journal (GesprÃ¤chsprotokoll + Modal), Strategie, Wissen. 3 neue DB-Tabellen mit RLS.', kiPrio:9, aufwand:'M', kiTodo:'Supabase-Anbindung der 3 Tabellen (partner_jahresziele, partner_monatsplan, partner_journal). UI komplett fertig.'},
                {name:'Wissen', view:'wissenView', status:'teilweise', typ:'standort', version:'0.5.0', details:'Struktur mit Bereichen (Verkauf, Marketing, Einkauf, Controlling, Allgemein), Suche, Wissen-Tabs in jedem Modul', kiPrio:15, aufwand:'L', kiTodo:'CMS-Backend: Artikel erstellen, Kategorien. Basis fÃ¼r Wissen-Tabs in anderen Modulen.'},
                {name:'Support', view:'supportView', status:'teilweise', typ:'standort', version:'1.1.0', details:'Tickets mit DB, Kontakte-Seite', kiPrio:22, aufwand:'M', kiTodo:'Ticket-PrioritÃ¤ten, SLA-Timer, E-Mail-Benachrichtigung.'},
                {name:'Ideenboard', view:'ideenboardView', status:'live', typ:'standort', version:'1.0.0', details:'Einreichen, Voting, Status â€“ alles DB', kiPrio:34, aufwand:'S', kiTodo:'Kommentar-Funktion. Grundfunktion top.'},
                {name:'Shop', view:'shopView', status:'demo', typ:'standort', version:'0.1.0', details:'UI + Warenkorb, keine echte Bestelllogik', kiPrio:18, aufwand:'L', kiTodo:'Bestellungen in DB speichern, BestÃ¤tigung, HQ-Verarbeitung.'},
                {name:'Aktenschrank', view:'aktenschrankView', status:'live', typ:'standort', version:'1.0.0', details:'Upload, Download, Kategorien â€“ alles DB', kiPrio:31, aufwand:'S', kiTodo:'Ordner-System, DateigrÃ¶ÃŸe-Limits. Funktioniert.'},
                {name:'Onboarding', view:'onboardingView', status:'teilweise', typ:'standort', version:'0.5.0', details:'Asana-Demo-Integration, Checklisten', kiPrio:7, aufwand:'L', kiTodo:'Echte Asana-API Anbindung oder eigene Checklisten-DB. Wichtig fÃ¼r neue Partner.'},
                {name:'Mitarbeiter', view:'mitarbeiterView', status:'live', typ:'standort', version:'1.5.0', details:'Anlegen, Rollen, Approval, Passwort-Reset, Deaktivierung', kiPrio:29, aufwand:'S', kiTodo:'AktivitÃ¤ts-Log. Funktioniert sehr gut.'}
            ],
            hq: [
                {name:'Netzwerk-Cockpit', view:'hqCockpitView', status:'teilweise', typ:'hq', version:'1.0.0', details:'KPIs, Schnellzugriffe, Standort-Vergleich, teilweise mit echten Daten', kiPrio:4, aufwand:'M', kiTodo:'Echte KPIs aus allen Standort-Daten aggregieren. Zentrales HQ-Dashboard.'},
                {name:'Kommandozentrale', view:'hqKommandoView', status:'teilweise', typ:'hq', version:'1.2.0', details:'7 Tabs (Standorte, Mitarbeiter, Kampagnen, Kommunikation, Aufgaben, Kalender, Dokumente), teilweise mit DB', kiPrio:5, aufwand:'XL', kiTodo:'Alle Tabs mit echten Daten versorgen. Mitarbeiter-Tab funktioniert bereits.'},
                {name:'Handlungsbedarf', view:'hqAktionenView', status:'teilweise', typ:'hq', version:'0.5.0', details:'Auto-Erkennung aus Standort-KPIs, priorisierte Aktionsliste', kiPrio:1, aufwand:'L', kiTodo:'Echte Regeln: Fehlende BWAs, negatives Ergebnis, offene Tickets. HÃ¶chste Prio fÃ¼r HQ-Alltag.'},
                {name:'HQ Standorte', view:'hqStandorteView', status:'live', typ:'hq', version:'1.0.0', details:'Alle Standorte mit Filter und Status', kiPrio:25, aufwand:'M', kiTodo:'Standort-Detail-Seite mit allen KPIs.'},
                {name:'HQ Finanzen', view:'hqFinanzenView', status:'live', typ:'hq', version:'1.3.0', details:'BWA-Status aller Standorte, Netzwerk-Finanzen, Periodenvergleich', kiPrio:6, aufwand:'M', kiTodo:'Netzwerk-P&L, Standort-Vergleich, Excel/PDF-Export.'},
                {name:'HQ Marketing', view:'hqMarketingView', status:'teilweise', typ:'hq', version:'1.0.0', details:'5 Tabs: Ãœbersicht, Budgetsteuerung (15 Standorte Ã— 8 Spalten), Leadreport (Ranking mit Balken), JahresgesprÃ¤che (Status-Tracking), Handlungsbedarf (Ampel-Alerts)', kiPrio:16, aufwand:'M', kiTodo:'DB-Anbindung fÃ¼r Budget und Lead-Daten. UI komplett fertig.'},
                {name:'HQ Einkauf', view:'hqEinkaufView', status:'teilweise', typ:'hq', version:'1.0.0', details:'3 Tabs: Ãœbersicht (Dashboard mit 5-Standort-Vergleich, Alarme, Rohertrag-Bars), Lieferanten (editierbar mit Modal), Strategien (Fortschritt pro Standort mit Ampel)', kiPrio:19, aufwand:'M', kiTodo:'Lieferanten-DB, Konditionen editierbar per Supabase.'},
                {name:'HQ Verkauf', view:'hqVerkaufView', status:'demo', typ:'hq', version:'0.1.0', details:'Ranking mit Demo-Daten, KPIs', kiPrio:11, aufwand:'M', kiTodo:'Echtes Netzwerk-Ranking aus verkauf_tracking + leads.'},
                {name:'HQ Allgemein', view:'hqAllgemeinView', status:'teilweise', typ:'hq', version:'1.0.0', details:'Netzwerk-Stimmung (4 Kategorien), HQ-Aufgaben aus Partner-Journals, Standort-Tabelle (Stimmung, Monatsfokus, Ziele, MaÃŸnahmen, GesprÃ¤che)', kiPrio:9, aufwand:'M', kiTodo:'Supabase-Anbindung an partner_journal, partner_jahresziele, partner_monatsplan Tabellen.'},
                {name:'HQ Auswertung / Nutzung', view:'hqAuswertungView', status:'live', typ:'hq', version:'1.1.0', details:'Portal-Nutzung mit echten DB-Daten: Logins, BWA-Status, Modul-Nutzung, Aufgaben, Score pro Standort. Supabase RPC get_portal_usage_stats()', kiPrio:14, aufwand:'S', kiTodo:'Weitere BI-Auswertungen: Netzwerk-Trends, Saisonvergleiche, Forecasting.'},
                {name:'HQ Wissen', view:'hqWissenView', status:'teilweise', typ:'hq', version:'0.5.0', details:'Artikel-Ãœbersicht mit Kategorien', kiPrio:13, aufwand:'L', kiTodo:'CMS: Artikel erstellen/bearbeiten/publizieren, PflichtlektÃ¼re.'},
                {name:'HQ Support', view:'hqSupportView', status:'live', typ:'hq', version:'1.0.0', details:'Netzwerk-Tickets, Status Ã¤ndern, PrioritÃ¤ten', kiPrio:24, aufwand:'M', kiTodo:'Ticket-Zuweisung, SLA-Tracking, Auto-Eskalation.'},
                {name:'HQ Ideen', view:'hqIdeenView', status:'live', typ:'hq', version:'1.0.0', details:'Ideen verwalten, Status Ã¤ndern, Filter', kiPrio:32, aufwand:'S', kiTodo:'Idee-zu-Projekt Konversion. Grundfunktion top.'},
                {name:'HQ Shop', view:'hqShopView', status:'demo', typ:'hq', version:'0.1.0', details:'UI zum HinzufÃ¼gen, keine echte DB', kiPrio:21, aufwand:'L', kiTodo:'Produktverwaltung CRUD, BestellÃ¼bersicht.'},
                {name:'HQ Einstellungen', view:'hqEinstellungenView', status:'live', typ:'hq', version:'1.2.0', details:'Module aktivieren/deaktivieren, Rollen-Matrix, User-Freigabe â€“ alles DB', kiPrio:36, aufwand:'S', kiTodo:'Branding-Einstellungen. Core funktioniert bereits.'}
            ],
            widgets: [
                {name:'Widget: Umsatz & Ergebnis', status:'live', typ:'widget', details:'Integriert in Controlling-Widget: Umsatz + Ergebnis aus letzter BWA', kiPrio:37, aufwand:'S', kiTodo:'Plan-Vergleich wenn Plan-Daten vorhanden.'},
                {name:'Widget: Pipeline', status:'live', typ:'widget', details:'Live aus leads-Tabelle: Offene Leads, Angebote, Pipeline-Wert', kiPrio:38, aufwand:'S', kiTodo:'Click-Through zu Lead. Funktioniert.'},
                {name:'Widget: Termine heute', status:'live', typ:'widget', details:'Live aus termine-Tabelle, farbige Tagesansicht', kiPrio:39, aufwand:'S', kiTodo:'Termin-Direkterstellung. Funktioniert.'},
                {name:'Widget: Offene Aufgaben', status:'live', typ:'widget', details:'Live aus todos-Tabelle, Quick-Toggle zum Abhaken direkt im Widget', kiPrio:40, aufwand:'S', kiTodo:'Direkt-Erstellung im Widget. Funktioniert.'},
                {name:'Widget: Marketing Performance', status:'demo', typ:'widget', details:'4 KPIs (Kosten MTD, Leads, Store Visits, Budget). Demo-Daten bis Marketing-DB fertig.', kiPrio:23, aufwand:'M', kiTodo:'An echte Marketing-DB anbinden.'},
                {name:'Widget: Controlling', status:'live', typ:'widget', details:'Live aus bwa_daten: Umsatz, Rohertrag-%, Ergebnis der letzten BWA', kiPrio:41, aufwand:'S', kiTodo:'Trend-Pfeil vs. Vormonat. Funktioniert.'},
                {name:'Widget: Support Tickets', status:'live', typ:'widget', details:'Live aus support_tickets: Offene Tickets mit Alter in Tagen, Farbcodierung', kiPrio:42, aufwand:'S', kiTodo:'Farbe bei >7 Tage. Funktioniert.'},
                {name:'Widget: Nachrichten HQ', status:'live', typ:'widget', details:'Live aus ankuendigungen: Neueste Nachrichten mit relativer Zeitanzeige, Kategorie-Farben', kiPrio:43, aufwand:'S', kiTodo:'Funktioniert. Keine Ã„nderung nÃ¶tig.'},
                {name:'Widget: Team-Ãœbersicht', status:'live', typ:'widget', details:'Live aus users-Tabelle: Aktive Mitarbeiter mit Rollen-Icons', kiPrio:44, aufwand:'S', kiTodo:'Funktioniert.'},
                {name:'Widget: Wissen', status:'demo', typ:'widget', details:'Kuratierte Wissens-Artikel. Demo-Daten bis CMS-Backend fertig.', kiPrio:45, aufwand:'S', kiTodo:'An Wissens-CMS anbinden.'},
                {name:'Widget: Verkaufserfolg KW', status:'live', typ:'widget', details:'Live aus verkauf_tracking: Verkaufsquote, Beratungen, aktuelle KW', kiPrio:17, aufwand:'M', kiTodo:'Echte Wochen-Daten aus verkauf_tracking.'},
                {name:'Widget: Monatsfokus', status:'live', typ:'widget', details:'Live aus partner_monatsplan: Aktueller Fokus und Beschreibung', kiPrio:46, aufwand:'S', kiTodo:'Funktioniert.'},
                {name:'Widget: Jahresziele', status:'live', typ:'widget', details:'Live aus partner_jahresziele: Top-2 Ziele mit Fortschrittsbalken', kiPrio:47, aufwand:'S', kiTodo:'Funktioniert.'},
                {name:'Widget: Letztes Journal', status:'live', typ:'widget', details:'Live aus partner_journal: Letztes GesprÃ¤ch mit Stimmung', kiPrio:48, aufwand:'S', kiTodo:'Funktioniert.'},
                {name:'Widget: Offene MaÃŸnahmen', status:'live', typ:'widget', details:'Live aus partner_journal: Offene Massnahmen aus GesprÃ¤chen', kiPrio:49, aufwand:'S', kiTodo:'Funktioniert.'}
            ]
        };

        // HQ-Prio: eigene Reihenfolge, gespeichert
        var hqPrioOrder = null;
        function loadHqPrio() { try { var s = localStorage.getItem('vitbikes_hq_prio'); if(s) hqPrioOrder = JSON.parse(s); } catch(e) {} }
        function saveHqPrio() { try { localStorage.setItem('vitbikes_hq_prio', JSON.stringify(hqPrioOrder)); } catch(e) {} }
        function resetHqPrio() { hqPrioOrder = null; try { localStorage.removeItem('vitbikes_hq_prio'); } catch(e) {} renderModulStatus(); }
        function getAllModulesFlat() { return MODUL_DATEN.standort.concat(MODUL_DATEN.hq).concat(MODUL_DATEN.widgets); }

        function getAufwandBadge(a) {
            var map = {'S':{bg:'bg-green-100 text-green-700',label:'S (<1 Tag)'},'M':{bg:'bg-blue-100 text-blue-700',label:'M (1-3 Tage)'},'L':{bg:'bg-orange-100 text-orange-700',label:'L (3-7 Tage)'},'XL':{bg:'bg-red-100 text-red-700',label:'XL (>1 Woche)'}};
            var m = map[a] || map['M'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold '+m.bg+'">'+m.label+'</span>';
        }
        function getTypBadge(t) {
            var map = {'standort':{bg:'bg-indigo-100 text-indigo-700',label:'ðŸª Standort'},'hq':{bg:'bg-purple-100 text-purple-700',label:'ðŸ¢ HQ'},'widget':{bg:'bg-cyan-100 text-cyan-700',label:'ðŸ“Š Widget'}};
            var m = map[t] || map['standort'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold '+m.bg+'">'+m.label+'</span>';
        }
        function getStatusBadge(s) {
            var map = {'live':{bg:'bg-green-100 text-green-800',icon:'ðŸŸ¢',label:'Live'},'teilweise':{bg:'bg-yellow-100 text-yellow-800',icon:'ðŸŸ¡',label:'Teilweise'},'demo':{bg:'bg-orange-100 text-orange-800',icon:'ðŸŸ ',label:'Demo/UI'},'stub':{bg:'bg-red-100 text-red-800',icon:'ðŸ”´',label:'Stub'}};
            var m = map[s] || map['stub'];
            return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold '+m.bg+'">'+m.icon+' '+m.label+'</span>';
        }

        function filterModulStatus(f) {
            currentModulFilter = f;
            document.querySelectorAll('.ms-filter').forEach(function(b) {
                b.className = 'ms-filter text-xs px-3 py-1.5 rounded-full font-semibold ' + (b.getAttribute('data-f') === f ? 'bg-vit-orange text-white' : 'bg-gray-100 text-gray-600');
            });
            renderModulStatus();
        }

        var _dragIdx = null;
        function onPrioDragStart(e) { _dragIdx = parseInt(e.target.closest('tr').getAttribute('data-idx')); e.dataTransfer.effectAllowed = 'move'; }
        function onPrioDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; var tr = e.target.closest('tr'); if(tr) tr.style.borderTop = '2px solid #EF7D00'; }
        function onPrioDragLeave(e) { var tr = e.target.closest('tr'); if(tr) tr.style.borderTop = ''; }
        function onPrioDrop(e) {
            e.preventDefault();
            var targetIdx = parseInt(e.target.closest('tr').getAttribute('data-idx'));
            e.target.closest('tr').style.borderTop = '';
            if(_dragIdx === null || _dragIdx === targetIdx) return;
            var item = hqPrioOrder.splice(_dragIdx, 1)[0];
            hqPrioOrder.splice(targetIdx, 0, item);
            saveHqPrio();
            renderModulStatus();
            _dragIdx = null;
        }
        function moveHqPrio(idx, dir) {
            if(!hqPrioOrder) return;
            var newIdx = idx + dir;
            if(newIdx < 0 || newIdx >= hqPrioOrder.length) return;
            var tmp = hqPrioOrder[idx];
            hqPrioOrder[idx] = hqPrioOrder[newIdx];
            hqPrioOrder[newIdx] = tmp;
            saveHqPrio();
            renderModulStatus();
        }

        function renderModulStatus() {
            var el = document.getElementById('modulStatusContent');
            if(!el) return;
            var h = '';
            var allModules = getAllModulesFlat();
            var counts = {live:0, teilweise:0, demo:0, stub:0};
            allModules.forEach(function(m) { counts[m.status] = (counts[m.status]||0)+1; });
            var sumEl = document.getElementById('modulStatusSummary');
            if(sumEl) {
                sumEl.innerHTML = '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold">ðŸŸ¢ '+counts.live+' Live</span>'
                    +'<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold">ðŸŸ¡ '+counts.teilweise+' Teilweise</span>'
                    +'<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-semibold">ðŸŸ  '+counts.demo+' Demo</span>'
                    +'<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-semibold">ðŸ”´ '+counts.stub+' Stub</span>';
            }

            // KI PRIO VIEW
            if(currentModulFilter === 'kiPrio') {
                var sorted = allModules.slice().sort(function(a,b){ return (a.kiPrio||99) - (b.kiPrio||99); });
                h += '<div class="vit-card p-6 mb-6">';
                h += '<div class="flex items-center justify-between mb-4">';
                h += '<div><h2 class="text-lg font-bold text-gray-800">ðŸ¤– KI-Empfehlung: Umsetzungs-Reihenfolge</h2>';
                h += '<p class="text-xs text-gray-500 mt-1">Sortiert nach Business-Impact Ã— Machbarkeit. Niedrigere Nummer = hÃ¶here PrioritÃ¤t.</p></div></div>';
                h += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                h += '<thead><tr class="border-b border-gray-200"><th class="text-left py-2 px-3 text-xs font-bold text-gray-500 w-10">#</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Modul</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Status</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Typ</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Aufwand</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">NÃ¤chster Schritt</th></tr></thead><tbody>';
                sorted.forEach(function(m, i) {
                    var bg = i < 3 ? 'bg-green-50' : i < 10 ? 'bg-yellow-50' : '';
                    h += '<tr class="border-b border-gray-100 hover:bg-gray-50 '+bg+'">';
                    h += '<td class="py-3 px-3 font-bold '+(i<3?'text-green-600':i<10?'text-yellow-600':'text-gray-400')+'">'+(i+1)+'</td>';
                    h += '<td class="py-3 px-3"><div class="font-semibold text-gray-800">'+m.name+'</div><div class="text-[10px] text-gray-400 mt-0.5">'+m.details+'</div></td>';
                    h += '<td class="py-3 px-3">'+getStatusBadge(m.status)+'</td>';
                    h += '<td class="py-3 px-3">'+getTypBadge(m.typ)+'</td>';
                    h += '<td class="py-3 px-3">'+getAufwandBadge(m.aufwand)+'</td>';
                    h += '<td class="py-3 px-3 text-xs text-gray-600 max-w-xs">'+(m.kiTodo||'')+'</td>';
                    h += '</tr>';
                });
                h += '</tbody></table></div></div>';
                el.innerHTML = h;
                return;
            }

            // HQ PRIO VIEW
            if(currentModulFilter === 'hqPrio') {
                loadHqPrio();
                if(!hqPrioOrder) {
                    hqPrioOrder = allModules.slice().sort(function(a,b){ return (a.kiPrio||99)-(b.kiPrio||99); }).map(function(m){ return {name:m.name, typ:m.typ}; });
                }
                var prioModules = [];
                hqPrioOrder.forEach(function(p) {
                    var found = allModules.find(function(m){ return m.name===p.name && m.typ===p.typ; });
                    if(found) prioModules.push(found);
                });
                h += '<div class="vit-card p-6 mb-6">';
                h += '<div class="flex items-center justify-between mb-4">';
                h += '<div><h2 class="text-lg font-bold text-gray-800">ðŸ¢ HQ-PrioritÃ¤t: Eigene Reihenfolge</h2>';
                h += '<p class="text-xs text-gray-500 mt-1">Per Drag & Drop oder Pfeiltasten sortieren. Wird automatisch gespeichert.</p></div>';
                h += '<button onclick="resetHqPrio()" class="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 font-semibold">â†©ï¸ Auf KI-Empfehlung zurÃ¼cksetzen</button></div>';
                h += '<div class="overflow-x-auto"><table class="w-full text-sm">';
                h += '<thead><tr class="border-b border-gray-200"><th class="w-10"></th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500 w-10">#</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Modul</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Status</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Aufwand</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">NÃ¤chster Schritt</th><th class="w-20"></th></tr></thead><tbody>';
                prioModules.forEach(function(m, i) {
                    h += '<tr class="border-b border-gray-100 hover:bg-gray-50 cursor-grab" draggable="true" data-idx="'+i+'" ondragstart="onPrioDragStart(event)" ondragover="onPrioDragOver(event)" ondragleave="onPrioDragLeave(event)" ondrop="onPrioDrop(event)">';
                    h += '<td class="py-2 px-2 text-gray-300 cursor-grab">â ¿</td>';
                    h += '<td class="py-3 px-3 font-bold text-gray-400">'+(i+1)+'</td>';
                    h += '<td class="py-3 px-3"><div class="font-semibold text-gray-800">'+m.name+'</div><div class="text-[10px] text-gray-400">'+getTypBadge(m.typ)+'</div></td>';
                    h += '<td class="py-3 px-3">'+getStatusBadge(m.status)+'</td>';
                    h += '<td class="py-3 px-3">'+getAufwandBadge(m.aufwand)+'</td>';
                    h += '<td class="py-3 px-3 text-xs text-gray-600 max-w-xs">'+(m.kiTodo||'')+'</td>';
                    h += '<td class="py-2 px-2"><button onclick="moveHqPrio('+i+',-1)" class="text-gray-400 hover:text-gray-700 text-sm">â–²</button><button onclick="moveHqPrio('+i+',1)" class="text-gray-400 hover:text-gray-700 text-sm ml-1">â–¼</button></td>';
                    h += '</tr>';
                });
                h += '</tbody></table></div></div>';
                el.innerHTML = h;
                return;
            }

            // NORMAL FILTER (alle / standort / hq / widgets)
            var modules = currentModulFilter === 'alle' ? allModules : (MODUL_DATEN[currentModulFilter] || allModules.filter(function(m){ return m.typ === currentModulFilter; }));
            h += '<div class="overflow-x-auto"><table class="w-full text-sm">';
            h += '<thead><tr class="border-b border-gray-200"><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Modul</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Version</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Status</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Typ</th><th class="text-left py-2 px-3 text-xs font-bold text-gray-500">Details</th></tr></thead><tbody>';
            modules.forEach(function(m) {
                h += '<tr class="border-b border-gray-100 hover:bg-gray-50">';
                h += '<td class="py-3 px-3 font-semibold text-gray-800">'+m.name+'</td>';
                h += '<td class="py-3 px-3"><span class="text-[10px] font-mono text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">'+(m.version||'â€“')+'</span></td>';
                h += '<td class="py-3 px-3">'+getStatusBadge(m.status)+'</td>';
                h += '<td class="py-3 px-3">'+getTypBadge(m.typ)+'</td>';
                h += '<td class="py-3 px-3 text-xs text-gray-500">'+m.details+'</td>';
                h += '</tr>';
            });
            h += '</tbody></table></div>';
            el.innerHTML = h;
        }

        // Alias for auto-loading
        function renderDevStatus() { renderModulStatus(); }



        // === PERFORMANCE COCKPIT ===
        var cockpitMonth = null;
        async function renderPerformanceCockpit() {
            var el = document.getElementById('cockpitContent');
            if(!el) return;
            el.innerHTML = '<p class="text-sm text-gray-400 text-center py-8 animate-pulse">Lade Cockpit-Daten...</p>';

            var stdId = sbProfile ? sbProfile.standort_id : null;
            console.log('[Cockpit] renderPerformanceCockpit() called, stdId:', stdId);
            var stdName = sbProfile ? (sbProfile.standort_name || sbProfile.name || 'Mein Standort') : 'Mein Standort';
            var currentYear = new Date().getFullYear();
            var pn = function(v) { return parseFloat(v) || 0; };
            var mLabels = {1:'Jan',2:'Feb',3:'MÃ¤r',4:'Apr',5:'Mai',6:'Jun',7:'Jul',8:'Aug',9:'Sep',10:'Okt',11:'Nov',12:'Dez'};

            try {
                // Load BWAs for current + previous year
                var bwaResp = await sb.from('bwa_daten').select('*').eq('standort_id', stdId).eq('jahr', currentYear).order('monat');
                var bwas = (bwaResp.data || []);
                var vjResp = await sb.from('bwa_daten').select('*').eq('standort_id', stdId).eq('jahr', currentYear - 1).order('monat');
                var vjBwas = (vjResp.data || []);

                if(bwas.length === 0) {
                    el.innerHTML = '<div class="text-center py-12"><p class="text-4xl mb-3">ðŸ“Š</p><p class="text-gray-500">Noch keine BWA-Daten fÃ¼r ' + currentYear + ' vorhanden.</p><p class="text-sm text-gray-400 mt-2">Lade eine BWA hoch, um das Performance Cockpit zu aktivieren.</p><button onclick="showControllingTab(\'bwa\')" class="mt-4 px-4 py-2 bg-vit-orange text-white rounded-lg text-sm hover:opacity-90">BWA hochladen â†’</button></div>';
                    return;
                }

                // Find latest month or selected month
                var latestMonth = cockpitMonth || Math.max.apply(null, bwas.map(function(b) { return b.monat; }));
                var bwa = bwas.find(function(b) { return b.monat === latestMonth; });
                var vjBwa = vjBwas.find(function(b) { return b.monat === latestMonth; });

                if(!bwa) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">Keine Daten fÃ¼r gewÃ¤hlten Monat.</p>'; return; }

                // Correct values from detail positions if available
                var detCockpit = await sb.from('bwa_detail_positionen').select('zeile,wert').eq('bwa_id', bwa.id).eq('ist_summenzeile', true).in('zeile', [1000,1040,1260,1300,1355]);
                if(detCockpit.data && detCockpit.data.length > 0) {
                    var dm = {}; detCockpit.data.forEach(function(d){ dm[d.zeile] = pn(d.wert); });
                    if(dm[1000]) bwa.umsatzerloese = dm[1000];
                    if(dm[1040]) bwa.rohertrag = dm[1040];
                    if(dm[1260]) bwa.gesamtkosten = dm[1260];
                    if(dm[1355]) bwa.ergebnis_vor_steuern = dm[1355];
                    else if(dm[1300]) bwa.ergebnis_vor_steuern = dm[1300];
                }

                // Extract values
                var umsatz = pn(bwa.umsatzerloese);
                var rohertrag = pn(bwa.rohertrag);
                var marge = umsatz ? (rohertrag / umsatz * 100) : 0;
                var gesamtkosten = pn(bwa.gesamtkosten);
                var betriebsergebnis = pn(bwa.betriebsergebnis || bwa.ergebnis_vor_steuern);
                var ergebnis = pn(bwa.ergebnis_vor_steuern);
                var personal = pn(bwa.personalkosten);
                var raum = pn(bwa.raumkosten);
                var werbe = pn(bwa.werbekosten);
                var sonstige = pn(bwa.sonstige_kosten) + pn(bwa.abschreibungen) + pn(bwa.kosten_warenabgabe);
                var ebitMarge = umsatz ? (ergebnis / umsatz * 100) : null;
                var kostenquote = umsatz ? (Math.abs(gesamtkosten) / umsatz * 100) : null;

                // Plan values
                var planUmsatz = pn(bwa.plan_umsatz);
                var planRohertrag = pn(bwa.plan_rohertrag);
                var planErgebnis = pn(bwa.plan_ergebnis);

                // YTD
                var ytdUmsatz = 0, ytdVjUmsatz = 0;
                bwas.forEach(function(b) { ytdUmsatz += pn(b.umsatzerloese); });
                vjBwas.forEach(function(b) { if(b.monat <= latestMonth) ytdVjUmsatz += pn(b.umsatzerloese); });
                var ytdUmsatzVjPct = ytdVjUmsatz ? (ytdUmsatz / ytdVjUmsatz * 100) : null;

                var vjEbitMarge = (vjBwa && pn(vjBwa.umsatzerloese)) ? (pn(vjBwa.ergebnis_vor_steuern) / pn(vjBwa.umsatzerloese) * 100) : null;
                var ebitMargeDelta = (ebitMarge !== null && vjEbitMarge !== null) ? (ebitMarge - vjEbitMarge) : null;

                // Marketing
                var mktUmsatzPct = (umsatz && werbe) ? (Math.abs(werbe) / umsatz * 100) : null;

                // Build HTML
                var h = '';

                // Header
                h += '<div class="flex items-center justify-between mb-6">';
                h += '<div class="flex items-center space-x-3"><h2 class="text-lg font-bold text-vit-orange">Filial-Performance Cockpit</h2>';
                h += '<span class="text-sm text-gray-500">' + stdName + ' | ' + currentYear + '</span></div>';
                h += '<select id="cockpitMonthSel" onchange="cockpitMonth=parseInt(this.value);renderPerformanceCockpit()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm bg-white">';
                for(var mm = 1; mm <= 12; mm++) {
                    var hasBwa = bwas.some(function(b){ return b.monat===mm; });
                    h += '<option value="'+mm+'"'+(mm===latestMonth?' selected':'')+(hasBwa?'':' disabled')+'>'+mLabels[mm]+(hasBwa?'':' (leer)')+'</option>';
                }
                h += '</select></div>';

                // KPI Cards
                var vjUmsatz = vjBwa ? pn(vjBwa.umsatzerloese) : null;
                var vjMarge = vjBwa && pn(vjBwa.umsatzerloese) ? (pn(vjBwa.rohertrag) / pn(vjBwa.umsatzerloese) * 100) : null;
                var umsatzDelta = vjUmsatz ? ((umsatz - vjUmsatz) / vjUmsatz * 100) : null;

                function kpiCard(label, value, suffix, delta, deltaLabel, color) {
                    var c = color || 'text-gray-800';
                    var dStr = '';
                    if(delta !== null && delta !== undefined) {
                        var dColor = delta >= 0 ? 'text-green-600' : 'text-red-500';
                        dStr = '<p class="text-xs mt-1 '+dColor+'">'+(delta>=0?'â–²':'â–¼')+' '+Math.abs(delta).toFixed(1)+(deltaLabel||'')+'</p>';
                    }
                    return '<div class="vit-card p-4 text-center"><p class="text-xs text-gray-500 mb-1">'+label+'</p><p class="text-xl font-bold '+c+'">'+value+(suffix||'')+'</p>'+dStr+'</div>';
                }

                h += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">';
                h += kpiCard('Umsatz', umsatz.toLocaleString('de-DE'), ' â‚¬', umsatzDelta, '% vs VJ');
                h += kpiCard('Rohertrag', rohertrag.toLocaleString('de-DE'), ' â‚¬', null, null);
                h += kpiCard('Marge', marge.toFixed(1), '%', vjMarge !== null ? (marge - vjMarge) : null, ' Pp vs VJ', marge >= 35 ? 'text-green-600' : 'text-orange-500');
                h += kpiCard('Gesamtkosten', Math.abs(gesamtkosten).toLocaleString('de-DE'), ' â‚¬', null, null);
                h += kpiCard('Ergebnis', ergebnis.toLocaleString('de-DE'), ' â‚¬', null, null, ergebnis >= 0 ? 'text-green-600' : 'text-red-600');
                h += kpiCard('EBIT-Marge', ebitMarge !== null ? ebitMarge.toFixed(1) : 'â€”', '%', ebitMargeDelta, ' Pp vs VJ', ebitMarge >= 0 ? 'text-green-600' : 'text-red-500');
                h += kpiCard('Kostenquote', kostenquote !== null ? kostenquote.toFixed(1) : 'â€”', '%', null, null, kostenquote <= 100 ? 'text-blue-600' : 'text-red-500');
                h += kpiCard('YTD Umsatz', ytdUmsatz.toLocaleString('de-DE'), ' â‚¬', ytdUmsatzVjPct ? (ytdUmsatzVjPct - 100) : null, '% vs VJ');
                h += '</div>';

                // Plan vs Ist bars
                if(planUmsatz || planRohertrag || planErgebnis) {
                    h += '<div class="vit-card p-5 mb-6"><h3 class="font-bold text-gray-800 mb-4">Plan vs. Ist</h3>';
                    h += '<div class="space-y-4">';
                    function planBar(label, ist, plan) {
                        if(!plan) return '';
                        var pct = Math.min(Math.round(ist / plan * 100), 150);
                        var color = pct >= 100 ? 'bg-green-500' : pct >= 80 ? 'bg-yellow-400' : 'bg-red-400';
                        return '<div><div class="flex justify-between text-sm mb-1"><span class="text-gray-600">'+label+'</span><span class="font-semibold">'+pct+'%</span></div><div class="w-full bg-gray-100 rounded-full h-3"><div class="'+color+' h-3 rounded-full transition-all" style="width:'+Math.min(pct,100)+'%"></div></div><div class="flex justify-between text-xs text-gray-400 mt-1"><span>Ist: '+ist.toLocaleString('de-DE')+' â‚¬</span><span>Plan: '+plan.toLocaleString('de-DE')+' â‚¬</span></div></div>';
                    }
                    h += planBar('Umsatz', umsatz, planUmsatz);
                    h += planBar('Rohertrag', rohertrag, planRohertrag);
                    h += planBar('Ergebnis', ergebnis, planErgebnis);
                    h += '</div></div>';
                }

                // Kostenstruktur
                h += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">';
                h += '<div class="vit-card p-5"><h3 class="font-bold text-gray-800 mb-4">Kostenstruktur</h3>';
                var totalK = Math.abs(personal) + Math.abs(raum) + Math.abs(werbe) + Math.abs(sonstige);
                function kostenBar(label, val, color) {
                    var pct = totalK ? (Math.abs(val) / totalK * 100) : 0;
                    return '<div class="flex items-center gap-3 mb-3"><span class="text-xs text-gray-500 w-24">'+label+'</span><div class="flex-1 bg-gray-100 rounded-full h-2.5"><div class="'+color+' h-2.5 rounded-full" style="width:'+pct+'%"></div></div><span class="text-xs font-semibold text-gray-600 w-20 text-right">'+Math.abs(val).toLocaleString('de-DE')+' â‚¬</span></div>';
                }
                h += kostenBar('Personal', personal, 'bg-blue-500');
                h += kostenBar('Raum', raum, 'bg-purple-500');
                h += kostenBar('Werbung', werbe, 'bg-orange-500');
                h += kostenBar('Sonstige', sonstige, 'bg-gray-400');
                h += '</div>';

                // Monatsvergleich Trend
                h += '<div class="vit-card p-5"><h3 class="font-bold text-gray-800 mb-4">Umsatz-Trend ' + currentYear + '</h3>';
                if(bwas.length >= 2) {
                    var maxU = Math.max.apply(null, bwas.map(function(b){ return pn(b.umsatzerloese); }));
                    h += '<div class="flex items-end gap-2 h-32">';
                    bwas.forEach(function(b) {
                        var pct = maxU ? (pn(b.umsatzerloese) / maxU * 100) : 0;
                        var isSelected = b.monat === latestMonth;
                        h += '<div class="flex-1 flex flex-col items-center">';
                        h += '<span class="text-[9px] text-gray-500 mb-1">'+pn(b.umsatzerloese).toLocaleString('de-DE')+'</span>';
                        h += '<div class="w-full '+(isSelected?'bg-vit-orange':'bg-gray-300')+' rounded-t" style="height:'+Math.max(pct,5)+'%"></div>';
                        h += '<span class="text-[10px] text-gray-400 mt-1">'+mLabels[b.monat]+'</span></div>';
                    });
                    h += '</div>';
                } else {
                    h += '<p class="text-sm text-gray-400 text-center py-4">Mindestens 2 Monate fÃ¼r Trend nÃ¶tig.</p>';
                }
                h += '</div></div>';

                // Marketing KPI + Benchmark (coming soon)
                h += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
                h += '<div class="vit-card p-5"><h3 class="font-bold text-gray-800 mb-3">Marketing-Kennzahlen</h3>';
                h += '<div class="space-y-3">';
                h += '<div class="flex justify-between text-sm"><span class="text-gray-500">Werbekosten</span><span class="font-semibold">'+Math.abs(werbe).toLocaleString('de-DE')+' â‚¬</span></div>';
                h += '<div class="flex justify-between text-sm"><span class="text-gray-500">% vom Umsatz</span><span class="font-semibold '+(mktUmsatzPct && mktUmsatzPct <= 5 ? 'text-green-600' : 'text-orange-500')+'">'+(mktUmsatzPct ? mktUmsatzPct.toFixed(1) : 'â€”')+'%</span></div>';
                h += '</div></div>';
                h += '<div class="vit-card p-5 opacity-50"><h3 class="font-bold text-gray-800 mb-3">ðŸ”’ Netzwerk-Benchmark</h3>';
                h += '<p class="text-sm text-gray-400 py-4 text-center">VerfÃ¼gbar sobald Netzwerk-Daten aggregiert werden.</p></div>';
                h += '</div>';

                el.innerHTML = h;
            } catch(err) {
                console.error('[COCKPIT]', err);
                el.innerHTML = '<div class="text-center py-8"><p class="text-red-400 text-sm">Fehler beim Laden: ' + err.message + '</p><button onclick="renderPerformanceCockpit()" class="mt-2 text-sm text-vit-orange underline">Erneut versuchen</button></div>';
            }
        }

        // Hook HQ views into showView
        var origShowView2 = showView;
        showView = function(v) {
            // RechteprÃ¼fung
            if(!hasAccess(v)) {
                alert('Kein Zugriff auf diesen Bereich mit Ihrer aktuellen Rolle.');
                return;
            }
            // Redirect 'home' to HQ Cockpit when in HQ mode
            if(v==='home' && currentRole==='hq') { v='hqCockpit'; }
            origShowView2(v);
            if(v==='hqCockpit') renderHqCockpit();
            if(v==='hqStandorte') renderHqStandorte();
            if(v==='hqFinanzen') renderHqFinanzen();
            if(v==='hqMarketing') { renderHqMarketing(); showHqMktTab('uebersicht'); }
            if(v==='allgemein') { loadAllgemeinData().then(function(){ showAllgemeinTab('uebersicht'); }); }
            if(v==='home') { loadDashboardWidgets(); loadAllgemeinData(); }
            if(v==='einkauf') { showEinkaufTab('sortiment'); }
            if(v==='hqAllgemein') { renderHqAllgemein(hqStandorte, [], [], []); }
            if(v==='hqEinkauf') { showHqEkTab('dash'); }
            if(v==='hqVerkauf') renderHqVerkauf();
            if(v==='hqAktionen') renderHqAktionen();
            if(v==='hqKomm'){showView('hqKommando');showKommandoTab('kommunikation');return;}
            if(v==='hqKampagnen'){showView('hqKommando');showKommandoTab('kampagnen');return;}
            if(v==='hqDokumente'){showView('hqKommando');showKommandoTab('dokumente');return;}
            if(v==='hqKalender'){showView('hqKommando');showKommandoTab('kalender');return;}
            if(v==='hqAufgaben'){showView('hqKommando');showKommandoTab('aufgaben');return;}
            if(v==='hqAuswertung') renderHqAuswertung();
            if(v==='hqWissen') renderHqWissen();
            if(v==='hqSupport') renderHqSupport();
            if(v==='hqIdeen') renderHqIdeen();
            if(v==='hqShop') renderHqShop();
            if(v==='hqEinstellungen') renderHqEinstellungen();
            if(v==='mitarbeiter') renderPartnerMitarbeiter();
            if(v==='hqKommando') renderKommandozentrale();
            if(v==='kalender') loadKalTermine();
            if(v==='todo') loadTodos();
            if(v==='notifications') renderNotifications('all');
            // Auto-Loading for Standort-Views
            if(v==='controlling') { showControllingTab('cockpit'); renderPerformanceCockpit(); loadBwaList(); }
            if(v==='verkauf') { showVerkaufTab('pipeline'); }
            if(v==='kommunikation') { showKommTab('chat'); }
            if(v==='aktenschrank') { loadAktenFiles(); }
            if(v==='devStatus') { renderDevStatus(); }
        };

        // === MOBILE SIDEBAR ===
        function toggleMobileSidebar() {
            var sidebar = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if(sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        function closeMobileSidebar() {
            var sidebar = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if(sidebar) sidebar.classList.remove('mobile-open');
            if(overlay) overlay.classList.remove('active');
        }
        // Auto-close sidebar on navigation (mobile)
        var origShowViewMobile = showView;
        showView = function(v) {
            closeMobileSidebar();
            origShowViewMobile(v);
        };

        // === VIEW MODE SWITCHER (Partner vs HQ) ===
        function switchViewMode(mode) {
            var isHQ = mode === 'hq';

            if(isHQ) {
                currentRole = 'hq';
                // Keep original roles but add hq
                if(currentRoles.indexOf('hq') < 0) currentRoles.push('hq');
            } else {
                // Remove hq from roles, restore original
                currentRoles = currentRoles.filter(function(r){ return r !== 'hq'; });
                if(currentRoles.length === 0) currentRoles = ['inhaber'];
                currentRole = currentRoles[0];
            }

            try { updateUIForRole(); } catch(e) { console.warn(e); }
            try { applyModulStatus(); } catch(e) { console.warn(e); }

            if(isHQ) {
                showView('hqCockpit');
            } else {
                showView('home');
            }
        }

        // Init: show partner mode by default
        switchViewMode('partner_grafrath');

        // === SOCIAL MEDIA LOCAL HERO ===
        var smThemen = [
            {id:'c001',thema:'Eure Kundenstories',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas hat euch am meisten ueberrascht nach dem Kauf?"','â€žUnser Kunde faehrt jetzt jeden Tag mit dem Rad zur Arbeit â€“ und hat uns das geschrieben:"'],
                hauptteil:'Kunden vor oder im Laden nach ihrer Erfahrung fragen. Was hat sich veraendert, seit sie das Rad haben? Wie fuehlt sich der Alltag an? Einfach authentisch erzaehlen lassen.',
                cta:'Komm vorbei und werde Teil der vit:bikes Community. Wir freuen uns auf deine Geschichte!',
                hqTipp:'Kurzes, ehrliches Statement vom Kunden ist Gold wert. Handy aufs Stativ, Kunde davor â€“ 30 Sekunden reichen.'
            },
            {id:'c002',thema:'Vario-Sattelstuetze: Lifehack fuer die Ampel',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:'https://www.instagram.com/reel/example_c002/',
                hook:['â€žDu stehst an der Ampel und kommst kaum vom Sattel?"','â€žDieser eine Hebel veraendert alles beim Stadtradeln."'],
                hauptteil:'Zeige die Vario-Sattelstuetze in Aktion: Hebel druecken, Sattel runter, bequem stehen. Erklaere kurz: Nicht nur fuers Gelaende, auch in der Stadt mega praktisch. Verschiedene Modelle erwaehnen.',
                cta:'Vario-Sattelstuetze nachruestbar â€“ komm vorbei, wir zeigen dir welche an dein Rad passt.',
                hqTipp:'Am besten direkt vor dem Laden an der Strasse drehen. Reale Ampel-Situation wirkt authentisch.'
            },
            {id:'c003',thema:'Erzaehl was Schoenes! Positive Kundenerfahrung',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas war euer schoenster Moment mit einem Kunden?"','â€žManchmal passieren im Laden Dinge, die kann man nicht planen."'],
                hauptteil:'Erzaehle eine persoenliche, positive Erfahrung mit einem Kunden. Was hat dich beruehrt, ueberrascht, gluecklich gemacht? Authentisch und emotional.',
                cta:'Bei uns geht es nicht nur ums Rad â€“ sondern um euch. Kommt vorbei!',
                hqTipp:'Kamera auf Stativ, direkt in die Kamera sprechen. Persoenlich und ehrlich â€“ das kommt am besten an.'
            },
            {id:'c008',thema:'Warum das Systemgewicht beim Radfahren zaehlt',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žAlle reden ueber Radgewicht â€“ aber was wirklich zaehlt, ist das Systemgewicht."','â€ž15 kg Rad oder 18 kg? Warum der Unterschied kleiner ist als du denkst."'],
                hauptteil:'Erklaere Systemgewicht = Fahrer + Gepaeck + Rad. Zeige: 3 kg Unterschied am Rad machen bei 100 kg Systemgewicht nur 3% aus. Viel wichtiger: Ergonomie, Komfort, Antrieb. Beim E-Bike relativiert der Motor das Gewicht zusaetzlich.',
                cta:'Wir beraten dich ganzheitlich â€“ nicht nur nach Gewicht. Komm zur Probefahrt!',
                hqTipp:'Mit einer Waage im Laden visualisieren. Rad draufstellen, dann Rucksack dazu â€“ der Aha-Effekt kommt von selbst.'
            },
            {id:'c015',thema:'Unsere Bedarfsanalyse',kat:'Beratung',schwierig:'leicht',done:true,
                beispiel:null,
                hook:['â€žBevor wir dir ein Rad zeigen, stellen wir erstmal Fragen."','â€žDie wichtigste Phase beim Radkauf? Bevor du ueberhaupt aufsteigst."'],
                hauptteil:'Zeige den Beratungsbogen, erklaere die Fragen: Wie oft faehrst du? Welche Strecken? Welcher Untergrund? Koerpergroesse? Beschwerden? Zeige wie du mit dem Kunden zusammen die Beduerfnisse herausarbeitest.',
                cta:'Individuelle Beratung statt Massenware. Vereinbare deinen Beratungstermin!',
                hqTipp:'Beratungssituation nachstellen mit Kollege als Kunde. Natuerlich und locker.'
            },
            {id:'c018',thema:'Aufgeschobener Service wird teuer',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDiesen Fehler machen 80% aller Radfahrer."','â€žKleine Wartung jetzt oder grosse Reparatur spaeter â€“ du hast die Wahl."'],
                hauptteil:'Zeige Beispiele: Verschlissene Kette zerstoert Ritzel (30â‚¬ vs. 150â‚¬). Abgefahrene Bremsbelaege beschaedigen Scheibe. Platter Reifen durch kaputten Mantel. Immer die guenstige Wartung vs. die teure Folge-Reparatur gegenueberstellen.',
                cta:'Mach einen Termin zur Inspektion â€“ bevor es teuer wird. Link in Bio!',
                hqTipp:'Verschleissteile nebeneinander legen: alt vs. neu. Der visuelle Vergleich wirkt sofort.'
            },
            {id:'c019',thema:'Wie eine Vermessung bei uns ablaeuft',kat:'Beratung',schwierig:'mittel',done:true,
                beispiel:null,
                hook:['â€žIn 15 Minuten weisst du mehr ueber deinen Koerper als in 15 Jahren Radfahren."','â€žRadfahren tut weh? Dann stimmt die Vermessung nicht."'],
                hauptteil:'Zeige den Ablauf Schritt fuer Schritt: Beinlaenge messen, Sitzknochenvermessung, Oberkoerper-Flexibilitaet, Ergebnis erklaeren, Rad einstellen. Zeige die Messgeraete und was sie aussagen.',
                cta:'Deine persoenliche Vermessung wartet. Buch deinen Termin â€“ kostenlos beim Neukauf!',
                hqTipp:'Am besten eine echte Vermessung mitfilmen (mit Einverstaendnis des Kunden natuerlich).'
            },
            {id:'c021',thema:'Entspannt bergauf fahren',kat:'Tipps',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žBergauf fahren und dabei laecheln? Geht!"','â€žDie meisten schalten zu spaet â€“ deswegen wird es anstrengend."'],
                hauptteil:'Tipps: Frueh genug runterschalten, gleichmaessige Trittfrequenz 70-80, Oberkoerper locker, Gewicht nach vorne. Beim E-Bike: Richtige Unterstuetzungsstufe waehlen, nicht im hoechsten Modus dauerhaft fahren.',
                cta:'Komm zur Probefahrt und erlebe wie entspannt E-Biken bergauf sein kann!',
                hqTipp:'Am besten draussen an einem kleinen Huegel drehen. Vorher-Nachher mit richtigem vs. falschem Gang.'
            },
            {id:'C024',thema:'Vorstellung vit:Fahrspassgarantie',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWann faehrt man gerne Fahrrad?"','â€žWenn alles passt."'],
                hauptteil:'Beim Neuradkauf gibt es unsere Fahrspassgarantie kostenlos dazu: 3D-Vermessung, Rad perfekt eingestellt, 4 Wochen Rueckgaberecht. Werkstatt max. 48 Stunden â€“ sonst Leihrad. Kleine Nachjustierungen 3 Monate gratis. Zubehoer montieren wir auch spaeter kostenlos.',
                cta:'Am Ende gehts nur darum: Dass Radfahren Spass macht. Komm vorbei!',
                hqTipp:'Elementarer USP! Jeder Standort sollte das drehen. Einfach die 5 Punkte durchgehen, laechelnd.'
            },
            {id:'c022',thema:'Akku im Winter richtig nutzen',kat:'Technik',schwierig:'mittel',done:true,
                beispiel:null,
                hook:['â€žDein E-Bike-Akku leidet im Winter â€“ wenn du diesen Fehler machst."','â€žWeniger Reichweite bei Kaelte? So holst du das Maximum raus."'],
                hauptteil:'Akku bei Zimmertemperatur lagern und erst kurz vor Fahrt einsetzen. Nicht unter 0Â°C laden. Eco-Modus nutzt bei Kaelte mehr als Turbo. Akku nie komplett leer fahren im Winter. Kontakte sauber halten.',
                cta:'Fragen zum Akku? Komm vorbei oder ruf an â€“ wir helfen gerne!',
                hqTipp:'Kann man gut im Laden drehen mit Akku in der Hand. Thermometer daneben stellen als Effekt.'
            },
            {id:'c025',thema:'Sicher anfahren im Winter',kat:'Tipps',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDer gefaehrlichste Moment im Winter? Die ersten 3 Meter."','â€žSo faehrst du sicher los wenn es glatt ist."'],
                hauptteil:'Niedrige Unterstuetzungsstufe beim Anfahren. Sanft in die Pedale, nicht ruckartig. Sattel etwas tiefer fuer bessere Standsicherheit. Reifendruck leicht reduzieren fuer mehr Grip. Immer beide Bremsen gleichmaessig.',
                cta:'Komm zum Winter-Check â€“ wir pruefen Bremsen, Reifen und Licht!',
                hqTipp:'Draussen bei echtem Winterwetter drehen â€“ Authentizitaet schlaegt Studioluft.'
            },
            {id:'c027',thema:'Einfach Bremsbelaege selber tauschen',kat:'Werkstatt',schwierig:'mittel',done:false,
                beispiel:'https://www.instagram.com/reel/DTKkhQjjVoT/',
                hook:['â€žBremsbelaege wechseln ist kein Hexenwerk â€“ wenn man einen wichtigen Schritt kennt."','â€žViele scheitern beim Bremsbelagwechsel an einem Detail: den Bremskolben."'],
                hauptteil:'Bremsbelaege sind Verschleissteile. Abgefahren = schlechtere Bremsleistung. Neue sind dicker, Kolben stehen weiter draussen â†’ muessen zurueckgedrueckt werden. Ablauf: Rad sicher abstellen, Vorderrad ausbauen, alte Belaege raus, Kolben vorsichtig zurueckdruecken (Kunststoff-Montierhebel), neue Belaege rein, Sicherung montieren, Vorderrad einsetzen, Bremse mehrfach ziehen.',
                cta:'Bei Unsicherheit lieber kurz stoppen und bei uns vorbeikommen. Bremsen sind sicherheitsrelevant!',
                hqTipp:'Super einfaches und erfolgreiches Video mit viel Mehrwert. Das kann jeder aus der Werkstatt nachmachen! ðŸ’ª'
            },
            {id:'c028',thema:'Schwalbe Click Valve Ventil',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žReifen aufpumpen nervt? Dieses Ventil aendert alles."','â€žKlick â€“ und die Pumpe sitzt perfekt. Kein Fummelei mehr."'],
                hauptteil:'Zeige das Click-Valve in Aktion: Aufstecken, Klick, pumpen, fertig. Vergleiche mit herkoemmlichem Ventil (Fummelei, Luft entweicht). Erwaehne: Kompatibel mit allen Schwalbe-Schlaeuchen, einfach nachzuruesten.',
                cta:'Click Valve nachruessten? Haben wir da â€“ komm vorbei oder bestell im Shop!',
                hqTipp:'Kurzes Vergleichsvideo: Alt vs. Neu. Der Unterschied verkauft sich von selbst.'
            },
            {id:'c033',thema:'Warum die richtige Rahmengroesse entscheidend ist',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDas falsche Rad in der richtigen Groesse ist besser als das richtige Rad in der falschen."','â€žKnieschmerzen, Rueckenschmerzen, Nackenschmerzen â€“ eine Ursache."'],
                hauptteil:'Zeige zwei gleiche Raeder in verschiedenen Groessen. Erklaere was passiert bei zu gross (Ueberstreckung, Nacken) und zu klein (Knie, Ruecken). Zeige wie ihr die richtige Groesse ermittelt (nicht nur nach Koerpergroesse!).',
                cta:'Sichere Groessenberatung bei uns â€“ kostenlos und unverbindlich.',
                hqTipp:'Am besten mit zwei Raedern nebeneinander und einer Person die beide testet.'
            },
            {id:'c038',thema:'Das ist mein Lieblingsprodukt',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWenn ich nur ein Produkt aus dem Laden mitnehmen duerfte..."','â€žJeder im Team hat einen Favoriten â€“ das ist meiner:"'],
                hauptteil:'Zeig dein persoenliches Lieblingsprodukt (muss kein Rad sein â€“ kann Helm, Schloss, Licht, Tasche sein). Erklaere WARUM es dein Favorit ist. Was macht es besonders? Persoenliche Geschichte dazu.',
                cta:'Was ist dein Must-Have? Komm vorbei und lass dich inspirieren!',
                hqTipp:'Super einfach zu drehen, sehr persoenlich. Ideal fuer Mitarbeiter die zum ersten Mal vor der Kamera stehen.'
            },
            {id:'c060',thema:'So vielseitig ist das vit:bikes Sortiment',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žVon Stadtrad bis Mountainbike â€“ alles unter einem Dach."','â€žWir haben nicht nur E-Bikes. Lass mich dir zeigen was noch geht."'],
                hauptteil:'Schneller Walk-Through durch den Laden. Zeige verschiedene Kategorien: City, Trekking, E-MTB, Cargo, Kinder. Betone die Markenvielfalt und dass fuer jeden was dabei ist.',
                cta:'Egal was du suchst â€“ bei uns findest du es. Oder wir bestellen es fuer dich!',
                hqTipp:'Dynamisch durch den Laden laufen, Kamera auf Gimbal oder einfach in der Hand. Schnelle Schnitte machen wir.'
            },
            {id:'c061',thema:'Knacken am Tretlager â€“ was steckt dahinter?',kat:'Werkstatt',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDein Rad knackt beim Treten? Das kann 5 verschiedene Ursachen haben."','â€žKnackgeraeuesche sind nervig â€“ aber meistens einfach zu beheben."'],
                hauptteil:'Haeufigste Ursachen: Lose Pedalgewinde, Tretlager nachziehen, Sattelklemme, Kettenblattschrauben, Schnellspanner. Zeige wie man systematisch die Ursache eingrenz. Einfache Loesungen vs. wann zum Profi.',
                cta:'Knacken nervt â€“ wir finden die Ursache. Termin vereinbaren!',
                hqTipp:'In der Werkstatt drehen, dabei die verschiedenen Stellen am Rad zeigen und abklopfen.'
            },
            {id:'c063',thema:'Software-Update â€“ wie fuehlt sich das an?',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDein E-Bike bekommt Updates wie dein Handy."','â€žNach dem Update fuehlt sich mein Rad an wie neu â€“ kein Witz."'],
                hauptteil:'Zeige den Update-Prozess: Rad anschliessen, Software pruefen, Update starten. Erklaere was sich aendert: Neue Fahrmodi, bessere Motorsteuerung, Fehlerbehebung. Vergleiche vorher/nachher wenn moeglich.',
                cta:'Kostenloses Software-Update bei uns â€“ einfach Termin machen!',
                hqTipp:'Am besten den Bildschirm zeigen waehrend das Update laeuft. Vorher/Nachher Fahreindruck waere top.'
            },
            {id:'c064',thema:'Der Aha-Moment bei der Probefahrt',kat:'Beratung',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDieser eine Moment auf der Probefahrt â€“ danach will jeder ein E-Bike."','â€žIch sehe es jedes Mal: Dieses Grinsen nach den ersten 50 Metern."'],
                hauptteil:'Beschreibe den typischen Ablauf: Kunde steigt auf, erste Pedalumdrehung, Motor schiebt an, das Laecheln kommt. Erklaere warum die Probefahrt so wichtig ist â€“ Zahlen und Daten ersetzen nicht das Gefuehl.',
                cta:'Erleb es selbst â€“ kostenlose Probefahrt jederzeit bei uns!',
                hqTipp:'Ideal: Filmst den Kunden (mit Erlaubnis!) beim ersten Moment auf dem E-Bike. Das Laecheln sagt alles.'
            },
            {id:'c065',thema:'Bremsen-Check in der Werkstatt',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWann hast du zuletzt deine Bremsen checken lassen?"','â€ž2 Minuten Check â€“ koennen Leben retten."'],
                hauptteil:'Zeige den schnellen Bremsen-Check: Belagstaerke pruefen, Scheibe auf Verschleiss kontrollieren, BremsflÃ¼ssigkeit checken, Zugseil spannen. Was sind Warnzeichen? Quietschen, langer Bremsweg, Hebel geht bis zum Lenker.',
                cta:'Bremsen-Check bei uns â€“ schnell, gruendlich, fuer deine Sicherheit.',
                hqTipp:'Werkstatt-Setting, Nahaufnahme der Bremsbelaege. Vergleich: Neu vs. Verschlissen.'
            },
            {id:'c068',thema:'Warum wir Kunden auch mal vom Kauf abraten',kat:'USP',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žJa, manchmal sagen wir: Kauf das Rad nicht."','â€žEin guter Berater verkaeuft dir nicht das teuerste â€“ sondern das richtige."'],
                hauptteil:'Erklaere wann ihr abratet: Rad passt nicht zur Nutzung, Kunde braucht eigentlich eine andere Kategorie, Budget stimmt nicht (lieber gut gebraucht als schlecht neu). Das schafft Vertrauen und kommt langfristig zurueck.',
                cta:'Ehrliche Beratung statt Verkaufsdruck. Das ist vit:bikes.',
                hqTipp:'Sehr starkes Thema fuer Vertrauensaufbau. Persoenlich in die Kamera, ruhig und ehrlich.'
            },
            {id:'c069',thema:'Akku richtig laden: die 5 groessten Fehler',kat:'Technik',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDu laedt deinen E-Bike-Akku falsch â€“ und merkst es nicht."','â€ž5 Fehler die deinen Akku schneller altern lassen."'],
                hauptteil:'Fehler: 1) Immer auf 100% laden (besser 80%). 2) Komplett leer fahren. 3) Bei Hitze/Kaelte laden. 4) Billig-Ladegeraet nutzen. 5) Akku monatelang voll/leer lagern. Zu jedem Fehler die Loesung.',
                cta:'Fragen zum Akku? Wir beraten dich gerne â€“ auch nach dem Kauf!',
                hqTipp:'5 Punkte = 5 kurze Cuts. Kann man gut nummeriert darstellen (Finger zeigen oder Zahlen einblenden).'
            },
            {id:'c073',thema:'So laeuft ein professioneller Werkstatt-Check ab',kat:'Werkstatt',schwierig:'leicht',done:true,
                beispiel:null,
                hook:['â€ž30 Punkte in 45 Minuten â€“ so gruendlich ist unser Check."','â€žDein Rad bekommt bei uns die volle Behandlung."'],
                hauptteil:'Zeige die einzelnen Pruefpunkte: Bremsen, Schaltung, Reifendruck, Speichenspannung, Tretlager, Steuersatz, Beleuchtung, Akku-Check (E-Bike). Erklaere was geprueft wird und warum.',
                cta:'Dein Rad verdient den besten Service. Termin zur Inspektion jetzt buchen!',
                hqTipp:'Top-Content! Einmal die Werkstatt-Arbeit filmen, verschiedene Stationen zeigen.'
            },
            {id:'c074',thema:'Danke zu 10.000 Follower',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€ž10.000! Danke an jeden einzelnen von euch."','â€žWas als kleiner Kanal angefangen hat..."'],
                hauptteil:'Persoenliches Danke-Video. Rueckblick: Wie alles angefangen hat, Lieblingsmomente, Community-Highlights. Was kommt als naechstes?',
                cta:'Feiert mit uns â€“ kommt im Laden vorbei, es gibt eine kleine Ueberraschung!',
                hqTipp:'Meilenstein-Videos performen super. Team zusammen vor die Kamera, Konfetti optional ðŸŽ‰'
            },
            {id:'c080',thema:'Leasing vs. Kauf â€“ was ist besser?',kat:'Beratung',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žJobRad, Bikeleasing, oder doch bar zahlen?"','â€žSo viel sparst du wirklich beim Leasing â€“ Klartext."'],
                hauptteil:'Vergleiche: Steuerersparnis beim Leasing (bis 40%), dafuer gebunden. Barkauf: Sofort deins, verhandelbar. Finanzierung: Flexibel, aber Zinsen. Fuer wen lohnt sich was? Rechenbeispiel mit konkreten Zahlen.',
                cta:'Wir rechnen es mit dir durch â€“ kostenlos und unverbindlich. Komm vorbei!',
                hqTipp:'Mit Taschenrechner oder Whiteboard. Zahlen sichtbar machen ueberzeugt.'
            },
            {id:'c081',thema:'Rueckenschmerzen auf dem E-Bike',kat:'Ergonomie',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žRueckenschmerzen nach jeder Fahrt? Das muss nicht sein."','â€ž3 Einstellungen die deinen Ruecken sofort entlasten."'],
                hauptteil:'Haeufigste Ursachen: Sattel zu niedrig/hoch, Lenker zu weit weg, falsche Rahmengroesse. Schnelle Fixes: Sattelhoehe anpassen, Vorbau kuerzer/hoeher, ergonomische Griffe. Wann professionelle Vermessung noetig.',
                cta:'Schmerzfrei Radfahren ist moeglich. Komm zur Ergonomie-Beratung!',
                hqTipp:'Person zeigt falsche vs. richtige Sitzposition. Der Unterschied ist sofort sichtbar.'
            },
            {id:'c085',thema:'Probefahren reicht nicht',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDu warst Probefahren und denkst: Passt? Vielleicht nicht."','â€žWarum 10 Minuten Probefahrt nicht reichen fuer die richtige Entscheidung."'],
                hauptteil:'Probefahrt gibt ersten Eindruck, aber: Sitzposition zeigt Probleme erst nach 30+ Minuten. Deshalb machen wir vorab Vermessung. Rueckgaberecht nach 4 Wochen als Sicherheitsnetz. Erst im Alltag zeigt sich ob das Rad passt.',
                cta:'Bei uns hast du 4 Wochen zum Testen. Fahrspassgarantie inklusive!',
                hqTipp:'Starkes USP-Video. Kurz und knackig die Fahrspassgarantie erwaehnen.'
            },
            {id:'c088',thema:'Erklaere die MyO-Konfiguration von Orbea',kat:'Technik',schwierig:'schwer',done:false,
                beispiel:null,
                hook:['â€žDein Rad, deine Farbe, deine Ausstattung â€“ so geht Individualisierung."','â€žOrbea MyO: Wie du dein Traumrad selbst zusammenstellst."'],
                hauptteil:'Zeige den MyO-Konfigurator am Bildschirm oder Tablet. Schritt fuer Schritt: Modell waehlen, Farbe anpassen, Komponenten auswaehlen. Lieferzeit erwaehnen. Vorteil: Einzigartiges Rad, kein Aufpreis fuer Farbwahl.',
                cta:'Lust auf dein individuelles Orbea? Wir konfigurieren es gemeinsam mit dir!',
                hqTipp:'Bildschirmaufnahme vom Konfigurator + Reaktion des Beraters. Oder Kunde konfiguriert live.'
            },
            {id:'c089',thema:'Die Raduebergabe bei vit:bikes',kat:'USP',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDie Uebergabe ist der schoenste Moment â€“ fuer uns und fuer euch."','â€žDein neues Rad wartet. So uebergeben wir es dir."'],
                hauptteil:'Zeige den Ablauf: Rad nochmal komplett gecheckt, alles eingestellt, Funktionen erklaert (E-Bike: Display, Modi, Akku). Erste gemeinsame Runde. Fotos fuer Social Media (mit Erlaubnis). Serviceplan erklaeren.',
                cta:'Bald ist dein Rad dran. Wir freuen uns darauf!',
                hqTipp:'Die strahlenden Gesichter bei der Uebergabe sind unbezahlbar. Authentische Freude filmen.'
            },
            {id:'c091',thema:'Sitzknochenvermessung',kat:'Ergonomie',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žDein Po schmerzt beim Radfahren? Dein Sattel ist nicht schuld â€“ du sitzt falsch."','â€žDie wichtigste Zahl beim Sattelkauf: Dein Sitzknochenabstand."'],
                hauptteil:'Erklaere: Jeder hat andere Sitzknochen. Breite messen (Gel-Pad oder Wellpappe). Richtige Sattelbreite ableiten. Zeige verschiedene Saettel fuer verschiedene Breiten. Sitzposition sportlich vs. aufrecht macht auch einen Unterschied.',
                cta:'Kostenlose Sitzknochenvermessung bei uns â€“ in 5 Minuten zum perfekten Sattel!',
                hqTipp:'Vermessungs-Prozess filmen. Der Moment wenn der Kunde die Zahl erfaehrt ist immer spannend.'
            },
            {id:'c095',thema:'Kette reinigen â€“ auch im Winter',kat:'Werkstatt',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žIm Winter rostet deine Kette 3x so schnell."','â€ž5 Minuten Pflege sparen dir 80 Euro Kettenwechsel."'],
                hauptteil:'Zeige: Kette mit Kettenreiniger reinigen, trocknen lassen, frisches Kettenoel auftragen. Im Winter oefter noetig wegen Salz und Naesse. Warnung: Zu viel Oel zieht Schmutz an!',
                cta:'Kettenreiniger und -oel bei uns im Shop. Oder wir machen das fuer dich!',
                hqTipp:'Nahaufnahme der Kette: Schmutzig â†’ Sauber. Vorher/Nachher ist super Content.'
            },
            {id:'c096',thema:'Riese & Mueller Vorstellung',kat:'Technik',schwierig:'mittel',done:false,
                beispiel:null,
                hook:['â€žMade in Germany, und das merkt man."','â€žWarum Riese & Mueller Premium ist â€“ und es sich lohnt."'],
                hauptteil:'Markenvorstellung: Darmstadt, Handmontage, Qualitaet. Zeige 2-3 Modelle im Laden. Was macht R&M besonders? DualBattery, Vollfederung, Cargo-Loesungen. Fuer wen ideal?',
                cta:'Riese & Mueller Probefahrt bei uns â€“ erlebe den Unterschied!',
                hqTipp:'Wenn R&M im Laden steht, direkt dort filmen. Qualitaet zeigen, Details hervorheben.'
            },
            {id:'c099',thema:'Was ist das Smartphone Grip?',kat:'Technik',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDein Handy am Lenker â€“ aber sicher."','â€žNavigation, Musik, Fitness â€“ alles auf dem Rad. So befestigst du es richtig."'],
                hauptteil:'Zeige verschiedene Smartphone-Halterungen: Quad Lock, SP Connect, universelle Loesungen. Vor- und Nachteile. Wichtig: Vibrationen koennen Kamera beschaedigen! Anti-Vibrations-Modul erwaehnen.',
                cta:'Smartphone-Halterung nachruestbar â€“ wir beraten dich welche passt!',
                hqTipp:'Zeige die Montage und das Einrasten des Handys. Der Klick-Moment ist befriedigend.'
            },
            {id:'c101',thema:'Helmberatung',kat:'Beratung',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žDer beste Helm ist der, den du auch wirklich aufsetzt."','â€ž95% tragen ihren Helm falsch. Gehoerst du dazu?"'],
                hauptteil:'Richtigen Sitz zeigen: 2 Finger ueber Augenbrauen, Riemen bilden V unter den Ohren, ein Finger zwischen Kinn und Riemen. Verschiedene Typen: City, MTB, Speed-Pedelec. MIPS erklaeren. Wann Helm tauschen (nach Sturz, nach 5 Jahren).',
                cta:'Helmberatung bei uns â€“ finde den perfekten Helm fuer dich.',
                hqTipp:'Helm falsch aufsetzen, dann richtig. Der Unterschied ist deutlich und lehrreich.'
            },
            {id:'c103',thema:'Was faehrt vit:bikes? Team stellt ihre Raeder vor',kat:'Story',schwierig:'leicht',done:false,
                beispiel:null,
                hook:['â€žWas fahren eigentlich die, die den ganzen Tag Raeder verkaufen?"','â€žUnser Team zeigt: Das sind unsere persoenlichen Raeder."'],
                hauptteil:'Jedes Teammitglied stellt kurz sein eigenes Rad vor: Was ist es, warum genau das, was ist das Besondere daran? Persoenlich und authentisch.',
                cta:'Welches Rad passt zu dir? Wir helfen dir â€“ aus eigener Erfahrung!',
                hqTipp:'Jeder Mitarbeiter 15-20 Sekunden mit seinem Rad. Zusammenschneiden wir. Super Team-Content!'
            }
        ];

        var smRankingData = [
            {name:'Pfaffenhofen',count:7},{name:'Witten',count:6},{name:'Berlin',count:6},
            {name:'Weilheim',count:4},{name:'Grafrath',count:4},{name:'Wachtendonk',count:3},
            {name:'Teisendorf',count:1},{name:'Warendorf',count:1},{name:'Muenster',count:1},{name:'Lohmar',count:1},
            {name:'Karlsdorf',count:0},{name:'Garching',count:0},{name:'Reutlingen',count:0},
            {name:'Holzkirchen',count:0},{name:'Hann. Muenden',count:0},{name:'Zell',count:0},
            {name:'Wesel',count:0},{name:'Rottweil',count:0},{name:'Hamburg',count:0},
            {name:'M-Thalkirchen',count:0},{name:'Muenchen BAL',count:0}
        ];

        // === I18N TRANSLATION SYSTEM ===

        // === NOTIFICATIONS DATA & LOGIC ===
        var notifications = [
            {id:1,type:'hq',icon:'ðŸ“¢',title:'Neue Kampagne: Fruehjahrs-Aktion 2026',desc:'Das HQ hat eine neue Kampagne gestartet. Materialien stehen bereit.',time:'vor 15 Min.',read:false,action:'showView(\'marketing\')'},
            {id:2,type:'system',icon:'âš ï¸',title:'Ticket #1042 eskaliert',desc:'Kunde Huber wartet seit 5 Tagen auf Rueckmeldung.',time:'vor 1 Std.',read:false,action:'showView(\'support\')'},
            {id:3,type:'hq',icon:'ðŸŽ¬',title:'Neues Content-Thema verfuegbar',desc:'Thema C035: "Helmberatung" wurde im Local Hero Katalog ergaenzt.',time:'vor 3 Std.',read:false,action:'showView(\'marketing\');showMarketingTab(\'social\')'},
            {id:4,type:'system',icon:'ðŸ“Š',title:'BWA Januar 2026 verfuegbar',desc:'Die BWA fuer Januar wurde hochgeladen und kann eingesehen werden.',time:'Gestern',read:true,action:'showView(\'controlling\')'},
            {id:5,type:'hq',icon:'ðŸ“‹',title:'Neue Einkaufsrichtlinie',desc:'Aktualisierte Margen-Empfehlung fuer Q1 2026 verfuegbar.',time:'Gestern',read:true,action:'showView(\'einkauf\')'},
            {id:6,type:'system',icon:'âœ…',title:'Onboarding: 70% abgeschlossen',desc:'Du hast 7 von 10 Onboarding-Schritten erledigt.',time:'vor 2 Tagen',read:true,action:'showView(\'onboarding\')'},
            {id:7,type:'hq',icon:'ðŸ†',title:'Verkaufs-Ranking: Platz 3!',desc:'Euer Standort ist im Netzwerk-Ranking auf Platz 3 geklettert.',time:'vor 3 Tagen',read:true,action:'showView(\'verkauf\')'},
            {id:8,type:'system',icon:'ðŸ””',title:'Termin morgen: Probefahrt Hr. Mueller',desc:'Morgen um 10:00 Uhr â€“ Probefahrt E-MTB geplant.',time:'vor 3 Tagen',read:true,action:'showView(\'kalender\')'}
        ];

        function filterNotif(f) {
            document.querySelectorAll('.notif-filter').forEach(function(b){b.className='notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.notif-filter[data-nf="'+f+'"]');
            if(btn)btn.className='notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderNotifications(f);
        }
        function renderNotifications(filter) {
            filter=filter||'all';
            var list=notifications.filter(function(n){
                if(filter==='unread') return !n.read;
                if(filter==='system') return n.type==='system';
                if(filter==='hq') return n.type==='hq';
                return true;
            });
            var el=document.getElementById('notifList'); if(!el)return;
            var h='';
            list.forEach(function(n){
                h+='<div class="vit-card p-4 flex items-start space-x-3 cursor-pointer hover:shadow-md transition '+(n.read?'opacity-70':'')+'" onclick="'+n.action+'">';
                h+='<span class="text-2xl flex-shrink-0">'+n.icon+'</span>';
                h+='<div class="flex-1 min-w-0">';
                h+='<div class="flex items-center space-x-2"><p class="font-semibold text-gray-800 text-sm truncate">'+n.title+'</p>';
                if(!n.read) h+='<span class="notif-dot w-2 h-2 bg-vit-orange rounded-full flex-shrink-0"></span>';
                h+='</div>';
                h+='<p class="text-xs text-gray-500 mt-0.5">'+n.desc+'</p>';
                h+='<p class="text-[10px] text-gray-400 mt-1">'+n.time+'</p>';
                h+='</div>';
                h+='<span class="text-xs px-2 py-0.5 rounded-full '+(n.type==='hq'?'bg-vit-orange text-white':'bg-gray-100 text-gray-500')+'">'+n.type.toUpperCase()+'</span>';
                h+='</div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">ðŸ””</p><p class="text-sm">Keine Benachrichtigungen</p></div>';
            el.innerHTML=h;
        }

        // === KALENDER DATA & LOGIC (DB-backed) ===
        var kalMonth = new Date().getMonth(); var kalYear = new Date().getFullYear();
        var kalTermine = [];
        var kalEditId = null;
        var kalSelectedTeilnehmer = []; // Array of {id, name} for current modal
        var kalStandortUsers = []; // Cached users for teilnehmer dropdown
        var kalCurrentView = 'month'; // 'month' | 'week' | 'day'
        var kalWeekStart = null; // Date object for Monday of current week
        var kalDayDate = null; // Date object for current day view
        var kalHourStart = 7; // First hour shown in week/day grids
        var kalHourEnd = 20; // Last hour shown

        var typeColors = {beratung:'bg-blue-100 text-blue-700 border-blue-300',probefahrt:'bg-green-100 text-green-700 border-green-300',werkstatt:'bg-gray-200 text-gray-700 border-gray-300',meeting:'bg-purple-100 text-purple-700 border-purple-300',sonstig:'bg-orange-100 text-orange-700 border-orange-300',schulung:'bg-indigo-100 text-indigo-700 border-indigo-300',event:'bg-pink-100 text-pink-700 border-pink-300',deadline:'bg-red-100 text-red-700 border-red-300'};
        var typeLabels = {beratung:'Beratung',probefahrt:'Probefahrt',werkstatt:'Werkstatt',meeting:'Meeting',sonstig:'Sonstiges',schulung:'Schulung',event:'Event',deadline:'Deadline'};
        var typeSolid = {beratung:'bg-blue-500',probefahrt:'bg-green-500',werkstatt:'bg-gray-500',meeting:'bg-purple-500',sonstig:'bg-orange-500',schulung:'bg-indigo-500',event:'bg-pink-500',deadline:'bg-red-500'};

        // Init week/day to current
        (function(){
            var now=new Date(); var day=now.getDay(); var diff=now.getDate()-day+(day===0?-6:1);
            kalWeekStart=new Date(now.getFullYear(),now.getMonth(),diff);
            kalDayDate=new Date(now.getFullYear(),now.getMonth(),now.getDate());
        })();

        // === VIEW SWITCHING ===
        function switchKalView(view){
            kalCurrentView=view;
            document.querySelectorAll('.kal-view-btn').forEach(function(b){b.className='kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500';});
            var btn=document.getElementById('kalViewBtn'+view.charAt(0).toUpperCase()+view.slice(1));
            if(btn)btn.className='kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-white text-gray-800 shadow-sm';
            document.getElementById('kalMonthContainer').style.display=view==='month'?'':'none';
            document.getElementById('kalWeekContainer').style.display=view==='week'?'':'none';
            document.getElementById('kalDayContainer').style.display=view==='day'?'':'none';
            kalRenderActive();
        }

        // Unified navigation
        function kalNav(dir){
            if(kalCurrentView==='month'){kalMonth+=dir;if(kalMonth>11){kalMonth=0;kalYear++;}if(kalMonth<0){kalMonth=11;kalYear--;}
            }else if(kalCurrentView==='week'){kalWeekStart=new Date(kalWeekStart.getTime()+dir*7*86400000);
            }else if(kalCurrentView==='day'){kalDayDate=new Date(kalDayDate.getTime()+dir*86400000);}
            kalRenderActive();
        }
        function kalGoToday(){
            var now=new Date();kalMonth=now.getMonth();kalYear=now.getFullYear();
            var day=now.getDay();var diff=now.getDate()-day+(day===0?-6:1);
            kalWeekStart=new Date(now.getFullYear(),now.getMonth(),diff);
            kalDayDate=new Date(now.getFullYear(),now.getMonth(),now.getDate());
            kalRenderActive();
        }

        function kalRenderActive(){
            kalUpdateNavTitle();
            if(kalCurrentView==='month')renderKalender();
            else if(kalCurrentView==='week')renderKalWeek();
            else if(kalCurrentView==='day')renderKalDay();
        }

        function kalUpdateNavTitle(){
            var months=['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            var dayNames=['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
            var title='';
            if(kalCurrentView==='month'){title=months[kalMonth]+' '+kalYear;}
            else if(kalCurrentView==='week'){
                var end=new Date(kalWeekStart.getTime()+6*86400000);
                if(kalWeekStart.getMonth()===end.getMonth()){
                    title=kalWeekStart.getDate()+'. â€“ '+end.getDate()+'. '+months[end.getMonth()]+' '+end.getFullYear();
                }else{
                    title=kalWeekStart.getDate()+'. '+months[kalWeekStart.getMonth()].slice(0,3)+' â€“ '+end.getDate()+'. '+months[end.getMonth()].slice(0,3)+' '+end.getFullYear();
                }
                // Add KW
                var d=new Date(Date.UTC(kalWeekStart.getFullYear(),kalWeekStart.getMonth(),kalWeekStart.getDate()));
                d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
                var yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
                var kw=Math.ceil((((d-yearStart)/86400000)+1)/7);
                title='KW '+kw+' Â· '+title;
            }
            else if(kalCurrentView==='day'){title=dayNames[kalDayDate.getDay()]+', '+kalDayDate.getDate()+'. '+months[kalDayDate.getMonth()]+' '+kalDayDate.getFullYear();}
            document.getElementById('kalNavTitle').textContent=title;
        }

        // === FILTERED TERMINE HELPER ===
        function kalGetFiltered(){
            var userFilter=(document.getElementById('kalFilterUser')||{}).value||'all';
            return kalTermine.filter(function(t){
                if(userFilter==='me' && sbProfile) return t.erstellt_von===(sbUser?sbUser.id:null) || t.user==='all';
                return true;
            });
        }

        // Helper: format date to YYYY-MM-DD
        function kalFmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}

        // === MONTH VIEW (enhanced existing) ===
        function renderKalender(){
            var filtered=kalGetFiltered();
            var firstDay=new Date(kalYear,kalMonth,1).getDay();
            firstDay=firstDay===0?6:firstDay-1;
            var daysInMonth=new Date(kalYear,kalMonth+1,0).getDate();
            var today=new Date(); var todayStr=kalFmtDate(today);
            var grid=document.getElementById('kalGrid'); var h='';

            for(var i=0;i<firstDay;i++) h+='<div class="min-h-[80px] border-b border-r border-gray-100 p-1 bg-gray-50"></div>';

            for(var d=1;d<=daysInMonth;d++){
                var dateStr=kalYear+'-'+String(kalMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
                var isToday=dateStr===todayStr;
                var dayTermine=filtered.filter(function(t){return t.date===dateStr;});
                h+='<div class="min-h-[80px] border-b border-r border-gray-100 p-1 cursor-pointer hover:bg-blue-50 transition '+(isToday?'bg-orange-50':'')
                    +'" onclick="kalClickDay(\''+dateStr+'\')">';
                h+='<p class="text-xs font-bold '+(isToday?'text-vit-orange':'text-gray-600')+'">'+d+'</p>';
                var shown=0;
                dayTermine.forEach(function(t){
                    if(shown<3){
                        var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                        h+='<div onclick="event.stopPropagation();openTerminDetail(\''+t.id+'\')" class="mt-0.5 px-1 py-0.5 rounded text-[9px] font-semibold truncate border cursor-pointer hover:opacity-80 '+cls+'" title="'+escH(t.title)+'">'+
                            (t.ganztaegig?'â—†':t.time.slice(0,5))+' '+escH(t.title.slice(0,15))+'</div>';
                    }
                    shown++;
                });
                if(dayTermine.length>3) h+='<p class="text-[9px] text-gray-400 mt-0.5">+'+(dayTermine.length-3)+' weitere</p>';
                h+='</div>';
            }
            grid.innerHTML=h;

            // Upcoming list
            var todayStrUp=kalFmtDate(new Date());
            var upcoming=filtered.filter(function(t){return t.date>=todayStrUp;}).sort(function(a,b){return a.date>b.date?1:-1;}).slice(0,8);
            var uEl=document.getElementById('kalUpcoming'); var uh='';
            var dayNamesShort=['So','Mo','Di','Mi','Do','Fr','Sa'];
            upcoming.forEach(function(t){
                var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                var dd=new Date(t.date); var dayName=dayNamesShort[dd.getDay()];
                uh+='<div class="vit-card p-3 flex items-center space-x-3 cursor-pointer hover:shadow-md transition" onclick="openTerminDetail(\''+t.id+'\')">';
                uh+='<div class="text-center flex-shrink-0 w-12"><p class="text-xs text-gray-500">'+dayName+'</p><p class="text-lg font-bold text-gray-800">'+parseInt(t.date.slice(8))+'</p><p class="text-[10px] text-gray-400">'+t.date.slice(5,7)+'</p></div>';
                uh+='<div class="flex-1 min-w-0"><p class="font-semibold text-gray-800 text-sm truncate">'+escH(t.title)+'</p><p class="text-xs text-gray-500">'+(t.ganztaegig?'GanztÃ¤gig':t.time+' Uhr'+(t.endTime?' â€“ '+t.endTime+' Uhr':''))+(t.ort?' Â· '+escH(t.ort):'')+(t.user!=='all'?' Â· '+escH(t.user):'')+'</p>';
                // Teilnehmer
                if(t.teilnehmer && t.teilnehmer.length > 0) {
                    uh+='<p class="text-[10px] text-gray-400 mt-0.5">ðŸ‘¥ '+t.teilnehmer.map(function(tn){return escH(typeof tn==='object'?tn.name:tn);}).join(', ')+'</p>';
                }
                uh+='</div>';
                uh+='<div class="flex flex-col items-end space-y-1">';
                uh+='<span class="text-[10px] px-2 py-0.5 rounded-full font-semibold '+cls+'">'+typeLabels[t.type]+'</span>';
                if(t.serie_id) uh+='<span class="text-[10px] text-gray-400" title="Serie">ðŸ”</span>';
                if(t.ms365_event_id) uh+='<span class="text-[10px] text-blue-500" title="Synced with MS365">ðŸ“…</span>';
                uh+='</div>';
                uh+='</div>';
            });
            uEl.innerHTML=uh||'<div class="text-center py-4 text-gray-400 text-sm">Keine anstehenden Termine.</div>';
        }

        // Click on day in month view â†’ switch to day view
        function kalClickDay(dateStr){
            kalDayDate=new Date(dateStr+'T12:00:00');
            switchKalView('day');
        }

        // === WEEK VIEW ===
        function renderKalWeek(){
            var filtered=kalGetFiltered();
            var todayStr=kalFmtDate(new Date());
            var dayNamesShort=['Mo','Di','Mi','Do','Fr','Sa','So'];

            // Build day columns
            var weekDays=[];
            for(var i=0;i<7;i++){
                var d=new Date(kalWeekStart.getTime()+i*86400000);
                weekDays.push({date:kalFmtDate(d),dayObj:d,label:dayNamesShort[i]+' '+d.getDate()+'.',isToday:kalFmtDate(d)===todayStr});
            }

            // Update headers
            for(var i=0;i<7;i++){
                var hEl=document.getElementById('kalWeekHead'+i);
                if(hEl){
                    hEl.textContent=weekDays[i].label;
                    hEl.className='py-2 text-center text-xs font-semibold '+(weekDays[i].isToday?'text-vit-orange bg-orange-50':'text-gray-600')+(i>=5?' text-orange-400':'');
                }
            }

            // All-day events
            var hasAllDay=false;
            for(var i=0;i<7;i++){
                var adEl=document.getElementById('kalWeekAllDay'+i);
                if(!adEl)continue;
                var adTerms=filtered.filter(function(t){return t.date===weekDays[i].date && t.ganztaegig;});
                var ah='';
                adTerms.forEach(function(t){
                    var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                    ah+='<div onclick="openTerminDetail(\''+t.id+'\')" class="px-1 py-0.5 rounded text-[9px] font-semibold truncate border cursor-pointer hover:opacity-80 '+cls+'" title="'+escH(t.title)+'">'+escH(t.title.slice(0,12))+'</div>';
                });
                adEl.innerHTML=ah;
                adEl.className='p-1.5 border-r border-b border-gray-100 min-h-[32px]'+(weekDays[i].isToday?' bg-orange-50':'');
                if(adTerms.length>0) hasAllDay=true;
            }
            document.getElementById('kalWeekAllDay').style.display=hasAllDay?'':'none';

            // Time grid
            var gridEl=document.getElementById('kalWeekGrid');
            var h='';
            for(var hour=kalHourStart;hour<=kalHourEnd;hour++){
                h+='<div class="grid grid-cols-8 border-b border-gray-50" style="min-height:60px;">';
                h+='<div class="p-1 border-r border-gray-200 text-[10px] text-gray-400 font-semibold text-right pr-2 pt-1 bg-gray-50/50">'+String(hour).padStart(2,'0')+':00</div>';
                for(var col=0;col<7;col++){
                    var dateStr=weekDays[col].date;
                    var cellTerms=filtered.filter(function(t){
                        if(t.ganztaegig) return false;
                        if(t.date!==dateStr) return false;
                        var tHour=parseInt(t.time.split(':')[0]);
                        return tHour===hour;
                    });
                    var bgCls=weekDays[col].isToday?'bg-orange-50/30':'';
                    h+='<div class="border-r border-gray-100 p-0.5 cursor-pointer hover:bg-blue-50/50 relative '+bgCls+'" onclick="kalClickWeekCell(\''+dateStr+'\','+hour+')">';
                    cellTerms.forEach(function(t){
                        var solid=typeSolid[t.type]||'bg-gray-500';
                        var durSlots=1;
                        if(t.endTime){var eh=parseInt(t.endTime.split(':')[0]);durSlots=Math.max(1,eh-hour);}
                        var heightPx=Math.min(durSlots*60,180);
                        h+='<div onclick="event.stopPropagation();openTerminDetail(\''+t.id+'\')" class="'+solid+' text-white rounded px-1.5 py-1 mb-0.5 text-[10px] cursor-pointer hover:opacity-90 shadow-sm overflow-hidden" style="min-height:'+Math.max(24,heightPx-4)+'px;" title="'+escH(t.title)+'">';
                        h+='<p class="font-bold truncate">'+escH(t.title)+'</p>';
                        h+='<p class="opacity-80 truncate">'+t.time+(t.endTime?' â€“ '+t.endTime:'')+(t.ort?' Â· '+escH(t.ort):'')+'</p>';
                        h+='</div>';
                    });
                    h+='</div>';
                }
                h+='</div>';
            }
            gridEl.innerHTML=h;

            // Scroll to current hour
            var nowHour=new Date().getHours();
            if(nowHour>=kalHourStart && nowHour<=kalHourEnd){
                var scrollTo=(nowHour-kalHourStart)*60;
                gridEl.scrollTop=Math.max(0,scrollTo-60);
            }
        }

        function kalClickWeekCell(dateStr,hour){
            kalEditId=null;
            kalSelectedTeilnehmer=[];
            document.getElementById('kalNewTitle').value='';
            document.getElementById('kalNewDate').value=dateStr;
            document.getElementById('kalNewTime').value=String(hour).padStart(2,'0')+':00';
            document.getElementById('kalNewEndTime').value=String(Math.min(hour+1,23)).padStart(2,'0')+':00';
            document.getElementById('kalNewType').value='beratung';
            document.getElementById('kalNewNotes').value='';
            document.getElementById('kalNewOrt').value='';
            document.getElementById('kalNewGanztaegig').checked=false;
            var rptEl=document.getElementById('kalNewRepeat');if(rptEl)rptEl.value='';
            var rptEndEl=document.getElementById('kalNewRepeatEnd');if(rptEndEl)rptEndEl.value='';
            var rptRow=document.getElementById('kalRepeatEndRow');if(rptRow)rptRow.style.display='none';
            document.getElementById('kalTimeFields').style.display='';
            document.getElementById('kalModalTitle').textContent='Neuen Termin anlegen';
            document.getElementById('kalSaveBtn').textContent='Speichern';
            var delBtn=document.getElementById('kalDeleteBtn');if(delBtn)delBtn.style.display='none';
            kalRenderTeilnehmerChips();
            kalLoadTeilnehmerDropdown();
            document.getElementById('kalNewModal').classList.remove('hidden');
        }

        // === DAY VIEW ===
        function renderKalDay(){
            var filtered=kalGetFiltered();
            var dateStr=kalFmtDate(kalDayDate);
            var todayStr=kalFmtDate(new Date());
            var isToday=dateStr===todayStr;
            var dayTermine=filtered.filter(function(t){return t.date===dateStr;});
            var allDayTerms=dayTermine.filter(function(t){return t.ganztaegig;});
            var timedTerms=dayTermine.filter(function(t){return !t.ganztaegig;}).sort(function(a,b){return a.time>b.time?1:-1;});

            // All-day section
            var adEl=document.getElementById('kalDayAllDay');
            var adList=document.getElementById('kalDayAllDayList');
            if(allDayTerms.length>0){
                adEl.style.display='';
                var ah='';
                allDayTerms.forEach(function(t){
                    var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                    ah+='<div onclick="openTerminDetail(\''+t.id+'\')" class="px-3 py-2 rounded-lg border cursor-pointer hover:shadow-sm transition '+cls+'"><span class="font-semibold text-sm">'+escH(t.title)+'</span>'+(t.ort?' <span class="text-xs opacity-70">Â· '+escH(t.ort)+'</span>':'')+'</div>';
                });
                adList.innerHTML=ah;
            }else{adEl.style.display='none';}

            // Hour grid
            var gridEl=document.getElementById('kalDayGrid');
            var h='';
            var nowHour=new Date().getHours();
            var nowMin=new Date().getMinutes();

            for(var hour=kalHourStart;hour<=kalHourEnd;hour++){
                var hourTerms=timedTerms.filter(function(t){return parseInt(t.time.split(':')[0])===hour;});
                var isNowHour=isToday&&hour===nowHour;
                h+='<div class="flex border-b border-gray-50 relative'+(isNowHour?' bg-orange-50/40':'')+'" style="min-height:72px;">';
                h+='<div class="w-16 flex-shrink-0 p-2 border-r border-gray-200 text-right pr-3 bg-gray-50/50"><span class="text-xs text-gray-400 font-semibold">'+String(hour).padStart(2,'0')+':00</span></div>';
                h+='<div class="flex-1 p-1 cursor-pointer hover:bg-blue-50/50 relative" onclick="kalClickWeekCell(\''+dateStr+'\','+hour+')">';

                hourTerms.forEach(function(t){
                    var solid=typeSolid[t.type]||'bg-gray-500';
                    var durMin=60;
                    if(t.endTime){
                        var sh=parseInt(t.time.split(':')[0]),sm=parseInt(t.time.split(':')[1]||0);
                        var eh=parseInt(t.endTime.split(':')[0]),em=parseInt(t.endTime.split(':')[1]||0);
                        durMin=Math.max(30,(eh*60+em)-(sh*60+sm));
                    }
                    var heightPx=Math.max(36,Math.round(durMin/60*72));
                    h+='<div onclick="event.stopPropagation();openTerminDetail(\''+t.id+'\')" class="'+solid+' text-white rounded-lg px-3 py-2 mb-1 cursor-pointer hover:opacity-90 shadow-sm" style="min-height:'+heightPx+'px;">';
                    h+='<p class="font-bold text-sm">'+escH(t.title)+'</p>';
                    h+='<p class="text-xs opacity-80">'+t.time+(t.endTime?' â€“ '+t.endTime:'')+(t.ort?' Â· '+escH(t.ort):'')+'</p>';
                    if(t.notes)h+='<p class="text-xs opacity-70 mt-0.5 truncate">'+escH(t.notes)+'</p>';
                    h+='</div>';
                });

                // Now indicator
                if(isNowHour){
                    var topPct=Math.round((nowMin/60)*72);
                    h+='<div class="absolute left-0 right-0 border-t-2 border-red-500 z-10 pointer-events-none" style="top:'+topPct+'px;"><div class="w-2.5 h-2.5 bg-red-500 rounded-full -mt-1.5 -ml-1"></div></div>';
                }
                h+='</div></div>';
            }
            gridEl.innerHTML=h;

            // Scroll to now
            if(isToday&&nowHour>=kalHourStart&&nowHour<=kalHourEnd){
                gridEl.scrollTop=Math.max(0,(nowHour-kalHourStart)*72-72);
            }

            // Sidebar: list of day's termine
            var months=['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            document.getElementById('kalDaySideTitle').textContent='Termine am '+kalDayDate.getDate()+'. '+months[kalDayDate.getMonth()];
            var sideEl=document.getElementById('kalDaySideList');
            if(dayTermine.length===0){sideEl.innerHTML='<p class="text-sm text-gray-400">Keine Termine an diesem Tag.</p>';
            }else{
                var sh='';
                dayTermine.sort(function(a,b){if(a.ganztaegig&&!b.ganztaegig)return -1;if(!a.ganztaegig&&b.ganztaegig)return 1;return a.time>b.time?1:-1;});
                dayTermine.forEach(function(t){
                    var cls=typeColors[t.type]||'bg-gray-100 text-gray-600';
                    var solid=typeSolid[t.type]||'bg-gray-500';
                    sh+='<div onclick="openTerminDetail(\''+t.id+'\')" class="flex items-start space-x-2 p-2 rounded-lg cursor-pointer hover:bg-gray-50 transition">';
                    sh+='<div class="w-1 rounded-full self-stretch flex-shrink-0 mt-0.5 '+solid+'"></div>';
                    sh+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+escH(t.title)+'</p>';
                    sh+='<p class="text-xs text-gray-500">'+(t.ganztaegig?'GanztÃ¤gig':t.time+(t.endTime?' â€“ '+t.endTime:''))+'</p>';
                    if(t.ort)sh+='<p class="text-xs text-gray-400">ðŸ“ '+escH(t.ort)+'</p>';
                    if(t.teilnehmer && t.teilnehmer.length > 0) sh+='<p class="text-[10px] text-gray-400">ðŸ‘¥ '+t.teilnehmer.map(function(tn){return escH(typeof tn==="object"?tn.name:tn);}).join(", ")+'</p>';
                    sh+='</div><span class="text-[10px] px-1.5 py-0.5 rounded-full font-semibold flex-shrink-0 '+cls+'">'+typeLabels[t.type]+'</span></div>';
                });
                sideEl.innerHTML=sh;
            }

            // Stats
            var statsEl=document.getElementById('kalDayStats');
            var typeCount={};dayTermine.forEach(function(t){typeCount[t.type]=(typeCount[t.type]||0)+1;});
            var statH='<p><span class="font-semibold text-gray-800">'+dayTermine.length+'</span> Termine gesamt</p>';
            Object.keys(typeCount).forEach(function(k){
                statH+='<div class="flex items-center space-x-2"><div class="w-2 h-2 rounded-full '+(typeSolid[k]||'bg-gray-400')+'"></div><span>'+typeCount[k]+'Ã— '+typeLabels[k]+'</span></div>';
            });
            var totalMin=0;timedTerms.forEach(function(t){
                if(t.endTime){var sh=parseInt(t.time.split(':')[0]),sm=parseInt(t.time.split(':')[1]||0),eh=parseInt(t.endTime.split(':')[0]),em=parseInt(t.endTime.split(':')[1]||0);totalMin+=(eh*60+em)-(sh*60+sm);}
            });
            if(totalMin>0){var hrs=Math.floor(totalMin/60);var mins=totalMin%60;statH+='<p class="mt-1">â±ï¸ Verplante Zeit: <span class="font-semibold">'+(hrs>0?hrs+'h ':'')+(mins>0?mins+'min':'')+'</span></p>';}
            statsEl.innerHTML=statH;
        }

        async function loadKalTermine() {
            try {
                var query = sb.from('termine').select('*').order('start_zeit', {ascending:true});
                if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) query = query.eq('standort_id', sbProfile.standort_id);
                var resp = await query;
                if(!resp.error) {
                    kalTermine = (resp.data||[]).map(function(t) {
                        var d = new Date(t.start_zeit);
                        var endTime = t.end_zeit ? new Date(t.end_zeit) : null;
                        return {
                            id: t.id, title: t.titel, 
                            date: d.toISOString().slice(0,10),
                            time: t.ganztaegig ? '00:00' : String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'),
                            endTime: endTime ? String(endTime.getHours()).padStart(2,'0')+':'+String(endTime.getMinutes()).padStart(2,'0') : null,
                            type: t.typ || 'sonstig',
                            user: t.erstellt_von_name || 'all',
                            notes: t.beschreibung || '',
                            ort: t.ort || '',
                            ganztaegig: t.ganztaegig || false,
                            erstellt_von: t.erstellt_von,
                            teilnehmer: t.teilnehmer || [],
                            wiederholung: t.wiederholung || '',
                            wiederholung_bis: t.wiederholung_bis || null,
                            serie_id: t.serie_id || null,
                            ms365_event_id: t.ms365_event_id || null,
                            ms365_sync_status: t.ms365_sync_status || null
                        };
                    });
                } else { kalTermine = []; }
            } catch(e) { console.warn('Kalender load:', e); kalTermine = []; }
            kalRenderActive();
        }

        function kalNavMonth(d){kalNav(d);}

        // Open day view to quickly add termin on that date
        function openKalDayModal(dateStr) {
            kalEditId = null;
            kalSelectedTeilnehmer = [];
            document.getElementById('kalNewTitle').value = '';
            document.getElementById('kalNewDate').value = dateStr;
            document.getElementById('kalNewTime').value = '09:00';
            document.getElementById('kalNewEndTime').value = '10:00';
            document.getElementById('kalNewType').value = 'beratung';
            document.getElementById('kalNewNotes').value = '';
            document.getElementById('kalNewOrt').value = '';
            document.getElementById('kalNewGanztaegig').checked = false;
            var rptEl=document.getElementById('kalNewRepeat'); if(rptEl) rptEl.value='';
            var rptEndEl=document.getElementById('kalNewRepeatEnd'); if(rptEndEl) rptEndEl.value='';
            var rptRow=document.getElementById('kalRepeatEndRow'); if(rptRow) rptRow.style.display='none';
            var rptInfo=document.getElementById('kalRepeatInfo'); if(rptInfo) rptInfo.textContent='';
            document.getElementById('kalModalTitle').textContent = 'Neuen Termin anlegen';
            document.getElementById('kalSaveBtn').textContent = 'Speichern';
            var delBtn = document.getElementById('kalDeleteBtn');
            if(delBtn) delBtn.style.display = 'none';
            kalRenderTeilnehmerChips();
            kalLoadTeilnehmerDropdown();
            document.getElementById('kalNewModal').classList.remove('hidden');
        }

        // Open termin detail/edit
        function openTerminDetail(terminId) {
            var t = kalTermine.find(function(x){ return x.id == terminId; });
            if(!t) return;
            kalEditId = t.id;
            kalSelectedTeilnehmer = (t.teilnehmer || []).map(function(tn) {
                return typeof tn === 'object' ? tn : {id: tn, name: tn};
            });
            document.getElementById('kalNewTitle').value = t.title;
            document.getElementById('kalNewDate').value = t.date;
            document.getElementById('kalNewTime').value = t.time || '09:00';
            document.getElementById('kalNewEndTime').value = t.endTime || '';
            document.getElementById('kalNewType').value = t.type;
            document.getElementById('kalNewNotes').value = t.notes || '';
            document.getElementById('kalNewOrt').value = t.ort || '';
            document.getElementById('kalNewGanztaegig').checked = t.ganztaegig || false;
            var rptEl=document.getElementById('kalNewRepeat'); if(rptEl) rptEl.value=t.wiederholung||'';
            var rptEndEl=document.getElementById('kalNewRepeatEnd'); if(rptEndEl) rptEndEl.value=t.wiederholung_bis||'';
            kalToggleRepeatEnd();
            document.getElementById('kalModalTitle').textContent = 'Termin bearbeiten';
            document.getElementById('kalSaveBtn').textContent = 'Aktualisieren';
            var delBtn = document.getElementById('kalDeleteBtn');
            if(delBtn) delBtn.style.display = '';
            kalRenderTeilnehmerChips();
            kalLoadTeilnehmerDropdown();
            document.getElementById('kalNewModal').classList.remove('hidden');
        }

        async function saveKalTermin(){
            var title=document.getElementById('kalNewTitle').value;
            var date=document.getElementById('kalNewDate').value;
            var time=document.getElementById('kalNewTime').value||'09:00';
            var endTime=document.getElementById('kalNewEndTime').value||null;
            var type=document.getElementById('kalNewType').value;
            var notes=document.getElementById('kalNewNotes').value;
            var ort=document.getElementById('kalNewOrt').value;
            var ganztaegig=document.getElementById('kalNewGanztaegig').checked;
            var repeat=document.getElementById('kalNewRepeat').value||'';
            var repeatEnd=document.getElementById('kalNewRepeatEnd').value||null;
            if(!title||!date){alert('Bitte Titel und Datum angeben.');return;}

            var startZeit = date+'T'+time+':00';
            var endZeit = endTime ? date+'T'+endTime+':00' : null;
            var teilnehmerData = kalSelectedTeilnehmer.map(function(tn){ return {id:tn.id, name:tn.name}; });

            var payload = {
                titel: title, start_zeit: startZeit, end_zeit: endZeit,
                typ: type, beschreibung: notes, ort: ort, ganztaegig: ganztaegig,
                erstellt_von: sbUser ? sbUser.id : null,
                erstellt_von_name: sbProfile ? sbProfile.name : 'Unbekannt',
                standort_id: sbProfile ? sbProfile.standort_id : null,
                teilnehmer: teilnehmerData,
                wiederholung: repeat || null,
                wiederholung_bis: repeatEnd || null
            };

            try {
                if(kalEditId) {
                    var resp = await sb.from('termine').update(payload).eq('id', kalEditId);
                    if(resp.error) throw resp.error;
                } else {
                    // Generate serie_id for repeating events
                    if(repeat && repeatEnd) {
                        var serieId = 'serie_' + Date.now();
                        payload.serie_id = serieId;
                        var dates = kalGenerateRepeatDates(date, repeat, repeatEnd);
                        var inserts = dates.map(function(d) {
                            var p = JSON.parse(JSON.stringify(payload));
                            p.start_zeit = d + 'T' + time + ':00';
                            p.end_zeit = endTime ? d + 'T' + endTime + ':00' : null;
                            return p;
                        });
                        if(inserts.length > 100) { alert('Maximal 100 Wiederholungen erlaubt. Bitte kÃ¼rzeren Zeitraum wÃ¤hlen.'); return; }
                        var resp = await sb.from('termine').insert(inserts);
                        if(resp.error) throw resp.error;
                    } else {
                        var resp = await sb.from('termine').insert(payload);
                        if(resp.error) throw resp.error;
                    }
                }
                document.getElementById('kalNewModal').classList.add('hidden');
                kalEditId = null;
                kalSelectedTeilnehmer = [];
                await loadKalTermine();
            } catch(err) { alert('Fehler: '+(err.message||err)); }
        }

        // Generate repeat dates array
        function kalGenerateRepeatDates(startDate, repeat, endDate) {
            var dates = [];
            var current = new Date(startDate + 'T12:00:00');
            var end = new Date(endDate + 'T12:00:00');
            var maxIterations = 200;
            var i = 0;
            while(current <= end && i < maxIterations) {
                dates.push(kalFmtDate(current));
                if(repeat === 'taeglich') current.setDate(current.getDate() + 1);
                else if(repeat === 'woechentlich') current.setDate(current.getDate() + 7);
                else if(repeat === '2wochen') current.setDate(current.getDate() + 14);
                else if(repeat === 'monatlich') current.setMonth(current.getMonth() + 1);
                else break;
                i++;
            }
            return dates;
        }

        // Toggle repeat end date visibility + calculate count preview
        function kalToggleRepeatEnd() {
            var repeatEl = document.getElementById('kalNewRepeat');
            var endRow = document.getElementById('kalRepeatEndRow');
            if(!repeatEl || !endRow) return;
            var repeat = repeatEl.value;
            if(repeat) {
                endRow.style.display = '';
                kalUpdateRepeatInfo();
            } else {
                endRow.style.display = 'none';
            }
        }

        function kalUpdateRepeatInfo() {
            var repeat = document.getElementById('kalNewRepeat').value;
            var startDate = document.getElementById('kalNewDate').value;
            var endDate = document.getElementById('kalNewRepeatEnd').value;
            var infoEl = document.getElementById('kalRepeatInfo');
            if(!repeat || !startDate || !endDate) { infoEl.textContent = ''; return; }
            var dates = kalGenerateRepeatDates(startDate, repeat, endDate);
            infoEl.textContent = dates.length + ' Termine';
        }

        // Teilnehmer management
        async function kalLoadTeilnehmerDropdown() {
            var select = document.getElementById('kalNewTeilnehmer');
            if(!select) return;
            // Load users if not cached
            if(kalStandortUsers.length === 0) {
                try {
                    var q = sb.from('users').select('id, name').eq('status', 'aktiv');
                    if(sbProfile && sbProfile.standort_id && !sbProfile.is_hq) q = q.eq('standort_id', sbProfile.standort_id);
                    var res = await q;
                    kalStandortUsers = (res.data || []).map(function(u) {
                        return { id: u.id, name: u.name || 'Unbekannt' };
                    });
                } catch(e) { console.warn('Teilnehmer laden:', e); }
            }
            var h = '<option value="">+ Teilnehmer hinzufÃ¼gen...</option>';
            kalStandortUsers.forEach(function(u) {
                // Don't show users already selected
                var already = kalSelectedTeilnehmer.find(function(tn) { return tn.id === u.id; });
                if(!already) {
                    h += '<option value="' + u.id + '">' + escH(u.name) + (u.rolle ? ' (' + u.rolle + ')' : '') + '</option>';
                }
            });
            select.innerHTML = h;
        }

        function kalAddTeilnehmer() {
            var select = document.getElementById('kalNewTeilnehmer');
            var userId = select.value;
            if(!userId) return;
            var user = kalStandortUsers.find(function(u) { return u.id === userId; });
            if(!user) return;
            kalSelectedTeilnehmer.push({ id: user.id, name: user.name });
            kalRenderTeilnehmerChips();
            kalLoadTeilnehmerDropdown(); // refresh to remove selected
            select.value = '';
        }

        function kalRemoveTeilnehmer(userId) {
            kalSelectedTeilnehmer = kalSelectedTeilnehmer.filter(function(tn) { return tn.id !== userId; });
            kalRenderTeilnehmerChips();
            kalLoadTeilnehmerDropdown();
        }

        function kalRenderTeilnehmerChips() {
            var container = document.getElementById('kalTeilnehmerList');
            if(!container) return;
            if(kalSelectedTeilnehmer.length === 0) { container.innerHTML = '<span class="text-xs text-gray-400">Keine Teilnehmer zugewiesen</span>'; return; }
            var h = '';
            kalSelectedTeilnehmer.forEach(function(tn) {
                h += '<span class="inline-flex items-center space-x-1 bg-blue-50 text-blue-700 text-xs font-semibold px-2 py-1 rounded-full">';
                h += '<span>' + escH(tn.name) + '</span>';
                h += '<button onclick="kalRemoveTeilnehmer(\'' + tn.id + '\')" class="text-blue-400 hover:text-red-500 ml-0.5">Ã—</button>';
                h += '</span>';
            });
            container.innerHTML = h;
        }

        async function deleteKalTermin() {
            if(!kalEditId) return;
            var t = kalTermine.find(function(x){ return x.id == kalEditId; });

            if(t && t.serie_id) {
                var choice = prompt('Dieser Termin gehÃ¶rt zu einer Serie.\n\n1 = Nur diesen Termin lÃ¶schen\n2 = Alle Termine der Serie lÃ¶schen\n\nBitte 1 oder 2 eingeben:', '1');
                if(!choice) return;
                try {
                    if(choice === '2') {
                        var resp = await sb.from('termine').delete().eq('serie_id', t.serie_id).select();
                        if(resp.error) throw resp.error;
                        if(!resp.data || resp.data.length === 0) throw new Error('LÃ¶schen fehlgeschlagen â€“ evtl. fehlende Berechtigung. Bitte Admin kontaktieren.');
                    } else {
                        var resp = await sb.from('termine').delete().eq('id', kalEditId).select();
                        if(resp.error) throw resp.error;
                        if(!resp.data || resp.data.length === 0) throw new Error('LÃ¶schen fehlgeschlagen â€“ evtl. fehlende Berechtigung. Bitte Admin kontaktieren.');
                    }
                    document.getElementById('kalNewModal').classList.add('hidden');
                    kalEditId = null;
                    await loadKalTermine();
                } catch(err) { alert('Fehler: '+(err.message||err)); }
            } else {
                if(!confirm('Termin wirklich lÃ¶schen?')) return;
                try {
                    var resp = await sb.from('termine').delete().eq('id', kalEditId).select();
                    if(resp.error) throw resp.error;
                    if(!resp.data || resp.data.length === 0) throw new Error('LÃ¶schen fehlgeschlagen â€“ evtl. fehlende Berechtigung. Bitte Admin kontaktieren.');
                    document.getElementById('kalNewModal').classList.add('hidden');
                    kalEditId = null;
                    await loadKalTermine();
                } catch(err) { alert('Fehler: '+(err.message||err)); }
            }
        }

        // === MS365 CALENDAR SYNC PREPARATION ===
        // Data model: termine table has ms365_event_id and ms365_sync_status columns
        // Sync flow: 
        //   1. User connects MS365 account (OAuth2 via Azure AD)
        //   2. On termin create/update/delete â†’ push to MS365 Graph API
        //   3. Periodic pull from MS365 â†’ merge into termine table
        //   4. Conflict resolution: last-write-wins with ms365_last_synced timestamp
        //
        // Graph API endpoints:
        //   POST   /me/events                    â†’ Create event
        //   PATCH  /me/events/{id}               â†’ Update event  
        //   DELETE /me/events/{id}               â†’ Delete event
        //   GET    /me/calendarView?startDateTime=&endDateTime= â†’ Pull events
        //
        // Required Azure AD app permissions: Calendars.ReadWrite
        //
        // Implementation: Supabase Edge Function that:
        //   1. Receives webhook from termine table changes
        //   2. Calls MS Graph API with user's OAuth token
        //   3. Stores ms365_event_id back in termine row
        //   4. Cron job for periodic bidirectional sync

        async function syncTerminToMs365(terminId) {
            // Placeholder: will be implemented via Supabase Edge Function
            var t = kalTermine.find(function(x){ return x.id == terminId; });
            if(!t) return;
            console.log('[MS365 Sync] Would sync termin:', t.title, 'to MS365');
            // Future: await sb.functions.invoke('ms365-calendar-sync', { body: { action: 'push', termin_id: terminId } });
        }

        async function pullMs365Events() {
            // Placeholder: pull events from MS365 and merge into termine table
            console.log('[MS365 Sync] Would pull events from MS365');
            // Future: var resp = await sb.functions.invoke('ms365-calendar-sync', { body: { action: 'pull' } });
        }

        // === AUFGABEN MODULE v2.0 â€“ Todoist-Inspired (Vanilla JS + Supabase) ===
        var todoState = {
            todos: [], sections: [], labels: [], comments: {},
            filter: 'all', view: 'list', search: '', selectedId: null,
            collapsedSecs: {}
        };
        var TODO_TODAY = new Date().toISOString().slice(0,10);
        var TODO_PRIO = {
            dringend:{icon:'ðŸ”´',border:'border-red-400',bg:'bg-red-500',sort:-1},
            hoch:{icon:'ðŸŸ ',border:'border-yellow-500',bg:'bg-yellow-500',sort:0},
            normal:{icon:'ðŸŸ¡',border:'border-gray-300',bg:'bg-gray-400',sort:1},
            niedrig:{icon:'ðŸŸ¢',border:'border-green-400',bg:'bg-green-500',sort:2}
        };
        var TODO_CAT = {verkauf:{icon:'ðŸ’°',label:'Verkauf'},werkstatt:{icon:'ðŸ”§',label:'Werkstatt'},marketing:{icon:'ðŸ“£',label:'Marketing'},admin:{icon:'ðŸ“‹',label:'Admin'},sonstig:{icon:'ðŸ“Œ',label:'Sonstiges'}};
        var TODO_SRC = {system:{icon:'ðŸ¤–',label:'System',cls:'bg-blue-50 text-blue-600 border border-blue-100'},hq:{icon:'ðŸ¢',label:'HQ',cls:'bg-purple-50 text-purple-600 border border-purple-100'}};

        // â”€â”€ Load all data â”€â”€
        async function loadTodos() {
            try {
                var sid = sbProfile ? sbProfile.standort_id : null;
                var isHQ = sbProfile && sbProfile.is_hq;

                // Todos
                var q = sb.from('todos').select('*').order('prio_sort',{ascending:true}).order('faellig_am',{ascending:true,nullsFirst:false});
                if(sid && !isHQ) q = q.eq('standort_id', sid);
                var r = await q;
                todoState.todos = (!r.error && r.data) ? r.data : [];

                // Sections
                var sq = sb.from('todo_sections').select('*').order('sort_order',{ascending:true});
                if(sid && !isHQ) sq = sq.eq('standort_id', sid);
                var sr = await sq;
                todoState.sections = (!sr.error && sr.data) ? sr.data : [];

                // Ensure "Eingang" section exists
                if(!todoState.sections.find(function(s){return s.name==='Eingang';})) {
                    var ins = await sb.from('todo_sections').insert({name:'Eingang',standort_id:sid,sort_order:0}).select();
                    if(ins.data && ins.data[0]) todoState.sections.unshift(ins.data[0]);
                }

                // Labels
                var lq = sb.from('todo_labels').select('*').order('name');
                if(sid && !isHQ) lq = lq.or('standort_id.eq.'+sid+',standort_id.is.null');
                var lr = await lq;
                todoState.labels = (!lr.error && lr.data) ? lr.data : [];

                // Store info in sidebar

            } catch(e) { console.warn('loadTodos:', e); }
            todoRender();
        }

        // â”€â”€ Counts â”€â”€
        function todoCounts() {
            var parents = todoState.todos.filter(function(t){return !t.parent_id;});
            return {
                open: parents.filter(function(t){return !t.erledigt;}).length,
                today: parents.filter(function(t){return !t.erledigt && t.faellig_am===TODO_TODAY;}).length,
                overdue: parents.filter(function(t){return !t.erledigt && t.faellig_am && t.faellig_am<TODO_TODAY;}).length,
                done: parents.filter(function(t){return t.erledigt;}).length
            };
        }

        // â”€â”€ Set Filter â”€â”€
        function todoSetFilter(f) {
            todoState.filter = f;
            var titles = {all:'Alle Aufgaben',heute:'Heute',ueberfaellig:'ÃœberfÃ¤llig',done:'Erledigt'};
            var h1 = document.getElementById('todoHeaderTitle');
            if(h1) h1.textContent = titles[f] || 'Aufgaben';
            // KPI highlight
            document.querySelectorAll('.todo-kpi').forEach(function(b){ b.style.background=''; b.style.boxShadow=''; });
            var kpiColors = {all:'#fafaf9',heute:'#fff7ed',ueberfaellig:'#fef2f2',done:'#f0fdf4'};
            var kpiBtn = document.querySelector('.todo-kpi[data-kpi="'+f+'"]');
            if(kpiBtn) { kpiBtn.style.background=kpiColors[f]||''; kpiBtn.style.boxShadow='0 0 0 1px #e7e5e4'; }
            todoRender();
        }

        // â”€â”€ Set View â”€â”€
        function todoSetView(v) {
            todoState.view = v;
            var lb = document.getElementById('todoViewListBtn');
            var bb = document.getElementById('todoViewBoardBtn');
            if(lb) lb.className = 'px-2 py-1 rounded-md text-[11px] ' + (v==='list' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700');
            if(bb) bb.className = 'px-2 py-1 rounded-md text-[11px] ' + (v==='board' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700');
            todoRender();
        }

        function todoSearchChanged() {
            todoState.search = (document.getElementById('todoSearchInput')||{}).value || '';
            todoRender();
        }

        // â”€â”€ Filter tasks â”€â”€
        function todoFilteredParents() {
            var f = todoState.filter, s = todoState.search.toLowerCase();
            return todoState.todos.filter(function(t) {
                if(t.parent_id) return false;
                if(s && t.titel.toLowerCase().indexOf(s)===-1 && (!t.beschreibung || t.beschreibung.toLowerCase().indexOf(s)===-1)) return false;
                if(f==='all') return !t.erledigt;
                if(f==='heute') return !t.erledigt && t.faellig_am===TODO_TODAY;
                if(f==='ueberfaellig') return !t.erledigt && t.faellig_am && t.faellig_am<TODO_TODAY;
                if(f==='done') return t.erledigt;
                return !t.erledigt;
            });
        }

        // â”€â”€ Main render â”€â”€
        function todoRender() {
            var c = todoCounts();
            // KPIs
            var e1=document.getElementById('kpiOpen2');if(e1)e1.textContent=c.open;
            var e2=document.getElementById('kpiToday2');if(e2)e2.textContent=c.today;
            var e3=document.getElementById('kpiOverdue2');if(e3)e3.textContent=c.overdue;
            var e4=document.getElementById('kpiDone2');if(e4)e4.textContent=c.done;
            // Header sub
            var hs=document.getElementById('todoHeaderSub');if(hs) hs.textContent=c.open+' offen Â· '+c.today+' heute Â· '+c.overdue+' Ã¼berfÃ¤llig';
            // Sidebar badges
            // Sidebar badge in nav
            var navBadge=document.getElementById('todoSidebarBadge');if(navBadge)navBadge.textContent=c.open;

            // List or Board
            var area = document.getElementById('todoListArea');
            if(!area) return;
            if(todoState.view === 'list') area.innerHTML = todoListHTML();
            else area.innerHTML = todoBoardHTML();

            // Detail panel
            todoRenderDetail();
        }

        // â”€â”€ Quick Add HTML â”€â”€
        // â”€â”€ Create New Task (opens detail panel) â”€â”€
        var todoStandortUsers = [];
        async function todoLoadStandortUsers() {
            if(todoStandortUsers.length) return;
            try {
                var sid = sbProfile ? sbProfile.standort_id : null;
                var q = sb.from('users').select('id, name').eq('status','aktiv');
                if(sid && !(sbProfile&&sbProfile.is_hq)) q = q.eq('standort_id', sid);
                var r = await q;
                todoStandortUsers = (!r.error && r.data) ? r.data : [];
            } catch(e) { console.warn('Users load:', e); }
        }

        async function todoCreateNew() {
            await todoLoadStandortUsers();
            var inbox = todoState.sections.find(function(s){return s.name==='Eingang';});
            try {
                var resp = await sb.from('todos').insert({
                    standort_id:sbProfile?sbProfile.standort_id:null, erstellt_von:sbUser?sbUser.id:null,
                    titel:'Neue Aufgabe', prio:'normal', prio_sort:1,
                    kategorie:'sonstig', section_id:inbox?inbox.id:null, erledigt:false
                }).select();
                if(resp.error) throw resp.error;
                if(resp.data&&resp.data[0]) {
                    todoState.todos.unshift(resp.data[0]);
                    todoState.selectedId = resp.data[0].id;
                    todoState.filter = 'all';
                    todoRender();
                    // Focus title input in detail panel
                    setTimeout(function(){
                        var inp = document.querySelector('#todoDetailPanel input[type="text"]');
                        if(inp) { inp.select(); inp.focus(); }
                    }, 100);
                }
            } catch(e) { console.error(e); alert('Fehler: '+e.message); }
        }

                // â”€â”€ List View HTML â”€â”€
        function todoListHTML() {
            var parents = todoFilteredParents();
            var secs = todoState.sections.slice().sort(function(a,b){return (a.sort_order||0)-(b.sort_order||0);});
            // Group: assigned section, or "unsorted"
            var h = '';

            secs.forEach(function(sec) {
                var tasks = parents.filter(function(t){return t.section_id===sec.id;});
                if(!tasks.length && todoState.filter !== 'all') return;
                var collapsed = todoState.collapsedSecs[sec.id];
                h += '<div class="mb-1">';
                // Section header
                h += '<div class="group flex items-center space-x-2 py-1 px-1 cursor-pointer" onclick="todoToggleSec(\''+sec.id+'\')">';
                h += '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-gray-400" style="transform:rotate('+(collapsed?'0':'90')+'deg);transition:transform 150ms"><path d="M9 18l6-6-6-6"/></svg>';
                h += '<h3 class="font-bold text-gray-500 uppercase" style="font-size:11px;letter-spacing:0.05em">'+escH(sec.name)+'</h3>';
                h += '<span class="text-gray-400 text-[10px]">'+tasks.length+'</span>';
                h += '<div class="flex-1"></div>';
                if(sec.name!=='Eingang') h += '<button onclick="event.stopPropagation();todoDeleteSec(\''+sec.id+'\')" class="text-gray-400 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100">âœ•</button>';
                h += '</div>';
                // Tasks
                if(!collapsed) {
                    if(tasks.length) {
                        tasks.forEach(function(t){ h += todoRowHTML(t, 0); });
                    } else {
                        h += '<p class="text-xs text-gray-400 italic px-3 py-1">Keine Aufgaben</p>';
                    }
                }
                h += '</div>';
            });

            // Unsectioned tasks
            var unsec = parents.filter(function(t){return !t.section_id || !todoState.sections.find(function(s){return s.id===t.section_id;});});
            if(unsec.length) {
                h += '<div class="mb-1"><div class="flex items-center space-x-2 py-1 px-1"><h3 class="font-bold text-gray-500 uppercase" style="font-size:11px;letter-spacing:0.05em">Ohne Sektion</h3><span class="text-gray-400 text-[10px]">'+unsec.length+'</span></div>';
                unsec.forEach(function(t){ h += todoRowHTML(t, 0); });
                h += '</div>';
            }

            // Add section button
            h += '<div class="mt-3 px-1"><button onclick="todoAddSecPrompt()" class="text-xs text-gray-400 hover:text-vit-orange flex items-center space-x-1">' +
                '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>' +
                '<span>Sektion hinzufÃ¼gen</span></button></div>';

            return h;
        }

        // â”€â”€ Single Task Row â”€â”€
        function todoRowHTML(task, depth) {
            var subs = todoState.todos.filter(function(t){return t.parent_id===task.id;});
            var doneSubs = subs.filter(function(s){return s.erledigt;}).length;
            var p = TODO_PRIO[task.prio]||TODO_PRIO.normal;
            var isOver = !task.erledigt && task.faellig_am && task.faellig_am < TODO_TODAY;
            var isToday = task.faellig_am === TODO_TODAY;
            var isSel = todoState.selectedId === task.id;
            var isOwn = task.erstellt_von === (sbUser?sbUser.id:null);
            var isSystem = task.typ==='system';
            var isHQTask = task.typ==='hq';
            var isEsc = task.eskalation_stufe >= 2;
            var assigneeName = task.zugewiesen && task.zugewiesen.name ? task.zugewiesen.name : null;
            var fmtD = task.faellig_am ? task.faellig_am.slice(8)+'.'+task.faellig_am.slice(5,7)+'.' : '';
            var lbls = (task.labels||[]).map(function(lid){return todoState.labels.find(function(l){return l.id===lid;});}).filter(Boolean);

            var h = '<div style="margin-left:'+(depth>0?28:0)+'px">';
            h += '<div class="group flex items-start space-x-2 px-3 py-2 rounded-lg cursor-pointer '+(isSel?'bg-yellow-50':'hover:bg-gray-50')+' '+(task.erledigt?'opacity-40':'')+'" '+(isSel?'style="box-shadow:0 0 0 1px #fed7aa"':'')+' onclick="todoSelect(\''+task.id+'\')">';

            // Checkbox
            h += '<button onclick="event.stopPropagation();todoToggle(\''+task.id+'\')" class="mt-1 flex-shrink-0 w-[18px] h-[18px] rounded-full border-2 flex items-center justify-center '+(task.erledigt?p.bg+' border-transparent':p.border)+'">';
            if(task.erledigt) h += '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><path d="M5 13l4 4L19 7"/></svg>';
            h += '</button>';

            // Expand toggle for subtasks
            if(subs.length>0 && depth===0) {
                h += '<button onclick="event.stopPropagation();todoToggleExpand(\''+task.id+'\')" class="mt-1 text-gray-400 hover:text-gray-600">' +
                    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="transform:rotate('+(todoState.collapsedSecs['sub_'+task.id]?'0':'90')+'deg);transition:transform 150ms"><path d="M9 18l6-6-6-6"/></svg></button>';
            }

            // Content
            h += '<div class="flex-1 min-w-0">';
            // Source badges
            if(isSystem || isHQTask || isEsc) {
                h += '<div class="flex items-center space-x-1 flex-wrap">';
                if(isSystem && TODO_SRC.system) h += '<span class="text-[9px] px-1 rounded font-bold '+TODO_SRC.system.cls+'">'+TODO_SRC.system.icon+' '+TODO_SRC.system.label+'</span>';
                if(isHQTask && TODO_SRC.hq) h += '<span class="text-[9px] px-1 rounded font-bold '+TODO_SRC.hq.cls+'">'+TODO_SRC.hq.icon+' '+TODO_SRC.hq.label+'</span>';
                if(isEsc) h += '<span class="text-[9px] px-1 rounded bg-red-50 text-red-600 border border-red-100 font-bold">ðŸ”¥ Eskaliert</span>';
                h += '</div>';
            }
            // Title
            h += '<p class="text-sm leading-snug '+(task.erledigt?'line-through text-gray-400':'text-gray-800 font-medium')+'">'+escH(task.titel)+'</p>';
            // Meta
            h += '<div class="flex items-center mt-1 flex-wrap" style="gap:6px">';
            h += '<span class="text-gray-400 text-[10px]">'+(TODO_CAT[task.kategorie]||TODO_CAT.sonstig).icon+'</span>';
            if(fmtD && !task.erledigt) h += '<span class="font-semibold text-[10px] '+(isOver?'text-red-500':isToday?'text-yellow-600':'text-gray-400')+'">ðŸ“… '+fmtD+(isOver?' Ã¼berfÃ¤llig':isToday?' heute':'')+'</span>';
            lbls.forEach(function(l){ h += '<span class="font-semibold px-1 rounded-full text-[9px]" style="background:'+l.color+'18;color:'+l.color+'">'+escH(l.name)+'</span>'; });
            if(subs.length>0) h += '<span class="text-gray-400 text-[10px]">â˜‘ '+doneSubs+'/'+subs.length+'</span>';
            if(assigneeName) h += '<span class="text-gray-400 text-[10px]">ðŸ‘¤ '+escH(assigneeName)+'</span>';
            h += '</div></div>';

            // Hover actions
            h += '<div class="flex space-x-1 opacity-0 group-hover:opacity-100">';
            if(depth===0) h += '<button onclick="event.stopPropagation();todoAddSubPrompt(\''+task.id+'\')" class="p-1 text-gray-400 hover:text-yellow-600 rounded" title="Unteraufgabe"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button>';
            h += '<button onclick="event.stopPropagation();todoDelete(\''+task.id+'\')" class="p-1 text-gray-400 hover:text-red-500 rounded" title="LÃ¶schen"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>';
            h += '</div></div>';

            // Subtasks
            if(subs.length>0 && !todoState.collapsedSecs['sub_'+task.id]) {
                subs.forEach(function(st){ h += todoRowHTML(st, depth+1); });
            }

            // Subtask progress bar
            if(subs.length>0 && depth===0 && !todoState.collapsedSecs['sub_'+task.id]) {
                var pct = subs.length ? Math.round(doneSubs/subs.length*100) : 0;
                h += '<div style="margin-left:28px" class="mt-1 mb-2 rounded-full overflow-hidden bg-gray-100 h-1"><div class="h-full bg-green-400 rounded-full" style="width:'+pct+'%;transition:width 150ms"></div></div>';
            }
            h += '</div>';
            return h;
        }

        // â”€â”€ Board View HTML â”€â”€
        function todoBoardHTML() {
            var parents = todoFilteredParents();
            var secs = todoState.sections.slice().sort(function(a,b){return (a.sort_order||0)-(b.sort_order||0);});
            var h = '<div class="mt-2 flex space-x-3 overflow-x-auto pb-4" style="min-height:400px">';

            secs.forEach(function(sec) {
                var tasks = parents.filter(function(t){return t.section_id===sec.id;});
                h += '<div class="flex-shrink-0" style="width:260px" ondragover="event.preventDefault();event.dataTransfer.dropEffect=\'move\'" ondrop="todoBoardDrop(event,\''+sec.id+'\')">';
                h += '<div class="flex items-center space-x-2 px-2 py-1 mb-2"><h3 class="font-bold text-gray-500 uppercase" style="font-size:11px;letter-spacing:0.05em">'+escH(sec.name)+'</h3>';
                h += '<span class="font-bold rounded-full bg-gray-200 text-gray-500 flex items-center justify-center" style="width:18px;height:18px;font-size:9px">'+tasks.length+'</span></div>';
                h += '<div class="space-y-2">';

                tasks.forEach(function(task) {
                    var subs = todoState.todos.filter(function(t){return t.parent_id===task.id;});
                    var doneSubs = subs.filter(function(s){return s.erledigt;}).length;
                    var p = TODO_PRIO[task.prio]||TODO_PRIO.normal;
                    var isOver = !task.erledigt && task.faellig_am && task.faellig_am<TODO_TODAY;
                    var isToday = task.faellig_am===TODO_TODAY;
                    var fmtD = task.faellig_am ? task.faellig_am.slice(8)+'.'+task.faellig_am.slice(5,7)+'.' : '';
                    var lbls = (task.labels||[]).map(function(lid){return todoState.labels.find(function(l){return l.id===lid;});}).filter(Boolean);
                    var assigneeName = task.zugewiesen && task.zugewiesen.name ? task.zugewiesen.name : null;

                    h += '<div draggable="true" ondragstart="event.dataTransfer.setData(\'text/plain\',\''+task.id+'\')" onclick="todoSelect(\''+task.id+'\')" class="bg-white rounded-xl border border-gray-200 p-3 cursor-pointer hover:shadow-md '+(task.erledigt?'opacity-40':'')+'" style="cursor:grab">';
                    // Labels
                    if(lbls.length) {
                        h += '<div class="flex space-x-1 mb-1 flex-wrap">';
                        lbls.forEach(function(l){ h += '<span class="font-bold px-1 rounded-full" style="font-size:8px;background:'+l.color+'18;color:'+l.color+'">'+escH(l.name)+'</span>'; });
                        h += '</div>';
                    }
                    // Checkbox + Title
                    h += '<div class="flex items-start space-x-2">';
                    h += '<button onclick="event.stopPropagation();todoToggle(\''+task.id+'\')" class="mt-1 flex-shrink-0 rounded-full border-2 flex items-center justify-center '+(task.erledigt?p.bg+' border-transparent':p.border)+'" style="width:15px;height:15px">';
                    if(task.erledigt) h += '<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><path d="M5 13l4 4L19 7"/></svg>';
                    h += '</button>';
                    h += '<p class="text-xs leading-snug flex-1 '+(task.erledigt?'line-through text-gray-400':'text-gray-800 font-medium')+'">'+escH(task.titel)+'</p></div>';
                    // Meta
                    h += '<div class="flex items-center mt-1 flex-wrap" style="gap:5px">';
                    if(fmtD) h += '<span class="font-semibold text-[9px] '+(isOver?'text-red-500':isToday?'text-yellow-600':'text-gray-400')+'">ðŸ“… '+fmtD+'</span>';
                    if(subs.length) h += '<span class="text-gray-400 text-[9px]">â˜‘ '+doneSubs+'/'+subs.length+'</span>';
                    if(task.typ!=='manual') h += '<span class="px-1 rounded font-bold text-[8px] '+(task.typ==='system'?'bg-blue-50 text-blue-500':'bg-purple-50 text-purple-500')+'">'+(task.typ==='system'?'ðŸ¤–':'ðŸ¢')+'</span>';
                    h += '<div class="flex-1"></div>';
                    if(assigneeName) {
                        var ini = assigneeName.split(' ').map(function(w){return w[0];}).join('').substring(0,2);
                        h += '<div class="rounded-full bg-gray-200 flex items-center justify-center" style="width:18px;height:18px" title="'+escH(assigneeName)+'"><span class="font-bold text-gray-500" style="font-size:7px">'+ini+'</span></div>';
                    }
                    h += '</div>';
                    // Progress bar
                    if(subs.length) {
                        var pct = Math.round(doneSubs/subs.length*100);
                        h += '<div class="mt-1 rounded-full overflow-hidden bg-gray-100" style="height:4px"><div class="h-full bg-green-400 rounded-full" style="width:'+pct+'%"></div></div>';
                    }
                    h += '</div>';
                });

                if(!tasks.length) h += '<div class="border-2 border-dashed border-gray-200 rounded-xl p-3 text-center"><p class="text-gray-400 text-[11px]">Hierher ziehen</p></div>';
                h += '</div></div>';
            });
            h += '</div>';
            return h;
        }

        // â”€â”€ Board drag & drop â”€â”€
        async function todoBoardDrop(e, secId) {
            e.preventDefault();
            var id = e.dataTransfer.getData('text/plain');
            if(!id) return;
            var t = todoState.todos.find(function(x){return x.id===id;});
            if(!t) return;
            t.section_id = secId;
            todoRender();
            try { await sb.from('todos').update({section_id:secId}).eq('id',id); } catch(err){console.warn(err);}
        }

        // â”€â”€ Detail Panel â”€â”€
        function todoRenderDetail() {
            var panel = document.getElementById('todoDetailPanel');
            if(!panel) return;
            if(!todoState.selectedId) { panel.classList.add('hidden'); return; }
            var task = todoState.todos.find(function(t){return t.id===todoState.selectedId;});
            if(!task) { panel.classList.add('hidden'); todoState.selectedId=null; return; }
            panel.classList.remove('hidden');
            // Lazy-load standort users for assignee dropdown
            if(!todoStandortUsers.length) { todoLoadStandortUsers().then(function(){ todoRenderDetail(); }); return; }

            var subs = todoState.todos.filter(function(t){return t.parent_id===task.id;});
            var doneSubs = subs.filter(function(s){return s.erledigt;}).length;
            var sec = todoState.sections.find(function(s){return s.id===task.section_id;});
            var p = TODO_PRIO[task.prio]||TODO_PRIO.normal;
            var comments = todoState.comments[task.id] || [];
            var lbls = (task.labels||[]).map(function(lid){return todoState.labels.find(function(l){return l.id===lid;});}).filter(Boolean);

            var h = '';
            // Header
            h += '<div class="flex items-center justify-between px-4 py-2 border-b border-gray-100 bg-gray-50">';
            h += '<div class="flex items-center space-x-2 text-xs text-gray-400">';
            if(sec) h += '<span class="font-medium">'+escH(sec.name)+'</span>';
            if(task.typ!=='manual' && TODO_SRC[task.typ]) h += '<span class="px-1 py-0 rounded font-bold text-[9px] '+TODO_SRC[task.typ].cls+'">'+TODO_SRC[task.typ].icon+' '+TODO_SRC[task.typ].label+'</span>';
            h += '</div>';
            h += '<button onclick="todoCloseDetail()" class="p-1 hover:bg-gray-200 rounded-lg text-gray-400 hover:text-gray-600"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>';
            h += '</div>';

            // Scrollable content
            h += '<div class="flex-1 overflow-y-auto"><div class="p-4 space-y-4">';

            // Title with checkbox
            h += '<div class="flex items-start space-x-2">';
            h += '<button onclick="todoToggle(\''+task.id+'\')" class="mt-1 flex-shrink-0 w-5 h-5 rounded-full border-2 flex items-center justify-center '+(task.erledigt?p.bg+' border-transparent':p.border)+'">';
            if(task.erledigt) h += '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><path d="M5 13l4 4L19 7"/></svg>';
            h += '</button>';
            h += '<input value="'+escH(task.titel).replace(/"/g,'&quot;')+'" onblur="todoUpdateField(\''+task.id+'\',\'titel\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur()" class="flex-1 font-semibold outline-none bg-transparent '+(task.erledigt?'line-through text-gray-400':'text-gray-800')+'" style="font-size:15px">';
            h += '</div>';

            // Description
            h += '<textarea onblur="todoUpdateField(\''+task.id+'\',\'beschreibung\',this.value)" placeholder="Beschreibung..." rows="2" class="w-full text-sm text-gray-600 placeholder-gray-400 outline-none bg-gray-50 rounded-lg p-2 border border-gray-100 focus:border-vit-orange/30" style="resize:none">'+(task.beschreibung||'')+'</textarea>';

            // Properties grid
            h += '<div class="grid grid-cols-2 gap-2">';
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">FÃ¤llig</label>';
            h += '<input type="date" value="'+(task.faellig_am||'')+'" onchange="todoUpdateField(\''+task.id+'\',\'faellig_am\',this.value||null)" class="mt-1 w-full px-2 py-1 text-xs border border-gray-200 rounded-lg outline-none focus:border-vit-orange/50"></div>';
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">PrioritÃ¤t</label>';
            h += '<select onchange="todoUpdatePrio(\''+task.id+'\',this.value)" class="mt-1 w-full px-2 py-1 text-xs border border-gray-200 rounded-lg outline-none focus:border-vit-orange/50">';
            Object.keys(TODO_PRIO).forEach(function(k){h+='<option value="'+k+'"'+(task.prio===k?' selected':'')+'>'+TODO_PRIO[k].icon+' '+k[0].toUpperCase()+k.slice(1)+'</option>';});
            h += '</select></div>';
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Kategorie</label>';
            h += '<select onchange="todoUpdateField(\''+task.id+'\',\'kategorie\',this.value)" class="mt-1 w-full px-2 py-1 text-xs border border-gray-200 rounded-lg outline-none focus:border-vit-orange/50">';
            Object.keys(TODO_CAT).forEach(function(k){h+='<option value="'+k+'"'+(task.kategorie===k?' selected':'')+'>'+TODO_CAT[k].icon+' '+TODO_CAT[k].label+'</option>';});
            h += '</select></div>';
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Sektion</label>';
            h += '<select onchange="todoUpdateField(\''+task.id+'\',\'section_id\',this.value)" class="mt-1 w-full px-2 py-1 text-xs border border-gray-200 rounded-lg outline-none focus:border-vit-orange/50">';
            h += '<option value="">â€”</option>';
            todoState.sections.forEach(function(s){h+='<option value="'+s.id+'"'+(task.section_id===s.id?' selected':'')+'>'+escH(s.name)+'</option>';});
            h += '</select></div>';
            h += '</div>';

            // Zugewiesen an
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Zugewiesen an</label>';
            h += '<select onchange="todoUpdateField(\''+task.id+'\',\'zugewiesen_an\',this.value||null)" class="mt-1 w-full px-2 py-1 text-xs border border-gray-200 rounded-lg outline-none focus:border-vit-orange/50">';
            h += '<option value="">â€” Nicht zugewiesen â€”</option>';
            todoStandortUsers.forEach(function(u){
                h += '<option value="'+u.id+'"'+(task.zugewiesen_an===u.id?' selected':'')+'>ðŸ‘¤ '+escH(u.name)+'</option>';
            });
            h += '</select></div>';

            // Labels
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Labels</label>';
            h += '<div class="flex flex-wrap gap-1 mt-1">';
            todoState.labels.forEach(function(l) {
                var active = (task.labels||[]).indexOf(l.id) >= 0;
                h += '<button onclick="todoToggleLabel(\''+task.id+'\',\''+l.id+'\')" class="font-semibold px-2 py-1 rounded-full border text-[10px] '+(active?'':'opacity-50 hover:opacity-80')+'" style="background:'+l.color+'15;color:'+l.color+';border-color:'+(active?l.color:'transparent')+';'+(active?'box-shadow:0 0 0 1px '+l.color+'40':'')+'">'+escH(l.name)+'</button>';
            });
            h += '</div></div>';

            // Subtasks
            h += '<div><div class="flex items-center justify-between mb-2"><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Unteraufgaben</label>';
            if(subs.length) h += '<span class="text-gray-400 text-[10px]">'+doneSubs+'/'+subs.length+'</span>';
            h += '</div>';
            if(subs.length) {
                var pct = Math.round(doneSubs/subs.length*100);
                h += '<div class="rounded-full overflow-hidden bg-gray-100 mb-2" style="height:5px"><div class="h-full bg-green-400 rounded-full" style="width:'+pct+'%"></div></div>';
            }
            subs.forEach(function(s) {
                var sp = TODO_PRIO[s.prio]||TODO_PRIO.normal;
                h += '<div class="flex items-center space-x-2 py-1 group">';
                h += '<button onclick="todoToggle(\''+s.id+'\')" class="flex-shrink-0 rounded-full border-2 flex items-center justify-center '+(s.erledigt?sp.bg+' border-transparent':sp.border)+'" style="width:15px;height:15px">';
                if(s.erledigt) h += '<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><path d="M5 13l4 4L19 7"/></svg>';
                h += '</button>';
                h += '<span class="flex-1 text-xs '+(s.erledigt?'line-through text-gray-400':'text-gray-700')+'">'+escH(s.titel)+'</span>';
                h += '<button onclick="todoDelete(\''+s.id+'\')" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 text-[10px]">âœ•</button>';
                h += '</div>';
            });
            h += '<div class="flex items-center space-x-2 mt-1">';
            h += '<div class="rounded-full border-2 border-dashed border-gray-300 flex-shrink-0" style="width:15px;height:15px"></div>';
            h += '<input id="todoDetailSubInput" placeholder="Unteraufgabe..." class="flex-1 px-1 py-1 border-b border-gray-100 outline-none focus:border-vit-orange/30 bg-transparent text-xs" onkeydown="if(event.key===\'Enter\')todoAddSubFromDetail(\''+task.id+'\')">';
            h += '</div></div>';

            // Comments
            h += '<div><label class="font-bold text-gray-400 uppercase text-[9px]" style="letter-spacing:0.05em">Kommentare</label>';
            h += '<div class="mt-2 space-y-2" id="todoDetailComments">';
            comments.forEach(function(c) {
                var cName = c.users ? c.users.name : 'Du';
                var cInit = cName.split(' ').map(function(w){return w[0];}).join('').substring(0,2);
                var cd = new Date(c.created_at);
                var cDate = String(cd.getDate()).padStart(2,'0')+'.'+String(cd.getMonth()+1).padStart(2,'0')+'.';
                h += '<div class="bg-gray-50 rounded-lg p-2">';
                h += '<div class="flex items-center space-x-1 mb-1"><div class="rounded-full bg-yellow-100 flex items-center justify-center" style="width:16px;height:16px"><span class="font-bold text-yellow-600 text-[7px]">'+cInit+'</span></div>';
                h += '<span class="font-semibold text-gray-600 text-[10px]">'+escH(cName)+'</span>';
                h += '<span class="text-gray-400 text-[9px]">'+cDate+'</span></div>';
                h += '<p class="text-gray-600 text-xs">'+escH(c.inhalt)+'</p></div>';
            });
            h += '</div>';
            h += '<div class="flex space-x-2 mt-2"><input id="todoCommentInput" placeholder="Kommentar..." class="flex-1 px-2 py-1 border border-gray-200 rounded-lg outline-none focus:border-vit-orange/30 text-xs" onkeydown="if(event.key===\'Enter\')todoAddComment(\''+task.id+'\')">';
            h += '</div></div>';

            h += '</div></div>';

            // Footer
            h += '<div class="px-4 py-2 border-t border-gray-100 bg-gray-50 flex items-center justify-between">';
            var cDate = task.created_at ? new Date(task.created_at) : null;
            var cStr = cDate ? String(cDate.getDate()).padStart(2,'0')+'.'+String(cDate.getMonth()+1).padStart(2,'0')+'.' : '';
            h += '<span class="text-gray-400 text-[9px]">Erstellt: '+cStr+'</span>';
            h += '<button onclick="todoDelete(\''+task.id+'\');todoCloseDetail()" class="text-red-400 hover:text-red-600 font-semibold text-[10px]">LÃ¶schen</button>';
            h += '</div>';

            panel.innerHTML = h;
            // Load comments async
            todoLoadComments(task.id);
        }

        // â”€â”€ Actions â”€â”€
        function todoSelect(id) {
            todoState.selectedId = (todoState.selectedId===id) ? null : id;
            todoRender();
        }
        function todoCloseDetail() { todoState.selectedId=null; todoRender(); }
        function todoToggleSec(id) { todoState.collapsedSecs[id]=!todoState.collapsedSecs[id]; todoRender(); }
        function todoToggleExpand(id) { todoState.collapsedSecs['sub_'+id]=!todoState.collapsedSecs['sub_'+id]; todoRender(); }

        async function todoToggle(id) {
            var t = todoState.todos.find(function(x){return x.id===id;});
            if(!t) return;
            var nowDone = !t.erledigt;
            t.erledigt = nowDone;
            t.erledigt_am = nowDone ? new Date().toISOString() : null;
            // If completing parent â†’ complete all subtasks
            if(nowDone && !t.parent_id) {
                todoState.todos.forEach(function(s){
                    if(s.parent_id===id && !s.erledigt) { s.erledigt=true; s.erledigt_am=new Date().toISOString(); sb.from('todos').update({erledigt:true,erledigt_am:s.erledigt_am}).eq('id',s.id); }
                });
            }
            todoRender();
            try { await sb.from('todos').update({erledigt:nowDone,erledigt_am:t.erledigt_am}).eq('id',id); } catch(e){console.warn(e);}
        }

        async function todoDelete(id) {
            // Delete subtasks too
            todoState.todos = todoState.todos.filter(function(t){return t.id!==id && t.parent_id!==id;});
            todoRender();
            try { await sb.from('todos').delete().eq('id',id); } catch(e){console.warn(e);}
        }

        async function todoUpdateField(id, field, value) {
            var t = todoState.todos.find(function(x){return x.id===id;});
            if(!t) return;
            t[field] = value;
            todoRender();
            var upd = {};
            upd[field] = value;
            try { await sb.from('todos').update(upd).eq('id',id); } catch(e){console.warn(e);}
        }

        async function todoUpdatePrio(id, prio) {
            var t = todoState.todos.find(function(x){return x.id===id;});
            if(!t) return;
            t.prio = prio;
            t.prio_sort = (TODO_PRIO[prio]||{}).sort || 1;
            todoRender();
            try { await sb.from('todos').update({prio:prio,prio_sort:t.prio_sort}).eq('id',id); } catch(e){console.warn(e);}
        }

        async function todoToggleLabel(taskId, labelId) {
            var t = todoState.todos.find(function(x){return x.id===taskId;});
            if(!t) return;
            var arr = t.labels || [];
            var idx = arr.indexOf(labelId);
            if(idx>=0) arr.splice(idx,1); else arr.push(labelId);
            t.labels = arr;
            todoRender();
            try { await sb.from('todos').update({labels:arr}).eq('id',taskId); } catch(e){console.warn(e);}
        }

        // â”€â”€ Subtask from detail â”€â”€
        async function todoAddSubFromDetail(parentId) {
            var inp = document.getElementById('todoDetailSubInput');
            var title = inp ? inp.value.trim() : '';
            if(!title) return;
            var parent = todoState.todos.find(function(t){return t.id===parentId;});
            try {
                var resp = await sb.from('todos').insert({
                    standort_id:sbProfile?sbProfile.standort_id:null, erstellt_von:sbUser?sbUser.id:null,
                    titel:title, parent_id:parentId, section_id:(parent&&parent.section_id)||null,
                    kategorie:parent?parent.kategorie:'sonstig', prio:'normal', prio_sort:1, erledigt:false
                }).select('*');
                if(resp.error) throw resp.error;
                if(resp.data&&resp.data[0]) todoState.todos.push(resp.data[0]);
            } catch(e){console.error(e);}
            todoRender();
        }

        function todoAddSubPrompt(parentId) {
            var title = prompt('Unteraufgabe:');
            if(!title || !title.trim()) return;
            var parent = todoState.todos.find(function(t){return t.id===parentId;});
            sb.from('todos').insert({
                standort_id:sbProfile?sbProfile.standort_id:null, erstellt_von:sbUser?sbUser.id:null,
                titel:title.trim(), parent_id:parentId, section_id:(parent&&parent.section_id)||null,
                kategorie:parent?parent.kategorie:'sonstig', prio:'normal', prio_sort:1, erledigt:false
            }).select('*').then(function(r){
                if(r.data&&r.data[0]) todoState.todos.push(r.data[0]);
                todoRender();
            });
        }

        // â”€â”€ Sections â”€â”€
        async function todoAddSecPrompt() {
            var name = prompt('Name der neuen Sektion:');
            if(!name || !name.trim()) return;
            try {
                var resp = await sb.from('todo_sections').insert({name:name.trim(),standort_id:sbProfile?sbProfile.standort_id:null,sort_order:todoState.sections.length}).select();
                if(resp.error) throw resp.error;
                if(resp.data&&resp.data[0]) todoState.sections.push(resp.data[0]);
            } catch(e){alert('Fehler: '+e.message);}
            todoRender();
        }

        async function todoDeleteSec(id) {
            if(!confirm('Sektion lÃ¶schen? Aufgaben werden zu "Eingang" verschoben.')) return;
            var inbox = todoState.sections.find(function(s){return s.name==='Eingang';});
            var inboxId = inbox ? inbox.id : null;
            // Move tasks
            todoState.todos.forEach(function(t){if(t.section_id===id)t.section_id=inboxId;});
            todoState.sections = todoState.sections.filter(function(s){return s.id!==id;});
            todoRender();
            try {
                if(inboxId) await sb.from('todos').update({section_id:inboxId}).eq('section_id',id);
                await sb.from('todo_sections').delete().eq('id',id);
            } catch(e){console.warn(e);}
        }

        // â”€â”€ Comments â”€â”€
        async function todoLoadComments(taskId) {
            try {
                var r = await sb.from('todo_comments').select('*, users(name)').eq('todo_id',taskId).order('created_at',{ascending:true});
                todoState.comments[taskId] = (!r.error && r.data) ? r.data : [];
                // Re-render comments section only
                var el = document.getElementById('todoDetailComments');
                if(el && todoState.selectedId===taskId) {
                    var comments = todoState.comments[taskId] || [];
                    var ch = '';
                    comments.forEach(function(c) {
                        var cName = c.users ? c.users.name : 'Du';
                        var cInit = cName.split(' ').map(function(w){return w[0];}).join('').substring(0,2);
                        var cd = new Date(c.created_at);
                        var cDate = String(cd.getDate()).padStart(2,'0')+'.'+String(cd.getMonth()+1).padStart(2,'0')+'.';
                        ch += '<div class="bg-gray-50 rounded-lg p-2"><div class="flex items-center space-x-1 mb-1"><div class="rounded-full bg-yellow-100 flex items-center justify-center" style="width:16px;height:16px"><span class="font-bold text-yellow-600 text-[7px]">'+cInit+'</span></div>';
                        ch += '<span class="font-semibold text-gray-600 text-[10px]">'+escH(cName)+'</span><span class="text-gray-400 text-[9px]">'+cDate+'</span></div>';
                        ch += '<p class="text-gray-600 text-xs">'+escH(c.inhalt)+'</p></div>';
                    });
                    if(!comments.length) ch = '<p class="text-xs text-gray-400 italic">Noch keine Kommentare.</p>';
                    el.innerHTML = ch;
                }
            } catch(e){console.warn(e);}
        }

        async function todoAddComment(taskId) {
            var inp = document.getElementById('todoCommentInput');
            var text = inp ? inp.value.trim() : '';
            if(!text) return;
            try {
                var r = await sb.from('todo_comments').insert({todo_id:taskId,user_id:sbUser?sbUser.id:null,inhalt:text}).select('*, users(name)');
                if(r.error) throw r.error;
                if(!todoState.comments[taskId]) todoState.comments[taskId] = [];
                if(r.data&&r.data[0]) todoState.comments[taskId].push(r.data[0]);
                inp.value = '';
                todoLoadComments(taskId);
            } catch(e){alert('Fehler: '+e.message);}
        }

        // â”€â”€ Backwards compat: old functions redirect to new â”€â”€
        function filterTodos(f) { todoSetFilter(f); }
        function renderTodos() { todoRender(); }
        var currentTodoFilter = 'all';

        // =====================================================================
        // BWA ERINNERUNGSLOGIK â€“ Automatische Deadline-Todos mit Eskalation
        // =====================================================================
        // Deadline: BWA fÃ¼r Monat X muss bis zum 15. des Folgemonats (X+1) eingereicht sein.
        // Eskalationsstufen:
        //   Stufe 0: Ab dem 1. des Folgemonats â†’ Todo â€žBWA einreichen" (prio: normal)
        //   Stufe 1: Ab dem 8. des Folgemonats â†’ Prio hochsetzen auf â€žhoch", Hinweistext
        //   Stufe 2: Ab dem 13. des Folgemonats â†’ Prio â€ždringend", Banner-Warnung
        //   Stufe 3: Nach dem 15. â†’ ÃœBERFÃ„LLIG, E-Mail-Eskalation an HQ (Platzhalter)
        // Jede Stufe: erinnerung_email_faellig = true â†’ wird von externem Cronjob/Edge Function abgeholt

        async function checkBwaDeadlines() {
            // Nur fÃ¼r Inhaber/Buchhaltung relevant, nicht fÃ¼r HQ
            var isInhaber = currentRoles.indexOf('inhaber') >= 0 || currentRoles.indexOf('buchhaltung') >= 0;
            var isHQ = sbProfile && sbProfile.is_hq;
            if(!isInhaber || isHQ) return;
            if(!sbProfile || !sbProfile.standort_id) return;

            var today = new Date();
            var todayStr = today.toISOString().slice(0,10);

            // Welche BWA-Monate fehlen? PrÃ¼fe die letzten 3 Monate (nur ab Jan 2026)
            var missingMonths = [];
            for(var offset = 1; offset <= 3; offset++) {
                var checkDate = new Date(today.getFullYear(), today.getMonth() - offset, 1);
                var bwaMonat = checkDate.getMonth() + 1; // 1-12
                var bwaJahr = checkDate.getFullYear();
                // Nur BWAs ab Januar 2026 erforderlich
                if(bwaJahr < 2026) continue;
                // Deadline = 15. des Folgemonats
                var deadlineDate = new Date(bwaJahr, bwaMonat, 15); // bwaMonat ist 0-indexed+1 = nÃ¤chster Monat
                // Nur relevant wenn wir nach dem 1. des Folgemonats sind
                var reminderStart = new Date(bwaJahr, bwaMonat, 1);
                if(today >= reminderStart) {
                    missingMonths.push({
                        monat: bwaMonat === 0 ? 12 : bwaMonat,
                        jahr: bwaMonat === 0 ? bwaJahr - 1 : bwaJahr,
                        bwaMonat: checkDate.getMonth() + 1,
                        bwaJahr: checkDate.getFullYear(),
                        deadline: deadlineDate,
                        deadlineStr: deadlineDate.toISOString().slice(0,10)
                    });
                }
            }
            if(missingMonths.length === 0) return;

            // PrÃ¼fe welche BWAs bereits eingereicht sind
            try {
                var bwaResp = await sb.from('bwa_daten').select('monat,jahr').eq('standort_id', sbProfile.standort_id);
                if(bwaResp.error) throw bwaResp.error;
                var submitted = (bwaResp.data || []);
                var submittedKeys = submitted.map(function(b) { return b.jahr + '-' + b.monat; });

                // PrÃ¼fe welche Reminder-Todos bereits existieren
                var todoResp = await sb.from('todos').select('id,titel,prio,eskalation_stufe,referenz_typ,referenz_id')
                    .eq('standort_id', sbProfile.standort_id)
                    .eq('referenz_typ', 'bwa_erinnerung')
                    .eq('erledigt', false);
                var existingTodos = (todoResp.data || []);
                var existingKeys = existingTodos.map(function(t) { return t.referenz_id; });

                var monatNamen = ['', 'Januar','Februar','Maerz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
                var bwaRemindersCreated = 0;
                var bwaEscalations = [];

                for(var i = 0; i < missingMonths.length; i++) {
                    var mm = missingMonths[i];
                    var key = mm.bwaJahr + '-' + mm.bwaMonat;

                    // Schon eingereicht? â†’ Skip
                    if(submittedKeys.indexOf(key) >= 0) {
                        // Falls ein Todo dafÃ¼r existiert, als erledigt markieren
                        var doneTodo = existingTodos.find(function(t){ return t.referenz_id === key; });
                        if(doneTodo) {
                            await sb.from('todos').update({erledigt:true, erledigt_am:new Date().toISOString()}).eq('id', doneTodo.id);
                        }
                        continue;
                    }

                    // Eskalationsstufe berechnen
                    var dayOfMonth = today.getDate();
                    var monthDiff = (today.getFullYear() - mm.bwaJahr) * 12 + (today.getMonth() + 1 - mm.bwaMonat);
                    var eskalation = 0;
                    if(monthDiff >= 1) { // Wir sind im Folgemonat oder spÃ¤ter
                        if(dayOfMonth >= 16 || monthDiff > 1) eskalation = 3; // ÃœBERFÃ„LLIG
                        else if(dayOfMonth >= 13) eskalation = 2; // Dringend
                        else if(dayOfMonth >= 8) eskalation = 1; // Hoch
                        else eskalation = 0; // Normal
                    }

                    var prioMap = ['normal','hoch','hoch','dringend'];
                    var prioSortMap = [1,0,0,0];
                    var prio = prioMap[eskalation] || 'normal';
                    var prioSort = prioSortMap[eskalation] || 1;
                    var monatLabel = monatNamen[mm.bwaMonat] || ('Monat ' + mm.bwaMonat);
                    var titel = t('bwa_reminder_title').replace('{monat}', monatLabel).replace('{jahr}', mm.bwaJahr);
                    var beschreibung = t('bwa_reminder_desc')
                        .replace('{monat}', monatLabel).replace('{jahr}', mm.bwaJahr)
                        .replace('{deadline}', mm.deadline.toLocaleDateString('de-DE'));
                    if(eskalation >= 2) beschreibung += '\n\n' + t('bwa_reminder_urgent');
                    if(eskalation >= 3) beschreibung += '\n' + t('bwa_reminder_overdue');

                    // Todo existiert schon? â†’ Update Eskalation
                    var existingTodo = existingTodos.find(function(t){ return t.referenz_id === key; });
                    if(existingTodo) {
                        if((existingTodo.eskalation_stufe || 0) < eskalation) {
                            await sb.from('todos').update({
                                prio: prio, prio_sort: prioSort,
                                eskalation_stufe: eskalation,
                                titel: titel, beschreibung: beschreibung,
                                erinnerung_email_faellig: eskalation >= 2
                            }).eq('id', existingTodo.id);
                            if(eskalation >= 2) bwaEscalations.push(mm);
                        }
                    } else {
                        // Neues Todo anlegen
                        await sb.from('todos').insert({
                            standort_id: sbProfile.standort_id,
                            erstellt_von: null, // System-generiert
                            titel: titel,
                            beschreibung: beschreibung,
                            faellig_am: mm.deadlineStr,
                            prio: prio, prio_sort: prioSort,
                            kategorie: 'admin',
                            typ: 'system',
                            referenz_typ: 'bwa_erinnerung',
                            referenz_id: key,
                            eskalation_stufe: eskalation,
                            erinnerung_email_faellig: eskalation >= 1
                        });
                        bwaRemindersCreated++;
                    }
                }

                // Banner anzeigen wenn Ã¼berfÃ¤llige BWAs vorhanden
                if(bwaEscalations.length > 0 || missingMonths.some(function(m){ return submittedKeys.indexOf(m.bwaJahr+'-'+m.bwaMonat) < 0; })) {
                    showBwaReminderBanner(missingMonths.filter(function(m){
                        return submittedKeys.indexOf(m.bwaJahr+'-'+m.bwaMonat) < 0;
                    }));
                }

            } catch(err) {
                console.warn('BWA deadline check:', err);
            }
        }

        function showBwaReminderBanner(missingBwas) {
            if(!missingBwas || missingBwas.length === 0) return;
            var existing = document.getElementById('bwaReminderBanner');
            if(existing) existing.remove();

            var today = new Date();
            var monatNamen = ['','Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
            var worst = 0;
            var labels = missingBwas.map(function(m) {
                var dayOfMonth = today.getDate();
                var monthDiff = (today.getFullYear() - m.bwaJahr) * 12 + (today.getMonth() + 1 - m.bwaMonat);
                var esk = 0;
                if(monthDiff >= 1) {
                    if(dayOfMonth >= 16 || monthDiff > 1) esk = 3;
                    else if(dayOfMonth >= 13) esk = 2;
                    else if(dayOfMonth >= 8) esk = 1;
                }
                if(esk > worst) worst = esk;
                return monatNamen[m.bwaMonat] + ' ' + m.bwaJahr;
            });

            var colors = ['bg-blue-50 border-blue-300 text-blue-800','bg-yellow-50 border-yellow-300 text-yellow-800','bg-orange-50 border-orange-400 text-orange-800','bg-red-50 border-red-400 text-red-800'];
            var icons = ['\u2139\uFE0F','\u26A0\uFE0F','\uD83D\uDD25','\uD83D\uDEA8'];
            var msgKeys = ['bwa_banner_info','bwa_banner_warn','bwa_banner_urgent','bwa_banner_overdue'];

            var banner = document.createElement('div');
            banner.id = 'bwaReminderBanner';
            banner.innerHTML = '<div style="position:fixed;top:64px;left:50%;transform:translateX(-50%);z-index:8999;max-width:640px;width:95%;" class="'+colors[worst]+' border rounded-xl shadow-lg px-5 py-3 flex items-center justify-between">'
                + '<div class="flex items-center space-x-3">'
                + '<span class="text-2xl">'+icons[worst]+'</span>'
                + '<div><p class="text-sm font-semibold">'+t(msgKeys[worst])+'</p>'
                + '<p class="text-xs opacity-75">' + t('bwa_banner_missing') + ': ' + labels.join(', ') + '</p></div></div>'
                + '<div class="flex items-center space-x-2">'
                + '<button onclick="showView(\'controlling\');document.getElementById(\'bwaReminderBanner\').remove();" class="px-3 py-1.5 bg-vit-orange text-white text-xs font-semibold rounded-lg hover:opacity-90">' + t('bwa_banner_btn') + '</button>'
                + '<button onclick="document.getElementById(\'bwaReminderBanner\').remove();" class="text-gray-400 hover:text-gray-600">\u2715</button>'
                + '</div></div>';
            document.body.appendChild(banner);
        }

        // HQ: Ãœbersicht fehlender BWAs aller Standorte
        async function loadHqBwaStatus() {
            if(!sbProfile || !sbProfile.is_hq) return;
            try {
                var today = new Date();
                var prevMonth = today.getMonth(); // 0-11, 0=Jan â†’ prev=Dec
                var prevYear = prevMonth === 0 ? today.getFullYear() - 1 : today.getFullYear();
                if(prevMonth === 0) prevMonth = 12; // Korrektur

                // Alle Standorte laden
                var stdResp = await sb.from('standorte').select('id,name');
                if(stdResp.error) return;
                var standorte = stdResp.data || [];

                // Alle BWAs fÃ¼r den Vormonat
                var bwaResp = await sb.from('bwa_daten').select('standort_id').eq('monat', prevMonth).eq('jahr', prevYear);
                var submittedIds = (bwaResp.data||[]).map(function(b){return b.standort_id;});

                var missing = standorte.filter(function(s){ return submittedIds.indexOf(s.id) < 0; });

                // Todos mit Ã¼berfÃ¤lligen BWA-Erinnerungen
                var eskResp = await sb.from('todos').select('standort_id,eskalation_stufe,erinnerung_email_faellig')
                    .eq('referenz_typ','bwa_erinnerung').eq('erledigt',false).gte('eskalation_stufe',2);
                var escalated = eskResp.data || [];

                return { missing: missing, escalated: escalated, total: standorte.length, month: prevMonth, year: prevYear };
            } catch(e) { console.warn('HQ BWA status:', e); return null; }
        }


        // === HQ KOMMUNIKATION ===
        var hqAnnouncements = [
            {id:1,title:'Fruehjahrs-Aktion 2026 â€“ Materialien verfuegbar',date:'2026-02-12',author:'Lisa Zentrale',priority:'hoch',target:'alle',body:'Liebe Partner, die Materialien fuer die Fruehjahrs-Aktion stehen ab sofort im Content-Bereich bereit. Bitte bis 01.03. im Laden platzieren.',read:18,total:21},
            {id:2,title:'Neue Einkaufsrichtlinie Q1/2026',date:'2026-02-10',author:'Thomas HQ',priority:'hoch',target:'alle',body:'Aktualisierte Margen-Empfehlung und Vororder-Deadlines fuer Q1 2026.',read:15,total:21},
            {id:3,title:'Schulung: Bosch Smart System â€“ 25.02.',date:'2026-02-08',author:'Lisa Zentrale',priority:'mittel',target:'alle',body:'Online-Schulung via Teams. Link wird per Mail versendet. Teilnahme empfohlen fuer alle Werkstatt-MA.',read:12,total:21},
            {id:4,title:'Osteraktion: Fruehbucher-Rabatt auf E-MTBs',date:'2026-02-05',author:'Marketing HQ',priority:'mittel',target:'alle',body:'10% Fruehbucher-Rabatt auf alle Orbea Rise und Wild. Gilt 01.03.â€“15.04.',read:21,total:21},
            {id:5,title:'Region Sued: Lagerbestand-Inventur bis 01.03.',date:'2026-02-03',author:'Thomas HQ',priority:'niedrig',target:'Region SÃ¼d',body:'Bitte Inventur durchfuehren und Ergebnisse in den Aktenschrank hochladen.',read:6,total:8}
        ];
        var hqForumTopics = [
            {id:1,title:'Best Practices: E-Bike Probefahrten organisieren',author:'Max Mustermann, Grafrath',date:'2026-02-13',replies:8,pinned:true},
            {id:2,title:'Erfahrungen mit Shimano EP6 Antrieb?',author:'Peter Hansen, Hamburg',date:'2026-02-12',replies:5,pinned:false},
            {id:3,title:'Werkstatt-Auslastung im Fruehjahr managen',author:'Jan Schulze, Berlin',date:'2026-02-11',replies:12,pinned:false},
            {id:4,title:'Jobrad-Leasing: Tipps fuer B2B-Kunden',author:'Miriam Deichmann, Hamburg',date:'2026-02-09',replies:3,pinned:true},
            {id:5,title:'Social Media: Welche Themen laufen bei euch?',author:'Laura Schmidt, Grafrath',date:'2026-02-07',replies:15,pinned:false}
        ];
        var currentHqKommTab='announce';
        function showHqKommTab(tab){
            currentHqKommTab=tab;
            document.querySelectorAll('.hqkomm-tab-btn').forEach(function(b){b.className='hqkomm-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700';});
            var btn=document.querySelector('.hqkomm-tab-btn[data-hkt="'+tab+'"]');
            if(btn)btn.className='hqkomm-tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            renderHqKomm();
        }
        function openAnkuendigungModal() {
            var html = '<div id="ankOverlay" onclick="closeAnkModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">\uD83D\uDCE2 Neue Ankuendigung</h3><button onclick="closeAnkModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Titel *</label><input id="ankTitel" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="z.B. Neue Preisliste ab Maerz"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Kategorie</label><select id="ankKat" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="news">News</option><option value="event">Event</option><option value="schulung">Schulung</option><option value="marketing">Marketing</option><option value="sortiment">Sortiment</option><option value="preise">Preise</option><option value="it">IT</option></select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Inhalt *</label><textarea id="ankInhalt" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" rows="5" placeholder="Ankuendigungstext..."></textarea></div>';
            html += '<label class="flex items-center space-x-2"><input id="ankWichtig" type="checkbox" class="rounded"><span class="text-sm text-gray-600">Als wichtig markieren</span></label>';
            html += '</div>';
            html += '<div id="ankError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-3"></div>';
            html += '<button onclick="saveAnkuendigung()" id="ankSaveBtn" class="w-full py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Veroeffentlichen</button>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'ankContainer'; c.innerHTML = html; document.body.appendChild(c);
        }
        function closeAnkModal() { var c = document.getElementById('ankContainer'); if(c) c.remove(); }
        async function saveAnkuendigung() {
            var titel = (document.getElementById('ankTitel')||{}).value;
            var inhalt = (document.getElementById('ankInhalt')||{}).value;
            var kategorie = (document.getElementById('ankKat')||{}).value || 'news';
            var wichtig = (document.getElementById('ankWichtig')||{}).checked || false;
            var errEl = document.getElementById('ankError');
            if(!titel||!titel.trim()||!inhalt||!inhalt.trim()) { if(errEl){errEl.textContent='Bitte Titel und Inhalt ausfuellen.';errEl.style.display='block';} return; }
            var btn = document.getElementById('ankSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }
            try {
                var resp = await sb.from('ankuendigungen').insert({
                    titel: titel.trim(), inhalt: inhalt.trim(), kategorie: kategorie,
                    wichtig: wichtig, erstellt_von: sbUser ? sbUser.id : null
                });
                if(resp.error) throw resp.error;
                closeAnkModal();
                alert('\u2705 Ankuendigung veroeffentlicht!');
                renderAnnouncements();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+err.message;errEl.style.display='block';}
                if(btn){btn.disabled=false;btn.textContent='Veroeffentlichen';}
            }
        }

        function renderHqKomm(){
            var el=document.getElementById('hqKommContent');if(!el)return;
            var h='';
            if(currentHqKommTab==='announce'){
                h+='<div class="flex justify-end mb-4"><button onclick="alert(\'Neue Ankuendigung erstellen (Demo)\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Ankuendigung</button></div>';
                hqAnnouncements.forEach(function(a){
                    var prioBg=a.priority==='hoch'?'border-l-4 border-red-500':a.priority==='mittel'?'border-l-4 border-yellow-400':'border-l-4 border-gray-300';
                    var readPct=Math.round(a.read/a.total*100);
                    h+='<div class="vit-card p-4 mb-3 '+prioBg+'">';
                    h+='<div class="flex items-start justify-between"><div class="flex-1">';
                    h+='<div class="flex items-center space-x-2"><p class="font-bold text-gray-800">'+a.title+'</p>';
                    if(a.priority==='hoch') h+='<span class="text-[10px] px-2 py-0.5 rounded-full bg-red-100 text-red-600 font-bold">WICHTIG</span>';
                    h+='</div>';
                    h+='<p class="text-xs text-gray-500 mt-1">'+a.author+' Â· '+a.date+' Â· Ziel: '+a.target+'</p>';
                    h+='<p class="text-sm text-gray-600 mt-2">'+a.body+'</p>';
                    h+='</div>';
                    h+='<div class="text-right flex-shrink-0 ml-4"><p class="text-xs text-gray-400">Gelesen</p>';
                    h+='<p class="text-lg font-bold '+(readPct>=90?'text-green-600':readPct>=50?'text-yellow-600':'text-red-500')+'">'+a.read+'/'+a.total+'</p>';
                    h+='<div class="w-16 bg-gray-100 rounded-full h-1.5 mt-1"><div class="h-1.5 rounded-full '+(readPct>=90?'bg-green-500':'bg-yellow-500')+'" style="width:'+readPct+'%"></div></div>';
                    h+='</div></div></div>';
                });
            } else if(currentHqKommTab==='rundmail'){
                h+='<div class="vit-card p-6"><h3 class="font-bold text-gray-800 mb-4">âœ‰ï¸ Rundmail an Standorte senden</h3>';
                h+='<div class="space-y-3">';
                h+='<select class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option>Alle Standorte (21)</option><option>Region Sued (8)</option><option>Region Nord (5)</option><option>Region West (5)</option><option>Region Ost (3)</option><option>Nur Inhaber</option></select>';
                h+='<input type="text" placeholder="Betreff" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
                h+='<textarea rows="6" placeholder="Nachricht an das Netzwerk..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>';
                h+='<div class="flex items-center space-x-3"><label class="flex items-center text-sm text-gray-600"><input type="checkbox" class="mr-2"> Als Ankuendigung im Portal anzeigen</label></div>';
                h+='<button onclick="this.textContent=\'âœ… Gesendet!\';this.disabled=true;setTimeout(function(){this.textContent=\'ðŸ“¨ Senden\';this.disabled=false;}.bind(this),2000)" class="px-6 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ“¨ Senden</button>';
                h+='</div></div>';
                h+='<h3 class="font-bold text-gray-800 mt-6 mb-3">Letzte Rundmails</h3>';
                var mails=[{subj:'Fruehjahrs-Aktion Materialien',date:'12.02.2026',to:'Alle',opened:'18/21'},{subj:'Einkaufsrichtlinie Q1',date:'10.02.2026',to:'Alle',opened:'15/21'},{subj:'Inventur-Erinnerung',date:'03.02.2026',to:'Region Sued',opened:'6/8'}];
                mails.forEach(function(m){
                    h+='<div class="vit-card p-3 flex items-center justify-between mb-2"><div><p class="text-sm font-semibold text-gray-800">'+m.subj+'</p><p class="text-xs text-gray-500">'+m.date+' Â· An: '+m.to+'</p></div><span class="text-xs font-semibold text-gray-500">Geoeffnet: '+m.opened+'</span></div>';
                });
            } else if(currentHqKommTab==='forum'){
                h+='<p class="text-sm text-gray-500 mb-4">Netzwerk-Forum: Moderieren und Pinnen von Beitraegen aller Standorte.</p>';
                hqForumTopics.forEach(function(f){
                    h+='<div class="vit-card p-4 flex items-center space-x-3 mb-2">';
                    if(f.pinned) h+='<span class="text-vit-orange text-sm">ðŸ“Œ</span>'; else h+='<span class="text-gray-300 text-sm">ðŸ’¬</span>';
                    h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+f.title+'</p><p class="text-xs text-gray-500">'+f.author+' Â· '+f.date+'</p></div>';
                    h+='<div class="text-right flex-shrink-0"><span class="text-xs font-bold text-gray-600">'+f.replies+' Antworten</span></div>';
                    h+='<button onclick="alert(\'Beitrag '+(f.pinned?'loesen':'pinnen')+' (Demo)\')" class="text-xs px-2 py-1 rounded border border-gray-200 text-gray-500 hover:bg-gray-50">'+(f.pinned?'Loesen':'Pinnen')+'</button>';
                    h+='</div>';
                });
            }
            el.innerHTML=h;
        }

        // === HQ KAMPAGNEN ===
        var hqKampagnen = [
            {id:1,name:'Fruehjahrs-Aktion 2026',type:'saisonal',start:'2026-03-01',end:'2026-04-15',status:'aktiv',standorte:21,umgesetzt:14,budget:25000,desc:'Fokus auf E-Bikes und Zubehoer. POS-Material + Online-Banner.'},
            {id:2,name:'Orbea Rise Launch Event',type:'produkt',start:'2026-02-20',end:'2026-03-10',status:'aktiv',standorte:21,umgesetzt:8,budget:15000,desc:'Produktlaunch neues Orbea Rise 2026. Probefahrt-Events an allen Standorten.'},
            {id:3,name:'Jobrad-Fruehjahr B2B',type:'event',start:'2026-03-15',end:'2026-05-31',status:'geplant',standorte:12,umgesetzt:0,budget:10000,desc:'B2B-Kampagne fuer Firmenkunden. Flyer + Akquise-Toolbox.'},
            {id:4,name:'Social Media Push #BikeLife',type:'social',start:'2026-02-01',end:'2026-02-28',status:'aktiv',standorte:21,umgesetzt:16,budget:5000,desc:'Netzwerk-weiter Social Media Push mit Hashtag-Kampagne.'},
            {id:5,name:'Black Friday Bikes',type:'saisonal',start:'2025-11-25',end:'2025-12-01',status:'beendet',standorte:21,umgesetzt:21,budget:20000,desc:'Abgeschlossene Saisonkampagne.'},
            {id:6,name:'Weihnachts-Zubehoer',type:'saisonal',start:'2025-12-01',end:'2025-12-24',status:'beendet',standorte:21,umgesetzt:19,budget:8000,desc:'Zubehoer-Fokus im Weihnachtsgeschaeft.'}
        ];
        function renderHqKampagnen(){
            var aktiv=hqKampagnen.filter(function(k){return k.status==='aktiv';}).length;
            var geplant=hqKampagnen.filter(function(k){return k.status==='geplant';}).length;
            var beendet=hqKampagnen.filter(function(k){return k.status==='beendet';}).length;
            var totalBudget=hqKampagnen.reduce(function(a,k){return a+k.budget;},0);
            var avgUmsetzung=Math.round(hqKampagnen.filter(function(k){return k.status==='aktiv';}).reduce(function(a,k){return a+Math.round(k.umgesetzt/k.standorte*100);},0)/(aktiv||1));
            var kpi=document.getElementById('hqKampKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqKampagnen.length+'</p><p class="text-xs text-gray-500">Kampagnen total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+aktiv+'</p><p class="text-xs text-gray-500">Aktiv</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+geplant+'</p><p class="text-xs text-gray-500">Geplant</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-400">'+beendet+'</p><p class="text-xs text-gray-500">Beendet</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+avgUmsetzung+'%</p><p class="text-xs text-gray-500">Ã˜ Umsetzung (aktiv)</p></div>';

            var el=document.getElementById('hqKampList');if(!el)return;
            var h='';
            var statusCls={aktiv:'bg-green-100 text-green-700',geplant:'bg-blue-100 text-blue-700',beendet:'bg-gray-100 text-gray-500'};
            var statusLabel={aktiv:'ðŸŸ¢ Aktiv',geplant:'ðŸ”µ Geplant',beendet:'âšª Beendet'};
            var typLabel={saisonal:'ðŸŒ¸ Saison',produkt:'ðŸš² Produkt',event:'ðŸŽª Event',social:'ðŸ“± Social'};
            hqKampagnen.forEach(function(k){
                var pct=k.standorte?Math.round(k.umgesetzt/k.standorte*100):0;
                h+='<div class="vit-card p-5">';
                h+='<div class="flex items-start justify-between mb-3"><div><h3 class="font-bold text-gray-800">'+k.name+'</h3>';
                h+='<p class="text-xs text-gray-500">'+k.start+' bis '+k.end+' Â· Budget: '+fmt(k.budget)+' EUR</p></div>';
                h+='<div class="flex items-center space-x-2"><span class="text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">'+(typLabel[k.type]||k.type)+'</span>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(statusCls[k.status]||'')+'">'+(statusLabel[k.status]||k.status)+'</span></div></div>';
                h+='<p class="text-sm text-gray-600 mb-3">'+k.desc+'</p>';
                h+='<div class="flex items-center space-x-4">';
                h+='<div class="flex-1"><p class="text-xs text-gray-500 mb-1">Umsetzung: '+k.umgesetzt+'/'+k.standorte+' Standorte ('+pct+'%)</p>';
                h+='<div class="w-full bg-gray-100 rounded-full h-2.5"><div class="h-2.5 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-500')+'" style="width:'+pct+'%"></div></div></div>';
                if(k.status!=='beendet') h+='<button onclick="alert(\'Kampagne bearbeiten (Demo)\')" class="text-xs px-3 py-1.5 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200">Bearbeiten</button>';
                h+='</div></div>';
            });
            el.innerHTML=h;
        }
        function addHqKampagne(){
            var n=document.getElementById('hqKampName').value;if(!n){alert('Bitte Name eingeben.');return;}
            hqKampagnen.unshift({id:hqKampagnen.length+1,name:n,type:document.getElementById('hqKampType').value,start:document.getElementById('hqKampStart').value||'2026-03-01',end:document.getElementById('hqKampEnd').value||'2026-04-30',status:'geplant',standorte:21,umgesetzt:0,budget:0,desc:document.getElementById('hqKampDesc').value||''});
            document.getElementById('hqKampModal').classList.add('hidden');document.getElementById('hqKampName').value='';
            renderHqKampagnen();
        }

        // === HQ DOKUMENTE ===
        var hqDokumente = [
            {id:1,name:'Franchise-Handbuch v4.2',kat:'richtlinie',date:'2026-01-15',size:'2.4 MB',type:'PDF',target:'alle',downloads:18},
            {id:2,name:'Einkaufsrichtlinie Q1/2026',kat:'richtlinie',date:'2026-02-10',size:'840 KB',type:'PDF',target:'alle',downloads:15},
            {id:3,name:'Margen-Kalkulation Vorlage',kat:'vorlage',date:'2026-01-20',size:'120 KB',type:'XLSX',target:'alle',downloads:12},
            {id:4,name:'Angebots-Template vit:bikes',kat:'vorlage',date:'2025-11-01',size:'95 KB',type:'DOCX',target:'alle',downloads:21},
            {id:5,name:'BWA-Analyse Checkliste',kat:'vorlage',date:'2026-01-08',size:'65 KB',type:'PDF',target:'Inhaber',downloads:9},
            {id:6,name:'Schulung: Bosch Smart System',kat:'schulung',date:'2026-02-08',size:'15 MB',type:'MP4',target:'alle',downloads:8},
            {id:7,name:'Schulung: Verkaufsgespraeche fuehren',kat:'schulung',date:'2025-12-15',size:'22 MB',type:'MP4',target:'alle',downloads:14},
            {id:8,name:'Schulung: Reklamationsmanagement',kat:'schulung',date:'2025-10-20',size:'18 MB',type:'MP4',target:'alle',downloads:19},
            {id:9,name:'Muster-Arbeitsvertrag Verkaeufer',kat:'vertrag',date:'2025-09-01',size:'180 KB',type:'DOCX',target:'Inhaber',downloads:7},
            {id:10,name:'Muster-Arbeitsvertrag Werkstatt',kat:'vertrag',date:'2025-09-01',size:'175 KB',type:'DOCX',target:'Inhaber',downloads:5},
            {id:11,name:'Social Media Guidelines',kat:'richtlinie',date:'2026-01-25',size:'1.1 MB',type:'PDF',target:'alle',downloads:11},
            {id:12,name:'Ladenbau-Richtlinie CI/CD',kat:'richtlinie',date:'2025-06-01',size:'3.8 MB',type:'PDF',target:'alle',downloads:20}
        ];
        var currentHqDokFilter='all';
        function filterHqDok(f){
            currentHqDokFilter=f;
            document.querySelectorAll('.hqdok-filter').forEach(function(b){b.className='hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqdok-filter[data-hdf="'+f+'"]');
            if(btn)btn.className='hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqDokumente();
        }

        var netzDokCache = null;
        async function loadNetzwerkDokumente() {
            try {
                var resp = await sb.from('netzwerk_dokumente').select('*, users(name)').order('created_at', {ascending:false});
                if(resp.error) throw resp.error;
                netzDokCache = resp.data || [];
            } catch(e) { netzDokCache = []; console.warn('Dok load:', e); }
            renderHqDokumente();
        }

        function renderHqDokumente(){
            // Wenn DB-Daten da sind, nutze die; sonst Fallback auf hardcoded
            var allDoks = netzDokCache || hqDokumente || [];
            var isFromDb = netzDokCache !== null && netzDokCache.length > 0;
            var isHQ = sbProfile && sbProfile.is_hq;

            var list = currentHqDokFilter==='all' ? allDoks : allDoks.filter(function(d){ return isFromDb ? d.kategorie===currentHqDokFilter : d.kat===currentHqDokFilter; });

            var kpi=document.getElementById('hqDokKpis');
            var totalCount = allDoks.length;
            var richtCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='richtlinie';}).length;
            var vorlCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='vorlage';}).length;
            var schulCount = allDoks.filter(function(d){return (isFromDb?d.kategorie:d.kat)==='schulung';}).length;
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+totalCount+'</p><p class="text-xs text-gray-500">Dokumente</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+richtCount+'</p><p class="text-xs text-gray-500">Richtlinien</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+vorlCount+'</p><p class="text-xs text-gray-500">Vorlagen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-purple-600">'+schulCount+'</p><p class="text-xs text-gray-500">Schulungen</p></div>';

            var el=document.getElementById('hqDokList');if(!el)return;
            var h='';
            var katIcons={richtlinie:'\uD83D\uDCCB',vorlage:'\uD83D\uDCC4',schulung:'\uD83C\uDF93',vertrag:'\uD83D\uDCD1',sonstiges:'\uD83D\uDCC1'};
            list.forEach(function(d){
                var kat = isFromDb ? d.kategorie : d.kat;
                var name = isFromDb ? d.titel : d.name;
                var dateStr = isFromDb ? new Date(d.created_at).toLocaleDateString('de-DE') : d.date;
                var sizeStr = isFromDb ? formatFileSize(d.datei_groesse) : d.size;
                var fileName = isFromDb ? (d.datei_name||'') : '';
                var ext = fileName.split('.').pop().toUpperCase();
                var typeColors={PDF:'bg-red-100 text-red-600',XLSX:'bg-green-100 text-green-700',DOCX:'bg-blue-100 text-blue-700',MP4:'bg-purple-100 text-purple-700',PNG:'bg-pink-100 text-pink-600',JPG:'bg-pink-100 text-pink-600'};

                h+='<div class="vit-card p-3 flex items-center space-x-3">';
                h+='<span class="text-2xl">'+(katIcons[kat]||'\uD83D\uDCC1')+'</span>';
                h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+name+'</p>';
                h+='<p class="text-[10px] text-gray-500">'+dateStr+' \u00B7 '+sizeStr;
                if(isFromDb && d.users && d.users.name) h+=' \u00B7 '+d.users.name;
                h+='</p></div>';
                if(ext) h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(typeColors[ext]||'bg-gray-100 text-gray-600')+'">'+ext+'</span>';
                if(isFromDb) {
                    h+='<button onclick="downloadDokument(\''+d.datei_url+'\')" class="text-xs px-3 py-1 bg-vit-orange text-white rounded-lg hover:opacity-90">\u2193</button>';
                    if(isHQ) h+='<button onclick="deleteNetzwerkDok(\''+d.id+'\')" class="text-xs px-2 py-1 text-gray-300 hover:text-red-500">\u2715</button>';
                } else {
                    h+='<span class="text-xs text-gray-400">'+(d.downloads||0)+'x \u2193</span>';
                    h+='<button onclick="alert(\'Download fuer '+name+' wird vorbereitet...\')" class="text-xs px-3 py-1 bg-vit-orange text-white rounded-lg hover:opacity-90">\u2193</button>';
                }
                h+='</div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400">Keine Dokumente in dieser Kategorie.</div>';
            el.innerHTML=h;
        }

        function formatFileSize(bytes) {
            if(!bytes) return 'â€”';
            if(bytes < 1024) return bytes + ' B';
            if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
            return (bytes/1048576).toFixed(1) + ' MB';
        }

        async function downloadDokument(path) {
            try {
                var resp = await sb.storage.from('dokumente').createSignedUrl(path, 3600);
                if(resp.error) throw resp.error;
                window.open(resp.data.signedUrl, '_blank');
            } catch(err) { alert('Download-Fehler: '+err.message); }
        }

        async function deleteNetzwerkDok(id) {
            if(!confirm('Dokument wirklich loeschen?')) return;
            try {
                var dokResp = await sb.from('netzwerk_dokumente').select('datei_url').eq('id',id).single();
                if(dokResp.data && dokResp.data.datei_url) {
                    await sb.storage.from('dokumente').remove([dokResp.data.datei_url]);
                }
                await sb.from('netzwerk_dokumente').delete().eq('id',id);
                await loadNetzwerkDokumente();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        // === HQ KALENDER (DB-backed) ===
        var hqKalTermine = [];

        async function loadHqKalTermine() {
            try {
                var resp = await sb.from('termine').select('*').eq('ist_netzwerk_termin', true).order('start_zeit', {ascending:true});
                if(!resp.error && resp.data && resp.data.length > 0) {
                    hqKalTermine = (resp.data||[]).map(function(t) {
                        var d = new Date(t.start_zeit);
                        return {
                            id: t.id, title: t.titel,
                            date: d.toISOString().slice(0,10),
                            time: t.ganztaegig ? '23:59' : String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'),
                            type: t.typ || 'meeting',
                            target: t.zielgruppe || 'alle',
                            pflicht: t.pflicht || false,
                            ms365_event_id: t.ms365_event_id || null
                        };
                    });
                } else {
                    // Fallback demo data when DB is empty
                    hqKalTermine = [
                        {id:1,title:'Schulung: Bosch Smart System (Online)',date:'2026-02-25',time:'09:00',type:'schulung',target:'alle',pflicht:true},
                        {id:2,title:'Orbea Rise Launch Event â€“ Kick-off',date:'2026-02-20',time:'10:00',type:'event',target:'alle',pflicht:false},
                        {id:3,title:'Deadline: Vororder Sommer 2026',date:'2026-03-01',time:'23:59',type:'deadline',target:'alle',pflicht:true},
                        {id:4,title:'Netzwerk-Meeting Q1 (Online)',date:'2026-03-05',time:'14:00',type:'meeting',target:'alle',pflicht:true},
                        {id:5,title:'Schulung: Verkaufsgespraeche Advanced',date:'2026-03-12',time:'09:00',type:'schulung',target:'alle',pflicht:false},
                        {id:6,title:'Fruehlings-Aktionstag â€“ Probefahrt-Event',date:'2026-03-15',time:'10:00',type:'event',target:'alle',pflicht:false},
                        {id:7,title:'Deadline: Social Media Monatsplanung Maerz',date:'2026-02-28',time:'23:59',type:'deadline',target:'alle',pflicht:false},
                        {id:8,title:'Region Sued Meeting',date:'2026-03-10',time:'15:00',type:'meeting',target:'Region SÃ¼d',pflicht:true},
                        {id:9,title:'Schulung: Shimano STEPS EP801',date:'2026-03-20',time:'09:00',type:'schulung',target:'alle',pflicht:false},
                        {id:10,title:'Deadline: BWA Februar einreichen',date:'2026-03-15',time:'23:59',type:'deadline',target:'Inhaber',pflicht:true}
                    ];
                }
            } catch(err) { console.warn('HQ Kalender load:', err); }
            renderHqKalender();
        }
        var currentHqKalFilter='all';
        function filterHqKal(f){
            currentHqKalFilter=f;
            document.querySelectorAll('.hqkal-filter').forEach(function(b){b.className='hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqkal-filter[data-hkf="'+f+'"]');
            if(btn)btn.className='hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqKalender();
        }
        function renderHqKalender(){
            var today=new Date().toISOString().slice(0,10);
            var list=hqKalTermine.filter(function(t){
                if(currentHqKalFilter!=='all' && t.type!==currentHqKalFilter) return false;
                return true;
            }).sort(function(a,b){return a.date>b.date?1:-1;});

            var upcoming=list.filter(function(t){return t.date>=today;}).length;
            var past=list.filter(function(t){return t.date<today;}).length;
            var pflicht=list.filter(function(t){return t.pflicht && t.date>=today;}).length;
            var kpi=document.getElementById('hqKalKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqKalTermine.length+'</p><p class="text-xs text-gray-500">Termine total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+upcoming+'</p><p class="text-xs text-gray-500">Anstehend</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500">'+pflicht+'</p><p class="text-xs text-gray-500">Pflichttermine</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-400">'+past+'</p><p class="text-xs text-gray-500">Vergangen</p></div>';

            var el=document.getElementById('hqKalList');if(!el)return;
            var h='';
            var typeIcons={schulung:'ðŸŽ“',event:'ðŸŽª',deadline:'â°',meeting:'ðŸ¤'};
            var typeCls={schulung:'bg-purple-100 text-purple-700',event:'bg-green-100 text-green-700',deadline:'bg-red-100 text-red-700',meeting:'bg-blue-100 text-blue-700'};
            var dayNames=['So','Mo','Di','Mi','Do','Fr','Sa'];
            list.forEach(function(t){
                var dd=new Date(t.date);var dayName=dayNames[dd.getDay()];
                var isPast=t.date<today;
                h+='<div class="vit-card p-3 flex items-center space-x-3 '+(isPast?'opacity-50':'')+'">';
                h+='<div class="text-center flex-shrink-0 w-14 '+(isPast?'':'bg-orange-50 rounded-lg p-1')+'"><p class="text-[10px] text-gray-500">'+dayName+'</p><p class="text-lg font-bold text-gray-800">'+parseInt(t.date.slice(8))+'</p><p class="text-[10px] text-gray-400">'+t.date.slice(5,7)+'.'+t.date.slice(0,4)+'</p></div>';
                h+='<span class="text-xl">'+(typeIcons[t.type]||'ðŸ“…')+'</span>';
                h+='<div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">'+t.title+'</p>';
                h+='<p class="text-[10px] text-gray-500">'+t.time+' Uhr Â· Ziel: '+t.target+(t.pflicht?' Â· <span class="text-red-500 font-bold">PFLICHT</span>':'')+'</p></div>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(typeCls[t.type]||'')+'">'+(typeIcons[t.type]||'')+' '+t.type.charAt(0).toUpperCase()+t.type.slice(1)+'</span>';
                h+='</div>';
            });
            el.innerHTML=h;
        }
        async function addHqKalTermin(){
            var title=document.getElementById('hqKalTitle').value;if(!title){alert('Bitte Titel eingeben.');return;}
            var date=document.getElementById('hqKalDate').value||new Date().toISOString().slice(0,10);
            var time=document.getElementById('hqKalTime').value||'09:00';
            var type=document.getElementById('hqKalType').value;
            var target=document.getElementById('hqKalTarget').value;
            var payload={
                titel:title, start_zeit:date+'T'+time+':00', typ:type,
                ist_netzwerk_termin:true, zielgruppe:target==='alle'?'alle':target,
                pflicht:false, ganztaegig:type==='deadline',
                erstellt_von:sbUser?sbUser.id:null,
                erstellt_von_name:sbProfile?sbProfile.name:'HQ'
            };
            try{
                var resp=await sb.from('termine').insert(payload);
                if(resp.error)throw resp.error;
                document.getElementById('hqKalModal').classList.add('hidden');
                document.getElementById('hqKalTitle').value='';
                await loadHqKalTermine();
            }catch(err){alert('Fehler: '+(err.message||err));}
        }

        // === HQ AUFGABEN ===
        var hqTasks = [
            {id:1,title:'Fruehjahrs-Deko aufbauen (POS-Material)',deadline:'2026-03-01',prio:'hoch',target:'alle',status:'offen',done:8,total:21,kat:'Marketing'},
            {id:2,title:'Vororder Sommer 2026 platzieren',deadline:'2026-03-01',prio:'hoch',target:'alle',status:'inprogress',done:14,total:21,kat:'Einkauf'},
            {id:3,title:'BWA Januar einreichen',deadline:'2026-02-20',prio:'hoch',target:'Inhaber',status:'inprogress',done:15,total:21,kat:'Controlling'},
            {id:4,title:'Local Hero Video drehen: Fruehjahrsthema',deadline:'2026-02-28',prio:'mittel',target:'alle',status:'offen',done:5,total:21,kat:'Marketing'},
            {id:5,title:'Werkstatt-Inventur durchfuehren',deadline:'2026-03-01',prio:'mittel',target:'Region SÃ¼d',status:'inprogress',done:4,total:8,kat:'Operations'},
            {id:6,title:'Schulungs-Video Bosch anschauen',deadline:'2026-02-28',prio:'niedrig',target:'alle',status:'offen',done:8,total:21,kat:'Wissen'},
            {id:7,title:'Kundenzufriedenheits-Umfrage ausfuellen',deadline:'2026-02-15',prio:'mittel',target:'alle',status:'inprogress',done:17,total:21,kat:'Support'},
            {id:8,title:'Jobrad-Info im Laden aushangen',deadline:'2026-03-15',prio:'niedrig',target:'alle',status:'offen',done:0,total:21,kat:'Marketing'},
            {id:9,title:'Social Media Profil aktualisieren',deadline:'2026-01-31',prio:'niedrig',target:'alle',status:'done',done:21,total:21,kat:'Marketing'},
            {id:10,title:'Weihnachts-Deko abbauen',deadline:'2026-01-10',prio:'niedrig',target:'alle',status:'done',done:21,total:21,kat:'Operations'}
        ];
        var currentHqTaskFilter='all';
        function filterHqTasks(f){
            currentHqTaskFilter=f;
            document.querySelectorAll('.hqtask-filter').forEach(function(b){b.className='hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hqtask-filter[data-htf="'+f+'"]');
            if(btn)btn.className='hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderHqAufgaben();
        }
        function renderHqAufgaben(){
            var today=new Date().toISOString().slice(0,10);
            var list=hqTasks.filter(function(t){
                if(currentHqTaskFilter==='all') return true;
                return t.status===currentHqTaskFilter;
            });
            var offen=hqTasks.filter(function(t){return t.status==='offen';}).length;
            var inprog=hqTasks.filter(function(t){return t.status==='inprogress';}).length;
            var done=hqTasks.filter(function(t){return t.status==='done';}).length;
            var overdue=hqTasks.filter(function(t){return t.status!=='done'&&t.deadline<today;}).length;
            var avgCompl=Math.round(hqTasks.filter(function(t){return t.status!=='done';}).reduce(function(a,t){return a+Math.round(t.done/t.total*100);},0)/(hqTasks.filter(function(t){return t.status!=='done';}).length||1));
            var kpi=document.getElementById('hqTaskKpis');
            if(kpi) kpi.innerHTML='<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800">'+hqTasks.length+'</p><p class="text-xs text-gray-500">Aufgaben total</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500">'+offen+'</p><p class="text-xs text-gray-500">Offen</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+inprog+'</p><p class="text-xs text-gray-500">In Arbeit</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+done+'</p><p class="text-xs text-gray-500">Erledigt</p></div>'
                +'<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+avgCompl+'%</p><p class="text-xs text-gray-500">Ã˜ Umsetzung</p></div>';

            var el=document.getElementById('hqTaskList');if(!el)return;
            var h='';
            var prioIcons={hoch:'ðŸ”´',mittel:'ðŸŸ¡',niedrig:'ðŸŸ¢'};
            var statusCls={offen:'bg-red-100 text-red-700',inprogress:'bg-blue-100 text-blue-700',done:'bg-green-100 text-green-700'};
            var statusLabel={offen:'Offen',inprogress:'In Arbeit',done:'Erledigt'};
            list.sort(function(a,b){var po={hoch:0,mittel:1,niedrig:2};return (po[a.prio]||1)-(po[b.prio]||1);});
            list.forEach(function(t){
                var pct=Math.round(t.done/t.total*100);
                var isOver=t.status!=='done'&&t.deadline<today;
                h+='<div class="vit-card p-4 '+(isOver?'border-l-4 border-red-500':'')+'">';
                h+='<div class="flex items-start justify-between mb-2"><div class="flex-1">';
                h+='<div class="flex items-center space-x-2"><span>'+(prioIcons[t.prio]||'')+'</span><p class="font-bold text-sm text-gray-800">'+t.title+'</p></div>';
                h+='<p class="text-[10px] text-gray-500 mt-0.5">'+t.kat+' Â· Deadline: '+t.deadline+' Â· Ziel: '+t.target+(isOver?' Â· <span class="text-red-500 font-bold">'+t('todo_overdue')+'</span>':'')+'</p>';
                h+='</div>';
                h+='<span class="text-[10px] px-2 py-0.5 rounded-full font-bold '+(statusCls[t.status]||'')+'">'+(statusLabel[t.status]||t.status)+'</span></div>';
                h+='<div class="flex items-center space-x-3"><div class="flex-1">';
                h+='<div class="flex items-center justify-between mb-0.5"><span class="text-[10px] text-gray-500">'+t.done+' / '+t.total+' Standorte ('+pct+'%)</span></div>';
                h+='<div class="w-full bg-gray-100 rounded-full h-2"><div class="h-2 rounded-full '+(pct>=80?'bg-green-500':pct>=50?'bg-yellow-500':'bg-red-400')+'" style="width:'+pct+'%"></div></div>';
                h+='</div></div></div>';
            });
            if(!list.length) h='<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">âœ…</p><p class="text-sm">Keine Aufgaben in diesem Filter</p></div>';
            el.innerHTML=h;
        }
        function addHqTask(){
            var title=document.getElementById('hqTaskTitle').value;if(!title){alert('Bitte Aufgabe eingeben.');return;}
            var target=document.getElementById('hqTaskTarget').value;
            var total=target==='alle'?21:target==='region_sued'?8:target==='region_nord'?5:target==='region_west'?5:3;
            hqTasks.unshift({id:hqTasks.length+1,title:title,deadline:document.getElementById('hqTaskDeadline').value||'2026-03-31',prio:document.getElementById('hqTaskPrio').value,target:target==='alle'?'alle':target.replace('region_','Region '),status:'offen',done:0,total:total,kat:'HQ'});
            document.getElementById('hqTaskModal').classList.add('hidden');document.getElementById('hqTaskTitle').value='';
            renderHqAufgaben();
        }

        // === HQ AUSWERTUNG: Portal-Nutzung ===
        // ========================================
        // PORTAL-NUTZUNG MODUL - STANDALONE VERSION
        // NUR fÃ¼r das Modul "Nutzung Portal" (hqAuswertung)
        // 
        // ERSETZE HIERMIT (in index.html):
        // Von: var portalNutzung = [
        // Bis: // === HQ WISSEN-VERWALTUNG ===
        //
        // Zeilen ca. 11726-11820
        // ========================================
        
        // === HILFSFUNKTIONEN ===
        
        // Berechnet das Alter einer BWA in Tagen
        function calculateBwaAge(uploadDate) {
          if (!uploadDate) return null;
          const upload = new Date(uploadDate);
          const now = new Date();
          const diffTime = Math.abs(now - upload);
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          return diffDays;
        }
        
        // ZÃ¤hlt wie viele Features ein Standort nutzt (max 7)
        function countFeaturesUsed(s) {
          let count = 0;
          if (s.termine_30d > 0) count++; // Kalender
          if (s.todos_created_30d > 0) count++; // Aufgaben
          if (s.leads_30d > 0) count++; // Verkauf/Pipeline
          if (s.latest_bwa_month) count++; // BWA/Controlling
          if (s.chat_messages_30d > 0) count++; // Chat
          if (s.tickets_total > 0) count++; // Support
          if (s.forum_posts_30d > 0) count++; // Forum
          return count;
        }
        
        // Berechnet Activity Score (0-100 Punkte)
        function calculateActivityScore(s) {
          let score = 0;
          
          // 1. Team-Beteiligung (20 Punkte)
          if (s.user_count > 0) {
            const participationRate = s.active_users / s.user_count;
            score += Math.min(20, participationRate * 20);
          }
          
          // 2. Feature-Nutzung (30 Punkte)
          const featureScore = (s.features_used / 7) * 15;
          score += featureScore;
          
          // BWA-Bonus (15 Punkte)
          if (s.latest_bwa_month) {
            const bwaAge = calculateBwaAge(s.latest_bwa_upload);
            if (bwaAge !== null && bwaAge <= 45) {
              score += 15; // BWA aktuell
            } else if (bwaAge !== null && bwaAge <= 90) {
              score += 10; // BWA etwas Ã¤lter
            } else {
              score += 5; // BWA sehr alt
            }
          }
          
          // 3. ProduktivitÃ¤t (30 Punkte)
          score += Math.min(10, s.todos_done_30d / 5); // max 10 bei 50+ Todos
          score += Math.min(10, s.termine_30d / 3); // max 10 bei 30+ Terminen
          score += Math.min(10, s.leads_30d / 2); // max 10 bei 20+ Leads
          
          // 4. Kommunikation (20 Punkte)
          score += Math.min(10, s.chat_messages_30d / 5); // max 10 bei 50+ Chat
          const commScore = Math.min(5, s.tickets_total) + Math.min(5, s.forum_posts_30d / 2);
          score += Math.min(10, commScore);
          
          return Math.round(score);
        }
        
        // === DATEN LADEN ===
        
        // LÃ¤dt Portal-Nutzungsdaten aus Supabase
        async function loadPortalNutzungData() {
          try {
            // Supabase RPC-Call
            const { data, error } = await sb.rpc('get_portal_usage_stats');
            
            if (error) {
              console.error('Error loading portal usage stats:', error);
              return [];
            }
            
            if (!data || data.length === 0) {
              console.warn('No usage data returned from database');
              return [];
            }
            
            // Daten transformieren
            return data.map(standort => {
              const features_used = countFeaturesUsed(standort);
              const transformed = {
                id: standort.standort_id,
                name: standort.standort_name,
                user_count: parseInt(standort.user_count),
                active_users: parseInt(standort.active_users),
                termine_30d: parseInt(standort.termine_30d),
                todos_created_30d: parseInt(standort.todos_created_30d),
                todos_done_30d: parseInt(standort.todos_done_30d),
                leads_30d: parseInt(standort.leads_30d),
                pipeline_value: parseFloat(standort.pipeline_value),
                latest_bwa_month: standort.latest_bwa_month,
                latest_bwa_upload: standort.latest_bwa_upload,
                bwa_age_days: calculateBwaAge(standort.latest_bwa_upload),
                chat_messages_30d: parseInt(standort.chat_messages_30d),
                tickets_total: parseInt(standort.tickets_total),
                tickets_open: parseInt(standort.tickets_open),
                forum_posts_30d: parseInt(standort.forum_posts_30d),
                features_used: features_used
              };
              
              transformed.score = calculateActivityScore(transformed);
              return transformed;
            });
            
          } catch (err) {
            console.error('Error in loadPortalNutzungData:', err);
            return [];
          }
        }
        
        // === RENDER-FUNKTION ===
        
        // Rendert das komplette HQ Auswertung Dashboard
        async function renderHqAuswertung() {
          // Daten laden
          const usageData = await loadPortalNutzungData();
          
          if (!usageData || usageData.length === 0) {
            console.warn('No usage data available - showing empty state');
            const kpiEl = document.getElementById('hqAuswKpis');
            if (kpiEl) {
              kpiEl.innerHTML = '<div class="col-span-5 text-center text-gray-500 p-8">Keine Nutzungsdaten verfÃ¼gbar. Bitte SQL-Funktion in Supabase erstellen.</div>';
            }
            return;
          }
          
          // Nach Score sortieren
          const sorted = usageData.slice().sort((a, b) => b.score - a.score);
          const totalStandorte = usageData.length;
          
          // === KPI BERECHNUNG ===
          const avgScore = Math.round(usageData.reduce((sum, s) => sum + s.score, 0) / totalStandorte);
          
          const avgParticipation = Math.round(
            usageData.reduce((sum, s) => {
              return sum + (s.user_count > 0 ? (s.active_users / s.user_count) * 100 : 0);
            }, 0) / totalStandorte
          );
          
          const bwaCount = usageData.filter(s => s.bwa_age_days !== null && s.bwa_age_days <= 45).length;
          const avgFeatures = (usageData.reduce((sum, s) => sum + s.features_used, 0) / totalStandorte).toFixed(1);
          const inactiveCount = usageData.filter(s => s.score < 30).length;
          
          // === KPI-KARTEN ===
          const kpiEl = document.getElementById('hqAuswKpis');
          if (kpiEl) {
            kpiEl.innerHTML = `
              <div class="vit-card p-4 text-center">
                <p class="text-3xl font-bold text-gray-800">${avgScore}</p>
                <p class="text-xs text-gray-500 mt-1">Ã˜ Activity Score</p>
              </div>
              <div class="vit-card p-4 text-center">
                <p class="text-3xl font-bold text-blue-600">${avgParticipation}%</p>
                <p class="text-xs text-gray-500 mt-1">Ã˜ Team-Beteiligung</p>
              </div>
              <div class="vit-card p-4 text-center">
                <p class="text-3xl font-bold ${bwaCount >= Math.floor(totalStandorte * 0.7) ? 'text-green-600' : 'text-yellow-500'}">${bwaCount}/${totalStandorte}</p>
                <p class="text-xs text-gray-500 mt-1">Aktuelle BWA</p>
              </div>
              <div class="vit-card p-4 text-center">
                <p class="text-3xl font-bold text-vit-orange">${avgFeatures}</p>
                <p class="text-xs text-gray-500 mt-1">Ã˜ Features genutzt</p>
              </div>
              <div class="vit-card p-4 text-center">
                <p class="text-3xl font-bold ${inactiveCount > 3 ? 'text-red-500' : 'text-gray-500'}">${inactiveCount}</p>
                <p class="text-xs text-gray-500 mt-1">Niedrige AktivitÃ¤t</p>
              </div>
            `;
          }
          
          // === TOP 5 ===
          const topEl = document.getElementById('hqAuswTop');
          if (topEl) {
            let html = '';
            sorted.slice(0, 5).forEach((s, index) => {
              const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
              html += `
                <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                  <span class="text-sm font-bold text-gray-400 w-6">${medal || (index + 1)}</span>
                  <div class="flex-1">
                    <p class="text-xs font-semibold text-gray-800">${s.name}</p>
                    <p class="text-[10px] text-gray-500">${s.active_users}/${s.user_count} User â€¢ ${s.features_used}/7 Features</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold text-vit-orange">${s.score}</p>
                    <p class="text-[10px] text-gray-500">Score</p>
                  </div>
                </div>
              `;
            });
            topEl.innerHTML = html;
          }
          
          // === BOTTOM 5 ===
          const bottomEl = document.getElementById('hqAuswBottom');
          if (bottomEl) {
            let html = '';
            sorted.slice(-5).reverse().forEach((s) => {
              const statusColor = s.score < 20 ? 'red' : s.score < 40 ? 'yellow' : 'gray';
              html += `
                <div class="flex items-center space-x-3 p-2 bg-gray-50 rounded-lg">
                  <div class="flex-1">
                    <p class="text-xs font-semibold text-gray-800">${s.name}</p>
                    <p class="text-[10px] text-gray-500">
                      ${s.active_users}/${s.user_count} User â€¢ 
                      ${s.latest_bwa_month ? `BWA: ${s.latest_bwa_month}` : 'Keine BWA'}
                    </p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold text-${statusColor}-500">${s.score}</p>
                    <p class="text-[10px] text-gray-500">Score</p>
                  </div>
                </div>
              `;
            });
            bottomEl.innerHTML = html;
          }
          
          // === MODUL-NUTZUNG ===
          const moduleStats = [
            { name: 'Kalender', count: usageData.filter(s => s.termine_30d > 0).length, icon: 'ðŸ“…' },
            { name: 'Aufgaben', count: usageData.filter(s => s.todos_created_30d > 0).length, icon: 'âœ“' },
            { name: 'Verkauf/Pipeline', count: usageData.filter(s => s.leads_30d > 0).length, icon: 'ðŸ’°' },
            { name: 'BWA/Controlling', count: usageData.filter(s => s.latest_bwa_month).length, icon: 'ðŸ“Š' },
            { name: 'Chat', count: usageData.filter(s => s.chat_messages_30d > 0).length, icon: 'ðŸ’¬' },
            { name: 'Support', count: usageData.filter(s => s.tickets_total > 0).length, icon: 'ðŸŽ«' },
            { name: 'Forum', count: usageData.filter(s => s.forum_posts_30d > 0).length, icon: 'ðŸ“¢' }
          ];
          
          const moduleEl = document.getElementById('hqAuswModules');
          if (moduleEl) {
            let html = '';
            moduleStats.sort((a, b) => b.count - a.count).forEach(m => {
              const pct = Math.round((m.count / totalStandorte) * 100);
              html += `
                <div class="flex items-center space-x-3 py-2">
                  <span class="text-sm w-6">${m.icon}</span>
                  <span class="text-xs font-medium text-gray-700 w-36">${m.name}</span>
                  <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div class="bg-vit-orange h-2 rounded-full transition-all" style="width: ${pct}%"></div>
                  </div>
                  <span class="text-xs font-semibold text-gray-600 w-16 text-right">${m.count}/${totalStandorte}</span>
                  <span class="text-xs text-gray-500 w-10 text-right">${pct}%</span>
                </div>
              `;
            });
            moduleEl.innerHTML = html;
          }
          
          // === ALLE STANDORTE - SCORE BARS ===
          const allEl = document.getElementById('hqAuswAll');
          if (allEl) {
            let html = '';
            sorted.forEach(s => {
              const maxScore = 100;
              const widthPct = Math.min(100, (s.score / maxScore) * 100);
              const barColor = s.score >= 70 ? 'bg-green-500' : 
                               s.score >= 50 ? 'bg-vit-orange' : 
                               s.score >= 30 ? 'bg-yellow-500' : 'bg-red-400';
              
              html += `
                <div class="flex items-center space-x-2 py-1">
                  <span class="text-[10px] w-32 truncate text-gray-700 font-medium">${s.name}</span>
                  <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                    <div class="${barColor} h-1.5 rounded-full transition-all" style="width: ${widthPct}%"></div>
                  </div>
                  <span class="text-[10px] font-bold text-gray-800 w-8 text-right">${s.score}</span>
                </div>
              `;
            });
            allEl.innerHTML = html;
          }
        }

        // === HQ WISSEN-VERWALTUNG ===
        var hqWissenItems = [
            {titel:'E-Bike Beratungsleitfaden 2026',kat:'handbuch',bereich:'Verkauf',datum:'12.02.2026',status:'live'},
            {titel:'Werkstatt: Bosch CX Gen5 Service',kat:'akademie',bereich:'Werkstatt',datum:'08.02.2026',status:'live'},
            {titel:'Social Media Best Practices Q1',kat:'bestpractice',bereich:'Marketing',datum:'05.02.2026',status:'live'},
            {titel:'Kassensystem Einrichtung',kat:'handbuch',bereich:'Betrieb',datum:'01.02.2026',status:'live'},
            {titel:'FAQ: Garantie-Abwicklung',kat:'faq',bereich:'Verkauf',datum:'28.01.2026',status:'live'},
            {titel:'Leasing-Angebote richtig kalkulieren',kat:'akademie',bereich:'Verkauf',datum:'25.01.2026',status:'live'},
            {titel:'Ladenbau-Konzept Richtlinien',kat:'handbuch',bereich:'Betrieb',datum:'20.01.2026',status:'live'},
            {titel:'Instagram Reels Anleitung',kat:'bestpractice',bereich:'Marketing',datum:'15.01.2026',status:'live'}
        ];
        function renderHqWissen(){
            var el=document.getElementById('hqWissenList');
            if(!el) return;
            var katIcons={akademie:'ðŸŽ“',handbuch:'ðŸ“–',bestpractice:'â­',faq:'â“'};
            var h='';
            hqWissenItems.forEach(function(w,i){
                h+='<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center space-x-3"><span class="text-lg">'+katIcons[w.kat]+'</span><div><p class="text-sm font-semibold text-gray-800">'+w.titel+'</p><p class="text-xs text-gray-500">'+w.bereich+' Â· '+w.datum+'</p></div></div><span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">'+w.status+'</span></div>';
            });
            el.innerHTML=h;
        }
        function addHqWissen(){
            var t=document.getElementById('hqWissenTitel');
            var k=document.getElementById('hqWissenKat');
            if(!t||!t.value.trim()){alert('Bitte Titel eingeben');return;}
            hqWissenItems.unshift({titel:t.value.trim(),kat:k.value,bereich:document.getElementById('hqWissenBereich').value,datum:new Date().toLocaleDateString('de-DE'),status:'live'});
            t.value='';document.getElementById('hqWissenInhalt').value='';
            renderHqWissen();
        }

        // === HQ SUPPORT-ÃœBERSICHT ===
        var hqSupportData = [
            {id:'T-2401',standort:'Grafrath',betreff:'Kassensystem Fehler beim Tagesabschluss',prio:'hoch',status:'offen',datum:'13.02.2026'},
            {id:'T-2402',standort:'Hamburg',betreff:'Schaufenster-Folie loest sich',prio:'mittel',status:'offen',datum:'13.02.2026'},
            {id:'T-2403',standort:'Weilheim',betreff:'Zugang Buchhaltungs-Tool gesperrt',prio:'hoch',status:'in Bearbeitung',datum:'12.02.2026'},
            {id:'T-2404',standort:'Karlsdorf',betreff:'Lieferverzoegerung Shimano Steps',prio:'mittel',status:'offen',datum:'12.02.2026'},
            {id:'T-2405',standort:'Grafrath',betreff:'Portal: BWA-Upload Fehlermeldung',prio:'niedrig',status:'in Bearbeitung',datum:'11.02.2026'},
            {id:'T-2406',standort:'Hamburg',betreff:'Marketing-Material fuer Fruehjahrsaktion',prio:'niedrig',status:'offen',datum:'11.02.2026'},
            {id:'T-2407',standort:'Weilheim',betreff:'Werkstatt-Terminplaner synchronisiert nicht',prio:'hoch',status:'in Bearbeitung',datum:'10.02.2026'}
        ];
        function renderHqSupport(){
            var el=document.getElementById('hqSupportTickets');
            if(!el) return;
            var prioColors={hoch:'bg-red-100 text-red-700',mittel:'bg-yellow-100 text-yellow-700',niedrig:'bg-gray-100 text-gray-600'};
            var statusColors={'offen':'bg-red-50 text-red-600','in Bearbeitung':'bg-blue-50 text-blue-600'};
            var h='';
            hqSupportData.forEach(function(t){
                h+='<div class="p-4 bg-gray-50 rounded-lg"><div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2"><span class="text-xs font-mono text-gray-400">'+t.id+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(prioColors[t.prio]||'')+'">'+t.prio+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusColors[t.status]||'')+'">'+t.status+'</span></div><span class="text-xs text-gray-400">'+t.datum+'</span></div><p class="text-sm font-semibold text-gray-800">'+t.betreff+'</p><p class="text-xs text-gray-500 mt-1">ðŸ“ '+t.standort+'</p></div>';
            });
            el.innerHTML=h;
            // Stats per location
            var stats={};
            hqSupportData.forEach(function(t){stats[t.standort]=(stats[t.standort]||0)+1;});
            var sEl=document.getElementById('hqSupportStats');
            if(sEl){
                var sh='';
                Object.keys(stats).sort(function(a,b){return stats[b]-stats[a];}).forEach(function(s){
                    sh+='<div class="flex items-center justify-between p-2 bg-gray-50 rounded"><span class="text-sm font-semibold">ðŸ“ '+s+'</span><span class="text-sm font-bold text-gray-800">'+stats[s]+' Tickets</span></div>';
                });
                sEl.innerHTML=sh;
            }
        }

        // === HQ IDEENBOARD (Supabase) ===
        async function renderHqIdeen(filter){
            var el=document.getElementById('hqIdeenList');
            if(!el) return;
            try {
                var query = sb.from('ideen').select('*, users(name), standorte(name)').order('votes', {ascending:false});
                if(filter && filter!=='all') query = query.eq('status', filter);
                var resp = await query;
                if(resp.error) throw resp.error;
                var ideas = resp.data || [];
                var allResp = await sb.from('ideen').select('status');
                var all = allResp.data || [];
                var t=document.getElementById('hqIdeenTotal');if(t)t.textContent=all.length;
                var p=document.getElementById('hqIdeenPruefung');if(p)p.textContent=all.filter(function(i){return i.status==='wird_geprueft'||i.status==='diskussion';}).length;
                var u=document.getElementById('hqIdeenUmgesetzt');if(u)u.textContent=all.filter(function(i){return i.status==='umgesetzt';}).length;
                var a=document.getElementById('hqIdeenAbgelehnt');if(a)a.textContent=all.filter(function(i){return i.status==='abgelehnt';}).length;
                var statusC={neu:'bg-blue-100 text-blue-700',diskussion:'bg-yellow-100 text-yellow-700',wird_geprueft:'bg-yellow-100 text-yellow-700',geplant:'bg-purple-100 text-purple-700',umgesetzt:'bg-green-100 text-green-700',abgelehnt:'bg-red-100 text-red-700'};
                var statusL={neu:'Neu',diskussion:'In Diskussion',wird_geprueft:'Wird gepr\u00fcft',geplant:'Geplant',umgesetzt:'Umgesetzt',abgelehnt:'Abgelehnt'};
                var h='';
                ideas.forEach(function(idee){
                    var standortName = idee.standorte ? idee.standorte.name : 'HQ';
                    var authorName = idee.users ? idee.users.name : 'Unbekannt';
                    var d = idee.created_at ? new Date(idee.created_at).toLocaleDateString('de-DE') : '';
                    h+='<div class="p-4 bg-gray-50 rounded-lg">';
                    h+='<div class="flex items-center justify-between mb-2">';
                    h+='<div class="flex items-center space-x-3">';
                    h+='<span class="text-lg font-bold text-vit-orange">\ud83d\udc4d '+(idee.votes||0)+'</span>';
                    h+='<span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusC[idee.status]||'bg-gray-100 text-gray-600')+'">'+(statusL[idee.status]||idee.status)+'</span>';
                    h+='<select onchange="updateIdeeStatus(\''+idee.id+'\',this.value)" class="text-xs border border-gray-200 rounded px-1 py-0.5">';
                    ['neu','wird_geprueft','geplant','umgesetzt','abgelehnt'].forEach(function(s){
                        h+='<option value="'+s+'"'+(idee.status===s?' selected':'')+'>'+(statusL[s]||s)+'</option>';
                    });
                    h+='</select></div>';
                    h+='<span class="text-xs text-gray-400">'+d+'</span></div>';
                    h+='<p class="text-sm font-semibold text-gray-800">'+idee.titel+'</p>';
                    if(idee.beschreibung) h+='<p class="text-xs text-gray-600 mt-1">'+idee.beschreibung+'</p>';
                    h+='<p class="text-xs text-gray-400 mt-1">\ud83d\udca1 '+authorName+' \u00b7 \ud83d\udccd '+standortName+'</p>';
                    h+='</div>';
                });
                if(ideas.length===0) h='<div class="text-center py-4 text-gray-400">Noch keine Ideen eingereicht.</div>';
                el.innerHTML=h;
            } catch(err) { console.error('HQ Ideen:', err); }
        }
        function filterHqIdeen(filter) {
            document.querySelectorAll('.hq-ideen-filter').forEach(function(b){b.className='hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.hq-ideen-filter[data-hif="'+filter+'"]');
            if(btn) btn.className='hq-ideen-filter px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white';
            renderHqIdeen(filter);
        }
        async function updateIdeeStatus(ideeId, newStatus) {
            try {
                var resp = await sb.from('ideen').update({status: newStatus}).eq('id', ideeId).select();
                if(resp.error) throw resp.error;
                if(!resp.data || resp.data.length === 0) {
                    alert('Status konnte nicht geÃ¤ndert werden â€“ keine Berechtigung.');
                    return;
                }
                renderHqIdeen('all');
            } catch(err) { alert('Fehler: '+err.message); }
        }


        // === HQ SHOP-VERWALTUNG ===
        var hqShopOrders = [
            {nr:'B-20260214-001',standort:'Grafrath',produkte:'3x Polo-Shirt, 2x Roll-Up',summe:309.70,datum:'14.02.2026',status:'in Bearbeitung'},
            {nr:'B-20260213-004',standort:'Hamburg',produkte:'100x Visitenkarten, 50x Flyer',summe:138.90,datum:'13.02.2026',status:'versendet'},
            {nr:'B-20260213-002',standort:'Weilheim',produkte:'5x Trinkflasche, 20x Sattelbezug',summe:122.50,datum:'13.02.2026',status:'versendet'},
            {nr:'B-20260212-001',standort:'Karlsdorf',produkte:'1x Kundenstopper, 2x Fensterfolie',summe:239.00,datum:'12.02.2026',status:'geliefert'},
            {nr:'B-20260211-003',standort:'Hamburg',produkte:'10x Softshell-Jacke',summe:799.00,datum:'11.02.2026',status:'geliefert'}
        ];
        function renderHqShop(){
            // Orders
            var oEl=document.getElementById('hqShopOrders');
            if(oEl){
                var h='';
                var statusC={'in Bearbeitung':'bg-yellow-100 text-yellow-700','versendet':'bg-blue-100 text-blue-700','geliefert':'bg-green-100 text-green-700'};
                hqShopOrders.forEach(function(o){
                    h+='<div class="p-3 bg-gray-50 rounded-lg"><div class="flex items-center justify-between mb-1"><div class="flex items-center space-x-2"><span class="text-xs font-mono text-gray-400">'+o.nr+'</span><span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusC[o.status]||'')+'">'+o.status+'</span></div><span class="text-sm font-bold text-gray-800">â‚¬ '+o.summe.toFixed(2)+'</span></div><p class="text-xs text-gray-600">'+o.produkte+'</p><p class="text-xs text-gray-400">ðŸ“ '+o.standort+' Â· '+o.datum+'</p></div>';
                });
                oEl.innerHTML=h;
            }
            // Products from shop data
            var pEl=document.getElementById('hqShopProducts');
            if(pEl && typeof shopProducts!=='undefined'){
                var h='';
                shopProducts.forEach(function(p){
                    h+='<div class="flex items-center justify-between p-2 bg-gray-50 rounded"><div class="flex items-center space-x-2"><span>'+p.icon+'</span><span class="text-sm font-semibold">'+p.name+'</span><span class="text-xs text-gray-400">('+p.kat+')</span></div><span class="text-sm font-bold text-gray-800">'+(p.preis>0?'â‚¬ '+p.preis.toFixed(2):'Kostenlos')+'</span></div>';
                });
                pEl.innerHTML=h;
            }
        }
        function addHqShopProduct(){
            var n=document.getElementById('hqShopName');
            var p=document.getElementById('hqShopPreis');
            if(!n||!n.value.trim()){alert('Bitte Produktname eingeben');return;}
            if(typeof shopProducts!=='undefined'){
                shopProducts.push({id:'prod_new_'+Date.now(),name:n.value.trim(),kat:document.getElementById('hqShopKat').value,preis:parseFloat(p.value)||0,icon:'ðŸ†•',beschreibung:document.getElementById('hqShopDesc').value||''});
            }
            n.value='';p.value='';document.getElementById('hqShopDesc').value='';
            renderHqShop();
        }
        var kzStandorte = []; // loaded from Supabase

        var kzMitarbeiter = []; // loaded from Supabase

        var currentKzStdFilter = 'all';
        var currentKzMaFilter = 'all';

        function showKommandoTab(tab) {
            document.querySelectorAll('.kommando-tab-content').forEach(function(el){el.style.display='none';});
            document.querySelectorAll('.kommando-tab-btn').forEach(function(b){
                b.className='kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });
            var tabEl=document.getElementById('kommandoTab'+tab.charAt(0).toUpperCase()+tab.slice(1));
            if(tabEl)tabEl.style.display='block';
            var btn=document.querySelector('.kommando-tab-btn[data-ktab="'+tab+'"]');
            if(btn)btn.className='kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange';
            if(tab==='standorte') renderKzStandorte();
            if(tab==='mitarbeiter') renderKzMitarbeiter();
            if(tab==='kommunikation') renderHqKomm();
            if(tab==='kampagnen') renderHqKampagnen();
            if(tab==='dokumente') loadNetzwerkDokumente();
            if(tab==='kalender') loadHqKalTermine();
            if(tab==='aufgaben') renderHqAufgaben();
        }

        function filterKzStandorte(f) {
            currentKzStdFilter=f;
            document.querySelectorAll('.kz-std-filter').forEach(function(b){b.className='kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.kz-std-filter[data-kzf="'+f+'"]');
            if(btn)btn.className='kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderKzStandorte();
        }
        function filterKzMa(f) {
            currentKzMaFilter=f;
            document.querySelectorAll('.kz-ma-filter').forEach(function(b){b.className='kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.kz-ma-filter[data-kzmf="'+f+'"]');
            if(btn)btn.className='kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderKzMitarbeiter();
        }

        function statusBadge(s) {
            if(s==='aktiv') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-green-100 text-green-700">ðŸŸ¢ Aktiv</span>';
            if(s==='demo') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700 animate-pulse">ðŸ”´ Demo</span>';
            if(s==='onboarding') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700">ðŸ”µ Onboarding</span>';
            if(s==='pending') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-yellow-100 text-yellow-700">â³ Wartet</span>';
            if(s==='gesperrt') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">ðŸš« Gesperrt</span>';
            if(s==='offboarding') return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">ðŸ”´ Offboarding</span>';
            return s;
        }
        function rolleBadge(r) {
            var colors = {'inhaber':'bg-vit-orange text-white','verkauf':'bg-blue-100 text-blue-700','werkstatt':'bg-gray-200 text-gray-700','buchhaltung':'bg-purple-100 text-purple-700','hq':'bg-red-100 text-red-700'};
            var labels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung','hq':'HQ'};
            return '<span class="px-2 py-1 rounded-full text-[10px] font-semibold '+(colors[r]||'bg-gray-100 text-gray-600')+'">'+(labels[r]||r)+'</span>';
        }
        function rollenBadges(rollen) {
            return rollen.map(function(r){ return rolleBadge(r); }).join(' ');
        }

        async function renderKzStandorte() {
            var body=document.getElementById('kzStandorteBody');
            if(!body)return;
            try {
                var resp = await sb.from('standorte').select('*').order('name');
                if(resp.error) throw resp.error;
                var standorte = resp.data || [];
                var countResp = await sb.from('users').select('standort_id');
                var userCounts = {};
                (countResp.data||[]).forEach(function(u){ if(u.standort_id) userCounts[u.standort_id] = (userCounts[u.standort_id]||0)+1; });
                var filter = currentKzStdFilter || 'all';
                var h='';
                standorte.forEach(function(s){
                    var st = s.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return;
                    var d = s.created_at ? new Date(s.created_at) : new Date();
                    var beitritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50">';
                    h+='<td class="px-4 py-3 font-semibold text-gray-800">'+s.name+'</td>';
                    h+='<td class="px-4 py-3 text-gray-600">'+(s.adresse||s.region||'')+'</td>';
                    h+='<td class="px-4 py-3"><span class="text-xs px-2 py-0.5 rounded '+(s.is_premium?'bg-vit-orange text-white':'bg-gray-100 text-gray-600')+'">'+(s.is_premium?'Premium':'Standard')+'</span></td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center font-semibold">'+(userCounts[s.id]||0)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+beitritt+'</td>';
                    h+='<td class="px-4 py-3 text-center text-xs text-gray-500">'+(s.telefon||'â€”')+'</td>';
                    h+='<td class="px-4 py-3 text-center"><button class="text-xs text-vit-orange hover:underline font-semibold" onclick="alert(\''+s.name+'\\nAdresse: '+(s.adresse||'â€“')+'\\nTelefon: '+(s.telefon||'â€“')+'\\nSlug: '+s.slug+'\')">Details â†’</button></td>';
                    h+='</tr>';
                });
                if(standorte.length===0) h='<tr><td colspan="8" class="text-center py-8 text-gray-400">Keine Standorte.</td></tr>';
                body.innerHTML=h;
                var ge=document.getElementById('kzStandorteGesamt');if(ge)ge.textContent=standorte.length;
                var ak=document.getElementById('kzStandorteAktiv');if(ak)ak.textContent=standorte.filter(function(s){return (s.status||'aktiv')==='aktiv';}).length;
                var ob=document.getElementById('kzStandorteOnb');if(ob)ob.textContent=standorte.filter(function(s){return s.status==='onboarding';}).length;
                var of2=document.getElementById('kzStandorteOff');if(of2)of2.textContent=standorte.filter(function(s){return s.status==='offboarding';}).length;
            } catch(err) { console.error('Standorte:', err); body.innerHTML='<tr><td colspan="8" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        async function renderKzMitarbeiter() {
            var body=document.getElementById('kzMaBody');
            if(!body)return;
            try {
                var resp = await sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').order('name');
                if(resp.error) throw resp.error;
                var users = resp.data || [];
                var stdFilter=(document.getElementById('kzMaStandortFilter')||{}).value||'all';
                var filter = currentKzMaFilter || 'all';
                var list = users.filter(function(u){
                    var st = u.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return false;
                    var stdName = u.standorte ? u.standorte.name : 'HQ';
                    if(stdFilter!=='all' && stdName!==stdFilter) return false;
                    return true;
                });
                var h='';
                list.forEach(function(u){
                    var stdName = u.standorte ? u.standorte.name : 'HQ';
                    var rollen = (u.user_rollen||[]).map(function(ur){ return ur.rollen ? ur.rollen.name : ''; }).filter(Boolean);
                    var st = u.status || 'aktiv';
                    var d = u.created_at ? new Date(u.created_at) : new Date();
                    var eintritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    // Action button: Freigeben for onboarding/pending, Details for others
                    var actionBtn = '';
                    if((st === 'onboarding' || st === 'pending') && rollen.length === 0) {
                        actionBtn = '<button class="text-xs px-3 py-1 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600" onclick="approveUser(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">Freigeben</button>';
                    } else {
                        actionBtn = '<button class="text-xs text-vit-orange hover:underline font-semibold" onclick="openEditMaModal(\''+u.id+'\')">âœï¸</button>'
                    +' <button class="text-xs text-blue-500 hover:text-blue-700 hover:underline font-semibold ml-1" onclick="loginAs(\''+u.id+'\',\''+u.email+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ”‘</button>'
                    +' <button class="text-xs text-red-400 hover:text-red-600 hover:underline font-semibold ml-1" onclick="deleteMa(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ—‘ï¸</button>';
                    }
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50'+((st==='onboarding' || st==='pending') && rollen.length===0 ? ' bg-yellow-50':'')+'">';
                    h+='<td class="px-4 py-3"><div class="flex items-center space-x-2"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)+'&background=EF7D00&color=fff&size=28" class="w-7 h-7 rounded-full"><div><span class="font-semibold text-gray-800">'+u.name+'</span><p class="text-[10px] text-gray-400">'+u.email+'</p></div></div></td>';
                    h+='<td class="px-4 py-3 text-gray-600 text-xs">'+stdName+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+(rollen.length > 0 ? rollenBadges(rollen) : '<span class="text-xs text-yellow-600 font-semibold">Wartet auf Freigabe</span>')+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+eintritt+'</td>';
                    h+='<td class="px-4 py-3 text-center"><span class="text-xs text-gray-400">'+(u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.label:'';}).filter(Boolean).join(', ')+'</span></td>';
                    h+='<td class="px-4 py-3 text-center">'+actionBtn+'</td>';
                    h+='</tr>';
                });
                if(list.length===0) h='<tr><td colspan="7" class="text-center py-8 text-gray-400">Keine Mitarbeiter gefunden.</td></tr>';
                body.innerHTML=h;
                var ge=document.getElementById('kzMaGesamt');if(ge)ge.textContent=users.length;
                var ak=document.getElementById('kzMaAktiv');if(ak)ak.textContent=users.filter(function(u){return (u.status||'aktiv')==='aktiv';}).length;
                var onbCount = users.filter(function(u){return u.status==='onboarding';}).length;
                var ob=document.getElementById('kzMaOnb');if(ob)ob.textContent=onbCount;
                var of2=document.getElementById('kzMaOff');if(of2)of2.textContent=users.filter(function(u){return u.status==='offboarding';}).length;
                var ro=document.getElementById('kzRollen');if(ro)ro.textContent='4';
                // Standort dropdown
                var sel=document.getElementById('kzMaStandortFilter');
                if(sel && sel.options.length<=1){
                    var standorte=[];
                    users.forEach(function(u){ var sn=u.standorte?u.standorte.name:'HQ'; if(standorte.indexOf(sn)===-1)standorte.push(sn); });
                    standorte.sort().forEach(function(s){sel.innerHTML+='<option value="'+s+'">'+s+'</option>';});
                }
            } catch(err) { console.error('Mitarbeiter:', err); body.innerHTML='<tr><td colspan="7" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        // === USER FREIGABE (mit Ebene-Logik) ===
        var approveEbene = 'standort';
        
        async function approveUser(userId, userName) {
            approveEbene = 'standort';
            
            // User-Daten laden fÃ¼r Standort-Info
            var userResp = await sb.from('users').select('*, standorte(name)').eq('id', userId).single();
            var userData = userResp.data || {};
            var currentStandortId = userData.standort_id || '';
            var currentStandortName = userData.standorte ? userData.standorte.name : '';
            
            var html = '<div id="approveOverlay" onclick="closeApproveModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">User freigeben</h3><button onclick="closeApproveModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<p class="text-sm text-gray-600 mb-4"><strong>'+userName+'</strong> hat sich registriert und wartet auf Freigabe.'+(currentStandortName ? ' <span class="text-xs text-gray-400">(GewÃ¼nschter Standort: '+currentStandortName+')</span>' : '')+'</p>';
            
            // === EBENE (HQ vs Standort) ===
            html += '<div class="space-y-3 mb-4">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
            html += '<div class="flex space-x-2">';
            html += '<button type="button" id="approveEbeneHQ" onclick="switchApproveEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300">\ud83c\udfe2 HQ</button>';
            html += '<button type="button" id="approveEbeneStd" onclick="switchApproveEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700">\ud83c\udfea Standort</button>';
            html += '</div></div>';
            
            // Standort Dropdown
            html += '<div id="approveStandortWrap"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="approveStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';
            html += '</div>';
            
            // === ROLLEN (dynamisch basierend auf Ebene) ===
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen zuweisen</p>';
            
            // HQ Rollen (initial hidden)
            html += '<div id="approveRollesHQ" style="display:none">';
            html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
            html += '<input type="checkbox" id="approveRole_hq" class="rounded" style="accent-color:#EF7D00;" checked>';
            html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
            html += '</div>';
            
            // Standort Rollen (initial visible)
            html += '<div id="approveRollesStd">';
            var stdRollen = ['inhaber','verkauf','werkstatt','buchhaltung'];
            var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
            stdRollen.forEach(function(r){
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="approveRole_'+r+'" class="rounded" style="accent-color:#EF7D00;">';
                html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
            });
            html += '</div>';
            
            html += '<div id="approveError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
            html += '<div class="flex space-x-3 mt-4">';
            html += '<button id="approveSaveBtn" onclick="confirmApprove(\''+userId+'\')" class="flex-1 py-2.5 bg-green-500 text-white rounded-lg font-semibold text-sm hover:bg-green-600">\u2705 Freigeben</button>';
            html += '<button onclick="rejectUser(\''+userId+'\')" class="py-2.5 px-4 bg-red-100 text-red-600 rounded-lg font-semibold text-sm hover:bg-red-200">\u274c Ablehnen</button>';
            html += '<button onclick="closeApproveModal()" class="py-2.5 px-4 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button>';
            html += '</div>';
            html += '</div></div>';
            
            var c = document.createElement('div');
            c.id = 'approveContainer';
            c.innerHTML = html;
            document.body.appendChild(c);
            
            // Standorte laden
            setTimeout(async function(){
                try {
                    var stdResp = await sb.from('standorte').select('id,name').order('name');
                    var sel = document.getElementById('approveStandort');
                    if(sel && stdResp.data) {
                        sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                        stdResp.data.forEach(function(s){
                            var selected = (currentStandortId === s.id) ? ' selected' : '';
                            sel.innerHTML += '<option value="'+s.id+'"'+selected+'>'+s.name+'</option>';
                        });
                    }
                } catch(e){ console.error(e); }
            }, 100);
        }
        
        function switchApproveEbene(ebene) {
            approveEbene = ebene;
            var hqBtn = document.getElementById('approveEbeneHQ');
            var stdBtn = document.getElementById('approveEbeneStd');
            var stdWrap = document.getElementById('approveStandortWrap');
            var rollesHQ = document.getElementById('approveRollesHQ');
            var rollesStd = document.getElementById('approveRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk) hqChk.checked = true;
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('approveRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeApproveModal() {
            var c = document.getElementById('approveContainer');
            if(c) c.remove();
        }

        async function confirmApprove(userId) {
            var errEl = document.getElementById('approveError');
            if(errEl) errEl.style.display = 'none';
            
            // Rollen basierend auf Ebene sammeln
            var selected = [];
            var isHqUser = (approveEbene === 'hq');
            if(isHqUser) {
                var hqChk = document.getElementById('approveRole_hq');
                if(hqChk && hqChk.checked) selected.push('hq');
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('approveRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
            }
            if(selected.length === 0) { 
                if(errEl) { errEl.textContent = 'Bitte mindestens eine Rolle zuweisen.'; errEl.style.display = 'block'; }
                return; 
            }
            
            // Standort-Pflicht fÃ¼r Standort-User
            var standortId = null;
            if(!isHqUser) {
                var stdSel = document.getElementById('approveStandort');
                standortId = stdSel ? stdSel.value : null;
                if(!standortId) {
                    if(errEl) { errEl.textContent = 'Bitte einen Standort wÃ¤hlen.'; errEl.style.display = 'block'; }
                    return;
                }
            }
            
            var btn = document.getElementById('approveSaveBtn');
            if(btn) { btn.disabled = true; btn.textContent = 'Wird freigeschaltet...'; }
            
            try {
                // 1. Status auf aktiv + is_hq + Standort setzen
                var updateData = { 
                    status: 'aktiv', 
                    is_hq: isHqUser,
                    standort_id: isHqUser ? null : standortId
                };
                var upd = await sb.from('users').update(updateData).eq('id', userId);
                if(upd.error) throw upd.error;
                
                // 2. Rollen-IDs holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                
                // 3. Bestehende Rollen lÃ¶schen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                
                // 4. Neue Rollen zuweisen
                var rollenInserts = selected.map(function(roleName){
                    return { user_id: userId, rolle_id: rollenMap[roleName] };
                }).filter(function(ri){ return ri.rolle_id; });
                
                if(rollenInserts.length > 0) {
                    var insResp = await sb.from('user_rollen').insert(rollenInserts);
                    if(insResp.error) throw insResp.error;
                }
                
                closeApproveModal();
                var rollenLabels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                alert('\u2705 User freigeschaltet!\nRollen: ' + selected.map(function(r){return rollenLabels[r]||r;}).join(', ') + '\n\nDer Mitarbeiter kann sich jetzt einloggen.');
                renderKzMitarbeiter();
            } catch(err) {
                if(errEl) { errEl.textContent = 'Fehler: ' + err.message; errEl.style.display = 'block'; }
                if(btn) { btn.disabled = false; btn.textContent = '\u2705 Freigeben'; }
            }
        }

        async function rejectUser(userId) {
            if(!confirm('User wirklich ablehnen? Der Account wird gesperrt.')) return;
            try {
                await sb.from('users').update({status: 'gesperrt'}).eq('id', userId);
                closeApproveModal();
                alert('User abgelehnt und gesperrt.');
                renderKzMitarbeiter();
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        // === ROLLEN-MODAL ===
        function openRollenModal(maIdx) {
            var m = kzMitarbeiter[maIdx];
            if(!m) return;
            var allRollen = ['hq','inhaber','verkauf','werkstatt','buchhaltung'];
            var labels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var desc = {'inhaber':'Vollzugriff auf alle Module, Dashboards, Shop, Onboarding','verkauf':'Verkauf, Marketing, Wissen, Support, Ideenboard','werkstatt':'Einkauf, Wissen, Support, Ideenboard','buchhaltung':'Allgemein, Verkauf, Einkauf, Controlling, Aktenschrank'};

            var html = '<div id="rollenModalOverlay" onclick="closeRollenModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:420px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Rollen bearbeiten</h3><button onclick="closeRollenModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>';
            html += '<div class="flex items-center space-x-3 mb-5 pb-4 border-b"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(m.name)+'&background=EF7D00&color=fff&size=40" class="w-10 h-10 rounded-full"><div><p class="font-semibold text-gray-800">'+m.name+'</p><p class="text-xs text-gray-500">'+m.standort+' Â· '+m.email+'</p></div></div>';
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Rollen zuweisen (Mehrfachauswahl)</p>';
            allRollen.forEach(function(r){
                var checked = m.rollen.indexOf(r)>=0 ? 'checked' : '';
                var colors = {'hq':'border-red-300 bg-red-50','inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
                html += '<label class="flex items-start space-x-3 p-3 rounded-lg border '+colors[r]+' mb-2 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="roleChk_'+r+'" '+checked+' class="mt-1 rounded" style="accent-color:#EF7D00;">';
                html += '<div><p class="font-semibold text-sm text-gray-800">'+labels[r]+'</p><p class="text-[11px] text-gray-500">'+desc[r]+'</p></div>';
                html += '</label>';
            });
            html += '<div class="flex space-x-3 mt-5"><button onclick="saveRollen('+maIdx+')" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
            html += '<button onclick="closeRollenModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';

            var container = document.createElement('div');
            container.id = 'rollenModalContainer';
            container.innerHTML = html;
            document.body.appendChild(container);
        }
        function closeRollenModal() {
            var c = document.getElementById('rollenModalContainer');
            if(c) c.remove();
        }
        function saveRollen(maIdx) {
            var allRollen = ['hq','inhaber','verkauf','werkstatt','buchhaltung'];
            var selected = [];
            allRollen.forEach(function(r){
                var chk = document.getElementById('roleChk_'+r);
                if(chk && chk.checked) selected.push(r);
            });
            if(selected.length===0) { alert('Mindestens eine Rolle muss zugewiesen werden.'); return; }
            kzMitarbeiter[maIdx].rollen = selected;
            closeRollenModal();
            renderKzMitarbeiter();

            var labels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var names = selected.map(function(r){return labels[r];}).join(', ');
            alert('âœ… Rollen fÃ¼r '+kzMitarbeiter[maIdx].name+' gespeichert:\n'+names);
        }

        // === PARTNER MITARBEITER-VERWALTUNG (GF-Ebene) ===
        var currentPartnerMaFilter = 'all';

        function getStandortName() {
            if(currentLocation && locations[currentLocation]) return locations[currentLocation].name;
            return 'Grafrath';
        }

        function getPartnerMitarbeiter() {
            var sName = getStandortName();
            return kzMitarbeiter.filter(function(m){ return m.standort === sName; });
        }

        function filterPartnerMa(f) {
            currentPartnerMaFilter = f;
            document.querySelectorAll('.p-ma-filter').forEach(function(b){
                b.className='p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';
            });
            var btn=document.querySelector('.p-ma-filter[data-pmf="'+f+'"]');
            if(btn) btn.className='p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderPartnerMitarbeiter();
        }

        async function renderPartnerMitarbeiter() {
            var body=document.getElementById('partnerMaBody');
            if(!body) return;
            try {
                // Nur Mitarbeiter des eigenen Standorts laden
                var query = sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').order('name');
                if(sbStandort && sbStandort.id) {
                    query = query.eq('standort_id', sbStandort.id);
                }
                var resp = await query;
                if(resp.error) throw resp.error;
                var users = resp.data || [];
                var filter = currentPartnerMaFilter || 'all';
                var list = users.filter(function(u){
                    var st = u.status || 'aktiv';
                    if(filter!=='all' && st!==filter) return false;
                    return true;
                });
                // KPIs
                var ge=document.getElementById('pMaGesamt');if(ge)ge.textContent=users.length;
                var ak=document.getElementById('pMaAktiv');if(ak)ak.textContent=users.filter(function(u){return (u.status||'aktiv')==='aktiv';}).length;
                var ob=document.getElementById('pMaOnb');if(ob)ob.textContent=users.filter(function(u){return u.status==='onboarding';}).length;
                var h='';
                list.forEach(function(u){
                    var rollen = (u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.name:'';}).filter(Boolean);
                    var st = u.status || 'aktiv';
                    var d = u.created_at ? new Date(u.created_at) : new Date();
                    var eintritt = String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
                    h+='<tr class="border-t border-gray-100 hover:bg-gray-50">';
                    h+='<td class="px-4 py-3"><div class="flex items-center space-x-2"><img src="https://ui-avatars.com/api/?name='+encodeURIComponent(u.name)+'&background=EF7D00&color=fff&size=28" class="w-7 h-7 rounded-full"><span class="font-semibold text-gray-800">'+u.name+'</span></div></td>';
                    h+='<td class="px-4 py-3 text-gray-500 text-xs">'+u.email+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+rollenBadges(rollen)+'</td>';
                    h+='<td class="px-4 py-3 text-center">'+statusBadge(st)+'</td>';
                    h+='<td class="px-4 py-3 text-center text-gray-500 text-xs">'+eintritt+'</td>';
                    h+='<td class="px-4 py-3 text-center"><div class="flex justify-center space-x-2">';
                    h+='<button class="text-xs text-vit-orange hover:underline font-semibold" onclick="openEditMaModal(\''+u.id+'\')">âœï¸</button>';
                    h+='<button class="text-xs text-red-400 hover:underline font-semibold" onclick="deleteMa(\''+u.id+'\',\''+u.name.replace(/'/g,"\\'")+'\')">ðŸ—‘ï¸</button>';
                    h+='</div></td>';
                    h+='</tr>';
                });
                if(list.length===0) h='<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">Keine Mitarbeiter gefunden.</td></tr>';
                body.innerHTML=h;
            } catch(err) { console.error('Partner-MA:', err); body.innerHTML='<tr><td colspan="6" class="text-center py-4 text-red-400">Fehler: '+err.message+'</td></tr>'; }
        }

        function deactivateMa(idx) {
            // Deprecated - use openEditMaModal instead
        }

        // Neuer Mitarbeiter Modal
        var newMaEbene = 'standort'; // tracks current ebene selection in create modal
        
        function openNeuerMaModal() {
            var isHQ = currentRoles.indexOf('hq') >= 0 || (sbProfile && sbProfile.is_hq);
            newMaEbene = 'standort';

            var html = '<div id="neuerMaOverlay" onclick="closeNeuerMaModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Neuen Mitarbeiter anlegen</h3><button onclick="closeNeuerMaModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            
            // Name fields
            html += '<div class="space-y-3 mb-4">';
            html += '<div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-semibold text-gray-600 mb-1">Vorname *</label><input id="newMaVorname" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Max" oninput="updateNewMaEmail()"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Nachname *</label><input id="newMaNachname" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Mustermann" oninput="updateNewMaEmail()"></div></div>';

            // E-Mail Typ Auswahl
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail-Typ</label>';
            html += '<div class="flex space-x-2 mb-2">';
            html += '<button type="button" id="newMaEmailTypeVit" onclick="switchNewMaEmailType(\'vitbikes\')" class="flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700">ðŸ¢ vit:bikes E-Mail</button>';
            html += '<button type="button" id="newMaEmailTypeOwn" onclick="switchNewMaEmailType(\'eigen\')" class="flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300">ðŸ“§ Eigene E-Mail</button>';
            html += '</div>';
            html += '<input id="newMaEmail" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="vorname.nachname@vitbikes.de"></div>';
            html += '<input type="hidden" id="newMaEmailType" value="vitbikes">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Passwort * (min. 8 Zeichen)</label><input id="newMaPassword" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="VitBikes2026!"></div>';

            // === EBENE (HQ vs Standort) â€“ nur fÃ¼r HQ-Admins sichtbar ===
            if(isHQ) {
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
                html += '<div class="flex space-x-2">';
                html += '<button type="button" id="newMaEbeneHQ" onclick="switchNewMaEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300">\ud83c\udfe2 HQ</button>';
                html += '<button type="button" id="newMaEbeneStd" onclick="switchNewMaEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700">\ud83c\udfea Standort</button>';
                html += '</div></div>';
            }

            // Standort Dropdown (visible when Ebene = Standort)
            if(isHQ) {
                html += '<div id="newMaStandortWrap"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort *</label><select id="newMaStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';
            } else {
                // GF: Standort ist fix der eigene
                var stdName = sbStandort ? sbStandort.name : 'Dein Standort';
                var stdId = sbStandort ? sbStandort.id : '';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Standort</label><input type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-50 text-gray-500" value="'+stdName+'" disabled><input type="hidden" id="newMaStandort" value="'+stdId+'"></div>';
            }
            html += '</div>';

            // === ROLLEN (dynamisch basierend auf Ebene) ===
            html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen zuweisen</p>';

            // HQ Rollen (initial hidden)
            html += '<div id="newMaRollesHQ" style="display:none">';
            html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
            html += '<input type="checkbox" id="newMaRole_hq" class="rounded" style="accent-color:#EF7D00;" checked>';
            html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
            html += '<p class="text-[10px] text-gray-400 ml-1 mb-2">Weitere HQ-Rollen kommen bald (z.B. HQ Marketing, HQ Finanzen)</p>';
            html += '</div>';

            // Standort Rollen (initial visible)
            html += '<div id="newMaRollesStd">';
            var stdRollen = isHQ ? ['inhaber','verkauf','werkstatt','buchhaltung'] : ['verkauf','werkstatt','buchhaltung'];
            var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
            var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
            stdRollen.forEach(function(r){
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="newMaRole_'+r+'" class="rounded" style="accent-color:#EF7D00;">';
                html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
            });
            html += '</div>';

            if(!isHQ) { html += '<p class="text-xs text-blue-600 bg-blue-50 rounded-lg p-2 mt-2">\ud83d\udccd Mitarbeiter wird deinem Standort zugeordnet.</p>'; }
            html += '<div id="newMaError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
            html += '<div class="flex space-x-3 mt-4"><button id="newMaSaveBtn" onclick="saveNeuerMa()" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Anlegen</button>';
            html += '<button onclick="closeNeuerMaModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';
            var c = document.createElement('div'); c.id = 'neuerMaContainer'; c.innerHTML = html; document.body.appendChild(c);
            if(isHQ) {
                setTimeout(async function(){
                    try {
                        var stdResp = await sb.from('standorte').select('id,name').order('name');
                        var sel = document.getElementById('newMaStandort');
                        if(sel && stdResp.data) {
                            sel.innerHTML = '<option value="">â€” Standort wÃ¤hlen â€”</option>';
                            stdResp.data.forEach(function(s){ sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>'; });
                        }
                    } catch(e){ console.error(e); }
                }, 100);
            }
        }

        function switchNewMaEbene(ebene) {
            newMaEbene = ebene;
            var hqBtn = document.getElementById('newMaEbeneHQ');
            var stdBtn = document.getElementById('newMaEbeneStd');
            var stdWrap = document.getElementById('newMaStandortWrap');
            var rollesHQ = document.getElementById('newMaRollesHQ');
            var rollesStd = document.getElementById('newMaRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                // Auto-check HQ role
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk) hqChk.checked = true;
                // Uncheck standort roles
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('newMaRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                // Uncheck HQ role
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeNeuerMaModal() { var c = document.getElementById('neuerMaContainer'); if(c) c.remove(); }

        var newMaEmailTypeValue = 'vitbikes';

        function switchNewMaEmailType(typ) {
            newMaEmailTypeValue = typ;
            var vitBtn = document.getElementById('newMaEmailTypeVit');
            var ownBtn = document.getElementById('newMaEmailTypeOwn');
            var emailInput = document.getElementById('newMaEmail');
            var typeHidden = document.getElementById('newMaEmailType');
            if(typeHidden) typeHidden.value = typ;

            if(typ === 'vitbikes') {
                if(vitBtn) vitBtn.className = 'flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(ownBtn) ownBtn.className = 'flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(emailInput) { emailInput.readOnly = true; emailInput.style.backgroundColor = '#F9FAFB'; emailInput.style.color = '#6B7280'; }
                updateNewMaEmail();
            } else {
                if(ownBtn) ownBtn.className = 'flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(vitBtn) vitBtn.className = 'flex-1 py-2 rounded-lg text-xs font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(emailInput) { emailInput.readOnly = false; emailInput.style.backgroundColor = '#fff'; emailInput.style.color = '#1a202c'; emailInput.value = ''; emailInput.placeholder = 'eigene@email.de'; emailInput.focus(); }
            }
        }

        function updateNewMaEmail() {
            if(newMaEmailTypeValue !== 'vitbikes') return;
            var vorname = (document.getElementById('newMaVorname') || {}).value || '';
            var nachname = (document.getElementById('newMaNachname') || {}).value || '';
            var emailInput = document.getElementById('newMaEmail');
            if(!emailInput) return;
            if(vorname.trim() && nachname.trim()) {
                // Umlaute und Sonderzeichen bereinigen
                var v = vorname.trim().toLowerCase().replace(/Ã¤/g,'ae').replace(/Ã¶/g,'oe').replace(/Ã¼/g,'ue').replace(/ÃŸ/g,'ss').replace(/[^a-z0-9.-]/g,'');
                var n = nachname.trim().toLowerCase().replace(/Ã¤/g,'ae').replace(/Ã¶/g,'oe').replace(/Ã¼/g,'ue').replace(/ÃŸ/g,'ss').replace(/[^a-z0-9.-]/g,'');
                emailInput.value = v + '.' + n + '@vitbikes.de';
            } else {
                emailInput.value = '';
                emailInput.placeholder = 'vorname.nachname@vitbikes.de';
            }
        }

        async function saveNeuerMa() {
            var vorname = (document.getElementById('newMaVorname')||{}).value||'';
            var nachname = (document.getElementById('newMaNachname')||{}).value||'';
            var email = (document.getElementById('newMaEmail')||{}).value||'';
            var pw = (document.getElementById('newMaPassword')||{}).value||'';
            var stdSel = document.getElementById('newMaStandort');
            var standortId = stdSel ? stdSel.value : null;
            var errEl = document.getElementById('newMaError');
            if(errEl) errEl.style.display = 'none';

            if(!vorname.trim() || !nachname.trim() || !email.trim()) { if(errEl){errEl.textContent='Bitte Vorname, Nachname und E-Mail ausfÃ¼llen.';errEl.style.display='block';} return; }
            if(!pw || pw.length < 8) { if(errEl){errEl.textContent='Passwort muss mindestens 8 Zeichen haben.';errEl.style.display='block';} return; }

            // Rollen basierend auf Ebene sammeln
            var selected = [];
            var isHqUser = (newMaEbene === 'hq');
            if(isHqUser) {
                var hqChk = document.getElementById('newMaRole_hq');
                if(hqChk && hqChk.checked) selected.push('hq');
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('newMaRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
                // Standort-Pflicht prÃ¼fen
                if(!standortId) { if(errEl){errEl.textContent='Bitte einen Standort wÃ¤hlen.';errEl.style.display='block';} return; }
            }
            if(selected.length===0) { if(errEl){errEl.textContent='Bitte mindestens eine Rolle zuweisen.';errEl.style.display='block';} return; }

            var btn = document.getElementById('newMaSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird angelegt...'; }

            var isHqUser = selected.indexOf('hq') >= 0;

            try {
                // Rollen-IDs aus der DB holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                var rollenIds = selected.map(function(r){ return rollenMap[r]; }).filter(Boolean);

                // Edge Function aufrufen statt create_full_user RPC
                var session = await sb.auth.getSession();
                if(!session.data.session) throw { message: 'Nicht eingeloggt' };

                var response = await fetch(sb.supabaseUrl + '/functions/v1/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + session.data.session.access_token,
                        'apikey': sb.supabaseKey
                    },
                    body: JSON.stringify({
                        email: email.trim().toLowerCase(),
                        password: pw,
                        vorname: vorname.trim(),
                        nachname: nachname.trim(),
                        is_hq: isHqUser,
                        standort_id: isHqUser ? null : (standortId || null),
                        rollen: rollenIds,
                        status: 'aktiv'
                    })
                });

                var result = await response.json();
                if(!response.ok) throw { message: result.error || 'User-Erstellung fehlgeschlagen' };

                closeNeuerMaModal();
                var rollenLabels = {'hq':'HQ','inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                alert('\u2705 Mitarbeiter angelegt!\n'+vorname.trim()+' '+nachname.trim()+'\nRollen: '+selected.map(function(r){return rollenLabels[r]||r;}).join(', ')+'\n\nDer Mitarbeiter kann sich sofort mit seinem Passwort anmelden.');
                renderKzMitarbeiter();
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+(err.message||err);errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Anlegen'; }
            }
        }

        // === MITARBEITER BEARBEITEN ===
        async function openEditMaModal(userId) {
            try {
                var resp = await sb.from('users').select('*, standorte(name), user_rollen(rollen(name,label))').eq('id', userId).single();
                if(resp.error) throw resp.error;
                var u = resp.data;
                var userRollen = (u.user_rollen||[]).map(function(ur){return ur.rollen?ur.rollen.name:'';}).filter(Boolean);
                var isUserHQ = u.is_hq || false;
                editMaEbene = isUserHQ ? 'hq' : 'standort';

                var html = '<div id="editMaOverlay" onclick="closeEditMaModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
                html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
                html += '<div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-gray-800">Mitarbeiter bearbeiten</h3><button onclick="closeEditMaModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
                html += '<div class="space-y-3 mb-4">';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Name</label><input id="editMaName" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="'+u.name+'"></div>';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">E-Mail</label><input id="editMaEmail" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" value="'+u.email+'"></div>';
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Neues Passwort (leer lassen = unverÃ¤ndert)</label><input id="editMaPassword" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="Neues Passwort eingeben..."></div>';

                // === EBENE (HQ vs Standort) ===
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Ebene</label>';
                html += '<div class="flex space-x-2">';
                html += '<button type="button" id="editMaEbeneHQ" onclick="switchEditEbene(\'hq\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition '+(isUserHQ?'border-red-500 bg-red-50 text-red-700':'border-gray-200 bg-white text-gray-500 hover:border-gray-300')+'">ðŸ¢ HQ</button>';
                html += '<button type="button" id="editMaEbeneStd" onclick="switchEditEbene(\'standort\')" class="flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition '+(!isUserHQ?'border-vit-orange bg-orange-50 text-orange-700':'border-gray-200 bg-white text-gray-500 hover:border-gray-300')+'">ðŸª Standort</button>';
                html += '</div></div>';

                // Standort (hidden for HQ)
                html += '<div id="editMaStandortWrap" style="'+(isUserHQ?'display:none':'')+'"><label class="block text-xs font-semibold text-gray-600 mb-1">Standort</label><select id="editMaStandort" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="">Wird geladen...</option></select></div>';

                // Status
                html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Status</label><select id="editMaStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">';
                html += '<option value="aktiv"'+(u.status==='aktiv'?' selected':'')+'>Aktiv</option>';
                html += '<option value="demo"'+(u.status==='demo'?' selected':'')+'>ðŸ”´ Demomodus</option>';
                html += '<option value="onboarding"'+(u.status==='onboarding'?' selected':'')+'>Onboarding</option>';
                html += '<option value="offboarding"'+(u.status==='offboarding'?' selected':'')+'>Offboarding</option>';
                html += '</select></div>';
                html += '</div>';

                // === ROLLEN (dynamic based on Ebene) ===
                html += '<p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Rollen</p>';

                // HQ Roles
                html += '<div id="editMaRollesHQ" style="'+(isUserHQ?'':'display:none')+'">';
                var hqChecked = userRollen.indexOf('hq') >= 0 ? ' checked' : '';
                html += '<label class="flex items-center space-x-3 p-2 rounded-lg border border-red-300 bg-red-50 mb-1.5 cursor-pointer hover:shadow-sm transition">';
                html += '<input type="checkbox" id="editMaRole_hq" class="rounded" style="accent-color:#EF7D00;"'+hqChecked+'>';
                html += '<span class="text-sm font-semibold text-gray-800">HQ</span></label>';
                html += '<p class="text-[10px] text-gray-400 ml-1 mb-2">Weitere HQ-Rollen kommen bald (z.B. HQ Marketing, HQ Finanzen)</p>';
                html += '</div>';

                // Standort Roles
                html += '<div id="editMaRollesStd" style="'+(!isUserHQ?'':'display:none')+'">';
                var stdRollen = ['inhaber','verkauf','werkstatt','buchhaltung'];
                var stdLabels = {'inhaber':'GeschÃ¤ftsleitung','verkauf':'Verkauf','werkstatt':'Werkstatt','buchhaltung':'Buchhaltung'};
                var stdColors = {'inhaber':'border-orange-300 bg-orange-50','verkauf':'border-blue-300 bg-blue-50','werkstatt':'border-gray-300 bg-gray-50','buchhaltung':'border-purple-300 bg-purple-50'};
                stdRollen.forEach(function(r){
                    var checked = userRollen.indexOf(r) >= 0 ? ' checked' : '';
                    html += '<label class="flex items-center space-x-3 p-2 rounded-lg border '+stdColors[r]+' mb-1.5 cursor-pointer hover:shadow-sm transition">';
                    html += '<input type="checkbox" id="editMaRole_'+r+'" class="rounded" style="accent-color:#EF7D00;"'+checked+'>';
                    html += '<span class="text-sm font-semibold text-gray-800">'+stdLabels[r]+'</span></label>';
                });
                html += '</div>';

                html += '<div id="editMaError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mt-3"></div>';
                html += '<div class="flex space-x-3 mt-4">';
                html += '<button id="editMaSaveBtn" onclick="saveEditMa(\''+userId+'\')" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>';
                html += '<button onclick="closeEditMaModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button>';
                html += '</div></div></div>';

                var c = document.createElement('div'); c.id = 'editMaContainer'; c.innerHTML = html; document.body.appendChild(c);

                // Load standorte dropdown
                setTimeout(async function(){
                    try {
                        var stdResp = await sb.from('standorte').select('id,name').order('name');
                        var sel = document.getElementById('editMaStandort');
                        if(sel && stdResp.data) {
                            sel.innerHTML = '<option value="hq">HQ (kein Standort)</option>';
                            stdResp.data.forEach(function(s){
                                var selected = (u.standort_id === s.id) ? ' selected' : '';
                                sel.innerHTML += '<option value="'+s.id+'"'+selected+'>'+s.name+'</option>';
                            });
                        }
                    } catch(e){}
                }, 100);
            } catch(err) { alert('Fehler: '+err.message); }
        }

        var editMaEbene = 'standort'; // tracks current ebene selection in edit modal
        function switchEditEbene(ebene) {
            editMaEbene = ebene;
            var hqBtn = document.getElementById('editMaEbeneHQ');
            var stdBtn = document.getElementById('editMaEbeneStd');
            var stdWrap = document.getElementById('editMaStandortWrap');
            var rollesHQ = document.getElementById('editMaRollesHQ');
            var rollesStd = document.getElementById('editMaRollesStd');
            if(ebene === 'hq') {
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-red-500 bg-red-50 text-red-700';
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = 'none';
                if(rollesHQ) rollesHQ.style.display = '';
                if(rollesStd) rollesStd.style.display = 'none';
                // Auto-check HQ role
                var hqChk = document.getElementById('editMaRole_hq');
                if(hqChk) hqChk.checked = true;
                // Uncheck standort roles
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('editMaRole_'+r);
                    if(chk) chk.checked = false;
                });
            } else {
                if(stdBtn) stdBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-vit-orange bg-orange-50 text-orange-700';
                if(hqBtn) hqBtn.className = 'flex-1 py-2.5 rounded-lg text-sm font-semibold border-2 transition border-gray-200 bg-white text-gray-500 hover:border-gray-300';
                if(stdWrap) stdWrap.style.display = '';
                if(rollesHQ) rollesHQ.style.display = 'none';
                if(rollesStd) rollesStd.style.display = '';
                // Uncheck HQ role
                var hqChk = document.getElementById('editMaRole_hq');
                if(hqChk) hqChk.checked = false;
            }
        }

        function closeEditMaModal() { var c = document.getElementById('editMaContainer'); if(c) c.remove(); }

        async function saveEditMa(userId) {
            var name = (document.getElementById('editMaName')||{}).value||'';
            var email = (document.getElementById('editMaEmail')||{}).value||'';
            var pw = (document.getElementById('editMaPassword')||{}).value||'';
            var standortId = (document.getElementById('editMaStandort')||{}).value||'';
            var status = (document.getElementById('editMaStatus')||{}).value||'aktiv';
            var isHQ = editMaEbene === 'hq';
            var errEl = document.getElementById('editMaError');
            if(errEl) errEl.style.display = 'none';

            if(!name.trim() || !email.trim()) { if(errEl){errEl.textContent='Name und E-Mail sind Pflicht.';errEl.style.display='block';} return; }
            if(!isHQ && (!standortId || standortId === 'hq')) { if(errEl){errEl.textContent='Bitte einen Standort zuweisen.';errEl.style.display='block';} return; }

            // Collect roles based on ebene
            var selected = [];
            if(isHQ) {
                selected = ['hq'];
            } else {
                ['inhaber','verkauf','werkstatt','buchhaltung'].forEach(function(r){
                    var chk = document.getElementById('editMaRole_'+r);
                    if(chk && chk.checked) selected.push(r);
                });
            }
            if(selected.length===0) { if(errEl){errEl.textContent='Mindestens eine Rolle nÃ¶tig.';errEl.style.display='block';} return; }

            var btn = document.getElementById('editMaSaveBtn');
            if(btn) { btn.disabled=true; btn.textContent='Wird gespeichert...'; }

            try {
                // 1. Users-Tabelle updaten
                var upd = await sb.from('users').update({
                    name: name.trim(),
                    email: email.trim().toLowerCase(),
                    standort_id: isHQ ? null : standortId,
                    is_hq: isHQ,
                    status: status
                }).eq('id', userId);
                if(upd.error) throw upd.error;

                // 2. Passwort Ã¤ndern (via set_user_password)
                if(pw && pw.length >= 6) {
                    var pwResp = await sb.rpc('set_user_password', { user_id: userId, new_password: pw });
                    if(pwResp && pwResp.error) console.warn('Passwort-Update:', pwResp.error.message);
                }

                // 3. Rollen: alte lÃ¶schen, neue setzen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                
                // Rollen-IDs holen
                var rollenResp = await sb.from('rollen').select('id, name');
                var rollenMap = {};
                if(rollenResp.data) rollenResp.data.forEach(function(r){ rollenMap[r.name] = r.id; });
                
                var rollenInserts = selected.map(function(roleName){
                    return { user_id: userId, rolle_id: rollenMap[roleName] };
                }).filter(function(ri){ return ri.rolle_id; });
                
                if(rollenInserts.length > 0) {
                    var insResp = await sb.from('user_rollen').insert(rollenInserts);
                    if(insResp.error) console.warn('Rollen-Zuweisung:', insResp.error.message);
                }

                closeEditMaModal();
                alert('\u2705 Mitarbeiter aktualisiert!');
                renderKzMitarbeiter();
                // If this user's status changed, re-check demo mode
                if(sbProfile && userId === sbProfile.id) {
                    sbProfile.status = status;
                } else if(status === 'demo' || (sbProfile && sbProfile.status === 'demo')) {
                    // If any user was set to/from demo while viewing as that user
                }
            } catch(err) {
                if(errEl){errEl.textContent='Fehler: '+(err.message||err);errEl.style.display='block';}
                if(btn) { btn.disabled=false; btn.textContent='Speichern'; }
            }
        }


        // === ALS USER ANMELDEN (ohne Passwort) ===
        async function loginAs(userId, email, userName) {
            if(!confirm('Als "'+userName+'" anmelden?\n\nDu wirst als dieser User eingeloggt um die Rechte zu testen.')) return;
            try {
                // 1. TemporÃ¤res Passwort setzen
                var tempPw = '_TempLogin_' + Date.now();
                await sb.rpc('set_user_password', { user_id: userId, new_password: tempPw });
                
                // 2. Ausloggen
                await sb.auth.signOut();
                
                // 3. Mit temporÃ¤rem Passwort einloggen
                var resp = await sb.auth.signInWithPassword({ email: email, password: tempPw });
                if(resp.error) throw resp.error;
                sbUser = resp.data.user;
                await loadUserProfile(sbUser.id);
                await loadModulStatus();
                enterApp();
                try { await loadPipelineFromSupabase(); } catch(e) {}
            } catch(err) {
                alert('Login fehlgeschlagen: '+(err.message||err)+'\n\nSeite wird neu geladen.');
                location.reload();
            }
        }

        // === MITARBEITER LÃ–SCHEN ===
        async function deleteMa(userId, userName) {
            if(!confirm('Mitarbeiter "'+userName+'" wirklich lÃ¶schen?\n\nDies lÃ¶scht den Account komplett (Auth + Profil + Rollen).')) return;
            try {
                // 1. Rollen lÃ¶schen
                await sb.from('user_rollen').delete().eq('user_id', userId);
                // 2. User-Profil lÃ¶schen
                await sb.from('users').delete().eq('id', userId);
                // 3. Auth-User lÃ¶schen (via DB-Funktion)
                await sb.rpc('delete_auth_user', { target_user_id: userId });
                alert('\u2705 '+userName+' wurde gelÃ¶scht.');
                renderKzMitarbeiter();
            } catch(err) {
                // Auch bei Fehler beim Auth-LÃ¶schen: Profil ist bereits weg
                if(err.message && err.message.includes('delete_auth_user')) {
                    alert('\u2705 '+userName+' Profil gelÃ¶scht.\n\u26a0\ufe0f Auth-User muss manuell im Supabase Dashboard entfernt werden.');
                    renderKzMitarbeiter();
                } else {
                    alert('Fehler: '+(err.message||err));
                }
            }
        }

        // === NEUER STANDORT MODAL ===
        function openNeuerStandortModal() {
            var html = '<div id="neuerStdOverlay" onclick="closeNeuerStdModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;">';
            html += '<div onclick="event.stopPropagation()" style="background:white;border-radius:16px;padding:24px;width:460px;max-width:90vw;box-shadow:0 25px 50px rgba(0,0,0,0.25);">';
            html += '<div class="flex items-center justify-between mb-5"><h3 class="text-lg font-bold text-gray-800">Neuen Standort anlegen</h3><button onclick="closeNeuerStdModal()" class="text-gray-400 hover:text-gray-600 text-xl">\u2715</button></div>';
            html += '<div class="space-y-3 mb-5">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Name *</label><input id="newStdName" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="z.B. vit:bikes MÃ¼nchen"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Slug * (URL-Key, nur Kleinbuchstaben)</label><input id="newStdSlug" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="z.B. muenchen"></div>';
            html += '<div class="grid grid-cols-2 gap-3">';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Region</label><select id="newStdRegion" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option>SÃ¼d</option><option>Nord</option><option>West</option><option>Ost</option><option>Mitte</option></select></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Status</label><select id="newStdStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="onboarding">Onboarding</option><option value="aktiv">Aktiv</option></select></div>';
            html += '</div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Adresse</label><input id="newStdAdresse" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="StraÃŸe, PLZ Ort"></div>';
            html += '<div><label class="block text-xs font-semibold text-gray-600 mb-1">Telefon</label><input id="newStdTelefon" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" placeholder="+49 ..."></div>';
            html += '<div><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="newStdPremium" style="accent-color:#EF7D00;"><span class="text-sm text-gray-700">Premium-Partner</span></label></div>';
            html += '</div>';
            html += '<div class="flex space-x-3"><button onclick="saveNeuerStandort()" class="flex-1 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Anlegen</button>';
            html += '<button onclick="closeNeuerStdModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-semibold text-sm hover:bg-gray-200">Abbrechen</button></div>';
            html += '</div></div>';
            var container = document.createElement('div');
            container.id = 'neuerStdContainer';
            container.innerHTML = html;
            document.body.appendChild(container);
            // Auto-generate slug from name
            var nameInput = document.getElementById('newStdName');
            if(nameInput) nameInput.addEventListener('input', function(){
                var slug = this.value.toLowerCase().replace(/vit:bikes\s*/i,'').replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
                var slugInput = document.getElementById('newStdSlug');
                if(slugInput) slugInput.value = slug;
            });
        }

        function closeNeuerStdModal() {
            var c = document.getElementById('neuerStdContainer');
            if(c) c.remove();
        }

        async function saveNeuerStandort() {
            var name = (document.getElementById('newStdName')||{}).value||'';
            var slug = (document.getElementById('newStdSlug')||{}).value||'';
            var region = (document.getElementById('newStdRegion')||{}).value||'SÃ¼d';
            var status = (document.getElementById('newStdStatus')||{}).value||'onboarding';
            var adresse = (document.getElementById('newStdAdresse')||{}).value||'';
            var telefon = (document.getElementById('newStdTelefon')||{}).value||'';
            var premium = (document.getElementById('newStdPremium')||{}).checked||false;

            if(!name.trim() || !slug.trim()) { alert('Bitte Name und Slug ausfÃ¼llen.'); return; }
            slug = slug.toLowerCase().replace(/[^a-z0-9-]/g,'');

            var btn = document.querySelector('#neuerStdContainer .bg-vit-orange');
            if(btn) { btn.disabled=true; btn.textContent='Wird angelegt...'; }

            try {
                var resp = await sb.from('standorte').insert({
                    name: name.trim(),
                    slug: slug,
                    region: region,
                    status: status,
                    is_premium: premium,
                    adresse: adresse.trim() || null,
                    telefon: telefon.trim() || null
                }).select().single();
                if(resp.error) throw resp.error;

                closeNeuerStdModal();
                alert('\u2705 Standort angelegt!\n'+name.trim()+'\nSlug: '+slug+'\nStatus: '+status);
                renderKzStandorte();
            } catch(err) {
                alert('Fehler: ' + err.message);
                if(btn) { btn.disabled=false; btn.textContent='Anlegen'; }
            }
        }

        // === HQ EINSTELLUNGEN - RECHTE-MATRIX ===
        function showSettingsTab(tab) {
            document.querySelectorAll('.settings-tab').forEach(function(b){
                b.className = 'settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            });
            var btn = document.querySelector('.settings-tab[data-tab="'+tab+'"]');
            if(btn) btn.className = 'settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange';
            document.querySelectorAll('.settings-tab-content').forEach(function(c){ c.style.display = 'none'; });
            var content = document.getElementById('settingsTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if(content) content.style.display = '';
        }

        // Tab/Widget-Konfiguration pro Modul
        var MODULE_TABS = {
            verkauf: [{key:'pipeline',label:'Pipeline'},{key:'woche',label:'Wochenansicht'},{key:'auswertung',label:'Auswertung'},{key:'training',label:'KI-Trainer'},{key:'vkWissen',label:'Wissen'}],
            marketing: [{key:'performance',label:'Performance'},{key:'budget',label:'Budget'},{key:'leads',label:'Leads'},{key:'social',label:'Social Media'},{key:'mktStrategie',label:'Strategie'},{key:'mktWissen',label:'Wissen'}],
            einkauf: [{key:'sortiment',label:'Sortiment'},{key:'lieferanten',label:'Lieferanten'},{key:'zentralreg',label:'Zentralreg.'},{key:'ekStrategie',label:'Strategie'},{key:'ekWissen',label:'Wissen'}],
            controlling: [{key:'cockpit',label:'Cockpit'},{key:'bwa',label:'BWA-Analyse'},{key:'benchmark',label:'Benchmark'},{key:'planist',label:'Plan/Ist'},{key:'liquiditaet',label:'LiquiditÃ¤t'},{key:'ctrlWissen',label:'Wissen'}],
            allgemein: [{key:'uebersicht',label:'Ãœbersicht'},{key:'jahresziele',label:'Jahresziele'},{key:'monatsplan',label:'Monatsplan'},{key:'journal',label:'Journal'},{key:'strategie',label:'Strategie'},{key:'wissen',label:'Wissen'}],
            support: [{key:'tickets',label:'Tickets'},{key:'kontakte',label:'Kontakte'}]
        };
        var MODULE_WIDGETS = {
            startseite: [{key:'pipeline',label:'Pipeline'},{key:'success',label:'Verkaufserfolg'},{key:'termine',label:'Termine'},{key:'aufgaben',label:'Aufgaben'},{key:'marketing',label:'Marketing'},{key:'team',label:'Team'},{key:'controlling',label:'Controlling'},{key:'support',label:'Support'},{key:'wissen',label:'Wissen'},{key:'nachrichten',label:'Nachrichten'}]
        };

        // Persistent expanded state
        var expandedModules = {};
        // Local config cache: {modul_key: {tabs: {tab_key: status}, widgets: {w_key: status}}}
        var sbModulConfig = {};

        async function renderModulStatusList() {
            var container = document.getElementById('modulStatusList');
            if(!container) return;
            try {
                var resp = await sb.from('modul_status').select('*').order('reihenfolge');
                if(resp.error) throw resp.error;
                var modules = resp.data || [];
                var html = '';
                var katLabels = {basis:'Basis',dashboards:'Dashboards',fachbereiche:'Fachbereiche',tools:'Tools'};
                var lastKat = '';
                var counts = {aktiv:0, demo:0, in_bearbeitung:0, deaktiviert:0};

                modules.forEach(function(m) {
                    counts[m.status] = (counts[m.status]||0) + 1;
                    // Parse config JSONB
                    var cfg = m.config || {};
                    sbModulConfig[m.modul_key] = cfg;

                    if(m.kategorie !== lastKat) {
                        lastKat = m.kategorie;
                        html += '<div class="px-5 py-2 bg-gray-50 text-xs font-bold text-gray-500 uppercase tracking-wider">' + (katLabels[m.kategorie]||m.kategorie) + '</div>';
                    }
                    var icons = {startseite:'ðŸ ',kalender:'ðŸ“…',aufgaben:'ðŸ“‹',kommunikation:'ðŸ’¬',dashboards:'ðŸ“Š',allgemein:'ðŸ¢',verkauf:'ðŸ“ˆ',einkauf:'ðŸ›’',marketing:'ðŸ“£',controlling:'ðŸ“Š',wissen:'ðŸ“š',support:'ðŸŽ«',ideenboard:'ðŸ’¡',shop:'ðŸ›ï¸',onboarding:'ðŸŽ¯',mitarbeiter:'ðŸ‘¥',aktenschrank:'ðŸ“'};
                    var hasTabs = MODULE_TABS[m.modul_key] && MODULE_TABS[m.modul_key].length > 0;
                    var hasWidgets = MODULE_WIDGETS[m.modul_key] && MODULE_WIDGETS[m.modul_key].length > 0;
                    var hasChildren = hasTabs || hasWidgets;
                    var isExpanded = expandedModules[m.modul_key] || false;

                    // Module row
                    html += '<div class="px-5 py-3 hover:bg-gray-50 transition">';
                    html += '<div class="flex items-center justify-between">';
                    html += '<div class="flex items-center space-x-3">';
                    if(hasChildren) {
                        html += '<button onclick="toggleModuleExpand(\'' + m.modul_key + '\')" class="text-gray-400 hover:text-gray-700 text-sm transition-transform ' + (isExpanded?'rotate-90':'') + '" style="width:20px">' + (isExpanded?'â–¼':'â–¶') + '</button>';
                    } else {
                        html += '<span style="width:20px"></span>';
                    }
                    html += '<span class="text-xl">' + (icons[m.modul_key]||'ðŸ“¦') + '</span>';
                    html += '<div><span class="font-semibold text-gray-800 text-sm">' + m.modul_name + '</span>';
                    html += '<span class="text-xs text-gray-400 ml-2">' + m.modul_key + '</span>';
                    if(hasTabs) html += '<span class="text-[10px] text-gray-400 ml-1">(' + MODULE_TABS[m.modul_key].length + ' Tabs)</span>';
                    if(hasWidgets) html += '<span class="text-[10px] text-gray-400 ml-1">(' + MODULE_WIDGETS[m.modul_key].length + ' Widgets)</span>';
                    html += '</div></div>';

                    // Status toggle buttons - now with 4 options
                    html += '<div class="flex items-center space-x-1 bg-gray-100 rounded-lg p-0.5">';
                    var btnBase = 'px-2.5 py-1.5 rounded-md text-[11px] font-semibold transition cursor-pointer';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'aktiv\')" class="' + btnBase + ' ' + (m.status==='aktiv' ? 'bg-green-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">âœ“ Aktiv</button>';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'demo\')" class="' + btnBase + ' ' + (m.status==='demo' ? 'bg-orange-400 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">ðŸ‘ Demo</button>';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'in_bearbeitung\')" class="' + btnBase + ' ' + (m.status==='in_bearbeitung' ? 'bg-yellow-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">ðŸ”§ Bald</button>';
                    html += '<button onclick="setModulStatus(\'' + m.id + '\',\'deaktiviert\')" class="' + btnBase + ' ' + (m.status==='deaktiviert' ? 'bg-gray-500 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200') + '">âœ• Aus</button>';
                    html += '</div></div>';

                    // Expandable children section
                    if(hasChildren && isExpanded) {
                        html += '<div class="ml-12 mt-3 mb-1 space-y-2">';
                        if(hasTabs) {
                            html += '<div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Tabs</div>';
                            MODULE_TABS[m.modul_key].forEach(function(tab) {
                                var tabStatus = (cfg.tabs && cfg.tabs[tab.key]) || 'aktiv';
                                html += '<div class="flex items-center justify-between py-1">';
                                html += '<span class="text-xs text-gray-700">â†³ ' + tab.label + '</span>';
                                html += '<div class="flex items-center space-x-0.5 bg-gray-100 rounded p-0.5">';
                                var tbtn = 'px-2 py-0.5 rounded text-[10px] font-semibold transition cursor-pointer';
                                html += '<button onclick="setTabStatus(\'' + m.modul_key + '\',\'' + tab.key + '\',\'aktiv\')" class="' + tbtn + ' ' + (tabStatus==='aktiv'?'bg-green-500 text-white':'text-gray-400 hover:bg-gray-200') + '">âœ“</button>';
                                html += '<button onclick="setTabStatus(\'' + m.modul_key + '\',\'' + tab.key + '\',\'demo\')" class="' + tbtn + ' ' + (tabStatus==='demo'?'bg-orange-400 text-white':'text-gray-400 hover:bg-gray-200') + '">ðŸ‘</button>';
                                html += '<button onclick="setTabStatus(\'' + m.modul_key + '\',\'' + tab.key + '\',\'deaktiviert\')" class="' + tbtn + ' ' + (tabStatus==='deaktiviert'?'bg-gray-500 text-white':'text-gray-400 hover:bg-gray-200') + '">âœ•</button>';
                                html += '</div></div>';
                            });
                        }
                        if(hasWidgets) {
                            html += '<div class="text-[10px] font-bold text-gray-400 uppercase mb-1 mt-2">Widgets</div>';
                            MODULE_WIDGETS[m.modul_key].forEach(function(w) {
                                var wStatus = (cfg.widgets && cfg.widgets[w.key]) || 'aktiv';
                                html += '<div class="flex items-center justify-between py-1">';
                                html += '<span class="text-xs text-gray-700">â†³ ' + w.label + '</span>';
                                html += '<div class="flex items-center space-x-0.5 bg-gray-100 rounded p-0.5">';
                                var wbtn = 'px-2 py-0.5 rounded text-[10px] font-semibold transition cursor-pointer';
                                html += '<button onclick="setWidgetStatus(\'' + m.modul_key + '\',\'' + w.key + '\',\'aktiv\')" class="' + wbtn + ' ' + (wStatus==='aktiv'?'bg-green-500 text-white':'text-gray-400 hover:bg-gray-200') + '">âœ“</button>';
                                html += '<button onclick="setWidgetStatus(\'' + m.modul_key + '\',\'' + w.key + '\',\'demo\')" class="' + wbtn + ' ' + (wStatus==='demo'?'bg-orange-400 text-white':'text-gray-400 hover:bg-gray-200') + '">ðŸ‘</button>';
                                html += '<button onclick="setWidgetStatus(\'' + m.modul_key + '\',\'' + w.key + '\',\'deaktiviert\')" class="' + wbtn + ' ' + (wStatus==='deaktiviert'?'bg-gray-500 text-white':'text-gray-400 hover:bg-gray-200') + '">âœ•</button>';
                                html += '</div></div>';
                            });
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                });
                container.innerHTML = html;

                var el1 = document.getElementById('countAktiv'); if(el1) el1.textContent = counts.aktiv||0;
                var el1b = document.getElementById('countDemo'); if(el1b) el1b.textContent = counts.demo||0;
                var el2 = document.getElementById('countWip'); if(el2) el2.textContent = counts.in_bearbeitung||0;
                var el3 = document.getElementById('countDeaktiviert'); if(el3) el3.textContent = counts.deaktiviert||0;
            } catch(err) { console.error('ModulStatusList:', err); container.innerHTML = '<div class="p-4 text-center text-red-400">Fehler beim Laden</div>'; }
        }

        function toggleModuleExpand(key) {
            expandedModules[key] = !expandedModules[key];
            renderModulStatusList();
        }

        async function setTabStatus(modulKey, tabKey, newStatus) {
            try {
                var cfg = sbModulConfig[modulKey] || {};
                if(!cfg.tabs) cfg.tabs = {};
                cfg.tabs[tabKey] = newStatus;
                var resp = await sb.from('modul_status').update({config: cfg}).eq('modul_key', modulKey);
                if(resp.error) throw resp.error;
                sbModulConfig[modulKey] = cfg;
                renderModulStatusList();
                applyModulStatus();
            } catch(err) { console.error('setTabStatus:', err); }
        }

        async function setWidgetStatus(modulKey, widgetKey, newStatus) {
            try {
                var cfg = sbModulConfig[modulKey] || {};
                if(!cfg.widgets) cfg.widgets = {};
                cfg.widgets[widgetKey] = newStatus;
                var resp = await sb.from('modul_status').update({config: cfg}).eq('modul_key', modulKey);
                if(resp.error) throw resp.error;
                sbModulConfig[modulKey] = cfg;
                renderModulStatusList();
                applyModulStatus();
            } catch(err) { console.error('setWidgetStatus:', err); }
        }

        async function setModulStatus(id, newStatus) {
            try {
                var resp = await sb.from('modul_status').update({status: newStatus, updated_by: sbUser ? sbUser.id : null}).eq('id', id);
                if(resp.error) throw resp.error;
                // Reload both the list and the sidebar
                await loadModulStatus();
                renderModulStatusList();
            } catch(err) { alert('Fehler: ' + err.message); }
        }

        function renderHqEinstellungen() {
            // Modul-Status Tab rendern
            renderModulStatusList();

            // Rechte-Matrix rendern
            var modules = [
                {key:'home',label:'Startseite',icon:'ðŸ ',core:true},
                {key:'kalender',label:'Kalender',icon:'ðŸ“…',core:true},
                {key:'todo',label:'Aufgaben',icon:'ðŸ“‹',core:true},
                {key:'kommunikation',label:'Kommunikation',icon:'ðŸ’¬',core:true},
                {key:'dashboards',label:'Dashboards',icon:'ðŸ“Š',core:false},
                {key:'allgemein',label:'Allgemein',icon:'ðŸ¢',core:false},
                {key:'verkauf',label:'Verkauf',icon:'ðŸ“ˆ',core:false},
                {key:'einkauf',label:'Einkauf',icon:'ðŸ›’',core:false},
                {key:'marketing',label:'Marketing',icon:'ðŸ“£',core:false},
                {key:'controlling',label:'Controlling',icon:'ðŸ“Š',core:false},
                {key:'wissen',label:'Wissen',icon:'ðŸ“š',core:false},
                {key:'support',label:'Support',icon:'ðŸŽ«',core:false},
                {key:'aktenschrank',label:'Aktenschrank',icon:'ðŸ“',core:false},
                {key:'ideenboard',label:'Ideenboard',icon:'ðŸ’¡',core:false},
                {key:'shop',label:'Werbemittel-Shop',icon:'ðŸ›ï¸',core:false},
                {key:'onboarding',label:'Onboarding',icon:'ðŸŽ¯',core:false}
            ];
            var rollen = ['inhaber','verkauf','werkstatt','buchhaltung'];

            var body = document.getElementById('rechteMatrixBody');
            if(!body) return;
            var h = '';
            modules.forEach(function(mod){
                var perms = rolePermissions[mod.key] || ['alle'];
                var isCore = mod.core;
                h += '<tr class="border-t border-gray-100 '+(isCore?'bg-green-50':'hover:bg-gray-50')+'">';
                h += '<td class="px-4 py-2.5 font-semibold text-gray-700 text-xs">'+mod.icon+' '+mod.label;
                if(isCore) h += ' <span class="text-[9px] text-green-600 font-normal">(Basis)</span>';
                h += '</td>';
                rollen.forEach(function(r){
                    var isAllowed = perms.indexOf('alle')>=0 || perms.indexOf(r)>=0;
                    if(isCore) {
                        h += '<td class="px-4 py-2.5 text-center"><span class="text-green-500 text-lg cursor-not-allowed" title="Basis-Modul â€“ immer aktiv">âœ…</span></td>';
                    } else {
                        h += '<td class="px-4 py-2.5 text-center"><button onclick="togglePermission(\''+mod.key+'\',\''+r+'\')" class="text-lg transition hover:scale-125" title="Klicken zum Umschalten">'+(isAllowed?'âœ…':'âŒ')+'</button></td>';
                    }
                });
                h += '</tr>';
            });
            body.innerHTML = h;

            // Update MA count
            var cnt = document.getElementById('settingsMaCount');
            if(cnt) cnt.textContent = kzMitarbeiter.length;
        }

        function togglePermission(modKey, rolle) {
            var perms = rolePermissions[modKey];
            if(!perms) { rolePermissions[modKey] = [rolle]; renderHqEinstellungen(); return; }

            // If currently 'alle', convert to explicit list minus this role
            if(perms.indexOf('alle')>=0) {
                rolePermissions[modKey] = ['inhaber','verkauf','werkstatt','buchhaltung'].filter(function(r){return r!==rolle;});
                renderHqEinstellungen();
                return;
            }

            var idx = perms.indexOf(rolle);
            if(idx>=0) {
                perms.splice(idx,1);
                if(perms.length===0) perms.push('inhaber'); // mindestens Inhaber
            } else {
                perms.push(rolle);
            }
            // If all 4 roles selected, simplify to 'alle'
            if(perms.length===4) rolePermissions[modKey] = ['alle'];
            renderHqEinstellungen();
            // Also update sidebar immediately if user is logged in
            try { updateUIForRole(); } catch(e){}
        }

        function renderKommandozentrale() {
            renderKzStandorte();
            renderKzMitarbeiter();
        }
        var currentLang = 'de';
        var i18n = {
            de: {
                // Navigation
                nav_home:'Startseite', nav_dashboards:'Dashboards', nav_mainmenu:'HauptmenÃ¼',
                nav_general:'Allgemein', nav_marketing:'Marketing', nav_purchasing:'Einkauf',
                nav_controlling:'Controlling', nav_sales:'Verkauf', nav_filingcab:'Aktenschrank',
                nav_support:'Support', nav_communication:'Kommunikation', nav_knowledge:'Wissen', nav_shop:'Werbemittel-Shop', h_purchasing:'EINKAUF', h_controlling:'CONTROLLING', h_filingcab:'AKTENSCHRANK', h_support:'SUPPORT', h_ideaboard:'IDEENBOARD', h_communication:'KOMMUNIKATION', h_forum:'FORUM', h_chat:'CHAT', h_calendar:'TERMINE', h_todos:'AUFGABEN', h_onboarding:'ONBOARDING', nav_ideaboard:'Ideenboard',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Steuerung',
                nav_hq_cockpit:'Netzwerk-Cockpit', nav_hq_locations:'Standorte',
                nav_hq_finance:'Finanzen', nav_hq_actions:'Handlungsbedarf', nav_hq_command:'Kommandozentrale', nav_hq_comm:'Kommunikation', nav_hq_campaigns:'Kampagnen', nav_hq_docs:'Dokumente', nav_hq_calendar:'Kalender', nav_hq_tasks:'Aufgaben', nav_hq_analytics:'Nutzung Portal', nav_calendar:'Kalender', nav_todo:'Aufgaben',
                // Headlines
                h_marketing:'MARKETING', h_sales:'VERKAUF', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD REPORTING',
                welcome:'Willkommen zurÃ¼ck, {name}!',
                // Dashboard
                dash_consultations:'Beratungen heute', dash_openoffers:'Offene Angebote',
                dash_opentickets:'Tickets offen',
                // Marketing tabs
                tab_campaigns:'Kampagnen', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Library', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategie', tab_knowledge:'ðŸ“š Wissen',
                // Social Media
                sm_channels:'ðŸ“± Unsere KanÃ¤le', sm_topics:'ðŸŽ¬ Themen-AuftrÃ¤ge',
                sm_upload:'ðŸ“¤ Video hochladen', sm_ranking:'ðŸ“Š Netzwerk-Ranking',
                sm_howto:"â„¹ï¸ So funktioniert's",
                filter_all:'Alle', filter_new:'ðŸ†• Neu fÃ¼r dich', filter_done:'âœ… Erledigt',
                search_topic:'Thema suchen...',
                // Role
                role_seller:'Verkauf',
                // Buttons & Labels
                btn_shoot:'ðŸ“¤ Drehen', btn_upload_now:'ðŸ“¤ Dieses Thema jetzt drehen & hochladen',
                btn_submit:'ðŸš€ Video einreichen', btn_to_channel:'Zum Kanal â†’',
                btn_follow:'Folgen', btn_subscribe:'Abonnieren',
                lbl_videos_shot:'Videos gedreht', lbl_topics:'Themen',
                lbl_streak:'ðŸ”¥ Streak: 2 Wochen', lbl_rank:'ðŸ† Rang 5 von 21',
                lbl_next_badge:'â­ NÃ¤chstes Badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (erste 3 Sekunden)',
                lbl_main:'ðŸ“‹ Hauptteil â€“ Was zeigen/erzÃ¤hlen',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tipp vom HQ-Marketing',
                lbl_example_video:'Beispielvideo ansehen',
                lbl_example_desc:'Schau dir an wie andere das gemacht haben â€“ dann nachmachen!',
                lbl_watch:'Ansehen â†’', lbl_done_video:'âœ… Du hast dieses Video bereits eingereicht!',
                lbl_difficulty:'Schwierigkeit',
                // Upload form
                upl_title:'Video hochladen', upl_desc:'WÃ¤hle ein Thema, lade dein Video hoch â€“ fertig! Wir kÃ¼mmern uns um Schnitt, Untertitel und Posting.',
                upl_select:'Thema wÃ¤hlen...', upl_own:'0000 â€“ Eigener Vorschlag',
                upl_your_video:'Dein Video', upl_drag:'Video hierhin ziehen',
                upl_click:'oder klicken zum AuswÃ¤hlen', upl_comment:'Kurzer Kommentar',
                upl_comment_ph:"z.B. 'Haben das im Laden gedreht, Lichtsituation war schwierig'",
                upl_footer:'Das HQ schneidet euer Video, packt Untertitel drauf und postet es als Collab-Post auf eurem Profil.',
                // Ranking
                rank_title:'ðŸ† Content-Ranking â€“ Wer dreht am meisten?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Netzwerk-Statistik',
                rank_total_vids:'Videos gesamt', rank_topics_covered:'Themen abgedeckt',
                rank_active:'Aktive Standorte', rank_no_video:'Noch ohne Video',
                // Howto
                howto_title:'So funktioniert Local Hero â€“ in 3 Schritten',
                howto_step1:'1. Inspiration', howto_step1d:'Wir stellen Thema + Beispielvideo bereit',
                howto_step2:'2. Drehen & Upload', howto_step2d:'1-3 Min. Video mit dem Handy drehen und hier hochladen',
                howto_step3:'3. Schnitt & Posting', howto_step3d:'Wir schneiden, packen Untertitel drauf und posten als Collab',
                howto_tips:'ðŸ’¡ Tipps fÃ¼r gute Videos', howto_links:'ðŸ”— Hilfreiche Links',
                // Local Hero header
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategie',
                lh_desc:'Dreh ein kurzes Video, lade es hoch â€“ wir machen den Rest! Schnitt, Untertitel & Posting Ã¼bernimmt das HQ.',
                // Channel cards
                ch_followers:'Follower', ch_posts:'BeitrÃ¤ge', ch_engagement:'Engagement',
                ch_subscribers:'Abonnenten', ch_videos:'Videos', ch_views:'Aufrufe',
                ch_likes:'Likes',
                // Badges
                badge_first:'Erster Upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Erreicht', badge_almost:'Noch 1!', badge_locked:'Gesperrt',
                // Content themes
                lbl_content_theme:'Content-Thema w\u00e4hlen',
                // Generic
                optional:'(optional)',
                // === BWA Erinnerungen ===
                bwa_reminder_title:'BWA {monat} {jahr} einreichen',
                bwa_reminder_desc:'Die BWA f\u00fcr {monat} {jahr} muss bis zum {deadline} eingereicht werden. Bitte im Bereich Controlling hochladen.',
                bwa_reminder_urgent:'\u26A0\uFE0F DRINGEND: Die Deadline ist in wenigen Tagen!',
                bwa_reminder_overdue:'\uD83D\uDEA8 \u00dcBERF\u00c4LLIG! Bitte umgehend einreichen. Das HQ wird benachrichtigt.',
                bwa_banner_info:'BWA-Erinnerung: Bitte einreichen.',
                bwa_banner_warn:'BWA-Erinnerung: Deadline naht!',
                bwa_banner_urgent:'BWA dringend einreichen!',
                bwa_banner_overdue:'BWA \u00fcberf\u00e4llig! HQ wird informiert.',
                bwa_banner_missing:'Fehlend',
                bwa_banner_btn:'Jetzt einreichen',
                // === Todos ===
                todo_open:'Offen', todo_today:'Heute', todo_overdue:'\u00dcberf\u00e4llig', todo_done:'Erledigt',
                todo_no_tasks:'Keine Aufgaben', todo_add:'Aufgabe hinzuf\u00fcgen', todo_edit:'Bearbeiten',
                todo_delete:'L\u00f6schen', todo_save:'Speichern', todo_cancel:'Abbrechen',
                todo_title_ph:'Aufgabe eingeben...', todo_due:'F\u00e4llig', todo_prio:'Priorit\u00e4t',
                todo_cat:'Kategorie', todo_system:'System-Aufgabe', todo_manual:'Manuell',
                prio_high:'Hoch', prio_normal:'Normal', prio_low:'Niedrig', prio_urgent:'Dringend',
                cat_sales:'Verkauf', cat_workshop:'Werkstatt', cat_marketing:'Marketing',
                cat_admin:'Admin', cat_other:'Sonstig',
                // === Tickets ===
                ticket_new:'Neues Ticket', ticket_subject:'Betreff', ticket_desc:'Beschreibung',
                ticket_category:'Kategorie', ticket_priority:'Priorit\u00e4t', ticket_create:'Ticket erstellen',
                ticket_status_open:'Offen', ticket_status_progress:'In Bearbeitung',
                ticket_status_waiting:'Wartend', ticket_status_resolved:'Gel\u00f6st',
                ticket_comments:'Kommentare', ticket_comment_ph:'Kommentar schreiben...',
                ticket_comment_send:'Senden', ticket_change_status:'Status \u00e4ndern',
                ticket_mark_resolved:'Als gel\u00f6st markieren', ticket_no_tickets:'Keine Tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'BWA hochladen',
                ctrl_month:'Monat', ctrl_year:'Jahr', ctrl_revenue:'Umsatz',
                ctrl_gross_profit:'Rohertrag', ctrl_costs:'Gesamtkosten', ctrl_result:'Ergebnis',
                ctrl_select_bwa:'BWA ausw\u00e4hlen', ctrl_edit:'Bearbeiten', ctrl_delete:'L\u00f6schen',
                // === Verkauf ===
                sales_week:'Wochenansicht', sales_pipeline:'Pipeline', sales_analysis:'Auswertung',
                sales_yearly:'Jahresplan', sales_plan:'Plan', sales_actual:'Ist',
                sales_consultations:'Beratungen', sales_sold:'Verkauft', sales_revenue:'Umsatz',
                sales_quote:'Quote', sales_all_sellers:'Alle Verk\u00e4ufer',
                sales_no_data:'Keine Verkaufsdaten f\u00fcr diese Woche',
                sales_add_entry:'Eintragen',
                // === Kommunikation ===
                comm_announcements:'Ank\u00fcndigungen', comm_board:'Schwarzes Brett',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'Neue Ank\u00fcndigung', comm_important:'Wichtig',
                comm_edit:'Bearbeiten', comm_delete:'L\u00f6schen', comm_publish:'Ver\u00f6ffentlichen',
                // === Dokumente ===
                doc_upload:'Dokument hochladen', doc_title:'Titel', doc_category:'Kategorie',
                doc_download:'Herunterladen', doc_delete:'L\u00f6schen', doc_select_file:'Datei ausw\u00e4hlen',
                doc_guidelines:'Richtlinien', doc_templates:'Vorlagen', doc_trainings:'Schulungen',
                doc_contracts:'Vertr\u00e4ge', doc_other:'Sonstiges',
                // === Shop ===
                shop_cart:'Warenkorb', shop_empty:'Warenkorb leer', shop_order:'Bestellen',
                shop_total:'Gesamt', shop_per_piece:'pro St\u00fcck', shop_remove:'Entfernen',
                // === Allgemein ===
                btn_save:'Speichern', btn_cancel:'Abbrechen', btn_close:'Schlie\u00dfen',
                btn_back:'Zur\u00fcck', btn_next:'Weiter', btn_confirm:'Best\u00e4tigen',
                loading:'Wird geladen...', error:'Fehler', success:'Erfolg',
                confirm_delete:'Wirklich l\u00f6schen?',
                // === Login ===
                login_title:'Partner Portal', login_email:'E-Mail', login_password:'Passwort',
                login_submit:'Anmelden', login_forgot:'Passwort vergessen?',
                login_reset_title:'Passwort zur\u00fccksetzen',
                login_reset_desc:'Gib deine E-Mail ein. Du erh\u00e4ltst einen Link zum Zur\u00fccksetzen.',
                login_reset_send:'Link senden', login_reset_sent:'E-Mail gesendet! Pr\u00fcfe deinen Posteingang.',
                pw_change_title:'Neues Passwort setzen',
                pw_change_desc:'Gib dein neues Passwort ein (mindestens 6 Zeichen).',
                pw_change_new:'Neues Passwort', pw_change_repeat:'Passwort wiederholen',
                pw_change_save:'Passwort speichern', pw_change_success:'Passwort erfolgreich ge\u00e4ndert!',
                pw_change_mismatch:'Passw\u00f6rter stimmen nicht \u00fcberein.',
                pw_change_min:'Mindestens 6 Zeichen.'
            },
            en: {
                nav_home:'Home', nav_dashboards:'Dashboards', nav_mainmenu:'Main Menu',
                nav_general:'General', nav_marketing:'Marketing', nav_purchasing:'Purchasing',
                nav_controlling:'Controlling', nav_sales:'Sales', nav_filingcab:'Filing Cabinet',
                nav_support:'Support', nav_communication:'Communication', nav_knowledge:'Knowledge', nav_shop:'Merchandise Shop', h_purchasing:'PURCHASING', h_controlling:'CONTROLLING', h_filingcab:'FILE CABINET', h_support:'SUPPORT', h_ideaboard:'IDEA BOARD', h_communication:'COMMUNICATION', h_forum:'FORUM', h_chat:'CHAT', h_calendar:'CALENDAR', h_todos:'TASKS', h_onboarding:'ONBOARDING', nav_ideaboard:'Idea Board',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Control',
                nav_hq_cockpit:'Network Cockpit', nav_hq_locations:'Locations',
                nav_hq_finance:'Finance', nav_hq_actions:'Action Required', nav_hq_command:'Command Center', nav_hq_comm:'Communication', nav_hq_campaigns:'Campaigns', nav_hq_docs:'Documents', nav_hq_calendar:'Calendar', nav_hq_tasks:'Tasks', nav_hq_analytics:'Portal Usage', nav_calendar:'Calendar', nav_todo:'Tasks',
                h_marketing:'MARKETING', h_sales:'SALES', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD REPORTING',
                welcome:'Welcome back, {name}!',
                dash_consultations:'Consultations today', dash_openoffers:'Open offers',
                dash_opentickets:'Open tickets',
                tab_campaigns:'Campaigns', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Library', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategy', tab_knowledge:'ðŸ“š Knowledge',
                sm_channels:'ðŸ“± Our Channels', sm_topics:'ðŸŽ¬ Content Briefs',
                sm_upload:'ðŸ“¤ Upload Video', sm_ranking:'ðŸ“Š Network Ranking',
                sm_howto:'â„¹ï¸ How it works',
                filter_all:'All', filter_new:'ðŸ†• New for you', filter_done:'âœ… Completed',
                search_topic:'Search topic...',
                role_seller:'Sales Associate',
                btn_shoot:'ðŸ“¤ Shoot', btn_upload_now:'ðŸ“¤ Shoot & upload this topic now',
                btn_submit:'ðŸš€ Submit video', btn_to_channel:'Go to channel â†’',
                btn_follow:'Follow', btn_subscribe:'Subscribe',
                lbl_videos_shot:'Videos recorded', lbl_topics:'Topics',
                lbl_streak:'ðŸ”¥ Streak: 2 weeks', lbl_rank:'ðŸ† Rank 5 of 21',
                lbl_next_badge:'â­ Next badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (first 3 seconds)',
                lbl_main:'ðŸ“‹ Main Part â€“ What to show/say',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tip from HQ Marketing',
                lbl_example_video:'Watch example video',
                lbl_example_desc:'See how others did it â€“ then recreate it!',
                lbl_watch:'Watch â†’', lbl_done_video:'âœ… You have already submitted this video!',
                lbl_difficulty:'Difficulty',
                upl_title:'Upload Video', upl_desc:'Choose a topic, upload your video â€“ done! We handle editing, subtitles and posting.',
                upl_select:'Choose topic...', upl_own:'0000 â€“ Own suggestion',
                upl_your_video:'Your Video', upl_drag:'Drag video here',
                upl_click:'or click to browse', upl_comment:'Short comment',
                upl_comment_ph:"e.g. 'Shot in the store, lighting was tricky'",
                upl_footer:'HQ edits your video, adds subtitles and posts it as a collab post on your profile.',
                rank_title:'ðŸ† Content Ranking â€“ Who shoots the most?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Network Statistics',
                rank_total_vids:'Total videos', rank_topics_covered:'Topics covered',
                rank_active:'Active locations', rank_no_video:'No video yet',
                howto_title:'How Local Hero works â€“ 3 simple steps',
                howto_step1:'1. Inspiration', howto_step1d:'We provide the topic + example video',
                howto_step2:'2. Shoot & Upload', howto_step2d:'Shoot 1-3 min. video with your phone and upload here',
                howto_step3:'3. Edit & Post', howto_step3d:'We edit, add subtitles and post as a collab',
                howto_tips:'ðŸ’¡ Tips for great videos', howto_links:'ðŸ”— Helpful links',
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategy',
                lh_desc:'Shoot a quick video, upload it â€“ we do the rest! Editing, subtitles & posting is handled by HQ.',
                ch_followers:'Followers', ch_posts:'Posts', ch_engagement:'Engagement',
                ch_subscribers:'Subscribers', ch_videos:'Videos', ch_views:'Views',
                ch_likes:'Likes',
                badge_first:'First Upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Achieved', badge_almost:'1 more!', badge_locked:'Locked',
                lbl_content_theme:'Choose content topic',
                optional:'(optional)',
                // === BWA Reminders ===
                bwa_reminder_title:'Submit BWA {monat} {jahr}',
                bwa_reminder_desc:'The BWA for {monat} {jahr} must be submitted by {deadline}. Please upload in the Controlling section.',
                bwa_reminder_urgent:'\u26A0\uFE0F URGENT: The deadline is in a few days!',
                bwa_reminder_overdue:'\uD83D\uDEA8 OVERDUE! Please submit immediately. HQ will be notified.',
                bwa_banner_info:'BWA reminder: Please submit.',
                bwa_banner_warn:'BWA reminder: Deadline approaching!',
                bwa_banner_urgent:'Submit BWA urgently!',
                bwa_banner_overdue:'BWA overdue! HQ will be notified.',
                bwa_banner_missing:'Missing',
                bwa_banner_btn:'Submit now',
                // === Todos ===
                todo_open:'Open', todo_today:'Today', todo_overdue:'Overdue', todo_done:'Done',
                todo_no_tasks:'No tasks', todo_add:'Add task', todo_edit:'Edit',
                todo_delete:'Delete', todo_save:'Save', todo_cancel:'Cancel',
                todo_title_ph:'Enter task...', todo_due:'Due', todo_prio:'Priority',
                todo_cat:'Category', todo_system:'System task', todo_manual:'Manual',
                prio_high:'High', prio_normal:'Normal', prio_low:'Low', prio_urgent:'Urgent',
                cat_sales:'Sales', cat_workshop:'Workshop', cat_marketing:'Marketing',
                cat_admin:'Admin', cat_other:'Other',
                // === Tickets ===
                ticket_new:'New ticket', ticket_subject:'Subject', ticket_desc:'Description',
                ticket_category:'Category', ticket_priority:'Priority', ticket_create:'Create ticket',
                ticket_status_open:'Open', ticket_status_progress:'In Progress',
                ticket_status_waiting:'Waiting', ticket_status_resolved:'Resolved',
                ticket_comments:'Comments', ticket_comment_ph:'Write a comment...',
                ticket_comment_send:'Send', ticket_change_status:'Change status',
                ticket_mark_resolved:'Mark as resolved', ticket_no_tickets:'No tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'Upload BWA',
                ctrl_month:'Month', ctrl_year:'Year', ctrl_revenue:'Revenue',
                ctrl_gross_profit:'Gross profit', ctrl_costs:'Total costs', ctrl_result:'Result',
                ctrl_select_bwa:'Select BWA', ctrl_edit:'Edit', ctrl_delete:'Delete',
                // === Sales ===
                sales_week:'Week view', sales_pipeline:'Pipeline', sales_analysis:'Analysis',
                sales_yearly:'Annual plan', sales_plan:'Plan', sales_actual:'Actual',
                sales_consultations:'Consultations', sales_sold:'Sold', sales_revenue:'Revenue',
                sales_quote:'Rate', sales_all_sellers:'All sellers',
                sales_no_data:'No sales data for this week',
                sales_add_entry:'Add entry',
                // === Communication ===
                comm_announcements:'Announcements', comm_board:'Bulletin board',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'New announcement', comm_important:'Important',
                comm_edit:'Edit', comm_delete:'Delete', comm_publish:'Publish',
                // === Documents ===
                doc_upload:'Upload document', doc_title:'Title', doc_category:'Category',
                doc_download:'Download', doc_delete:'Delete', doc_select_file:'Select file',
                doc_guidelines:'Guidelines', doc_templates:'Templates', doc_trainings:'Trainings',
                doc_contracts:'Contracts', doc_other:'Other',
                // === Shop ===
                shop_cart:'Shopping cart', shop_empty:'Cart is empty', shop_order:'Order',
                shop_total:'Total', shop_per_piece:'per piece', shop_remove:'Remove',
                // === General ===
                btn_save:'Save', btn_cancel:'Cancel', btn_close:'Close',
                btn_back:'Back', btn_next:'Next', btn_confirm:'Confirm',
                loading:'Loading...', error:'Error', success:'Success',
                confirm_delete:'Really delete?',
                // === Login ===
                login_title:'Partner Portal', login_email:'Email', login_password:'Password',
                login_submit:'Sign in', login_forgot:'Forgot password?',
                login_reset_title:'Reset password',
                login_reset_desc:'Enter your email. You will receive a link to reset your password.',
                login_reset_send:'Send link', login_reset_sent:'Email sent! Check your inbox.',
                pw_change_title:'Set new password',
                pw_change_desc:'Enter your new password (at least 6 characters).',
                pw_change_new:'New password', pw_change_repeat:'Repeat password',
                pw_change_save:'Save password', pw_change_success:'Password changed successfully!',
                pw_change_mismatch:'Passwords do not match.',
                pw_change_min:'At least 6 characters.'
            },
            nl: {
                nav_home:'Startpagina', nav_dashboards:'Dashboards', nav_mainmenu:'Hoofdmenu',
                nav_general:'Algemeen', nav_marketing:'Marketing', nav_purchasing:'Inkoop',
                nav_controlling:'Controlling', nav_sales:'Verkoop', nav_filingcab:'Documentenarchief',
                nav_support:'Ondersteuning', nav_communication:'Communicatie', nav_ideaboard:'IdeeÃ«nbord',
                nav_onboarding:'Onboarding', nav_hq_control:'HQ Beheer',
                nav_hq_cockpit:'Netwerk-Cockpit', nav_hq_locations:'Locaties',
                nav_hq_finance:'FinanciÃ«n', nav_hq_actions:'Actie vereist', nav_hq_command:'Commandocentrum', nav_hq_comm:'Communicatie', nav_hq_campaigns:'Campagnes', nav_hq_docs:'Documenten', nav_hq_calendar:'Agenda', nav_hq_tasks:'Taken', nav_hq_analytics:'Portaalgebruik', nav_calendar:'Agenda', nav_todo:'Taken',
                h_marketing:'MARKETING', h_sales:'VERKOOP', h_dashboards:'DASHBOARDS',
                h_leadreporting:'LEAD RAPPORTAGE',
                h_purchasing:'INKOOP', h_controlling:'CONTROLLING', h_filingcab:'DOCUMENTENARCHIEF',
                h_support:'ONDERSTEUNING', h_ideaboard:'IDEE\u00cbNBORD', h_communication:'COMMUNICATIE',
                h_forum:'FORUM', h_chat:'CHAT', h_calendar:'AGENDA', h_todos:'TAKEN', h_onboarding:'ONBOARDING',
                nav_knowledge:'Kennis', nav_shop:'Promotieshop',
                welcome:'Welkom terug, {name}!',
                dash_consultations:'Adviezen vandaag', dash_openoffers:'Openstaande offertes',
                dash_opentickets:'Open tickets',
                tab_campaigns:'Campagnes', tab_socialmedia:'Social Media',
                tab_contentlib:'Content Bibliotheek', tab_analytics:'Analytics',
                tab_strategy:'ðŸ“‹ Strategie', tab_knowledge:'ðŸ“š Kennis',
                sm_channels:'ðŸ“± Onze kanalen', sm_topics:'ðŸŽ¬ Content-opdrachten',
                sm_upload:'ðŸ“¤ Video uploaden', sm_ranking:'ðŸ“Š Netwerk-ranking',
                sm_howto:'â„¹ï¸ Zo werkt het',
                filter_all:'Alle', filter_new:'ðŸ†• Nieuw voor jou', filter_done:'âœ… Afgerond',
                search_topic:'Onderwerp zoeken...',
                role_seller:'Verkoper',
                btn_shoot:'ðŸ“¤ Filmen', btn_upload_now:'ðŸ“¤ Dit onderwerp nu filmen & uploaden',
                btn_submit:'ðŸš€ Video indienen', btn_to_channel:'Naar kanaal â†’',
                btn_follow:'Volgen', btn_subscribe:'Abonneren',
                lbl_videos_shot:'Videos gemaakt', lbl_topics:'Onderwerpen',
                lbl_streak:'ðŸ”¥ Reeks: 2 weken', lbl_rank:'ðŸ† Rang 5 van 21',
                lbl_next_badge:'â­ Volgende badge: 5 Videos',
                lbl_hook:'ðŸŽ£ Hook / Intro (eerste 3 seconden)',
                lbl_main:'ðŸ“‹ Hoofddeel â€“ Wat laten zien/vertellen',
                lbl_outro:'ðŸ“£ Outro / Call-to-Action',
                lbl_hqtip:'ðŸ’¡ Tip van HQ Marketing',
                lbl_example_video:'Voorbeeldvideo bekijken',
                lbl_example_desc:'Bekijk hoe anderen het deden â€“ en doe het na!',
                lbl_watch:'Bekijken â†’', lbl_done_video:'âœ… Je hebt deze video al ingediend!',
                lbl_difficulty:'Moeilijkheid',
                upl_title:'Video uploaden', upl_desc:'Kies een onderwerp, upload je video â€“ klaar! Wij zorgen voor montage, ondertiteling en publicatie.',
                upl_select:'Onderwerp kiezen...', upl_own:'0000 â€“ Eigen voorstel',
                upl_your_video:'Jouw video', upl_drag:'Sleep video hierheen',
                upl_click:'of klik om te selecteren', upl_comment:'Kort commentaar',
                upl_comment_ph:"bijv. 'In de winkel gefilmd, belichting was lastig'",
                upl_footer:'HQ monteert je video, voegt ondertiteling toe en plaatst het als collab-post op je profiel.',
                rank_title:'ðŸ† Content-ranking â€“ Wie filmt het meest?',
                rank_badges:'ðŸŽ–ï¸ Badges', rank_stats:'ðŸ“Š Netwerkstatistieken',
                rank_total_vids:'Totaal videos', rank_topics_covered:'Onderwerpen behandeld',
                rank_active:'Actieve locaties', rank_no_video:'Nog geen video',
                howto_title:'Zo werkt Local Hero â€“ in 3 stappen',
                howto_step1:'1. Inspiratie', howto_step1d:'Wij leveren het onderwerp + voorbeeldvideo',
                howto_step2:'2. Filmen & Upload', howto_step2d:'Film 1-3 min. video met je telefoon en upload hier',
                howto_step3:'3. Montage & Publicatie', howto_step3d:'Wij monteren, voegen ondertiteling toe en publiceren als collab',
                howto_tips:'ðŸ’¡ Tips voor goede videos', howto_links:'ðŸ”— Handige links',
                lh_title:'ðŸŽ¬ Local Hero â€“ Content Strategie',
                lh_desc:'Film een korte video, upload het â€“ wij doen de rest! Montage, ondertiteling & publicatie doet het HQ.',
                ch_followers:'Volgers', ch_posts:'Berichten', ch_engagement:'Betrokkenheid',
                ch_subscribers:'Abonnees', ch_videos:'Videos', ch_views:'Weergaven',
                ch_likes:'Likes',
                badge_first:'Eerste upload', badge_3:'3 Videos', badge_5:'5 Videos',
                badge_10:'10 Videos', badge_25:'25 Videos', badge_50:'50 Videos',
                badge_reached:'âœ… Behaald', badge_almost:'Nog 1!', badge_locked:'Vergrendeld',
                lbl_content_theme:'Content-onderwerp kiezen',
                optional:'(optioneel)',
                // === BWA Herinneringen ===
                bwa_reminder_title:'BWA {monat} {jahr} indienen',
                bwa_reminder_desc:'De BWA voor {monat} {jahr} moet voor {deadline} ingediend worden. Upload in het onderdeel Controlling.',
                bwa_reminder_urgent:'\u26A0\uFE0F DRINGEND: De deadline is over een paar dagen!',
                bwa_reminder_overdue:'\uD83D\uDEA8 TE LAAT! Dien zo snel mogelijk in. HQ wordt ge\u00efnformeerd.',
                bwa_banner_info:'BWA-herinnering: Gelieve in te dienen.',
                bwa_banner_warn:'BWA-herinnering: Deadline nadert!',
                bwa_banner_urgent:'BWA dringend indienen!',
                bwa_banner_overdue:'BWA te laat! HQ wordt ge\u00efnformeerd.',
                bwa_banner_missing:'Ontbrekend',
                bwa_banner_btn:'Nu indienen',
                // === Taken ===
                todo_open:'Open', todo_today:'Vandaag', todo_overdue:'Te laat', todo_done:'Afgerond',
                todo_no_tasks:'Geen taken', todo_add:'Taak toevoegen', todo_edit:'Bewerken',
                todo_delete:'Verwijderen', todo_save:'Opslaan', todo_cancel:'Annuleren',
                todo_title_ph:'Taak invoeren...', todo_due:'Deadline', todo_prio:'Prioriteit',
                todo_cat:'Categorie', todo_system:'Systeemtaak', todo_manual:'Handmatig',
                prio_high:'Hoog', prio_normal:'Normaal', prio_low:'Laag', prio_urgent:'Dringend',
                cat_sales:'Verkoop', cat_workshop:'Werkplaats', cat_marketing:'Marketing',
                cat_admin:'Administratie', cat_other:'Overig',
                // === Tickets ===
                ticket_new:'Nieuw ticket', ticket_subject:'Onderwerp', ticket_desc:'Beschrijving',
                ticket_category:'Categorie', ticket_priority:'Prioriteit', ticket_create:'Ticket aanmaken',
                ticket_status_open:'Open', ticket_status_progress:'In behandeling',
                ticket_status_waiting:'Wachtend', ticket_status_resolved:'Opgelost',
                ticket_comments:'Reacties', ticket_comment_ph:'Reactie schrijven...',
                ticket_comment_send:'Verzenden', ticket_change_status:'Status wijzigen',
                ticket_mark_resolved:'Als opgelost markeren', ticket_no_tickets:'Geen tickets',
                // === Controlling / BWA ===
                ctrl_bwa:'BWA', ctrl_trend:'Trend', ctrl_upload:'BWA uploaden',
                ctrl_month:'Maand', ctrl_year:'Jaar', ctrl_revenue:'Omzet',
                ctrl_gross_profit:'Brutowinst', ctrl_costs:'Totale kosten', ctrl_result:'Resultaat',
                ctrl_select_bwa:'BWA selecteren', ctrl_edit:'Bewerken', ctrl_delete:'Verwijderen',
                // === Verkoop ===
                sales_week:'Weekoverzicht', sales_pipeline:'Pipeline', sales_analysis:'Analyse',
                sales_yearly:'Jaarplan', sales_plan:'Plan', sales_actual:'Werkelijk',
                sales_consultations:'Adviezen', sales_sold:'Verkocht', sales_revenue:'Omzet',
                sales_quote:'Percentage', sales_all_sellers:'Alle verkopers',
                sales_no_data:'Geen verkoopgegevens voor deze week',
                sales_add_entry:'Invoeren',
                // === Communicatie ===
                comm_announcements:'Aankondigingen', comm_board:'Prikbord',
                comm_forum:'Forum', comm_chat:'Chat',
                comm_new_announcement:'Nieuwe aankondiging', comm_important:'Belangrijk',
                comm_edit:'Bewerken', comm_delete:'Verwijderen', comm_publish:'Publiceren',
                // === Documenten ===
                doc_upload:'Document uploaden', doc_title:'Titel', doc_category:'Categorie',
                doc_download:'Downloaden', doc_delete:'Verwijderen', doc_select_file:'Bestand selecteren',
                doc_guidelines:'Richtlijnen', doc_templates:'Sjablonen', doc_trainings:'Trainingen',
                doc_contracts:'Contracten', doc_other:'Overig',
                // === Shop ===
                shop_cart:'Winkelwagen', shop_empty:'Winkelwagen leeg', shop_order:'Bestellen',
                shop_total:'Totaal', shop_per_piece:'per stuk', shop_remove:'Verwijderen',
                // === Algemeen ===
                btn_save:'Opslaan', btn_cancel:'Annuleren', btn_close:'Sluiten',
                btn_back:'Terug', btn_next:'Volgende', btn_confirm:'Bevestigen',
                loading:'Wordt geladen...', error:'Fout', success:'Gelukt',
                confirm_delete:'Echt verwijderen?',
                // === Login ===
                login_title:'Partner Portaal', login_email:'E-mail', login_password:'Wachtwoord',
                login_submit:'Inloggen', login_forgot:'Wachtwoord vergeten?',
                login_reset_title:'Wachtwoord resetten',
                login_reset_desc:'Voer je e-mailadres in. Je ontvangt een link om je wachtwoord te resetten.',
                login_reset_send:'Link verzenden', login_reset_sent:'E-mail verzonden! Controleer je inbox.',
                pw_change_title:'Nieuw wachtwoord instellen',
                pw_change_desc:'Voer je nieuwe wachtwoord in (minimaal 6 tekens).',
                pw_change_new:'Nieuw wachtwoord', pw_change_repeat:'Wachtwoord herhalen',
                pw_change_save:'Wachtwoord opslaan', pw_change_success:'Wachtwoord succesvol gewijzigd!',
                pw_change_mismatch:'Wachtwoorden komen niet overeen.',
                pw_change_min:'Minimaal 6 tekens.'
            }
        };

        // ========== WERBEMITTEL-SHOP ==========
        var shopCart = [];

        async function renderShop() {
            var container = document.getElementById('shopGrid');
            if(!container) return;
            try {
                var resp = await sb.from('shop_produkte').select('*').eq('verfuegbar', true).order('kategorie');
                if(resp.error) throw resp.error;
                var products = resp.data || [];
                var html = '';
                products.forEach(function(p) {
                    var inCart = shopCart.find(function(c){return c.id===p.id});
                    html += '<div class="vit-card p-5 hover:shadow-md transition">';
                    html += '<div class="w-full h-32 bg-gray-100 rounded-lg mb-3 flex items-center justify-center text-4xl">ðŸ›ï¸</div>';
                    html += '<span class="text-xs font-semibold text-vit-orange uppercase">' + (p.kategorie||'') + '</span>';
                    html += '<h3 class="font-bold text-gray-800 text-sm mt-1">' + p.name + '</h3>';
                    if(p.beschreibung) html += '<p class="text-xs text-gray-500 mt-1">' + p.beschreibung + '</p>';
                    html += '<div class="flex items-center justify-between mt-3">';
                    html += '<span class="font-bold text-gray-800">' + (p.preis > 0 ? p.preis.toFixed(2) + ' \u20ac' : 'Kostenlos') + '</span>';
                    html += '<button onclick="addToCart(\x27'+p.id+'\x27,\x27'+(p.name||'').replace(/\x27/g,'')+'\x27,'+p.preis+')" class="px-3 py-1.5 text-xs font-semibold rounded-lg ' + (inCart ? 'bg-green-500 text-white' : 'bg-vit-orange text-white hover:opacity-90') + '">' + (inCart ? '\u2713 Im Warenkorb' : '+ Bestellen') + '</button>';
                    html += '</div></div>';
                });
                if(products.length===0) html = '<div class="col-span-3 text-center py-8 text-gray-400">Keine Produkte.</div>';
                container.innerHTML = html;
                renderShopCart();
            } catch(err) { console.error('Shop:', err); }
        }

        function addToCart(id, name, preis) {
            var existing = shopCart.find(function(c){return c.id===id});
            if(existing) { existing.menge++; } else { shopCart.push({id:id, name:name, preis:preis, menge:1}); }
            renderShop();
        }

        function renderShopCart() {
            var container = document.getElementById('shopCartItems');
            if(!container) return;
            if(shopCart.length===0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Warenkorb leer</p>';
                var totalEl = document.getElementById('shopCartTotal'); if(totalEl) totalEl.textContent = '0,00';
                var countEl = document.getElementById('shopCartCount'); if(countEl) countEl.textContent = '0';
                return;
            }
            var html = ''; var total = 0; var count = 0;
            shopCart.forEach(function(c) {
                total += c.preis * c.menge;
                count += c.menge;
                html += '<div class="flex items-center justify-between py-2 border-b border-gray-100">';
                html += '<div class="flex-1 min-w-0"><span class="text-sm font-medium text-gray-800 truncate block">' + c.name + '</span>';
                html += '<span class="text-xs text-gray-400">' + c.preis.toFixed(2) + ' \u20ac / St\u00fcck</span></div>';
                html += '<div class="flex items-center space-x-2 ml-3">';
                html += '<button onclick="updateShopCart(\x27'+c.id+'\x27,-1)" class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold">\u2212</button>';
                html += '<span class="text-sm font-bold w-6 text-center">' + c.menge + '</span>';
                html += '<button onclick="updateShopCart(\x27'+c.id+'\x27,1)" class="w-6 h-6 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold">+</button>';
                html += '<span class="text-sm font-bold text-gray-800 w-16 text-right">' + (c.preis*c.menge).toFixed(2) + ' \u20ac</span>';
                html += '<button onclick="removeFromCart(\x27'+c.id+'\x27)" class="text-gray-300 hover:text-red-500 ml-1">\u2715</button>';
                html += '</div></div>';
            });
            html += '<div class="flex justify-between pt-3 font-bold text-gray-800"><span>Gesamt</span><span>' + total.toFixed(2) + ' \u20ac</span></div>';
            container.innerHTML = html;
            var totalEl = document.getElementById('shopCartTotal'); if(totalEl) totalEl.textContent = total.toFixed(2).replace('.',',');
            var countEl = document.getElementById('shopCartCount'); if(countEl) countEl.textContent = count;
        }

        function filterShop(kat) {
            document.querySelectorAll('.shop-filter-btn').forEach(function(b){b.className='shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn=document.querySelector('.shop-filter-btn[data-sf="'+kat+'"]');
            if(btn) btn.className='shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderShop();
        }

        async function submitShopOrder() {
            if(shopCart.length===0 || !sbUser) return;
            try {
                var total = shopCart.reduce(function(a,c){return a+c.preis*c.menge},0);
                var orderResp = await sb.from('shop_bestellungen').insert({standort_id:sbStandort?sbStandort.id:null, user_id:sbUser.id, gesamt_preis:total}).select().single();
                if(orderResp.error) throw orderResp.error;
                var positionen = shopCart.map(function(c){ return {bestellung_id:orderResp.data.id, produkt_id:c.id, menge:c.menge, einzelpreis:c.preis}; });
                await sb.from('shop_positionen').insert(positionen);
                shopCart = [];
                alert('Bestellung erfolgreich! \ud83c\udf89');
                renderShop();
            } catch(err) { alert('Fehler: '+err.message); }
        }

        function removeFromCart(id) {
            shopCart = shopCart.filter(function(c){return c.id!==id;});
            renderShop();
        }

        function updateShopCart(id, delta) {
            var item = shopCart.find(function(c){return c.id===id;});
            if(!item) return;
            item.menge += delta;
            if(item.menge <= 0) shopCart = shopCart.filter(function(c){return c.id!==id;});
            renderShop();
        }

        // ========== HQ DRILL-DOWN: Switch to Partner view for a specific location ==========
        function hqDrillDown(locationKey) {
            // Switch to partner mode for that location
            var sel = document.getElementById('viewModeSwitch');
            if(sel) {
                // Find matching option
                var opts = sel.options;
                for(var i=0; i<opts.length; i++) {
                    if(opts[i].value.indexOf(locationKey) > -1) {
                        sel.value = opts[i].value;
                        switchViewMode(opts[i].value);
                        return;
                    }
                }
            }
            // Fallback
            switchViewMode('partner_grafrath');
        }

        function handleFileUpload(input) {
            if(input.files && input.files[0]) {
                var name = input.files[0].name;
                var size = (input.files[0].size/1024).toFixed(1);
                var parent = input.closest('[onclick]') || input.parentElement;
                if(parent) {
                    var origHTML = parent.innerHTML;
                    parent.innerHTML = '<div class="py-4"><p class="text-green-600 font-semibold text-sm">âœ… '+name+'</p><p class="text-xs text-gray-400">'+size+' KB hochgeladen</p></div>';
                }
            }
        }

        function switchLang(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            // Update flag opacity
            document.querySelectorAll('.lang-flag').forEach(function(f){
                f.classList.toggle('opacity-40', f.getAttribute('data-lang')!==lang);
                f.classList.toggle('opacity-100', f.getAttribute('data-lang')===lang);
            });
            // Translate all data-i18n elements
            document.querySelectorAll('[data-i18n]').forEach(function(el){
                var key = el.getAttribute('data-i18n');
                if(i18n[lang] && i18n[lang][key]) {
                    el.textContent = i18n[lang][key];
                }
            });
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el){
                var key = el.getAttribute('data-i18n-placeholder');
                if(i18n[lang] && i18n[lang][key]) {
                    el.placeholder = i18n[lang][key];
                }
            });
            // Re-render ALL visible dynamic content
            try { renderTodos(); } catch(e){}
            try { renderTickets('all'); } catch(e){}
            try { renderAnnouncements(); } catch(e){}
            try { renderShopCart(); } catch(e){}
            var views = document.querySelectorAll('.view');
            views.forEach(function(v) {
                if(v.style.display !== 'none') {
                    var vid = v.id;
                    if(vid==='homeView') { /* static i18n handles it */ }
                    if(vid==='smThemenList' || document.getElementById('smThemenList')) { try{renderSmThemen();}catch(e){} }
                    if(vid==='smRankingList' || document.getElementById('smRankingList')) { try{renderSmRanking();}catch(e){} }
                    if(vid==='shopView') { try{renderShop();}catch(e){} }
                    if(vid==='wissenView') { try{renderWissenGlobal();}catch(e){} }
                }
            });
            // Force re-render SM if visible
            try{if(document.getElementById('smThemenList') && document.getElementById('smThemenList').innerHTML) renderSmThemen();}catch(e){}
            try{if(document.getElementById('smRankingList') && document.getElementById('smRankingList').innerHTML) renderSmRanking();}catch(e){}
        }

        // Helper: get translated text (for JS-rendered content)
        function t(key) {
            return (i18n[currentLang] && i18n[currentLang][key]) || (i18n.de[key]) || key;
        }

        var currentSmFilter = 'all';

        function switchSmSub(sub) {
            document.querySelectorAll('.sm-sub-content').forEach(function(el){el.style.display='none';});
            document.querySelectorAll('.sm-sub-btn').forEach(function(b){b.className='sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600';});
            var target = document.getElementById('smSub'+sub.charAt(0).toUpperCase()+sub.slice(1));
            if(target) target.style.display='block';
            var btn = document.querySelector('.sm-sub-btn[data-smsub="'+sub+'"]');
            if(btn) btn.className='sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-vit-orange text-white';
            if(sub==='themen') renderSmThemen();
            if(sub==='ranking') renderSmRanking();
        }

        function filterSmThemen(filter) {
            currentSmFilter = filter;
            document.querySelectorAll('.sm-thema-filter').forEach(function(b){b.className='sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600';});
            var btn = document.querySelector('.sm-thema-filter[data-smf="'+filter+'"]');
            if(btn) btn.className='sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white';
            renderSmThemen();
        }

        function renderSmThemen() {
            var search = (document.getElementById('smThemenSearch')||{}).value||'';
            var list = smThemen.filter(function(t){
                if(currentSmFilter==='neu' && t.done) return false;
                if(currentSmFilter==='done' && !t.done) return false;
                if(search && t.thema.toLowerCase().indexOf(search.toLowerCase())===-1 && t.id.toLowerCase().indexOf(search.toLowerCase())===-1) return false;
                return true;
            });

            var katColors = {Story:'bg-pink-100 text-pink-700',Technik:'bg-blue-100 text-blue-700',Beratung:'bg-green-100 text-green-700',Werkstatt:'bg-gray-200 text-gray-700',USP:'bg-orange-100 text-orange-700',Tipps:'bg-cyan-100 text-cyan-700',Ergonomie:'bg-purple-100 text-purple-700'};
            var schwColors = {leicht:'ðŸŸ¢',mittel:'ðŸŸ¡',schwer:'ðŸ”´'};

            var el = document.getElementById('smThemenList');
            if(!el) return;
            var h = '';
            list.forEach(function(th,idx){
                var detailId = 'smDetail_'+th.id;
                h += '<div class="vit-card overflow-hidden '+(th.done?'opacity-60 border-l-4 border-green-400':'border-l-4 border-transparent hover:border-l-4 hover:border-vit-orange')+' transition">';

                // Header row (clickable to expand)
                h += '<div class="p-4 flex items-center space-x-4 cursor-pointer" onclick="var d=document.getElementById(\''+detailId+'\');d.style.display=d.style.display===\'none\'?\'block\':\'none\'">';
                // Status icon
                if(th.done) {
                    h += '<div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">âœ“</div>';
                } else {
                    h += '<div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-vit-orange font-bold text-lg flex-shrink-0">â–¶</div>';
                }
                // Title area
                h += '<div class="flex-1 min-w-0">';
                h += '<div class="flex items-center space-x-2 mb-0.5">';
                h += '<span class="text-[10px] font-mono font-bold text-gray-400">'+th.id.toUpperCase()+'</span>';
                h += '<span class="text-[10px] px-1.5 py-0.5 rounded '+(katColors[th.kat]||'bg-gray-100 text-gray-600')+'">'+th.kat+'</span>';
                h += '<span class="text-[10px]">'+schwColors[th.schwierig]+' '+th.schwierig+'</span>';
                if(th.beispiel) h += '<span class="text-[10px] px-1.5 py-0.5 bg-red-50 text-red-600 rounded">ðŸŽ¥ Beispielvideo</span>';
                h += '</div>';
                h += '<p class="text-sm font-semibold text-gray-800">'+th.thema+'</p>';
                h += '</div>';
                // Expand arrow + action
                h += '<div class="flex items-center space-x-2 flex-shrink-0">';
                if(!th.done) h += '<button class="px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:opacity-90 whitespace-nowrap" onclick="event.stopPropagation(); switchSmSub(\'upload\')">'+ t('btn_shoot')+'</button>';
                h += '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
                h += '</div>';
                h += '</div>';

                // Expandable detail (hidden by default)
                h += '<div id="'+detailId+'" style="display:none;" class="px-4 pb-5 border-t border-gray-100 bg-gray-50">';
                h += '<div class="pt-4 space-y-4">';

                // Beispielvideo
                if(th.beispiel) {
                    h += '<div class="p-3 bg-red-50 rounded-lg flex items-center space-x-3">';
                    h += '<span class="text-2xl">ðŸŽ¥</span>';
                    h += '<div class="flex-1"><p class="text-xs font-bold text-gray-700">'+ t('lbl_example_video')+'</p><p class="text-[10px] text-gray-500">'+t('lbl_example_desc')+'</p></div>';
                    h += '<a href="'+th.beispiel+'" target="_blank" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-semibold hover:opacity-90">'+ t('lbl_watch')+'</a>';
                    h += '</div>';
                }

                // Hook
                h += '<div>';
                h += '<p class="text-xs font-bold text-vit-orange uppercase mb-1.5">'+ t('lbl_hook')+'</p>';
                th.hook.forEach(function(hk){
                    h += '<p class="text-sm text-gray-700 italic bg-white p-2 rounded mb-1 border-l-3 border-l-2 border-vit-orange">'+hk+'</p>';
                });
                h += '</div>';

                // Hauptteil
                h += '<div>';
                h += '<p class="text-xs font-bold text-blue-600 uppercase mb-1.5">'+ t('lbl_main')+'</p>';
                h += '<p class="text-sm text-gray-700 bg-white p-3 rounded leading-relaxed">'+th.hauptteil+'</p>';
                h += '</div>';

                // CTA
                h += '<div>';
                h += '<p class="text-xs font-bold text-green-600 uppercase mb-1.5">'+ t('lbl_outro')+'</p>';
                h += '<p class="text-sm text-gray-700 bg-white p-2 rounded italic">'+th.cta+'</p>';
                h += '</div>';

                // HQ Tipp
                if(th.hqTipp) {
                    h += '<div class="p-3 bg-orange-50 rounded-lg border border-orange-200">';
                    h += '<p class="text-xs font-bold text-vit-orange mb-1">'+ t('lbl_hqtip')+'</p>';
                    h += '<p class="text-xs text-gray-600">'+th.hqTipp+'</p>';
                    h += '</div>';
                }

                // Upload CTA
                if(!th.done) {
                    h += '<button class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold text-sm hover:opacity-90 transition" onclick="switchSmSub(\'upload\')">'+ t('btn_upload_now')+'</button>';
                } else {
                    h += '<div class="text-center py-2 text-sm text-green-600 font-semibold">'+ t('lbl_done_video')+'</div>';
                }

                h += '</div></div>';
                h += '</div>';
            });
            if(!list.length) h = '<div class="text-center py-8 text-gray-400"><p class="text-3xl mb-2">ðŸŽ¬</p><p class="text-sm">Keine Themen gefunden</p></div>';
            el.innerHTML = h;

            // Populate upload select
            var sel = document.getElementById('smUploadThema');
            if(sel && sel.options.length<=1) {
                smThemen.filter(function(t){return !t.done;}).forEach(function(t){
                    sel.innerHTML += '<option value="'+t.id+'">'+t.id.toUpperCase()+' â€“ '+t.thema+'</option>';
                });
                sel.innerHTML += '<option value="0000">0000 â€“ Eigener Vorschlag</option>';
            }
        }

        function renderSmRanking() {
            var el = document.getElementById('smRankingList');
            if(!el) return;
            var sorted = smRankingData.slice().sort(function(a,b){return b.count-a.count;});
            var maxCount = sorted[0]?sorted[0].count:1;
            var h = '';
            sorted.forEach(function(s,i){
                var isMe = s.name==='Grafrath';
                var w = maxCount ? Math.max(5, s.count/maxCount*100) : 5;
                var medal = i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':'';
                h += '<div class="flex items-center space-x-3 p-2 rounded-lg '+(isMe?'bg-orange-50 border border-orange-200':'')+'"><span class="text-xs w-5 text-gray-400 font-bold">'+(i+1)+'</span><span class="text-xs w-28 truncate font-semibold '+(isMe?'text-vit-orange':'text-gray-700')+'">'+medal+' '+s.name+(isMe?' (du)':'')+'</span><div class="flex-1 bg-gray-100 rounded-full h-4"><div class="h-4 rounded-full '+(s.count>0?'bg-gradient-to-r from-vit-orange to-yellow-400':'bg-gray-200')+'" style="width:'+w+'%"></div></div><span class="text-xs font-bold w-8 text-right">'+s.count+'</span></div>';
            });
            el.innerHTML = h;
        }

        // showAllgemeinTab - replaced by new allgemein module (see below)

        function showView(viewName) {
            console.log('showView called with:', viewName);
            
            // Log event
            if(typeof logPortalEvent === 'function') logPortalEvent('view_opened', {view: viewName});
            
            // Trainer: map view to area
            var viewAreaMap = {home:'allgemein',controlling:'controlling',verkauf:'verkauf',marketing:'marketing',einkauf:'einkauf',werkstatt:'werkstatt',todo:'allgemein',kommunikation:'allgemein'};
            var viewContainerMap = {home:'trainerAreaHome',controlling:'trainerAreaControlling',verkauf:'trainerAreaVerkauf',marketing:'trainerAreaMarketing'};
            var trainerArea = viewAreaMap[viewName];
            var trainerContainer = viewContainerMap[viewName];
            if(trainerArea && trainerContainer && typeof showTrainerForArea === 'function') {
                showTrainerForArea(trainerArea, trainerContainer);
            }
            
            // Verstecke ALLE Views automatisch (per Klasse statt hardcoded Liste)
            var allViews = document.querySelectorAll('.view');
            console.log('Found', allViews.length, 'views to hide');
            for(var i = 0; i < allViews.length; i++) {
                allViews[i].style.display = 'none';
            }
            
            // Zeige gewÃ¤hlte View
            var viewId = viewName + 'View';
            var viewEl = document.getElementById(viewId);
            if(viewEl) {
                viewEl.style.display = 'block';
                console.log('SUCCESS: Showed', viewId, '- offsetHeight:', viewEl.offsetHeight);
                if(viewName === 'dashboards') initDashboardTabs();
                
                // Version badge anzeigen
                showModuleVersionBadge(viewName + 'View');
            } else {
                console.error('FAILED: View not found:', viewId);
            }
        }

        function showModuleVersionBadge(viewId) {
            // Entferne altes Badge
            var old = document.getElementById('moduleVersionBadge');
            if(old) old.remove();
            // Finde Modul-Version
            var allMods = getAllModulesFlat();
            var mod = allMods.find(function(m){ return m.view === viewId; });
            if(!mod || !mod.version) return;
            var badge = document.createElement('div');
            badge.id = 'moduleVersionBadge';
            badge.style.cssText = 'position:fixed;bottom:8px;right:8px;z-index:50;background:rgba(255,255,255,0.9);border:1px solid #e5e7eb;border-radius:6px;padding:2px 8px;font-size:10px;color:#9ca3af;font-family:monospace;pointer-events:none;backdrop-filter:blur(4px);';
            badge.textContent = 'v' + mod.version;
            document.body.appendChild(badge);
        }

        // Asana Onboarding Integration
        const ASANA_PROJECT_ID = '1212995737414526'; // Onboarding vit:bikes Partner
        let asanaTasks = [];
        let asanaSections = {};
        
        async function loadAsanaOnboarding() {
            const container = document.getElementById('asanaOnboardingContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vit-orange"></div>
                    <p class="mt-4 text-gray-600 font-semibold">Lade Onboarding-Aufgaben...</p>
                    <p class="mt-2 text-sm text-gray-500">Synchronisiere mit Asana Projekt</p>
                </div>
            `;
            
            // Simuliere kurzes Laden
            setTimeout(() => {
                loadDemoTasks();
                groupTasksBySections();
                renderAsanaTasks();
            }, 800);
        }
        
        
        function loadDemoTasks() {
            // Demo Tasks basierend auf echten Asana Daten
            asanaTasks = [
                // Allgemein - Qualifizierungsphase
                { gid: '1', name: 'Whatsapp-Gruppe beitreten', completed: true, section: 'Allgemein', due_on: null, notes: 'Link zur WhatsApp-Gruppe findest du in der Willkommens-E-Mail', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '2', name: 'Sharepoint Zugang einrichten', completed: true, section: 'Allgemein', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '3', name: 'Vorstellung Teams im BÃ¼ro', completed: false, section: 'Allgemein', due_on: '2026-02-20', assignee: { name: 'Jens Bader' }, notes: 'Kennenlernen der Kollegen im HQ', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '4', name: 'Das vit:bikes Portal kennenlernen', completed: false, section: 'Allgemein', due_on: '2026-02-18', assignee: { name: 'Markus Unger' }, notes: 'EinfÃ¼hrung in alle Features', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '5', name: 'Lizenzvertrag durchgehen', completed: false, section: 'Allgemein', due_on: '2026-02-19', assignee: { name: 'Markus Unger' }, notes: 'Vertragsdetails klÃ¤ren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // vit:bikes basic
                { gid: '10', name: 'Akademie App installieren', completed: true, section: 'vit:bikes basic', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '11', name: 'Module durchgehen', completed: true, section: 'vit:bikes basic', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '12', name: 'Social Media KanÃ¤le folgen', completed: true, section: 'vit:bikes basic', due_on: null, notes: 'Instagram, LinkedIn, Facebook', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '13', name: 'Die Entwicklung des Fahrradmarktes verstehen', completed: false, section: 'vit:bikes basic', due_on: '2026-02-22', notes: 'Video-Kurs in der Akademie', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '14', name: 'Zielgruppe definieren', completed: false, section: 'vit:bikes basic', due_on: '2026-02-24', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Marketing
                { gid: '20', name: 'Willkommen im Marketing-Modul', completed: true, section: 'Marketing', due_on: null, assignee: { name: 'Mike' }, notes: 'EinfÃ¼hrung von Mike', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '21', name: 'Google My Business Profil optimieren', completed: true, section: 'Marketing', due_on: null, notes: 'Schritt-fÃ¼r-Schritt Anleitung befolgen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '22', name: 'Social Media Bestandsaufnahme', completed: true, section: 'Marketing', due_on: null, notes: 'Alle Profile durchgehen und dokumentieren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '23', name: 'Youtube Kanal einrichten', completed: false, section: 'Marketing', due_on: '2026-02-25', assignee: { name: 'Basti Schrecker' }, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '24', name: 'Website Check durchfÃ¼hren', completed: false, section: 'Marketing', due_on: '2026-02-28', notes: 'Performance, SEO, UX prÃ¼fen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '25', name: 'Strategie-Meeting mit Mike', completed: false, section: 'Marketing', due_on: '2026-03-03', assignee: { name: 'Mike' }, notes: 'Marketingstrategie besprechen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Verkauf
                { gid: '30', name: 'Was ist Verkauf?', completed: true, section: 'Verkauf', due_on: null, notes: 'Grundlagen-Video ansehen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '31', name: 'vit:bikes Verkaufsablauf lernen', completed: true, section: 'Verkauf', due_on: null, notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '32', name: 'Die Erfolgstabelle verstehen', completed: true, section: 'Verkauf', due_on: null, notes: 'Tracking-System einfÃ¼hren', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '33', name: '3D-Vermessungssystem Training', completed: false, section: 'Verkauf', due_on: '2026-02-21', notes: 'Praktisches Training vor Ort', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '34', name: 'FahrspaÃŸgarantie verstehen', completed: false, section: 'Verkauf', due_on: '2026-02-26', notes: 'USP von vit:bikes', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '35', name: 'Verkaufstraining fÃ¼r Mitarbeiter', completed: false, section: 'Verkauf', due_on: '2026-03-01', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Einkauf
                { gid: '40', name: 'Willkommen im Einkaufssystem', completed: false, section: 'Einkauf', due_on: '2026-02-19', assignee: { name: 'Florian' }, notes: 'EinfÃ¼hrung von Florian', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '41', name: 'Gemeinsam stark Prinzip verstehen', completed: false, section: 'Einkauf', due_on: '2026-02-23', notes: 'Warum Gruppenvolumen Konditionssprung bedeutet', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '42', name: 'Zentralregulierung erklÃ¤rt', completed: false, section: 'Einkauf', due_on: '2026-02-27', notes: 'IHT statt Bico Prozess', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '43', name: 'Kernsortiment: 7-8 Marken Strategie', completed: false, section: 'Einkauf', due_on: '2026-03-02', notes: 'Fokus auf Kernlieferanten', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '44', name: '4-Marken-Strategie definieren', completed: false, section: 'Einkauf', due_on: '2026-03-05', notes: 'Expertenstatus statt Bauchladen', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Werkstatt
                { gid: '50', name: 'Werkstatt-Prozesse kennenlernen', completed: false, section: 'Werkstatt', due_on: '2026-02-24', notes: '', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '51', name: 'Service-Standards vit:bikes', completed: false, section: 'Werkstatt', due_on: '2026-03-01', notes: 'QualitÃ¤tsrichtlinien', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                
                // Toolbox
                { gid: '60', name: 'Quiply App installieren', completed: false, section: 'Toolbox', due_on: '2026-02-20', notes: 'Interne Kommunikation', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '61', name: 'Todoist einrichten', completed: false, section: 'Toolbox', due_on: '2026-02-22', notes: 'Task Management', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` },
                { gid: '62', name: 'Outlook konfigurieren', completed: false, section: 'Toolbox', due_on: '2026-02-25', notes: 'E-Mail Setup', permalink_url: `https://app.asana.com/0/${ASANA_PROJECT_ID}` }
            ];
        }
        
        function groupTasksBySections() {
            asanaSections = {};
            
            asanaTasks.forEach(task => {
                if (task.memberships && task.memberships.length > 0) {
                    const sectionName = task.memberships[0].section.name;
                    
                    if (!asanaSections[sectionName]) {
                        asanaSections[sectionName] = [];
                    }
                    
                    asanaSections[sectionName].push(task);
                }
            });
        }
        
        function renderAsanaTasks() {
            const container = document.getElementById('asanaOnboardingContent');
            
            // Berechne Gesamt-Fortschritt
            const totalTasks = asanaTasks.length;
            const completedTasks = asanaTasks.filter(t => t.completed).length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            let html = `
                <!-- Header mit Fortschritt -->
                <div class="vit-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="h2-headline text-gray-800">Dein Onboarding-Plan</h2>
                        <a href="https://app.asana.com/0/${ASANA_PROJECT_ID}" target="_blank" class="text-sm text-vit-orange hover:underline font-semibold">
                            In Asana Ã¶ffnen â†’
                        </a>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-6">Live synchronisiert mit Asana â€¢ ${totalTasks} Aufgaben</p>

                    <!-- Gesamt-Fortschritt -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Gesamt-Fortschritt</span>
                            <span class="text-sm font-semibold text-vit-orange">${progress}% (${completedTasks}/${totalTasks})</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-vit-orange h-3 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Wichtige Sections die wir anzeigen wollen
            const sectionsToShow = [
                'Allgemein',
                'vit:bikes basic',
                'Marketing', 
                'Verkauf',
                'Einkauf',
                'Werkstatt',
                'Toolbox'
            ];
            
            sectionsToShow.forEach(sectionName => {
                if (asanaSections[sectionName]) {
                    html += renderSection(sectionName, asanaSections[sectionName]);
                }
            });
            
            container.innerHTML = html;
        }
        
        function renderSection(sectionName, tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const sectionProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Filter out separator tasks (those starting with --)
            const realTasks = tasks.filter(t => !t.name.startsWith('--'));
            
            if (realTasks.length === 0) return '';
            
            return `
                <div class="vit-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            ${getSectionIcon(sectionName)}
                            <span class="ml-2">${sectionName}</span>
                            <span class="ml-3 text-sm font-normal text-gray-500">${completedTasks}/${totalTasks}</span>
                        </h3>
                        <div class="text-sm font-semibold ${sectionProgress === 100 ? 'text-green-600' : 'text-vit-orange'}">
                            ${sectionProgress}%
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="bg-vit-orange h-2 rounded-full transition-all duration-500" style="width: ${sectionProgress}%"></div>
                    </div>
                    
                    <div class="space-y-2">
                        ${realTasks.map(task => renderTask(task)).join('')}
                    </div>
                </div>
            `;
        }
        
        function getSectionIcon(sectionName) {
            const icons = {
                'Allgemein': 'ðŸ“‹',
                'vit:bikes basic': 'ðŸŽ“',
                'Marketing': 'ðŸ“¢',
                'Verkauf': 'ðŸŽ¯',
                'Einkauf': 'ðŸ›’',
                'Werkstatt': 'ðŸ”§',
                'Toolbox': 'ðŸ› ï¸',
                'Mitarbeiter/Team': 'ðŸ‘¥'
            };
            return `<span class="text-2xl">${icons[sectionName] || 'ðŸ“Œ'}</span>`;
        }
        
        function renderTask(task) {
            const isCompleted = task.completed;
            const dueDate = task.due_on ? new Date(task.due_on).toLocaleDateString('de-DE') : null;
            const assignee = task.assignee ? task.assignee.name : null;
            
            return `
                <div class="flex items-start space-x-3 p-3 ${isCompleted ? 'bg-green-50' : 'bg-white border border-gray-200'} rounded-lg hover:shadow-sm transition-shadow">
                    <input 
                        type="checkbox" 
                        ${isCompleted ? 'checked' : ''} 
                        onchange="toggleTaskCompletion('${task.gid}', this.checked)"
                        class="w-5 h-5 mt-0.5 text-vit-orange rounded cursor-pointer"
                    >
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <span class="text-sm ${isCompleted ? 'text-gray-500 line-through' : 'text-gray-700 font-medium'}">
                                ${task.name}
                            </span>
                            ${dueDate || assignee ? `
                                <div class="flex items-center space-x-2 ml-2">
                                    ${dueDate ? `<span class="text-xs text-gray-500">ðŸ“… ${dueDate}</span>` : ''}
                                    ${assignee ? `<span class="text-xs text-gray-500">ðŸ‘¤ ${assignee}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${task.notes ? `
                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">${task.notes}</p>
                        ` : ''}
                    </div>
                    <a href="${task.permalink_url}" target="_blank" class="text-gray-400 hover:text-vit-orange">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>
            `;
        }
        
        async function toggleTaskCompletion(taskGid, completed) {
            try {
                // Optimistic UI Update
                const task = asanaTasks.find(t => t.gid === taskGid);
                if (task) {
                    task.completed = completed;
                    renderAsanaTasks();
                }
                
                // Update in Asana via MCP
                const response = await fetch('/api/asana/task/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_id: taskGid,
                        completed: completed
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update task');
                }
                
                // Show success feedback
                showNotification(completed ? 'âœ… Aufgabe abgeschlossen!' : 'â†©ï¸ Aufgabe reaktiviert', 'success');
                
            } catch (error) {
                console.error('Error updating task:', error);
                
                // Revert optimistic update
                const task = asanaTasks.find(t => t.gid === taskGid);
                if (task) {
                    task.completed = !completed;
                    renderAsanaTasks();
                }
                
                showNotification('âŒ Fehler beim Aktualisieren', 'error');
            }
        }
        
        
        // Verkaufserfolg Tracking Functions
        function updateSalesData() {
            const planned = parseInt(document.getElementById('plannedInput').value) || 0;
            const spontaneous = parseInt(document.getElementById('spontaneousInput').value) || 0;
            const online = parseInt(document.getElementById('onlineInput').value) || 0;
            const ergo = parseInt(document.getElementById('ergoInput').value) || 0;
            const sales = parseInt(document.getElementById('salesInput').value) || 0;
            
            // Berechne Gesamt-Beratungen
            const totalConsultations = planned + spontaneous + online;
            
            // Berechne Quote
            const quote = totalConsultations > 0 ? Math.round((sales / totalConsultations) * 100) : 0;
            
            // Update Display
            document.getElementById('totalConsultations').textContent = totalConsultations;
            document.getElementById('quoteDisplay').textContent = quote + '%';
            
            // FÃ¤rbe Quote je nach Performance
            const quoteElement = document.getElementById('quoteDisplay');
            if (quote >= 40) {
                quoteElement.className = 'text-2xl font-bold text-green-600';
            } else if (quote >= 25) {
                quoteElement.className = 'text-2xl font-bold text-blue-600';
            } else {
                quoteElement.className = 'text-2xl font-bold text-orange-600';
            }
        }
        
        function saveSalesData() {
            var salesperson = document.getElementById('salesPersonSelect').value;
            var planned = document.getElementById('plannedInput').value;
            var spontaneous = document.getElementById('spontaneousInput').value;
            var online = document.getElementById('onlineInput').value;
            var ergo = document.getElementById('ergoInput').value;
            
            // Show success feedback
            var btn = event && event.target ? event.target : null;
            if(btn) {
                var orig = btn.innerHTML;
                btn.innerHTML = 'âœ… Gespeichert!';
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-vit-orange');
                setTimeout(function(){ btn.innerHTML = orig; btn.classList.remove('bg-green-500'); btn.classList.add('bg-vit-orange'); }, 2000);
            }
        }
    

        // ============================================================
        // === VERKAUFSTRAINING KI ENGINE (Local Simulation) ===
        // ============================================================

        var TRAIN_SCENARIOS = [
            {
                id:'ebike_beratung', title:'E-Bike Erstberatung', icon:'ðŸš²', difficulty:'Einsteiger', diffColor:'#059669',
                desc:'Kunde interessiert sich fÃ¼r ein E-Bike, ist unsicher und braucht Beratung.',
                opener:'Hallo! Ich schau mich mal ein bisschen um... Ich Ã¼berlege mir eventuell ein E-Bike anzuschaffen, aber ich bin mir noch nicht so sicher.',
                criteria:['Bedarfsermittlung','Produktwissen','Einwandbehandlung','Abschlusstechnik','Kundenfreundlichkeit'],
                customer:'Thomas MÃ¼ller, 52 Jahre, Pendler (12km), Budget 3-4k',
                responses:[
                    {phase:'start', triggers:['willkommen','hallo','guten tag','herzlich','grÃ¼ÃŸ','schÃ¶n dass','freut mich','kann ich','darf ich','helfen','beratung','was suchen'],
                     replies:['Danke! Ja, ich pendel jeden Tag 12 Kilometer zur Arbeit und dachte, vielleicht wÃ¤re ein E-Bike eine Alternative zum Auto.','Danke, ja genau. Ich fahre tÃ¤glich zur Arbeit, so 12 Kilometer einfach. Da kam mir die Idee mit dem E-Bike.'],
                     score:{kundenfreundlichkeit:15}},
                    {phase:'bedarf', triggers:['wie weit','strecke','kilometer','wohin','wofÃ¼r','nutzen','fahren','pendel','alltag','einsatz','gelÃ¤nde','stadt','weg','route'],
                     replies:['Also hauptsÃ¤chlich fÃ¼r den Arbeitsweg. 12 Kilometer einfach, grÃ¶ÃŸtenteils Radweg, ein paar Steigungen sind dabei. Und am Wochenende vielleicht mal eine Tour mit meiner Frau.','Der Arbeitsweg ist 12km, relativ flach mit zwei kleinen HÃ¼geln. Gibt es da einen groÃŸen Unterschied bei den Motoren?'],
                     score:{bedarfsermittlung:20}},
                    {phase:'budget', triggers:['budget','preis','kosten','ausgeben','vorstellung','preislich','investieren','preisklasse','euro','geld','wert'],
                     replies:['So zwischen 3.000 und 4.000 Euro hatte ich mir gedacht. Ist das realistisch fÃ¼r ein gutes E-Bike?','Hmm, ich hatte so an 3.000 bis 4.000 gedacht. Kriegt man da was VernÃ¼nftiges?'],
                     score:{bedarfsermittlung:15}},
                    {phase:'produkt', triggers:['motor','bosch','shimano','akku','reichweite','watt','nm','drehmoment','antrieb','mittelmotor','hinterrad','schaltung','gang','bremse','federung','rahmen','gewicht','kilo'],
                     replies:['Bosch kenne ich vom HÃ¶ren. Wie weit kommt man denn mit einer Akkuladung? Meine Strecke ist ja 24km hin und zurÃ¼ck.','Das klingt schon gut. Und wie ist das mit der Reichweite? Ich will nicht auf halber Strecke stehen bleiben!'],
                     score:{produktwissen:20}},
                    {phase:'einwand_akku', triggers:['reichweite','laden','akku','batterie','strom','ladezeit','km','kilometer','weit','laden'],
                     replies:['80 bis 120 Kilometer? Das reicht ja locker fÃ¼r die ganze Woche! Muss man den Akku komplett leerfahren oder kann man auch zwischendurch laden?','Ok, das beruhigt mich. Wie lange hÃ¤lt so ein Akku eigentlich, bevor man ihn tauschen muss?'],
                     score:{einwandbehandlung:15}},
                    {phase:'einwand_diebstahl', triggers:['diebstahl','sicher','schloss','versicherung','stehlen','abschlieÃŸen','geklaut','angst','keller','garage','dieb'],
                     replies:['Ja, das ist bei mir ein groÃŸes Thema. Bei der Arbeit steht das Rad drauÃŸen. Was empfehlen Sie da?','Guter Punkt! Auf der Arbeit gibt es nur einen normalen FahrradstÃ¤nder drauÃŸen. Gibt es gute SchlÃ¶sser oder eine Versicherung?'],
                     score:{einwandbehandlung:20}},
                    {phase:'probefahrt', triggers:['probefahrt','testen','ausprobieren','mal drauf','fahren','sitzen','test','probe','aufsteigen','mal setzen'],
                     replies:['Ja, sehr gerne! Das wÃ¼rde mir die Entscheidung bestimmt leichter machen.','Probefahrt wÃ¤re super! Dann merke ich ja, ob mir das FahrgefÃ¼hl taugt.'],
                     score:{abschlusstechnik:20}},
                    {phase:'vergleich', triggers:['unterschied','vergleich','besser','oder','modell','empfehl','welches','tipp','vorschlag','favorit','top','best'],
                     replies:['Und was wÃ¼rden Sie mir konkret empfehlen? Also welches Modell fÃ¼r meinen Einsatz?','Haben Sie einen persÃ¶nlichen Favoriten fÃ¼r Pendler in meiner Preisklasse?'],
                     score:{produktwissen:15}},
                    {phase:'abschluss', triggers:['bestellen','kaufen','nehmen','haben','reservieren','lieferzeit','verfÃ¼gbar','mitnehmen','wann','finanzierung','leasing','jobrad'],
                     replies:['Das klingt wirklich gut. Wie sieht es mit der VerfÃ¼gbarkeit aus? Und bieten Sie auch Finanzierung an?','Ich bin ziemlich Ã¼berzeugt. Gibt es die MÃ¶glichkeit, das Ã¼ber JobRad zu machen? Mein Arbeitgeber bietet das an.'],
                     score:{abschlusstechnik:25}},
                    {phase:'positiv', triggers:['gut','super','toll','klasse','prima','perfekt','genau','richtig','stimmt','interessant','klingt gut','spannend'],
                     replies:['Ja, das klingt wirklich Ã¼berzeugend. Haben Sie noch weitere Tipps fÃ¼r E-Bike-Einsteiger?','Super, danke fÃ¼r die Info! Was sollte ich noch wissen, bevor ich mich entscheide?'],
                     score:{kundenfreundlichkeit:10}},
                    {phase:'negativ', triggers:['teuer','viel geld','Ã¼berlegen','nochmal drÃ¼ber','frau fragen','weiÃŸ nicht','unsicher','schwierig','hmm','naja'],
                     replies:['Hmm, das ist schon eine Menge Geld. Lohnt sich das wirklich gegenÃ¼ber dem Auto?','Ich muss da nochmal drÃ¼ber nachdenken. Kann ich ein Angebot mitnehmen?'],
                     score:{}},
                    {phase:'default', triggers:[],
                     replies:['KÃ¶nnen Sie mir dazu noch etwas mehr erzÃ¤hlen?','Das ist interessant. Was genau meinen Sie damit?','Verstehe. Und was empfehlen Sie da konkret?'],
                     score:{}}
                ]
            },
            {
                id:'premium_upgrade', title:'Premium-Upgrade', icon:'ðŸ’Ž', difficulty:'Fortgeschritten', diffColor:'#D97706',
                desc:'Stammkundin will ihr 3 Jahre altes E-Bike ersetzen. Chance fÃ¼r ein Upgrade!',
                opener:'Hi! Ich war vor drei Jahren schon mal bei euch und hab mein Trekking-Bike hier gekauft. Jetzt brauch ich was Neues, der Akku macht langsam schlapp.',
                criteria:['Kundenhistorie nutzen','Upselling-Technik','Mehrwert-Argumentation','Vergleichskompetenz','Kundenbindung'],
                customer:'Sabine Koch, 44 Jahre, erfahrene Fahrerin (5000km/Jahr)',
                responses:[
                    {phase:'start', triggers:['willkommen','schÃ¶n','wieder','erinnere','damals','freut','toll dass','zurÃ¼ck'],
                     replies:['Ja, damals war ich super zufrieden mit der Beratung! Das Bike hat mir drei Jahre gute Dienste geleistet. Aber jetzt merke ich den Akku doch deutlich.'],
                     score:{kundenhistorie:20}},
                    {phase:'bedarf', triggers:['was fahren','strecke','nutzen','wofÃ¼r','wie viel','kilometer','akku problem','defekt'],
                     replies:['Ich fahre so 5.000 Kilometer im Jahr, hauptsÃ¤chlich Touren und den Arbeitsweg. Beim alten Bike schafft der Akku nur noch 60km statt der ursprÃ¼nglichen 100.'],
                     score:{kundenhistorie:15}},
                    {phase:'upgrade', triggers:['neu','technologie','besser','weiterentwickl','fortschritt','generation','upgrade','verbessert','modern'],
                     replies:['Oh wirklich? Was hat sich denn in den drei Jahren so getan? Mein altes hat noch den Bosch Performance Line.'],
                     score:{upselling:20}},
                    {phase:'premium', triggers:['premium','hochwertig','top','spitzen','leicht','carbon','vollausstattung','extra','beste'],
                     replies:['Das klingt schon verlockend, aber brauche ich wirklich die Premium-Variante? Was ist der konkrete Vorteil gegenÃ¼ber der Mittelklasse?'],
                     score:{mehrwert:20,upselling:15}},
                    {phase:'vergleich', triggers:['unterschied','vergleich','versus','statt','gegenÃ¼ber','besser als','dein altes','modell'],
                     replies:['Ok, also mehr Reichweite und leichter. Wie viel mehr kostet die Premium-Variante gegenÃ¼ber dem vergleichbaren Mittelklasse-Modell?'],
                     score:{vergleichskompetenz:20}},
                    {phase:'preis', triggers:['preis','kosten','euro','budget','invest','teuer','wert','lohnt','amortis'],
                     replies:['Hmm, 4.500 Euro ist schon ein Sprung nach oben. Kann man das irgendwie finanzieren? Und was wÃ¼rde ich fÃ¼r mein altes Bike noch bekommen?'],
                     score:{upselling:10}},
                    {phase:'inzahlung', triggers:['altes bike','inzahlung','tausch','eintausch','ankauf','gebraucht','zurÃ¼cknehmen','alt gegen neu'],
                     replies:['Inzahlung? Das wÃ¤re natÃ¼rlich super! Dann relativiert sich der Preis ja. Was wÃ¤re mein altes Bike noch wert?'],
                     score:{kundenbindung:20}},
                    {phase:'abschluss', triggers:['bestellen','kaufen','nehmen','probefahrt','test','probieren','entschieden','will','hÃ¤tte gern'],
                     replies:['Ich bin ehrlich gesagt ziemlich Ã¼berzeugt. Kann ich eine Probefahrt machen, um den Unterschied selbst zu spÃ¼ren?'],
                     score:{upselling:15,kundenbindung:15}},
                    {phase:'default', triggers:[],
                     replies:['KÃ¶nnen Sie mir das etwas genauer erklÃ¤ren?','Interessant. Wie schlÃ¤gt sich das im Vergleich zu meinem aktuellen Bike?','Und was sagen Ihre anderen Kunden dazu?'],
                     score:{}}
                ]
            },
            {
                id:'reklamation', title:'Schwieriger Kunde', icon:'ðŸ˜¤', difficulty:'Experte', diffColor:'#DC2626',
                desc:'Unzufriedener Kunde mit Reklamation. E-Bike hat nach 4 Monaten einen Defekt.',
                opener:'So, ich bin jetzt zum zweiten Mal hier wegen dem Problem. Mein E-Bike ist vier Monate alt und der Motor spinnt schon wieder. Beim Anruf letzte Woche hat mir niemand geholfen!',
                criteria:['Empathie zeigen','Deeskalation','LÃ¶sungsorientierung','Verbindlichkeit','Kundenzufriedenheit'],
                customer:'Frank Weber, 38 Jahre, verÃ¤rgert, E-Bike 4 Monate alt (3800â‚¬)',
                responses:[
                    {phase:'empathie', triggers:['versteh','tut mir','entschuldig','nachvollzieh','Ã¤rger','verstÃ¤nd','sorry','schlimm','unangenehm','bedauer'],
                     replies:['Na immerhin nimmt mich hier mal jemand ernst. Aber ich bin trotzdem sauer. Das Bike hat fast 4.000 Euro gekostet!','Ok... Danke. Aber was passiert jetzt konkret? Ich brauche das Bike fÃ¼r den Arbeitsweg.'],
                     score:{empathie:25,deeskalation:15}},
                    {phase:'problem', triggers:['was genau','problem','sympto','beschreib','erzÃ¤hl','wann','wie Ã¤uÃŸert','gerÃ¤usch','motor','defekt','fehler','passiert'],
                     replies:['Der Motor macht ein komisches Klacken und schaltet sich manchmal einfach ab. Mitten auf der StraÃŸe! Das ist doch gefÃ¤hrlich!','Beim Anfahren klackt es laut und ab 20 km/h schaltet die UnterstÃ¼tzung manchmal einfach aus. Das passiert seit zwei Wochen.'],
                     score:{loesungsorientierung:15}},
                    {phase:'loesung', triggers:['werkstatt','reparatur','lÃ¶sung','beheben','sofort','schnell','termin','prÃ¼fen','diagnose','tauschen','ersatz','garantie','gewÃ¤hrleist'],
                     replies:['Garantie ist klar, aber wie lange dauert die Reparatur? Ich kann nicht wochenlang ohne Bike sein!','Ok, und wenn es lÃ¤nger dauert? Bekomme ich dann ein Leihrad? Ich bin auf das Bike angewiesen.'],
                     score:{loesungsorientierung:20,verbindlichkeit:15}},
                    {phase:'leihrad', triggers:['leihrad','leih','ersatzrad','Ã¼bergangs','zwischenzei','Ã¼berbrÃ¼ck','alternative','solange'],
                     replies:['Ein Leihrad? Das wÃ¤re natÃ¼rlich super. Dann kann ich damit leben. Wann kÃ¶nnte ich das abholen?','Ok, das ist fair. Wann steht das Leihrad bereit und wie lange wird die Reparatur dauern?'],
                     score:{kundenzufriedenheit:20,verbindlichkeit:15}},
                    {phase:'termin', triggers:['morgen','Ã¼bermorgen','diese woche','termin','wann','zeitplan','abhol','bringen','vorbeikommen','montag','dienstag'],
                     replies:['Morgen wÃ¤re gut. Kann ich das Bike morgen frÃ¼h vorbeibringen und direkt das Leihrad mitnehmen?','Diese Woche noch? Ok, das geht in Ordnung. Dann komme ich morgen.'],
                     score:{verbindlichkeit:20}},
                    {phase:'eskalation', triggers:['anwalt','bewertung','google','facebook','melden','verbraucherschutz','schlecht','unverschÃ¤mt','frechheit','skandal'],
                     replies:['HÃ¶ren Sie, ich will mich nicht streiten. Ich will nur, dass mein Bike funktioniert. KÃ¶nnen wir das jetzt klÃ¤ren?','Ich will keine schlechte Bewertung schreiben mÃ¼ssen. Geben Sie mir einfach eine vernÃ¼nftige LÃ¶sung.'],
                     score:{}},
                    {phase:'zufrieden', triggers:['danke','ok','gut','fair','einverstanden','passt','akzeptier','annehm','klingt gut'],
                     replies:['Gut, danke. Dann machen wir das so. Entschuldigung, dass ich vorhin etwas laut war. Aber Sie verstehen das sicher.','Ok, das klingt fair. Schreiben Sie mir das bitte noch als BestÃ¤tigung auf? Dann sind wir uns einig.'],
                     score:{kundenzufriedenheit:20,deeskalation:10}},
                    {phase:'default', triggers:[],
                     replies:['Ja und? Was machen wir jetzt?','Das hilft mir jetzt nicht weiter. Was ist der konkrete nÃ¤chste Schritt?','KÃ¶nnen wir bitte zum Punkt kommen?'],
                     score:{}}
                ]
            },
            {
                id:'family', title:'Familienberatung', icon:'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', difficulty:'Einsteiger', diffColor:'#059669',
                desc:'Familie mÃ¶chte FahrrÃ¤der fÃ¼r alle. Verschiedene WÃ¼nsche und BedÃ¼rfnisse.',
                opener:'Guten Tag! Wir sind die Familie Berger. Wir wollen uns alle mit neuen FahrrÃ¤dern ausstatten - meine Frau, meine Tochter und ich. Wo fangen wir am besten an?',
                criteria:['Mehrpersonen-Beratung','Budgetberatung','Angst nehmen','Paketangebot','Familienfreundlichkeit'],
                customer:'Martin Berger (41), Frau Lisa (39, unsicher), Tochter Emma (12)',
                responses:[
                    {phase:'start', triggers:['willkommen','hallo','schÃ¶n','toll','familie','super','klasse','gemeinsam','zusammen'],
                     replies:['Danke! Ja, wir wollen das jetzt endlich mal anpacken. Emma hat schon ganz hibbelig gefragt, ob sie sich ein Bike aussuchen darf.'],
                     score:{familienfreundlichkeit:15}},
                    {phase:'bedarf', triggers:['wofÃ¼r','nutzen','fahren','wohin','strecke','gelÃ¤nde','touren','alltag','schule','arbeit'],
                     replies:['Also ich will damit zur Arbeit fahren, so 8 Kilometer. Lisa will hauptsÃ¤chlich EinkÃ¤ufe machen und vielleicht Wochenendtouren. Und Emma fÃ¤hrt damit zur Schule und zu Freunden.'],
                     score:{mehrpersonen:20}},
                    {phase:'lisa', triggers:['frau','lisa','partnerin','unsicher','angst','sicher','komfort','bequem','einstieg','tief','aufrecht'],
                     replies:['Ja, Lisa ist da etwas nervÃ¶s... Sie ist seit 10 Jahren nicht mehr gefahren. Lisa sagt gerade, sie hÃ¤tte gerne einen tiefen Einstieg und aufrechtes Sitzen. Und bitte nicht so schnell!'],
                     score:{angst:20,mehrpersonen:10}},
                    {phase:'emma', triggers:['tochter','emma','kind','mÃ¤dchen','jugend','cool','farbe','schule','12','grÃ¶ÃŸe'],
                     replies:['Emma ist 12 und ungefÃ¤hr 1,52 Meter groÃŸ. Sie hÃ¤tte das Rad gerne in TÃ¼rkis oder Mint. Und es MUSS cool aussehen, sagt sie. Ihre Freundinnen haben auch neue RÃ¤der.'],
                     score:{familienfreundlichkeit:15}},
                    {phase:'budget', triggers:['budget','preis','kosten','gesamt','zusammen','paket','rabatt','sparen','angebot','alles zusammen'],
                     replies:['Insgesamt hatten wir so an 4.000 bis maximal 6.000 Euro gedacht fÃ¼r alle drei. Geht das? Gibt es einen Familienrabatt?'],
                     score:{budgetberatung:20}},
                    {phase:'paket', triggers:['paket','bundle','zusammen','komplett','set','alles','drei rÃ¤der','familien'],
                     replies:['Ein Familienpaket? Das klingt gut! Was wÃ¼rde denn da alles reingehÃ¶ren? Helme und SchlÃ¶sser auch?'],
                     score:{paketangebot:25}},
                    {phase:'zubehoer', triggers:['helm','schloss','licht','korb','tasche','zubehÃ¶r','satteltasche','gepÃ¤ck','klingel','stÃ¤nder'],
                     replies:['Stimmt, Helme brauchen wir auch alle drei neue. Und Lisa hÃ¤tte gerne einen Korb vorne. KÃ¶nnen Sie da was zusammenstellen?'],
                     score:{paketangebot:15}},
                    {phase:'probefahrt', triggers:['probefahrt','test','ausprobieren','sitzen','fahren','mal drauf','probieren'],
                     replies:['Oh ja! KÃ¶nnen wir alle drei eine Probefahrt machen? Lisa will unbedingt vorher testen, ob sie sich sicher fÃ¼hlt.'],
                     score:{angst:15,familienfreundlichkeit:10}},
                    {phase:'abschluss', triggers:['bestellen','kaufen','nehmen','entschieden','kauf','paket','machen wir','lieferung','wann','abholen'],
                     replies:['Das klingt nach einem super Plan! KÃ¶nnen Sie uns das Angebot aufschreiben? Dann besprechen wir es kurz und entscheiden uns.'],
                     score:{paketangebot:10,budgetberatung:10}},
                    {phase:'default', triggers:[],
                     replies:['Das mÃ¼sste ich kurz mit meiner Frau besprechen... Lisa, was meinst du?','Interessant! Emma, hast du das gehÃ¶rt? Wie findest du das?','KÃ¶nnen Sie uns noch mehr dazu erzÃ¤hlen?'],
                     score:{}}
                ]
            }
        ];

        var tState = { active:false, scenario:null, messages:[], timer:0, timerInterval:null, recognition:null, isListening:false, isSpeaking:false, usedPhases:[], scores:{} };

        function initTrainingModule() {
            var grid = document.getElementById('trainingScenarios');
            if(!grid) return;
            var h = '';
            TRAIN_SCENARIOS.forEach(function(sc) {
                h += '<div class="vit-card t-scenario-card p-5" onclick="startTraining(\''+sc.id+'\')">';
                h += '<div class="flex items-start gap-3">';
                h += '<span class="text-3xl">'+sc.icon+'</span>';
                h += '<div class="flex-1">';
                h += '<div class="flex items-center gap-2 mb-1"><span class="font-bold text-gray-800">'+sc.title+'</span>';
                h += '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full" style="background:'+sc.diffColor+'15;color:'+sc.diffColor+'">'+sc.difficulty+'</span></div>';
                h += '<p class="text-xs text-gray-500 leading-relaxed">'+sc.desc+'</p>';
                h += '<p class="text-[10px] text-gray-400 mt-1 italic">Kunde: '+sc.customer+'</p>';
                h += '</div>';
                h += '<span class="t-card-arrow text-lg" style="color:#EF7D00">â†’</span>';
                h += '</div></div>';
            });
            grid.innerHTML = h;
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) { var w=document.getElementById('trainingSpeechWarn'); if(w) w.classList.remove('hidden'); }
        }

        function getSimulatedResponse(scenario, userMsg) {
            var msg = userMsg.toLowerCase();
            var responses = scenario.responses;
            var bestMatch = null;
            var bestScore = 0;

            for(var i=0; i<responses.length; i++) {
                var r = responses[i];
                if(r.phase === 'default') continue;
                var matchCount = 0;
                for(var t=0; t<r.triggers.length; t++) {
                    if(msg.includes(r.triggers[t])) matchCount++;
                }
                // Bonus for unused phases
                if(matchCount > 0 && tState.usedPhases.indexOf(r.phase) === -1) matchCount += 0.5;
                if(matchCount > bestScore) { bestScore = matchCount; bestMatch = r; }
            }

            if(!bestMatch || bestScore === 0) {
                bestMatch = responses[responses.length-1]; // default
            }

            // Track used phases and scores
            if(bestMatch.phase !== 'default') tState.usedPhases.push(bestMatch.phase);
            if(bestMatch.score) {
                for(var k in bestMatch.score) {
                    tState.scores[k] = (tState.scores[k]||0) + bestMatch.score[k];
                }
            }

            // Pick a random reply from the options
            var replies = bestMatch.replies;
            return replies[Math.floor(Math.random()*replies.length)];
        }

        function generateEvaluation(scenario) {
            var totalMsgs = tState.messages.filter(function(m){return m.role==='seller';}).length;
            var scores = tState.scores;
            var criteria = scenario.criteria;
            var evalResult = {gesamtScore:0, kriterien:[], staerken:[], verbesserungen:[], zusammenfassung:''};

            var total = 0;
            criteria.forEach(function(c) {
                var key = c.toLowerCase().replace(/[Ã¤Ã¶Ã¼ ]/g, function(ch){return{Ã¤:'ae',Ã¶:'oe',Ã¼:'ue',' ':''}[ch]||ch;}).replace(/[-\/]/g,'');
                // Check multiple possible key matches
                var score = 0;
                for(var k in scores) {
                    if(key.includes(k) || k.includes(key.substring(0,6))) score += scores[k];
                }
                score = Math.min(100, Math.max(15, score + (totalMsgs > 3 ? 20 : 0)));
                // Add some variance
                score = Math.min(100, score + Math.floor(Math.random()*15));

                var kommentar = score >= 80 ? 'Sehr gut umgesetzt!' : score >= 60 ? 'Solide Leistung, noch Potenzial.' : score >= 40 ? 'Hier gibt es noch VerbesserungsmÃ¶glichkeiten.' : 'Dieser Bereich wurde kaum abgedeckt.';
                evalResult.kriterien.push({name:c, score:score, kommentar:kommentar});
                total += score;
            });

            evalResult.gesamtScore = Math.round(total / criteria.length);

            // Staerken (high scores)
            var sorted = evalResult.kriterien.slice().sort(function(a,b){return b.score-a.score;});
            sorted.slice(0,2).forEach(function(k) {
                if(k.score >= 50) evalResult.staerken.push(k.name + ' (' + k.score + '/100)');
            });
            if(evalResult.staerken.length===0) evalResult.staerken.push('GesprÃ¤ch wurde gefÃ¼hrt');
            if(totalMsgs >= 5) evalResult.staerken.push('Ausreichend GesprÃ¤chstiefe');

            // Verbesserungen (low scores)
            sorted.slice(-2).forEach(function(k) {
                if(k.score < 70) evalResult.verbesserungen.push(k.name + ' stÃ¤rker fokussieren');
            });
            if(tState.usedPhases.length < 4) evalResult.verbesserungen.push('Mehr verschiedene GesprÃ¤chsaspekte abdecken');
            if(totalMsgs < 4) evalResult.verbesserungen.push('LÃ¤ngere GesprÃ¤che fÃ¼hren fÃ¼r bessere Ergebnisse');

            var gs = evalResult.gesamtScore;
            evalResult.zusammenfassung = gs >= 80
                ? 'Hervorragende Beratung! Du hast den Kunden gut abgeholt, auf seine BedÃ¼rfnisse eingegangen und ein Ã¼berzeugendes GesprÃ¤ch gefÃ¼hrt.'
                : gs >= 60
                ? 'Solide Beratung mit guten AnsÃ¤tzen. Einige Bereiche kÃ¶nnen noch vertieft werden, um den Kunden noch besser zu Ã¼berzeugen.'
                : gs >= 40
                ? 'Das GesprÃ¤ch hatte Potenzial, aber wichtige Beratungsaspekte wurden nicht ausreichend abgedeckt. Ãœbe gezielt die schwÃ¤cheren Bereiche.'
                : 'Hier ist noch viel Luft nach oben. Versuche, aktiver auf den Kunden einzugehen und alle Beratungsschritte abzudecken.';

            return evalResult;
        }

        function startTraining(scenarioId) {
            var sc = TRAIN_SCENARIOS.find(function(s){ return s.id === scenarioId; });
            if(!sc) return;
            tState = {active:true, scenario:sc, messages:[], timer:0, timerInterval:null, recognition:null, isListening:false, isSpeaking:false, usedPhases:[], scores:{}};
            document.getElementById('trainingMenu').style.display = 'none';
            document.getElementById('trainingEval').style.display = 'none';
            document.getElementById('trainingSession').style.display = '';
            document.getElementById('tSessionIcon').textContent = sc.icon;
            document.getElementById('tSessionTitle').textContent = sc.title;
            document.getElementById('tSessionDiff').textContent = sc.difficulty;
            document.getElementById('tSessionHint').textContent = sc.desc;
            document.getElementById('tChatMessages').innerHTML = '';
            document.getElementById('tEndBtn').disabled = true;
            document.getElementById('tEndBtn').textContent = 'Beenden & Bewerten';
            clearInterval(tState.timerInterval);
            tState.timerInterval = setInterval(function() {
                tState.timer++;
                var el = document.getElementById('tSessionTimer');
                if(el) el.textContent = Math.floor(tState.timer/60)+':'+String(tState.timer%60).padStart(2,'0');
            }, 1000);
            tState.messages.push({role:'customer',text:sc.opener});
            renderTrainingMessages();
            speakTraining(sc.opener);
        }

        function renderTrainingMessages() {
            var el = document.getElementById('tChatMessages');
            if(!el) return;
            var h = '';
            tState.messages.forEach(function(m) {
                if(m.role === 'customer') {
                    h += '<div class="t-msg-customer"><p class="t-msg-label" style="color:#6b7280">'+tState.scenario.icon+' Kunde</p><p class="t-msg-text">'+m.text+'</p></div>';
                } else {
                    h += '<div class="t-msg-seller"><p class="t-msg-label" style="color:#EF7D00">ðŸ§‘â€ðŸ’¼ Du (VerkÃ¤ufer)</p><p class="t-msg-text">'+m.text+'</p></div>';
                }
            });
            el.innerHTML = h;
            el.scrollTop = el.scrollHeight;
            if(tState.messages.length >= 4) document.getElementById('tEndBtn').disabled = false;
        }

        function speakTraining(text) {
            if(!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            var utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'de-DE';
            utt.rate = 1.0;
            var voices = window.speechSynthesis.getVoices();
            var deVoice = voices.find(function(v){ return v.lang.startsWith('de'); });
            if(deVoice) utt.voice = deVoice;
            tState.isSpeaking = true;
            showTrainingWave(true, false);
            utt.onend = function() { tState.isSpeaking = false; hideTrainingWave(); };
            utt.onerror = function() { tState.isSpeaking = false; hideTrainingWave(); };
            window.speechSynthesis.speak(utt);
        }

        function showTrainingWave(speaking, listening) {
            var el = document.getElementById('tWaveform');
            var label = document.getElementById('tWaveLabel');
            if(!el) return;
            el.classList.remove('hidden');
            if(listening) {
                el.style.background = 'rgba(239,125,0,0.05)';
                if(label) { label.textContent = 'ðŸŽ¤ HÃ¶rt zu...'; label.style.color = '#EF7D00'; }
            } else {
                el.style.background = 'rgba(59,130,246,0.05)';
                if(label) { label.textContent = 'ðŸ”Š Kunde spricht...'; label.style.color = '#3b82f6'; }
            }
            var bars = document.getElementById('tWaveBars');
            if(bars) {
                var bh = '';
                for(var i=0;i<24;i++) bh += '<div style="width:3px;border-radius:2px;background:'+(listening?'#EF7D00':'#3b82f6')+';height:4px;transition:height 0.12s" class="t-wave-bar"></div>';
                bars.innerHTML = bh;
                animateTrainingWave();
            }
        }

        var tWaveAnimId = null;
        function animateTrainingWave() {
            clearInterval(tWaveAnimId);
            tWaveAnimId = setInterval(function() {
                document.querySelectorAll('.t-wave-bar').forEach(function(b) {
                    b.style.height = (tState.isListening || tState.isSpeaking) ? (Math.random()*24+4)+'px' : '4px';
                });
            }, 100);
        }
        function hideTrainingWave() {
            var el = document.getElementById('tWaveform');
            if(el) el.classList.add('hidden');
            clearInterval(tWaveAnimId);
        }

        function toggleTrainingMic() {
            if(tState.isListening) return;
            if(tState.isSpeaking) { window.speechSynthesis.cancel(); tState.isSpeaking = false; hideTrainingWave(); }
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) { showToast('Spracherkennung nicht verfÃ¼gbar','warning'); return; }
            var recognition = new SR();
            recognition.lang = 'de-DE';
            recognition.interimResults = true;
            recognition.continuous = true;
            tState.recognition = recognition;
            tState.isListening = true;
            var finalT = '';
            recognition.onresult = function(e) {
                var interim = '';
                for(var i=e.resultIndex;i<e.results.length;i++) {
                    if(e.results[i].isFinal) finalT += e.results[i][0].transcript + ' ';
                    else interim += e.results[i][0].transcript;
                }
                var full = (finalT + interim).trim();
                var el = document.getElementById('tTranscript');
                if(el && full) { el.classList.remove('hidden'); el.textContent = '"' + full + '"'; }
            };
            recognition.onerror = function() { tState.isListening = false; resetTrainingInput(); hideTrainingWave(); };
            recognition.onend = function() { tState.isListening = false; };
            recognition.start();
            showTrainingWave(false, true);
            document.getElementById('tMicBtn').classList.add('hidden');
            document.getElementById('tSendMicBtn').classList.remove('hidden');
            document.getElementById('tInputHint').textContent = 'Sprich jetzt... DrÃ¼cke âœ“ zum Senden';
        }

        function sendTrainingVoice() {
            if(tState.recognition) { tState.recognition.stop(); tState.recognition = null; }
            tState.isListening = false;
            hideTrainingWave();
            var el = document.getElementById('tTranscript');
            var text = el ? el.textContent.replace(/^"|"$/g,'').trim() : '';
            if(el) el.classList.add('hidden');
            resetTrainingInput();
            if(!text) return;
            processTrainingMessage(text);
        }

        function sendTrainingText() {
            var inp = document.getElementById('tTextInput');
            var text = inp ? inp.value.trim() : '';
            if(!text) return;
            inp.value = '';
            var btn = document.getElementById('tSendTextBtn');
            if(btn) btn.classList.add('hidden');
            processTrainingMessage(text);
        }

        document.addEventListener('input', function(e) {
            if(e.target && e.target.id === 'tTextInput') {
                var btn = document.getElementById('tSendTextBtn');
                if(btn) btn.classList.toggle('hidden', !e.target.value.trim());
            }
        });

        function resetTrainingInput() {
            var mic = document.getElementById('tMicBtn');
            var send = document.getElementById('tSendMicBtn');
            if(mic) mic.classList.remove('hidden');
            if(send) send.classList.add('hidden');
            var hint = document.getElementById('tInputHint');
            if(hint) hint.textContent = 'DrÃ¼cke ðŸŽ¤ oder tippe deine Antwort';
        }

        function processTrainingMessage(text) {
            tState.messages.push({role:'seller', text:text});
            renderTrainingMessages();

            // Show thinking briefly
            var thinking = document.getElementById('tThinking');
            if(thinking) thinking.classList.remove('hidden');

            // Simulate small delay for realism
            setTimeout(function() {
                if(thinking) thinking.classList.add('hidden');
                var reply = getSimulatedResponse(tState.scenario, text);
                tState.messages.push({role:'customer', text:reply});
                renderTrainingMessages();
                speakTraining(reply);
            }, 800 + Math.random()*700);
        }

        function endTrainingSession() {
            if(tState.recognition) { tState.recognition.stop(); tState.recognition = null; }
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            clearInterval(tState.timerInterval);
            tState.isListening = false;
            tState.isSpeaking = false;
            tState.active = false;
            hideTrainingWave();

            var ev = generateEvaluation(tState.scenario);
            showTrainingEvaluation(ev);
        }

        function showTrainingEvaluation(ev) {
            document.getElementById('trainingSession').style.display = 'none';
            document.getElementById('trainingEval').style.display = '';
            document.getElementById('tEvalTitle').textContent = tState.scenario.title;
            document.getElementById('tEvalMeta').textContent = tState.messages.length + ' Nachrichten â€¢ ' + Math.floor(tState.timer/60)+':'+String(tState.timer%60).padStart(2,'0');
            var score = ev.gesamtScore || 0;
            var svg = document.getElementById('tScoreRing');
            var r=42, circ=2*Math.PI*r, offset=circ-(score/100)*circ;
            var col = score>=80?'#059669':score>=60?'#D97706':'#DC2626';
            svg.innerHTML = '<circle cx="50" cy="50" r="'+r+'" fill="none" stroke="#e5e7eb" stroke-width="5"/><circle cx="50" cy="50" r="'+r+'" fill="none" stroke="'+col+'" stroke-width="5" stroke-dasharray="'+circ+'" stroke-dashoffset="'+offset+'" stroke-linecap="round" style="transform:rotate(-90deg);transform-origin:center;transition:stroke-dashoffset 1s"/><text x="50" y="50" text-anchor="middle" dominant-baseline="central" style="font-size:24px;font-weight:800;fill:'+col+'">'+score+'</text>';
            document.getElementById('tScoreLabel').textContent = score>=80?'Hervorragend! ðŸŒŸ':score>=60?'Gut gemacht! ðŸ‘':'AusbaufÃ¤hig ðŸ’ª';
            document.getElementById('tScoreSummary').textContent = ev.zusammenfassung || '';
            var rings = document.getElementById('tCriteriaRings');
            var details = document.getElementById('tCriteriaDetails');
            var rh='', dh='';
            (ev.kriterien||[]).forEach(function(k) {
                var kc = k.score>=80?'#059669':k.score>=60?'#D97706':'#DC2626';
                var kr=20, kcirc=2*Math.PI*kr, koff=kcirc-(k.score/100)*kcirc;
                rh += '<div class="text-center"><svg width="48" height="48"><circle cx="24" cy="24" r="'+kr+'" fill="none" stroke="#e5e7eb" stroke-width="3"/><circle cx="24" cy="24" r="'+kr+'" fill="none" stroke="'+kc+'" stroke-width="3" stroke-dasharray="'+kcirc+'" stroke-dashoffset="'+koff+'" stroke-linecap="round" style="transform:rotate(-90deg);transform-origin:center;transition:stroke-dashoffset 1s"/><text x="24" y="24" text-anchor="middle" dominant-baseline="central" style="font-size:11px;font-weight:700;fill:'+kc+'">'+k.score+'</text></svg><p class="text-[9px] text-gray-500 font-semibold mt-1" style="max-width:70px">'+k.name+'</p></div>';
                dh += '<div class="p-3 rounded-lg" style="background:#f9fafb"><div class="flex justify-between mb-1"><span class="text-xs font-semibold text-gray-800">'+k.name+'</span><span class="text-xs font-bold" style="color:'+kc+'">'+k.score+'/100</span></div><p class="text-[11px] text-gray-500">'+k.kommentar+'</p></div>';
            });
            if(rings) rings.innerHTML = rh;
            if(details) details.innerHTML = dh;
            var sh='', ih='';
            (ev.staerken||[]).forEach(function(s){ sh += '<p class="text-xs text-gray-600">â€¢ '+s+'</p>'; });
            (ev.verbesserungen||[]).forEach(function(v){ ih += '<p class="text-xs text-gray-600">â€¢ '+v+'</p>'; });
            document.getElementById('tStrengths').innerHTML = sh || '<p class="text-xs text-gray-400">â€”</p>';
            document.getElementById('tImprovements').innerHTML = ih || '<p class="text-xs text-gray-400">â€”</p>';
        }

        function restartTrainingScenario() { if(tState.scenario) startTraining(tState.scenario.id); }
        function backToTrainingMenu() {
            document.getElementById('trainingSession').style.display = 'none';
            document.getElementById('trainingEval').style.display = 'none';
            document.getElementById('trainingMenu').style.display = '';
            document.getElementById('tEndBtn').textContent = 'Beenden & Bewerten';
            initTrainingModule();
        }

        // === REACT PIPELINE MOUNT FUNCTION ===
        var pipelineMounted = false;
        function mountReactPipeline() {
            var root = document.getElementById('react-pipeline-root');
            if(!root) return;
            if(pipelineMounted) return; // Already mounted
            // Wait for Babel to compile
            if(typeof window.__PIPELINE_APP === 'function') {
                ReactDOM.createRoot(root).render(React.createElement(window.__PIPELINE_APP));
                pipelineMounted = true;
            } else {
                // Retry after Babel has compiled
                setTimeout(mountReactPipeline, 200);
            }
        }


</script>

<!-- React Pipeline Component (Babel-compiled JSX) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel" data-type="module">
/* â”€â”€ vit:bikes Deal Flow Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const { useState, useRef, useCallback, useEffect } = React;

const STAGES = [
  { id: "lead", label: "ðŸŽ¯ Leads", color: "#FF6B35", bg: "#FFF3ED", emoji: "ðŸŽ£" },
  { id: "angebot", label: "ðŸ“ Angebot", color: "#667EEA", bg: "#EBF4FF", emoji: "ðŸ’Œ" },
  { id: "schwebend", label: "â³ Schwebend", color: "#F7C948", bg: "#FFFBEA", emoji: "ðŸŽˆ" },
  { id: "verkauft", label: "ðŸŽ‰ Verkauft", color: "#38B2AC", bg: "#E6FFFA", emoji: "ðŸ†" },
  { id: "gold", label: "ðŸ—„ï¸ Schrank der Hoffnung", color: "#D69E2E", bg: "#FFFFF0", emoji: "âœ¨" },
  { id: "lost", label: "ðŸ’€ Verloren", color: "#E53E3E", bg: "#FFF5F5", emoji: "ðŸ˜­" },
];
const PIPELINE = ["lead", "angebot", "schwebend", "verkauft"];
const AGING = { lead: 3, angebot: 5, schwebend: 7 };
const AVATARS = ["ðŸ‘¤","ðŸ‘©","ðŸ‘¨","ðŸ‘©â€ðŸ’¼","ðŸ‘¨â€ðŸ’¼","ðŸ‘©â€ðŸŽ¨","ðŸ‘¨â€ðŸ”§","ðŸ‘©â€âš•ï¸","ðŸ‘¨â€ðŸ³","ðŸ‘©â€ðŸ’»","ðŸ§‘â€ðŸŽ“","ðŸ‘´"];
const ACT_TYPES = [
  { id: "call", label: "ðŸ“ž Anruf", color: "#667EEA" },
  { id: "email", label: "ðŸ“§ E-Mail", color: "#38B2AC" },
  { id: "meeting", label: "â˜• Meeting", color: "#F7C948" },
  { id: "note", label: "ðŸ“ Notiz", color: "#A0AEC0" },
  { id: "whatsapp", label: "ðŸ’¬ WhatsApp", color: "#25D366" },
];
const ACHIEVEMENTS = [
  { id: "first_sale", label: "Erster Verkauf", icon: "ðŸŒŸ", desc: "Dein erster Deal", check: s => s.sold >= 1 },
  { id: "streak3", label: "3er Streak", icon: "ðŸ”¥", desc: "3x hintereinander", check: s => s.streak >= 3 },
  { id: "streak5", label: "5er Streak", icon: "ðŸ’¥", desc: "Unstoppable!", check: s => s.streak >= 5 },
  { id: "10k", label: "10K Club", icon: "ðŸ’°", desc: "â‚¬10k Umsatz", check: s => s.rev >= 10000 },
  { id: "50k", label: "50K Club", icon: "ðŸ’Ž", desc: "â‚¬50k Umsatz", check: s => s.rev >= 50000 },
  { id: "100k", label: "100K Club", icon: "ðŸ‘‘", desc: "Legende!", check: s => s.rev >= 100000 },
  { id: "machine", label: "Deal Machine", icon: "âš™ï¸", desc: "10 Deals erstellt", check: s => s.total >= 10 },
  { id: "hot", label: "Heisse Hand", icon: "âœ‹", desc: "5x Heat 5", check: s => s.hot >= 5 },
  { id: "golddig", label: "HoffnungstrÃ¤ger", icon: "â›ï¸", desc: "3 Hoffnungs-Kontakte", check: s => s.gold >= 3 },
  { id: "active", label: "Aktiver Seller", icon: "ðŸƒ", desc: "20 AktivitÃ¤ten", check: s => s.acts >= 20 },
];
const LOCATIONS = [
  { id: "hq", label: "ðŸ¢ HQ (Alle)", isHQ: true },
  { id: "berlin", label: "ðŸ“ Berlin" },
  { id: "muenchen", label: "ðŸ“ MÃ¼nchen" },
  { id: "hamburg", label: "ðŸ“ Hamburg" },
];

const SELLERS = [
  { id: "max", name: "Max Weber", short: "MW", color: "#667EEA", loc: "berlin" },
  { id: "julia", name: "Julia Braun", short: "JB", color: "#E1306C", loc: "berlin" },
  { id: "alex", name: "Alex KrÃ¼ger", short: "AK", color: "#38B2AC", loc: "muenchen" },
  { id: "nina", name: "Nina Hoffmann", short: "NH", color: "#F7C948", loc: "muenchen" },
  { id: "tom", name: "Tom Richter", short: "TR", color: "#FF6B35", loc: "hamburg" },
];

const CELEB = ["ðŸŽ‰","ðŸ¥³","ðŸ†","ðŸ’°","ðŸ”¥","â­","ðŸŽŠ","ðŸ’Ž","ðŸ‘‘","ðŸš€"];
const GOAL = 15000;
const NOW = Date.now();
const ago = d => NOW - d * 864e5;
const fmt = v => new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(v);
const dSince = ts => Math.floor((NOW - ts) / 864e5);
const tAgo = ts => { const d = dSince(ts); return d === 0 ? "Heute" : d === 1 ? "Gestern" : `vor ${d}d`; };

const DEFAULT_RULES = [
  { id: "r1", from: "lead", to: "angebot", action: "todo", text: "Angebot nachfassen", days: 3, enabled: true, scope: "hq" },
  { id: "r2", from: "angebot", to: "schwebend", action: "todo", text: "Nachfragen ob Entscheidung gefallen", days: 5, enabled: true, scope: "hq" },
  { id: "r3", from: "lead", to: "angebot", action: "activity", actType: "note", text: "Angebot wurde erstellt", enabled: true, scope: "hq" },
  { id: "r4", from: "*", to: "verkauft", action: "todo", text: "Willkommens-Mail senden", days: 0, enabled: true, scope: "hq" },
  { id: "r5", from: "*", to: "gold", action: "todo", text: "In 30 Tagen erneut kontaktieren", days: 30, enabled: true, scope: "hq" },
  { id: "r6", from: "lead", to: "angebot", action: "activity", actType: "call", text: "Beratungstermin vereinbaren", enabled: true, scope: "berlin" },
];

const INIT = [
  { id:1, name:"Anna MÃ¼ller", value:2400, stage:"lead", avatar:"ðŸ‘©", heat:3, note:"Interesse Premium-Paket", phone:"0176 123 4567", email:"anna.mueller@mail.de", acts:[{type:"call",text:"ErstgesprÃ¤ch gefÃ¼hrt",time:ago(1)}], todos:[{text:"Angebot vorbereiten",due:ago(-1),done:false,id:"t1"}], created:ago(2), changed:ago(2), loc:"berlin", seller:"max" },
  { id:2, name:"Thomas Schmidt", value:4500, stage:"angebot", avatar:"ðŸ‘¨", heat:5, note:"Jahresabo Angebot gesendet", phone:"0151 234 5678", email:"t.schmidt@web.de", acts:[{type:"email",text:"Angebot versendet",time:ago(0)},{type:"call",text:"Nachgefasst",time:ago(2)}], todos:[{text:"Angebot nachfassen",due:ago(-2),done:false,id:"t2"}], created:ago(5), changed:ago(1), loc:"berlin", seller:"julia" },
  { id:3, name:"Sarah Weber", value:1800, stage:"schwebend", avatar:"ðŸ‘©â€ðŸ’¼", heat:4, note:"Wartet auf Partner-RÃ¼ckmeldung", phone:"0171 345 6789", email:"sarah.weber@gmail.com", acts:[{type:"meeting",text:"Beratung vor Ort",time:ago(3)}], todos:[], created:ago(8), changed:ago(3), loc:"muenchen", seller:"alex" },
  { id:4, name:"Marco Fischer", value:3200, stage:"angebot", avatar:"ðŸ‘¨â€ðŸ’¼", heat:4, note:"Vergleicht Angebote", phone:"0162 456 7890", email:"marco.fischer@outlook.de", acts:[{type:"whatsapp",text:"Nachricht gesendet",time:ago(6)}], todos:[{text:"Konkurrenzvergleich senden",due:ago(1),done:true,id:"t3"}], created:ago(10), changed:ago(6), loc:"muenchen", seller:"nina" },
  { id:5, name:"Lisa Bauer", value:950, stage:"lead", avatar:"ðŸ‘©â€ðŸŽ¨", heat:2, note:"Via Empfehlung", phone:"0157 567 8901", email:"lisa.bauer@mail.de", acts:[], todos:[], created:ago(1), changed:ago(1), loc:"hamburg", seller:"tom" },
  { id:6, name:"Peter Klein", value:5000, stage:"gold", avatar:"ðŸ‘¨â€ðŸ”§", heat:3, note:"Budget erst Q2", phone:"0173 678 9012", email:"peter.klein@gmx.de", acts:[{type:"note",text:"Meldet sich MÃ¤rz",time:ago(4)}], todos:[{text:"In 30 Tagen erneut kontaktieren",due:ago(-26),done:false,id:"t4"}], created:ago(15), changed:ago(4), loc:"hamburg", seller:"tom" },
];

/* â”€â”€ Tiny Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Particle({x,y,emoji,delay}){return <div style={{position:"fixed",left:x,top:y,fontSize:"2rem",pointerEvents:"none",zIndex:9999,animation:`fly 1.2s ease-out ${delay}s forwards`,opacity:0}}>{emoji}</div>}
function Heat({heat}){return <div style={{display:"flex",gap:2,alignItems:"center"}}>{[1,2,3,4,5].map(i=><div key={i} style={{width:7,height:7,borderRadius:"50%",background:i<=heat?(heat>=4?"#FF6B35":heat>=3?"#F7C948":"#CBD5E0"):"#E2E8F0",transition:"all .3s"}}/>)}<span style={{fontSize:9,marginLeft:3,color:"#999"}}>{heat>=4?"ðŸ”¥":heat>=3?"â˜€ï¸":"â„ï¸"}</span></div>}

function TodoBadge({todos}){
  const open = todos.filter(t => !t.done);
  if(!open.length) return null;
  const overdue = open.some(t => t.due < NOW);
  return <div style={{display:"inline-flex",alignItems:"center",gap:3,background:overdue?"#FED7D7":"#EBF4FF",color:overdue?"#C53030":"#667EEA",fontSize:10,fontWeight:700,padding:"2px 7px",borderRadius:8,fontFamily:"'Outfit',sans-serif",animation:overdue?"pulse 1.5s infinite":"none"}}>
    {overdue?"â—":"â˜‘ï¸"} {open.length}
  </div>
}

function AgingBadge({deal}){
  if(["verkauft","lost","gold"].includes(deal.stage))return null;
  const d=dSince(deal.changed),w=AGING[deal.stage]||5;
  if(d<w)return null;
  const u=d>=w*2;
  return <div style={{display:"inline-flex",alignItems:"center",gap:3,background:u?"#FED7D7":"#FEFCBF",color:u?"#C53030":"#B7791F",fontSize:10,fontWeight:700,padding:"2px 8px",borderRadius:8,animation:u?"pulse 1s infinite":"none",fontFamily:"'Outfit',sans-serif"}}>{u?"ðŸš¨":"â°"} {d}d</div>
}


/* â”€â”€ Deal Card (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Card({deal,onDrag,onClick,isNew}){
  const st=STAGES.find(s=>s.id===deal.stage);
  const d=dSince(deal.changed),w=AGING[deal.stage]||999,aging=d>=w&&!["verkauft","lost","gold"].includes(deal.stage);
  const urgent=d>=w*2;
  const openT=deal.todos.filter(t=>!t.done).length;
  const overdue=deal.todos.some(t=>!t.done&&t.due<NOW);
  const seller=SELLERS.find(s=>s.id===deal.seller);
  return <div draggable onDragStart={e=>{e.dataTransfer.setData("id",deal.id);e.dataTransfer.effectAllowed="move";onDrag(deal.id)}} onClick={()=>onClick(deal)} style={{background:"#fff",borderRadius:12,padding:"11px 13px",cursor:"grab",borderLeft:`3px solid ${aging?(urgent?"#E53E3E":"#ECC94B"):st.color}`,boxShadow:"0 1px 3px rgba(0,0,0,.04)",transition:"all .15s",animation:isNew?"appear .4s ease":"none",userSelect:"none"}}>
    <div style={{display:"flex",alignItems:"center",gap:9,marginBottom:5}}>
      <div style={{width:30,height:30,borderRadius:9,background:st.bg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,flexShrink:0}}>{deal.avatar}</div>
      <div style={{flex:1,minWidth:0}}>
        <div style={{fontWeight:700,fontSize:13,color:"#1a202c",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{deal.name}</div>
        <div style={{fontSize:10,color:"#A0AEC0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{deal.note}</div>
      </div>
    </div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <span style={{fontWeight:800,fontSize:14,color:st.color}}>{fmt(deal.value)}</span>
      <div style={{display:"flex",alignItems:"center",gap:4}}>
        {seller&&<span style={{fontSize:9,fontWeight:700,color:seller.color,background:seller.color+"10",padding:"1px 5px",borderRadius:4}}>{seller.short}</span>}
        {openT>0&&<span style={{fontSize:9,fontWeight:700,color:overdue?"#E53E3E":"#667EEA",background:overdue?"#FED7D7":"#EBF4FF",padding:"1px 5px",borderRadius:4}}>{overdue?"â—":"â˜‘"}{openT}</span>}
        {aging&&<span style={{fontSize:9,fontWeight:700,color:urgent?"#E53E3E":"#B7791F",background:urgent?"#FED7D7":"#FEFCBF",padding:"1px 5px",borderRadius:4}}>{urgent?"ðŸš¨":"â°"}{d}d</span>}
        <div style={{display:"flex",gap:1}}>{[1,2,3,4,5].map(i=><div key={i} style={{width:5,height:5,borderRadius:"50%",background:i<=deal.heat?(deal.heat>=4?"#FF6B35":deal.heat>=2?"#F7C948":"#CBD5E0"):"#EDF2F7"}}/>)}</div>
      </div>
    </div>
  </div>
}

/* â”€â”€ Column (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Col({stage,deals,onDrop,onDrag,onClick,newId}){
  const[dg,setDg]=useState(false);
  const tv=deals.reduce((s,d)=>s+d.value,0);
  return <div onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={e=>{e.preventDefault();setDg(false);onDrop(+e.dataTransfer.getData("id"),stage.id)}} style={{flex:"1 1 0",minWidth:180,display:"flex",flexDirection:"column",gap:6,background:dg?`${stage.color}08`:"transparent",borderRadius:14,padding:8,transition:"all .2s",border:`2px dashed ${dg?stage.color:"transparent"}`}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 4px 2px"}}>
      <div style={{display:"flex",alignItems:"center",gap:6}}>
        <div style={{width:8,height:8,borderRadius:"50%",background:stage.color}}/>
        <span style={{fontWeight:700,fontSize:12,color:"#2D3748"}}>{stage.label}</span>
        <span style={{fontSize:10,fontWeight:600,color:"#A0AEC0"}}>{deals.length}</span>
      </div>
      <span style={{fontWeight:700,fontSize:11,color:stage.color}}>{fmt(tv)}</span>
    </div>
    <div style={{display:"flex",flexDirection:"column",gap:5,flex:1,minHeight:80}}>
      {deals.map(d=><Card key={d.id} deal={d} onDrag={onDrag} onClick={onClick} isNew={d.id===newId}/>)}
      {!deals.length&&<div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#E2E8F0",fontSize:24,opacity:dg?1:.3}}>{stage.emoji}</div>}
    </div>
  </div>
}

/* â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AddModal({onClose,onAdd,currentLoc}){
  const[n,setN]=useState("");const[v,setV]=useState("");const[no,setNo]=useState("");const[ph,setPh]=useState("");const[em,setEm]=useState("");const[av,setAv]=useState("ðŸ‘¤");const[loc,setLoc]=useState(currentLoc==="hq"?"berlin":currentLoc);const[seller,setSeller]=useState("");
  const availSellers=SELLERS.filter(s=>s.loc===loc);
  const go=()=>{if(!n||!v)return;onAdd({name:n,value:+v,note:no||"Neuer Kontakt",avatar:av,heat:3,stage:"lead",phone:ph,email:em,acts:[],todos:[],created:Date.now(),changed:Date.now(),loc,seller:seller||availSellers[0]?.id||""})};
  const ip={width:"100%",padding:"10px 14px",borderRadius:12,border:"2px solid #E2E8F0",fontSize:14,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"};
  const locs=LOCATIONS.filter(l=>!l.isHQ);
  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .2s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:24,padding:28,width:420,maxWidth:"92vw",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 25px 60px rgba(0,0,0,.15)",animation:"pop .3s cubic-bezier(.34,1.56,.64,1)"}}>
      <h2 style={{margin:"0 0 20px",fontFamily:"'Outfit',sans-serif",fontWeight:800,fontSize:22}}>ðŸš€ Neuer Kontakt</h2>
      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Name *</label><input style={ip} placeholder="z.B. Anna MÃ¼ller" value={n} onChange={e=>setN(e.target.value)} autoFocus/></div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Wert (â‚¬) *</label><input style={ip} type="number" placeholder="2500" value={v} onChange={e=>setV(e.target.value)}/></div>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Standort</label>
            <select value={loc} onChange={e=>{setLoc(e.target.value);setSeller("")}} style={{...ip,cursor:"pointer",background:"#fff"}}>{locs.map(l=><option key={l.id} value={l.id}>{l.label}</option>)}</select>
          </div>
        </div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>VerkÃ¤ufer</label>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{availSellers.map(s=><div key={s.id} onClick={()=>setSeller(s.id)} style={{padding:"6px 12px",borderRadius:10,fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",background:seller===s.id?s.color+"20":"#F7FAFC",color:seller===s.id?s.color:"#A0AEC0",border:`2px solid ${seller===s.id?s.color:"transparent"}`,transition:"all .2s",display:"flex",alignItems:"center",gap:5}}>
              <span style={{width:22,height:22,borderRadius:7,background:s.color,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:900}}>{s.short}</span>{s.name}
            </div>)}{!availSellers.length&&<span style={{fontSize:12,color:"#CBD5E0"}}>Kein VerkÃ¤ufer fÃ¼r diesen Standort</span>}</div>
          </div>
        </div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Telefon</label><input style={ip} placeholder="0176 ..." value={ph} onChange={e=>setPh(e.target.value)}/></div>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>E-Mail</label><input style={{...ip}} type="email" placeholder="anna@mail.de" value={em} onChange={e=>setEm(e.target.value)}/></div>
        </div>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Notiz</label><input style={ip} placeholder="Interesse an..." value={no} onChange={e=>setNo(e.target.value)}/></div>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Avatar</label>
          <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{AVATARS.map(a=><div key={a} onClick={()=>setAv(a)} style={{width:38,height:38,borderRadius:10,border:`2px solid ${av===a?"#667EEA":"#E2E8F0"}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:19,cursor:"pointer",background:av===a?"#EBF4FF":"#fff",transform:av===a?"scale(1.1)":"scale(1)",transition:"all .2s"}}>{a}</div>)}</div>
        </div>
        <div style={{display:"flex",gap:12,marginTop:4}}>
          <button onClick={onClose} style={{flex:1,padding:"11px 18px",borderRadius:12,border:"2px solid #E2E8F0",background:"#fff",fontSize:14,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
          <button onClick={go} style={{flex:2,padding:"11px 18px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#667EEA,#764BA2)",fontSize:14,fontWeight:700,color:"#fff",cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(102,126,234,.4)",opacity:n&&v?1:.5}}>ðŸš€ HinzufÃ¼gen</button>
        </div>
      </div>
    </div>
  </div>
}

/* â”€â”€ Verkaufsformular, Detail Modal, Auto Modal, Scores, Funnel, Badges, DropZone, App â”€â”€ */
/* â”€â”€ Verkaufsformular (2 Modi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function SalesForm({deal,sales,seller,onClose,onUpdateDeal,mode}){
  const[form,setForm]=useState({...sales});
  const u=(k,v)=>{
    setForm(p=>({...p,[k]:v}));
    // Budget-Range â†’ Deal-Wert automatisch setzen
    if(k==="budgetRange"){
      const map={"<2k":1500,"2-3k":2500,"3-5k":4000,"5k+":6000};
      if(map[v]) onUpdateDeal(deal.id,"value",map[v]);
    }
  };
  const saveAndClose=()=>{
    // Merge: bestehende sales + form (damit Upload-Daten nicht Ã¼berschrieben werden)
    const merged = {...(deal.sales||{}), ...form};
    onUpdateDeal(deal.id,"sales",merged);
    onClose();
  };
  const isInt=mode==="interactive";

  const payOpts=["JobRad","BLS","BusinessBike","Finanzierung","Leasing/Divers","Bar/EC"];
  const bedarfFields=[
    {k:"nutzung",l:"Was machst du mit dem Fahrrad?",p:"Pendeln, Sport, Freizeit..."},
    {k:"ziel",l:"Welches Ziel verfolgst du?",p:"Fitness, MobilitÃ¤t, Spass..."},
    {k:"distanz",l:"Distanzen",p:"km pro Fahrt",half:1},
    {k:"haeufigkeit",l:"Wie oft / Woche",p:"3x / 5h",half:1},
    {k:"erfahrung",l:"E-Bike Erfahrung",p:"Noch nie, ab und zu, regelmÃ¤ssig..."},
    {k:"lagerung",l:"Lagerung & Transport",p:"Garage, Keller...",half:1},
    {k:"aufladen",l:"Wo aufladen?",p:"Zuhause, Arbeit...",half:1},
    {k:"wichtig",l:"Was ist dir am Rad wichtig?",p:"Komfort, Design, Reichweite..."},
    {k:"dreiPunkte",l:"3 Punkte damit du heute kaufst?",p:"1. ... 2. ... 3. ...",big:1},
    {k:"budget",l:"Budget",p:"â‚¬ â€“ Wie kam es zustande?",half:1},
    {k:"zeitrahmen",l:"Wann einsatzfÃ¤hig?",p:"Sofort, nÃ¤chste Woche...",half:1},
  ];
  const ergoFields=[{k:"sattelhoehe",l:"SattelhÃ¶he"},{k:"sattelversatz",l:"Sattelversatz"},{k:"abstandLenker",l:"Sattel-Lenker"},{k:"lenkerhoehe",l:"LenkerhÃ¶he"},{k:"sitzknochen",l:"Sitzknochen"},{k:"griffgroesse",l:"GriffgrÃ¶sse"}];
  const checkFields=[{k:"todoZubehoer",l:"ZubehÃ¶rteile bestellt"},{k:"todoRadBestellt",l:"Fahrrad bestellt / lagernd"},{k:"todoKiste",l:"Kiste gepackt"},{k:"todoLeasing",l:"Leasing-Anfrage gestellt"},{k:"todoFinanzierung",l:"Finanzierung: Unterlagen kopiert"},{k:"todoWertgarantie",l:"Wertgarantie"}];

  // â”€â”€ Print version: open in new window â”€â”€
  const doPrint=()=>{
    const w=window.open("","_blank","width=800,height=1100");
    w.document.write(`<html><head><title>Fahrradberatung â€“ ${deal.name}</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;color:#1a1a1a}
      body{padding:36px 44px;max-width:780px;margin:0 auto}
      .hdr{border-bottom:3px solid #f60;padding-bottom:10px;margin-bottom:16px}
      .hdr h1{font-size:20px;font-weight:700}
      .hdr .sub{font-size:10px;color:#999;margin-top:2px}
      .meta{display:flex;gap:24px;margin-bottom:14px;font-size:11px}
      .meta b{font-weight:700}
      .pay-row{display:flex;gap:5px;margin-bottom:16px;flex-wrap:wrap}
      .pill{padding:3px 12px;border:1.5px solid #ccc;border-radius:5px;font-size:10px;font-weight:600}
      .pill.on{background:#333;color:#fff;border-color:#333}
      .sec{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#f60;margin:16px 0 8px;padding-bottom:3px;border-bottom:2px solid #f60}
      .f{margin-bottom:8px}
      .fl{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:#999;margin-bottom:1px}
      .fv{min-height:22px;border-bottom:1px solid #ccc;padding:2px 0;font-size:11px;line-height:1.6}
      .fv:empty::after{content:' ';white-space:pre}
      .g2{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px}
      .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px 16px}
      .chk{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:10px}
      .box{width:11px;height:11px;border:1.5px solid #888;border-radius:2px;display:inline-block}
      .ft{margin-top:24px;text-align:center;font-size:8px;color:#bbb;border-top:1px solid #eee;padding-top:6px}
      @media print{.np{display:none!important}body{padding:20px 28px}}
    </style></head><body>
    <div class="hdr"><h1>FAHRRADBERATUNG</h1><div class="sub">vit:bikes Â· ${new Date().toLocaleDateString("de-DE")}</div></div>
    <div class="meta"><span><b>Kunde:</b> ________________________________</span><span><b>Datum:</b> ___________</span><span><b>VerkÃ¤ufer:</b> ____________________</span></div>
    <div class="pay-row">${payOpts.map(p=>`<span class="pill">${p}</span>`).join("")}</div>
    <div class="sec">Bedarfsanalyse</div>
    ${bedarfFields.map(f=>`<div class="f"><div class="fl">${f.l}</div><div class="fv"></div></div>`).join("")}
    <div class="sec">Ergodaten</div>
    <div style="margin-bottom:6px"><span class="pill">Bodyscanner</span> <span class="pill">Smartfit</span></div>
    <div class="g3">${ergoFields.map(f=>`<div class="f"><div class="fl">${f.l}</div><div class="fv"></div></div>`).join("")}</div>
    <div class="sec">Gekauftes Rad</div>
    <div class="f"><div class="fv" style="min-height:28px"></div></div>
    <div class="g2"><div class="f"><div class="fl">Nr. Teilekiste</div><div class="fv"></div></div><div class="f"><div class="fl">Nr. Auftrag</div><div class="fv"></div></div></div>
    <div class="sec">Nach dem Kauf</div>
    ${checkFields.map(c=>`<div class="chk"><span class="box"></span> ${c.l}</div>`).join("")}
    <div class="ft">vit:bikes Â· Fahrradberatung</div>
    <div class="np" style="text-align:center;margin-top:20px"><button onclick="window.print()" style="padding:12px 40px;font-size:14px;font-weight:700;cursor:pointer;border:none;background:#f60;color:#fff;border-radius:8px">Drucken</button></div>
    </body></html>`);w.document.close()};

  // â”€â”€ Print mode: just trigger print and close â”€â”€
  if(!isInt){doPrint();onClose();return null}

  // â”€â”€ Interactive mode: minimal clean â”€â”€
  const ip={width:"100%",padding:"10px 14px",borderRadius:12,border:"1.5px solid #E8E8E8",fontSize:14,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",background:"#fff"};
  const T=({on,onClick,children,c})=><div onClick={onClick} style={{padding:"11px 18px",borderRadius:12,fontSize:14,fontWeight:600,cursor:"pointer",background:on?(c||"#1a202c"):"#fff",color:on?"#fff":"#666",border:`1.5px solid ${on?(c||"#1a202c"):"#E8E8E8"}`,transition:"all .12s",userSelect:"none"}}>{children}</div>;
  const Sin=({k,opts,c})=><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{opts.map(o=><T key={o.id||o} on={form[k]===(o.id||o)} c={c} onClick={()=>u(k,form[k]===(o.id||o)?"":(o.id||o))}>{o.label||o}</T>)}</div>;
  const Mul=({k,opts,c})=><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{opts.map(o=>{const id=o.id||o;const cur=form[k]||[];const on=Array.isArray(cur)&&cur.includes(id);return <T key={id} on={on} c={c} onClick={()=>u(k,on?cur.filter(x=>x!==id):[...(Array.isArray(cur)?cur:[]),id])}>{o.label||o}</T>})}</div>;
  const Q=({q,sub,children})=><div style={{marginBottom:32}}><div style={{fontSize:16,fontWeight:700,color:"#1a202c",marginBottom:sub?4:10}}>{q}</div>{sub&&<div style={{fontSize:12,color:"#999",marginBottom:10}}>{sub}</div>}{children}</div>;

  return <div onClick={e=>{e.stopPropagation();saveAndClose()}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,animation:"fadeIn .1s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#FAFAFA",borderRadius:24,width:540,maxWidth:"96vw",maxHeight:"94vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 24px 80px rgba(0,0,0,.1)",animation:"pop .2s ease"}}>

      <div style={{padding:"20px 28px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
        <div><div style={{fontWeight:800,fontSize:20,color:"#1a202c"}}>Beratung</div><div style={{fontSize:12,color:"#999",marginTop:2}}>{deal.name}</div></div>
        <button onClick={e=>{e.stopPropagation();saveAndClose()}} style={{width:36,height:36,borderRadius:10,border:"none",background:"#EFEFEF",fontSize:16,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#999"}}>âœ•</button>
      </div>

      <div style={{padding:"0 28px 28px",overflowY:"auto",flex:1}}>

        <Q q="Bezahlart"><Sin k="payment" opts={payOpts}/></Q>

        <Q q="WofÃ¼r brauchst du das Rad?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="nutzungTags" opts={[{id:"pendeln",label:"Pendeln"},{id:"sport",label:"Sport"},{id:"freizeit",label:"Freizeit"},{id:"transport",label:"Transport"},{id:"kinder",label:"Kinder"},{id:"offroad",label:"Offroad"},{id:"stadt",label:"Stadt"},{id:"reisen",label:"Reisen"}]}/>
        </Q>

        <Q q="Welche Strecken?"><Sin k="distanz" opts={[{id:"kurz",label:"< 5 km"},{id:"mittel",label:"5â€“15 km"},{id:"weit",label:"15â€“30 km"},{id:"lang",label:"30+ km"}]}/></Q>

        <Q q="Wie oft pro Woche?"><Sin k="haeufigkeit" opts={[{id:"selten",label:"Selten"},{id:"1-2x",label:"1â€“2Ã—"},{id:"3-5x",label:"3â€“5Ã—"},{id:"tÃ¤glich",label:"TÃ¤glich"}]}/></Q>

        <Q q="E-Bike Erfahrung?"><Sin k="erfahrung" opts={[{id:"keine",label:"Keine"},{id:"wenig",label:"Mal getestet"},{id:"mittel",label:"Gelegentlich"},{id:"viel",label:"RegelmÃ¤ssig"}]}/></Q>

        <Q q="Wo steht das Rad?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="lagerungTags" opts={[{id:"garage",label:"Garage"},{id:"keller",label:"Keller"},{id:"wohnung",label:"Wohnung"},{id:"draussen",label:"Draussen"},{id:"arbeit",label:"Arbeit"}]}/>
        </Q>

        <Q q="Was ist dir wichtig?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="wichtigTags" opts={[{id:"komfort",label:"Komfort"},{id:"reichweite",label:"Reichweite"},{id:"speed",label:"Speed"},{id:"design",label:"Design"},{id:"leicht",label:"Leicht"},{id:"robust",label:"Robust"},{id:"preis",label:"Preis-Leistung"},{id:"motor",label:"Starker Motor"},{id:"leise",label:"Leiser Motor"}]} c="#667EEA"/>
        </Q>

        <Q q="3 Dinge, damit du heute kaufst?">
          {(()=>{const[v,setV]=useState("");const items=form.dreiPunkteList||[];const add=()=>{if(!v.trim()||items.length>=3)return;u("dreiPunkteList",[...items,v.trim()]);setV("")};
          return <div>
            {items.map((t,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:12,background:"#1a202c",color:"#fff",fontSize:14,fontWeight:600,marginBottom:6}}>
              <span style={{width:24,height:24,borderRadius:8,background:"rgba(255,255,255,.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:800,flexShrink:0}}>{i+1}</span>
              <span style={{flex:1}}>{t}</span>
              <span onClick={()=>u("dreiPunkteList",items.filter((_,j)=>j!==i))} style={{cursor:"pointer",opacity:.5}}>âœ•</span>
            </div>)}
            {items.length<3&&<input value={v} onChange={e=>setV(e.target.value)} placeholder={`Punkt ${items.length+1} eingeben...`} onKeyDown={e=>{if(e.key==="Enter")add()}} style={ip}/>}
          </div>})()}
        </Q>

        <Q q="Budget">
          <Sin k="budgetRange" opts={[{id:"<2k",label:"< 2.000 â‚¬"},{id:"2-3k",label:"2â€“3.000 â‚¬"},{id:"3-5k",label:"3â€“5.000 â‚¬"},{id:"5k+",label:"5.000+ â‚¬"}]}/>
          <input value={form.budget||""} onChange={e=>u("budget",e.target.value)} placeholder="Details..." style={{...ip,marginTop:8}}/>
        </Q>

        <Q q="Wann brauchst du es?"><Sin k="zeitrahmen" opts={[{id:"sofort",label:"Sofort"},{id:"2-4w",label:"2â€“4 Wochen"},{id:"flexibel",label:"Flexibel"}]}/></Q>

        <Q q="Ergonomie">
          <div style={{display:"flex",gap:8,marginBottom:12}}>{["Bodyscanner","Smartfit"].map(m=><T key={m} on={form.ergoMethod===m} onClick={()=>u("ergoMethod",form.ergoMethod===m?"":m)}>{m}</T>)}</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
            {ergoFields.map(f=><input key={f.k} value={form[f.k]||""} onChange={e=>u(f.k,e.target.value)} placeholder={f.l} style={{...ip,fontSize:12,padding:"8px 10px",textAlign:"center"}}/>)}
          </div>
        </Q>

        <Q q="Abschluss">
          <input value={form.gekauftesRad||""} onChange={e=>u("gekauftesRad",e.target.value)} placeholder="Gekauftes Rad" style={{...ip,marginBottom:8,fontWeight:600}}/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}}>
            <input value={form.nrTeilekiste||""} onChange={e=>u("nrTeilekiste",e.target.value)} placeholder="Nr. Teilekiste" style={{...ip,fontSize:12}}/>
            <input value={form.nrAuftrag||""} onChange={e=>u("nrAuftrag",e.target.value)} placeholder="Nr. Auftrag" style={{...ip,fontSize:12}}/>
          </div>
          {checkFields.map(c=><div key={c.k} onClick={()=>u(c.k,!form[c.k])} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:12,background:form[c.k]?"#E6FFFA":"#fff",border:`1.5px solid ${form[c.k]?"#38B2AC":"#E8E8E8"}`,cursor:"pointer",marginBottom:6}}>
            <div style={{width:22,height:22,borderRadius:7,border:`2px solid ${form[c.k]?"#38B2AC":"#ccc"}`,background:form[c.k]?"#38B2AC":"#fff",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all .1s"}}>{form[c.k]&&<span style={{color:"#fff",fontSize:12,fontWeight:900}}>âœ“</span>}</div>
            <span style={{fontSize:13,fontWeight:600,color:form[c.k]?"#1a202c":"#888"}}>{c.l}</span>
          </div>)}
        </Q>
      </div>

      <div style={{padding:"14px 28px",borderTop:"1px solid #EFEFEF",flexShrink:0}}>
        <button onClick={e=>{e.stopPropagation();saveAndClose()}} style={{width:"100%",padding:"12px",borderRadius:12,border:"none",background:"#1a202c",color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer"}}>Speichern</button>
      </div>
    </div>
  </div>
}

/* â”€â”€ Detail Modal (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SOURCES=["Empfehlung","Google","Instagram","Facebook","Messe","Walk-In","Website","Flyer","TikTok","Andere"];
const LEASING_PROVIDERS=["JobRad","BLS (Bikeleasing-Service)","BusinessBike","Leasing/Divers"];
const PAY_METHODS=[{id:"Bar/EC",icon:"ðŸ’¶"},{id:"Finanzierung",icon:"ðŸ¦"},{id:"Leasing",icon:"ðŸ“‹"}];

/* â”€â”€ Scan Upload Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function ScanUploadModal({deal,sales,onClose,onUpdateDeal}){
  const[file,setFile]=useState(null);
  const[preview,setPreview]=useState(null);
  const[loading,setLoading]=useState(false);
  const[error,setError]=useState(null);
  const[parsed,setParsed]=useState(null); // KI-erkannte Werte
  const[editData,setEditData]=useState(null); // Bearbeitbare Felder
  const fileRef=useRef(null);

  const FIELD_LABELS={
    payment:"Bezahlart",nutzung:"Nutzung",ziel:"Ziel",distanz:"Distanzen",haeufigkeit:"HÃ¤ufigkeit",
    erfahrung:"E-Bike Erfahrung",lagerung:"Lagerung",aufladen:"Aufladen",zeitrahmen:"Zeitrahmen",
    wichtig:"Wichtig am Rad",budget:"Budget",akku:"Akku-Ladezeit",dreiPunkte:"3 Kaufkriterien",
    einwaende:"EinwÃ¤nde",next:"NÃ¤chster Schritt",notizen:"Notizen",
    ergoMethod:"Ergonomie-Methode",sattelhoehe:"SattelhÃ¶he",sattelversatz:"Sattelversatz",
    abstandLenker:"Abstand Sattel-Lenker",lenkerhoehe:"LenkerhÃ¶he",sitzknochen:"Sitzknochen",griffgroesse:"GriffgrÃ¶sse",
    gekauftesRad:"Gekauftes Rad",nrTeilekiste:"Nr. Teilekiste",nrAuftrag:"Nr. Auftrag",
    todoZubehoer:"ZubehÃ¶rteile bestellt",todoRadBestellt:"Rad bestellt/lagernd",todoKiste:"Kiste gepackt",
    todoLeasing:"Leasing-Anfrage gestellt",todoFinanzierung:"Finanzierung: Unterlagen",todoWertgarantie:"Wertgarantie",
    nutzungTags:"Nutzungs-Tags",lagerungTags:"Lagerungs-Tags",wichtigTags:"Wichtig-Tags",
    budgetRange:"Budget-Bereich",dreiPunkteList:"3-Punkte-Liste"
  };

  const handleFile=(f)=>{
    if(!f)return;
    setFile(f);setError(null);setParsed(null);setEditData(null);
    const reader=new FileReader();
    reader.onload=e=>setPreview(e.target.result);
    reader.readAsDataURL(f);
  };

  const handleDrop=(e)=>{e.preventDefault();e.stopPropagation();const f=e.dataTransfer?.files?.[0];if(f)handleFile(f)};

  const analyze=async()=>{
    if(!preview)return;
    setLoading(true);setError(null);
    try{
      const base64=preview.split(",")[1];
      const mediaType=file.type||"image/jpeg";

      // Scan-Analyse via Supabase Edge Function (API-Key liegt sicher auf dem Server)
      const session=await window.sb.auth.getSession();
      const token=session?.data?.session?.access_token;
      const supabaseUrl=window.sb?.supabaseUrl||SUPABASE_URL||"";
      const supabaseKey=window.sb?.supabaseKey||SUPABASE_ANON_KEY||"";

      const resp=await fetch(supabaseUrl+"/functions/v1/analyze-scan",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+(token||""),
          "apikey":supabaseKey
        },
        body:JSON.stringify({
          image_base64:base64,
          media_type:mediaType
        })
      });

      if(!resp.ok){
        const errBody=await resp.json().catch(()=>({}));
        throw new Error(errBody.error||`Fehler ${resp.status}`);
      }

      const data=await resp.json();
      const result=data.fields||{};
      setParsed(result);

      // Merge: bestehende sales haben Vorrang, gescannte Werte fÃ¼llen LÃ¼cken
      const existing=deal.sales||{};
      const merged={};
      for(const[k,v] of Object.entries(result)){
        if(v===null||v===undefined||v==="")continue;
        merged[k]=v;
      }
      // Overlay: bestehende Werte Ã¼berschreiben gescannte (digitale Eingaben haben Vorrang)
      for(const[k,v] of Object.entries(existing)){
        if(v!==null&&v!==undefined&&v!==""&&v!==false&&!(Array.isArray(v)&&v.length===0)){
          merged[k]=v;
        }
      }
      setEditData(merged);

    }catch(err){
      console.error("Scan analysis error:",err);
      setError(err.message||"Analyse fehlgeschlagen");
    }finally{
      setLoading(false);
    }
  };

  const updateField=(k,v)=>setEditData(p=>({...p,[k]:v}));

  const saveAll=()=>{
    if(!editData)return;
    // Merge with whatever is already saved
    const current=deal.sales||{};
    const final={...current,...editData};
    onUpdateDeal(deal.id,"sales",final);
    // Update deal value from budgetRange if present
    if(editData.budgetRange){
      const map={"<2k":1500,"2-3k":2500,"3-5k":4000,"5k+":6000};
      if(map[editData.budgetRange])onUpdateDeal(deal.id,"value",map[editData.budgetRange]);
    }
    onClose();
  };

  const ip={width:"100%",padding:"8px 12px",borderRadius:10,border:"1.5px solid #E2E8F0",fontSize:13,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",background:"#fff"};

  return <div onClick={e=>{e.stopPropagation();onClose()}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.5)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,animation:"fadeIn .15s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:24,width:560,maxWidth:"96vw",maxHeight:"94vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 24px 80px rgba(0,0,0,.12)",animation:"pop .25s ease"}}>

      {/* Header */}
      <div style={{padding:"20px 28px 14px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #F0F0F0"}}>
        <div>
          <div style={{fontWeight:800,fontSize:18,color:"#1a202c"}}>ðŸ“· Formular-Scan</div>
          <div style={{fontSize:11,color:"#A0AEC0",marginTop:2}}>{deal.name} â€“ Beratungsformular einscannen & analysieren</div>
        </div>
        <button onClick={onClose} style={{width:34,height:34,borderRadius:10,border:"none",background:"#F5F5F5",fontSize:15,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#999"}}>âœ•</button>
      </div>

      {/* Content */}
      <div style={{padding:"20px 28px",overflowY:"auto",flex:1}}>

        {/* Step 1: Upload */}
        {!editData&&<>
          <input ref={fileRef} type="file" accept="image/*,.pdf" style={{display:"none"}} onChange={e=>handleFile(e.target.files[0])}/>

          {!preview&&<div
            onClick={()=>fileRef.current?.click()}
            onDragOver={e=>{e.preventDefault();e.stopPropagation()}}
            onDrop={handleDrop}
            style={{border:"2px dashed #E2E8F0",borderRadius:16,padding:"48px 24px",textAlign:"center",cursor:"pointer",transition:"all .2s",background:"#FAFAFA"}}
            onMouseOver={e=>e.currentTarget.style.borderColor="#FF6B35"}
            onMouseOut={e=>e.currentTarget.style.borderColor="#E2E8F0"}
          >
            <div style={{fontSize:48,marginBottom:12}}>ðŸ“„</div>
            <div style={{fontWeight:700,fontSize:15,color:"#2D3748",marginBottom:4}}>Formular hochladen</div>
            <div style={{fontSize:12,color:"#A0AEC0"}}>Foto oder Scan per Klick oder Drag & Drop</div>
            <div style={{fontSize:11,color:"#CBD5E0",marginTop:8}}>JPG, PNG, PDF</div>
          </div>}

          {preview&&<div style={{marginBottom:20}}>
            <div style={{position:"relative",borderRadius:14,overflow:"hidden",border:"1px solid #E2E8F0",marginBottom:14}}>
              <img src={preview} alt="Scan" style={{width:"100%",maxHeight:300,objectFit:"contain",background:"#F9FAFB"}}/>
              <button onClick={()=>{setFile(null);setPreview(null);setError(null)}} style={{position:"absolute",top:8,right:8,width:28,height:28,borderRadius:8,border:"none",background:"rgba(0,0,0,.6)",color:"#fff",fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
            </div>
            <div style={{fontSize:11,color:"#A0AEC0",marginBottom:12}}>ðŸ“ {file?.name} ({(file?.size/1024).toFixed(0)} KB)</div>

            {error&&<div style={{padding:"10px 14px",borderRadius:10,background:"#FFF5F5",border:"1px solid #FED7D7",color:"#C53030",fontSize:12,fontWeight:600,marginBottom:12}}>âš ï¸ {error}</div>}

            <button onClick={analyze} disabled={loading} style={{width:"100%",padding:"14px",borderRadius:12,border:"none",background:loading?"#A0AEC0":"linear-gradient(135deg,#FF6B35,#E55D2B)",color:"#fff",fontSize:14,fontWeight:700,cursor:loading?"wait":"pointer",fontFamily:"'Outfit',sans-serif",opacity:loading?.7:1,boxShadow:"0 4px 15px rgba(255,107,53,.3)"}}>
              {loading?<span>â³ KI analysiert Formular...</span>:<span>ðŸ¤– Mit KI analysieren</span>}
            </button>
          </div>}

          {loading&&<div style={{padding:20,textAlign:"center"}}>
            <div style={{display:"inline-flex",gap:6,marginBottom:10}}>{[0,1,2].map(i=><div key={i} style={{width:10,height:10,borderRadius:"50%",background:"#FF6B35",animation:`pulse 1s infinite ${i*.2}s`}}/>)}</div>
            <div style={{fontSize:13,color:"#718096",fontWeight:600}}>Handschrift wird erkannt...</div>
            <div style={{fontSize:11,color:"#A0AEC0",marginTop:4}}>Dies kann einige Sekunden dauern</div>
          </div>}
        </>}

        {/* Step 2: Voransicht & Bearbeiten */}
        {editData&&<div>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:16,padding:"10px 14px",borderRadius:10,background:"#F0FFF4",border:"1px solid #C6F6D5"}}>
            <span style={{fontSize:20}}>âœ…</span>
            <div>
              <div style={{fontWeight:700,fontSize:13,color:"#22543D"}}>Analyse abgeschlossen</div>
              <div style={{fontSize:11,color:"#48BB78"}}>{Object.keys(editData).filter(k=>editData[k]!==null&&editData[k]!==undefined&&editData[k]!=="").length} Felder erkannt â€“ prÃ¼fe & ergÃ¤nze die Werte</div>
            </div>
          </div>

          {/* Show which fields came from existing digital data */}
          {Object.keys(deal.sales||{}).length>0&&<div style={{padding:"8px 12px",borderRadius:8,background:"#EBF4FF",border:"1px solid #BEE3F8",fontSize:11,color:"#2B6CB0",fontWeight:600,marginBottom:14}}>
            â„¹ï¸ Bestehende Daten aus der digitalen Beratung wurden beibehalten
          </div>}

          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            {Object.entries(editData).filter(([k,v])=>v!==null&&v!==undefined).map(([k,v])=>{
              const label=FIELD_LABELS[k]||k;
              const isFromExisting=sales[k]!==undefined&&sales[k]!==null&&sales[k]!==""&&sales[k]!==false;
              const isBoolean=typeof v==="boolean";
              const isArray=Array.isArray(v);

              return <div key={k} style={{padding:"10px 14px",borderRadius:12,background:isFromExisting?"#F0F7FF":"#FAFAFA",border:`1px solid ${isFromExisting?"#BEE3F8":"#EDF2F7"}`}}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}>
                  <span style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em"}}>{label}</span>
                  {isFromExisting&&<span style={{fontSize:8,fontWeight:700,background:"#667EEA",color:"#fff",padding:"1px 5px",borderRadius:4}}>DIGITAL</span>}
                  {!isFromExisting&&parsed?.[k]&&<span style={{fontSize:8,fontWeight:700,background:"#FF6B35",color:"#fff",padding:"1px 5px",borderRadius:4}}>SCAN</span>}
                </div>
                {isBoolean?
                  <div onClick={()=>updateField(k,!v)} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer"}}>
                    <div style={{width:20,height:20,borderRadius:6,border:`2px solid ${v?"#38B2AC":"#CBD5E0"}`,background:v?"#38B2AC":"#fff",display:"flex",alignItems:"center",justifyContent:"center"}}>{v&&<span style={{color:"#fff",fontSize:11,fontWeight:900}}>âœ“</span>}</div>
                    <span style={{fontSize:12,fontWeight:600,color:v?"#2D3748":"#A0AEC0"}}>{v?"Ja":"Nein"}</span>
                  </div>
                :isArray?
                  <input value={v.join(", ")} onChange={e=>updateField(k,e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} style={ip}/>
                :
                  <input value={v||""} onChange={e=>updateField(k,e.target.value)} style={ip}/>
                }
              </div>
            })}
          </div>

          {/* Option to re-scan */}
          <button onClick={()=>{setParsed(null);setEditData(null);setFile(null);setPreview(null)}} style={{marginTop:14,padding:"8px 14px",borderRadius:8,border:"1px solid #E2E8F0",background:"#fff",fontSize:11,fontWeight:600,color:"#718096",cursor:"pointer",width:"100%"}}>
            ðŸ“· Anderen Scan hochladen
          </button>
        </div>}
      </div>

      {/* Footer */}
      <div style={{padding:"14px 28px",borderTop:"1px solid #F0F0F0",display:"flex",gap:10}}>
        <button onClick={onClose} style={{flex:1,padding:"12px",borderRadius:12,border:"2px solid #E2E8F0",background:"#fff",fontSize:13,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
        {editData&&<button onClick={saveAll} style={{flex:2,padding:"12px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#FF6B35,#E55D2B)",color:"#fff",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(255,107,53,.3)"}}>âœ… Werte Ã¼bernehmen</button>}
      </div>
    </div>
  </div>
}

function DetailModal({deal,onClose,onAct,onHeat,onToggleTodo,onAddTodo,onUpdateDeal,onChangeStage}){
  const[tab,setTab]=useState("overview");
  const[at,setAt]=useState("call");const[tx,setTx]=useState("");
  const[todoTx,setTodoTx]=useState("");const[todoDays,setTodoDays]=useState(3);
  const[ef,setEf]=useState(null);const[ev,setEv]=useState("");
  const[showForm,setShowForm]=useState(null); // null | "interactive" | "print"
  const st=STAGES.find(s=>s.id===deal.stage);
  const sales=deal.sales||{};const seller=SELLERS.find(s=>s.id===deal.seller);
  const openT=deal.todos.filter(t=>!t.done).length;

  const sav=(f,v)=>{onUpdateDeal(deal.id,f,v);setEf(null)};
  const uS=(k,v)=>onUpdateDeal(deal.id,"sales",{...sales,[k]:v});
  const goAct=()=>{if(!tx.trim())return;onAct(deal.id,{type:at,text:tx.trim(),time:Date.now()});setTx("")};
  const goTodo=()=>{if(!todoTx.trim())return;onAddTodo(deal.id,{text:todoTx.trim(),due:Date.now()+todoDays*864e5,done:false,id:"t"+Date.now()});setTodoTx("")};

  const Edt=({f,v,ph,tp,sx})=>{
    if(ef===f)return <input value={ev} onChange={e=>setEv(e.target.value)} type={tp||"text"} autoFocus
      onKeyDown={e=>{if(e.key==="Enter")sav(f,tp==="number"?+ev:ev);if(e.key==="Escape")setEf(null)}}
      onBlur={()=>sav(f,tp==="number"?+ev:ev)}
      style={{padding:"4px 8px",borderRadius:6,border:"1.5px solid #667EEA",fontSize:"inherit",fontFamily:"inherit",outline:"none",background:"#EBF4FF",width:"100%",boxSizing:"border-box",...sx}}/>;
    return <span onClick={()=>{setEf(f);setEv(v||"")}} style={{cursor:"pointer",borderBottom:"1px dashed #E2E8F0",...sx}}>{v||<span style={{color:"#CBD5E0"}}>{ph}</span>}</span>
  };

  const Lbl=({children})=><div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".06em",marginBottom:6}}>{children}</div>;
  const Chip=({on,color,onClick,children})=><div onClick={onClick} style={{padding:"5px 11px",borderRadius:8,fontSize:11,fontWeight:600,cursor:"pointer",background:on?(color||"#667EEA"):on===false?"#F7FAFC":"#F7FAFC",color:on?"#fff":"#718096",transition:"all .12s"}}>{children}</div>;

  const tabList=[{id:"overview",l:"Ãœbersicht"},{id:"sales",l:"GesprÃ¤ch"},{id:"log",l:"Log",n:deal.acts.length},{id:"todos",l:"Todos",n:openT}];

  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.3)",backdropFilter:"blur(5px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .15s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:18,width:560,maxWidth:"94vw",maxHeight:"88vh",display:"flex",flexDirection:"column",boxShadow:"0 16px 48px rgba(0,0,0,.1)",animation:"pop .2s cubic-bezier(.34,1.56,.64,1)",overflow:"hidden"}}>

      {/* â”€â”€ Header â”€â”€ */}
      <div style={{padding:"20px 24px 14px",background:`linear-gradient(135deg,${st.color}08,${st.color}03)`}}>
        <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
          <div style={{width:44,height:44,borderRadius:12,background:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0,boxShadow:"0 1px 4px rgba(0,0,0,.06)"}}>{deal.avatar}</div>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontWeight:800,fontSize:17,color:"#1a202c"}}><Edt f="name" v={deal.name} ph="Name"/></div>
            <div style={{fontSize:12,color:"#718096",marginTop:1}}><Edt f="note" v={deal.note} ph="Notiz..."/></div>
          </div>
          <div style={{textAlign:"right",flexShrink:0}}>
            <div style={{fontWeight:800,fontSize:18,color:st.color}}><Edt f="value" v={String(deal.value)} tp="number" sx={{textAlign:"right",fontWeight:800,fontSize:16,width:100}}/>{ef!=="value"&&" â‚¬"}</div>
            <select value={deal.stage} onChange={e=>onChangeStage(deal.id,deal.stage,e.target.value)} style={{marginTop:3,padding:"3px 8px",borderRadius:7,border:"none",fontSize:10,fontWeight:700,color:st.color,background:st.bg,cursor:"pointer",outline:"none"}}>{STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
          </div>
        </div>
        <div style={{display:"flex",gap:6,marginTop:10,flexWrap:"wrap",alignItems:"center",fontSize:11,color:"#718096"}}>
          <span style={{background:"#fff",borderRadius:6,padding:"3px 8px",border:"1px solid #F0F0F0"}}>ðŸ“ž <Edt f="phone" v={deal.phone} ph="Telefon" sx={{fontSize:11}}/></span>
          <span style={{background:"#fff",borderRadius:6,padding:"3px 8px",border:"1px solid #F0F0F0"}}>ðŸ“§ <Edt f="email" v={deal.email} ph="E-Mail" sx={{fontSize:11}}/></span>
          {seller&&<span style={{background:seller.color+"10",color:seller.color,borderRadius:6,padding:"3px 8px",fontWeight:700,fontSize:10}}>{seller.short} {seller.name.split(" ")[0]}</span>}
          <span style={{marginLeft:"auto",fontSize:10,color:"#CBD5E0"}}>{tAgo(deal.created)}</span>
        </div>
      </div>

      {/* â”€â”€ Tabs â”€â”€ */}
      <div style={{display:"flex",borderBottom:"1px solid #F0F0F0",padding:"0 24px"}}>
        {tabList.map(t=><div key={t.id} onClick={()=>setTab(t.id)} style={{padding:"10px 14px",fontSize:12,fontWeight:tab===t.id?700:600,cursor:"pointer",color:tab===t.id?"#667EEA":"#A0AEC0",borderBottom:tab===t.id?"2px solid #667EEA":"2px solid transparent",transition:"all .12s"}}>{t.l}{t.n>0?<span style={{marginLeft:4,fontSize:9,background:tab===t.id?"#667EEA":"#EDF2F7",color:tab===t.id?"#fff":"#A0AEC0",padding:"1px 5px",borderRadius:8,fontWeight:700}}>{t.n}</span>:""}</div>)}
      </div>

      {/* â”€â”€ Content â”€â”€ */}
      <div style={{padding:24,overflowY:"auto",flex:1}}>

        {tab==="overview"&&<div style={{display:"grid",gap:20}}>

          {/* Beratungs-Summary â€“ das Wichtigste zuerst */}
          <div style={{background:"#F8F9FB",borderRadius:10,padding:14}}>
            <Lbl>Beratung auf einen Blick</Lbl>
            <div style={{display:"grid",gap:8}}>
              {[{k:"nutzung",l:"ðŸš² Nutzung",ph:"Was macht der Kunde mit dem Rad?"},{k:"ziel",l:"ðŸŽ¯ Ziel",ph:"Welches Ziel?"},{k:"budget",l:"ðŸ’¶ Budget",ph:"Was kann investiert werden?"},{k:"next",l:"ðŸ‘£ NÃ¤chster Schritt",ph:"Was wurde vereinbart?"},{k:"einwaende",l:"âš ï¸ EinwÃ¤nde",ph:"Bedenken?"}].map(f=>{
                const val=sales[f.k];
                return <div key={f.k} style={{display:"flex",gap:8,alignItems:"flex-start"}}>
                  <span style={{fontSize:11,fontWeight:700,color:"#718096",minWidth:110,paddingTop:2}}>{f.l}</span>
                  <div style={{flex:1,fontSize:12,color:val?"#2D3748":"#CBD5E0",fontWeight:val?600:400,lineHeight:1.4,cursor:"pointer",borderBottom:"1px dashed #EDF2F7",padding:"2px 0"}} onClick={()=>setTab("sales")}>{val||f.ph}</div>
                </div>
              })}
              {sales.gekauftesRad&&<div style={{display:"flex",gap:8,alignItems:"flex-start"}}>
                <span style={{fontSize:11,fontWeight:700,color:"#718096",minWidth:110,paddingTop:2}}>ðŸš² Rad</span>
                <span style={{fontSize:12,fontWeight:600,color:"#2D3748"}}>{sales.gekauftesRad}</span>
              </div>}
              {(sales.distanz||sales.haeufigkeit||sales.zeitrahmen)&&<div style={{display:"flex",gap:12,flexWrap:"wrap",marginTop:2}}>
                {sales.distanz&&<span style={{fontSize:10,color:"#718096"}}>ðŸ“ {sales.distanz}</span>}
                {sales.haeufigkeit&&<span style={{fontSize:10,color:"#718096"}}>ðŸ”„ {sales.haeufigkeit}</span>}
                {sales.zeitrahmen&&<span style={{fontSize:10,color:"#718096"}}>â° {sales.zeitrahmen}</span>}
              </div>}
            </div>
            <div style={{marginTop:8,textAlign:"right"}}><span onClick={()=>setTab("sales")} style={{fontSize:10,color:"#667EEA",fontWeight:600,cursor:"pointer"}}>Alle Felder bearbeiten â†’</span></div>
          </div>

          {/* Bezahlart */}
          <div><Lbl>Bezahlart</Lbl>
            <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
              {PAY_METHODS.map(p=><Chip key={p.id} on={sales.payment===p.id} onClick={()=>uS("payment",sales.payment===p.id?"":p.id)}>{p.icon} {p.id}</Chip>)}
            </div>
            {sales.payment==="Leasing"&&<div style={{marginTop:10}}>
              <div style={{fontSize:10,fontWeight:600,color:"#A0AEC0",marginBottom:5}}>Anbieter</div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                {LEASING_PROVIDERS.map(lp=><Chip key={lp} on={sales.leasingProvider===lp} color="#D69E2E" onClick={()=>uS("leasingProvider",lp)}>{lp}</Chip>)}
              </div>
              {sales.leasingProvider&&<input value={sales.leasingRef||""} onChange={e=>uS("leasingRef",e.target.value)} placeholder="Vorgangsnr..." style={{marginTop:8,width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#D69E2E"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>}
            </div>}
          </div>

          {/* Interesse + VerkÃ¤ufer in einer Zeile */}
          <div style={{display:"flex",gap:20,flexWrap:"wrap"}}>
            <div style={{flex:"1 1 120px"}}><Lbl>Interesse</Lbl>
              <div style={{display:"flex",gap:3}}>{[1,2,3,4,5].map(h=><div key={h} onClick={()=>onHeat(deal.id,h)} style={{width:34,height:26,borderRadius:7,background:h<=deal.heat?(deal.heat>=4?"#FF6B3520":deal.heat>=2?"#F7C94820":"#EDF2F7"):"#FAFAFA",border:`1.5px solid ${h<=deal.heat?"transparent":"#F0F0F0"}`,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .12s",fontSize:12}}>{h<=deal.heat?"ðŸ”¥":""}</div>)}</div>
            </div>
            <div style={{flex:"1 1 200px"}}><Lbl>VerkÃ¤ufer</Lbl>
              <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>{SELLERS.filter(s=>s.loc===deal.loc).map(s=><Chip key={s.id} on={deal.seller===s.id} color={s.color} onClick={()=>onUpdateDeal(deal.id,"seller",s.id)}>{s.name}</Chip>)}</div>
            </div>
          </div>

          {/* Quelle */}
          <div><Lbl>Quelle</Lbl>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{SOURCES.map(src=><Chip key={src} on={deal.source===src} onClick={()=>onUpdateDeal(deal.id,"source",src)}>{src}</Chip>)}</div>
          </div>

          {/* Social Quick */}
          {deal.email&&<div><Lbl>Social finden</Lbl>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
              {[{l:"LinkedIn",u:`https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(deal.name)}`,c:"#0077B5"},{l:"Instagram",u:`https://www.instagram.com/${(deal.email.split("@")[0]||"").replace(/[._]/g,"")}`,c:"#E1306C"},{l:"Facebook",u:`https://www.facebook.com/search/top?q=${encodeURIComponent(deal.name)}`,c:"#1877F2"},{l:"XING",u:`https://www.xing.com/search/members?keywords=${encodeURIComponent(deal.name)}`,c:"#00605E"},{l:"Google",u:`https://www.google.com/search?q="${encodeURIComponent(deal.name)}"`,c:"#4285F4"}].map(s=><a key={s.l} href={s.u} target="_blank" rel="noopener" style={{fontSize:11,background:s.c+"10",color:s.c,padding:"5px 10px",borderRadius:7,textDecoration:"none",fontWeight:600}}>{s.l}</a>)}
            </div>
          </div>}
        </div>}

        {tab==="sales"&&<div style={{display:"grid",gap:20}}>
          {/* Bedarfsanalyse */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸŽ¯ Bedarfsanalyse</div>
            {[
              {k:"nutzung",l:"Nutzung",p:"Was machst du mit dem Fahrrad?"},
              {k:"ziel",l:"Ziel",p:"Welches Ziel verfolgst du mit dem Radfahren?"},
              {k:"distanz",l:"Distanzen",p:"Welche Distanzen willst du zurÃ¼cklegen?"},
              {k:"haeufigkeit",l:"HÃ¤ufigkeit",p:"Wie oft / wie viel Zeit pro Woche?"},
              {k:"erfahrung",l:"E-Bike Erfahrung",p:"Welche Erfahrungen mit E-Bike?"},
              {k:"lagerung",l:"Lagerung & Transport",p:"Wo wird das Rad gelagert / transportiert?"},
              {k:"aufladen",l:"Aufladen",p:"Wo kannst du das Rad aufladen?"},
              {k:"zeitrahmen",l:"Wann einsatzfÃ¤hig",p:"Wann muss das Rad einsatzfÃ¤hig sein?"},
              {k:"wichtig",l:"Wichtig am Rad",p:"Was ist dir an deinem Rad wichtig?"},
              {k:"budget",l:"Budget",p:"Was kannst du investieren? (Wie kam das Budget zustande?)"},
              {k:"akku",l:"Akku-Ladezeit",p:"Ist schnelle Akku-Ladezeit wichtig?"},
              {k:"dreiPunkte",l:"3 Kaufkriterien",p:"Welche 3 Punkte muss das Rad haben, damit du es heute kaufst?"},
            ].map(f=><div key={f.k} style={{marginBottom:8}}>
              <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>{f.l}</div>
              <input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
            </div>)}
          </div>

          {/* EinwÃ¤nde & NÃ¤chster Schritt */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸ’¬ GesprÃ¤ch</div>
            {[
              {k:"einwaende",l:"EinwÃ¤nde / Bedenken",p:"Welche Bedenken hat der Kunde?",big:1},
              {k:"next",l:"NÃ¤chster Schritt",p:"Was wurde vereinbart?"},
              {k:"notizen",l:"Sonstige Notizen",p:"Weitere Infos zum GesprÃ¤ch...",big:1},
            ].map(f=><div key={f.k} style={{marginBottom:8}}>
              <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>{f.l}</div>
              {f.big?<textarea value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} rows={2} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",resize:"vertical"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              :<input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>}
            </div>)}
          </div>

          {/* Ergodaten */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸ“ Ergodaten</div>
            <div style={{display:"flex",gap:5,marginBottom:10}}>
              {["Bodyscanner","Smartfit"].map(m=><Chip key={m} on={sales.ergoMethod===m} onClick={()=>uS("ergoMethod",sales.ergoMethod===m?"":m)}>{m}</Chip>)}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              {[{k:"sattelhoehe",l:"SattelhÃ¶he"},{k:"sattelversatz",l:"Sattelversatz"},{k:"abstandLenker",l:"Abstand Sattel-Lenker"},{k:"lenkerhoehe",l:"LenkerhÃ¶he"},{k:"sitzknochen",l:"Sitzknochen"},{k:"griffgroesse",l:"GriffgrÃ¶sse"}].map(f=><div key={f.k}>
                <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>{f.l}</div>
                <input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              </div>)}
            </div>
          </div>

          {/* Gekauftes Rad */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸš² Rad & Auftrag</div>
            <div style={{display:"grid",gap:8}}>
              <div>
                <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>Gekauftes Rad</div>
                <input value={sales.gekauftesRad||""} onChange={e=>uS("gekauftesRad",e.target.value)} placeholder="Modell / Marke / Farbe / GrÃ¶sse" style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <div>
                  <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>Nr. Teilekiste</div>
                  <input value={sales.nrTeilekiste||""} onChange={e=>uS("nrTeilekiste",e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
                </div>
                <div>
                  <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>Nr. Auftrag</div>
                  <input value={sales.nrAuftrag||""} onChange={e=>uS("nrAuftrag",e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
                </div>
              </div>
              <div>
                <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:5}}>Nach dem Kauf</div>
                <div style={{display:"grid",gap:4}}>
                  {[{k:"todoZubehoer",l:"ZubehÃ¶rteile bestellt"},{k:"todoRadBestellt",l:"Fahrrad bestellt / ist lagernd"},{k:"todoKiste",l:"Kiste gepackt"},{k:"todoLeasing",l:"Leasing-Anfrage gestellt"},{k:"todoFinanzierung",l:"Finanzierung: Unterlagen angefordert & kopiert"},{k:"todoWertgarantie",l:"Wertgarantie"}].map(c=><div key={c.k} onClick={()=>uS(c.k,!sales[c.k])} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 8px",borderRadius:7,background:sales[c.k]?"#E6FFFA":"#FAFAFA",cursor:"pointer",transition:"all .12s"}}>
                    <div style={{width:16,height:16,borderRadius:4,border:`1.5px solid ${sales[c.k]?"#38B2AC":"#CBD5E0"}`,background:sales[c.k]?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{sales[c.k]&&<span style={{color:"#fff",fontSize:9,fontWeight:900}}>âœ“</span>}</div>
                    <span style={{fontSize:11,fontWeight:600,color:sales[c.k]?"#2D3748":"#718096"}}>{c.l}</span>
                  </div>)}
                </div>
              </div>
            </div>
          </div>
        </div>}

        {tab==="log"&&<div>
          <div style={{display:"flex",gap:5,marginBottom:8}}>{ACT_TYPES.map(a=><div key={a.id} onClick={()=>setAt(a.id)} style={{padding:"5px 10px",borderRadius:7,fontSize:11,fontWeight:600,cursor:"pointer",background:at===a.id?a.color+"15":"#FAFAFA",color:at===a.id?a.color:"#A0AEC0",transition:"all .12s"}}>{a.label}</div>)}</div>
          <div style={{display:"flex",gap:6,marginBottom:16}}><input value={tx} onChange={e=>setTx(e.target.value)} placeholder="Was wurde besprochen?" onKeyDown={e=>e.key==="Enter"&&goAct()} style={{flex:1,padding:"8px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/><button onClick={goAct} style={{padding:"8px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,fontSize:12,cursor:"pointer",opacity:tx.trim()?1:.35}}>+</button></div>
          {!deal.acts.length&&<div style={{color:"#CBD5E0",fontSize:12,textAlign:"center",padding:20}}>Noch keine EintrÃ¤ge</div>}
          {deal.acts.map((a,i)=>{const t=ACT_TYPES.find(x=>x.id===a.type);return <div key={i} style={{display:"flex",gap:10,padding:"9px 0",borderBottom:i<deal.acts.length-1?"1px solid #F7FAFC":"none"}}>
            <div style={{width:26,height:26,borderRadius:7,background:(t?.color||"#aaa")+"10",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,flexShrink:0}}>{t?.label.split(" ")[0]}</div>
            <div><div style={{fontSize:12,color:"#2D3748",fontWeight:600}}>{a.text}</div><div style={{fontSize:10,color:"#A0AEC0",marginTop:1}}>{tAgo(a.time)}</div></div>
          </div>})}
        </div>}

        {tab==="todos"&&<div>
          <div style={{display:"flex",gap:5,marginBottom:14}}><input value={todoTx} onChange={e=>setTodoTx(e.target.value)} placeholder="Neues Todo..." onKeyDown={e=>e.key==="Enter"&&goTodo()} style={{flex:1,padding:"8px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/><select value={todoDays} onChange={e=>setTodoDays(+e.target.value)} style={{padding:"8px 8px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:11,background:"#fff",cursor:"pointer",outline:"none"}}><option value={0}>Heute</option><option value={1}>Morgen</option><option value={3}>3d</option><option value={7}>1W</option><option value={14}>2W</option><option value={30}>30d</option></select><button onClick={goTodo} style={{padding:"8px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,fontSize:12,cursor:"pointer",opacity:todoTx.trim()?1:.35}}>+</button></div>
          {!deal.todos.length&&<div style={{color:"#CBD5E0",fontSize:12,textAlign:"center",padding:20}}>Alles erledigt âœ¨</div>}
          {[...deal.todos].sort((a,b)=>a.done-b.done||a.due-b.due).map(t=>{const ov=!t.done&&t.due<NOW;return <div key={t.id} onClick={()=>onToggleTodo(deal.id,t.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 10px",marginBottom:3,borderRadius:8,background:t.done?"#FAFAFA":ov?"#FFF5F5":"#fff",border:`1px solid ${ov?"#FEB2B2":"#F0F0F0"}`,cursor:"pointer",transition:"all .12s"}}>
            <div style={{width:18,height:18,borderRadius:5,border:`2px solid ${t.done?"#38B2AC":ov?"#E53E3E":"#CBD5E0"}`,background:t.done?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{t.done&&<span style={{color:"#fff",fontSize:9,fontWeight:900}}>âœ“</span>}</div>
            <div style={{flex:1}}><div style={{fontSize:12,fontWeight:600,color:t.done?"#A0AEC0":"#2D3748",textDecoration:t.done?"line-through":"none"}}>{t.text}</div><div style={{fontSize:10,color:ov?"#E53E3E":"#A0AEC0"}}>{ov?"âš ï¸ ÃœberfÃ¤llig Â· ":""}FÃ¤llig {tAgo(t.due)}</div></div>
          </div>})}
        </div>}

      </div>

      {/* â”€â”€ Footer â”€â”€ */}
      <div style={{padding:"10px 24px",borderTop:"1px solid #F0F0F0",display:"flex",gap:6,justifyContent:"space-between",flexWrap:"wrap"}}>
        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
          <button onClick={()=>setShowForm("interactive")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #667EEA",background:"#fff",fontSize:11,fontWeight:700,color:"#667EEA",cursor:"pointer"}}>ðŸ“‹ Beratung digital</button>
          <button onClick={()=>setShowForm("print")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #A0AEC0",background:"#fff",fontSize:11,fontWeight:700,color:"#718096",cursor:"pointer"}}>ðŸ–¨ï¸ Druckformular</button>
          <button onClick={()=>setShowForm("scan")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #FF6B35",background:"#fff",fontSize:11,fontWeight:700,color:"#FF6B35",cursor:"pointer"}}>ðŸ“· Scan hochladen</button>
        </div>
        <button onClick={onClose} style={{padding:"9px 24px",borderRadius:8,border:"none",background:"#F7FAFC",fontSize:12,fontWeight:700,color:"#718096",cursor:"pointer"}}>Schliessen</button>
      </div>

      {showForm&&showForm!=="scan"&&<SalesForm deal={deal} sales={sales} seller={seller} onClose={()=>setShowForm(null)} onUpdateDeal={onUpdateDeal} mode={showForm}/>}
      {showForm==="scan"&&<ScanUploadModal deal={deal} sales={sales} onClose={()=>setShowForm(null)} onUpdateDeal={onUpdateDeal}/>}
    </div>
  </div>
}
/* â”€â”€ Automations Settings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AutoModal({rules,onUpdate,onClose}){
  const[rs,setRs]=useState(rules);
  const[nFrom,setNFrom]=useState("*");const[nTo,setNTo]=useState("angebot");const[nAct,setNAct]=useState("todo");const[nTx,setNTx]=useState("");const[nDays,setNDays]=useState(3);const[nActType,setNActType]=useState("note");const[nScope,setNScope]=useState("hq");
  const[filterScope,setFilterScope]=useState("all");
  const addRule=()=>{if(!nTx.trim())return;setRs(p=>[...p,{id:"r"+Date.now(),from:nFrom,to:nTo,action:nAct,text:nTx.trim(),days:nDays,actType:nActType,enabled:true,scope:nScope}]);setNTx("")};
  const toggle=(id)=>setRs(p=>p.map(r=>r.id===id?{...r,enabled:!r.enabled}:r));
  const remove=(id)=>setRs(p=>p.filter(r=>r.id!==id));
  const save=()=>{onUpdate(rs);onClose()};
  const allStages=[{id:"*",label:"Beliebig"},...STAGES];
  const scopes=[{id:"hq",label:"ðŸ¢ HQ (Alle)"},...LOCATIONS.filter(l=>!l.isHQ)];
  const filtered=filterScope==="all"?rs:rs.filter(r=>r.scope===filterScope);
  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .2s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:24,padding:28,width:620,maxWidth:"94vw",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 25px 60px rgba(0,0,0,.15)",animation:"pop .3s cubic-bezier(.34,1.56,.64,1)"}}>
      <h2 style={{margin:"0 0 6px",fontFamily:"'Outfit',sans-serif",fontWeight:800,fontSize:22}}>âš¡ Automationen</h2>
      <p style={{margin:"0 0 16px",fontSize:13,color:"#A0AEC0",fontFamily:"'Outfit',sans-serif"}}>ðŸ¢ HQ-Regeln gelten Ã¼berall. ðŸ“ Standort-Regeln nur lokal.</p>

      {/* Scope Filter */}
      <div style={{display:"flex",gap:4,marginBottom:16,background:"#F7FAFC",borderRadius:12,padding:4}}>
        {[{id:"all",label:"Alle"},...scopes].map(s=><div key={s.id} onClick={()=>setFilterScope(s.id)} style={{flex:1,padding:"7px 10px",borderRadius:10,textAlign:"center",fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",background:filterScope===s.id?"#fff":"transparent",color:filterScope===s.id?"#2D3748":"#A0AEC0",boxShadow:filterScope===s.id?"0 2px 8px rgba(0,0,0,.06)":"none",transition:"all .2s"}}>{s.label}</div>)}
      </div>

      {/* Existing rules */}
      <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:20}}>
        {filtered.map(r=>{const fromSt=allStages.find(s=>s.id===r.from);const toSt=STAGES.find(s=>s.id===r.to);const sc=scopes.find(s=>s.id===r.scope);const isHQ=r.scope==="hq";return <div key={r.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:14,background:r.enabled?"#fff":"#F7FAFC",border:`1.5px solid ${r.enabled?(isHQ?"#667EEA30":"#D69E2E30"):"#EDF2F7"}`,opacity:r.enabled?1:.55,transition:"all .2s"}}>
          <div onClick={()=>toggle(r.id)} style={{width:22,height:22,borderRadius:6,border:`2px solid ${r.enabled?"#38B2AC":"#CBD5E0"}`,background:r.enabled?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0}}>{r.enabled&&<span style={{color:"#fff",fontSize:11,fontWeight:800}}>âœ“</span>}</div>
          <div style={{flex:1}}>
            <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",fontSize:12,fontWeight:700,fontFamily:"'Outfit',sans-serif",color:"#2D3748"}}>
              <span style={{background:isHQ?"#EBF4FF":"#FFFFF0",color:isHQ?"#667EEA":"#B7791F",padding:"2px 6px",borderRadius:6,fontSize:10,fontWeight:800}}>{isHQ?"ðŸ¢ HQ":"ðŸ“ "+(sc?.label?.replace("ðŸ“ ","")||r.scope)}</span>
              <span style={{background:"#EBF4FF",color:"#667EEA",padding:"2px 6px",borderRadius:6,fontSize:11}}>{fromSt?.label||"?"}</span>
              <span style={{color:"#A0AEC0"}}>â†’</span>
              <span style={{background:toSt?.bg||"#eee",color:toSt?.color||"#666",padding:"2px 6px",borderRadius:6,fontSize:11}}>{toSt?.label||"?"}</span>
              <span style={{color:"#A0AEC0"}}>dann</span>
              <span style={{background:r.action==="todo"?"#FEFCBF":"#E6FFFA",color:r.action==="todo"?"#B7791F":"#38B2AC",padding:"2px 6px",borderRadius:6,fontSize:11}}>{r.action==="todo"?"â˜‘ï¸ Todo":"ðŸ“‹ AktivitÃ¤t"}</span>
            </div>
            <div style={{fontSize:11,color:"#718096",fontFamily:"monospace",marginTop:3}}>"{r.text}"{r.action==="todo"&&r.days!==undefined?` (in ${r.days}d fÃ¤llig)`:""}</div>
          </div>
          <div onClick={()=>remove(r.id)} style={{width:24,height:24,borderRadius:6,background:"#FFF5F5",color:"#E53E3E",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:12,fontWeight:800,flexShrink:0}}>Ã—</div>
        </div>})}
        {!filtered.length&&<div style={{textAlign:"center",color:"#CBD5E0",fontSize:13,padding:16}}>Keine Regeln fÃ¼r diesen Filter</div>}
      </div>

      {/* New Rule */}
      <div style={{background:"#F7FAFC",borderRadius:16,padding:16,marginBottom:20}}>
        <div style={{fontSize:12,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",marginBottom:10}}>âž• Neue Regel</div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Geltung</span>
          <select value={nScope} onChange={e=>setNScope(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}>{scopes.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Wenn</span>
          <select value={nFrom} onChange={e=>setNFrom(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}>{allStages.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>â†’</span>
          <select value={nTo} onChange={e=>setNTo(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}>{STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Dann</span>
          <select value={nAct} onChange={e=>setNAct(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}><option value="todo">â˜‘ï¸ Todo erstellen</option><option value="activity">ðŸ“‹ AktivitÃ¤t loggen</option></select>
          {nAct==="activity"&&<select value={nActType} onChange={e=>setNActType(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}>{ACT_TYPES.map(a=><option key={a.id} value={a.id}>{a.label}</option>)}</select>}
          {nAct==="todo"&&<select value={nDays} onChange={e=>setNDays(+e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"#fff",cursor:"pointer"}}><option value={0}>Heute</option><option value={1}>1 Tag</option><option value={3}>3 Tage</option><option value={7}>1 Woche</option><option value={14}>2 Wochen</option><option value={30}>30 Tage</option></select>}
        </div>
        <div style={{display:"flex",gap:8}}>
          <input value={nTx} onChange={e=>setNTx(e.target.value)} placeholder="Text der Aktion..." onKeyDown={e=>e.key==="Enter"&&addRule()} style={{flex:1,padding:"10px 14px",borderRadius:12,border:"2px solid #E2E8F0",fontSize:13,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}}/>
          <button onClick={addRule} style={{padding:"10px 18px",borderRadius:12,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,cursor:"pointer",opacity:nTx.trim()?1:.5}}>+</button>
        </div>
      </div>

      <div style={{display:"flex",gap:12}}>
        <button onClick={onClose} style={{flex:1,padding:"11px 18px",borderRadius:12,border:"2px solid #E2E8F0",background:"#fff",fontSize:14,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
        <button onClick={save} style={{flex:2,padding:"11px 18px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#667EEA,#764BA2)",fontSize:14,fontWeight:700,color:"#fff",cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(102,126,234,.4)"}}>ðŸ’¾ Speichern</button>
      </div>
    </div>
  </div>
}

/* â”€â”€ Scoreboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Scores({deals,streak}){
  const sold=deals.filter(d=>d.stage==="verkauft"),tSold=sold.reduce((s,d)=>s+d.value,0);
  const pipe=deals.filter(d=>!["verkauft","lost","gold"].includes(d.stage)).reduce((s,d)=>s+d.value,0);
  const closed=deals.filter(d=>["verkauft","lost"].includes(d.stage));
  const wr=closed.length?Math.round(sold.length/closed.length*100):0;
  const gp=Math.min(100,Math.round(tSold/GOAL*100));
  const items=[{l:"Pipeline",v:fmt(pipe),c:"#667EEA"},{l:"Verkauft",v:fmt(tSold),c:"#38B2AC"},{l:"Win-Rate",v:wr+"%",c:"#F7C948"},{l:"Streak",v:streak+"x",c:"#FF6B35"}];
  return <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"stretch"}}>
    {items.map(s=><div key={s.l} style={{flex:"1 1 100px",background:"#fff",borderRadius:12,padding:"10px 14px",border:"1px solid #F0F0F0"}}>
      <div style={{fontSize:10,color:"#A0AEC0",fontWeight:600,textTransform:"uppercase",letterSpacing:".04em"}}>{s.l}</div>
      <div style={{fontSize:17,fontWeight:800,color:s.c,marginTop:2}}>{s.v}</div>
    </div>)}
    <div style={{flex:"1 1 180px",background:"#fff",borderRadius:12,padding:"10px 14px",border:"1px solid #F0F0F0"}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{fontSize:10,color:"#A0AEC0",fontWeight:600,textTransform:"uppercase"}}>Monatsziel</span><span style={{fontSize:12,fontWeight:800,color:gp>=100?"#38B2AC":"#667EEA"}}>{gp}%</span></div>
      <div style={{height:6,borderRadius:3,background:"#EDF2F7",overflow:"hidden"}}><div style={{height:"100%",borderRadius:3,width:gp+"%",background:gp>=100?"#38B2AC":"#667EEA",transition:"width .6s"}}/></div>
      <div style={{display:"flex",justifyContent:"space-between",marginTop:3}}><span style={{fontSize:9,color:"#CBD5E0"}}>{fmt(tSold)}</span><span style={{fontSize:9,color:"#CBD5E0"}}>{fmt(GOAL)}</span></div>
    </div>
  </div>
}

/* â”€â”€ Funnel + Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Funnel({deals}){
  const c={};PIPELINE.forEach(s=>c[s]=deals.filter(d=>d.stage===s).length);
  const data=PIPELINE.map((sid,i)=>{const st=STAGES.find(s=>s.id===sid);const cnt=c[sid]+PIPELINE.slice(i+1).reduce((s,l)=>s+c[l],0);return{...st,count:cnt,cur:c[sid]}});
  const mx=Math.max(...data.map(f=>f.count),1);
  return <div style={{background:"#fff",borderRadius:18,padding:20,boxShadow:"0 2px 10px rgba(0,0,0,.04)",border:"1px solid #F0F0F0"}}>
    <div style={{fontSize:14,fontWeight:800,color:"#2D3748",fontFamily:"'Outfit',sans-serif",marginBottom:14}}>ðŸ“Š Conversion Funnel</div>
    {data.map((item,i)=>{const w=Math.max(15,item.count/mx*100);const prev=i>0?data[i-1].count:null;const cr=prev?Math.round(item.count/prev*100):null;
      return <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,marginBottom:6}}>
        <div style={{width:90,fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",textAlign:"right"}}>{item.label}</div>
        <div style={{flex:1}}><div style={{height:28,borderRadius:8,width:w+"%",background:`linear-gradient(90deg,${item.color},${item.color}88)`,display:"flex",alignItems:"center",justifyContent:"center",transition:"width .6s",minWidth:40}}><span style={{fontSize:12,fontWeight:800,color:"#fff"}}>{item.cur}</span></div></div>
        {cr!==null&&<div style={{width:50,fontSize:11,fontWeight:700,color:cr>=50?"#38B2AC":cr>=25?"#F7C948":"#E53E3E",fontFamily:"monospace"}}>{cr}%</div>}
      </div>
    })}
  </div>
}
function Badges({deals,streak,unlocked}){
  const s={sold:deals.filter(d=>d.stage==="verkauft").length,rev:deals.filter(d=>d.stage==="verkauft").reduce((a,d)=>a+d.value,0),streak,total:deals.length,hot:deals.filter(d=>d.heat>=5).length,gold:deals.filter(d=>d.stage==="gold").length,acts:deals.reduce((a,d)=>a+d.acts.length,0)};
  return <div style={{background:"#fff",borderRadius:18,padding:20,boxShadow:"0 2px 10px rgba(0,0,0,.04)",border:"1px solid #F0F0F0"}}>
    <div style={{fontSize:14,fontWeight:800,color:"#2D3748",fontFamily:"'Outfit',sans-serif",marginBottom:14}}>ðŸ… Achievements</div>
    <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
      {ACHIEVEMENTS.map(a=>{const ok=a.check(s)||unlocked.includes(a.id);return <div key={a.id} title={a.desc} style={{padding:"8px 12px",borderRadius:12,display:"flex",alignItems:"center",gap:6,background:ok?"linear-gradient(135deg,#FFFFF0,#FEFCBF)":"#F7FAFC",border:`1.5px solid ${ok?"#D69E2E":"#E2E8F0"}`,opacity:ok?1:.45,cursor:"default",transform:ok?"scale(1)":"scale(.95)",transition:"all .3s"}}>
        <span style={{fontSize:18}}>{ok?a.icon:"ðŸ”’"}</span>
        <div><div style={{fontSize:11,fontWeight:700,color:ok?"#B7791F":"#A0AEC0",fontFamily:"'Outfit',sans-serif"}}>{a.label}</div><div style={{fontSize:9,color:ok?"#D69E2E":"#CBD5E0",fontFamily:"monospace"}}>{a.desc}</div></div>
      </div>})}
    </div>
  </div>
}

/* â”€â”€ Drop Zone (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function DropZone({sid,label,sub,bc,tc,cc,deals,onDrop,onDrag}){
  const[dg,setDg]=useState(false);
  if(!deals.length&&!dg)return null;
  return <div style={{padding:"0 0 8px"}}><div onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={e=>{e.preventDefault();setDg(false);onDrop(+e.dataTransfer.getData("id"),sid)}} style={{background:"#fff",borderRadius:12,padding:12,border:`1.5px dashed ${dg?bc:bc+"50"}`,transition:"all .2s"}}>
    <div style={{fontSize:11,fontWeight:700,color:tc,marginBottom:6}}>{label} <span style={{fontWeight:500,color:"#A0AEC0",fontSize:10}}>â€“ {sub}</span></div>
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{deals.map(d=><div key={d.id} draggable onDragStart={e=>{e.dataTransfer.setData("id",d.id);onDrag(d.id)}} style={{background:"#F8F9FB",borderRadius:8,padding:"5px 10px",fontSize:11,fontWeight:600,color:cc,cursor:"grab",border:`1px solid ${bc}30`,display:"flex",alignItems:"center",gap:4}}>
      {d.avatar} {d.name} <span style={{color:"#A0AEC0",fontSize:10}}>{fmt(d.value)}</span>
    </div>)}</div>
  </div></div>
}

/* â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function PipelineApp(){
  const[deals,setDeals]=useState(INIT);
  const[dragId,setDragId]=useState(null);
  const[showAdd,setShowAdd]=useState(false);
  const[sel,setSel]=useState(null);
  const[parts,setParts]=useState([]);
  const[streak,setStreak]=useState(0);
  const[newId,setNewId]=useState(null);
  const[toast,setToast]=useState(null);
  const[unlocked,setUnlocked]=useState([]);
  const[showIn,setShowIn]=useState(false);
  const[showAuto,setShowAuto]=useState(false);
  const[rules,setRules]=useState(DEFAULT_RULES);
  // Determine location from logged-in user profile
  const isHqUser = window.sbProfile && window.sbProfile.is_hq;
  const userStandortSlug = (function() {
    // Map standort_id to a loc slug - for now use demo mapping
    // TODO: Replace with real standort lookup from DB
    if(!window.sbProfile || window.sbProfile.is_hq) return "hq";
    return "berlin"; // Default for non-HQ users until DB mapping exists
  })();
  const[curLoc,setCurLoc]=useState(isHqUser ? "hq" : userStandortSlug);
  const nid=useRef(100);

  const filteredDeals = curLoc === "hq" ? deals : deals.filter(d => d.loc === curLoc);

  const msg=useCallback(m=>{setToast(m);setTimeout(()=>setToast(null),2500)},[]);
  const pop=useCallback((x,y)=>{const np=Array.from({length:14},(_,i)=>({id:Date.now()+i,x:x+(Math.random()-.5)*120,y:y+(Math.random()-.5)*80,emoji:CELEB[Math.floor(Math.random()*CELEB.length)],delay:i*.04}));setParts(p=>[...p,...np]);setTimeout(()=>setParts(p=>p.filter(pp=>!np.find(n=>n.id===pp.id))),2000)},[]);

  useEffect(()=>{
    const s={sold:deals.filter(d=>d.stage==="verkauft").length,rev:deals.filter(d=>d.stage==="verkauft").reduce((a,d)=>a+d.value,0),streak,total:deals.length,hot:deals.filter(d=>d.heat>=5).length,gold:deals.filter(d=>d.stage==="gold").length,acts:deals.reduce((a,d)=>a+d.acts.length,0)};
    const nu=ACHIEVEMENTS.filter(a=>a.check(s)&&!unlocked.includes(a.id));
    if(nu.length){setUnlocked(p=>[...p,...nu.map(a=>a.id)]);nu.forEach((a,i)=>setTimeout(()=>msg(`ðŸ… ${a.icon} ${a.label}!`),i*800))}
  },[deals,streak]);

  // Apply automation rules on stage change
  const applyRules=useCallback((dealId,fromStage,toStage)=>{
    const deal=deals.find(d=>d.id===dealId);
    const dealLoc=deal?.loc||"";
    const active=rules.filter(r=>r.enabled&&(r.from==="*"||r.from===fromStage)&&r.to===toStage&&(r.scope==="hq"||r.scope===dealLoc));
    if(!active.length)return;
    setDeals(prev=>prev.map(d=>{
      if(d.id!==dealId)return d;
      let updated={...d,todos:[...d.todos],acts:[...d.acts]};
      active.forEach(r=>{
        if(r.action==="todo"){updated.todos=[{text:r.text,due:Date.now()+(r.days||0)*864e5,done:false,id:"t"+Date.now()+Math.random()},...updated.todos]}
        else{updated.acts=[{type:r.actType||"note",text:r.text,time:Date.now()},...updated.acts]}
      });
      return updated;
    }));
    active.forEach((r,i)=>setTimeout(()=>msg(`âš¡ Auto: ${r.action==="todo"?"â˜‘ï¸":"ðŸ“‹"} "${r.text}"`),300+i*600));
  },[rules,msg]);

  const drop=useCallback((id,ns)=>{
    const deal=deals.find(x=>x.id===id);
    if(!deal||deal.stage===ns)return;
    const oldStage=deal.stage;
    setDeals(p=>p.map(x=>x.id===id?{...x,stage:ns,changed:Date.now()}:x));
    // Trigger automations
    setTimeout(()=>applyRules(id,oldStage,ns),100);
    if(ns==="verkauft"){setStreak(s=>s+1);msg(`ðŸ† ${deal.name} verkauft! ${fmt(deal.value)}`);pop(innerWidth/2,innerHeight/2)}
    else if(ns==="lost"){setStreak(0);msg(`ðŸ’€ ${deal.name} verloren...`)}
    else if(ns==="gold"){msg(`ðŸ’Ž ${deal.name} â†’ Schrank der Hoffnung`)}
    setDragId(null);
  },[deals,pop,msg,applyRules]);

  const addDeal=useCallback(d=>{const id=nid.current++;setDeals(p=>[...p,{...d,id}]);setNewId(id);setShowAdd(false);msg(`ðŸŽ¯ ${d.name} hinzugefÃ¼gt!`);setTimeout(()=>setNewId(null),600)},[msg]);
  const addAct=useCallback((id,a)=>{setDeals(p=>p.map(d=>d.id===id?{...d,acts:[a,...d.acts]}:d));setSel(p=>p&&p.id===id?{...p,acts:[a,...p.acts]}:p)},[]);
  const setHeat=useCallback((id,h)=>{setDeals(p=>p.map(d=>d.id===id?{...d,heat:h}:d));setSel(p=>p&&p.id===id?{...p,heat:h}:p)},[]);
  const toggleTodo=useCallback((did,tid)=>{setDeals(p=>p.map(d=>d.id===did?{...d,todos:d.todos.map(t=>t.id===tid?{...t,done:!t.done}:t)}:d));setSel(p=>p&&p.id===did?{...p,todos:p.todos.map(t=>t.id===tid?{...t,done:!t.done}:t)}:p)},[]);
  const addTodo=useCallback((did,todo)=>{setDeals(p=>p.map(d=>d.id===did?{...d,todos:[todo,...d.todos]}:d));setSel(p=>p&&p.id===did?{...p,todos:[todo,...p.todos]}:p)},[]);
  const updateDeal=useCallback((did,field,val)=>{setDeals(p=>p.map(d=>d.id===did?{...d,[field]:val}:d));setSel(p=>p&&p.id===did?{...p,[field]:val}:p)},[]);
  const changeStage=useCallback((did,fromStage,toStage)=>{
    if(fromStage===toStage)return;
    const deal=deals.find(d=>d.id===did);
    setDeals(p=>p.map(d=>d.id===did?{...d,stage:toStage,changed:Date.now()}:d));
    setSel(p=>p&&p.id===did?{...p,stage:toStage,changed:Date.now()}:p);
    setTimeout(()=>applyRules(did,fromStage,toStage),100);
    if(toStage==="verkauft"){setStreak(s=>s+1);msg(`ðŸ† ${deal?.name} verkauft! ${fmt(deal?.value||0)}`);pop(innerWidth/2,innerHeight/2)}
    else if(toStage==="lost"){setStreak(0);msg(`ðŸ’€ ${deal?.name} verloren...`)}
    else if(toStage==="gold"){msg(`ðŸ—„ï¸ ${deal?.name} â†’ Schrank der Hoffnung`)}
  },[deals,applyRules,msg,pop]);

  const main=STAGES.filter(s=>!["lost","gold"].includes(s.id));
  const aging=filteredDeals.filter(d=>!["verkauft","lost","gold"].includes(d.stage)&&dSince(d.changed)>=(AGING[d.stage]||5)).length;
  const openTodos=filteredDeals.reduce((s,d)=>s+d.todos.filter(t=>!t.done).length,0);

  return <div style={{fontFamily:"'Outfit',sans-serif"}}>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>{`
      @keyframes appear{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
      @keyframes fly{0%{opacity:1;transform:translateY(0) scale(1) rotate(0)}100%{opacity:0;transform:translateY(-100px) scale(.3) rotate(360deg)}}
      @keyframes fadeIn{from{opacity:0}to{opacity:1}}
      @keyframes pop{0%{opacity:0;transform:scale(.9) translateY(12px)}100%{opacity:1;transform:scale(1) translateY(0)}}
      @keyframes toastIn{0%{opacity:0;transform:translateY(-16px)}100%{opacity:1;transform:translateY(0)}}
      @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
      *{box-sizing:border-box}
    `}</style>
    {parts.map(p=><Particle key={p.id} {...p}/>)}
    {toast&&<div style={{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",background:"#1a202c",color:"#fff",padding:"10px 20px",borderRadius:10,fontWeight:700,fontSize:13,zIndex:9999,boxShadow:"0 4px 20px rgba(0,0,0,.15)",animation:"toastIn .2s ease"}}>{toast}</div>}

    {/* Header */}
    <div style={{padding:"0 0 10px",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10}}>
      <div>
        <h1 style={{margin:0,fontSize:22,fontWeight:800,color:"#1a202c",letterSpacing:"-.02em"}}>Deal Flow</h1>
        <div style={{fontSize:11,color:"#A0AEC0",fontWeight:600,marginTop:2}}>
          {aging>0&&<span style={{color:"#E53E3E"}}>âš  {aging} Follow-Up  </span>}{openTodos>0&&<span style={{color:"#667EEA"}}>â˜‘ {openTodos} Todos  </span>}{!aging&&!openTodos&&"Alles im Griff"}
        </div>
      </div>
      <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
        {isHqUser&&<div style={{display:"flex",background:"#fff",borderRadius:8,border:"1px solid #EDF2F7",overflow:"hidden"}}>
          {LOCATIONS.map(l=><div key={l.id} onClick={()=>setCurLoc(l.id)} style={{padding:"6px 12px",fontSize:11,fontWeight:600,cursor:"pointer",background:curLoc===l.id?"#667EEA":"transparent",color:curLoc===l.id?"#fff":"#718096",transition:"all .15s",whiteSpace:"nowrap"}}>{l.label}</div>)}
        </div>}
        <button onClick={()=>setShowAuto(true)} style={{padding:"7px 12px",borderRadius:8,border:"1px solid #EDF2F7",background:"#fff",fontSize:12,fontWeight:600,color:"#718096",cursor:"pointer"}}>âš¡</button>
        <button onClick={()=>setShowIn(v=>!v)} style={{padding:"7px 12px",borderRadius:8,border:"1px solid #EDF2F7",background:showIn?"#EBF4FF":"#fff",fontSize:12,fontWeight:600,color:showIn?"#667EEA":"#718096",cursor:"pointer"}}>ðŸ“Š</button>
        <button onClick={()=>setShowAdd(true)} style={{padding:"7px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontSize:12,fontWeight:700,cursor:"pointer"}}>+ Kontakt</button>
      </div>
    </div>

    <div style={{padding:"0 0 12px"}}><Scores deals={filteredDeals} streak={streak}/></div>

    {showIn&&<div style={{padding:"0 0 12px",display:"flex",gap:12,flexWrap:"wrap",animation:"appear .3s"}}>
      <div style={{flex:"1 1 300px"}}><Funnel deals={filteredDeals}/></div>
      <div style={{flex:"1 1 380px"}}><Badges deals={filteredDeals} streak={streak} unlocked={unlocked}/></div>
    </div>}

    <div style={{padding:"0 0 12px",display:"flex",gap:4,overflowX:"auto",minHeight:320}}>
      {main.map(s=><Col key={s.id} stage={s} deals={filteredDeals.filter(d=>d.stage===s.id)} onDrop={drop} onDrag={setDragId} onClick={setSel} newId={newId}/>)}
    </div>

    <DropZone sid="gold" label="ðŸ—„ï¸ Schrank der Hoffnung" sub="Wertvolle Kontakte, die noch reifen" bc="#D69E2E" tc="#B7791F" cc="#B7791F" deals={filteredDeals.filter(d=>d.stage==="gold")} onDrop={drop} onDrag={setDragId}/>
    <DropZone sid="lost" label="ðŸ’€ Verloren" sub="Jederzeit wiederbelebbar" bc="#FEB2B2" tc="#E53E3E" cc="#A0AEC0" deals={filteredDeals.filter(d=>d.stage==="lost")} onDrop={drop} onDrag={setDragId}/>
    <div style={{height:32}}/>

    {showAdd&&<AddModal onClose={()=>setShowAdd(false)} onAdd={addDeal} currentLoc={curLoc}/>}
    {sel&&<DetailModal deal={sel} onClose={()=>setSel(null)} onAct={addAct} onHeat={setHeat} onToggleTodo={toggleTodo} onAddTodo={addTodo} onUpdateDeal={updateDeal} onChangeStage={changeStage}/>}
    {showAuto&&<AutoModal rules={rules} onUpdate={setRules} onClose={()=>setShowAuto(false)}/>}
  </div>
}

// Register globally so mountReactPipeline() can find it
window.__PIPELINE_APP = PipelineApp;

// Auto-mount if already visible
if(document.getElementById('react-pipeline-root') && document.getElementById('vkTabPipeline') && document.getElementById('vkTabPipeline').style.display !== 'none') {
    mountReactPipeline();
}
</script>

<!-- Jahresziel Modal -->
<div id="jahreszielModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none" onclick="if(event.target===this)closeJahreszielModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold" id="jahreszielModalTitle">Neues Jahresziel</h3><button onclick="closeJahreszielModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>
            <input type="hidden" id="jahreszielEditId" value="">
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Typ</label>
                <select id="jahreszielTyp" onchange="toggleJahreszielFelder()" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400">
                    <option value="umsatz">ðŸ’° Umsatzziel</option><option value="deckungsbeitrag">ðŸ“Š Deckungsbeitrag</option><option value="smart">ðŸŽ¯ SMART-Ziel</option><option value="soft_target">âœ… Soft Target</option>
                </select></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Titel</label><input id="jahreszielTitel" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="z.B. Jahresumsatz â‚¬850.000"></div>
            <div class="mb-4" id="jahreszielBeschreibungWrap"><label class="block text-sm font-semibold text-gray-700 mb-1">Beschreibung / SMART-Details</label><textarea id="jahreszielBeschreibung" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="S: M: A: R: T:"></textarea></div>
            <div class="grid grid-cols-3 gap-3 mb-4" id="jahreszielWerteWrap">
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Zielwert</label><input id="jahreszielZielwert" type="number" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Aktueller Wert</label><input id="jahreszielAktuellerWert" type="number" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Einheit</label><select id="jahreszielEinheit" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"><option value="â‚¬">â‚¬</option><option value="StÃ¼ck">StÃ¼ck</option><option value="Bewertungen">Bewertungen</option><option value="%">%</option></select></div>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t"><button onclick="closeJahreszielModal()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveJahresziel()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
        </div>
    </div>
</div>

<!-- Journal Modal -->
<div id="journalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none" onclick="if(event.target===this)closeJournalModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">GesprÃ¤ch protokollieren</h3><button onclick="closeJournalModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>
            <input type="hidden" id="journalEditId" value="">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Datum</label><input id="journalDatum" type="date" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Stimmung</label>
                    <div class="flex space-x-3 mt-1">
                        <button type="button" onclick="setJournalStimmung('positiv')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="positiv">ðŸ˜Š</button>
                        <button type="button" onclick="setJournalStimmung('neutral')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="neutral">ðŸ˜</button>
                        <button type="button" onclick="setJournalStimmung('besorgt')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="besorgt">ðŸ˜Ÿ</button>
                        <button type="button" onclick="setJournalStimmung('kritisch')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="kritisch">ðŸ˜¤</button>
                    </div><input type="hidden" id="journalStimmung" value=""></div>
            </div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Teilnehmer</label><input id="journalTeilnehmer" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="z.B. Matthias, Sascha (HQ)"></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Themen</label>
                <div class="flex flex-wrap gap-2" id="journalThemenTags">
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Umsatz/Zahlen" class="journal-thema-cb hidden"><span>ðŸ’° Umsatz</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Personal" class="journal-thema-cb hidden"><span>ðŸ‘¥ Personal</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Marketing" class="journal-thema-cb hidden"><span>ðŸ“¢ Marketing</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Werkstatt" class="journal-thema-cb hidden"><span>ðŸ”§ Werkstatt</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Einkauf" class="journal-thema-cb hidden"><span>ðŸ›’ Einkauf</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Ziele" class="journal-thema-cb hidden"><span>ðŸŽ¯ Ziele</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Work-Life-Balance" class="journal-thema-cb hidden"><span>âš–ï¸ WLB</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Sonstiges" class="journal-thema-cb hidden"><span>ðŸ“Œ Sonstiges</span></label>
                </div></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Aktuelle Lage</label><textarea id="journalLage" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Wie steht der Partner da?"></textarea></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">WÃ¼nsche an HQ</label><div id="journalWuensche" class="space-y-2 mb-2"></div><button onclick="addJournalWunsch()" class="text-sm text-vit-orange font-semibold">+ Wunsch</button></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Vereinbarte MaÃŸnahmen</label><div id="journalMassnahmen" class="space-y-2 mb-2"></div><button onclick="addJournalMassnahme()" class="text-sm text-vit-orange font-semibold">+ MaÃŸnahme</button></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Notizen</label><textarea id="journalNotizen" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Sonstiges..."></textarea></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">NÃ¤chster Termin</label><input id="journalNaechsterTermin" type="date" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
            <div class="flex justify-end space-x-3 pt-4 border-t"><button onclick="closeJournalModal()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveJournalEntry()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
        </div>
    </div>
</div>


<!-- vit:bikes Marketing Module React Components (Cockpit, Budget, Kampagnen, Reichweite) -->
<script type="text/babel">
(function(){
const{useState,useReducer,useEffect,createContext,useContext}=React;
const uid=()=>Math.random().toString(36).slice(2,9);
const fmt=v=>v.toLocaleString("de-DE");
const fmtE=v=>fmt(v)+" \u20ac";
const pct=(a,b)=>b?Math.round(a/b*100):0;
const clp=(v,a,b)=>Math.max(a,Math.min(b,v));
const ST={name:"Grafrath",plz:"82284"},YR=2026,UZ=838000,OBM=1500,LBM=600;
const MO=["Jan","Feb","M\u00e4r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

const SCORE={total:72,parts:[{n:"Google My Business",s:78,w:30,i:"\ud83d\udccd",c:"#2563eb"},{n:"Paid Reichweite",s:65,w:25,i:"\ud83c\udfaf",c:"#EF7D00"},{n:"Bewertungen",s:82,w:20,i:"\u2b50",c:"#ca8a04"},{n:"Organische Pr\u00e4senz",s:60,w:15,i:"\ud83d\udce1",c:"#9333ea"},{n:"Lokales Marketing",s:70,w:10,i:"\ud83c\udfea",c:"#16a34a"}],trend:[58,61,64,63,67,69,68,72],rank:12,ts:28,tips:[{a:"GMB Antwortrate auf 100%",p:4,e:"Einfach"},{a:"5 neue GMB-Fotos",p:3,e:"Einfach"},{a:"Lokales Event Q1",p:5,e:"Mittel"},{a:"Local Hero Video",p:4,e:"Mittel"}]};
const FN=[{l:"Budget",i:"\ud83d\udcb0",ist:3155,soll:3000,f:fmtE},{l:"Reichweite",i:"\ud83d\udc41",ist:192350,soll:200000,f:fmt},{l:"Klicks",i:"\ud83d\udc46",ist:1620,soll:1600,f:fmt},{l:"Leads",i:"\ud83c\udfaf",ist:10,soll:12,f:fmt},{l:"Termine",i:"\ud83d\udcc5",ist:7,soll:10,f:fmt},{l:"Abschl\u00fcsse",i:"\ud83e\udd1d",ist:4,soll:7,f:fmt},{l:"Umsatz",i:"\ud83d\udcb6",ist:19200,soll:100560,f:fmtE}];
const OL={ch:[{name:"Google Ads",icon:"\ud83d\udd0d",color:"#f59e0b",split:.8,k:{ko:1445,im:43541,cl:1049,le:4}},{name:"Meta Ads",icon:"\ud83d\udcd8",color:"#3b82f6",split:.2,k:{ko:279,im:148809,cl:571,le:2}}],mo:[{m:"Jan",g:1152,me:279,le:4,te:3,u:6800},{m:"Feb",g:1445,me:279,le:6,te:4,u:12400}],nw:{cpt:163,lm:9,sv:22,bm:1436}};
const LK=[{id:"e",n:"Events",i:"\ud83c\udfea",c:"#EF7D00"},{id:"f",n:"Print",i:"\ud83d\udcc4",c:"#9333ea"},{id:"o",n:"OOH",i:"\ud83e\udea7",c:"#2563eb"},{id:"s",n:"Sponsoring",i:"\ud83e\udd1d",c:"#16a34a"},{id:"x",n:"Sonstiges",i:"\ud83d\udce6",c:"#9ca3af"}];
const DL=[{id:"la1",kat:"e",t:"Fr\u00fchlings-Probefahrt-Tag",b:350,mo:2,s:"geplant"},{id:"la2",kat:"f",t:"Flyer Fr\u00fchjahrsaktion",b:180,mo:2,s:"bezahlt"},{id:"la3",kat:"o",t:"Banner Hauptstra\u00dfe",b:450,mo:0,s:"laufend"},{id:"la4",kat:"s",t:"TSV Trikots",b:200,mo:1,s:"bezahlt"},{id:"la5",kat:"e",t:"E-Bike Testevent",b:500,mo:3,s:"geplant"}];
const DKA=[{id:"k1",t:"Fr\u00fchjahrs-kampagne",typ:"hq",ch:"Google+Meta",st:"2026-02-15",en:"2026-04-30",s:"aktiv",b:4500,d:"Performance-Max"},{id:"k2",t:"E-Bike Leasing",typ:"hq",ch:"Meta",st:"2026-03-01",en:"2026-05-31",s:"geplant",b:2000,d:"Pendler"},{id:"k3",t:"Awareness Ganzjahr",typ:"hq",ch:"Google",st:"2026-01-01",en:"2026-12-31",s:"aktiv",b:12000,d:"Brand"},{id:"k4",t:"Probefahrt-Tag",typ:"lokal",ch:"Lokal",st:"2026-03-15",en:"2026-03-15",s:"geplant",b:350,d:"Testtag"},{id:"k5",t:"Stadtradeln",typ:"lokal",ch:"Lokal",st:"2026-05-01",en:"2026-05-21",s:"geplant",b:300,d:"Teamsponsor"}];
const ADS=[{n:"PerformanceMax",ch:"Google",sp:1162,im:39296,cl:848,le:3,cpc:1.37,ctr:2.16,co:"#f59e0b",bu:1162},{n:"Search Service",ch:"Google",sp:142,im:1944,cl:129,le:1,cpc:1.10,ctr:6.63,co:"#f59e0b",bu:150},{n:"Search Marken",ch:"Google",sp:141,im:2301,cl:72,le:0,cpc:1.96,ctr:3.13,co:"#f59e0b",bu:150},{n:"Awareness Lokal",ch:"Meta",sp:140,im:120730,cl:153,le:0,cpc:0.92,ctr:0.13,co:"#3b82f6",bu:140},{n:"Conversion E-Bike",ch:"Meta",sp:139,im:28079,cl:418,le:2,cpc:0.33,ctr:1.49,co:"#3b82f6",bu:140}];
const GMB={ra:4.7,rv:142,rr:87,kpis:[{l:"Aufrufe",v:1847,c:12,i:"\ud83d\udc41"},{l:"Anrufe",v:34,c:8,i:"\ud83d\udcde"},{l:"Routen",v:89,c:15,i:"\ud83d\uddfa"},{l:"Website",v:156,c:-3,i:"\ud83c\udf10"},{l:"Fotos",v:2340,c:22,i:"\ud83d\udcf8"},{l:"Nachrichten",v:12,c:50,i:"\ud83d\udcac"}],revs:[{a:"Sandra M.",r:5,t:"Super Beratung!",d:"12.02",ok:true},{a:"Thomas K.",r:5,t:"Top Service.",d:"08.02",ok:true},{a:"Julia W.",r:4,t:"Etwas Wartezeit.",d:"03.02",ok:false},{a:"Peter H.",r:3,t:"Mehr Leasing-Infos.",d:"28.01",ok:true}],di:[87,32,14,5,4]};
const ORG=[{n:"YouTube",i:"\ud83c\udfa5",co:"#ef4444",kp:[{l:"Subs",v:"12.4k",c:"+1.1k"},{l:"Views",v:"745k",c:"+12%"},{l:"Watch",v:"41.7kh",c:"+8%"},{l:"Likes",v:"11.6k",c:"+15%"}],no:"3 Videos"},{n:"Instagram",i:"\ud83d\udcf8",co:"#c026d3",kp:[{l:"Follower",v:"10.2k",c:"+340"},{l:"Engage",v:"4.2%",c:"+0.3%"},{l:"Posts",v:"847",c:"+12"},{l:"Reach",v:"3.4k",c:"+18%"}],no:"2 Posts+4 Stories"},{n:"TikTok",i:"\ud83c\udfb5",co:"#6b7280",kp:[{l:"Follower",v:"2.8k",c:"+210"},{l:"Videos",v:"124",c:"+6"},{l:"Likes",v:"89k",c:"+4.2k"},{l:"Views",v:"18.2k",c:"+22%"}],no:"1 Reel (8.4k)"}];

// State
function reducer(s,a){switch(a.type){case"AL":return{...s,lo:[...s.lo,{id:uid(),...a.d}]};case"DL":return{...s,lo:s.lo.filter(x=>x.id!==a.id)};case"AK":return{...s,ka:[...s.ka,{id:uid(),...a.d}]};case"DK":return{...s,ka:s.ka.filter(x=>x.id!==a.id)};default:return s;}}
const Ctx=createContext(null);
const useApp=()=>useContext(Ctx);

// Shared
const cs={card:"bg-white rounded-xl border border-gray-200 shadow-sm p-5 mb-4 hover:shadow-md transition-shadow",mono:"font-mono",lbl:"text-[9px] text-gray-400 font-semibold uppercase tracking-wider mb-1"};
function Bar({value,max,color="#EF7D00",h=4}){const p=max?clp(Math.round(value/max*100),0,100):0;return<div style={{height:h,background:"#f3f4f6",borderRadius:h,overflow:"hidden",width:"100%"}}><div style={{height:"100%",width:p+"%",background:color,borderRadius:h,transition:"width .8s ease"}}/></div>;}
function Bdg({text,color="#EF7D00"}){return<span className={cs.mono} style={{fontSize:9,fontWeight:600,color,background:color+"15",padding:"3px 8px",borderRadius:6}}>{text}</span>;}
function SBdg({s}){const m={aktiv:{t:"LIVE",c:"#16a34a"},geplant:{t:"GEPLANT",c:"#2563eb"},bezahlt:{t:"BEZAHLT",c:"#9ca3af"},laufend:{t:"LAUFEND",c:"#EF7D00"}};const x=m[s]||m.geplant;return<Bdg text={x.t} color={x.c}/>;}
function Ring({score,size=140,sw=7}){const r=(size-sw)/2,ci=2*Math.PI*r,of=ci-(score/100)*ci;return<svg width={size} height={size} style={{transform:"rotate(-90deg)"}}><circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#f3f4f6" strokeWidth={sw}/><circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#EF7D00" strokeWidth={sw} strokeDasharray={ci} strokeDashoffset={of} strokeLinecap="round" style={{transition:"stroke-dashoffset 1.2s ease"}}/></svg>;}

// â•â• COCKPIT â•â•
function Cockpit(){
  const up=pct(FN[6].ist,UZ),usp=pct(FN[6].ist,FN[6].soll);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
      <div className={cs.card} style={{boxShadow:"0 0 20px rgba(239,125,0,0.12)"}}>
        <div style={{display:"flex",alignItems:"center",gap:20}}>
          <div style={{position:"relative",flexShrink:0}}><Ring score={SCORE.total}/><div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}><span style={{fontSize:40,fontWeight:900,color:"#EF7D00"}}>{SCORE.total}</span><span style={{fontSize:10,color:"#9ca3af"}}>von 100</span></div></div>
          <div style={{flex:1}}><h2 style={{fontSize:16,fontWeight:800,color:"#111827",marginBottom:2}}>Sichtbarkeitsscore</h2><p style={{fontSize:11,color:"#6b7280",marginBottom:10}}>Deine lokale Sichtbarkeit</p>
            {SCORE.parts.map((p,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}><span style={{fontSize:11,width:14}}>{p.i}</span><span style={{fontSize:10,color:"#6b7280",flex:1}}>{p.n}</span><div style={{width:70}}><Bar value={p.s} max={100} color={p.c} h={3}/></div><span className={cs.mono} style={{fontSize:10,color:p.c,width:24,textAlign:"right"}}>{p.s}</span></div>)}
            <div style={{display:"flex",alignItems:"center",gap:10,marginTop:10,padding:"7px 10px",background:"#f9fafb",borderRadius:8}}><span style={{fontSize:10,color:"#9ca3af"}}>Rang</span><span className={cs.mono} style={{fontSize:15,fontWeight:800,color:"#EF7D00"}}>{SCORE.rank}</span><span style={{fontSize:10,color:"#9ca3af"}}>/ {SCORE.ts}</span><div style={{flex:1}}/><svg width={56} height={16}>{SCORE.trend.map((v,i)=>i>0?<line key={i} x1={(i-1)*8} y1={16-((SCORE.trend[i-1]-50)/40)*16} x2={i*8} y2={16-((v-50)/40)*16} stroke="#EF7D00" strokeWidth={1.5}/>:null)}</svg></div>
          </div>
        </div>
      </div>
      <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:16,fontWeight:800,color:"#111827"}}>Umsatzziel {YR}</h2><p style={{fontSize:11,color:"#9ca3af"}}>{ST.name}</p></div><span style={{fontSize:26,fontWeight:900,color:"#EF7D00"}}>{fmtE(UZ)}</span></div><div style={{marginBottom:10}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:11,color:"#6b7280"}}>{fmtE(FN[6].ist)} erreicht</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:up>=10?"#16a34a":"#dc2626"}}>{up}%</span></div><Bar value={FN[6].ist} max={UZ} h={7}/></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginTop:14}}>{[["YTD Soll",fmtE(FN[6].soll)],["Zielerr.",usp+"%",usp>=90?"#16a34a":"#dc2626"],["Ã˜ Bon",fmtE(Math.round(FN[6].ist/(FN[5].ist||1)))]].map(([l,v,c],i)=><div key={i} style={{padding:10,background:"#f9fafb",borderRadius:10,textAlign:"center"}}><p className={cs.lbl}>{l}</p><p className={cs.mono} style={{fontSize:15,fontWeight:700,color:c||"#111827"}}>{v}</p></div>)}</div>
      </div>
    </div>
    {/* Funnel */}
    <div className={cs.card} style={{padding:24}}><h2 style={{fontSize:15,fontWeight:800,color:"#111827",marginBottom:3}}>Marketing-Funnel</h2><p style={{fontSize:10,color:"#9ca3af",marginBottom:16}}>Budget \u2192 Reichweite \u2192 Klicks \u2192 Leads \u2192 Termine \u2192 Abschl\u00fcsse \u2192 Umsatz</p>
      <div style={{display:"flex",alignItems:"stretch",gap:0}}>{FN.map((s,i)=>{const r=s.soll?s.ist/s.soll:1;const col=r>=.9?"#16a34a":r>=.7?"#ca8a04":"#dc2626";const bg=r>=.9?"rgba(22,163,74,0.06)":r>=.7?"rgba(202,138,4,0.06)":"rgba(220,38,38,0.06)";const cv=i>0&&i<6?(FN[i].ist/(FN[i-1].ist||1)*100):null;return<React.Fragment key={i}><div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",padding:"14px 6px",background:bg,borderRadius:10,border:"1px solid "+col+"25"}}><span style={{fontSize:20,marginBottom:4}}>{s.i}</span><span className={cs.mono} style={{fontSize:15,fontWeight:800,color:col}}>{s.f(s.ist)}</span><span style={{fontSize:8,color:"#9ca3af",marginTop:3}}>{s.l}</span><div style={{width:"100%",margin:"6px 0 3px"}}><Bar value={s.ist} max={s.soll} color={col} h={3}/></div><span className={cs.mono} style={{fontSize:8,color:"#9ca3af"}}>{Math.round(r*100)}%</span></div>{i<FN.length-1&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:28,flexShrink:0}}><svg width="14" height="10" viewBox="0 0 14 10"><path d="M0 5h10M8 1l4 4-4 4" fill="none" stroke="#d1d5db" strokeWidth="1.2"/></svg>{cv!==null&&<span className={cs.mono} style={{fontSize:7,color:"#9ca3af",marginTop:1}}>{cv<1?cv.toFixed(2):cv.toFixed(0)}%</span>}</div>}</React.Fragment>;})}</div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><div className={cs.card}><h2 style={{fontSize:13,fontWeight:800,color:"#111827",marginBottom:10}}>\ud83d\ude80 Score verbessern</h2>{SCORE.tips.map((t,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:i<SCORE.tips.length-1?"1px solid #f3f4f6":"none"}}><div style={{width:32,height:32,borderRadius:8,background:"rgba(239,125,0,0.08)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><span className={cs.mono} style={{fontSize:12,fontWeight:800,color:"#EF7D00"}}>+{t.p}</span></div><div><p style={{fontSize:11,fontWeight:600,color:"#111827"}}>{t.a}</p><p style={{fontSize:9,color:"#9ca3af"}}>{t.e}</p></div></div>)}</div>
      <div className={cs.card}><h2 style={{fontSize:13,fontWeight:800,color:"#111827",marginBottom:10}}>\ud83d\udcc8 vs. Netzwerk</h2>{[["Budget/Mo",fmtE(OBM),fmtE(OL.nw.bm),null],["Leads/Mo","5.0","9.0",true],["CPT",fmtE(Math.round(3155/7)),fmtE(163),true],["Store Visits","39","22",false]].map(([l,mi,nw,nb],i)=><div key={i} style={{display:"flex",alignItems:"center",gap:6,padding:"8px 0",borderBottom:i<3?"1px solid #f3f4f6":"none"}}><span style={{fontSize:11,color:"#9ca3af",flex:1}}>{l}</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:70,textAlign:"right",color:"#111827"}}>{mi}</span><span style={{fontSize:9,color:"#d1d5db"}}>vs</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:70,textAlign:"right",color:nb?"#16a34a":"#6b7280"}}>{nw}{nb&&" \u2713"}</span></div>)}</div>
    </div>
  </div>;
}

// â•â• BUDGET â•â•
function Budget(){
  const{state:st,dispatch:dp}=useApp();const[sa,setSa]=useState(false);const[fm,sFm]=useState({t:"",k:"e",b:"",m:2,s:"geplant"});
  const ad=()=>{if(!fm.t||!fm.b)return;dp({type:"AL",d:{kat:fm.k,t:fm.t,b:Number(fm.b),mo:fm.m,s:fm.s}});setSa(false);};
  const lt=st.lo.reduce((s,a)=>s+a.b,0),lj=LBM*12,oY=OL.mo.reduce((s,m)=>s+m.g+m.me,0);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:16}}>{[{l:"Gesamtbudget",v:fmtE(OBM*12+lj),s:fmtE(OBM+LBM)+"/Mo"},{l:"Online (HQ)",v:fmtE(OBM*12),s:"HQ steuert",c:"#2563eb"},{l:"Lokal (Du)",v:fmtE(lj),s:"Du steuerst",c:"#EF7D00"},{l:"Ausgegeben YTD",v:fmtE(oY+lt),s:pct(oY+lt,OBM*12+lj)+"% v. Jahr"}].map((k,i)=><div key={i} className={cs.card} style={{textAlign:"center",padding:14}}><p className={cs.lbl}>{k.l}</p><p className={cs.mono} style={{fontSize:20,fontWeight:800,color:k.c||"#111827"}}>{k.v}</p><p style={{fontSize:9,color:"#9ca3af",marginTop:2}}>{k.s}</p></div>)}</div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"#111827"}}>Online-Marketing</h2><p style={{fontSize:10,color:"#9ca3af"}}>HQ steuert die Aufteilung</p></div><Bdg text="HQ-GESTEUERT" color="#2563eb"/></div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>{OL.ch.map(ch=><div key={ch.name} style={{padding:14,background:"#f9fafb",borderRadius:10,borderLeft:"3px solid "+ch.color}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{fontWeight:700,fontSize:12,color:"#111827"}}>{ch.icon} {ch.name}</span><span className={cs.mono} style={{fontSize:10,color:"#9ca3af"}}>{Math.round(ch.split*100)}%</span></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}}>{[["Kosten",fmtE(ch.k.ko)],["Klicks",fmt(ch.k.cl)],["Leads",""+ch.k.le]].map(([l,v],j)=><div key={j}><p style={{fontSize:8,color:"#9ca3af"}}>{l}</p><p className={cs.mono} style={{fontSize:13,fontWeight:700,color:"#111827"}}>{v}</p></div>)}</div></div>)}</div>
    </div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"#111827"}}>Lokales Marketing</h2><p style={{fontSize:10,color:"#9ca3af"}}>Dein Budget, deine Entscheidung</p></div><div style={{display:"flex",gap:6}}><Bdg text="DU STEUERST" color="#EF7D00"/><button onClick={()=>setSa(!sa)} style={{padding:"6px 14px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>+ Ausgabe</button></div></div>
      <div style={{padding:14,background:"#f9fafb",borderRadius:10,marginBottom:14}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:11,color:"#6b7280"}}>{fmtE(lt)} von {fmtE(lj)}</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:"#EF7D00"}}>{pct(lt,lj)}%</span></div><Bar value={lt} max={lj} h={5}/></div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:6,marginBottom:14}}>{LK.map(k=>{const sm=st.lo.filter(a=>a.kat===k.id).reduce((s,a)=>s+a.b,0);return<div key={k.id} style={{padding:10,background:"#f9fafb",borderRadius:8,textAlign:"center"}}><span style={{fontSize:16}}>{k.i}</span><p className={cs.mono} style={{fontSize:13,fontWeight:700,color:k.c,marginTop:2}}>{fmtE(sm)}</p><p style={{fontSize:8,color:"#9ca3af"}}>{k.n}</p></div>;})}</div>
      {sa&&<div style={{padding:14,background:"#fff7ed",borderRadius:10,marginBottom:14,border:"1px solid #fed7aa"}}><div style={{display:"flex",gap:6,flexWrap:"wrap"}}><input value={fm.t} onChange={e=>sFm({...fm,t:e.target.value})} placeholder="Titel..." style={{flex:1,minWidth:140,padding:"6px 10px",border:"1px solid #e5e7eb",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}/><select value={fm.k} onChange={e=>sFm({...fm,k:e.target.value})} style={{padding:"6px 10px",border:"1px solid #e5e7eb",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}>{LK.map(k=><option key={k.id} value={k.id}>{k.i} {k.n}</option>)}</select><input type="number" value={fm.b} onChange={e=>sFm({...fm,b:e.target.value})} placeholder="\u20ac" style={{width:70,padding:"6px 10px",border:"1px solid #e5e7eb",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}/><button onClick={ad} style={{padding:"6px 16px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>Speichern</button></div></div>}
      {st.lo.map(a=>{const k=LK.find(x=>x.id===a.kat)||LK[4];return<div key={a.id} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:"1px solid #f3f4f6"}}><span style={{fontSize:14}}>{k.i}</span><div style={{flex:1}}><span style={{fontSize:11,fontWeight:600,color:"#111827"}}>{a.t}</span><span style={{fontSize:9,color:"#9ca3af",marginLeft:6}}>{MO[a.mo]}</span></div><SBdg s={a.s}/><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:60,textAlign:"right",color:"#111827"}}>{fmtE(a.b)}</span><button onClick={()=>dp({type:"DL",id:a.id})} style={{background:"none",border:"none",color:"#d1d5db",cursor:"pointer",fontSize:12}}>\u2715</button></div>;})}
    </div>
  </div>;
}

// â•â• KAMPAGNEN â•â•
function Kampagnen(){
  const{state:st,dispatch:dp}=useApp();const[fi,sFi]=useState("alle");const[sa,setSa]=useState(false);const[fm,sFm]=useState({t:"",ch:"Lokal",st:"",en:"",b:"",d:"",typ:"lokal",s:"geplant"});
  const ak=()=>{if(!fm.t)return;dp({type:"AK",d:{...fm,b:Number(fm.b)||0}});setSa(false);};
  const fl=st.ka.filter(k=>fi==="hq"?k.typ==="hq":fi==="lokal"?k.typ==="lokal":fi==="aktiv"?k.s==="aktiv":true).sort((a,b)=>(a.st||"").localeCompare(b.st||""));
  const tM=MO.slice(0,6);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:16}}>{[{l:"Gesamt",v:st.ka.length},{l:"Aktiv",v:st.ka.filter(k=>k.s==="aktiv").length,c:"#16a34a"},{l:"HQ",v:st.ka.filter(k=>k.typ==="hq").length,c:"#2563eb"},{l:"Eigene",v:st.ka.filter(k=>k.typ==="lokal").length,c:"#EF7D00"}].map((k,i)=><div key={i} className={cs.card} style={{textAlign:"center",padding:14}}><p className={cs.lbl}>{k.l}</p><p className={cs.mono} style={{fontSize:26,fontWeight:800,color:k.c||"#111827"}}>{k.v}</p></div>)}</div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div style={{display:"flex",gap:4}}>{[{k:"alle",l:"Alle"},{k:"aktiv",l:"Aktiv"},{k:"hq",l:"\ud83c\udfe2 HQ"},{k:"lokal",l:"\ud83d\udccd Eigene"}].map(f=><button key={f.k} onClick={()=>sFi(f.k)} style={{padding:"4px 10px",borderRadius:7,border:"1px solid "+(fi===f.k?"#EF7D00":"#e5e7eb"),background:fi===f.k?"rgba(239,125,0,0.08)":"transparent",color:fi===f.k?"#EF7D00":"#9ca3af",fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:"Outfit"}}>{f.l}</button>)}</div><button onClick={()=>setSa(!sa)} style={{padding:"6px 14px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>+ Eigene Aktion</button></div>
      {fl.map(k=><div key={k.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 0",borderBottom:"1px solid #f3f4f6"}}><div style={{width:3,height:28,borderRadius:2,background:k.typ==="hq"?"#2563eb":"#EF7D00",flexShrink:0}}/><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:1}}><span style={{fontSize:12,fontWeight:700,color:"#111827"}}>{k.t}</span><SBdg s={k.s}/>{k.typ==="hq"&&<Bdg text="HQ" color="#2563eb"/>}</div><div style={{display:"flex",gap:10,fontSize:9,color:"#9ca3af"}}><span>{k.ch}</span>{k.st&&<span>{k.st.slice(5)}\u2192{k.en?.slice(5)||"?"}</span>}<span className={cs.mono}>{fmtE(k.b)}</span></div></div>{k.typ==="lokal"&&<button onClick={()=>dp({type:"DK",id:k.id})} style={{background:"none",border:"none",color:"#d1d5db",cursor:"pointer",fontSize:12}}>\u2715</button>}</div>)}
    </div>
  </div>;
}

// â•â• REICHWEITE â•â•
function Reichweite(){
  const[rf,sRf]=useState("alle");const fr=GMB.revs.filter(r=>rf==="offen"?!r.ok:rf==="kritisch"?r.r<=3:true);
  return<div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"#111827"}}>Aktive Kampagnen</h2><p style={{fontSize:10,color:"#9ca3af"}}>Was das HQ f\u00fcr dich schaltet</p></div><Bdg text="\u25cf LIVE" color="#16a34a"/></div>
      {ADS.map((c,i)=><div key={i} style={{padding:12,background:"#f9fafb",borderRadius:10,marginBottom:6,borderLeft:"3px solid "+c.co}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><div style={{display:"flex",gap:6,alignItems:"center"}}><span style={{fontSize:11,fontWeight:700,color:"#111827"}}>{c.n}</span><Bdg text={c.ch} color={c.co}/></div><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:"#111827"}}>{fmtE(c.sp)}</span></div><div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr) 1.2fr",gap:8}}>{[["Impr.",fmt(c.im)],["Klicks",fmt(c.cl)],["CTR",c.ctr+"%"],["CPC",c.cpc.toFixed(2)+"\u20ac"],["Leads",""+c.le]].map(([l,v],j)=><div key={j}><p style={{fontSize:7,color:"#9ca3af",textTransform:"uppercase"}}>{l}</p><p className={cs.mono} style={{fontSize:12,fontWeight:700,color:l==="Leads"&&c.le>0?"#16a34a":"#111827"}}>{v}</p></div>)}<div><p style={{fontSize:7,color:"#9ca3af",textTransform:"uppercase"}}>Budget</p><Bar value={c.sp} max={c.bu} color={c.co} h={3}/></div></div></div>)}
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
      <div className={cs.card}><div style={{display:"flex",alignItems:"center",gap:8,marginBottom:14}}><div style={{width:32,height:32,borderRadius:8,background:"linear-gradient(135deg,#4285F4,#34A853)",display:"flex",alignItems:"center",justifyContent:"center"}}><span style={{color:"#fff",fontSize:14,fontWeight:900}}>G</span></div><div><h2 style={{fontSize:13,fontWeight:800,color:"#111827"}}>Google My Business</h2><div style={{display:"flex",alignItems:"center",gap:3}}><span style={{color:"#fbbf24",fontSize:12}}>\u2605</span><span className={cs.mono} style={{fontSize:13,fontWeight:700,color:"#111827"}}>{GMB.ra}</span><span style={{fontSize:9,color:"#9ca3af"}}>({GMB.rv})</span></div></div></div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6}}>{GMB.kpis.map((k,i)=><div key={i} style={{padding:8,background:"#f9fafb",borderRadius:8,textAlign:"center"}}><span style={{fontSize:12}}>{k.i}</span><p className={cs.mono} style={{fontSize:14,fontWeight:700,color:"#111827",marginTop:1}}>{fmt(k.v)}</p><p style={{fontSize:7,color:"#9ca3af"}}>{k.l}</p><p className={cs.mono} style={{fontSize:8,color:k.c>0?"#16a34a":"#dc2626"}}>{k.c>0?"+":""}{k.c}%</p></div>)}</div>
      </div>
      <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:10}}><h2 style={{fontSize:13,fontWeight:800,color:"#111827"}}>\u2b50 Bewertungen</h2><div style={{display:"flex",gap:3}}>{[{k:"alle",l:"Alle"},{k:"offen",l:"Offen"},{k:"kritisch",l:"\u26a0 1-3"}].map(f=><button key={f.k} onClick={()=>sRf(f.k)} style={{padding:"2px 7px",borderRadius:5,border:"1px solid "+(rf===f.k?"#EF7D00":"#e5e7eb"),background:rf===f.k?"rgba(239,125,0,0.06)":"transparent",color:rf===f.k?"#EF7D00":"#9ca3af",fontSize:9,fontWeight:600,cursor:"pointer",fontFamily:"Outfit"}}>{f.l}</button>)}</div></div>
        {fr.map((r,i)=><div key={i} style={{padding:8,borderRadius:8,marginBottom:3,background:!r.ok?"#fefce8":"#f9fafb",border:"1px solid "+(r.ok?"#f3f4f6":"#fde68a")}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:1}}><div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontSize:10,fontWeight:600,color:"#111827"}}>{r.a}</span><span style={{fontSize:8,color:"#9ca3af"}}>{r.d}</span></div><div style={{display:"flex",alignItems:"center",gap:3}}>{[1,2,3,4,5].map(s=><span key={s} style={{color:s<=r.r?"#fbbf24":"#e5e7eb",fontSize:8}}>\u2605</span>)}{r.ok?<Bdg text="\u2713" color="#16a34a"/>:<Bdg text="OFFEN" color="#ca8a04"/>}</div></div><p style={{fontSize:10,color:"#6b7280",marginLeft:0}}>{r.t}</p></div>)}
      </div>
    </div>
    <div className={cs.card}><h2 style={{fontSize:15,fontWeight:800,color:"#111827",marginBottom:3}}>\ud83d\udce1 Organische Reichweite</h2><p style={{fontSize:10,color:"#9ca3af",marginBottom:14}}>vit:bikes Brand inkl. deiner Sichtbarkeit</p>
      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>{ORG.map(ch=><div key={ch.n} style={{padding:14,background:"#f9fafb",borderRadius:10,borderTop:"2px solid "+ch.co}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:10}}><span style={{fontSize:18}}>{ch.i}</span><span style={{fontSize:13,fontWeight:800,color:"#111827"}}>{ch.n}</span></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>{ch.kp.map((k,i)=><div key={i}><p style={{fontSize:7,color:"#9ca3af",textTransform:"uppercase"}}>{k.l}</p><p className={cs.mono} style={{fontSize:14,fontWeight:700,color:"#111827"}}>{k.v}</p><p className={cs.mono} style={{fontSize:8,color:"#16a34a"}}>{k.c}</p></div>)}</div><div style={{marginTop:10,padding:6,background:"#fff",borderRadius:6,border:"1px solid #f3f4f6"}}><p style={{fontSize:9,color:"#6b7280"}}>\ud83d\udccd {ch.no}</p></div></div>)}</div>
    </div>
  </div>;
}

// â•â• APP WRAPPER (shared state) â•â•
function MktApp({tab}){
  const[state,dispatch]=useReducer(reducer,{lo:DL,ka:DKA});
  const comps={cockpit:Cockpit,budget:Budget,kampagnen:Kampagnen,reichweite:Reichweite};
  const C=comps[tab]||Cockpit;
  return<Ctx.Provider value={{state,dispatch}}><C/></Ctx.Provider>;
}

// Mount into portal containers
const mktState={lo:DL,ka:DKA};
function mountMktTab(tab,elId){
  const el=document.getElementById(elId);
  if(el&&!el._mounted){el._mounted=true;ReactDOM.createRoot(el).render(<MktApp tab={tab}/>);}
}

// Observe tab visibility to mount on first show
const mktObs=new MutationObserver(()=>{
  const tabs={mktReactCockpit:"cockpit",mktReactBudget:"budget",mktReactKampagnen:"kampagnen",mktReactReichweite:"reichweite"};
  Object.entries(tabs).forEach(([elId,tab])=>{
    const el=document.getElementById(elId);
    if(el&&el.offsetParent!==null) mountMktTab(tab,elId);
  });
});

// Start observing when marketing view becomes visible
const initMkt=()=>{
  const mv=document.getElementById("marketingView");
  if(mv){mktObs.observe(mv,{attributes:true,subtree:true,attributeFilter:["style"]});}
  // Mount cockpit immediately if visible
  setTimeout(()=>mountMktTab("cockpit","mktReactCockpit"),100);
};

// Hook into existing showMarketingTab
const _origMktTab=window.showMarketingTab;
if(_origMktTab){
  window.showMarketingTab=function(t){
    _origMktTab(t);
    setTimeout(()=>{
      const tabs={cockpit:"mktReactCockpit",budget:"mktReactBudget",kampagnen:"mktReactKampagnen",reichweite:"mktReactReichweite"};
      if(tabs[t]) mountMktTab(t,tabs[t]);
    },50);
  };
}

// Init on DOM ready
if(document.readyState==="complete") initMkt();
else window.addEventListener("load",initMkt);
})();
</script>






<!-- Theme Switching -->
<script>
function toggleTheme() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
}
function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    try { localStorage.setItem('vit-theme', theme); } catch(e){}
    var track = document.getElementById('themeToggleTrack');
    if(track) {
        if(theme === 'dark') track.classList.add('active');
        else track.classList.remove('active');
    }
}
// Init on load
(function(){
    var saved = 'light';
    try { saved = localStorage.getItem('vit-theme') || 'light'; } catch(e){}
    setTheme(saved);
})();
</script>


<!-- â•â•â• NUTZERPROFIL SLIDE-OVER PANEL â•â•â• -->
<div id="profilePanel" style="display:none;position:fixed;inset:0;z-index:9999;">
    <!-- Backdrop -->
    <div onclick="closeProfilePanel()" style="position:absolute;inset:0;background:rgba(0,0,0,0.4);transition:opacity 0.3s;" id="profileBackdrop"></div>
    <!-- Panel -->
    <div id="profileSlider" style="position:absolute;top:0;right:0;bottom:0;width:380px;background:var(--vit-white,#fff);box-shadow:-8px 0 30px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.16,1,0.3,1);overflow-y:auto;">

        <!-- Header -->
        <div style="padding:24px 24px 0;position:relative;">
            <button onclick="closeProfilePanel()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;padding:4px;">âœ•</button>
            <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:#9ca3af;font-weight:600;margin-bottom:16px;">Mein Profil</p>

            <!-- Avatar + Name -->
            <div style="text-align:center;margin-bottom:24px;">
                <div style="position:relative;display:inline-block;">
                    <img id="profileAvatarImg" src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" style="width:80px;height:80px;border-radius:50%;border:3px solid #EF7D00;">
                    <label for="profilePhotoUpload" style="position:absolute;bottom:0;right:0;width:26px;height:26px;border-radius:50%;background:#EF7D00;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid white;font-size:12px;" title="Foto Ã¤ndern">ðŸ“·</label>
                    <input type="file" id="profilePhotoUpload" accept="image/*" style="display:none;" onchange="handleProfilePhoto(this)">
                </div>
                <h2 id="profileNameDisplay" style="font-size:20px;font-weight:800;margin-top:10px;color:#111827;">Demo User</h2>
                <p id="profileRoleDisplay" style="font-size:12px;color:#9ca3af;">Inhaber</p>
                <p id="profileStandortDisplay" style="font-size:11px;color:#9ca3af;margin-top:2px;">ðŸ“ Grafrath</p>
            </div>
        </div>

        <!-- PersÃ¶nliche Daten -->
        <div style="padding:0 24px 24px;">
            <div style="background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:#9ca3af;font-weight:600;margin-bottom:12px;">PersÃ¶nliche Daten</p>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:#6b7280;font-weight:600;display:block;margin-bottom:3px;">Vorname</label>
                    <input id="profileVorname" type="text" value="Max" style="width:100%;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='#e5e7eb'">
                </div>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:#6b7280;font-weight:600;display:block;margin-bottom:3px;">Nachname</label>
                    <input id="profileNachname" type="text" value="Bauer" style="width:100%;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='#e5e7eb'">
                </div>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:#6b7280;font-weight:600;display:block;margin-bottom:3px;">E-Mail</label>
                    <input id="profileEmail" type="email" value="max@vitbikes-grafrath.de" disabled style="width:100%;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;background:#f3f4f6;color:#6b7280;font-family:Outfit,sans-serif;">
                    <p style="font-size:9px;color:#9ca3af;margin-top:2px;">Wird vom HQ verwaltet</p>
                </div>

                <div style="margin-bottom:0;">
                    <label style="font-size:11px;color:#6b7280;font-weight:600;display:block;margin-bottom:3px;">Rolle</label>
                    <div id="profileRolle" style="width:100%;padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;background:#f3f4f6;color:#6b7280;">Inhaber</div>
                    <p style="font-size:9px;color:#9ca3af;margin-top:2px;">Wird vom HQ verwaltet</p>
                </div>
            </div>

            <!-- Erscheinungsbild -->
            <div style="background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:#9ca3af;font-weight:600;margin-bottom:12px;">Erscheinungsbild</p>
                <div style="display:flex;gap:8px;">
                    <button onclick="setTheme('light')" id="profileThemeLight" style="flex:1;padding:12px;border-radius:10px;border:2px solid #EF7D00;background:#f9fafb;cursor:pointer;text-align:center;">
                        <span style="font-size:20px;">â˜€ï¸</span>
                        <p style="font-size:11px;font-weight:600;color:#111827;margin-top:4px;">Light</p>
                    </button>
                    <button onclick="setTheme('dark')" id="profileThemeDark" style="flex:1;padding:12px;border-radius:10px;border:2px solid transparent;background:#1a1a1e;cursor:pointer;text-align:center;">
                        <span style="font-size:20px;">ðŸŒ™</span>
                        <p style="font-size:11px;font-weight:600;color:#f0f0f0;margin-top:4px;">Dark</p>
                    </button>
                </div>
            </div>

            <!-- Speichern -->
            <button onclick="saveProfile()" style="width:100%;padding:12px;background:#EF7D00;color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif;margin-bottom:12px;transition:opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                Ã„nderungen speichern
            </button>

            <!-- Passwort / Abmelden -->
            <div style="display:flex;gap:8px;">
                <button onclick="changePassword()" style="flex:1;padding:8px;background:none;border:1px solid #e5e7eb;border-radius:8px;font-size:11px;color:#6b7280;cursor:pointer;font-family:Outfit,sans-serif;">ðŸ”’ Passwort Ã¤ndern</button>
                <button onclick="handleLogout()" style="flex:1;padding:8px;background:none;border:1px solid #fecaca;border-radius:8px;font-size:11px;color:#dc2626;cursor:pointer;font-family:Outfit,sans-serif;">ðŸšª Abmelden</button>
            </div>

            <!-- Meta -->
            <div style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px;text-align:center;">
                <p style="font-size:9px;color:#9ca3af;">vit:bikes Partner Portal v7.0 Â· Mitglied seit Jan 2025</p>
            </div>
        </div>
    </div>
</div>

<!-- Profile Panel JS -->
<script>
function openProfilePanel() {
    var panel = document.getElementById('profilePanel');
    var slider = document.getElementById('profileSlider');
    panel.style.display = 'block';
    // Populate from sbProfile if available
    if(typeof sbProfile !== 'undefined' && sbProfile) {
        var nameParts = (sbProfile.name || 'Demo User').split(' ');
        document.getElementById('profileVorname').value = nameParts[0] || '';
        document.getElementById('profileNachname').value = nameParts.slice(1).join(' ') || '';
        document.getElementById('profileEmail').value = sbProfile.email || '';
        document.getElementById('profileNameDisplay').textContent = sbProfile.name || 'Demo User';
        document.getElementById('profileRoleDisplay').textContent = (typeof currentRole !== 'undefined' ? currentRole : sbProfile.is_hq ? 'HQ' : 'Inhaber');
        var roleEl = document.getElementById('profileRolle'); if(roleEl) roleEl.textContent = (typeof currentRole !== 'undefined' ? currentRole : sbProfile.is_hq ? 'HQ' : 'Inhaber');
        var stdName = sbProfile.standort_name || ((typeof sbStandort !== 'undefined' && sbStandort) ? sbStandort.name : '');
        document.getElementById('profileStandortDisplay').textContent = stdName ? 'ðŸ“ ' + stdName : '';
        // Avatar
        var avatarUrl = sbProfile.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(sbProfile.name||'User') + '&background=EF7D00&color=fff';
        document.getElementById('profileAvatarImg').src = avatarUrl;
    }
    // Theme buttons
    updateProfileThemeButtons();
    // Animate in
    requestAnimationFrame(function(){
        slider.style.transform = 'translateX(0)';
    });
}

function closeProfilePanel() {
    var slider = document.getElementById('profileSlider');
    slider.style.transform = 'translateX(100%)';
    setTimeout(function(){
        document.getElementById('profilePanel').style.display = 'none';
    }, 350);
}

function updateProfileThemeButtons() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var lightBtn = document.getElementById('profileThemeLight');
    var darkBtn = document.getElementById('profileThemeDark');
    if(lightBtn) lightBtn.style.borderColor = current === 'light' ? '#EF7D00' : 'transparent';
    if(darkBtn) darkBtn.style.borderColor = current === 'dark' ? '#EF7D00' : 'transparent';
}

// Override setTheme to also update profile buttons
var _origSetTheme = typeof setTheme === 'function' ? setTheme : null;
setTheme = function(theme) {
    if(_origSetTheme) _origSetTheme(theme);
    else {
        document.documentElement.setAttribute('data-theme', theme);
        try { localStorage.setItem('vit-theme', theme); } catch(e){}
    }
    updateProfileThemeButtons();
};

async function saveProfile() {
    var vorname = document.getElementById('profileVorname').value.trim();
    var nachname = document.getElementById('profileNachname').value.trim();
    var fullName = (vorname + ' ' + nachname).trim();

    if(typeof sb !== 'undefined' && typeof sbProfile !== 'undefined' && sbProfile) {
        try {
            var upd = { name: fullName };
            var resp = await sb.from('users').update(upd).eq('id', sbProfile.id);
            if(resp.error) throw resp.error;
            // Update local state
            sbProfile.name = fullName;
            // Update UI
            document.querySelectorAll('[data-user-name]').forEach(function(el){ el.textContent = fullName; });
            document.getElementById('profileNameDisplay').textContent = fullName;
            var avatarUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(fullName) + '&background=EF7D00&color=fff';
            document.getElementById('profileAvatarImg').src = avatarUrl;
            var topAvatar = document.getElementById('userAvatarImg');
            if(topAvatar) topAvatar.src = avatarUrl;
            alert('âœ… Profil gespeichert!');
        } catch(e) {
            console.error('Profile save error:', e);
            alert('Fehler beim Speichern: ' + (e.message||e));
        }
    } else {
        alert('âœ… Profil gespeichert! (Demo-Modus)');
    }
}

function handleProfilePhoto(input) {
    if(input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profileAvatarImg').src = e.target.result;
            var topAvatar = document.getElementById('userAvatarImg');
            if(topAvatar) topAvatar.src = e.target.result;
            // TODO: Upload to Supabase Storage
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function changePassword() {
    var newPw = prompt('Neues Passwort eingeben (min. 8 Zeichen):');
    if(!newPw || newPw.length < 8) { if(newPw !== null) alert('Passwort muss mindestens 8 Zeichen haben.'); return; }
    if(typeof sb !== 'undefined') {
        sb.auth.updateUser({ password: newPw }).then(function(res){
            if(res.error) alert('Fehler: ' + res.error.message);
            else alert('âœ… Passwort geÃ¤ndert!');
        });
    } else {
        alert('âœ… Passwort geÃ¤ndert! (Demo-Modus)');
    }
}
</script>



<!-- â•â•â• BWA MOTIVATION + ESKALATION SYSTEM â•â•â• -->
<script>
(function(){
    // â”€â”€â”€â”€ CONFIG â”€â”€â”€â”€
    var MO_NAMES = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    var STANDORTE_DEMO = [
        {id:'s1',name:'MÃ¼nchen City',submitted:'2026-02-03',rating:'gold'},
        {id:'s2',name:'Berlin Mitte',submitted:'2026-02-05',rating:'gold'},
        {id:'s3',name:'Hamburg Altona',submitted:'2026-02-07',rating:'gold'},
        {id:'s4',name:'Frankfurt Main',submitted:'2026-02-10',rating:'ok'},
        {id:'s5',name:'KÃ¶ln Ehrenfeld',submitted:'2026-02-11',rating:'ok'},
        {id:'s6',name:'Stuttgart West',submitted:'2026-02-14',rating:'ok'},
        {id:'s7',name:'DÃ¼sseldorf',submitted:'2026-02-15',rating:'ok'},
        {id:'s8',name:'Leipzig',submitted:null,rating:'missing'},
        {id:'s9',name:'Dresden',submitted:null,rating:'missing'},
        {id:'s10',name:'NÃ¼rnberg',submitted:null,rating:'missing'},
        {id:'s11',name:'Hannover',submitted:null,rating:'missing'},
        {id:'s12',name:'Grafrath',submitted:null,rating:'missing'},
        {id:'s13',name:'MÃ¼nster',submitted:null,rating:'missing'},
        {id:'s14',name:'Freiburg',submitted:null,rating:'missing'},
        {id:'s15',name:'Augsburg',submitted:null,rating:'missing'},
        {id:'s16',name:'Bonn',submitted:null,rating:'overdue'},
        {id:'s17',name:'Mannheim',submitted:null,rating:'overdue'},
        {id:'s18',name:'Karlsruhe',submitted:'2026-02-18',rating:'overdue'},
        {id:'s19',name:'Dortmund',submitted:null,rating:'missing'},
        {id:'s20',name:'Essen',submitted:null,rating:'missing'},
        {id:'s21',name:'Bremen',submitted:'2026-02-12',rating:'ok'}
    ];

    // â”€â”€â”€â”€ HELPERS â”€â”€â”€â”€
    function getBwaMonth(today) {
        var d = today || new Date();
        var m = d.getMonth(); // 0-based
        var y = d.getFullYear();
        // BWA bezieht sich auf Vormonat
        if(m === 0) return {y:y-1, m:11};
        return {y:y, m:m-1};
    }

    function getDeadline(bwaMonth) {
        // Deadline = 15. des Folgemonats
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        return new Date(fy, fm, 15, 23, 59, 59);
    }

    function getEskalationsStufe(today, bwaMonth) {
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        // Are we in the follow month?
        if(today.getFullYear() < fy || (today.getFullYear() === fy && today.getMonth() < fm)) return -1; // not yet
        if(today.getFullYear() > fy || today.getMonth() > fm) return 3; // way past
        var day = today.getDate();
        if(day <= 7) return 0;
        if(day <= 12) return 1;
        if(day <= 15) return 2;
        return 3;
    }

    function getRating(submittedDate, bwaMonth) {
        if(!submittedDate) return 'missing';
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        var d8 = new Date(fy, fm, 8, 23, 59, 59);
        var d15 = new Date(fy, fm, 15, 23, 59, 59);
        var sd = new Date(submittedDate);
        if(sd <= d8) return 'gold';
        if(sd <= d15) return 'ok';
        return 'overdue';
    }

    function daysUntil(deadline) {
        var now = new Date();
        return Math.ceil((deadline - now) / (1000*60*60*24));
    }

    function ratingBadge(rating) {
        var map = {
            gold: {t:'ðŸ¥‡ GOLD', c:'#ca8a04', bg:'rgba(202,138,4,0.1)'},
            ok: {t:'âœ… OK', c:'#16a34a', bg:'rgba(22,163,74,0.1)'},
            overdue: {t:'ðŸš¨ ÃœBERFÃ„LLIG', c:'#dc2626', bg:'rgba(220,38,38,0.1)'},
            missing: {t:'â³ AUSSTEHEND', c:'#9ca3af', bg:'rgba(156,163,175,0.1)'}
        };
        var m = map[rating] || map.missing;
        return '<span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;color:'+m.c+';background:'+m.bg+'">'+m.t+'</span>';
    }

    function eskalationBadge(stufe) {
        var cols = ['#9ca3af','#ca8a04','#ea580c','#dc2626'];
        var c = cols[Math.min(stufe,3)] || cols[0];
        return '<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;color:'+c+';background:'+c+'18">Stufe '+stufe+'</span>';
    }

    // â”€â”€â”€â”€ STANDORT-SICHT: Cockpit Widget â”€â”€â”€â”€
    function updateBwaDeadlineWidget() {
        var today = new Date();
        var bwaMo = getBwaMonth(today);
        var deadline = getDeadline(bwaMo);
        var stufe = getEskalationsStufe(today, bwaMo);
        var days = daysUntil(deadline);
        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;

        // Check if current user submitted (demo: use Grafrath)
        var myStandort = STANDORTE_DEMO.find(function(s){return s.name==='Grafrath';});
        var submitted = myStandort && myStandort.submitted;
        var rating = myStandort ? myStandort.rating : 'missing';

        var titleEl = document.getElementById('bwaDeadlineTitle');
        var subEl = document.getElementById('bwaDeadlineSubtext');
        var daysEl = document.getElementById('bwaCountdownDays');
        var ringEl = document.getElementById('bwaRingCircle');
        var ctaEl = document.getElementById('bwaUploadCTA');
        var badgeEl = document.getElementById('bwaRatingBadge');
        var eskBanner = document.getElementById('bwaEskalationBanner');

        if(!titleEl) return;

        if(submitted && rating !== 'missing') {
            // Already submitted
            titleEl.textContent = 'BWA fÃ¼r ' + moName + ' eingereicht';
            subEl.textContent = 'Eingereicht am ' + submitted.split('-').reverse().join('.');
            badgeEl.innerHTML = ratingBadge(rating);
            badgeEl.style.display = '';
            ctaEl.style.display = 'none';
            daysEl.textContent = 'âœ“';
            daysEl.style.color = '#16a34a';
            daysEl.style.fontSize = '20px';
            ringEl.style.stroke = '#16a34a';
            ringEl.setAttribute('stroke-dashoffset', '0');
            eskBanner.style.display = 'none';
            // Show KPI report
            showKpiReport(bwaMo, rating);
            // Unlock benchmark
            setBenchmarkLock(false);
        } else {
            // Not submitted
            ctaEl.style.display = '';
            badgeEl.style.display = 'none';
            setBenchmarkLock(true);
            document.getElementById('bwaKpiReport').style.display = 'none';

            if(days > 0) {
                titleEl.textContent = 'Noch ' + days + ' Tage bis zur BWA-Deadline';
                subEl.textContent = 'BWA fÃ¼r ' + moName + ' Â· Frist: 15. ' + MO_NAMES[bwaMo.m+1 > 11 ? 0 : bwaMo.m+1];
                daysEl.textContent = days;
                daysEl.style.color = days <= 3 ? '#dc2626' : days <= 7 ? '#ca8a04' : '#EF7D00';
                ringEl.style.stroke = days <= 3 ? '#dc2626' : days <= 7 ? '#ca8a04' : '#EF7D00';
                var pct = Math.max(0, 1 - days/15);
                ringEl.setAttribute('stroke-dashoffset', (175.9 * (1-pct)).toFixed(1));

                // CTA subtext
                if(days > 7) {
                    ctaEl.textContent = 'ðŸ¥‡ FrÃ¼habgabe = Gold-Status!';
                } else {
                    ctaEl.textContent = 'ðŸ“¤ BWA jetzt einreichen';
                }
            } else {
                var overdueDays = Math.abs(days);
                titleEl.textContent = 'BWA ist seit ' + overdueDays + ' Tag' + (overdueDays>1?'en':'') + ' Ã¼berfÃ¤llig';
                subEl.textContent = 'BWA fÃ¼r ' + moName + ' Â· Deadline war der 15.';
                daysEl.textContent = '!';
                daysEl.style.color = '#dc2626';
                daysEl.style.fontSize = '24px';
                ringEl.style.stroke = '#dc2626';
                ringEl.setAttribute('stroke-dashoffset', '0');
                ctaEl.textContent = 'ðŸš¨ BWA sofort einreichen';
                ctaEl.style.background = '#dc2626';
            }

            // Eskalation Banner
            if(stufe >= 2) {
                eskBanner.style.display = '';
                var eskText = document.getElementById('bwaEskText');
                var eskSub = document.getElementById('bwaEskSub');
                if(stufe === 2) {
                    eskText.textContent = 'Eskalationsstufe 2 â€“ Nur noch ' + Math.max(0,days) + ' Tage!';
                    eskSub.textContent = 'Reiche jetzt ein, um Stufe 3 und HQ-Benachrichtigung zu vermeiden.';
                } else {
                    eskText.textContent = 'Eskalationsstufe 3 â€“ BWA Ã¼berfÃ¤llig!';
                    eskSub.textContent = 'Ohne aktuelle Zahlen kÃ¶nnen wir dich nicht gezielt bei Einkauf, Marketing und Controlling unterstÃ¼tzen.';
                    eskBanner.style.background = '#fef2f2';
                    eskBanner.style.borderColor = '#fca5a5';
                }
            } else {
                eskBanner.style.display = 'none';
            }
        }

        // Netzwerk-Widget
        updateNetzwerkWidget();
    }

    // â”€â”€â”€â”€ NETZWERK WIDGET (Standort-Sicht) â”€â”€â”€â”€
    function updateNetzwerkWidget() {
        var gold = 0, ok = 0, missing = 0, overdue = 0;
        STANDORTE_DEMO.forEach(function(s) {
            if(s.rating==='gold') gold++;
            else if(s.rating==='ok') ok++;
            else if(s.rating==='overdue') overdue++;
            else missing++;
        });
        var total = STANDORTE_DEMO.length;
        var submitted = gold + ok + overdue;
        var pct = Math.round(submitted / total * 100);

        var el = function(id) { return document.getElementById(id); };
        if(el('bwaNetzwerkProgress')) el('bwaNetzwerkProgress').textContent = submitted + ' von ' + total + ' eingereicht';
        if(el('bwaNetzwerkBar')) el('bwaNetzwerkBar').style.width = pct + '%';
        if(el('bwaNwGold')) el('bwaNwGold').textContent = 'ðŸ¥‡ Gold: ' + gold;
        if(el('bwaNwOk')) el('bwaNwOk').textContent = 'âœ… OK: ' + ok;
        if(el('bwaNwMissing')) el('bwaNwMissing').textContent = 'â³ Ausstehend: ' + missing;
        if(el('bwaNwOverdue')) el('bwaNwOverdue').textContent = 'ðŸš¨ ÃœberfÃ¤llig: ' + overdue;
    }

    // â”€â”€â”€â”€ KPI REPORT (Sofort-Nutzen nach Upload) â”€â”€â”€â”€
    function showKpiReport(bwaMo, rating) {
        var report = document.getElementById('bwaKpiReport');
        if(!report) return;
        report.style.display = '';

        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;
        document.getElementById('bwaKpiReportMonth').textContent = moName;
        document.getElementById('bwaKpiRating').innerHTML = ratingBadge(rating);

        // Demo KPIs
        var kpis = [
            {l:'Umsatz', v:'68.400 â‚¬', c:'+4.2%', co:'#16a34a'},
            {l:'Rohertrag', v:'24.100 â‚¬', c:'36.7%', co:'#2563eb'},
            {l:'Personalkosten', v:'13.600 â‚¬', c:'19.9%', co:'#ca8a04'},
            {l:'Ergebnis', v:'3.200 â‚¬', c:'+12%', co:'#16a34a'}
        ];
        var grid = document.getElementById('bwaKpiReportGrid');
        grid.innerHTML = kpis.map(function(k){
            return '<div style="padding:12px;background:#f9fafb;border-radius:10px;text-align:center"><p style="font-size:9px;color:#9ca3af;text-transform:uppercase">'+k.l+'</p><p style="font-size:18px;font-weight:800;color:#111827;margin-top:2px">'+k.v+'</p><p style="font-size:10px;font-weight:600;color:'+k.co+'">'+k.c+'</p></div>';
        }).join('');

        // Insights
        var recs = [
            'Rohertragsmarge +2.5 Pp Ã¼ber Netzwerk-Durchschnitt â€“ starke Performance! ðŸ’ª',
            'Personalkosten leicht Ã¼ber Schnitt (19.9% vs. 18.5%) â€“ Arbeitszeitplanung prÃ¼fen.',
            'Werkstatt-Umsatz +8% ggÃ¼. Vorjahr â€“ Trend beibehalten mit proaktiver Service-Ansprache.'
        ];
        document.getElementById('bwaKpiRecList').innerHTML = recs.map(function(r){return '<li>â†’ '+r+'</li>';}).join('');
    }

    // â”€â”€â”€â”€ BENCHMARK LOCK â”€â”€â”€â”€
    function setBenchmarkLock(locked) {
        var overlay = document.getElementById('benchmarkLockOverlay');
        var content = document.getElementById('benchmarkContent');
        if(!overlay || !content) return;
        if(locked) {
            overlay.style.display = '';
            content.style.display = 'none';
        } else {
            overlay.style.display = 'none';
            content.style.display = '';
        }
    }

    // â”€â”€â”€â”€ HQ-SICHT: BWA Netzwerk-Status â”€â”€â”€â”€
    function renderHqBwaStatus() {
        var bwaMo = getBwaMonth(new Date());
        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;
        var deadline = getDeadline(bwaMo);
        var today = new Date();

        var el = function(id){return document.getElementById(id);};
        if(el('hqBwaMonth')) el('hqBwaMonth').textContent = moName;

        // Sort: gold first, then ok, then overdue, then missing
        var order = {gold:0, ok:1, overdue:2, missing:3};
        var sorted = STANDORTE_DEMO.slice().sort(function(a,b){return (order[a.rating]||3) - (order[b.rating]||3);});

        var gold=0, ok=0, overdue=0, missing=0;
        sorted.forEach(function(s){
            if(s.rating==='gold') gold++;
            else if(s.rating==='ok') ok++;
            else if(s.rating==='overdue') overdue++;
            else missing++;
        });

        var total = sorted.length;
        var submitted = gold + ok + overdue;
        var pct = Math.round(submitted/total*100);

        if(el('hqBwaSubmitted')) el('hqBwaSubmitted').textContent = submitted;
        if(el('hqBwaTotal')) el('hqBwaTotal').textContent = total;
        if(el('hqBwaGold')) el('hqBwaGold').textContent = gold;
        if(el('hqBwaOk')) el('hqBwaOk').textContent = ok;
        if(el('hqBwaMissing')) el('hqBwaMissing').textContent = missing;
        if(el('hqBwaOverdue')) el('hqBwaOverdue').textContent = overdue;
        if(el('hqBwaPct')) el('hqBwaPct').textContent = pct + '%';
        if(el('hqBwaBar')) el('hqBwaBar').style.width = pct + '%';

        // Table
        var tbody = el('hqBwaTableBody');
        if(!tbody) return;

        tbody.innerHTML = sorted.map(function(s){
            var stufe = s.rating === 'missing' ? getEskalationsStufe(today, bwaMo) : (s.rating==='overdue'?3:0);
            var dl = daysUntil(deadline);
            var daysText = s.submitted ? s.submitted.split('-').reverse().join('.') : (dl>0 ? 'noch '+dl+' Tage' : Math.abs(dl)+' Tage Ã¼berfÃ¤llig');
            var daysColor = s.submitted ? '#16a34a' : (dl>0 ? '#9ca3af' : '#dc2626');
            return '<tr class="text-sm">'+
                '<td class="py-2.5 font-semibold text-gray-800">'+s.name+'</td>'+
                '<td class="py-2.5">'+(s.submitted ? '<span class="text-green-600 text-xs font-semibold">âœ“ Eingereicht</span>' : '<span class="text-gray-400 text-xs">Ausstehend</span>')+'</td>'+
                '<td class="py-2.5">'+ratingBadge(s.rating)+'</td>'+
                '<td class="py-2.5 text-xs text-gray-500">'+(s.submitted||'â€”')+'</td>'+
                '<td class="py-2.5">'+(s.rating==='missing'||s.rating==='overdue' ? eskalationBadge(stufe) : '<span class="text-xs text-gray-300">â€”</span>')+'</td>'+
                '<td class="py-2.5 text-xs" style="color:'+daysColor+'">'+daysText+'</td>'+
                '</tr>';
        }).join('');
    }

    // â”€â”€â”€â”€ INIT â”€â”€â”€â”€
    // Hook into controlling view activation
    var _origShowCtrl = window.showControllingTab;
    if(_origShowCtrl) {
        window.showControllingTab = function(t) {
            _origShowCtrl(t);
            if(t === 'cockpit') setTimeout(updateBwaDeadlineWidget, 100);
        };
    }

    // Hook into HQ Finanzen view
    var _origShowView = window.showView;
    if(_origShowView) {
        var _wrapped = false;
        if(!_wrapped) {
            window.showView = function(v) {
                _origShowView(v);
                if(v === 'hqFinanzen' || v === 'controlling') {
                    setTimeout(function(){
                        if(v === 'hqFinanzen') renderHqBwaStatus();
                        if(v === 'controlling') updateBwaDeadlineWidget();
                    }, 150);
                }
            };
            _wrapped = true;
        }
    }

    // Auto-init if controlling is visible
    setTimeout(function(){
        updateBwaDeadlineWidget();
        renderHqBwaStatus();
    }, 500);
})();
</script>


<!-- â•â•â• TRAINER ENGINE â•â•â• -->
<style>
.trainer-card{background:linear-gradient(135deg,#fffbf5,#fff);border:1px solid #fed7aa;border-radius:16px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden;transition:all 0.3s;}
.trainer-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#f97316,#fb923c);}
.trainer-card:hover{box-shadow:0 4px 20px rgba(249,115,22,0.12);}
.trainer-card .tc-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;padding:3px 8px;border-radius:6px;}
.trainer-card .tc-badge.perf{background:#fef3c7;color:#92400e;}
.trainer-card .tc-badge.onb{background:#dbeafe;color:#1e40af;}
.trainer-drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:9998;opacity:0;transition:opacity 0.3s;}
.trainer-drawer-backdrop.active{opacity:1;}
.trainer-drawer{position:fixed;top:0;right:0;bottom:0;width:440px;max-width:95vw;background:#fff;z-index:9999;transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.16,1,0.3,1);overflow-y:auto;box-shadow:-8px 0 30px rgba(0,0,0,0.15);}
.trainer-drawer.open{transform:translateX(0);}
.trainer-step{padding:20px 24px;border-bottom:1px solid #f3f4f6;}
.trainer-step.active{background:#fffbf5;}
.trainer-step .step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0;}
.trainer-step .step-num.done{background:#dcfce7;color:#16a34a;}
.trainer-step .step-num.current{background:#f97316;color:#fff;}
.trainer-step .step-num.upcoming{background:#f3f4f6;color:#9ca3af;}
.trainer-locked-card{background:linear-gradient(135deg,#fef2f2,#fff);border:2px dashed #fecaca;border-radius:16px;padding:32px;text-align:center;}
</style>

<script>
// â•â•â• TRAINER ENGINE v1.0 â•â•â•
(function(){
    'use strict';
    
    var trainerState = {
        trainers: [],
        assignments: [],
        completions: [],
        onboarding: null,
        activeDrawer: null,
        currentStep: 0,
        stepResults: {}
    };

    // â”€â”€ Event Logging â”€â”€
    window.logPortalEvent = async function(eventType, meta) {
        if(typeof sb === 'undefined' || !sbUser) return;
        try {
            await sb.from('portal_events').insert({
                user_id: sbUser.id,
                standort_id: sbProfile ? sbProfile.standort_id : null,
                event_type: eventType,
                meta: meta || {}
            });
        } catch(e) { console.warn('logEvent:', e); }
    };

    // â”€â”€ Load Active Trainers for Area â”€â”€
    async function loadTrainersForArea(areaKey) {
        if(typeof sb === 'undefined' || !sbProfile) return [];
        var sid = sbProfile.standort_id;
        try {
            // Get active assignments for this standort
            var aResp = await sb.from('trainer_assignments')
                .select('*, trainer:trainer_id(*)')
                .eq('standort_id', sid)
                .eq('status', 'active');
            var assignments = (aResp.data || []).filter(function(a) {
                if(!a.trainer || !a.trainer.is_active) return false;
                if(areaKey && a.trainer.area_key !== areaKey) return false;
                // Check cooldown
                if(a.cooldown_until && new Date(a.cooldown_until) > new Date()) return false;
                return true;
            });
            
            // Also check for onboarding trainers if not done
            if(trainerState.onboarding && !trainerState.onboarding.onboarding_done) {
                var oResp = await sb.from('trainers')
                    .select('*')
                    .eq('mode', 'onboarding')
                    .eq('is_active', true)
                    .eq('trigger_type', 'onboarding_step');
                var obTrainers = (oResp.data || []).filter(function(t) {
                    var cond = t.trigger_condition_json || {};
                    return cond.phase === trainerState.onboarding.phase && cond.step === trainerState.onboarding.step;
                });
                // Add onboarding trainers as virtual assignments
                obTrainers.forEach(function(t) {
                    if(!assignments.find(function(a){ return a.trainer_id === t.id; })) {
                        assignments.push({ id: 'ob_'+t.id, trainer_id: t.id, trainer: t, status: 'active', _isOnboarding: true });
                    }
                });
            }
            
            // Sort: onboarding first, then by priority
            assignments.sort(function(a,b) {
                if(a._isOnboarding && !b._isOnboarding) return -1;
                if(!a._isOnboarding && b._isOnboarding) return 1;
                return (a.trainer.priority||3) - (b.trainer.priority||3);
            });
            
            return assignments.slice(0, 1); // max 1 per area
        } catch(e) { console.warn('loadTrainers:', e); return []; }
    }

    // â”€â”€ Load Onboarding State â”€â”€
    async function loadOnboardingState() {
        if(typeof sb === 'undefined' || !sbUser) return;
        try {
            var resp = await sb.from('user_onboarding').select('*').eq('user_id', sbUser.id).maybeSingle();
            trainerState.onboarding = resp.data;
        } catch(e) { console.warn('loadOnboarding:', e); }
    }

    // â”€â”€ Render Trainer Card â”€â”€
    function renderTrainerCard(assignment, containerEl) {
        if(!assignment || !assignment.trainer || !containerEl) return;
        var t = assignment.trainer;
        var modeLabel = t.mode === 'onboarding' ? 'Onboarding' : 'Training';
        var modeCls = t.mode === 'onboarding' ? 'onb' : 'perf';
        var areaIcons = {verkauf:'ðŸ’°',controlling:'ðŸ“Š',marketing:'ðŸ“±',einkauf:'ðŸ“¦',werkstatt:'ðŸ”§',allgemein:'ðŸ '};
        
        var html = '<div class="trainer-card" id="trainerCard_'+assignment.id+'">'
            + '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">'
            + '<div style="flex:1">'
            + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
            + '<span class="tc-badge '+modeCls+'">'+modeLabel+'</span>'
            + '<span style="font-size:10px;color:#9ca3af">'+(areaIcons[t.area_key]||'ðŸ“‹')+' '+t.area_key+'</span>'
            + '<span style="font-size:10px;color:#9ca3af">Â· '+t.duration_minutes+' Min</span>'
            + '</div>'
            + '<h3 style="font-size:15px;font-weight:800;color:#111827;margin-bottom:4px">'+escH(t.title)+'</h3>'
            + '<p style="font-size:13px;color:#6b7280;line-height:1.4">'+escH(t.summary||'')+'</p>'
            + '</div>'
            + '<div style="flex-shrink:0;font-size:32px">'+(areaIcons[t.area_key]||'ðŸ“‹')+'</div>'
            + '</div>'
            + '<div style="display:flex;align-items:center;gap:8px;margin-top:14px">'
            + '<button onclick="window._trainerStart(\''+assignment.id+'\',\''+t.id+'\')" style="padding:8px 20px;background:#f97316;color:white;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif">â–¶ Starten</button>'
            + '<button onclick="window._trainerSnooze(\''+assignment.id+'\')" style="padding:8px 16px;background:none;border:1px solid #e5e7eb;border-radius:8px;font-size:12px;color:#9ca3af;cursor:pointer;font-family:Outfit,sans-serif">SpÃ¤ter</button>'
            + '</div>'
            + '</div>';
        
        containerEl.innerHTML = html;
    }

    // â”€â”€ Trainer Drawer (Micro-Learning) â”€â”€
    function openTrainerDrawer(trainerId) {
        var trainer = null;
        // Find trainer in state
        trainerState.assignments.forEach(function(a) {
            if(a.trainer && a.trainer.id === trainerId) trainer = a.trainer;
        });
        if(!trainer) {
            // Try direct load
            sb.from('trainers').select('*').eq('id', trainerId).single().then(function(r) {
                if(r.data) { _buildDrawer(r.data); }
            });
            return;
        }
        _buildDrawer(trainer);
    }

    function _buildDrawer(trainer) {
        trainerState.activeDrawer = trainer;
        trainerState.currentStep = 0;
        trainerState.stepResults = {};
        
        var steps = (trainer.content_json || {}).steps || [];
        var areaIcons = {verkauf:'ðŸ’°',controlling:'ðŸ“Š',marketing:'ðŸ“±',einkauf:'ðŸ“¦',werkstatt:'ðŸ”§',allgemein:'ðŸ '};
        
        // Remove existing
        var old = document.getElementById('trainerDrawerBackdrop');
        if(old) old.remove();
        old = document.getElementById('trainerDrawer');
        if(old) old.remove();
        
        // Backdrop
        var backdrop = document.createElement('div');
        backdrop.id = 'trainerDrawerBackdrop';
        backdrop.className = 'trainer-drawer-backdrop';
        backdrop.onclick = function(){ closeTrainerDrawer(); };
        document.body.appendChild(backdrop);
        
        // Drawer
        var drawer = document.createElement('div');
        drawer.id = 'trainerDrawer';
        drawer.className = 'trainer-drawer';
        
        var h = '<div style="padding:20px 24px;border-bottom:1px solid #f3f4f6;position:sticky;top:0;background:#fff;z-index:1">'
            + '<div style="display:flex;align-items:center;justify-content:space-between">'
            + '<div>'
            + '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">'
            + '<span style="font-size:16px">'+(areaIcons[trainer.area_key]||'ðŸ“‹')+'</span>'
            + '<span style="font-size:10px;font-weight:700;text-transform:uppercase;color:#f97316;letter-spacing:0.05em">'+(trainer.mode==='onboarding'?'Onboarding':'Training')+'</span>'
            + '</div>'
            + '<h2 style="font-size:18px;font-weight:800;color:#111827">'+escH(trainer.title)+'</h2>'
            + '</div>'
            + '<button onclick="closeTrainerDrawer()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;padding:4px">âœ•</button>'
            + '</div>'
            + '<div style="display:flex;align-items:center;gap:12px;margin-top:12px">'
            + '<div style="flex:1;height:4px;background:#f3f4f6;border-radius:2px;overflow:hidden"><div id="trainerProgressBar" style="height:100%;background:#f97316;border-radius:2px;width:0%;transition:width 0.5s"></div></div>'
            + '<span id="trainerStepLabel" style="font-size:11px;color:#9ca3af;white-space:nowrap">0/'+steps.length+'</span>'
            + '</div>'
            + '</div>';
        
        h += '<div id="trainerStepsContainer">';
        steps.forEach(function(step, i) {
            h += '<div class="trainer-step'+(i===0?' active':'')+'" id="trainerStep_'+i+'" style="'+(i>0?'display:none':'')+'">'
                + '<div style="display:flex;align-items:flex-start;gap:12px">'
                + '<div class="step-num '+(i===0?'current':'upcoming')+'" id="trainerStepNum_'+i+'">'+(i+1)+'</div>'
                + '<div style="flex:1">'
                + '<h3 style="font-size:15px;font-weight:700;color:#111827;margin-bottom:8px">'+escH(step.title||'Schritt '+(i+1))+'</h3>'
                + '<p style="font-size:13px;color:#4b5563;line-height:1.6;white-space:pre-line">'+escH(step.body||'')+'</p>';
            
            if(step.type === 'question' && step.options) {
                h += '<div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px" id="trainerOpts_'+i+'">';
                step.options.forEach(function(opt, oi) {
                    h += '<button onclick="window._trainerSelectOpt('+i+','+oi+',this)" style="padding:6px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:12px;color:#374151;cursor:pointer;background:#fff;font-family:Outfit,sans-serif;transition:all 0.2s">'+escH(opt)+'</button>';
                });
                h += '</div>';
            }
            
            if(step.type === 'action' && step.input_placeholder) {
                h += '<textarea id="trainerInput_'+i+'" placeholder="'+escH(step.input_placeholder)+'" style="width:100%;margin-top:12px;padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:13px;font-family:Outfit,sans-serif;resize:vertical;min-height:60px;outline:none" onfocus="this.style.borderColor=\'#f97316\'" onblur="this.style.borderColor=\'#e5e7eb\'"></textarea>';
            }
            
            if(step.cta) {
                h += '<button onclick="'+step.cta+';closeTrainerDrawer()" style="margin-top:12px;padding:8px 16px;background:#f97316;color:white;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif">â†’ Direkt Ã¶ffnen</button>';
            }
            
            h += '</div></div></div>';
        });
        h += '</div>';
        
        // Footer
        h += '<div style="padding:20px 24px;border-top:1px solid #f3f4f6;position:sticky;bottom:0;background:#fff;display:flex;align-items:center;justify-content:space-between">'
            + '<button id="trainerPrevBtn" onclick="window._trainerPrev()" style="padding:8px 16px;background:none;border:1px solid #e5e7eb;border-radius:8px;font-size:12px;color:#6b7280;cursor:pointer;font-family:Outfit,sans-serif;display:none">â† ZurÃ¼ck</button>'
            + '<div style="flex:1"></div>'
            + '<button id="trainerNextBtn" onclick="window._trainerNext()" style="padding:10px 24px;background:#f97316;color:white;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif">Weiter â†’</button>'
            + '</div>';
        
        drawer.innerHTML = h;
        document.body.appendChild(drawer);
        
        // Animate in
        requestAnimationFrame(function(){
            backdrop.classList.add('active');
            drawer.classList.add('open');
        });
        
        _updateDrawerUI();
        
        // Log start
        logPortalEvent('trainer_started', { trainer_id: trainer.id, title: trainer.title });
        // Insert completion record
        if(typeof sb !== 'undefined' && sbUser) {
            sb.from('trainer_completions').insert({
                user_id: sbUser.id,
                standort_id: sbProfile ? sbProfile.standort_id : null,
                trainer_id: trainer.id
            });
        }
    }

    function _updateDrawerUI() {
        var trainer = trainerState.activeDrawer;
        if(!trainer) return;
        var steps = (trainer.content_json || {}).steps || [];
        var cur = trainerState.currentStep;
        var total = steps.length;
        
        // Progress
        var bar = document.getElementById('trainerProgressBar');
        var label = document.getElementById('trainerStepLabel');
        if(bar) bar.style.width = Math.round(((cur+1)/total)*100) + '%';
        if(label) label.textContent = (cur+1)+'/'+total;
        
        // Show/hide steps
        for(var i=0; i<total; i++) {
            var el = document.getElementById('trainerStep_'+i);
            var num = document.getElementById('trainerStepNum_'+i);
            if(el) { el.style.display = i===cur ? 'block' : 'none'; el.className = 'trainer-step'+(i===cur?' active':''); }
            if(num) num.className = 'step-num '+(i<cur?'done':i===cur?'current':'upcoming');
        }
        
        // Buttons
        var prev = document.getElementById('trainerPrevBtn');
        var next = document.getElementById('trainerNextBtn');
        if(prev) prev.style.display = cur > 0 ? 'inline-block' : 'none';
        if(next) next.textContent = cur >= total-1 ? 'âœ… AbschlieÃŸen' : 'Weiter â†’';
    }

    window._trainerNext = function() {
        var trainer = trainerState.activeDrawer;
        if(!trainer) return;
        var steps = (trainer.content_json || {}).steps || [];
        var cur = trainerState.currentStep;
        
        // Save current step input
        var inp = document.getElementById('trainerInput_'+cur);
        if(inp) trainerState.stepResults['step_'+cur+'_input'] = inp.value;
        
        if(cur >= steps.length - 1) {
            _completeTrainer(trainer);
            return;
        }
        trainerState.currentStep++;
        _updateDrawerUI();
    };

    window._trainerPrev = function() {
        if(trainerState.currentStep > 0) {
            trainerState.currentStep--;
            _updateDrawerUI();
        }
    };

    window._trainerSelectOpt = function(stepIdx, optIdx, btn) {
        var trainer = trainerState.activeDrawer;
        var steps = (trainer.content_json || {}).steps || [];
        var opt = steps[stepIdx] && steps[stepIdx].options ? steps[stepIdx].options[optIdx] : '';
        trainerState.stepResults['step_'+stepIdx+'_choice'] = opt;
        // Highlight selected
        var container = document.getElementById('trainerOpts_'+stepIdx);
        if(container) {
            container.querySelectorAll('button').forEach(function(b){ b.style.background='#fff'; b.style.borderColor='#e5e7eb'; b.style.color='#374151'; });
            btn.style.background='#fff7ed'; btn.style.borderColor='#f97316'; btn.style.color='#f97316';
        }
    };

    async function _completeTrainer(trainer) {
        closeTrainerDrawer();
        
        var action = trainer.action_after_json || {};
        var successMetric = trainer.success_metric_json || {};
        
        // Create task if configured
        if(action.create_task && typeof sb !== 'undefined' && sbUser) {
            try {
                var taskData = {
                    standort_id: sbProfile ? sbProfile.standort_id : null,
                    erstellt_von: sbUser.id,
                    titel: action.task_title || 'Trainer-Aktion',
                    beschreibung: 'Aus Training: ' + trainer.title + '\n' + JSON.stringify(trainerState.stepResults),
                    kategorie: action.task_kategorie || 'sonstig',
                    prio: action.task_prio || 'normal',
                    prio_sort: action.task_prio === 'hoch' ? 3 : action.task_prio === 'dringend' ? 4 : 1,
                    quelle: 'trainer',
                    erledigt: false
                };
                await sb.from('todos').insert(taskData);
            } catch(e) { console.warn('Trainer task:', e); }
        }
        
        // Update completion record
        if(typeof sb !== 'undefined' && sbUser) {
            var followupDays = successMetric.check_after_days || 7;
            var followupDate = new Date();
            followupDate.setDate(followupDate.getDate() + followupDays);
            
            await sb.from('trainer_completions')
                .update({ 
                    completed_at: new Date().toISOString(),
                    result_json: trainerState.stepResults,
                    followup_due_at: followupDate.toISOString()
                })
                .eq('user_id', sbUser.id)
                .eq('trainer_id', trainer.id)
                .is('completed_at', null);
            
            // Update assignment status
            await sb.from('trainer_assignments')
                .update({ status: 'completed', updated_at: new Date().toISOString() })
                .eq('standort_id', sbProfile.standort_id)
                .eq('trainer_id', trainer.id)
                .eq('status', 'active');
        }
        
        // Advance onboarding if applicable
        if(action.advance_onboarding && trainerState.onboarding) {
            var nextPhase = action.next_phase || trainerState.onboarding.phase;
            var nextStep = (action.next_step || trainerState.onboarding.step) + 0;
            await sb.from('user_onboarding')
                .update({ phase: nextPhase, step: nextStep, updated_at: new Date().toISOString() })
                .eq('user_id', sbUser.id);
            trainerState.onboarding.phase = nextPhase;
            trainerState.onboarding.step = nextStep;
        }
        
        logPortalEvent('trainer_completed', { trainer_id: trainer.id, title: trainer.title, results: trainerState.stepResults });
        
        // Show success toast
        _showTrainerToast('âœ… Training abgeschlossen!' + (action.create_task ? ' Aufgabe wurde erstellt.' : ''));
    }

    window.closeTrainerDrawer = function() {
        var backdrop = document.getElementById('trainerDrawerBackdrop');
        var drawer = document.getElementById('trainerDrawer');
        if(drawer) drawer.classList.remove('open');
        if(backdrop) backdrop.classList.remove('active');
        setTimeout(function(){
            if(backdrop) backdrop.remove();
            if(drawer) drawer.remove();
        }, 400);
        trainerState.activeDrawer = null;
    };

    // â”€â”€ Snooze â”€â”€
    window._trainerSnooze = async function(assignmentId) {
        if(typeof sb === 'undefined') return;
        var cooldown = new Date();
        cooldown.setHours(cooldown.getHours() + 48);
        await sb.from('trainer_assignments')
            .update({ cooldown_until: cooldown.toISOString() })
            .eq('id', assignmentId);
        // Remove card
        var card = document.getElementById('trainerCard_'+assignmentId);
        if(card) card.style.display = 'none';
        logPortalEvent('trainer_snoozed', { assignment_id: assignmentId });
    };

    // â”€â”€ Start â”€â”€
    window._trainerStart = function(assignmentId, trainerId) {
        openTrainerDrawer(trainerId);
    };

    // â”€â”€ Toast â”€â”€
    function _showTrainerToast(msg) {
        var toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#111827;color:white;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:99999;box-shadow:0 8px 30px rgba(0,0,0,0.2);font-family:Outfit,sans-serif;transition:opacity 0.5s;';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(function(){ toast.style.opacity='0'; }, 3000);
        setTimeout(function(){ toast.remove(); }, 3500);
    }

    // â”€â”€ Show Trainer in Area â”€â”€
    window.showTrainerForArea = async function(areaKey, containerId) {
        var container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';
        
        var assignments = await loadTrainersForArea(areaKey);
        trainerState.assignments = (trainerState.assignments || []).concat(assignments);
        
        if(assignments.length > 0) {
            renderTrainerCard(assignments[0], container);
        }
    };

    // â”€â”€ Init â”€â”€
    window._initTrainerEngine = async function() {
        await loadOnboardingState();
        
        // Init onboarding for new users
        if(!trainerState.onboarding && typeof sb !== 'undefined' && sbUser && sbProfile) {
            await sb.from('user_onboarding').upsert({
                user_id: sbUser.id,
                standort_id: sbProfile.standort_id,
                role_key: sbProfile.is_hq ? 'hq' : 'allgemein',
                phase: 1, step: 1,
                onboarding_done: false
            }, { onConflict: 'user_id' });
            trainerState.onboarding = { phase: 1, step: 1, onboarding_done: false };
        }
    };

})();
</script>


<!-- â•â•â• TAGES-COCKPIT + VERKAUFS-STREAK SYSTEM â•â•â• -->
<script>
(function(){
    var MO = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    var WOCHENTAGE = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    var IMPULSE = [
        'Du hast 2 Angebote, die seit 5+ Tagen offen sind. Ein kurzer Follow-Up-Anruf kÃ¶nnte den Unterschied machen!',
        'Kunden, die am Wochenende Probefahrt hatten, sind jetzt kaufbereit. Heute anrufen!',
        'Werkstatt ist zu 78% ausgelastet â€“ perfekte Gelegenheit fÃ¼r Service-Angebote an Bestandskunden.',
        'Tipp: E-Bike-Leasing-Anfragen steigen im FrÃ¼hjahr um 40%. Sprich aktiv Pendler an!',
        'Dein Standort liegt 12% Ã¼ber dem Netzwerk-Durchschnitt bei ZubehÃ¶r-Attach-Rate. Weiter so! ðŸ’ª',
        '3 Leads sind im "Schwebend"-Status. Schick heute ein kurzes "Noch Fragen?"-Follow-Up.',
        'Diese Woche sind 2 Events im Kalender. Nutze die Chance fÃ¼r spontane Leads!',
        'Top-Performer im Netzwerk machen 30% ihres Umsatzes mit Service. Wie siehts bei dir aus?'
    ];

    // â”€â”€â”€â”€ TAGES-COCKPIT â”€â”€â”€â”€
    function renderDailyFocus() {
        var now = new Date();
        var dateEl = document.getElementById('dailyFocusDate');
        if(dateEl) dateEl.textContent = WOCHENTAGE[now.getDay()] + ', ' + now.getDate() + '. ' + MO[now.getMonth()];

        // BWA Status
        var bwaMo = now.getMonth() === 0 ? {y:now.getFullYear()-1,m:11} : {y:now.getFullYear(),m:now.getMonth()-1};
        var fm = bwaMo.m+1 > 11 ? 0 : bwaMo.m+1;
        var fy = bwaMo.m+1 > 11 ? bwaMo.y+1 : bwaMo.y;
        var deadline = new Date(fy, fm, 15, 23, 59, 59);
        var daysLeft = Math.ceil((deadline - now) / (1000*60*60*24));

        var bwaEl = document.getElementById('dfBwa');
        var bwaSubEl = document.getElementById('dfBwaSub');
        if(bwaEl && bwaSubEl) {
            if(daysLeft > 7) {
                bwaEl.textContent = 'âœ…';
                bwaSubEl.textContent = daysLeft + ' Tage Zeit';
                bwaSubEl.style.color = '#16a34a';
            } else if(daysLeft > 0) {
                bwaEl.textContent = 'âš ï¸';
                bwaSubEl.textContent = 'Noch ' + daysLeft + ' Tage!';
                bwaSubEl.style.color = '#ca8a04';
            } else {
                bwaEl.textContent = 'ðŸš¨';
                bwaSubEl.textContent = Math.abs(daysLeft) + ' Tage Ã¼berfÃ¤llig';
                bwaSubEl.style.color = '#dc2626';
            }
        }

        // Random Impulse
        var impulseEl = document.getElementById('dfImpulseText');
        if(impulseEl) {
            var idx = now.getDate() % IMPULSE.length;
            impulseEl.textContent = IMPULSE[idx];
        }
    }

    // â”€â”€â”€â”€ VERKAUFS-STREAK â”€â”€â”€â”€
    function renderSalesMomentum() {
        // Demo data - in prod, fetch from Supabase
        var streak = 12;
        var bestStreak = 18;
        var goalIst = 86400;
        var goalSoll = 120000;
        var closeRate = 34;
        var closeRatePrev = 30;
        var avgDeal = 4320;
        var nwAvgDeal = 3890;

        // Update streak emoji
        var emojiEl = document.getElementById('streakEmoji');
        if(emojiEl) {
            if(streak >= 14) emojiEl.textContent = 'ðŸ”¥ðŸ”¥';
            else if(streak >= 7) emojiEl.textContent = 'ðŸ”¥';
            else if(streak >= 3) emojiEl.textContent = 'âœ¨';
            else emojiEl.textContent = 'ðŸ’¤';
        }

        // Goal bar
        var pct = Math.min(Math.round(goalIst / goalSoll * 100), 100);
        var goalPctEl = document.getElementById('goalPct');
        var goalBarEl = document.getElementById('goalBar');
        if(goalPctEl) {
            goalPctEl.textContent = pct + '%';
            goalPctEl.style.color = pct >= 90 ? '#16a34a' : pct >= 60 ? '#ca8a04' : '#dc2626';
        }
        if(goalBarEl) {
            goalBarEl.style.width = pct + '%';
            goalBarEl.style.backgroundColor = pct >= 90 ? '#16a34a' : pct >= 60 ? '#EF7D00' : '#dc2626';
        }

        // Close rate change
        var crDiff = closeRate - closeRatePrev;
        var crEl = document.querySelector('#closeRate + p');
        if(crEl && crDiff !== 0) {
            crEl.textContent = (crDiff > 0 ? 'â†‘ +' : 'â†“ ') + crDiff + '% ggÃ¼. Vormonat';
            crEl.style.color = crDiff > 0 ? '#16a34a' : '#dc2626';
        }
    }

    // â”€â”€â”€â”€ INIT â”€â”€â”€â”€
    // Hook into showView
    var _origSV = window.showView;
    if(_origSV) {
        var _hooked = false;
        if(!_hooked) {
            var __origSV = _origSV;
            window.showView = function(v) {
                __origSV(v);
                if(v === 'home' || v === 'startseite') setTimeout(renderDailyFocus, 100);
                if(v === 'verkauf') setTimeout(renderSalesMomentum, 100);
            };
            _hooked = true;
        }
    }

    // Auto-init
    setTimeout(function(){
        renderDailyFocus();
        renderSalesMomentum();
    }, 600);
})();
</script>

</body>
</html>
