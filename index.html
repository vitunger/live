<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>vit:bikes cockpit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            font-family: 'Open Sans', sans-serif;
        }
        
        /* vit:bikes Corporate Colors */
        :root {
            --vit-orange: #EF7D00;
            --vit-gray: #626062;
            --vit-black: #000000;
            --vit-white: #FFFFFF;
            /* Dark Mode Colors */
            --dm-bg: #111114;
            --dm-surface: #1A1A1F;
            --dm-surface-hover: #222228;
            --dm-border: #2A2A30;
            --dm-text: #EAEAEC;
            --dm-sub: #87878F;
            --dm-muted: #55555C;
            /* Semantic theme colors - used by JS components */
            --c-bg: #FFFFFF;
            --c-bg2: #f9fafb;
            --c-bg3: #f3f4f6;
            --c-text: #111827;
            --c-text2: #374151;
            --c-sub: #6b7280;
            --c-muted: #9ca3af;
            --c-border: #e5e7eb;
            --c-border2: #f3f4f6;
            --c-ring: #f3f4f6;
            --c-orange-tint: #fff7ed;
            --c-yellow-tint: #fffbeb;
            --c-blue-tint: #eff6ff;
        }
        
        .bg-vit-orange { background-color: var(--vit-orange); }
        .bg-vit-gray { background-color: var(--vit-gray); }
        .text-vit-orange { color: var(--vit-orange); }
        .text-vit-gray { color: var(--vit-gray); }
        .border-vit-orange { border-color: var(--vit-orange); }
        .hover\:bg-vit-orange:hover { background-color: var(--vit-orange); }
        
        /* Corporate Font Styles */
        .h1-headline {
            font-weight: 700;
            font-size: 26px;
            line-height: 32px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--vit-black);
        }
        
        .h2-headline {
            font-weight: 400;
            font-size: 12px;
            line-height: 18px;
            text-transform: uppercase;
            position: relative;
            padding-bottom: 8px;
            display: inline-block;
        }
        
        .h2-headline::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -3mm;
            width: 15.5mm;
            height: 0.5pt;
            background-color: var(--vit-orange);
        }
        
        /* Gradient Backgrounds */
        .vit-gradient {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }
        
        /* Subtiler vit-Hintergrund fÃ¼r Main Content */
        .vit-background {
            position: relative;
        }
        
        .vit-background::before {
            content: '';
            position: fixed;
            top: 0;
            left: 256px; /* Sidebar width */
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--c-bg2) 0%, var(--c-bg3) 100%);
            z-index: -1;
        }
        @media (max-width: 768px) {
            .vit-background::before { left: 0 !important; }
        }
        
        /* Card Styles */
        .vit-card {
            background: var(--c-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .vit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 125, 0, 0.2);
        }
        
        /* vit-Logo Watermark auf Cards */
        .vit-card-watermark::before {
            content: 'vit';
            position: absolute;
            bottom: -20px;
            right: -20px;
            font-size: 120px;
            font-weight: 900;
            color: rgba(239, 125, 0, 0.03);
            pointer-events: none;
            font-style: italic;
        }
        
        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            transition: width 0.25s cubic-bezier(0.4,0,0.2,1);
            position: relative;
        }
        .sidebar.collapsed { width: 64px !important; min-width: 64px; }
        .sidebar.collapsed .sidebar-label,
        .sidebar.collapsed .sidebar-badge,
        .sidebar.collapsed .dev-badge,
        .sidebar.collapsed hr { display: none !important; }
        .sidebar.collapsed .sidebar-item {
            justify-content: center !important;
            padding: 10px 0 !important;
        }
        .sidebar.collapsed .sidebar-item svg { margin: 0 !important; }
        .sidebar.collapsed .p-4 { padding: 8px !important; }
        .sidebar.collapsed .space-x-3 > :not(svg) { display: none; }
        .sidebar.collapsed .space-x-3 { gap: 0 !important; justify-content: center; }
        .sidebar.collapsed #externMenu .mb-3 { display: none; }
        /* Tooltip on hover when collapsed */
        .sidebar.collapsed .sidebar-item { position: relative; }
        .sidebar.collapsed .sidebar-item:hover::after {
            content: attr(data-tooltip);
            position: absolute; left: 68px; top: 50%; transform: translateY(-50%);
            background: #333; color: #fff; padding: 4px 10px; border-radius: 6px;
            font-size: 12px; white-space: nowrap; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        /* Collapse toggle button */
        .sidebar-collapse-btn {
            position: absolute; bottom: 16px; right: -14px; z-index: 50;
            width: 28px; height: 28px; border-radius: 50%;
            background: #2a2a2a; border: 2px solid #3a3a3a;
            color: #999; display: none; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; padding: 0;
        }
        .sidebar-collapse-btn:hover { background: #EF7D00; color: #fff; border-color: #EF7D00; }
        .sidebar:hover .sidebar-collapse-btn { display: flex; }
        .sidebar.collapsed .sidebar-collapse-btn { display: flex; right: -14px; }
        .sidebar.collapsed .sidebar-collapse-btn svg { transform: rotate(180deg); }
        
        .sidebar-item {
            transition: all 0.2s;
        }
        
        .sidebar-item:hover {
            background-color: rgba(239, 125, 0, 0.1);
            border-left: 3px solid var(--vit-orange);
        }
        
        .sidebar-item.active {
            background-color: rgba(239, 125, 0, 0.15);
            border-left: 3px solid var(--vit-orange);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-new { 
            background-color: rgba(239, 125, 0, 0.15); 
            color: var(--vit-orange);
            border: 1px solid var(--vit-orange);
        }
        .status-inprogress { 
            background-color: var(--vit-orange); 
            color: white; 
        }

        /* Badge-System wird jetzt Ã¼ber modul_status DB gesteuert */
        /* Dev-Status Badge styles */
        .dev-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .dev-badge.live { background-color: #dcfce7; color: #15803d; }
        .dev-badge.beta { background-color: #ede9fe; color: #6d28d9; }
        .dev-badge.demo { background-color: #fef3c7; color: #b45309; }
        .dev-badge.wip { background-color: #dbeafe; color: #1d4ed8; }
        .dev-badge.planned { background-color: var(--c-bg3); color: var(--c-sub); }

        .status-done { 
            background-color: var(--vit-gray); 
            color: white; 
        }
        
        /* Chat Styles */
        .chat-message {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .chat-message.sent {
            background-color: var(--vit-orange);
            color: white;
            margin-left: 20%;
        }
        
        .chat-message.received {
            background-color: #F3F4F6;
            margin-right: 20%;
        }
        
        /* Forum Styles */
        .forum-post {
            border-left: 3px solid var(--vit-orange);
            padding-left: 15px;
        }
        
        /* Corporate Bullets - Orangene Kreise */
        .vit-list {
            list-style: none;
            padding-left: 0;
        }
        
        .vit-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
        }
        
        .vit-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 7px;
            width: 8px;
            height: 8px;
            background-color: var(--vit-orange);
            border-radius: 50%;
        }
        
        /* Hide class for view switching - MUST override Tailwind */
        /* Premium Feature Locks */
        .premium-feature {
            position: relative;
        }
        
        .premium-feature.locked::after {
            content: 'ðŸ”’ Nur fÃ¼r vit:bikes Partner';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--vit-gray);
            border-radius: 8px;
            backdrop-filter: blur(2px);
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #EF7D00 0%, #FF9500 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .locked-menu-item {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .locked-menu-item::after {
            content: 'ðŸ”’';
            margin-left: auto;
            font-size: 12px;
        }

        /* === MOBILE RESPONSIVE === */
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
        }
        #sidebarOverlay.active { display: block; }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed !important;
                top: 0; left: 0; bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px !important;
                flex: none !important;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .sidebar-collapse-btn { display: none !important; }
            .topnav-desktop { display: none !important; }
            .topnav-mobile { display: flex !important; }
            .main-content-area {
                margin-left: 0 !important;
                padding: 12px !important;
                width: 100% !important;
                flex: 1 1 100% !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            /* Fix: Collapsed sidebar class should not affect mobile */
            .sidebar.collapsed { width: 280px !important; transform: translateX(-100%); }
            .sidebar.collapsed.mobile-open { transform: translateX(0); }
            /* Grids responsive: force fewer columns on mobile */
            .grid.grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid.grid-cols-3:not(.no-mobile-override) { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid.grid-cols-6 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid.grid-cols-5 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            /* Tables: horizontal scroll */
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            thead, tbody, tr { display: table; width: 100%; table-layout: auto; }
            /* Cards & flex containers */
            .flex-wrap { gap: 8px !important; }
            /* Dashboard header */
            .h1-headline { font-size: 1.1rem !important; line-height: 1.3 !important; }
            /* Quick-action cards on home */
            #quickActionsGrid { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; gap: 8px !important; }
            #quickActionsGrid > div { padding: 8px !important; }
            #quickActionsGrid > div p { font-size: 9px !important; }
            /* Fix modals on mobile */
            .fixed.inset-0 > div { max-width: 95vw !important; max-height: 90vh !important; overflow-y: auto !important; margin: 5vh auto !important; }
            /* Profile slider */
            #profileSlider { width: 100% !important; }
            /* Feedback button mobile */
            .feedback-bar { font-size: 11px !important; padding: 6px 12px !important; }
            /* vit-card text overflow */
            .vit-card { overflow: hidden; }
            /* Kanban columns stack */
            .grid.md\\:grid-cols-5 { grid-template-columns: 1fr !important; }
            .grid.md\\:grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid.lg\\:grid-cols-2 { grid-template-columns: 1fr !important; }
            .grid.lg\\:grid-cols-3 { grid-template-columns: 1fr !important; }
            /* Tab buttons scroll */
            .entw-tab-btn, .dev-tab-btn { font-size: 12px !important; padding: 6px 10px !important; }
        }
        @media (min-width: 769px) {
            .topnav-mobile { display: none !important; }
            .topnav-desktop { display: flex !important; }
            #sidebarOverlay { display: none !important; }
        }

        /* Tab navigation scroll on mobile */
        nav.-mb-px {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        nav.-mb-px::-webkit-scrollbar { display: none; }

        /* Headline responsive */
        @media (max-width: 768px) {
            .h1-headline { font-size: 1.1rem !important; }
            /* Flex containers that should stack on mobile â€” but NOT the main nav bar */
            .flex.items-center.justify-between:not(nav > div) { flex-wrap: wrap; gap: 8px; }
            nav > .flex { flex-wrap: nowrap !important; gap: 0 !important; }
            /* Version badge */
            #versionBadge { font-size: 9px !important; }
        }
    
        @keyframes tpulse{0%,100%{opacity:0.4;transform:scale(0.8)}50%{opacity:1;transform:scale(1.2)}}
        .t-msg-customer{padding:12px 16px;border-radius:12px;background:var(--c-bg2);border:1px solid var(--c-border);margin-bottom:8px}
        .t-msg-seller{padding:12px 16px;border-radius:12px;background:var(--c-orange-tint,#fff7ed);border:1px solid #fed7aa;margin-left:48px;margin-bottom:8px}
        .t-msg-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
        .t-msg-text{font-size:13px;color:var(--c-text2);line-height:1.5}
        .t-scenario-card{cursor:pointer;transition:all 0.2s}.t-scenario-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}

/* === EINKAUF MODULE CSS (from standalone) === */
.vc{background:var(--c-bg);border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);border:1px solid var(--c-border);transition:box-shadow .2s}.vc:hover{box-shadow:0 6px 20px rgba(0,0,0,.08)}
.pill{display:inline-flex;align-items:center;padding:2px 9px;border-radius:99px;font-size:10px;font-weight:700;letter-spacing:.3px}
.pg{background:#ecfdf5;color:#059669}.py{background:#fefce8;color:#ca8a04}.pr{background:#fef2f2;color:#dc2626}.pb{background:var(--c-blue-tint,#eff6ff);color:#2563eb}.pgr{background:var(--c-bg3);color:var(--c-sub)}.po{background:var(--c-orange-tint,#fff7ed);color:#ea580c}
.prog{height:6px;border-radius:3px;background:var(--c-border);overflow:hidden}.pf{height:100%;border-radius:3px;transition:width .4s}
.si{border:1.5px solid var(--c-border);border-radius:10px;padding:7px 11px 7px 34px;font-size:12.5px;transition:border .15s;width:100%}.si:focus{outline:none;border-color:var(--vit-orange, #EF7D00);box-shadow:0 0 0 3px rgba(239,125,0,.1)}
.fi{animation:fi .25s ease}@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.td{transition:background .15s;border-radius:7px;padding:7px 9px}.td:hover{background:#fef7ed}
.td input[type=checkbox]{accent-color:#EF7D00;width:15px;height:15px}
.dt{width:100%;border-collapse:collapse;font-size:12.5px}.dt th{background:var(--c-bg2);font-weight:600;color:#666;padding:9px 12px;text-align:left;border-bottom:1.5px solid #eee}.dt td{padding:8px 12px;border-bottom:1px solid #f3f3f3}.dt tr:hover td{background:var(--c-bg2)}
.wn{padding:7px 14px;border-radius:9px;font-size:11.5px;font-weight:600;cursor:pointer;transition:all .15s;border:1.5px solid transparent}.wn.on{background:#EF7D00;color:#fff;border-color:#EF7D00}.wn:not(.on){background:var(--c-bg);color:var(--c-sub);border-color:var(--c-border)}.wn:not(.on):hover{border-color:#EF7D00;color:#EF7D00}
.mc{transition:all .2s}.mc:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,.1)}
.rbtn{display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:9px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;border:1.5px solid var(--c-border);background:var(--c-bg);color:var(--c-sub)}.rbtn:hover{border-color:#EF7D00;color:#EF7D00}
.vbtn{background:#EF7D00;color:#fff;border:none;padding:7px 18px;border-radius:9px;font-size:12px;font-weight:600;cursor:pointer}.vbtn:hover{opacity:.9}
.ek-modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:100;display:flex;align-items:center;justify-content:center}
.ek-modal{background:var(--c-bg);border-radius:16px;max-width:720px;width:95%;max-height:85vh;overflow-y:auto;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.widget-info-btn{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--c-bg3);color:var(--c-muted);font-size:10px;font-weight:700;cursor:pointer;border:none;margin-left:6px;transition:all .2s;font-style:italic;font-family:Georgia,serif;line-height:1;vertical-align:middle}
.widget-info-btn:hover{background:#EF7D00;color:#fff}
.widget-info-popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:420px;background:var(--c-bg);border:1px solid var(--c-border);border-radius:12px;padding:16px 18px;box-shadow:0 12px 40px rgba(0,0,0,.18);z-index:9999;font-size:13px;color:var(--c-sub);line-height:1.6}
.widget-info-popup.active{display:block}
.widget-info-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.15);z-index:9998}
.widget-info-overlay.active{display:block}

        /* ========================================
           DARK MODE
           ======================================== */
        body.dark { background-color: var(--dm-bg) !important; color: var(--dm-text) !important; }
        
        /* Backgrounds */
        body.dark .bg-white { background-color: var(--dm-surface) !important; }
        body.dark .vit-card { background: var(--dm-surface) !important; border: 1px solid var(--dm-border) !important; box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important; }
        body.dark .vit-card:hover { box-shadow: 0 4px 12px rgba(239,125,0,0.15) !important; }
        body.dark .vit-card-watermark::before { color: rgba(239,125,0,0.05) !important; }
        
        /* Main content area */
        body.dark .vit-background { background: var(--dm-bg) !important; }
        body.dark #mainApp { background: var(--dm-bg) !important; }
        body.dark .h1-headline { color: var(--dm-text) !important; }
        
        /* Tages-Cockpit stat cards */
        body.dark .bg-emerald-50, body.dark .bg-lime-50, body.dark .bg-cyan-50, body.dark .bg-sky-50, body.dark .bg-violet-50, body.dark .bg-rose-50, body.dark .bg-fuchsia-50, body.dark .bg-stone-50, body.dark .bg-slate-50, body.dark .bg-zinc-50, body.dark .bg-neutral-50 { background-color: rgba(255,255,255,0.05) !important; }
        
        /* Modal/Dialog backgrounds */
        body.dark .modal-content, body.dark [role="dialog"] { background: var(--dm-surface) !important; border-color: var(--dm-border) !important; }
        
        /* Trainer / Coach popup */
        body.dark #trainerPopup, body.dark .trainer-popup { background: var(--dm-surface) !important; border-color: var(--dm-border) !important; color: var(--dm-text) !important; }
        
        /* Login screen */
        body.dark #loginScreen { background: var(--dm-bg) !important; }
        body.dark #loginScreen .vit-card { background: var(--dm-surface) !important; }
        
        /* Tabs */
        body.dark .vk-tab-btn { color: var(--dm-sub) !important; border-color: transparent !important; }
        body.dark .vk-tab-btn.font-semibold.text-vit-orange { color: var(--vit-orange) !important; border-color: var(--vit-orange) !important; }
        body.dark .sm-sub-btn { background: var(--dm-surface-hover) !important; color: var(--dm-sub) !important; }
        body.dark .sm-sub-btn.bg-vit-orange { background: var(--vit-orange) !important; color: white !important; }
        
        /* Stat number colors stay readable */
        body.dark .text-green-500 { color: #34D399 !important; }
        body.dark .text-red-500 { color: #F87171 !important; }
        body.dark .text-blue-500 { color: #60A5FA !important; }
        body.dark .text-purple-500 { color: #A78BFA !important; }
        body.dark .text-yellow-500 { color: #FBBF24 !important; }
        body.dark .text-orange-500 { color: #FB923C !important; }
        body.dark .bg-gray-50 { background-color: var(--dm-bg) !important; }
        body.dark .bg-gray-100 { background-color: var(--dm-surface) !important; }
        body.dark .bg-gray-200 { background-color: var(--dm-surface-hover) !important; }
        body.dark .bg-gray-300 { background-color: var(--dm-border) !important; }
        body.dark .bg-gray-400 { background-color: #3A3A42 !important; }
        body.dark .bg-gray-500 { background-color: #4A4A52 !important; }
        body.dark .bg-slate-50, body.dark .bg-slate-100 { background-color: var(--dm-surface) !important; }

        /* Text */
        body.dark .text-gray-900, body.dark .text-gray-800, body.dark .text-black { color: var(--dm-text) !important; }
        body.dark .text-gray-700 { color: #C8C8CE !important; }
        body.dark .text-gray-600, body.dark .text-gray-500 { color: var(--dm-sub) !important; }
        body.dark .text-gray-400, body.dark .text-gray-300 { color: var(--dm-muted) !important; }

        /* Borders */
        body.dark .border-gray-200, body.dark .border-gray-300, body.dark .border-gray-100, body.dark .border-gray-50, body.dark .border-white { border-color: var(--dm-border) !important; }
        body.dark .border-gray-400 { border-color: #3A3A42 !important; }
        body.dark .divide-gray-200 > * + *, body.dark .divide-gray-100 > * + * { border-color: var(--dm-border) !important; }

        /* Shadows */
        body.dark .shadow-sm, body.dark .shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.5) !important; }
        body.dark .shadow-md { box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important; }
        body.dark .shadow-lg, body.dark .shadow-xl { box-shadow: 0 4px 16px rgba(0,0,0,0.6) !important; }

        /* Inputs & Forms */
        body.dark input, body.dark textarea, body.dark select {
            background-color: var(--dm-surface) !important; color: var(--dm-text) !important; border-color: var(--dm-border) !important;
        }
        body.dark input::placeholder, body.dark textarea::placeholder { color: var(--dm-muted) !important; }
        body.dark input:focus, body.dark textarea:focus, body.dark select:focus {
            border-color: var(--vit-orange) !important; box-shadow: 0 0 0 1px var(--vit-orange) !important;
        }

        /* Tables */
        body.dark table { color: var(--dm-text) !important; }
        body.dark th { color: var(--dm-sub) !important; border-color: var(--dm-border) !important; }
        body.dark td { border-color: var(--dm-border) !important; }

        /* Hover states */
        body.dark .hover\:bg-gray-50:hover, body.dark .hover\:bg-gray-100:hover { background-color: var(--dm-surface-hover) !important; }
        body.dark .hover\:bg-gray-200:hover { background-color: var(--dm-border) !important; }

        /* Status badges */
        body.dark .status-new { background-color: rgba(59,130,246,0.15) !important; color: #60A5FA !important; }
        body.dark .status-inprogress { background-color: rgba(239,125,0,0.15) !important; color: #EF7D00 !important; }

        /* Colored backgrounds -> transparent tinted */
        body.dark .bg-green-50, body.dark .bg-green-100 { background-color: rgba(34,197,94,0.12) !important; }
        body.dark .bg-red-50, body.dark .bg-red-100 { background-color: rgba(248,113,113,0.12) !important; }
        body.dark .bg-blue-50, body.dark .bg-blue-100 { background-color: rgba(59,130,246,0.12) !important; }
        body.dark .bg-yellow-50, body.dark .bg-yellow-100 { background-color: rgba(250,204,21,0.12) !important; }
        body.dark .bg-purple-50, body.dark .bg-purple-100 { background-color: rgba(139,92,246,0.12) !important; }
        body.dark .bg-orange-50, body.dark .bg-orange-100 { background-color: rgba(239,125,0,0.12) !important; }
        body.dark .bg-indigo-50 { background-color: rgba(99,102,241,0.12) !important; }
        body.dark .bg-pink-50 { background-color: rgba(236,72,153,0.12) !important; }
        body.dark .bg-teal-50 { background-color: rgba(20,184,166,0.12) !important; }
        body.dark .bg-amber-50 { background-color: rgba(245,158,11,0.12) !important; }

        /* Colored text -> brighter for dark bg */
        body.dark .text-green-700, body.dark .text-green-600, body.dark .text-green-800 { color: #34D399 !important; }
        body.dark .text-red-700, body.dark .text-red-600, body.dark .text-red-800 { color: #F87171 !important; }
        body.dark .text-blue-700, body.dark .text-blue-600, body.dark .text-blue-800 { color: #60A5FA !important; }
        body.dark .text-yellow-700, body.dark .text-yellow-600, body.dark .text-yellow-800 { color: #FBBF24 !important; }
        body.dark .text-purple-700, body.dark .text-purple-600 { color: #A78BFA !important; }
        body.dark .text-indigo-700, body.dark .text-indigo-600 { color: #818CF8 !important; }
        body.dark .text-orange-600, body.dark .text-orange-700 { color: #EF7D00 !important; }

        /* Scrollbar */
        body.dark ::-webkit-scrollbar { width: 8px; }
        body.dark ::-webkit-scrollbar-track { background: var(--dm-bg); }
        body.dark ::-webkit-scrollbar-thumb { background: var(--dm-border); border-radius: 4px; }

        /* Profile sidebar */
        body.dark #profileSidebar { background-color: var(--dm-surface) !important; border-color: var(--dm-border) !important; }
        body.dark #profileSlider { background: var(--dm-surface) !important; }
        body.dark #profilePanel .text-gray-800, body.dark #profilePanel .text-gray-700 { color: var(--dm-text) !important; }
        body.dark #profilePanel .text-gray-500, body.dark #profilePanel .text-gray-400 { color: var(--dm-sub) !important; }
        body.dark #profilePanel .bg-gray-50, body.dark #profileSlider .bg-gray-50 { background: var(--dm-bg2) !important; }
        body.dark #profileSlider input[type="text"],
        body.dark #profileSlider input[type="tel"],
        body.dark #profileSlider input[type="email"]:not(:disabled) {
            background: var(--dm-bg) !important; color: var(--dm-text) !important; border-color: var(--dm-border) !important;
        }
        body.dark #profileSlider input::placeholder { color: var(--dm-sub) !important; }

        /* Widget info popup */
        body.dark .widget-info-popup { background: var(--dm-surface) !important; border-color: var(--dm-border) !important; color: var(--dm-sub) !important; }

        /* Table & data displays in dark mode */
        body.dark .dt th { background: var(--dm-surface-hover) !important; }
        body.dark .dt td { background: var(--dm-surface) !important; }
        body.dark tr:nth-child(even) td { background: var(--dm-bg) !important; }
        body.dark .prog { background: var(--dm-border) !important; }
        body.dark hr { border-color: var(--dm-border) !important; }
        body.dark pre, body.dark code { background: var(--dm-surface-hover) !important; color: var(--dm-text) !important; }
        body.dark .ring-1 { --tw-ring-color: var(--dm-border) !important; }

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tus-js-client@4/dist/tus.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EF7D00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="vit:bikes">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="vit:bikes Portal">

</head>
<body class="bg-gray-50">

    <!-- LOGIN SCREEN -->
    <!-- Splash loader while checking session -->
    <div id="appSplash" style="display:flex;position:fixed;inset:0;z-index:10000;background:#fff;align-items:center;justify-content:center;flex-direction:column;gap:16px;">
        <div style="font-size:28px;font-weight:800;color:#EF7D00;font-family:system-ui,sans-serif;letter-spacing:-0.5px;">vit:bikes</div>
        <div style="width:120px;height:3px;background:#eee;border-radius:3px;overflow:hidden;"><div style="width:40%;height:100%;background:#EF7D00;border-radius:3px;animation:splashBar 1.2s ease-in-out infinite;"></div></div>
        <style>@keyframes splashBar{0%{margin-left:0;width:40%}50%{margin-left:60%;width:40%}100%{margin-left:0;width:40%}}</style>
    </div>
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center vit-background relative" style="display:none;">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-block mb-6">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAABGCAYAAAAq7+rZAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAA+V0lEQVR42u19d3wc1bX/99w7M1ukVbeMsTGYjkwJGAh5KbIJNXSbFb05weQFCIGQnrDatJc8Elp+gcQPCOaBk2jpGDDwAha9iW4RwBBsZMtWb6stc+89vz9mRl7bkrUGkwDR+XwGCXl25s7sPd97zveUSy9cUHLXfttkj+vLaE0ESSBjyBYvrwulDl442MBNkNQAA4CxlYUTEJSEOe+zk3c476D0ZZWOmVcRyseIDABDH/S6hqErI0K+2hF6dP7VdYe/EG8xlIIO7ndjvOTUg3cyC6vtbEQzEwg0zvU46oA7hpz+G14t3funS3vaDECNCVBjI/hX88pnHL+9fmBa2fAuyhgQQPiIxRihK0uEfPQfzrKD/yd9MDMREQwmZEI+hIhFK0JnvtEdfrkySpIBTWBhkdJzdsjEm79R8itqgOYE5EcFBlccW73/9+r7n9i3dvic2pLhMiJNAH9ghWIGOxLozFj8/Jrwj1rQ4qYAJBIQAHD4PuU7HDhN3zC9JFeiDI0LBgAgAG1LKf7e4/w6ubSnzTRBEsCNM0FE4EOmqmt3n5zZ1TXG/DPAgAGOWAZrh6T7xJropQBxquGjv++E/BsAwu+W9gz8sSXS8E5/eKDUJqEYRhsjBzNaHTRFfe/W06suoCTUHxfA3ooTmgDgtAOryg7fKX3PjIrs1N5ho1xFviHywYwRAmBApsSR8u/d9g1fS/U+zU2QDSnoxpkgSsJ8e3+VnDnJDfdlWZEY3woxBqY0RPLv3fabh11ffTUnIKgBhuOQ1AC9+OSyhr0m5Q4fSGslsPWBc4wXqMMhKVu7Qtdcdl9XS/CME9N5Qj40IDxaD+uax7reXvqGfVJf3uaI5WmkYpJK5/XhO6Svui5eduh5C+E2xbfShG/yrIOvfSZ7WV2tmtI3DFcIWKAP55VoJo7ZoJWDVs8NrTU/4QRE43JwUxxSNED/8YSa/fbbxj01nWEjqLhnsQQ4YyS9tDZ8KbAyi1Z/Ja4Dz5o1JXrg1OwvJSnW7FkgHzkWMEzUgXy3x1pz87OVP+cEBBomXIUJ2UqAMKcZihOwLrh3YGlzW/ibUtrSArQgppzLVGbnxSE7uHecf1DlXg0p6A8LCk1xSMRhrjm6evfdq/WFmazSAKyt8TAENtKS4s1OK7moeeVazAQlkzDxuGdzHDB1+OrqqGvlmRk0vltiGDoWJvl6p/3g6Yv7lnATJKWg2Qe0/9pv8NKdqvVOQzkYQR89IDAAAWJBNrV2R36w6JWVfZgJoo+A35mQf0+RAJBshnlhAexDb8w98/npsW3rttEHZHOshITMKTJTS014eiW+3Dq4y02XL+vMAxDNzR9sEjY1QtCeML88lBftXJPffSgP3hrKZBi6LAzxVpfzxueuq/sax9uJktA+KarvPrOs4XPTc99O5zzydNzrARwWQE/eyd3xdsm8R9/KdNYBoi4Omn0+WD1VPuPInfO3OkJZypAg+idwBwxdESb5amf42fo/Dn4zeLaJaTwhW81CCH7ZfyEUN0Eeuegz5z++0nmiIkqWVkIJguwd1nrPybldrzp05S1EHpmGD0Cejfjdp8WO2nmS+cpghnWxpvu4pj0JZFyHHnkv/EOgxR0xGpaDT997ckldjXu5YMWGixs3MXQkLMXb3aFrfnRPT6v5awEXQeCjdnL/e1rMLcm4zP8UMDDChCWZ3pyFp1Y6lxCBU6mJCTwhHxEgAODG5WDmZv2z/4vNe6MzvKIiBEtp1kSQvUOsPjM5f9z9Z5dcRw3QLyzYYjOfUAfG5MklddXqmqhUrAwVrUiGwcxQox2GkYuFIZd32ksuuKvv7o1N+7MOSl8yoyo/fSjPeQLMWNcZuZ5BvjQEsarXbvvzG9v9LPDTA0C7+eTYZ3eflD9hMGPyBDAzF47FfHClH3tsjmUoEnLsl9ZGf3n+3b1PmRMniMQJ2fqygVInkzAzWyEffnddx21/n3z82Xuap2sj2ZK0IgPB1kDaVQfPoK+nTq14ff+Ffb9/NAFrThKqmBs9moCkJFTTqelL994mv+PAsFFCFAcqhsGltiTbYmvEXaYCx1rCau931EPvhC9lThMa1xOJ/xOvmbX/NkM/lZZBZYRCG3x2M9iV1Tae7Sj5/rXNrUO/r/XCjFwHPuOAbasP2LavqbKCJWeEJMHrx0GA0QKDOYMtJkgZpixEQlgQAAHMWP+ghHVDdvbp9vCvDvmf3p9yEwW5IRMyIR8dIABAQwraU/R1y3etip186A7mvpDIq7wh0oA0bl7N2YGu+sNJtX+fk+z4G8e91XhzN0kkIGYDJvGVSdscNL3vW3lXGwNIUSQYlDiC3uq2O3tzaIYxqpBEI4KOOSRf7Qw/edmD3W/+pNGzCprikAwAxuzZ1mf9+bV2NoJ4s7ckAgsCT4pavc932o+e8r/dd/j5Ejrh50187yhnWvcwPffU2/Jx1iQCxRcEMkYyQLvuOzU7y1VsUCQ3wkwmYlvirX75St8wL1caQhAbgFARoZ6ebOide94seeDyR9e86ScgTVgGE/KRyJhrJSdgURLqobMrLpqz/dBVw1mlDMEyBqYkDLEmHe69/a3aWd+5d9U/muKbN18D8qv5/NJFX5qaObN3WBfFHRhDpixE9M5A+I2z/lJ12DNtbas3v8iuZ9yb4pDxOhAVacGMQeIR0ZaRp0/+Z+TRg6ZmZw9keVzykgBoJl0ZJvliZ+j+WVcfeBzQrDbLwUy4CRPyz7QQRiZrEuqFBbD3X9h39dNfj+1x0Dbp83p9Mz+dhZ4ey1cePaPz3jt32+1zp9z25mChMhZKYLr/4ivlc+qqsmeks0YXk8DDAGzJPKxt0bwycuEzbW2r37oQoV2+CIXlowKZoaRnRjNAH0ZxOAEr1QoeYyWmDTI3Z4LRDgvfhHvP/NJz/mNarigwCKwfxwK1Ddj5W54tvYioWb12GZyZM6ELn3GZdxhKToDBhPyLLITCyU/Jerz0jRcf+cyk4S92D2stJSQbqMpSaT3bHnngoOuGjuME2J+wPIp1YFq+GX5mv9r8gb1Z1oK4GGXRlVGSz7WVpD577VBDYLEUocyCkjCLT6s8av9p+c8NZI0BGTGmxx0Y9UZwqQO8Oxjt/8ofu35LIC7GNGCAkACdv6wueskB77w5vSw/JZ1npiLcBWaoioi0Hny37OdH3ND7k2KfcUIm5J9uIQRzthEwzM38zS/uPO+i/dY8v31ZZvv+HBtLkNWX1u5nt8kc+cBZ0asoOXy+Z1HA3dhVuOes6Bl71eYO7M+ZolwFZnDEBq0ZsIYeX21/mxnU2Dg+iZbw1fukmZXb7b9NJrVLdT6CPIoLkBoGSiy0v5n/NUBsio3xN0FQA3Tz11f+ZKcqd9ve4eJCqYZhykIQb/daK3/7vPMrTkBgwgKYkH+xjDtxm5vBM1shv7O0Z6g8VNKyczXOqggbzmtBAKRyWe1cjc8euGP56jk3ZF/44wLYS1pgGKAUQMNyesUpew7dU2mraN4AxcTsGTCxkJQvrI0mT1vcf99swDqnCGVZ1gRBF8Bcday8+oCpuQP6Bzmb1YysYrO5I+OyCllkWtfYKz577R5x5namPcfnDjgBgfPBFc9X7fGlGblFAoqMQRFJSgQBYYRlyQfeLr3oike6Xpg9G3JG80TkYEL+tVIUCx5EHn72WN/jz7Q5p2ktpS1YgwGXSWpl9EGTs3+4OV5+8HkL4b51IUK4Gk5DCvrbB3b/YPdKt3YwR4YYYjw73DBMzBGytUu+99+P1P6WExBzigCDpjikOAn6qqPLDthnSv6M4ZzRLDhMBGu8QwrIjJF2a0fk20CLiwYIFJMO7CcpfX5H9Zsppa6dVygqSckwdFkE8qV1zlNnN/X8lZsg50xYBxPySQEEAJiT9GoeTr5t4C93rwhdFbWFBcAlEA0rUIXMiS9Nz6e+dVD5frv+Djm6CLmfHlGz7x7V6ptDGW2IWbABoAmG/TA7b0RjMEES2GWJVzoilyxdsSLnFxONq5zxOMCcEJ/fUf92UkTJnC7OU2ADXRYh2doZur/hL733BUlN437OT1L6U0P58XWTMl8ZzBhVDJHIABzJ6Ehb5tH3wt8iQs7POJyoR5iQjz2HsKGhm4T2iK+hS6acUbrTwTvkjuka1soSbA3kyEyJuFXfOJAfPHKX2EIDI3euHDy3wnZDwy5YCvZZOga01/GACSBmkJ8IbUC6MkKyZY3z0Km39t9ZbK7+CFcx/6p5e9eoLw5koSX8PIRxuIqQDXQO2dkn3w2NJDUV8yq8H3XO57Z755dh4fKgF6IshoVUJSFhvdRhX/fDJd3Pb0ly14RMyMfGQhiZzkloZuDE/609o2VNaHl1iCylSQuCGMgYnhbN1xwyI/PDw2fkvje1JF81nAdLIuKC4kJiwGuK5BMGBjAG7AhDawft/GMrSy9h9uoQilhxCcvBx+5WHdutMnuFoLwxhoqoZSQA0BFHyFfXOtddfH/PG8saIYPQ5TgAJCgFfcfZq769a6XeYyAHU2yYMeKQeKfH6bv15dJGTkAsS07wBhPyyQUEEMCpBog+erd/4bM48e0+p7vMEsJoGItAwy64L61V77BWwy5YkG8ZsA8ABdOf/L8RA6ShSxwh3umxrrjk3nXLkfLCh+MOyK9X+PaczLd2rdLTB3PMJMz4IT8DEw0J8VaX1fH/nqJfcAJidhF+fCIBgTjMqfvX7rjfNup7ea0NQKLIl20sIcXrneHEH55e17EMEElMAMKEfIIBAfBIxsu+BGvh60N/v/+d6Ik9eUdFJLHRYMlERGQRyCKAjClIyw+KJHm9deApJ5moTeKtTnvtja9N+2WxTT8C5fzZMZNn7Fqpv59xtSn2mUgwC1jixY6yH97198HuYvsKBNWOZ38m88vty9zyjAsjiumtYGBiYZKt65zlxy/a6Trm4sjSCZmQjz0gAECy2WurdvGD3cue7pTnQljSImgzsup77QoJBGbAMPnAELRM9HXIAwYGWeLVLuf7Nz715uCWKufh2w/+eptYLppVzKJIlr88RPLVDuv5U27pvLFYriLIulzYEDto1jbZeDqrNYjH5WEYgCXBQ65ES4d9EdDi+j0QJ4jECfl0AAIAnLcQLidgzb11cNGylfY1pY5tkfEIMmYGDIGMp6HEDGbCBhYDEwyTrghDvtFlPR6/deDmoolEn+W/6fiyw3avUvHBLIpLegLgCEJXzkHzu9FvE6jovgJe56W4PHAburIqrETeFBnJYOhYWMg3e52mc/7a/7dHE7AmSpcn5FMHCMD6yMNRf01f9Hy7dX9FWFhGQcF4azwzvI7qxivpJR8I2BAMg20BdGds3bqu5CKiopWTEAeAWfa+27tXlDoudLGeuCFdEhby5Q578SX3dT1uimxQGgDVX0554Jy62sxBvTloWSyRaIHWDdmDT7WHvsMMWjbBG0zIpxUQMBJ5YLrkmWknv9QZfrc8JCylYEYaKPsxRmLyrQZAMABNOuZI2doduuHU27teCroSFaGcghqgU6evuGDPGjVzIFN8MVHUAb3fb/Xf917Vpcygxi2IZMRn7Vg+a6r7U9aKyRTT8YAgQDrsCPFqh7jqW6neVcsaIZMTkYUJ+RQDwkjk4ak33xy85XU5d3U61FPqEGlNxrMOuAAYvF+1gYlaJFb1W513v1P6o6KJREBgOfiS+ik1+07O/DjvusYw1kcyNv+w2raEeKvXarzqwVXtxSrnMq+5izl/v3U/2rlKTUm7bEhwcZEMR8i3u0Pv/eClil8Vm3U5IRPyiQYEwIs8cBzyyuf6Xnnk/dDJg65NIQHWLBgswIbAI8AAEIOlkKK1K3LZFc3tXcuWQRRFJDZ5+yscsePAr3cq01VDeTAYAsZzQ5hHv0iwv8LrHc6Kry+ccl2xyskJiNmN0L84Ypu63Se53xzOGkNFvDcGIASzhqTn2qM/amlpH8bMCSJxQv5NAAEAKAX9wgLY8+/tefjx1aFvOZaUNhvNxncXWIANYLTQMUeIN7rtV45cvPf1HIec01w8y584pOqgPWvUOems0ZIhvXwG9gohDMDBUaB6lgBntU2vrCv51gqsyKWKTIkO6hWO3GXgvyaXuqG8YVNUgRZDl4VJvtYhnzh9cffiiQ7JE/JvBwgAsL8feTjxjr6rH2+P/DEWkZZhozhYullAEmMgb9NTbaHvAM0qtX5R3azEm8CMhJg9PfP7bSKKctrXzIJPCgOQ9gABPjBoDR2LCLm8077/jL903VfsTkdBJKPp9ElH7FadP9ZvfDJ+mJEJIQl0DFv62feci4iAiQ7JE/JvCQiAH3logjx08aHnv7DOaa6MSsswFBjQhlW5I+TrXfZt//lAz8NbpJwEc9PxV5964BS9X39WawGWI0URG3EIQRakMeCwBNYOWNmn3g8XnRKNIKJYV+fsOWnwSkcaGFPch4ihoiEpX1xn3Xzhkv4XiyVLJ2RCPpWAgJGW7imTeGpy/PXO8JrqsLSYkS+32Vo56GQeeidaNMsPv4X73nvvXXLglPwvLK1YG7FBfcRYwCAMdNSS8vWO0DUX39P9ZrH1Co8mvKrHO/Zb9d3da9TuQzlTVCRDMzjiQLzTY/fdvbzs+5yAaGyY4A0m5JMh1kd14aCl+9IVKzo/O6XmmJij75wSwfQeZbvNbeEf/eLptSv3aYBMbkGY8c74u4ndK9X0niw0CZaeF0Ign6UkFG4czTAMU+II+W6v8/7CV6xfFtuVKOETiYkHqqbtPzV9aU4pw4CgopALxpJCvtguf/aHp9d1XHcxZBIT1sGE/HtbCAC8yEMiAZF8vOvF/3yict9l7c5Rf3qnbM+zl3RdmUhAFGNGB/UKicMn77DvZH1BOu8VEwkjIFh4NcyMTSMMLCCYmCDpjR7xvVRLb/8yFBfJmA0IIvCX98v9YrsKtzzrwhSbEl0WJvF6l/Vqw62XXuVzEBM5BxPyiRH6Z9wkkYAojPcHjVCL8j18dv6xM0ru+MLU/Am9Ga2FoPW9DoSX/Who/QYuXv0E6YooyVe7nKf2vXb4Cxz3SpbHu19THPKkFPTlR1d+4ax9hx8PU14rZjnei2LP3NIsbHn3iuicM27tXzZee/oJmZB/Kwuh0H1ggJrikIktAIMmn+W/8Zjqg/es1if0Z7RmFpINMGIO+PkHZAjEAmQEYAgWGXQOW/zCmtjFBHCRJD8F9QqH7JC7vDqk4JriXhIzdGlEyNe7nNvOuLV/WbFk6YRMyL8FhzCKKcLYQgWJ+6C1f2328lKpMJAXXlJAkNzkxxy9v/nOABkwky6LSPni+9aic+9a91yxOQCPJiCpAequ05eeuUeNe1DfsLdTtEFwrzFdBQ7boNWDVvrJf9iXMqPYzktbVTgxOnaNBcCJBETjFpz/Yb7+eDy+ydjq6uo4mUxu1XvF4/FRid9UKqWLGdMY5064DP9qCXYpujde+p+HT3evHcgWbONOI74BgjohEh5CGAZHbeaOYWfg6idozyuOz7Q3+lbKOCY/IQH66sPVJT/67FDr1Ji77VDeQAiIkd5oYvSto5mhK6KWfOjd0E8Pvz6dmGiLNiETFsLW5BwAgTrwJbOm1OxaMfhzV7FhCEFgsM8VeMULXl8FAoGN8TGCjSNt+WpP6GdXvtK/+tjjYSWLUM5lCcg5SahHv5r//o7lalrvMCspYMFgg9YNFOQt+39jA1MSJvF2j/WP3zxX+t+cSP9L9ldgZrrn3G3qyjBo5/2/OQDe7i/BglTnaxgl0nHrWdW7b1+iwn15F7Z//gA75r6X+95Y2LJ+f40PueDwMcccM7m2tvZAYwyztzkl27ZNSqm2G2+88aXgvK3xHhoaGr5UUVFR7rousx+XJiLV3t7+yNKlS3PBvY444oiympqaesvyVICIWAhBruv233zzzY9NAMLHSBqbQNQAfe+89OW7xFRVd5Y0EQvmAAB89fRzkxkMkIDRMOVhFq91WW+e9+foHzjeL6nIegU0Qv/0yao9dq1IX5rJac3kpUQT+b0d4GVAkl/JHTSGJQIbluLvndZ3Hn51XRo/hqR/YnlzMMSzj/9M+WW7DT4xOZKrGPbhr8QBplfqNiAxA0iOKKjw6832qszctWtVfrf+HEMAcCygPU2405q6K7D67Y3J4C2V+vp62dzcrCKRyCG1tbW35HI5EBGMMYhGoxgYGLgdwImJREImk0n1YQGRiDgWiy2sqanZLZvNgoggpUQ2m0UsFttm6dKl64IxxWKxHSdNmnSPlBLMDGZGKBTC0NDQmwB235ogNQEIH0Ka4pBogLn6CzWz9q0ePnswp7XgICGICvKOyOMOyIw48pLAGWWJdwasC9rRPpzyNqIptl7BPPm13G+3LXGd7gy0FN42r54hwus5BPazIIm8LtFRyJfanWXHLkrf/q+oV2j0J+665V2lvIsJ2aTZITAR2AZEzEYOaOWNQAQAIURah0hxWMCAQQ6BbGhow1vVlRRCuK7raq21hvedKNd1LSJKb3UfmGjQv5cBQMYYEkIMSrlJE26tlNIBGAAwrusKIhr8d3YZxMdtQHGfgDxoev4324QZORUQhh5pKAx7vRQQkIsCxMLz40OQrb323Sc29f9fsV2JgnqFxfHKI/asVkf2ZVgLkNwARvyGLoV/YwaHCOhI2/qJtuglRPwvrVfIuMpSGlIzSDNIG5BhkMtEATu7CRkKgmaQMt5njAF9FKaNb7rL4GBmCUASkfiI5vTIPQp+3/DZjRl1TB9Hnfi3BYSASLzpKzWn1FXp2b15owWE9Kokhd9lyQMCYq8JgjAAG+KQIGpLO7lH28sv3YKuRCP7K+wzKXt5CSnWmoj91vDMXqFSITAEnaBg2JSEIN/qsa+76J7im7t8ZF8kEQOs2EDBqxtRbKAIUEiN7W8EVhAjeN5P/Jw2zEFp2wa/T8gnDBAITTDzd9st9pmq/K8taGazcbZwUEJNXjUje24eMetSW4pXupzf//ChthVIFef7BvUK95/6/vm7las9B3JGC0AIv7uTpyDs36twdSGOWCTe6bF6/vaqSHwc6hWUYeFYIhoNC6vcEXaZI5xwWFhay5qxLAT2szzJ+PtkBPtlfLIlatu2sDyRtm0LACWu69KEun+COISmOAQR9B3Hd+wzI6a2G8yDBRkxemSUAJZeCwQYU+4Y8Vaf3Xb9c/yzLem8NLsR+heP107eo3LgJ/m8MsxCCgS8gcdYeFmQ3t+CHd4F2FiWJV9bF25MPjPQ03jJ2PUKiTFyAxobPT9/SwAzkdj0ZTQCSCZB5ZPEuhfXhn/Q1itDWSUgCByWoB7X6kVdXbBnFhoTEI2NQGPjZUDPr9aTMryeRiuxQf64RSLh3yc5Ujq2VV2JeDwue3p6ZDweH/Xafq7CuP2wiLzwkxDiLKVUzHW9IIkfRdCVlZW9AFBbW7tVniEej8uOjo5RQaa2tpZTqZQpgr+iRCJBra2t44JVETkbI9caa1ybk9mzZ5tkMmk+NoCwvM57ea90hXr2qdaY5OQ4qwmbqyHwnUDWcOTyLvn9u1f296G1OJa/sckjEh88afjKHUpMZVdGaClG6ImR3g1MAZXpf7sMHQuTfL1DvnbCXw6/lhMpsbl6hbEslWRyfYSgWP1JJjc9N+n/XNLSPrykBb8aYxQjMIokOJn0/nbKRaFRQaw3rXN/SG64rU7yo/naXT8JaPyU8qYmGY/HTaD4Y8nChQtfGE+xtgaQEdEHdg8TiYSYOXMmNTQ0aB/sPjQ4pVKpD3Wt5ubmj5eFkEzCeLn/a1tnVlUljtteJ12jFW9mjIahK8JSvtRtPTXvnoHFAQdRhDUiRQP0dUdVHbjPpPQpA1nWAkJ6JKUZiSqsz4pcnwRlETCUs7G8p+QCQkqnWiHH8lHPqkd4OxHbflJF2Qib7ljE0hmm1b1S0f2da4vlOY7YuSp29N5OpZSWyiuP2HAs4urIMFxVOnza4lX9lx8zefuaKDgLIOwfHXlLXXTn6tUAOFFfXjF1WmmpI4nfbnedvOqNsab14Vv2mt/uUGHtcPUJU5XlMAkjjHSG6bm3geuf62nbWu6hz+5PbmhoOMC2bem67gbfmxCCpZRERL233HLLqoaGhnzh5N+MctRFo9EyrTUXEJq6pKTk5YULF37o3IpEIiGIyMybN+8wAKVe4MQTKSWUUqa8vNx0d3c/ft999/Vio/BlPB6XyWRSA8DRRx8dra6unm6MKXVdNyA6NxHbtuE/w2sbP0MikRD+9eT8+fP3UEptOzAwUFr0F0HEjuNQOp1+f8mSJc9/rMKOQV9GSvX89G8N5bvM3han9wwrRUTWaHyYIxhdOYuf6rAu2YJ6BcQBNAD4/JT8r6tDGn3ZoLbZT3ICef51gAN+abUxpMuiJJ9b6/z19Kaux8YKM3pZEeDhzmnR4+r7HpsR6yzLqpG9bWFL5sFJltvdX/Gl//dk3yubi/cHpd+XfM699sBp6fhQzuSJR96HDoWE/VwXTgOOuPfw7R9/YUo4H815lV4ckRDdSvzjxbO232/RopXZY/bSF+1a1v39gaxRc6oRKpHaTrsE4Q0XWhMqQ4ou3K/zIQI0KGgFB7ln1H7k+udw1NYIrRKRzOfzEEIcOWXKlCM3yxAaoy688ML3lFJLVq1a9ZtUKrV6NFAI8hDKysoWV1VV7RPkPAgh4LpuTgixPYB1y5YtEx+UZEwkElYymVRnn332BbW1tb9TSgXP430ZWiMajaKnp+eFTCZziK+svLHynnnmmXvHYrGLpJSHMvNUIYQY531BKeXm8/ntAbQHzxqAy/z5808rLS39ARHNlFKipqamyJ2HvTGXlJSgra3tQQBHfPxCLCkYZogvN1Wc+0S7fKkiIizNrDdWOQPWsZCQr3eKWy9+uOdZsyWdl1LQfzmh6sydY3r2QI60IJKeY8DeTPH7Pwb7SXh9ID2ffNWgM3z/6pLvb665CwFsErBSrW090FhSXaLCJVY+XObkw+WhfDgs3NBOFarsiBnuPJ8HEGMEAUg0QJ/6hfLKXapyR5aKvBOzVWlZKB8udfLhydF8yWDWpJ99u2fpETuvKCuROloRcsMxOx+J2floeSgfLpNuZAf/etWOFrFQPlxq5aPVobxtiSC5i0doBAGD8lDeLgt54y2189GYo8I1EcWjWVqJeliFR1N8/CYyo8c6Rj+klJbjODuXl5d/a+edd37xzDPPPDKVSumxahZ8U579nwYAW5aVs237Q5nmvvKps846a1ZFRcVvXddVWmultdZKKa2UykspeXBw8K2BgYHDUqlUf8Hzkf95s2DBgu9UVVU9X1paOt+yrO2k9GirzRzGfw85y7J4Yzfh3HPPvbimpuYWx3FmAoBSyvhjKkqYOaeUUkKI9MctyjCiTI2NgKCV2euWh498u99aWe6Q0GY9qhsWXCqZ3hmQ/betdL5bLMvPfueleN2k0s9U5f5LaMNGeztTezaA8JvBFsTiQJ6aMJmIlKJt0Plp8sF1740XyUi1+pzIGvv6riGLwcR5JTivBbtGsusyT4uaEwHYaITGKOzpsoS3pf3J092jp5SaqoEcKWWI81qw1sIlYWH1oP3nZDOGapxseVaRyGliVwujjNB5LVgZMQKSrpJGuzDKCJVVwmj2cjyCPA9vyz0gp4TJucLklDDKCKVdmKza1HdvSEEnm6EKjy0JvbInIyFCFIQJ/WQhYmZ2XdcMDw+7lmXVVlVVLTnzzDMPS6VSOpFIiM24JMF+gcHvH4ozqKur40MOOaS8tLT0r5ZlOUop4bvckplJCGFprQf6+/vnLl68uDcAAADU1NQkfOW9rqqq6r8B2JlMxtfHETHMrDc+ABT+HhCAMpVK6a997WszS0pKrnBdV+fzee0DYvBOZDFHQU4Ifaw4hNH5hI510yKVp5y7J56aGnXNkAu2CEQw2rIs67Ue++cLW7raTymFlUTx9QpL52V/skvM3bY3S0oIWJ7yk99siUayEr26CYYxZMocI1p7Qqt++GjF1ZzoF+M1PmlIQTODiHqf+ez08Mu7V4h9+3JshLcJtBzKgbcppT2uP7Z8T6L+l0brnTDbB5XpFeYUGxqaQQIeqyYIVvewUC+ti9wApKlfCS28ZAIaqfxkJmYQ3vNniNCWdCAclx1bADlFUOytClyASFHL33OCCNqwkA7gSGMXjq0esA4/ovKwGEyJ6wdhbKF12kh+sjP64JKW9uGhoaHNKqKUkizLkqOFQ7XWMMbogskqXNfVtm2L8vLyppNOOmmvxsbGNgBia1dMbhoRapTJZFItWLDg+tLS0p0ymYwSQgS6w0IIQ0TWwMDAGTfffPPywLXwV3LR0NCgzz333Mbq6uqvZzIZl5kt3w1mAMayLCmlHNPMJyLk8/lyITzHdrfddqPm5mZYlnVpKBRCJpPhQrfacRwZuDPjiTHGEkLAGO/7/VgCQqBQj9bDmtPc+/T2FTWnnLIz/zkqlclpzleFRej1HvnGvLunXMOJXrFF9QqPVe9WV5m7aCgHw2AJAwQeHI1sG0EjVBCTgCDFLltieXfo0uaVK7PYDJG4UUxQAlDtafvm3SvNvhLKABB+joOujRprn1oVB/BSvG5DC8HvG6F/dujkGdVO38HpPLEAhL9O6zKHxPIe+6kLl3S9SAB0Pm88E8jfFQvBhrtAT8Qzl98bDKdDhLWDWVaGyS4PqUkx2wgPFDxIcFlgZb/sBHvvlAm6LEvyvX5nAMiPjK99ypSKI2f03Tuz2hXDrgeitmB0DNto6za7AXhrxx0z1NIyumXgFxL1pNPplUREzCMpUSSlJCnlzpFIpCSXy3mJ4kQB96Ci0Wh5RUXFVUQ0b6wS5kJw4Q+RbRUo9znnnHN+RUXFiZlMRhGRVXBNHQqFrO7u7ktvuOGGexcsWGAnk0m30Kz/2te+dnBZWVkik8koHwyIvdWCHMeRmUymi5nfANDnX5c3IlhhjMkxc9aPpKhZs2bZUsrZfnhVBJ+zLIt6e3t/FQqFbjfGkG3bm52nruvCsiwYY/o+1oAAAHOaobxS4q6/VIerZhw2Db8sC+vQyrSTe3KddQGhNZ8qVjlbvTDj06flfz21RId6MkIFLdWNCcqaeST/IHAXGKzLo5Z8bl3osZPv7EltEanmA9Wdy63bd4q5/1UbQcjVFJCLQrmMcseciFkLEmhcqApje42ASALmwCnpk7eN6lB/BkoQLL8fFJSW9HZ/6AbAC2Bk/OF7KdbBBrsAGcLvlu6rgBX48g1TrgCs302Bze3IiFcXvNsyOWx2HcyzYSKyBVNnxuaL/q/20IfeLlsB5AQQ8t9tvwb6EeR4hGxbl1m6x2hVyX67KgZIGDKO3HASGmOgtUbAyDOztm3byufzSxYuXHjWaK/upJNO2q6iouIHkUjkP5VSQQ0EAFjpdFo7jnPCqaeeOmvx4sUtPp9gNr6XDyIwxiCfz49KqBWChtYahStrIW9QWlp6RTab1VprGazkxhgVjUat7u7uG2644Ybf+uARRAGorq6O4/G4Y1nW/zPGsFKKAvATQjAz6/7+/u93dHQsuuuuu7qLjXIkk0mz/fbbb8fM27quC2YmZtaO48h0Ov3I9ddf/4MPqnMfa0AAgDlJKM+c7vmv3325ctletbTLfSutZy9/qvtNBoi2gEi85cjYkbuXm+P6c0ZvELngwgwhjz/wvnSGIwlr05Z5fg19i7Bl+ysQwB6A9L5/9l6xpTvG3ON6XGh4QCSG8mQmRXmXxdNv/yIRHtnAbWiERjIhtg3/+jSjAcMkBPz9KW3IlQNy3Y1Plt7L3ENBghMHz8IYCSNuuDq25gHk1/rWjyPCrtd8ijZg93aYpIfw9qtporFTmcsBKENSayGVB3IQYFJqU7s3ULRA2ZgZSikYYwQz08KFC60FCxaojczk9wF8Y/78+YOxWOy7uVxuBBSYmSORCIXD4a8CaKmrqxu5Z3AfpdQIIIxmIeTzeSilRsCAmYOVOFA8am1txVFHHVXpOE4TACeXyxnyBMYYHQ6HrZ6ensdvvPHGrzc1NcmGhgZdoLgymUyq+fPnx0Oh0B7Dw8NaCCGDlZyIRG9v7/xbb711UaDo4yUopVIpHZwTCoVqmNlxXZcDrsVxHGitn1ywYIE9ZcoU2draOm6Yta6ujltbWylIfPrYA8KIP56AoGTv0wCeLjCpi6tXqAMDdc7uVe9fExEGA4po9BbKfhEVBWnLRpeGST62Ri666G/9L32gkJsPIG91yz/VVVvHE9T6dgoGpiKkxYzy/KkAHonHvfObvD0o9O0Nv993comZOZQ3LCCEl6YNHZGW9f6QTN23alVvqgEOAluePTdhlDSGDf7HmCAjakPlJb+SU+W1BYBOZIjUhtbXhpqloUixEhrs4yeBYaS7KcGrlNpgRS5Yxbm+vp7PO+883ngl9PmBH82fP/+IUCi0t+u6hogEM4tsNgtmPrS+vt5KJpOqsbGRAgshuFchIEgpx7UQCkGrvb1dplIp94wzzlgYDod3DFwF/x7GcRw5NDT0j/fff/9EZtb+/QufwfjXPkcpxcYYNsaAmY3jOGJwcPDZW2+9ddHFF18caWtr0wBMXV3d2PzXsmWjjp9Hckg4ALl9brrpJhcYv59FPB6Xra2tVBjC/UQAAuC19WqKQ07qAC2bDVNsnf6j9ZCUhLpz7roL965WO/flWIvx9lfwVlkTtQW90y+7/rKi5rucGPhA9QqUgiYCfvxK+UP7Tsq07VxB04ZcNoJYGIYcdg2qQu4x8R13LBcN7/YDoIBP2LZk+JwaR6M3A01kLMOATZBr0mRaVlv/AwDLOwqa17Ln/oz8Jeg9GV8PTB4JFsyo9dvfiWALLAOIvGcs1G2yy0WBghtDYGtSJGzgKJ+7EEBWSwyRbW08cQtdho0BYnRiOWl8UFDZbPY3tm3fbLzlWwAQvgswo7y8fCcAb6ZSKeHdSo/qMmQymU18540BocBCoIULF7qnnHLKN0pKSk4cGhoaAQNmZiklcrnc0ODg4HEPP/xwR0NDwwZ5EYFZf+yxx25rjPlcNpuloOLSjyYIrfViALjyyiszWzKfgkzLdDrdFgqFMlLKsM+/WJlMhqWUR5922mnfaGtruxmAWr169Qbfn+M4nM/nacWKFblgzMF4P1GAEFgKAIDmIgkhQMxeBv2NAydtU1eRuSyvjPFyhooLNllSype7ShpvefXdjv/d7YPvr2Aug0XJldm16dI/11Xzd5A3hr1xUNZlPbWUa0/cu+vw1Lto+uMCWCIJ99C9J5dUO/3zMi6B2RszM+nSMMu3BuRj332k71VOQDQWAKPPHKx3ARgYpfK3YLknMIuRHbmZvX1zx3GDPIXSOrtqSP7W1XY0p8ECgCRQT87WEcvtBIDKdyM8FiBs/P9jgQIA6uvre1hKmZZSlhhj2I86aCmljEaj0wG8uXz5cioEmo0BYayknMIVVggBpZQEwCeccMIBoVDo6mw2q40x0rc02E+dFv39/afecccdr9XX11upVEpttJoLAMa27T2klNHAsvHvI3K5HFzXPWbevHnTPM5QmM0uT0Tkum5+3bp1v04mk4M+WbnmtNNOW2bb9pG5XC4gOomIKBQK/X677bb7iTHGnTp1KkYD9YMOOqgLwMuu696UTCYf979a/kQBwhaHi+LefHj8FP3TnWO6rCdDPjE3HhRAl4UgWrutV+L3dP7B5yA+cGirwQ8fPtvh3LRbtb4kZhmpzUi7eI4I5l3K1UkAmhZMAZ0H4Pzd0odtW8JTci40+f0ZJBg5I7AmHf49MIxly7BB1h2x1316ZLMavyv15sqfiQkjGQZjbZ29aSIRWtrbhw+9FZdu7sQ3S0t5NA4hYM6DAqTNYSkAuv/++ztPPvnk94UQuyulAkAAEcF13cqNCczROITRQnoBIBRaCFrrXH19fWk4HF7MzJavzMH9jJRS9vX1/ejOO++8tzC8OEaEYwffPTIFOT9Ca41IJHKIEOKQYuaPECKwcK4FMBgUL6XT6Z8Q0eFEREqpEdBxXddYlrVN0A1qtDAmEU0XQuwnpZx/4okn3njbbbctSCQSn15AaIpDihT0lV+u/dwusexXB3MckHnjihSMQeXQY2us7wLQRXdeGpMMCjiQntav7FDavG2le3BPjrUASwZkOg8qC4sjvnHApG3Q2LkOSWDbGJ8RERoZw97uMswm4kCuGrTarli7172MZqJm6EQBSWCYvZzDEVbR/8+GLsMGyLdBEwTmLXrMRxOwZm/s63pEsC680Ae1EDbUXT1cuPL78X8MDg5W+z7/mBYCMwdVj5uQikHWcEGUIVNVVfVHx3F2zmazhWnz2rZtOTg4+Pidd975y3g87hREFMYadM1Yz6mUKrZPAwshSCmVdl3XAEBzc7P2rYSWY4455oKKiopr/Wuq4HmNMWoMkBIF4GSIiGKx2Py5c+emk8nkNz+13WHidV6tzv61+Wuqwq7IaxSV3W2YdVmI5Mtd4p6LHu15iLfWZiszPcVtz4gbc5CedeBNWMpr6GmlHD1ihjqOCPhV/dRpkxxz2JALgEh4bB+ZkCXRmZG3Njc3Z5EYDaQosDELjs3aop7bUHg+gNwWRIBoo8PvNs0br8TGmE2OLcgPkMwc2eg6pLVGaWlpGwBMmTIlKGYa9V7pdHrUHIXCc/zrEzP/zQ/nFf67zOfzOhQK7X/UUUedlkql8vX19ZvloowxarSxFD5/sYfWmjaOOMTjcXnvvfde19PTc7bWutO2bcuyLMv/6Yx2CCEs/96CmS1jjEin08pxnAuPPfbYL30qAeHReliUhLn9xJqGWdX5/QdyRgsxfpo2MzhkEa0asjJLVzuXMIMa67ZSD4AGGAJw11tySVu/7A5LIdkIJhYAC1hgTIuq0wHwZ6elT5hWwiWuIk0QxEbCJiHXDlrq0faSRX6ewiarC/mNXchvK+cdYyNCcA4KfxpC6OPzVQoAfPDBB9cQ0XbGGNB621/4Sty9NW9IRGV33XXXjcPDw78LhUIWM6sCBRfMHCktLb3xyCOP/Hxzc7Maq6YCAKSUa4IU7E3i/ZYlHMexbNu2HMfZ3GHbtm0JIcr8Zi8bgEIikRD33Xffop6enj0zmczZxphLcrnct13X/bbrut/O5/OX5vP5S4eHh38wNDS00HXd1/3rcMEqQkIItizrkk+dy8AAYRn06ftMLtmjdPg3DONzLcWZplFbWE+00+W/earznctTkMmt1FK9ICeh/6w9YrftVGbOy7isAbbAJNI55pqwOejkfau3nRzKHU/GeAlGnluvSi2SKwathy/7v7VvcByjdpMeqUsoiDKwxmY4BOF5CUGreT/SYPjjsV9HfX29aG5uNuXl5V9yHKfUL5GWBURbJpvN/qMwzPeh5w8z+6z7t+bNm7dnJBKZ49cJSCIirbWxLMuJxWJ3fvnLXz4olUq9u3H1ZdCExRjztlKKsWHNkLYsS+ZyuZuEEA/7/7bZOeZzAdq27Z6Nw7/JZNL49+8AsKgYa2vevHnXhkKhBQUJX0JrTUT0hU8fh+B3Xrp3rtu4S4Wa2juM8cOM8KJvpQ7kG71y5WXP7PprTrSIrb1Ra5DU9GZfyQ27lQ2dZyMrjBEggJSGqXZc6+QdnGvLbDUrm2cE3aYFmHLaor/3hP4EgJZ1jKGw7DWgFUHbeL9OYUwOwRgI5pHzhd9DsixkuQxQYxGW2OzZ43MI42GlX/OwUep2goLYuxDiOxu5F0ZKKZRSbzz44INrAVBjYyMnk1uljQsnk0nDzDR79uxTa2pqXnAcZ2pA2hGR0Fpr27YnVVVV3VVfX/8fTU1NaQoy2byVO8iabNVar7Usa4rWOiD9WEoJY8yrt99+++KtM69SGgCN58LU1taKVCqVHxgY+ElFRcXpQoiIH7Ikn1St/lQBQpD/n/jCNnV7VA5dnMkaU2xnX0FgDSle7ra+39LeMlx0vcKWeA0jBU+7vfTyWS2v7lEh9h7IGSO8MYqca/D5ydnjBBnkzIiOmxIb8u1+ueaK5637iMBzmkdfUUzgF/sByKBx6mihQwYhzxYxj2QRkathJoW02KViYDsC3n3rQjizX/XuNVrux5xmqGJDwJuJWPDRRx+tW1paeKOQIwMwxx9/fCIcDh9QYB2MEG1a63sA8KxZs2xg6+6UNXv2bNnc3Lz2iCOOONG27WYppTTGBDVgMp/Pq1AotFd1dXWKiL4Sj8dFQds09lft4blz5y61LOucIIfCz0GAEGIegCvPOuus8HvvvYfa2lpThOK7GwHtBiDa3Nw8njVr6uvrrZ6enqGysrIhKWXUD+Oud2U+TYDQ6Of/z54yPG9GqabuLIwErPGWKmbWFWGSLZ1i2Zn39f6l2M5LH3CQEmhWa4bLb6qrsK4gVkFOQtCPwDD7u1R5CQLGklJ0ZK0bW9rbhzkBi8bYicojoPzcgoIgwsbWgTYgIuaMa7IEwDD5dqvgMsvwrFp9eWXljofu+rt3+9fPtg2vccTOO4e+ukf3j6vDbmlOgwFB5ZbO9mlH/emV0DWpFWs7x6t2ZGZZV1fnLFmyxKqrqxt5prKyMlleXj69tLT0AsdxLtioloGJSOTz+Uwmk1kEAEcfffRW/66am5t1fX29tXTp0meOPvro88vLy//HGOMCsH2uwcrlcqqkpOSIuXPn/r9UKnV+fX291dzcvMF3k8lkrrVt+5yCgibhuq4JhUKfP/bYY3+0aNGiX3xIQN2i85ubm82xxx67l2VZVcaYIKTKvjvU8+lyGfx4f9ewXGtYC0Faj1cKzwBsSVibsUzzutC3CYP4KLdXCBKJXlxr/2X3MvWzaodK8pqYaGSnSrE+C5hgCSPXDFn5x9c6Y5KJBe6h55IW5iGANnUZ/CpMS3KrIPoMgQy86KbszxHvXaUPeOKY7he73apFXWnRJmwh3xqwnv/uw2teDuot+rLZkr1q9I93q9RwFUCkYQlGx7CLeyrELQA6d8xkqGX0gVp+DsJxdXV1bwUdgAqIPWLmbUOhkOXn6ssCEFGhUMgeGhpa+OCDD74XdA0KUpe3MiioWbNm2UuWLLn++OOP3zcWi32jMBQZgEI0Gv3GMcccs+ree+/99axZs+yWlhY3iAKkUqkXjj/++P+NxWJnBJ8lIqGUMiUlJT+fO3fu3kqp24jo7eHh4U2AXgjBfkTFaK3fKgScQw45pHzSpEn24OD4e8sopchxHNsYc6DjOFcKISzfDQqSvIRS6plPFSBQCoYTENvdUHLLpBif/aXJ5j86M9CSxk7XM4AudUg+uda68XuPdL34Ue++lASMd4+u9sO2q3hgeqk5MZ8xGvAn2YZgpWO2lK398pFkc+eKscjELZVl/s/3eq2n96nk08DuSAKnIFA6b8yMsvyOu0hKZhUhFhV4cm3kxwBe3rHSMyYsIRiGO4cyXJnxaxlsYhrMGWOzGNd8933WEiFEyajfizHYyE0AMyvbtu1sNvuPnp6exsKU249KWlpalK/Y35w7d25dJBKZvdG4pOu6KhaL/eorX/nKP+6///6mwFJIpVImkUiIJ5544mLLsr7oOM4OrusGgCK01iYSiTQwc4NSKuidOFrkA1rrjJRyRwBrAxIzGo3+GcDnI5GI5s2kpBYkZ0nLskp8gChspsLMTLlc7g+ftrAjNyaB1avbMle9HD329V5rVWWIpdmkBduI6WxitsGKftl7x8vOD/9Z+yss+73H6bf243/TiiDGaCUswRjWhPcGrGuxmWDBlsqcpMdl3PRq2eK3B8R7FWFh6YJiGCKIdJ5Nf9YopXRW510VotzwpjONLb+E3AJgEcFiwNJm9E2yNz6YmZVSZrTDJ7uEf55hZte2bcsY05PP5+c2Nzf3bcZsDlKMCw9sbkwF529yjl8/YAYHB0/K5XJrpFcpFcwpMsYIY4yOxWI3HX744Z8rCEdya2sr/e1vf+seGBg40XXdQdu2LWZ2/c5Q5Lqu9l0iFkJglIOFEJBSjgZ8NVLKMiKqlFKWjXUIIYKfJcH7DVKxAeTD4bCVyWTuWrJkyb2fujyEJGD+eiLkXX9f0337ivBxbRlnqDIEaRjKcBBlIzYGJiwNhAzJF3vCl97wj451aAUl/wm7/MxphiYC//zNmgffH6KVUZtJAC4BmgBNBE2AW2KB3k/Ld65YssNSZtDmEqSkIJZgRQQtvOsYArQY/Xk41QBx36pVvUvejc5fOWTna8NsS2+3FkMM4+9yTcwQfrfSTZTc2zLHu5cIxj7K/YIc+yB0VyhiDCk8x7ZtEQ6HbaXUu9ls9rC777775YIWZZvyw+vvNfL7GCvniBSMbROd8EN74uGHH+5Ip9MNWmsjhJDB6iuEEMYYKaWMlJWV3X344YfvEOQIBK7DQw891DIwMDBbKfX3SCRiW5YlEPTnWx+WHLO34hhrhjbeltquKVIKnhdSSgqHw87Q0FDL2rVrv5pIJMSnMjGpIQXdFIdMPtX58pKV9nFrMs7qirCwIhbIEoyINFQWJjHMDh54z/npqfd03dj0URKJoyikuQzWihUrcqsG6LaQbQkQ2ZYkaUmSliBJRLZjW2J12v5TC1pc3+8fmz1wbFeziEiSUkqyhCTLkiSzRpaOZlo0pKATCYjvPbbu0UVvhf7jtb7I/6WN41pCCmkJYUkhLCkkBDmShGzvp8mFn+8HkDVWqSW9BkdCCEtKIaUQlrUpcaOMMVlmHjbGZIs9mDlrjBlwXfeV4eHhH61Zs2b/u+66q2WcVuzBZ4eZOWOMyQLIFDYoDXxzZs4X3GvY/5kbK7RXX19vPfDAA08ODw+fT0TDAEaeB0DOdd20ZVmVJSUlqcMOO6yqsbGRAVAACg8++OCLbW1tB6bT6aRSagUzmwD7hBBjHUIIQczsjLoOeBewRZFSCAjGmLaBgYHfrFixov6ZZ57pSSaTn95ahgAUGlLdj7w+a8p/nLmL+71JkexheU07OpLX9eXFy8+0yWsuau5eyn648p9symgAeGJV+Ld92m0VxnBhQpAgsGFBb3ZH7wJ6MNb4kr6Z2z9k+p5bbZ21ImTsPHn5SI4ADenwINBkRrKONlj5PM6Fkl0tP3sCh1531NR9plp9M4e1CAGAYRAxTMQR4qXu0MsAcO8UbxxVM2YMPtex/Ow3+0w0b8ASXrf6tJa6x8g1AJDyG3Rks9kHAewNgDdOwR0T4KRkx3HQ09Pj3n///auCsRfsQ7Dxah8kA53EzCEArJSiUCgEfxXtKQzNua77diaT2cdxnPW9ACwL2WxWYYyt4Jubm5V//z/MnTv3oVAoJHO59fjh9zc04XA4bIzR/pgoABT/s4MAGmfNmvXfU6dOrQuHw7GAU9ksP0akg2cI8hyIaIExplJrzVLKLSJVM5lMfmBgYHmB60UA+P8DLVWJAvl5vmIAAAAASUVORK5CYII=" width="260" height="70" alt="vit:bikes" style="display:block;">
                </div>
                <h1 class="text-2xl font-bold text-gray-800">cockpit</h1>
                <p class="text-sm text-gray-500 mt-1">Melde dich mit deinen Zugangsdaten an</p>
            </div>
            <div class="vit-card p-8">
                <form onsubmit="handleLogin(event); return false;" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">E-Mail</label>
                        <input type="email" id="loginEmail"  class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="name@standort.de" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Passwort</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    <div id="loginError" style="display:none" class="bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg p-3 mb-2"></div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center text-sm text-gray-600"><input type="checkbox" checked class="mr-2 rounded"> Angemeldet bleiben</label>
                        <a href="#" onclick="showPasswordReset()" class="text-sm text-vit-orange hover:underline">Passwort vergessen?</a>
                    </div>
                    <button type="submit" class="w-full py-3 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">Anmelden</button>
                </form>
                <!-- Registration Link -->
                <div class="mt-5 pt-4 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-500 mb-3">Noch kein Konto?</p>
                    <button onclick="showRegistration()" class="w-full py-2.5 bg-gray-100 text-gray-700 rounded-lg font-semibold text-sm hover:bg-gray-200 transition">Registrieren</button>
                </div>

                <!-- Demo Quick-Switch (3-Ebenen Test) -->
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider mb-2 text-center font-semibold">Demo</p>
                    <button onclick="switchDemoAccount('standort','partner')" class="w-full py-2 rounded-lg text-[10px] font-semibold border border-green-200 text-green-600 hover:bg-green-50 transition">
                        ðŸ† Standort (Partner) â€“ Demo starten
                    </button>
                </div>
                
            </div>
        </div>
        <p class="text-center text-xs text-gray-400 absolute bottom-4 left-0 right-0">&copy; 2026 vit:bikes GmbH &middot; cockpit v7.2</p>
    </div>

    <!-- Pending-Screen: Warteseite nach Selbstregistrierung -->
    <div id="pendingScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang wird gepr&uuml;ft</h2>
        <p class="text-gray-500 mb-6">
          Danke f&uuml;r deine Registrierung! Dein Zugang wird vom HQ-Team gepr&uuml;ft und freigeschaltet.
          Du wirst benachrichtigt, sobald es soweit ist.
        </p>
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-400">Eingeloggt als</p>
          <p class="text-sm font-medium text-gray-700" id="pendingEmail"></p>
        </div>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Gesperrt-Screen -->
    <div id="blockedScreen" style="display:none" class="min-h-screen bg-gray-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-10 max-w-md text-center">
        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Zugang gesperrt</h2>
        <p class="text-gray-500 mb-6">
          Dein Zugang wurde deaktiviert. Bitte wende dich an das HQ-Team.
        </p>
        <button onclick="sb.auth.signOut().then(function(){ window.location.reload(); })" 
                class="text-sm text-gray-400 hover:text-gray-600 transition cursor-pointer">
          Abmelden
        </button>
      </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Top Navigation -->
        <nav class="bg-white shadow-md">
            <div class="flex justify-between items-center px-3 md:px-6 py-2 md:py-4">
                <!-- Left: Hamburger (mobile) + Logo + Location -->
                <div class="flex items-center space-x-2 md:space-x-3 min-w-0">
                    <!-- Hamburger Menu Button (mobile only) -->
                    <button onclick="toggleMobileSidebar()" class="topnav-mobile p-1.5 rounded-lg hover:bg-gray-100 flex-shrink-0" style="display:none;">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-2">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAAAmCAYAAAAWR3O2AAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAAdSElEQVR42u1ceZhUxbX/naq79TI9MwzbAIILagLuxF2DGmNQMSLQE+OKG+AWd1/2njZ5Ji9uMfiMGcFIcMu0srjEGGNg9BkxChIDgyAKAwgywMz03n3vrTrvj+6GHkDUPDV530d9X33dc/tW3Zp7fnXO7yz30sob7cf3q3fPLSjSm7Lma2Of2++UZc3tCk3QBDB20zgGgWZw4sLavY8dkp9ZY6rjAC0Apl2drxk6bIE+zBqrnn6//oirWzdnbzkpOODao/zX+oe8YXmfIQgEAMxQEQdyfcp8/aFn9/9q87J2L3FR/V4nDsksjNjeQNcHqHzuJ2maoeqDQi7ZaP3q8GmF67gVkpqgsKd9qiYeXBWe3JE033QMLYbVesc/OWb1A9QEhRjkx4wltIOIouIrA/NPDKn1TmRW9FFgAQBBYJCkjVnzB9ckNmeIwBccor87tI+/d8FnJaoAIAjI+wJrUtb34+3tLhH40H7Znw6MeI1FH/rTgIUZOmiCOtOic/GHdT9lBiEKvUf8/wRg7nh6a/rljvC4LVmz01Naf6nBveS1q4I/ojh8jsH4qIHzY5CUgFpy9bNX7NPHO6onyx4RxO52eMSBXJcULx19Xz7BAP3psvCXh9V5V2ULWgHbAaoZfiQAuS5ltI5+IPsXAPjLlPDxgyPqwlQOiuhjwbxjU7YhxAcZ6weXJT7cvKAZkmj32nNP+wjAzI/BmJTo+uC1DuvcbNHgfFH5h/Rzb3v5yvA4isOfvwvQxGIQJwF62rhBDY0RL17wWFcLvLKrwdAAdElg4FTBUCs2mbcQAAJ4eH3xjjpHGZ6GFiUBagAqYEJ0Z2XuvZ7grcwlTbJvpHhXwFCaAS12o1vKKFDluTQDqi5M5upuY/ER0255iKOQJ8fh7xH9PwmYk8uaZNxj2fkrupypBqQB7ftfri889tQFdYeeHIffGu0NhuaRIIpDn7DXltv616j+BQ+6WrtoBgctEpYhhCGEIJAM2sJYnzZazpiVe0vHIF6eEvr23vV8Zs4V5EhhWlIIWwphCiENKcX6tP2TsQ/1dBCB/3pV6Jph9froTJGEKYSptPhIsAiAwxZJQ5SuLYWUG3usxcs3Rb7NHGeM2KNZ/i+NqgisQXH47dcG7vxSn8JNRcXc7ZnvP/f+gKOmPLm+60c/hojHoStE949X1I84tjG1WJIyfAZReS6toSMOiTU95vw1PebPwL4vmDQJpmfX1r1x53Gb8hSHnj6+bthhjW7Dhh4PwiiNlT7YNAHHMPUJ03NLYrHSNZ+eVHvE4GAxnC6wzHnkDa7FD0YOLIxJF3qbJwK0EFK8lzRv6UziDctkEbRlz1HTznwbSCgG6OOI/J72SQEDEGKQFCf//eut5/aqcc8AMdZlrL/se/ex3+DWNkYTNFohqAnqnRutFw9s8E7tzrMSZaExgy0DXPCM3Jz3ag+8/ImtG3Z10ecvrTnw0MEq3JH0vLA0yav84AEFw5TH/TK5mLBryT57Vb+BJzR0LTeEqvXUdk+p5AWRfHezNfuAe4oTdvwnf1wG3x6Rf0aAqXCTZgC/XDIsMnHfDW/2Dfj72gbRsi6j5eD73Clrb0Bg2D3Iv3xl4KyjBhWfzrs7kVVVHyT5j0329w+5t/CzldfCXvJhiS/sWw8xqhFqxlsNA08fkVo+IKQirip5QwDgayAUAFZtNt96em2/428csb5IZQGX12VQHO67N5nPDW/wzujOYTtQATYJXFCGu2B1aOSEccmORX+GeL8bOjoCTHEw9miWzx4wANAahWxKQLVGQwePHuouDJu+ZZnSWLrZvuHwB7K/BGJi7c23Lx8Q8vfPeMxSlrgLM3TIAm3KGu9PXzj4oOaTOlzEwRUTUIl7LL3BmjGyv3tpTxbeNnPCgBTQDIG/rXWOPvXh3OLKOqrHvnxVZMxRA7PPFz2luAqozPDrgsJY9IH986/8d/57e2IsnyPp3fFAUwJqfgxGUyL7jzc22pMUG0bRU97QiHvP368K3PXud34+d4DjH5DNMwuG0ApgXfJ6QJI+SJs3xds6Chi5nS+0RiFFE1Tb5NojhoT1pEweCgSjfH2hAR12yFifMmae+nBuMbduBwsAwjLw5FGjzGHh3F2SFOsdvLGACbkhJdY90xn+T45BoGmP6fnCAAMAFc9p7GOZxNIPzVhASFNq3zu4oXjj3hHvrEwRTCABDZAGtA8VsSDX9YgXjrk/P2/HHR6NlpAzLJK7O2L7wisBrMI92DEhNmVkclGH8SOOQTQv224+uBWC4tCXHPPOtUNr9Yh0EZp6u/BsSkkdKft78cTmTDVQ97QvCDAAUAncHTczd9vKreasWkuY3RkUUnkoAMRMAAuwJrYE0JMzvPZN1s0EIJGokmYZPG9eE4gOqVOjk4Xt3KNCfQImifVJ66cXzsltxEhQvIq7YBm4NTqw396R4o8KvtbVa9YMVetAdiTFq8fdn3mMo3tM0b8MMACAOBS3Qt7w0uArVvcYb9RZ5LAikCawLpkirUmHLSE3puV9Zz2SXfqXGIxt3KNsTm76+oDQwJB/h9Kaq3mTZugaC6Kj21j5wxcGTeMYBFWZk0q8Z+Sgnp8OrFF1eQ+8LdcEwBBAxpX6g4x5HYE4sUee/1rAEMBYBn5h1arii2uDEz/MGJ1BCak90qQJrKBDArQxJT/823rnNo5BnNRctcPL5uS8A3tuHRzxh+VcqOoAnyCwhqD1WfOGP65aVcRIbPOmK7znhcuDhw2u9S5L57lXcBAMv8YRckNGzjzx17lFujfv2dP+JRqmZJq0jkJOebZ77dJuc3zeM3yLiLUPhiY2hRAbk+YPLpmX7FkAiEqOhmMQiELPGF+7715BdXMmx5oVSeZqc0JyTY/xxxPuz/3ho3jP8Drv7oitpM/gat5jGxCbsyL5PxtqfsgMquY9e9q/EDAAQAkojsH4xmOZV9u7zKm2ISQxFWsk0fvdxuJRD93y8E45mpEgIvCoAYU7+wV00PXAxEzwAe2DDYC689J9Nxm+kRm0S95zdficobXq5NQOvIcAFbCEWJcyfnb5E1s3ILEnKPdvBZgKCX5zMswTH8nMeHuLdW+fsHBcLUVHKnAdIa4TO8RyqAnqTxfWjd43os7pybMikNxWYaOgakwSH/TI+8bO6Fq+oLkq5lLhPYcMCA0IF+5i1qy5N+8JWZBru+Wqn7/R91c78p497fNtxqc5+Sst8DkGQfHM9UsvDa3tceWmrz/e/T/MIKIqc1KKG4t9wz+/O0AaSZ8gqGRTmEmHTIhNablx+abgbRwrCsS3j10QK2mqxd9J3jikVu3Tk4MvaPs6BYEZQqxLGzclFq7P40ZIYA9g/mWR3k86iLcHzqi6tmR+DMbJcfgLLw5eNmqANz1V1IoEJIjLLBqqNiDkok7niqNbMtOruUssBtHcDJ57bv2Q4/fLLA9ZXsD1Qb3yRQHI97qtF4bf6Y75v0R0q2t9qATY7dyrrHkT7eBPQaQpFottM5vxePwTl1DEYjGjalxlLf/0fP92gNl2w9vBVHVDywlMammvrxnbN9teZ+vGvAITQZBgMKAiDsu1GWPxfvedfRRHE6AENHZIH6y4zp51QF/3gq48Kymr8kUC2tNSL+oMHPa1BzLL0Vxyu/fs+39Tk7Qjp9npYDmT/ebFxVhjiAZtzZMvBAxoBjNBCEbelXgvad0IJCqJS67mPQsurTm2MZg7P5VjJRiSt/n3UKEAGcs6jf8+9TeZdv4aJMU/tXYhADz30oaakX2yV9jCN3K+wJqkM33MjFQXALxxdeikvft4R2kAq7daK465PzNvRy26g3YQ8XhcX3TRRftFIpErtNZg5nT//v3viMfj7g4Keae1jBkzxh46dOitlmWFtNZQSk37zW9+80H1fACyUspfTJs2rbib+f69AbMLjSOoCerpsQ1fGhrIXpPKaV0iumW3hqHqTZIreownTpuVadvJjS7NQoND9r1BQ1OqSCBiQJfzRRaJD5Ny82sf2HGOFcU/U5Mbi4HicXA2TwP7Bf27ah0feU9ASZ4DoAsAIpY3sW+ddzUAbMnIPwGYhwQEsGtwtre3l2p5pDwgEon8BzMjl8sVN2/efC8A9+PW5Pu+Y1nW98PhsKO1Ri6Xmw3gA8uyhlfmy2azfqFQ+BWA4v9bDfNRO/iAhuIv6i0yuwtCSQGBEtllRxB15im3rMv+LnOe0NwrXySpCeqNy0MX7VOjj0zmK4VR23LdbEuSH6asH16RSHUNj8E4meAzQM2x7Wb1o1zrqvMEM/j+c7RBlYJQ3QtQQvdQVmXZ1wxozalYDALdEIzdP0VBRG4+n/e5FGjaHAqFKBaLifb2dhoxYgSXecguyyyYWRARiLYzBCFEr/ls295pXDQa7VUJmUgk9I7zMzM1NzfvRD12sRaKxWJU2QC7aolEQn8mgGmNlszDC9HawxpD3lk9BdaCykG6kpLQYRvy3c3GnRNn93RwYrs5qbjR947pExkUSN/ueZqhBEFoaAIAUhGHZEe38ffDf33mDI4lRMUcEsCIf7x6rjpPx+PAtHFO5+qu3H1hk4SrpepIh3qANOJx6HOv0xoahtCAUCUQxj+BF8bMRERG+bv8xS9+kSUivSshJxKJbSS7vr4+D+DaYrEY0FpDa722rHlQmY+IDGbelQDV7tbT3NxM5TXwx5BuEY/HdRlEn7+GiSagmUGzTnM2bKnx1wwOYu9kEVoKiJIbTaIjJTqe7on8F8eyvcoPKm70okn5Hw5yMHhrQfhCsgEtSnWfxCh6Ah1p8wYgodC+PYA36/xg435hRxQVqCsPTHi0a8MOLjYB4PvPrK0/Yl8ZyiTBfojFCiPYOXXO0FsPGeBRzvPokbffzr5yZW29b8iQ9jJ9WFUUG4X/fFGfwQPrWLZv9PJNiczmbSAvt6ZdC8ucMmXKYRdeeGEeAAKBACul/CVLlnQkEgmvIqCy0L2xY8fONk1TAEA+n0+WQcK78cYoHo/r888//0giEsVikcPhsCWEaJ8xY0ZXNBqVRKQA8NSpU/trrfsUi0VorUkIwcFgkFzX7ZoxY8amylpGjx7tDB8+/IBsNhvYJVAMA93d3Ss/E8AQwNwMcdGLmzqfGls7ITiYXw2b2sz7YCKwFCTWpY3vxp/dmGsOQFJZqOX6YDWvvd/wYTWpq1OF0tMHrEt+tAarPiGSK7vlkyc9lJ1fMV2V+uMDw3zlIX1Tt6QKXAz0E9ZLkwIXnPJwfg6iEJSA4lIRL52yT+H5wSF1qA6Cky6tXrXWako0rV0YlsopaOLLTq7tP0QWL2kM+vFUno2sWzI+/QPu1xscb1mdDWkNkH8A8K2dXPnWVo2yKSEi+L6viaivbduv27ZdbWL4xBNPXHPkkUf+PB6PPzR69Gijra3NHzNmTM3QoUNXOo5Tr7WG53lHAniTiHYZVJ08ebKMx+Pe1KlTf1RTU3NboVCA4zjI5XLvJZPJ4yoa7Pzzzx/S0NBwpxDiNK112LbtCsh927YNKeWvANwUj8f11KlTT3Qc5yFm3i8UClG1aaw0KSWEEFHxmZGXODRHISc8m1y8ZKt5EUhIg9iNWBBrUvTKV1tTT3C09CzTdsZY8j4OCGfv7GMg6GrBxIKgAa3BJhFtzcrcB6nAzcwl01UJ+AJAOmM8mnVhmkJHwqYKDA765xHAiJbNJIFfvDR42MCQf7SvlBVxdMBXYl7iH7WbLOKwLZVhCzb9DYIdUhE7rMMBgx1fEZQmhAwt+wdUrR3WYcfQDQCAZaBrTxjY7ztH9x/wnaP7D4geu5ezCz6DYDBoVHogEDCIyBRC7F9XVzdjypQp17S1tflVYPIrHEZKuVuz0NLS4l166aVfC4VCt/m+75mmqTzP6yoUCmMeeeSRzhEjRvCUKVP27tev36vBYPBbRFTvOI4ZCoWMUChkOI7jhMNhQwhRUwZgrWmaj9u2PZyIyLIsGIaxyw5AfKakt5Jzongy8cq3Ij8+YRBu25onrE4Z1xOA6vRBBTzzm2pPHRIsnr2tmJwAkACDVY1FxpLN5j1fe6yng8dt5z1UfnqB4ukV717jLBhWw6ckc6xrLT6lNTqkDzWt7+LJMAGowY46L2IAPQWorozkTUmn5fTGrON6YF8QfB/cr8G112fst5jVE0XXP6RfUI1gBjoz5vqcopf7ZIRcn6bFgIe7XxsSueqwzkU1pq6XgvitTufcxEL8Qei8UXaBSSmVS6VSj2mt/TII+kspz2FmXSgU2HGcuydNmvTCww8//K5t26LMXVAeX23atnXf9yUAuuSSS/qGQqFZutRYCCFzudy3Z8yYsWry5MnmggUL+KCDDnrcNM2huVzOBSBd150DYBURMTMrrbVQSr1eBvfxlmUNLhQKipm7s9nsNVLKzRXzVV6HNgwDUspln7WXVCm8EhRP/eTN8yLvdXvoOn1OcjEDRNVllwBGjRplDg0vv9skoMACxACIwWAdMiE7kmLDiyudnXgPACwABAP8t4yYtXeYvqYVu/0cqj+grutMALPQCHXtmOF2SHQ05YrgGkOYa1LilWNnJtf8drzxJWgwaRLQpAwhI4fdn5oHYN7SK+yf7BXWIxhAd8F49fDpufOrr+vm0lxn6Ei97YcNkgiBTQDwiwqu61YA0/PAAw9cUT3u8ssvb7Jt+wmllOc4jmUYxhQAN+fzeeF5HoioF2AKhQJs2wYzQ2tNZS+JDcOYJYRozOfzBcdxnO7u7usffvjhP1188cVOS0tL4bLLLvuWaZrHpNNpT0opi8VidPr06XM+Sl5a6709z9MAZD6fX/Dggw/+/ot0q7ebJwYRpR6rkMRql3R+DJLi8Bd++90rh4b54O7qbDQTwMSSINYlze/+x1+3pm8dvJ33VNpJcSgC+J7V5rxBQa+r1qI61hpBQ58PYBbFoV+ftOGkfg4PzXvsWSTNLQWjhVGkh3wW4PKMDLAP5hgERoJW/BmOLh83CRa3QgKQSECVAF+LQqFARQCeEMiVt0BR+bBctyJgMXny5NrGxsbsxo0bqWxKWi+++OILHccZm81mWSl1cllgynVdqmiSCn/wfR/FYrGiYeQDDzzQc8EFF9xsmuY3UqlUMRgMOt3d3b+eOXPmvbFYzGhvb/cAQCl1Xj6fZ621mc/n/z5z5sw5Y8aMsXeUUT6fp7a2tkKhUOiRUgrP8xQzn3DBBRec4nne+oqGKfdNjz76aCoWi4nPBTAlVQeePxrG5v690wcxlB6znTluUMOQUE+s4HOvsktmqFobcnVS/vWrv0/P2on3VBPtVkhqSvactn9g9qCQf3mywKpG6NHzorX7nJ1Irq631CQLBA/C2JShDbNXOPOORZbvL5JiTaj0CsgBoP0KwVACDIZmMDVBcWvJ3ALA4sa1qSN7QidulNKwTBOrk7WrgQyKBV9ZxVJcTSkF13X9cv6HRo8eLWOxmFi5cuUfpJRjPc8jpVTj5MmTzYULF/p9+/bdZnqEKN2KYrEIy7JKWV2lUk1NTROI6PZ0Ou0JIayenp5n169f/51oNCrLHpcum58vMzMppbTWevi55567suxxVTassm1bZrPZ3wG4PZ1Ov6CU2mjbdqPv+wOJ6CXDMNxymEADYCnllqampvvj8fjPPjfAAMDJbTunD5pbQdQEtfiC9E8Hhbjvlnwp6rKNjQsg7RG/l7JvImSxu7LLSg3N5qzx0OCQulyz1v0D7OwbccdMHjVqesj4x5npotYRW4h1WfnYHX/dmgYAJYjB2PawUrG3jq76vstrqgSyb28/kiqZKq3Z87xtgjdNc6dA2cSJE7NSSvi+D9/3xYoVKyQAVEwSM0MptU3DeJ5XAaCntb4agFksFouWZVE6nX66ra3Nnzx5sgmU7vMxxxxjua4bqsxpGEbItu39d+RFpmlCKbUPAMydO3frWWedFdVa/15KObgMWqtMxqGUgud5QxzHuX38+PHFzxUwH5U+eKGp/qC9QsXLk0XuVbLJDL/WIWNpl/jdGXO6Fn5cNrqp5DoTUfr11ZOdt/sHcIjWQFDizPMPfLdrYIBqegpSdeeFvzYZ+C2Qr1qMAOlS723UDUD7AEr5Ly4VovfyM5dGYVkDS8fuLB6hW1oWeTuSVGaWlUhsOp2WZaGOqATgiGhrW1tb4aijjopUj91RuOXPoO/7UwuFwp8Nwxjiuq4fDAannX322e+0tLS8UnHRFy5cWJg4cWI3Mw8qu/hdvu//A+j1IJ9SSklmXlL2ksyWlpZXTzvttEP69OkzipnJ930qa6mBUsobpJQjXdeFEOLWLxQwADB69GhjaHDRPXW2NsrcpfICIbYlxIc5Si1LOt9jzlJz8ydIsjVDAvCTBXPW0JB7R6qgdIAwekgAB+eLWkUMyNUZmn9Goqu9Er9BuVaCyr23giEqHWNILmXDJfXWNQclqnNEi3e5Nx599NFU1d/q7LPPrhNCXKiUUmXOsKS8i43dRWLLoAnMnTt35bhx475lGMYr5fNtx3GePOuss4555plnVkejUSuRSLjMvEgIMYKZhe/7HU8++eRJH+eml0HTBeDFHX8fN27cCtM0/+r7vhJCDDC+UO0Sh5434e8HDQ6pUyvpg+qbGrTIWNYjfnbe01s3NDbDiH+C13I0lw3H8qTx+wGOd5sjhWMThUO2Duc9UoYgbM6ZLUAey9rL2swFmAm63FGo8oIUFwmkMy64r6W++vyEuhOnvln7RigU0u3t7e4NxwwJNO2b/GGNUEHLEGrx5tDD5z63aSkpVa2qrGg0eorWuiCEEFrrOiL6gWEYg3zfLwohbAAPlSOoH5/aIPLHjRvXMHfu3NfGjRt3fTgcnlYsFoumafYPBALzvvnNbx7f2dmZB0DMPIOZL9Jau4ZhHDphwoSrt2zZ8pvquM+uQPNRv0kpD6rElrTW+S9Ow8RLnsivXhdrNmblW/tF+PCtBfiSYCiGilgs16Tk6gc2NPySY5leVXi7nbYcMKRE97oVk0Iv9q3B2J4iXFeDHEnGxozcOHtL4BlCCu1VGWdm0syCwaLXdXK++BtBCKXZtQUaDq13X1pyxtYNa3PJBw9tx3/uX+PVNAbUd4fVsABpvJ8rvAZgqZRMRKSUUhpAvRDipQqBNQwDzAzP87xgMGhns9nZTz311EsA4LquKmfCVXVKoPxZWZsKhUKVlMJ948ePPzwUCl1aKBRylmUdrJR6tK2t7Ztlovry+PHjf1tTU3NJoVBQhmHc169fv6snTJjQVZnLNE3pum5i9uzZ944dO/ZLwWDwTi6psh1DvAEiOsH3fc+2bTOfzz8vvii8EMDNAK77Y1fqlU7jnM68XN/gwADAIQPSY0mrM9a1M9s6Cmj/dE8vLugs1fNtKtJvDUkibMEOGLDCQRIZJX5314ubsjoGY1n53TDSYAqZZNSYJAMGbCFYVIKJv3v3gOeXd8tn+gTIsiRQa2uzrlYNC1veUAAIl1y6gqsYvmJQ6aVJ0JpN0zSlaZqmZVlCSolKJyIIIWCappnL5Z4lootjsZgoEwoCUFceK5nZKLvbZtWxOtd1KR6P62g0Kt95550r8/n8wkAgEFRKIRKJnDVhwoRHTj/9dCsajcpcLndlNpt9XJYaAoHAl8Ph8PHhcPj4UCj01ZqamuMNwzisfJ3GYDB4ZjAYHFv+rO6nlP4dyywUCss8z7v+C+Uw8Th06SH7no6nzqkbe2QD3S+FPqLgo/O9HuP2rye6nyubrk9VGHVyW6nE8qq/B/4cOiL7eFhSWDG0zBGtSdszgDQ1A7q5GRyPA1qK5LqMmNMl2SgwqWTeSQNpYAT4wcQir2XRiIlLLv7g2oj0jst5oFqXREdSLgaA96RXGFmQc/M+aoQgZPK8HgBYYpXneXcppZh5+3v+KhpDCKFc131j9uzZT1UyAgAQDoeLAP7Ldd1w2TvaUOYuq4vF4t3l8dlgMFisqsFx999//297nne11pozmQybphk0TXNQIpFYU67DOW/ChAlPSim/7vu+WUW2tVJKMPNLZcCszefz03eMMlelLYTWek1nZ+ev29ratvwv6K+zJV8FcMkAAAAASUVORK5CYII=" width="140" height="38" alt="vit:bikes" class="hidden md:block">
                        <div class="w-8 h-8 bg-vit-orange rounded flex items-center justify-center md:hidden">
                            <span class="text-white font-bold text-lg">V</span>
                        </div>
                    </div>
                    <span class="text-gray-400 topnav-desktop">|</span>
                    <div class="topnav-desktop">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-semibold text-gray-700" id="locationDisplay">Standort</span>
                            <span id="premiumBadge" class="hidden"></span>
                        </div>
                        <span class="text-xs text-gray-500" id="userRoleDisplay">cockpit</span>
                    </div>
                    <!-- Mobile: compact location -->
                    <div class="topnav-mobile flex-shrink-0" style="display:none;">
                        <span class="text-[11px] font-semibold text-gray-700 truncate" id="locationDisplayMobile">Standort</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-6 flex-shrink-0">
                    <!-- Language Switcher -->
                    <div class="flex items-center space-x-0.5 md:space-x-1">
                        <button onclick="switchLang('de')" class="lang-flag text-sm md:text-lg hover:scale-125 transition-transform" title="Deutsch" data-lang="de">ðŸ‡©ðŸ‡ª</button>
                        <button onclick="switchLang('en')" class="lang-flag text-sm md:text-lg hover:scale-125 transition-transform opacity-40" title="English" data-lang="en">ðŸ‡¬ðŸ‡§</button>
                        <button onclick="switchLang('nl')" class="lang-flag text-sm md:text-lg hover:scale-125 transition-transform opacity-40" title="Nederlands" data-lang="nl">ðŸ‡³ðŸ‡±</button>
                    </div>

                    <button onclick="showView('notifications'); return false;" class="relative flex-shrink-0">
                        <svg class="w-5 h-5 md:w-6 md:h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <span class="absolute -top-1 -right-1 bg-vit-orange text-white text-[9px] md:text-xs rounded-full w-4 h-4 md:w-5 md:h-5 flex items-center justify-center">3</span>
                    </button>

                    <!-- Mobile Profile Avatar -->
                    <img id="userAvatarImgMobile" src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" class="topnav-mobile w-8 h-8 rounded-full ring-2 ring-transparent hover:ring-orange-300 cursor-pointer flex-shrink-0" style="display:none;" onclick="openProfilePanel()">
                    
                    <div class="flex items-center space-x-3 topnav-desktop cursor-pointer hover:opacity-80 transition-opacity" onclick="openProfilePanel()">
                        <img id="userAvatarImg" src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" class="w-10 h-10 rounded-full ring-2 ring-transparent hover:ring-orange-300 transition-all">
                        <div>
                            <div class="text-sm font-semibold text-gray-800" data-user-name>Demo User</div>
                            <div class="text-xs text-gray-500" id="userRoleText">Rolle</div>
                        </div>
                    </div>
                    
                    <button onclick="handleLogout()" class="text-gray-600 hover:text-vit-orange topnav-desktop">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex" style="height: calc(100vh - 3.5rem); height: calc(100dvh - 3.5rem); overflow: hidden;">
            <!-- Sidebar Overlay (mobile) -->
            <div id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>
            <!-- Sidebar -->
            <aside id="sidebarNav" class="sidebar w-64 text-white overflow-y-auto flex-shrink-0" style="position:relative;">
                <!-- Collapse toggle -->
                <button id="sidebarCollapseBtn" class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Sidebar einklappen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <div class="p-4 pt-5">
                        <!-- HQ/Standort Toggle entfernt - Umschaltung erfolgt automatisch per Rolle -->
                        <div id="hqToggleSection" class="hidden"></div>

                        <!-- Partner-level quick access (hidden in HQ mode) -->
                        <div id="partnerQuickNav">
                        <!-- Startseite -->
                        <button onclick="showView('home')" data-module="startseite" data-tooltip="Home" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            <span class="sidebar-label" data-i18n="nav_home">Startseite</span>
                        </button>

                        <!-- Kalender -->
                        <button onclick="showView('kalender')" data-module="kalender" data-tooltip="Kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span class="sidebar-label" data-i18n="nav_calendar">Kalender</span>
                        </button>

                        <!-- Aufgaben -->
                        <button onclick="showView('todo')" data-module="aufgaben" data-tooltip="Aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            <span class="sidebar-label" data-i18n="nav_todo">Aufgaben</span>
                            <span class="sidebar-badge ml-auto bg-red-500 text-white text-[10px] rounded-full px-1.5 py-0.5 font-bold" id="todoSidebarBadge">5</span>
                        </button>

                        <!-- Kommunikation -->
                        <button onclick="showView('kommunikation')" data-module="kommunikation" data-tooltip="Kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            <span class="sidebar-label" data-i18n="nav_communication">Kommunikation</span>
                        </button>

                        <hr class="border-gray-600 my-3">
                        </div>

                        <!-- Dashboards - nur fÃ¼r INHABER (jetzt in Allgemein integriert) -->
                        <div id="ownerDashboards" class="hidden">
                            <button onclick="showView('dashboards')" data-module="dashboards" data-tooltip="Dashboards" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_dashboards">Dashboards</span>
                            </button>
                        </div>

                        <!-- Fachbereiche - nur Partner-Modus -->
                        <div id="commonTools">
                            <!-- Allgemein -->
                            <button onclick="showView('allgemein')" data-module="allgemein" data-tooltip="Allgemein" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                <span class="sidebar-label" data-i18n="nav_general">Allgemein</span>
                            </button>

                            <!-- Verkauf -->
                            <button onclick="showView('verkauf')" data-module="verkauf" data-tooltip="Verkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                <span class="sidebar-label" data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <!-- Einkauf -->
                            <button onclick="showView('einkauf')" data-module="einkauf" data-tooltip="Einkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_purchasing">Einkauf</span>
                            </button>

                            <!-- Marketing -->
                            <button onclick="showView('marketing')" data-module="marketing" data-tooltip="Marketing" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <!-- Zahlen -->
                            <button onclick="showView('controlling')" data-module="controlling" data-tooltip="Zahlen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_controlling">Zahlen</span>
                            </button>

                            <!-- Buchhaltung (Standort) -->
                            <button onclick="showView('standortBilling')" data-module="standortBilling" data-tooltip="Buchhaltung" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                <span class="sidebar-label">Buchhaltung</span>
                                <span class="sidebar-badge ml-auto text-xs bg-purple-500 text-white px-1.5 py-0.5 rounded-full">Beta</span>
                            </button>
                        </div>

                        <!-- Tools - alle Standort-Rollen -->
                        <div id="partnerToolsNav">
                        <hr class="border-gray-600 my-3">

                        <button onclick="showView('wissen')" data-module="wissen" data-tooltip="Wissen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                            <span class="sidebar-label">Wissen</span>
                        </button>
                        <button onclick="showView('support')" data-module="support" data-tooltip="Support" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span class="sidebar-label">Support</span>
                        </button>
                        <button onclick="showView('entwicklung')" data-module="entwicklung" data-tooltip="Entwicklung" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                            <span class="sidebar-label">Entwicklung</span>
                        </button>
                        <button onclick="showView('shop')" data-module="shop" data-tooltip="Shop" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                            <span class="sidebar-label">Shop</span>
                        </button>
                        <button onclick="showView('aktenschrank')" data-module="aktenschrank" data-tooltip="Aktenschrank" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                            <span class="sidebar-label">Aktenschrank</span>
                        </button>
                        </div>

                        <div id="onboardingNavSection">
                        <hr class="border-gray-600 my-3">
                        <button onclick="showView('onboarding')" data-module="onboarding" data-tooltip="Onboarding" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                            <span class="sidebar-label" data-i18n="nav_onboarding">Onboarding</span>
                        </button>
                        </div>

                        <!-- Mitarbeiter - nur GeschÃ¤ftsleitung -->
                        <div id="mitarbeiterNavSection">
                        <button onclick="showView('mitarbeiter')" data-module="mitarbeiter" data-tooltip="Mitarbeiter" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                            <span class="sidebar-label">Mitarbeiter</span>
                        </button>
                        </div>


                        <!-- Dev-Status (nur HQ/Admin) -->
                        <div id="devStatusNavSection" style="display:none">
                        </div>

                        <!-- â•â•â• EXTERN (BikeEngine) SIDEBAR â•â•â• -->
                        <div id="externMenu" class="space-y-1 hidden">
                            <div class="mb-3 px-3 py-2 rounded-lg" style="background: linear-gradient(135deg, rgba(239,125,0,0.15), rgba(239,125,0,0.05));">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-lg">âš¡</span>
                                    <span class="text-sm font-bold text-vit-orange">BikeEngine</span>
                                </div>
                                <p class="text-[10px] text-gray-400">Dein Einstieg ins vit:bikes Netzwerk</p>
                            </div>

                            <button onclick="showView('externHome')" data-tooltip="Dashboard" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                <span>Dashboard</span>
                            </button>

                            <button onclick="showView('onboarding')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                                <span>Onboarding & Weg</span>
                            </button>

                            <button onclick="showView('wissen')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                <span>Akademie</span>
                            </button>

                            <button onclick="showView('kommunikation')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                <span>Community</span>
                                <span class="ml-auto text-[9px] bg-gray-600 text-gray-300 rounded px-1.5 py-0.5 font-bold">LESEN</span>
                            </button>

                            <button onclick="showView('support')" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                <span class="sidebar-label">Support</span>
                            </button>
                        </div>
                        <!-- HQ-specific items (hidden by default) -->
                        <div id="hqMenu" class="space-y-2 hidden">
                            <!-- HQ Top-Level -->
                            <button onclick="showView('hqCockpit')" data-hq-module="hqCockpit" data-tooltip="Netzwerk-Cockpit" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_hq_cockpit">Netzwerk-Cockpit</span>
                            </button>

                            <button onclick="showView('hqKommando')" data-hq-module="hqKommandozentrale" data-tooltip="Kommandozentrale" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_hq_command">Kommandozentrale</span>
                            </button>

                            <button onclick="showView('hqAktionen')" data-hq-module="hqHandlungsbedarf" data-tooltip="Handlungsbedarf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_hq_actions">Handlungsbedarf</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqOffice')" data-hq-module="hqOffice" data-tooltip="Office" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="sidebar-label">Office</span>
                                <span class="sidebar-badge ml-auto text-[9px] rounded-full px-1.5 py-0.5 font-bold" id="officeOnlineBadge" style="background:#22c55e;color:white;display:none">0</span>
                            </button>

                            <button onclick="showView('kalender')" data-module="kalender" data-tooltip="Kalender" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_calendar">Kalender</span>
                            </button>
                            <button onclick="showView('todo')" data-module="aufgaben" data-tooltip="Aufgaben" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                <span class="sidebar-label" data-i18n="nav_todo">Aufgaben</span>
                            </button>
                            <button onclick="showView('kommunikation')" data-module="kommunikation" data-tooltip="Kommunikation" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_communication">Kommunikation</span>
                            </button>

                            <hr class="border-gray-600 my-4">
                            <div class="mb-2">
                                <span class="sidebar-label text-xs text-gray-400 uppercase font-semibold px-3" data-i18n="nav_hq_control">HQ Steuerung</span>
                            </div>

                            <button onclick="showView('hqStandorte')" data-hq-module="hqStandorte" data-tooltip="Standorte" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_hq_locations">Standorte</span>
                            </button>

                            <button onclick="showView('hqFinanzen')" data-hq-module="hqFinanzen" data-tooltip="Finanzen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_hq_finance">Finanzen</span>
                            </button>

                            <button onclick="showView('hqMarketing')" data-hq-module="hqMarketing" data-tooltip="Marketing" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_marketing">Marketing</span>
                            </button>

                            <button onclick="showView('hqEinkauf')" data-hq-module="hqEinkauf" data-tooltip="Einkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_purchasing">Einkauf</span>
                            </button>
                            <button onclick="showView('hqAllgemein')" data-hq-module="hqStandorte" data-tooltip="Allgemein" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <span>ðŸ¢</span><span class="sidebar-label">Allgemein</span>
                            </button>

                            <!-- Feature Flags & Backups moved to Entwicklung -->

                            <button onclick="showView('hqVerkauf')" data-hq-module="hqStandorte" data-tooltip="Verkauf" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                <span class="sidebar-label" data-i18n="nav_sales">Verkauf</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            <button onclick="showView('hqWissen')" data-hq-module="hqAkademie" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                <span class="sidebar-label" data-i18n="nav_knowledge">Wissen</span>
                            </button>

                            <button onclick="showView('hqBilling')" data-hq-module="hqBilling" data-tooltip="Abrechnung" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                <span class="sidebar-label">Abrechnung</span>
                            </button>

                            <button onclick="showView('hqSupport')" data-hq-module="hqSupport" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_support">Support</span>
                            </button>

                            <button onclick="showView('entwicklung')" data-hq-module="hqEntwicklung" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                <span class="sidebar-label">Entwicklung</span>
                            </button>

                            <button onclick="showView('hqShop')" data-hq-module="hqBilling" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                                <span class="sidebar-label" data-i18n="nav_shop">Shop</span>
                            </button>

                            <hr class="border-gray-600 my-3">

                            
                            <button onclick="showView('hqOnboarding')" data-hq-module="hqStandorte" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                                <span>Onboarding-Pipeline</span>
                                <span class="ml-auto bg-vit-orange text-white text-[9px] rounded-full px-1.5 py-0.5 font-bold" id="hqOnbBadge">3</span>
                            </button>
                            
                            <button onclick="showView('hqEinstellungen')" data-hq-module="hqEinstellungen" class="sidebar-item flex items-center space-x-3 p-3 rounded w-full text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span>Einstellungen</span>
                            </button>
                        </div>
                    </nav>
                </div>

                <!-- HQ Quick-Switch (nur fÃ¼r HQ-User sichtbar) -->
                <div id="sidebarBottomHQ" style="padding:8px 12px;border-top:1px solid #333;display:none;">
                    <div id="impersonationBtns" style="display:flex;flex-direction:column;gap:4px;">
                        <button onclick="switchDemoAccount('standort','partner')" style="width:100%;padding:6px 10px;background:#374151;border:1px solid #4B5563;border-radius:8px;color:#9CA3AF;font-size:11px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:6px;" onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#374151'">
                            <span style="font-size:14px">ðŸ‘ï¸</span> Demo-Standort
                        </button>
                        <button onclick="impersonateUser('a2135f35-fff3-48ca-a766-4b5370ed7a1a')" style="width:100%;padding:6px 10px;background:#374151;border:1px solid #4B5563;border-radius:8px;color:#9CA3AF;font-size:11px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:6px;" onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#374151'">
                            <span style="font-size:14px">ðŸ”„</span> Thorsten Guhr
                        </button>
                    </div>
                    <div id="impersonationActive" style="display:none;">
                        <div style="background:#7C3AED;border-radius:8px;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;">
                            <span style="font-size:10px;color:white;" id="impersonationLabel">ðŸ‘ï¸ Demo</span>
                            <button onclick="exitImpersonation()" style="background:#EF4444;color:white;border:none;border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;font-weight:600;">âœ• ZurÃ¼ck</button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content-area flex-1 overflow-y-auto p-4 md:p-8 vit-background" style="min-height: 0; min-width: 0;">
                <!-- Startseite View (fÃ¼r ALLE) -->
                <div id="homeView" class="view" style="display: block;">
                    <!-- Header mit Willkommen + Dashboard anpassen -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800"><span id="welcomeText">Willkommen zurÃ¼ck!</span> ðŸ‘‹</h1>
                            <p class="text-gray-600" id="welcomeDate"></p>
                        </div>
                        <button onclick="toggleDashboardEdit()" class="flex items-center space-x-2 px-4 py-2 border-2 border-gray-300 rounded-lg hover:border-vit-orange hover:text-vit-orange transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="font-semibold" id="dashboardEditButton">Dashboard anpassen</span>
                        </button>
                    </div>

                    <!-- FESTER BEREICH (immer sichtbar) -->
                    <div class="mb-8">
                        <!-- Schnellzugriff Aktionen -->
                        <div id="quickActionsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                            <button onclick="showView('verkauf')" data-module="verkauf" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-vit-orange p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Neuer Lead</p>
                            </button>
                            
                            <button onclick="showView('verkauf'); showVerkaufTab('pipeline')" data-module="verkauf" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-blue-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Angebot erstellen</p>
                            </button>
                            
                            <button onclick="showView('support')" data-module="support" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-green-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Support anfragen</p>
                            </button>
                            
                            <button onclick="showView('wissen')" data-module="wissen" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                                <div class="bg-purple-500 p-3 rounded-lg inline-block mb-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                                <p class="font-semibold text-gray-800">Wissen</p>
                            </button>
                        </div>


                        <!-- ðŸŽ¯ TAGES-COCKPIT â€“ Heute steuern -->
                        <div id="dailyFocusBlock" class="mb-6" data-widget="daily_focus">
                            <div class="vit-card p-5" style="border-left:4px solid #EF7D00;">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-sm font-bold text-gray-800">ðŸŽ¯ Heute steuern<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-daily')">i</button></h3><div class="widget-info-popup" id="info-daily">Dein tÃ¤gliches Steuerungs-Cockpit. Zeigt die 5 wichtigsten Kennzahlen fÃ¼r heute: Umsatz, offene Leads, Aufgaben, BWA-Deadline und Termine. Klicke auf eine Kachel, um direkt ins Modul zu springen.</div>
                                    <span class="text-xs text-gray-400" id="dailyFocusDate"></span>
                                </div>
                                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                                    <div class="p-3 bg-green-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('verkauf')">
                                        <p class="text-xs text-gray-500">Umsatz heute</p>
                                        <p id="dfUmsatz" class="text-xl font-bold text-green-600">â€”</p>
                                        <p class="text-[10px] text-gray-400">Keine Daten</p>
                                    </div>
                                    <div class="p-3 bg-orange-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('verkauf')">
                                        <p class="text-xs text-gray-500">Offene Leads</p>
                                        <p id="dfLeads" class="text-xl font-bold text-vit-orange">â€”</p>
                                        <p class="text-[10px] text-gray-400">Keine Daten</p>
                                    </div>
                                    <div class="p-3 bg-blue-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('todo')">
                                        <p class="text-xs text-gray-500">Aufgaben heute</p>
                                        <p id="dfTasks" class="text-xl font-bold text-blue-600">â€”</p>
                                        <p class="text-[10px] text-gray-400">Keine Daten</p>
                                    </div>
                                    <div class="p-3 bg-purple-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('controlling')">
                                        <p class="text-xs text-gray-500">BWA-Status</p>
                                        <p id="dfBwa" class="text-lg font-bold text-gray-800">â³</p>
                                        <p id="dfBwaSub" class="text-[10px] text-gray-500">â€” Tage</p>
                                    </div>
                                    <div class="p-3 bg-yellow-50 rounded-lg text-center cursor-pointer hover:shadow-md transition" onclick="showView('kalender')">
                                        <p class="text-xs text-gray-500">Termine heute</p>
                                        <p id="dfTermine" class="text-xl font-bold text-yellow-600">â€”</p>
                                        <p class="text-[10px] text-gray-400">Keine Daten</p>
                                    </div>
                                </div>
                                <!-- Tagesimpuls -->
                                <div id="dailyImpulse" class="p-3 rounded-lg" style="background:linear-gradient(135deg,rgba(239,125,0,0.06),rgba(245,158,11,0.06))">
                                    <div class="flex items-center gap-2">
                                        <span style="font-size:16px">ðŸ’¡</span>
                                        <p class="text-xs text-gray-700"><strong>Tagesimpuls:</strong> <span id="dfImpulseText">Willkommen im Portal! Dein Tagesimpuls wird geladen, sobald Daten verfÃ¼gbar sind.</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- ðŸ¥ PERFORMANCE HEALTH SCORE -->
                        <div id="healthScoreWidget" class="vit-card p-5 mb-6" data-widget="health_score">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-gray-800">ðŸ¥ Performance Health Score<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-health')">i</button></h3><div class="widget-info-popup" id="info-health">Dein Gesamt-Score (0â€“100) zeigt, wie gut dein Standort performt. Er setzt sich zusammen aus: Controlling (25%), Verkauf (25%), Marketing (15%), Werkstatt (15%), Engagement (10%) und Disziplin (10%). ðŸŸ¢ ab 75 = Gesund, ðŸŸ¡ 50â€“74 = Beobachtung, ðŸ”´ unter 50 = Kritisch.</div>
                                <div id="healthBadge"></div>
                            </div>
                            <div class="flex items-center gap-5">
                                <div style="position:relative;width:80px;height:80px;flex-shrink:0">
                                    <svg width="80" height="80" style="transform:rotate(-90deg)">
                                        <circle cx="40" cy="40" r="34" fill="none" stroke="var(--c-bg3)" stroke-width="6"/>
                                        <circle id="healthRing" cx="40" cy="40" r="34" fill="none" stroke="#16a34a" stroke-width="6" stroke-dasharray="213.6" stroke-dashoffset="42.7" stroke-linecap="round" style="transition:all 1s ease"/>
                                    </svg>
                                    <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
                                        <span id="healthScoreNum" style="font-size:24px;font-weight:900;color:#16a34a">â€”</span>
                                    </div>
                                </div>
                                <div style="flex:1"><div id="healthCategories" class="space-y-2"></div></div>
                                <div style="width:90px;text-align:center;flex-shrink:0">
                                    <p class="text-xs text-gray-400">Trend 4W</p>
                                    <svg id="healthTrendSvg" width="80" height="32" style="margin:4px auto"></svg>
                                    <p id="healthTrendText" class="text-xs font-semibold text-green-600"></p>
                                </div>
                            </div>
                            <div id="healthTrainerHint" class="mt-3 p-2.5 rounded-lg text-xs" style="background:linear-gradient(135deg,rgba(239,125,0,0.06),rgba(245,158,11,0.04));display:none">
                                <span style="font-size:13px">ðŸŽ“</span> <span id="healthTrainerText" class="text-gray-600"></span>
                            </div>
                        </div>

                        <!-- Kern-Metrik: Umsatz -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ VS. PLAN<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-umsatz')">i</button></h2><div class="widget-info-popup" id="info-umsatz">Vergleich deines tatsÃ¤chlichen Umsatzes mit dem Plan â€“ aufgeteilt in Heute, diese Woche und diesen Monat. Der Fortschrittsbalken zeigt, wie nah du am Ziel bist.</div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Heute</p>
                                    <p class="text-3xl font-bold text-gray-400">â€”</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs text-gray-400 font-semibold">â€”</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Plan: â€”</p>
                                </div>

                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Diese Woche</p>
                                    <p class="text-3xl font-bold text-gray-400">â€”</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs text-gray-400 font-semibold">â€”</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Plan: â€”</p>
                                </div>

                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Dieser Monat</p>
                                    <p class="text-3xl font-bold text-gray-400">â€”</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs text-gray-400 font-semibold">â€”</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Plan: â€”</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WIDGET-BEREICH (anpassbar) -->
                    <div class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Meine Widgets</h2>
                    </div>

                    <div id="widgetContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Widget 1: Verkaufs-Pipeline -->
                        <div class="dashboard-widget vit-card p-6" data-widget="pipeline">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“ˆ Meine Pipeline</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-400" id="wPipelineBadge"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wPipelineContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('verkauf')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zur Pipeline
                            </button>
                        </div>

                        <!-- Widget 2: Verkaufserfolg KW -->
                        <div class="dashboard-widget vit-card p-6" data-widget="success">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ’° Verkaufserfolg</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700" id="wSuccessKW"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wSuccessContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('verkauf')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zum Verkauf
                            </button>
                        </div>

                        <!-- Widget 3: Termine Heute -->
                        <div class="dashboard-widget vit-card p-6" data-widget="termine">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“… Termine Heute</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700" id="wTermineCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wTermineContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('kalender')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zum Kalender
                            </button>
                        </div>

                        <!-- Widget 4: Offene Aufgaben -->
                        <div class="dashboard-widget vit-card p-6" data-widget="aufgaben">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">âœ… Offene Aufgaben</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-orange-700" id="wAufgabenCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wAufgabenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('onboarding')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Alle Aufgaben
                            </button>
                        </div>

                        <!-- Widget 5: Marketing Kampagnen -->
                        <div class="dashboard-widget vit-card p-6" data-widget="marketing">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“Š Marketing Performance</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wMarketingContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('marketing')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Marketing Ã¶ffnen
                            </button>
                        </div>

                        <!-- Widget 6: Team Performance -->
                        <div class="dashboard-widget vit-card p-6" data-widget="team">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ‘¥ Team-Ãœbersicht</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wTeamContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('mitarbeiter')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Mitarbeiter
                            </button>
                        </div>

                        <!-- Widget 7: Controlling -->
                        <div class="dashboard-widget vit-card p-6" data-widget="controlling">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“Š Controlling</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wControllingContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('controlling')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Controlling Ã¶ffnen
                            </button>
                        </div>

                        <!-- Widget 8: Support Tickets -->
                        <div class="dashboard-widget vit-card p-6" data-widget="support">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸŽ¯ Support Tickets</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700" id="wSupportCount"></span>
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wSupportContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('support')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Support
                            </button>
                        </div>

                        <!-- Widget 9: Wissens-Updates -->
                        <div class="dashboard-widget vit-card p-6" data-widget="wissen">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“š Neue Inhalte</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wWissenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('allgemein');showAllgemeinTab('wissen')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zu Wissen
                            </button>
                        </div>

                        <!-- Widget 10: Nachrichten HQ -->
                        <div class="dashboard-widget vit-card p-6" data-widget="nachrichten">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-800">ðŸ“¬ Nachrichten HQ</h3>
                                <div class="flex items-center space-x-2">
                                    <button class="widget-remove hidden text-gray-400 hover:text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="wNachrichtenContent">
                                <div class="space-y-2 animate-pulse"><div class="h-3 bg-gray-200 rounded w-3/4"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-2/3"></div></div>
                            </div>
                            <button onclick="showView('kommunikation')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">
                                â†’ Zur Kommunikation
                            </button>
                        </div>
                    </div>

                    <!-- Widget hinzufÃ¼gen Panel (versteckt bis Edit-Modus) -->
                    

                        <!-- Widget: Monatsfokus -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸ“… Monatsfokus</h3>
                                <span class="text-xs text-gray-400" id="homeMonatsfokusMonat"></span>
                            </div>
                            <div id="homeMonatsfokusContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('monatsplan')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Monatsplan Ã¶ffnen â†’</button>
                        </div>
                        
                        <!-- Widget: Jahresziele -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸŽ¯ Jahresziele</h3>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-100 text-vit-orange" id="homeJahreszieleCount">0 Ziele</span>
                            </div>
                            <div id="homeJahreszieleContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('jahresziele')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Alle Ziele â†’</button>
                        </div>
                        
                        <!-- Widget: Letztes Journal -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">ðŸ“ Partner-Journal</h3>
                                <span class="text-xs text-gray-400" id="homeJournalDatum"></span>
                            </div>
                            <div id="homeJournalContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('journal')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Journal Ã¶ffnen â†’</button>
                        </div>
                        
                        <!-- Widget: Offene MaÃŸnahmen -->
                        <div class="vit-card vit-card-watermark p-5">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">âš¡ Offene MaÃŸnahmen</h3>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="homeMassnahmenCount">0</span>
                            </div>
                            <div id="homeMassnahmenContent"><p class="text-sm text-gray-400 italic">Lade...</p></div>
                            <button onclick="showView('allgemein');showAllgemeinTab('journal')" class="mt-4 w-full text-sm text-vit-orange hover:text-orange-600 font-semibold">Alle MaÃŸnahmen â†’</button>
                        </div>

<div id="widgetAddPanel" class="hidden mt-6 vit-card p-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Widget hinzufÃ¼gen</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="addWidget('pipeline')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Pipeline
                            </button>
                            <button onclick="addWidget('success')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Verkaufserfolg
                            </button>
                            <button onclick="addWidget('termine')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Termine
                            </button>
                            <button onclick="addWidget('aufgaben')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Aufgaben
                            </button>
                            <button onclick="addWidget('marketing')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Marketing
                            </button>
                            <button onclick="addWidget('team')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Team
                            </button>
                            <button onclick="addWidget('controlling')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Controlling
                            </button>
                            <button onclick="addWidget('support')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Support
                            </button>
                            <button onclick="addWidget('wissen')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Wissen
                            </button>
                            <button onclick="addWidget('nachrichten')" class="p-3 border-2 border-gray-200 rounded-lg hover:border-vit-orange text-sm">
                                + Nachrichten
                            </button>
                        </div>
                    </div>
                </div> <!-- END homeView -->

                <!-- CRM View -->
                <div id="verkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_sales">VERKAUF</h1>

                    <!-- ðŸ”¥ Verkaufs-Momentum --><div style="position:relative">
                    <div id="trainerAreaVerkauf" class="mb-4"></div>
                    <div id="salesMomentumBar" class="mb-6" data-widget="sales_momentum">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
                            <!-- Streak -->
                            <div class="vit-card p-4 flex items-center gap-3" style="border-left:3px solid #EF7D00;">
                                <div style="font-size:28px" id="streakEmoji">ðŸ”¥</div>
                                <div>
                                    <p class="text-xs text-gray-400">Lead-Streak<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-streak')">i</button></p><div class="widget-info-popup" id="info-streak">Dein Lead-Streak zÃ¤hlt, wie viele Tage in Folge du mindestens 1 Lead-AktivitÃ¤t hattest. Dazu kommen Monatsziel-Fortschritt, Abschlussquote und durchschnittlicher Deal-Wert im Vergleich zum Netzwerk.</div>
                                    <p class="text-xl font-bold text-gray-800"><span id="streakDays">12</span> Tage</p>
                                    <p class="text-[10px] text-vit-orange font-semibold">LÃ¤ngster: 18 Tage</p>
                                </div>
                            </div>
                            <!-- Monatsziel -->
                            <div class="vit-card p-4">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-xs text-gray-400">Monatsziel</p>
                                    <span id="goalPct" class="text-xs font-bold text-green-600">72%</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2.5 mb-2"><div id="goalBar" class="h-2.5 rounded-full bg-green-500 transition-all" style="width:72%"></div></div>
                                <div class="flex justify-between text-[10px] text-gray-500">
                                    <span><span id="goalIst" class="font-bold text-gray-800">86.400 â‚¬</span> erreicht</span>
                                    <span>Ziel: <span id="goalSoll">120.000 â‚¬</span></span>
                                </div>
                            </div>
                            <!-- Abschlussquote -->
                            <div class="vit-card p-4 text-center">
                                <p class="text-xs text-gray-400">Abschlussquote</p>
                                <p class="text-2xl font-bold text-gray-800" id="closeRate">34%</p>
                                <p class="text-[10px] text-green-500 font-semibold">â†‘ +4% ggÃ¼. Vormonat</p>
                            </div>
                            <!-- Durchschn. Dealwert -->
                            <div class="vit-card p-4 text-center">
                                <p class="text-xs text-gray-400">Ã˜ Deal-Wert</p>
                                <p class="text-2xl font-bold text-gray-800" id="avgDeal">4.320 â‚¬</p>
                                <p class="text-[10px] text-gray-500">Netzwerk Ã˜: 3.890 â‚¬</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showVerkaufTab('pipeline')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="pipeline">ðŸŽ¯ Pipeline</button>
                            <button onclick="showVerkaufTab('woche')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="woche">Wochenansicht</button>
                            <button onclick="showVerkaufTab('auswertung')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="auswertung">Auswertung</button>
                            <button onclick="showVerkaufTab('training')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="training">ðŸŽ™ï¸ Training KI</button>
                            <button onclick="showVerkaufTab('vkWissen')" class="vk-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="vkWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Pipeline (React CRM) ===== -->
                    <div id="vkTabPipeline" class="vk-tab-content">
                        <div id="react-pipeline-root"></div>
                    </div>

                    <!-- ===== TAB 2: Wochenansicht ===== -->
                    <div id="vkTabWoche" class="vk-tab-content" style="display:none;">
                        <!-- Week Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <button onclick="changeWeek(-1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â—€</button>
                                <h2 class="text-lg font-semibold text-gray-800" id="weekTitle">KW 7 Â· 10.02. - 15.02.2026</h2>
                                <button onclick="changeWeek(1)" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100">â–¶</button>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="openVerkaufEntryModal()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Eintragen</button>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">Monatsziel</p>
                                    <p class="font-bold text-gray-800">77.734 â‚¬</p>
                                </div>
                                <select id="weekSellerFilter" onchange="renderWeekViewFromDb()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="all">Alle Verkaeufer</option>
                                    <option value="Sandra">Sandra</option>
                                    <option value="Thomas">Thomas</option>
                                    <option value="Dirk">Dirk</option>
                                    <option value="Max">Max</option>
                                </select>
                            </div>
                        </div>

                        <!-- Week Summary KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Plan Termine</p><p class="text-2xl font-bold text-gray-800" id="wkPlan">25</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Beratungen IST</p><p class="text-2xl font-bold text-blue-600" id="wkGesamt">4</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Verkauft</p><p class="text-2xl font-bold text-green-600" id="wkVerkauft">1</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">Umsatz KW</p><p class="text-2xl font-bold text-vit-orange" id="wkUmsatz">17.056 â‚¬</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-500">VK-Quote</p><p class="text-2xl font-bold" id="wkQuote">25%</p></div>
                        </div>

                        <!-- Seller Tables -->
                        <div id="weekSellerTables" class="space-y-6"></div>
                    </div>

                    <!-- ===== TAB 3: Auswertung ===== -->
                    <div id="vkTabAuswertung" class="vk-tab-content" style="display:none;">
                        <!-- Soft Lock: Pipeline Insights -->
                        <div id="pipelineInsightLock" style="display:none;">
                            <div class="vit-card p-6 text-center mb-4" style="border:2px dashed var(--c-border);">
                                <div style="font-size:40px;margin-bottom:8px">ðŸ“Š</div>
                                <h3 class="text-base font-bold text-gray-800 mb-1">Erweiterte Pipeline-Auswertung</h3>
                                <p class="text-xs text-gray-500 mb-3">VerfÃ¼gbar ab einer Abschlussquote â‰¥ 20% oder nach Abschluss des Trainers "Nachfass-Systematik".</p>
                                <button onclick="showTrainerCard(TRAINERS&&TRAINERS[0])" class="px-4 py-2 bg-vit-orange text-white text-sm font-bold rounded-lg hover:opacity-90">ðŸŽ“ Trainer starten</button>
                            </div>
                        </div>
                        <!-- Year KPIs -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Jahresumsatz Plan</p><p class="text-2xl font-bold text-gray-800" id="ausJahresPlan">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Umsatz IST (YTD)</p><p class="text-2xl font-bold text-vit-orange" id="ausUmsatzYTD">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Verkaeufe gesamt</p><p class="text-2xl font-bold text-green-600" id="ausVerkauft">0</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">VK-Quote YTD</p><p class="text-2xl font-bold text-blue-600" id="ausQuote">â€”</p></div>
                            <div class="vit-card p-5 text-center"><p class="text-xs text-gray-500">Ã˜ Verkaufspreis</p><p class="text-2xl font-bold text-purple-600" id="ausAvgPreis">â€”</p></div>
                        </div>

                        <!-- Umsatz-Verlauf Chart -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz-Verlauf 2026</h2>
                            <div id="ausChartContainer" class="w-full" style="height:200px;position:relative;"></div>
                        </div>

                        <!-- Monthly Overview Table -->
                        <div class="vit-card p-6 mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Monatsuebersicht 2026</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50">
                                        <th class="text-left py-2.5 px-3 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Beratungen</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Verkauft</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">VK-Quote</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Umsatz</th>
                                        <th class="text-right py-2.5 px-3 font-semibold text-gray-600">Ã˜ Preis</th>
                                    </tr></thead>
                                    <tbody id="jahresTabelle"><tr><td colspan="6" class="text-center py-6 text-gray-400">Lade Daten...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Top Sellers -->
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Verkaeufer-Ranking 2026</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="ausRanking">
                                <p class="text-sm text-gray-400 col-span-4 text-center py-4">Noch keine Daten erfasst.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="vkTabVkWissen" class="vk-tab-content" style="display:none;"></div>
                    <!-- Training KI Tab -->
                    <div id="vkTabTraining" class="vk-tab-content" style="display:none;">
                        <div id="trainingMenu">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800">ðŸŽ™ï¸ Verkaufstraining KI</h2>
                                    <p class="text-xs text-gray-500">Ãœbe realistische VerkaufsgesprÃ¤che und erhalte Feedback</p>
                                </div>
                            </div>
                            <div id="trainingSpeechWarn" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-700">âš ï¸ Spracherkennung nicht verfÃ¼gbar. Du kannst alternativ Text eingeben.</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6" id="trainingScenarios"></div>
                            <div class="vit-card p-4">
                                <p class="text-xs font-bold text-gray-800 mb-2">ðŸ’¡ So funktioniert's</p>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div><span class="text-2xl block mb-1">ðŸŽ¤</span><p class="font-bold text-gray-800 text-xs">Sprechen</p><p class="text-[10px] text-gray-500">DrÃ¼cke Mikrofon und sprich</p></div>
                                    <div><span class="text-2xl block mb-1">ðŸ¤–</span><p class="font-bold text-gray-800 text-xs">KI-Kunde</p><p class="text-[10px] text-gray-500">Reagiert realistisch</p></div>
                                    <div><span class="text-2xl block mb-1">ðŸ“Š</span><p class="font-bold text-gray-800 text-xs">Feedback</p><p class="text-[10px] text-gray-500">Detaillierte Bewertung</p></div>
                                </div>
                            </div>
                        </div>
                        <div id="trainingSession" style="display:none">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span id="tSessionIcon" class="text-2xl">ðŸš€</span>
                                    <div><h3 id="tSessionTitle" class="font-bold text-gray-800"></h3><p class="text-xs text-gray-500"><span id="tSessionDiff"></span> Â· <span id="tSessionTimer">0:00</span></p></div>
                                </div>
                                <button id="tEndBtn" onclick="endTrainingSession()" disabled class="text-xs px-4 py-2 border-2 border-vit-orange text-vit-orange rounded-lg font-bold hover:bg-orange-50 transition disabled:opacity-40">Beenden &amp; Bewerten</button>
                            </div>
                            <div class="p-3 rounded-lg text-xs text-center text-white font-semibold" style="background:linear-gradient(135deg,#EF7D00,#dc6b00)">ðŸ’¡ <span id="tSessionHint"></span></div>
                            <div id="tChatMessages" class="space-y-3 mt-4" style="min-height:200px;max-height:400px;overflow-y:auto"></div>
                            <div id="tThinking" class="hidden p-3 text-center text-xs text-gray-400"><div class="inline-flex items-center gap-2"><div class="flex gap-1"><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite"></span><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite 0.2s"></span><span class="w-2 h-2 bg-gray-300 rounded-full" style="animation:tpulse 1s infinite 0.4s"></span></div> Kunde Ã¼berlegt...</div></div>
                            <div id="tWaveform" class="hidden p-3 rounded-lg mt-2"><div id="tWaveBars" class="flex items-center justify-center gap-0.5" style="height:32px"></div><p id="tWaveLabel" class="text-[10px] font-semibold text-center mt-1" style="color:#EF7D00">ðŸŽ¤ HÃ¶rt zu...</p></div>
                            <p id="tTranscript" class="hidden text-xs text-vit-orange italic text-center mt-2"></p>
                            <div class="mt-3">
                                <div class="flex gap-2">
                                    <input id="tTextInput" type="text" placeholder="Oder hier tippen..." class="flex-1 p-2.5 border border-gray-200 rounded-lg text-sm" onkeydown="if(event.key==='Enter')sendTrainingText()">
                                    <button id="tMicBtn" onclick="toggleTrainingMic()" class="w-12 h-12 rounded-full text-white text-xl flex items-center justify-center" style="background:linear-gradient(135deg,#EF7D00,#dc6b00);box-shadow:0 4px 15px rgba(239,125,0,0.3)">ðŸŽ¤</button>
                                    <button id="tSendMicBtn" onclick="sendTrainingVoice()" class="hidden w-12 h-12 rounded-full bg-green-500 text-white text-xl flex items-center justify-center font-bold">âœ“</button>
                                    <button id="tSendTextBtn" onclick="sendTrainingText()" class="hidden w-10 h-10 rounded-full text-white text-sm flex items-center justify-center" style="background:#EF7D00">â†‘</button>
                                </div>
                                <p id="tInputHint" class="text-center text-[10px] text-gray-400 mt-2">DrÃ¼cke ðŸŽ¤ oder tippe deine Antwort</p>
                            </div>
                        </div>
                        <div id="trainingEval" style="display:none">
                            <div class="text-center mb-6"><h3 id="tEvalTitle" class="text-lg font-bold text-gray-800"></h3><p id="tEvalMeta" class="text-xs text-gray-400"></p></div>
                            <div class="flex justify-center mb-4"><svg id="tScoreRing" width="96" height="96" viewBox="0 0 100 100"></svg></div>
                            <p id="tScoreLabel" class="text-center font-bold text-gray-800 mb-1"></p>
                            <p id="tScoreSummary" class="text-center text-xs text-gray-500 mb-6 px-4"></p>
                            <div class="border-t pt-4">
                                <p class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Bewertungskriterien</p>
                                <div id="tCriteriaRings" class="flex justify-center gap-4 flex-wrap mb-4"></div>
                                <div id="tCriteriaDetails" class="space-y-2 mb-6"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="p-3 rounded-lg" style="background:#f0fdf4"><p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:#059669">ðŸ’ª StÃ¤rken</p><div id="tStrengths"></div></div>
                                <div class="p-3 rounded-lg" style="background:var(--c-yellow-tint,#fffbeb)"><p class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color:#EF7D00">ðŸ’¡ Tipps</p><div id="tImprovements"></div></div>
                            </div>
                            <div class="flex justify-center gap-3">
                                <button onclick="restartTrainingScenario()" class="px-6 py-2.5 rounded-lg text-white text-sm font-bold" style="background:linear-gradient(135deg,#EF7D00,#dc6b00)">ðŸ”„ Nochmal Ã¼ben</button>
                                <button onclick="backToTrainingMenu()" class="px-6 py-2.5 rounded-lg border-2 border-gray-200 text-gray-600 text-sm font-bold hover:bg-gray-50">â† Szenarien</button>
                            </div>
                        </div>
                    </div>
                </div>

                </div>

                <!-- MARKETING View -->
                <!-- ===== DASHBOARDS VIEW (Finanzen, Marketing PRO, Team als Tabs) ===== -->
                <div id="dashboardsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_dashboards">DASHBOARDS</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showDashboardTab('finanzen')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="finanzen">Finanzen</button>
                            <button onclick="showDashboardTab('leadreporting')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="leadreporting">Marketing <span class="premium-badge ml-1 text-[8px] px-1.5 py-0.5">PRO</span></button>
                            <button onclick="showDashboardTab('team')" class="dash-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="team">Team</button>
                        </nav>
                    </div>

                    <!-- Tab: Finanzen (initially visible, content injected from old financesView) -->
                    <div id="dashTabFinanzen" class="dash-tab-content"></div>

                    <!-- Tab: Lead Reporting / Marketing PRO -->
                    <div id="dashTabLeadreporting" class="dash-tab-content" style="display:none;"></div>

                    <!-- Tab: Team -->
                    <div id="dashTabTeam" class="dash-tab-content" style="display:none;"></div>
                </div>

                <div id="leadReportingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_leadreporting">LEAD REPORTING</h1>
                    
                    <!-- Header with filters -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">â— Live-Daten</span>
                            <span class="text-sm text-gray-600">167 Leads in 2026</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <option>Jahr (YTD)</option>
                                <option>Q1</option>
                                <option>Q2</option>
                            </select>
                        </div>
                    </div>

                    <!-- 4 KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Jahresziel</span>
                                <span class="text-vit-orange text-xl">ðŸŽ¯</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">3,602.5</div>
                            <div class="text-xs text-gray-500 mt-1">Leads gesamt</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ziel YTD (2 Mon.)</span>
                                <span class="text-blue-500 text-xl">ðŸ“ˆ</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">422.7</div>
                            <div class="text-xs text-gray-500 mt-1">Soll bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Ist YTD</span>
                                <span class="text-red-500 text-xl">âš ï¸</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">167.0</div>
                            <div class="text-xs text-gray-500 mt-1">Erreicht bis heute</div>
                        </div>
                        <div class="vit-card p-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">Performance</span>
                                <span class="text-purple-500 text-xl">%</span>
                            </div>
                            <div class="text-3xl font-bold text-red-500">40%</div>
                            <div class="text-xs text-gray-500 mt-1">Zielerreichung</div>
                        </div>
                    </div>

                    <!-- Monthly Chart -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Monatliche Uebersicht</h2>
                        <div class="flex items-center space-x-4 mb-4">
                            <div id="monthlyChart" style="width:100%; height:280px; position:relative;">
                                <div class="flex items-end justify-between h-64 px-2" id="chartBars"></div>
                                <div class="flex justify-between px-2 mt-2 text-xs text-gray-500" id="chartLabels"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-center space-x-6 text-sm text-gray-500">
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-gray-300 rounded inline-block"></span><span>Soll</span></span>
                            <span class="flex items-center space-x-2"><span class="w-4 h-4 bg-vit-orange rounded inline-block"></span><span>Ist</span></span>
                        </div>
                    </div>

                    <!-- Detail Table -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Detailansicht</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-2 font-semibold text-gray-600">Monat</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Soll</th>
                                        <th class="text-right py-3 px-2 font-semibold text-green-600">Termine</th>
                                        <th class="text-right py-3 px-2 font-semibold text-purple-600">â‚¬/Termin</th>
                                        <th class="text-right py-3 px-2 font-semibold text-blue-600">SV (x0.25)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-orange-600">SV (Roh)</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-800">Gesamt</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Differenz</th>
                                        <th class="text-right py-3 px-2 font-semibold text-gray-600">Performance</th>
                                        <th class="text-center py-3 px-2 font-semibold text-gray-600">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="detailTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Marketing View (HauptmenÃ¼) â€“ REDESIGN v3: Cockpit, Budget, Kampagnen, Reichweite + Social, Strategie, Wissen -->
                <div id="marketingView" class="view" style="display: none;">
                    <div id="trainerAreaMarketing" class="mb-4"></div>
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_marketing">MARKETING</h1>
                    
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showMarketingTab('cockpit')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="cockpit">ðŸŽ¯ Cockpit</button>
                            <button onclick="showMarketingTab('budget')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="budget">ðŸ’° Budget</button>
                            <button onclick="showMarketingTab('kampagnen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="kampagnen">ðŸ“… Kampagnen</button>
                            <button onclick="showMarketingTab('reichweite')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="reichweite">ðŸ“¡ Reichweite</button>
                            <button onclick="showMarketingTab('social')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="social">ðŸŽ¬ Social Media</button>
                            <button onclick="showMarketingTab('mktStrategie')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktStrategie">ðŸ“‹ Strategie</button>
                            <button onclick="showMarketingTab('mktWissen')" class="marketing-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="mktWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <div id="marketingTabCockpit" class="marketing-tab-content"><div id="mktReactCockpit"></div></div>
                    <div id="marketingTabBudget" class="marketing-tab-content" style="display:none;"><div id="mktReactBudget"></div></div>
                    <div id="marketingTabKampagnen" class="marketing-tab-content" style="display:none;"><div id="mktReactKampagnen"></div></div>
                    <div id="marketingTabReichweite" class="marketing-tab-content" style="display:none;"><div id="mktReactReichweite"></div></div>

                    <div id="marketingTabSocial" class="marketing-tab-content" style="display:none;">

                        <!-- Motivation Header -->
                        <div class="vit-card p-5 mb-6 bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-bold text-gray-800" data-i18n="lh_title">ðŸŽ¬ Local Hero â€“ Content Strategie</h2>
                                    <p class="text-sm text-gray-600 mt-1">Dreh ein kurzes Video, lade es hoch â€“ wir machen den Rest! Schnitt, Untertitel &amp; Posting Ã¼bernimmt das HQ.</p>
                                </div>
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-vit-orange" id="smScoreNumber">4</div>
                                    <div class="text-[10px] text-gray-500 uppercase" data-i18n="lbl_videos_shot">Videos gedreht</div>
                                </div>
                            </div>
                            <!-- Progress -->
                            <div class="mt-3 flex items-center space-x-3">
                                <div class="flex-1 bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-vit-orange to-yellow-400 h-3 rounded-full transition-all" id="smProgressBar" style="width:8%"></div>
                                </div>
                                <span class="text-xs font-bold text-gray-600" id="smProgressText">4 / 50 Themen</span>
                            </div>
                            <div class="flex items-center space-x-4 mt-3">
                                <span class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded-full font-semibold" data-i18n="lbl_streak">ðŸ”¥ Streak: 2 Wochen</span>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold" data-i18n="lbl_rank">ðŸ† Rang 5 von 21</span>
                                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full font-semibold" data-i18n="lbl_next_badge">â­ Naechstes Badge: 5 Videos</span>
                            </div>
                        </div>

                        <!-- Sub-Navigation Pills -->
                        <div class="flex space-x-2 mb-5 flex-wrap gap-y-2">
                            <button onclick="switchSmSub('kanaele')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-vit-orange text-white" data-smsub="kanaele" data-i18n="sm_channels">ðŸ“± Unsere Kanaele</button>
                            <button onclick="switchSmSub('themen')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="themen" data-i18n="sm_topics">ðŸŽ¬ Themen-Auftraege</button>
                            <button onclick="switchSmSub('upload')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="upload" data-i18n="sm_upload">ðŸ“¤ Video hochladen</button>
                            <button onclick="switchSmSub('pipeline')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="pipeline">ðŸ“Š Meine Videos</button>
                            <button onclick="switchSmSub('consents')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="consents">âœ… Consents</button>
                            <button onclick="switchSmSub('ranking')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ranking" data-i18n="sm_ranking">ðŸ“Š Netzwerk-Ranking</button>
                            <button onclick="switchSmSub('ablauf')" class="sm-sub-btn px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-600" data-smsub="ablauf" data-i18n="sm_howto">â„¹ï¸ So funktioniert's</button>
                        </div>

                        <!-- SUB: Unsere KanÃ¤le -->
                        <div id="smSubKanaele" class="sm-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                                <!-- Instagram -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">Instagram</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">10.2k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">847</p><p class="text-[10px] text-gray-500" data-i18n="ch_posts">Beitraege</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">4.2%</p><p class="text-[10px] text-gray-500" data-i18n="ch_engagement">Engagement</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="flex-1 py-2 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.instagram.com/vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                                <!-- YouTube -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-red-600 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">YouTube</h3>
                                            <p class="text-xs text-gray-500">vit:bikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">156</p><p class="text-[10px] text-gray-500" data-i18n="ch_subscribers">Abonnenten</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">48</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">12.4k</p><p class="text-[10px] text-gray-500" data-i18n="ch_views">Aufrufe</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-semibold text-center hover:bg-red-700 transition">Zum Kanal â†’</a>
                                        <a href="https://www.youtube.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Abonnieren</a>
                                    </div>
                                </div>

                                <!-- TikTok -->
                                <div class="vit-card p-5">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-11 h-11 rounded-full bg-black flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1v-3.5a6.37 6.37 0 0 0-.79-.05A6.34 6.34 0 0 0 3.15 15.2a6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.34-6.34V8.73a8.19 8.19 0 0 0 4.76 1.52V6.79a4.82 4.82 0 0 1-1-.1z"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-gray-800">TikTok</h3>
                                            <p class="text-xs text-gray-500">@vitbikes</p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-4 text-center mb-4">
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">2.8k</p><p class="text-[10px] text-gray-500" data-i18n="ch_followers">Follower</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">124</p><p class="text-[10px] text-gray-500" data-i18n="ch_videos">Videos</p></div>
                                        <div class="flex-1"><p class="text-lg font-bold text-gray-800">89k</p><p class="text-[10px] text-gray-500" data-i18n="ch_likes">Likes</p></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="flex-1 py-2 bg-black text-white rounded-lg text-xs font-semibold text-center hover:opacity-90 transition">Zum Kanal â†’</a>
                                        <a href="https://www.tiktok.com/@vitbikes" target="_blank" class="py-2 px-3 border border-gray-200 rounded-lg text-xs text-gray-600 hover:bg-gray-50 transition">Folgen</a>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- SUB 1: Themen-AuftrÃ¤ge -->
                        <div id="smSubThemen" class="sm-sub-content" style="display:none;">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex space-x-2">
                                    <button onclick="filterSmThemen('all')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-smf="all" data-i18n="filter_all">Alle</button>
                                    <button onclick="filterSmThemen('neu')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="neu" data-i18n="filter_new">ðŸ†• Neu fuer dich</button>
                                    <button onclick="filterSmThemen('done')" class="sm-thema-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-smf="done" data-i18n="filter_done">âœ… Erledigt</button>
                                </div>
                                <input type="text" id="smThemenSearch" placeholder="Thema suchen..." data-i18n-placeholder="search_topic" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs w-48" oninput="filterSmThemen(currentSmFilter)">
                            </div>
                            <div id="smThemenList" class="space-y-2"></div>
                        </div>

                        <!-- SUB 2: Upload -->
                        <div id="smSubUpload" class="sm-sub-content" style="display:none;">
                            <div class="max-w-2xl mx-auto">
                                <div class="vit-card p-6">
                                    <div class="text-center mb-5">
                                        <div class="text-4xl mb-2">ðŸ“¤</div>
                                        <h3 class="text-lg font-bold text-gray-800">Videos hochladen</h3>
                                        <p class="text-sm text-gray-500">Lade ein oder mehrere Videos hoch â€“ sie werden als Gruppe zusammen geschnitten.</p>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Content-Thema waehlen</label>
                                            <select id="smUploadThema" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm">
                                                <option value="">Thema waehlen...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Kategorie</label>
                                            <select id="vpUploadCategory" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm">
                                                <option value="sonstiges">Sonstiges</option>
                                                <option value="probefahrt">Probefahrt</option>
                                                <option value="event">Event</option>
                                                <option value="werkstatt">Werkstatt</option>
                                                <option value="cargo_demo">Cargo Demo</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Deine Videos <span class="font-normal text-gray-400">(mehrere moeglich)</span></label>
                                            <div id="vpDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-vit-orange transition cursor-pointer">
                                                <div class="text-4xl mb-2">â˜ï¸</div>
                                                <p class="text-sm text-gray-600">Videos hierhin ziehen</p>
                                                <p class="text-xs text-gray-400 mt-1">oder klicken zum Auswaehlen Â· Mehrfachauswahl moeglich</p>
                                                <p class="text-[10px] text-gray-300 mt-2">MP4, MOV, WebM Â· Max. 2 GB pro Datei</p>
                                                <input type="file" id="vpFileInput" accept="video/*" multiple class="hidden">
                                            </div>
                                        </div>
                                        <!-- File Queue -->
                                        <div id="vpFileQueue" class="space-y-2"></div>
                                        <div>
                                            <label class="text-sm font-semibold text-gray-700 block mb-1">Kurzer Kommentar <span class="font-normal text-gray-400">(optional)</span></label>
                                            <textarea id="vpUploadComment" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" rows="2" placeholder="z.B. 'Drei Clips vom gleichen Kunden, bitte zusammen schneiden'"></textarea>
                                        </div>
                                        <div id="vpUploadStatus" style="display:none" class="p-4 bg-gray-50 rounded-lg">
                                            <div class="flex justify-between text-sm mb-1"><span id="vpUploadStatusText" class="font-medium">Hochladen...</span><span id="vpUploadPercent">0/0</span></div>
                                            <div class="w-full bg-gray-200 rounded-full h-2"><div id="vpUploadBar" class="bg-vit-orange h-2 rounded-full transition-all" style="width:0%"></div></div>
                                        </div>
                                        <button id="vpUploadBtn" onclick="vpDoMultiUpload()" class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold hover:opacity-90 transition text-sm disabled:opacity-50" disabled>
                                            ðŸš€ Videos einreichen
                                        </button>
                                        <p class="text-[10px] text-gray-400 text-center">Mehrere Clips werden als Gruppe zusammen geschnitten. Pipeline: Analyse â†’ Consent-Check â†’ Schnitt â†’ HQ-Freigabe â†’ Posting.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB: Meine Videos (Pipeline Dashboard) -->
                        <div id="smSubPipeline" class="sm-sub-content" style="display:none;">
                            <div id="vpDashboardContent"></div>
                        </div>

                        <!-- SUB: Consents -->
                        <div id="smSubConsents" class="sm-sub-content" style="display:none;">
                            <div id="vpConsentsContent"></div>
                        </div>

                        <!-- SUB 3: Ranking -->
                        <div id="smSubRanking" class="sm-sub-content" style="display:none;">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="vit-card p-6">
                                    <h3 class="font-bold text-gray-800 mb-4" data-i18n="rank_title">ðŸ† Content-Ranking â€“ Wer dreht am meisten?</h3>
                                    <div id="smRankingList" class="space-y-2"></div>
                                </div>
                                <div>
                                    <div class="vit-card p-6 mb-4">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_badges">ðŸŽ–ï¸ Badges</h3>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŒ±</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_first">Erster Upload</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
                                                <div class="text-2xl">ðŸŽ¬</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_3">3 Videos</p>
                                                <p class="text-[10px] text-green-600" data-i18n="badge_reached">âœ… Erreicht</p>
                                            </div>
                                            <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                                                <div class="text-2xl">â­</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_5">5 Videos</p>
                                                <p class="text-[10px] text-orange-600" data-i18n="badge_almost">Noch 1!</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ”¥</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_10">10 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ’Ž</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_25">25 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200 opacity-50">
                                                <div class="text-2xl">ðŸ‘‘</div>
                                                <p class="text-[10px] font-semibold text-gray-600 mt-1" data-i18n="badge_50">50 Videos</p>
                                                <p class="text-[10px] text-gray-400" data-i18n="badge_locked">Gesperrt</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="vit-card p-6">
                                        <h3 class="font-bold text-gray-800 mb-3" data-i18n="rank_stats">ðŸ“Š Netzwerk-Statistik</h3>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">â€”</p><p class="text-[10px] text-gray-500" data-i18n="rank_total_vids">Videos gesamt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">â€”</p><p class="text-[10px] text-gray-500" data-i18n="rank_topics_covered">Themen abgedeckt</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">â€”</p><p class="text-[10px] text-gray-500" data-i18n="rank_active">Aktive Standorte</p></div>
                                            <div class="text-center p-3 bg-gray-50 rounded-lg"><p class="text-xl font-bold">â€”</p><p class="text-[10px] text-gray-500" data-i18n="rank_no_video">Noch ohne Video</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUB 4: Ablauf -->
                        <div id="smSubAblauf" class="sm-sub-content" style="display:none;">
                            <div class="vit-card p-6 mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-4" data-i18n="howto_title">So funktioniert Local Hero â€“ in 3 Schritten</h3>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                                        <div class="w-10 h-10 bg-vit-orange text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">1. Inspiration</p>
                                        <p class="text-[10px] text-gray-500">Wir stellen Thema + Beispielvideo bereit</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">DU</div>
                                        <p class="text-xs font-bold text-gray-700">2. Drehen & Upload</p>
                                        <p class="text-[10px] text-gray-500">1-3 Min. Video mit dem Handy drehen und hier hochladen</p>
                                    </div>
                                    <div class="flex items-center justify-center"><span class="text-2xl text-gray-300">â†’</span></div>
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold">HQ</div>
                                        <p class="text-xs font-bold text-gray-700">3. Schnitt & Posting</p>
                                        <p class="text-[10px] text-gray-500">Wir schneiden, packen Untertitel drauf und posten als Collab</p>
                                    </div>
                                </div>
                            </div>

                            <div class="vit-card p-6 mb-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_tips">ðŸ’¡ Tipps fuer gute Videos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ“±</span><div><p class="text-sm font-semibold">Hochformat</p><p class="text-xs text-gray-500">9:16 Format (wie Instagram Story/Reel)</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ”Š</span><div><p class="text-sm font-semibold">Laut & deutlich sprechen</p><p class="text-xs text-gray-500">Wir packen Untertitel drauf â€“ aber guter Ton hilft</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ’¡</span><div><p class="text-sm font-semibold">Gutes Licht</p><p class="text-xs text-gray-500">Am besten Tageslicht oder Laden-Beleuchtung</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">â±ï¸</span><div><p class="text-sm font-semibold">Max. 1-3 Minuten</p><p class="text-xs text-gray-500">Kurz und knackig â€“ lieber zu kurz als zu lang</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸŽ¯</span><div><p class="text-sm font-semibold">Hook-Hauptteil-Outro</p><p class="text-xs text-gray-500">Aufbau steht bei jedem Thema dabei</p></div></div>
                                    <div class="flex items-start space-x-3"><span class="text-xl">ðŸ¤·</span><div><p class="text-sm font-semibold">Nicht perfekt sein</p><p class="text-xs text-gray-500">Authentisch > perfekt. Einfach drauflos!</p></div></div>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-bold text-gray-800 mb-3" data-i18n="howto_links">ðŸ”— Hilfreiche Links</h3>
                                <div class="space-y-2">
                                    <a href="https://fahrrad.vitbikes.de/inspiration/" target="_blank" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸŽ¥</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Beispielvideos & Inspiration</p><p class="text-[10px] text-gray-400">fahrrad.vitbikes.de/inspiration</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                    <a href="#" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-orange-50 transition">
                                        <span class="text-xl">ðŸ“‹</span><div class="flex-1"><p class="text-sm font-semibold text-vit-orange">Reel-Template (MAKE IT REEL)</p><p class="text-[10px] text-gray-400">Hook â€“ Hauptteil â€“ Outro Vorlage</p></div><span class="text-gray-400">â†’</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Tab: Marketing Strategie -->
                    <div id="marketingTabMktStrategie" class="marketing-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">ðŸ“‹</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Marketing-Strategie</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Die Marketing-Strategie wird nach dem JahresgesprÃ¤ch hier hinterlegt. Budget-Vereinbarungen, Mediamix und Performance-Daten werden dann sichtbar.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="marketingTabMktWissen" class="marketing-tab-content" style="display:none;"></div>
                </div>
                <div id="einkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_purchasing">EINKAUF</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showEinkaufTab('sortiment')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="sortiment">ðŸª Sortiment</button>
                            <button onclick="showEinkaufTab('lieferanten')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="lieferanten">ðŸ“‹ Lieferanten</button>
                            <button onclick="showEinkaufTab('zentralreg')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="zentralreg">ðŸ¦ Zentralreg.</button>
                            <button onclick="showEinkaufTab('ekStrategie')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekStrategie">ðŸŽ¯ Strategie</button>
                            <button onclick="showEinkaufTab('ekWissen')" class="ek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ekWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <div id="ekTabSortiment" class="ek-tab-content"></div>
                    <div id="ekTabLieferanten" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabZentralreg" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabEkStrategie" class="ek-tab-content" style="display:none;"></div>
                    <div id="ekTabEkWissen" class="ek-tab-content" style="display:none;"></div>
                </div>

                <div id="controllingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_controlling">ZAHLEN</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showControllingTab('cockpit')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="cockpit">ðŸŽ¯ Cockpit</button>
                            <button onclick="showControllingTab('bwa')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="bwa">BWAs</button>
                            <button onclick="showControllingTab('benchmark')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="benchmark">Benchmarks</button>
                            <button onclick="showControllingTab('planist')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="planist">Plan / Ist</button>
                            <button onclick="showControllingTab('liquiditaet')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="liquiditaet">Liquiditaet</button>
                            <button onclick="showControllingTab('ctrlWissen')" class="ctrl-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ctrlWissen">ðŸ“š Wissen</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 0: COCKPIT ===== -->
                    <div id="ctrlTabCockpit" class="ctrl-tab-content">
                        <!-- BWA Deadline Countdown + Motivation -->
                        <div id="trainerAreaControlling" class="mb-4"></div>
                        <div id="bwaDeadlineWidget" class="vit-card p-5 mb-6" data-widget="bwa_deadline">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div id="bwaCountdownRing" style="position:relative;width:64px;height:64px;flex-shrink:0">
                                        <svg width="64" height="64" style="transform:rotate(-90deg)">
                                            <circle cx="32" cy="32" r="28" fill="none" stroke="var(--c-bg3)" stroke-width="5"/>
                                            <circle id="bwaRingCircle" cx="32" cy="32" r="28" fill="none" stroke="#EF7D00" stroke-width="5" stroke-dasharray="175.9" stroke-dashoffset="0" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
                                        </svg>
                                        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
                                            <span id="bwaCountdownDays" style="font-size:18px;font-weight:900;color:#EF7D00">â€”</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h2 id="bwaDeadlineTitle" class="text-base font-bold text-gray-800">BWA-Status wird geladen...<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-bwa')">i</button></h2><div class="widget-info-popup" id="info-bwa">Zeigt den Status deiner monatlichen BWA-Einreichung. Deadline ist der 15. des Folgemonats. Einreichung vor dem 8. = ðŸ¥‡ Gold-Status. Nach dem 15. = Ã¼berfÃ¤llig mit Eskalation. Aktuelle BWA freischaltet Benchmarks und KPI-Feedback.</div>
                                        <p id="bwaDeadlineSubtext" class="text-sm text-gray-500 mt-1"></p>
                                        <div id="bwaRatingBadge" style="display:none;margin-top:6px"></div>
                                    </div>
                                </div>
                                <div id="bwaCTAArea">
                                    <button onclick="showControllingTab('bwa')" id="bwaUploadCTA" class="px-5 py-2.5 bg-vit-orange text-white font-bold text-sm rounded-lg hover:opacity-90 transition" style="display:none">
                                        ðŸ“¤ BWA jetzt einreichen
                                    </button>
                                </div>
                            </div>
                            <!-- Eskalation-Banner (Stufe 2+3) -->
                            <div id="bwaEskalationBanner" style="display:none;margin-top:12px;padding:12px 16px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca;">
                                <div class="flex items-center gap-3">
                                    <span style="font-size:20px">âš ï¸</span>
                                    <div>
                                        <p id="bwaEskText" class="text-sm font-semibold text-red-700"></p>
                                        <p id="bwaEskSub" class="text-xs text-red-500 mt-0.5"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Netzwerk-Vergleich: Wer hat schon eingereicht? -->
                        <div id="bwaNetzwerkWidget" class="vit-card p-5 mb-6" data-widget="bwa_netzwerk">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-sm font-bold text-gray-800">ðŸ“Š BWA-Status im Netzwerk<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-bwa-nw')">i</button></h2><div class="widget-info-popup" id="info-bwa-nw">Wie viele der 21 Standorte haben ihre BWA bereits eingereicht? Gold = vor dem 8., OK = bis zum 15., ÃœberfÃ¤llig = nach dem 15. Je mehr Standorte einreichen, desto besser die Netzwerk-Analyse.</div>
                                <span id="bwaNetzwerkProgress" class="text-xs font-semibold text-gray-500"></span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2.5 mb-3"><div id="bwaNetzwerkBar" class="h-2.5 rounded-full transition-all" style="width:0%;background:#EF7D00"></div></div>
                            <div id="bwaNetzwerkDetail" class="flex gap-4 text-xs text-gray-500">
                                <span id="bwaNwGold">ðŸ¥‡ Gold: â€”</span>
                                <span id="bwaNwOk">âœ… OK: â€”</span>
                                <span id="bwaNwMissing">â³ Ausstehend: â€”</span>
                                <span id="bwaNwOverdue">ðŸš¨ ÃœberfÃ¤llig: â€”</span>
                            </div>
                        </div>

                        <!-- KPI Sofort-Report (nach Upload sichtbar) -->
                        <div id="bwaKpiReport" class="vit-card p-5 mb-6" data-widget="kpi_feedback" style="display:none;border-left:4px solid #16a34a">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-sm font-bold text-gray-800">âœ… Dein Monats-Feedback<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-kpi')">i</button></h2><div class="widget-info-popup" id="info-kpi">Nach Einreichung deiner BWA erhÃ¤ltst du sofort ein Feedback mit KPIs und 1â€“3 konkreten Empfehlungen. Der Vergleich zum Netzwerk-Durchschnitt zeigt, wo du gut bist und wo Potenzial liegt.</div>
                                    <p class="text-xs text-gray-500" id="bwaKpiReportMonth"></p>
                                </div>
                                <div id="bwaKpiRating"></div>
                            </div>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4" id="bwaKpiReportGrid"></div>
                            <div id="bwaKpiInsights" class="p-3 bg-green-50 rounded-lg">
                                <p class="text-xs font-semibold text-green-700 mb-1">ðŸ’¡ Empfehlungen</p>
                                <ul id="bwaKpiRecList" class="text-xs text-green-600 space-y-1"></ul>
                            </div>
                        </div>

                        <!-- Original Cockpit Content -->
                        <div id="cockpitContent"><p class="text-sm text-gray-400 text-center py-8">Lade Cockpit-Daten...</p></div>
                    </div>

                    <!-- ===== TAB 1: BWAs ===== -->
                    <div id="ctrlTabBwa" class="ctrl-tab-content" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left: BWA Ablage -->
                            <div class="lg:col-span-1">
                                <div class="vit-card p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800">BWA Ablage</h2>
                                        <button onclick="openBwaUploadModal()" class="px-3 py-1.5 bg-vit-orange text-white text-sm rounded-lg hover:opacity-90">+ Erfassen</button>
                                    </div>
                                    <div id="bwaFileList" class="space-y-2">
                                        <p class="text-sm text-gray-400 text-center py-4">Wird geladen...</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Right: BWA Anzeige -->
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6" id="bwaDisplay">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-gray-800" id="bwaTitle">BWA auswaehlen</h2>
                                        <div class="flex space-x-2">
                                            <button onclick="editSelectedBwa()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50" id="bwaEditBtn" style="display:none">âœï¸ Bearbeiten</button>
                                            <button onclick="deleteBwa()" class="px-3 py-1.5 text-sm border border-red-300 text-red-500 rounded-lg hover:bg-red-50" id="bwaDeleteBtn" style="display:none">ðŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                    <!-- KPI Summary -->
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="bwaKpiGrid">
                                        <div class="p-4 bg-green-50 rounded-lg text-center"><p class="text-xs text-gray-500">Umsatz</p><p class="text-xl font-bold text-gray-800" id="bwaKpiUmsatz">â€”</p><p class="text-xs text-gray-400" id="bwaKpiUmsatzVj">&nbsp;</p></div>
                                        <div class="p-4 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500">Rohertrag</p><p class="text-xl font-bold text-gray-800" id="bwaKpiRohertrag">â€”</p><p class="text-xs text-gray-400" id="bwaKpiMarge">&nbsp;</p></div>
                                        <div class="p-4 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Gesamtkosten</p><p class="text-xl font-bold text-gray-800" id="bwaKpiKosten">â€”</p><p class="text-xs text-gray-400" id="bwaKpiKostenVj">&nbsp;</p></div>
                                        <div class="p-4 bg-purple-50 rounded-lg text-center"><p class="text-xs text-gray-500">Ergebnis</p><p class="text-xl font-bold text-gray-800" id="bwaKpiErgebnis">â€”</p><p class="text-xs text-gray-400" id="bwaKpiErgebnisMarge">&nbsp;</p></div>
                                    </div>
                                    <!-- Validation Banner -->
                                    <div id="bwaValidationBanner" class="hidden"></div>
                                    <!-- BWA Table -->
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm" id="bwaDetailTable">
                                            <thead><tr class="bg-gray-50"><th class="text-left py-2 px-3 font-semibold text-gray-600">Position</th><th class="text-right py-2 px-3 font-semibold text-gray-600">IST</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Plan</th><th class="text-right py-2 px-3 font-semibold text-gray-600">Abweichung</th><th class="text-right py-2 px-3 font-semibold text-gray-600">VJ</th></tr></thead>
                                            <tbody id="bwaDetailBody"><tr><td colspan="5" class="text-center py-8 text-gray-400">Waehle links eine BWA aus oder erfasse neue Daten.</td></tr></tbody>
                                        </table>
                                    </div>
                                    <!-- 12-Monats-Verlauf -->
                                    <div class="mt-6 pt-4 border-t border-gray-200" id="bwaTrendSection" style="display:none">
                                        <h3 class="font-semibold text-gray-800 mb-3">ðŸ“ˆ 12-Monats-Verlauf</h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3" id="bwaTrendCards"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Benchmarks ===== -->
                    <div id="ctrlTabBenchmark" class="ctrl-tab-content" style="display:none;">
                        <!-- Feature Lock Overlay -->
                        <div id="benchmarkLockOverlay" style="display:none;">
                            <div class="vit-card p-8 text-center mb-6" style="border:2px dashed var(--c-border);">
                                <div style="font-size:48px;margin-bottom:12px">ðŸ”’</div>
                                <h2 class="text-lg font-bold text-gray-800 mb-2">Benchmark-Vergleich gesperrt</h2>
                                <p class="text-sm text-gray-500 mb-4">Ohne aktuelle BWA-Daten ist kein Netzwerk-Vergleich mÃ¶glich.<br>Reiche deine BWA ein, um die Benchmarks freizuschalten.</p>
                                <button onclick="showControllingTab('bwa')" class="px-6 py-3 bg-vit-orange text-white font-bold text-sm rounded-lg hover:opacity-90 transition">
                                    ðŸ“¤ BWA einreichen & freischalten
                                </button>
                                <p class="text-xs text-gray-400 mt-3">Tipp: FrÃ¼habgabe vor dem 8. = Gold-Status ðŸ¥‡</p>
                            </div>
                        </div>
                        <div id="benchmarkContent">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-2">Standort-Vergleich</h2>
                            <p class="text-sm text-gray-500 mb-6">Dein Standort vs. Netzwerk-Durchschnitt (Februar 2026)</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / mÂ²</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">428 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">382 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:85%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+12% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Rohertragsmarge</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">36.7%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">34.2%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+2.5 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Umsatz / Mitarbeiter</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-orange-500">28.560 â‚¬</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">30.100 â‚¬</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-orange-400 h-2.5 rounded-full" style="width:65%"></div></div>
                                    <p class="text-xs text-orange-600 mt-1 font-semibold">-5% unter Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Personalkostenquote</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-red-500">19.9%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">18.5%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-red-400 h-2.5 rounded-full" style="width:72%"></div></div>
                                    <p class="text-xs text-red-600 mt-1 font-semibold">+1.4 Pp ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Lagerumschlag</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">4.2x</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">3.8x</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:82%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+11% ueber Durchschnitt</p>
                                </div>
                                <div class="p-5 border border-gray-200 rounded-xl">
                                    <p class="text-sm text-gray-500 mb-1">Werkstatt-Auslastung</p>
                                    <div class="flex items-end justify-between"><div><p class="text-2xl font-bold text-green-600">78%</p><p class="text-xs text-gray-500">Dein Standort</p></div><div class="text-right"><p class="text-lg font-semibold text-gray-400">72%</p><p class="text-xs text-gray-400">Netzwerk Ã¸</p></div></div>
                                    <div class="mt-3 bg-gray-200 rounded-full h-2.5"><div class="bg-green-500 h-2.5 rounded-full" style="width:78%"></div></div>
                                    <p class="text-xs text-green-600 mt-1 font-semibold">+6 Pp ueber Durchschnitt</p>
                                </div>
                            </div>
                        </div>
                    </div></div>

                    <!-- ===== TAB 3: Plan / Ist (dynamisch) ===== -->
                    <div id="ctrlTabPlanist" class="ctrl-tab-content" style="display:none;">
                        <div id="planIstContent">
                            <!-- Filled dynamically by renderPlanIst() -->
                            <div class="text-center py-12 text-gray-400">
                                <div class="w-8 h-8 border-2 border-vit-orange border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p class="text-sm">Lade Plan-Daten...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB 4: Liquiditaet ===== -->
                    <div id="ctrlTabLiquiditaet" class="ctrl-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">ðŸ’§</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">LiquiditÃ¤tsplanung</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Die LiquiditÃ¤tsplanung wird aktuell vorbereitet. Hier werden zukÃ¼nftig Cash-Flow-Prognosen, offene Forderungen und Verbindlichkeiten angezeigt.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- Wissen Tab -->
                    <div id="ctrlTabCtrlWissen" class="ctrl-tab-content" style="display:none;"></div>
                </div>


                <div id="aktenschrankView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_filingcab">AKTENSCHRANK</h1>

                    <!-- Search & Upload Bar -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="relative flex-1 max-w-md">
                                <input type="text" id="aktenSearch" onkeyup="filterAkten()" placeholder="Dokument suchen..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange">
                                <svg class="absolute left-3 top-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                        </div>
                        <button onclick="document.getElementById('aktenUploadModal').classList.remove('hidden')" class="px-4 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Dokument hochladen</button>
                    </div>

                    <!-- Folder Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8" id="aktenFolders">

                        <!-- 1. Vertraege & Recht -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('vertraege')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-blue-100 rounded-xl group-hover:bg-blue-200 transition">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-blue-100 text-blue-700 rounded-full px-2 py-0.5">8</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Vertraege &amp; Recht</h3>
                            <p class="text-xs text-gray-500">Miet-, Franchise-, Arbeitsvertraege, Versicherungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 15.01.2026</p>
                        </div>

                        <!-- 2. Finanzen & Buchhaltung -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('finanzen')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-green-100 rounded-xl group-hover:bg-green-200 transition">
                                    <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-green-100 text-green-700 rounded-full px-2 py-0.5">14</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Finanzen &amp; Buchhaltung</h3>
                            <p class="text-xs text-gray-500">BWAs, Jahresabschluesse, Steuerbescheide, Rechnungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 05.02.2026</p>
                        </div>

                        <!-- 3. Personal & HR -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('personal')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-purple-100 rounded-xl group-hover:bg-purple-200 transition">
                                    <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-purple-100 text-purple-700 rounded-full px-2 py-0.5">11</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Personal &amp; HR</h3>
                            <p class="text-xs text-gray-500">Arbeitsvertraege, Lohn, Urlaub, Fortbildungen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 31.01.2026</p>
                        </div>

                        <!-- 4. Standort & Betrieb -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('standort')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-orange-100 rounded-xl group-hover:bg-orange-200 transition">
                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-orange-100 text-orange-700 rounded-full px-2 py-0.5">6</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Standort &amp; Betrieb</h3>
                            <p class="text-xs text-gray-500">Grundrisse, Genehmigungen, Inventar, Wartung</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 10.12.2025</p>
                        </div>

                        <!-- 5. Marketing & Branding -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('marketing')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-pink-100 rounded-xl group-hover:bg-pink-200 transition">
                                    <svg class="w-7 h-7 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-4 12v4m-4-4v4m8-12V8a4 4 0 00-8 0v4m-2 0h12a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2z"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-pink-100 text-pink-700 rounded-full px-2 py-0.5">9</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Marketing &amp; Branding</h3>
                            <p class="text-xs text-gray-500">Brand Guidelines, Vorlagen, Druckdaten, Fotos</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 03.02.2026</p>
                        </div>

                        <!-- 6. Lieferanten & Einkauf -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('lieferanten')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-cyan-100 rounded-xl group-hover:bg-cyan-200 transition">
                                    <svg class="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-cyan-100 text-cyan-700 rounded-full px-2 py-0.5">7</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Lieferanten &amp; Einkauf</h3>
                            <p class="text-xs text-gray-500">Rahmenvertraege, Preislisten, Konditionen</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 20.01.2026</p>
                        </div>

                        <!-- 7. Diverses -->
                        <div class="akten-folder vit-card p-5 cursor-pointer hover:shadow-lg transition group" onclick="openAktenFolder('diverses')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="p-3 bg-gray-100 rounded-xl group-hover:bg-gray-200 transition">
                                    <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                                </div>
                                <span class="text-xs font-bold bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">3</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Diverses</h3>
                            <p class="text-xs text-gray-500">Sonstiges, Notizen, Protokolle, Temporaeres</p>
                            <p class="text-xs text-gray-400 mt-2">Zuletzt: 08.02.2026</p>
                        </div>

                    </div>

                    <!-- Folder Detail View (hidden by default) -->
                    <div id="aktenFolderDetail" class="hidden">
                        <div class="flex items-center space-x-3 mb-4">
                            <button onclick="closeAktenFolder()" class="p-2 rounded-lg border border-gray-300 hover:bg-gray-100 text-gray-600">&#9664; Zurueck</button>
                            <h2 class="text-lg font-semibold text-gray-800" id="aktenFolderTitle">Ordner</h2>
                        </div>
                        <div class="vit-card overflow-hidden">
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-50"><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Dokument</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Typ</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Hochgeladen</th><th class="text-left py-2.5 px-4 font-semibold text-gray-600">Groesse</th><th class="text-right py-2.5 px-4 font-semibold text-gray-600">Aktion</th></tr></thead>
                                <tbody id="aktenFileList"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Modal -->
                    <div id="aktenUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Dokument hochladen</h3>
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                            </div>
                            <div class="space-y-3">
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option>Vertraege &amp; Recht</option><option>Finanzen &amp; Buchhaltung</option><option>Personal &amp; HR</option>
                                    <option>Standort &amp; Betrieb</option><option>Marketing &amp; Branding</option><option>Lieferanten &amp; Einkauf</option><option>Diverses</option>
                                </select>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-vit-orange transition cursor-pointer">
                                    <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                    <p class="text-sm text-gray-500">Datei hierher ziehen oder <span class="text-vit-orange font-semibold">durchsuchen</span></p>
                                    <p class="text-xs text-gray-400 mt-1">PDF, XLSX, DOCX, JPG â€“ max. 25 MB</p>
                                </div>
                                <input type="text" placeholder="Beschreibung (optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button onclick="document.getElementById('aktenUploadModal').classList.add('hidden')" class="w-full bg-vit-orange text-white py-2 rounded-lg font-semibold hover:opacity-90">Hochladen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="supportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_support">SUPPORT</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showSupportTab('tickets')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="tickets">ðŸŽ« Tickets <span id="supTicketBadge" class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">4</span></button>
                            <button onclick="showSupportTab('kontakte')" class="sup-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="kontakte">ðŸ‘¥ Kontakte Zentrale</button>
                        </nav>
                    </div>

                    <!-- ===== TAB 1: Tickets ===== -->
                    <div id="supTabTickets" class="sup-tab-content">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterTickets('all')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-tf="all">Alle (7)</button>
                                <button onclick="filterTickets('offen')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="offen">Offen (2)</button>
                                <button onclick="filterTickets('bearbeitung')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="bearbeitung">In Bearbeitung (2)</button>
                                <button onclick="filterTickets('geloest')" class="ticket-filter-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600" data-tf="geloest">Geloest (3)</button>
                            </div>
                            <button onclick="document.getElementById('ticketCreate').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neues Ticket</button>
                        </div>

                        <!-- Create Ticket Form -->
                        <div id="ticketCreate" class="hidden vit-card p-5 mb-4">
                                                        <!-- Auto-Support Interceptor -->
                            <div id="ticketInterceptor" style="display:none" class="mb-4 p-4 rounded-xl border-2 border-orange-200 bg-orange-50">
                                <div class="flex items-center gap-3 mb-3">
                                    <span style="font-size:24px">ðŸ¤–</span>
                                    <div><p class="text-sm font-bold text-gray-800">Bevor du ein Ticket erstellst...</p><p class="text-xs text-gray-500">Wir haben mÃ¶glicherweise eine sofortige LÃ¶sung!</p></div>
                                </div>
                                <div id="interceptorContent" class="space-y-2 mb-3"></div>
                                <div class="flex gap-2">
                                    <button onclick="acceptInterceptor()" class="flex-1 px-3 py-2 bg-green-500 text-white text-xs font-bold rounded-lg hover:bg-green-600">âœ… LÃ¶sung ausprobieren</button>
                                    <button onclick="skipInterceptor()" class="flex-1 px-3 py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200">Trotzdem Ticket erstellen â†’</button>
                                </div>
                            </div>

                            <h3 class="font-semibold text-gray-800 mb-3">Neues Support-Ticket erstellen</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <select id="ticketCatInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="allgemein">Kategorie waehlen...</option>
                                    <option value="it">IT / Systeme</option>
                                    <option value="einkauf">Einkauf / Lieferanten</option>
                                    <option value="marketing">Marketing / Ads</option>
                                    <option value="buchhaltung">Buchhaltung / BWA</option>
                                    <option value="werkstatt">Werkstatt / Technik</option>
                                    <option value="sonstiges">Sonstiges</option>
                                </select>
                                <select id="ticketPrioInput" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="mittel">Prioritaet...</option>
                                    <option value="dringend">ðŸ”´ Hoch â€“ Betrieb eingeschraenkt</option>
                                    <option value="mittel">ðŸŸ¡ Mittel â€“ Wichtig, aber kein Stillstand</option>
                                    <option value="niedrig">ðŸŸ¢ Niedrig â€“ Frage / Wunsch</option>
                                </select>
                            </div>
                            <input id="ticketTitelInput" type="text" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                            <textarea id="ticketBeschreibungInput" placeholder="Beschreibe dein Problem oder deine Frage moeglichst genau..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-400">Wird im Portal gespeichert</span>
                                <div class="flex space-x-2">
                                    <button onclick="document.getElementById('ticketCreate').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                    <button onclick="submitTicketForm()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Ticket erstellen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Ticket List -->
                        <div id="ticketList" class="space-y-3"></div>

                        <!-- Zoho Desk Hinweis -->
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center space-x-3">
                            <span class="text-2xl">ðŸ”—</span>
                            <div>
                                <p class="text-sm font-semibold text-blue-800">Alle Tickets werden ueber Zoho Desk verwaltet</p>
                                <p class="text-xs text-blue-600">Fuer erweiterte Funktionen (Anhaenge, Chat, Historie) direkt in Zoho Desk oeffnen.</p>
                            </div>
                            <button class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 whitespace-nowrap">Zoho Desk oeffnen â†’</button>
                        </div>
                    </div>

                    <!-- ===== TAB 2: Kontakte Zentrale ===== -->
                    <div id="supTabKontakte" class="sup-tab-content" style="display:none;">
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">Alle Ansprechpartner der vit:bikes Zentrale auf einen Blick. Bei dringenden Problemen bitte direkt anrufen.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="kontakteGrid"></div>
                    </div>
                </div>

                <!-- ===== IDEENBOARD VIEW (Dev Pipeline) ===== -->
                <div id="entwicklungView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="h1-headline text-gray-800">ENTWICKLUNG</h1>
                            <p class="text-sm text-gray-500 mt-1">Feedback, ModulÃ¼bersicht, Releases & Steuerung</p>
                        </div>
                        <button onclick="toggleDevSubmitForm()" class="px-4 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 flex items-center space-x-2">
                            <span>ðŸ’¡</span><span>Feedback geben</span>
                        </button>
                    </div>

                    <!-- Unified Tab Navigation -->
                    <div class="flex items-center space-x-1 bg-gray-100 rounded-lg p-1 mb-5 overflow-x-auto" id="entwicklungTabs">
                        <button onclick="showEntwicklungTab('ideen')" class="entw-tab-btn px-4 py-2 rounded-md text-sm font-semibold bg-white text-gray-800 shadow-sm whitespace-nowrap" data-etab="ideen">ðŸ’¡ Ideen</button>
                        <button onclick="showEntwicklungTab('module')" class="entw-tab-btn px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="module">ðŸ“¦ Module</button>
                        <button onclick="showEntwicklungTab('releases')" class="entw-tab-btn px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="releases">ðŸš€ Releases</button>
                        <!-- HQ-only tabs -->
                        <span class="entw-hq-sep border-l border-gray-300 h-5 mx-1" style="display:none"></span>
                        <button onclick="showEntwicklungTab('steuerung')" class="entw-tab-btn entw-hq-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="steuerung" style="display:none">ðŸŽ¯ Steuerung</button>
                        <button onclick="showEntwicklungTab('flags')" class="entw-tab-btn entw-hq-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="flags" style="display:none">ðŸš© Feature Flags</button>
                        <button onclick="showEntwicklungTab('nutzung')" class="entw-tab-btn entw-hq-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="nutzung" style="display:none">ðŸ“Š Nutzung</button>
                        <button onclick="showEntwicklungTab('system')" class="entw-tab-btn entw-hq-tab px-4 py-2 rounded-md text-sm font-semibold text-gray-500 whitespace-nowrap" data-etab="system" style="display:none">âš™ï¸ System</button>
                    </div>

                    <!-- Submit Form (same as before, toggled) -->
                    <div id="devSubmitForm" class="hidden vit-card p-5 mb-6 border-2 border-vit-orange/20 relative">
                        <button onclick="toggleDevSubmitForm()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-700 text-lg transition">&times;</button>
                        <h3 class="font-semibold text-gray-800 mb-1">ðŸ’¡ Feedback / Idee einreichen</h3>
                        <p class="text-xs text-gray-400 mb-4">Audio, Bild, Screenshot oder einfach Text â€“ wir kÃ¼mmern uns um den Rest.</p>

                        <!-- Eingabetyp-Buttons -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button onclick="setDevInputType('text')" class="dev-input-type-btn px-3 py-2 rounded-lg text-sm font-semibold bg-vit-orange text-white" data-dit="text">âœï¸ Text</button>
                            <button onclick="setDevInputType('audio')" class="dev-input-type-btn px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-600" data-dit="audio">ðŸŽ¤ Audio</button>
                            <button onclick="setDevInputType('screenshot')" class="dev-input-type-btn px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-600" data-dit="screenshot">ðŸ“¸ Screenshot</button>
                            <button onclick="setDevInputType('video')" class="dev-input-type-btn px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-600" data-dit="video">ðŸ–¥ï¸ Bildschirmaufnahme</button>
                            <button onclick="setDevInputType('datei')" class="dev-input-type-btn px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-600" data-dit="datei">ðŸ“Ž Datei</button>
                        </div>

                        <!-- Audio-Aufnahme-Bereich -->
                        <div id="devAudioRecordArea" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <button onclick="toggleDevAudioRecord()" id="devAudioRecBtn" class="w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition text-xl">ðŸŽ¤</button>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800" id="devAudioStatus">Klick zum Starten</p>
                                        <p class="text-xs text-gray-500" id="devAudioTimer">00:00</p>
                                    </div>
                                </div>
                                <div id="devAudioPreview" class="hidden">
                                    <audio id="devAudioPlayer" controls class="h-8"></audio>
                                </div>
                            </div>
                        </div>

                        <!-- Bildschirmaufnahme-Bereich -->
                        <div id="devScreenRecordArea" class="hidden mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <button onclick="toggleDevScreenRecord()" id="devScreenRecBtn" class="w-12 h-12 rounded-full bg-purple-500 text-white flex items-center justify-center hover:bg-purple-600 transition text-xl">ðŸ–¥ï¸</button>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800" id="devScreenStatus">Klick zum Starten</p>
                                        <p class="text-xs text-gray-500" id="devScreenTimer">00:00</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="flex items-center space-x-1 text-xs text-gray-600 cursor-pointer">
                                        <input type="checkbox" id="devScreenWithMic" checked class="rounded border-gray-300">
                                        <span>ðŸŽ¤ Mit Mikrofon</span>
                                    </label>
                                </div>
                            </div>
                            <div id="devScreenPreview" class="hidden mt-3">
                                <video id="devScreenPlayer" controls class="w-full rounded-lg max-h-48 bg-black"></video>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1">WÃ¤hle Bildschirm/Fenster/Tab â€“ die Aufnahme wird automatisch als Datei angehÃ¤ngt.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <select id="devKategorie" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="feature">ðŸš€ Neues Feature</option>
                                <option value="verbesserung">ðŸ”§ Verbesserung</option>
                                <option value="bug">ðŸ› Bug / Problem</option>
                                <option value="prozess">ðŸ“‹ Prozess-Vorschlag</option>
                                <option value="sonstiges">ðŸ’¬ Sonstiges</option>
                            </select>
                            <select id="devModul" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">(Betroffenes Modul â€“ optional)</option>
                            </select>
                        </div>

                        <input id="devTitel" type="text" placeholder="Titel (optional â€“ wird automatisch ergÃ¤nzt)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3">
                        <textarea id="devBeschreibung" placeholder="Beschreibe deine Idee oder dein Problem mÃ¶glichst konkret..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3" rows="4"></textarea>

                        <!-- Datei-Upload -->
                        <div id="devFileArea" class="mb-3">
                            <input type="file" id="devFileInput" multiple class="hidden" onchange="handleDevFileSelect(event)">
                            <button onclick="document.getElementById('devFileInput').click()" class="px-3 py-2 border border-dashed border-gray-300 rounded-lg text-sm text-gray-500 hover:border-vit-orange hover:text-vit-orange w-full">
                                ðŸ“Ž Dateien / Screenshots hinzufÃ¼gen (optional)
                            </button>
                            <div id="devFileList" class="mt-2 space-y-1"></div>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">Dein Feedback wird automatisch analysiert und priorisiert</span>
                            <div class="flex space-x-2">
                                <button onclick="toggleDevSubmitForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                <button onclick="submitDevIdea()" id="devSubmitBtn" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ’¡ Feedback einreichen</button>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB: Ideen ===== -->
                    <div id="entwTabIdeen" class="entw-tab-content">
                        <!-- Filter Bar -->
                        <div class="flex flex-wrap items-center gap-2 mb-4">
                            <select id="entwFilterScope" onchange="renderEntwIdeen()" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5">
                                <option value="alle">Alle Bereiche</option>
                                <option value="portal">Portal</option>
                                <option value="netzwerk">Netzwerk</option>
                            </select>
                            <select id="entwFilterStatus" onchange="renderEntwIdeen()" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5">
                                <option value="alle">Alle Status</option>
                                <option value="neu">In PrÃ¼fung</option>
                                <option value="dev">In Entwicklung</option>
                                <option value="done">Umgesetzt</option>
                            </select>
                            <select id="entwFilterKat" onchange="renderEntwIdeen()" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5">
                                <option value="alle">Alle Kategorien</option>
                                <option value="feature">Feature</option>
                                <option value="bug">Bug</option>
                                <option value="verbesserung">Verbesserung</option>
                                <option value="design">Design</option>
                                <option value="sonstiges">Sonstiges</option>
                            </select>
                            <select id="entwFilterQuelle" onchange="renderEntwIdeen()" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5">
                                <option value="alle">Alle Quellen</option>
                                <option value="meine">Meine</option>
                                <option value="standort">Mein Standort</option>
                            </select>
                            <span class="text-xs text-gray-400 ml-auto" id="entwIdeenCount"></span>
                        </div>
                        <!-- Stats -->
                        <div id="entwStatsBar" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            <div class="vit-card p-3 text-center"><p class="text-xl font-bold text-gray-800" id="entwStatTotal">0</p><p class="text-[10px] text-gray-500">Gesamt</p></div>
                            <div class="vit-card p-3 text-center"><p class="text-xl font-bold text-blue-600" id="entwStatNeu">0</p><p class="text-[10px] text-gray-500">In PrÃ¼fung</p></div>
                            <div class="vit-card p-3 text-center"><p class="text-xl font-bold text-yellow-600" id="entwStatDev">0</p><p class="text-[10px] text-gray-500">In Entwicklung</p></div>
                            <div class="vit-card p-3 text-center"><p class="text-xl font-bold text-green-600" id="entwStatDone">0</p><p class="text-[10px] text-gray-500">Ausgerollt</p></div>
                        </div>
                        <div id="entwIdeenContent"></div>
                    </div>

                    <!-- ===== TAB: Module ===== -->
                    <div id="entwTabModule" class="entw-tab-content" style="display:none;">
                        <div class="flex flex-wrap items-center gap-2 mb-6">
                            <button onclick="filterModulStatus('alle')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="alle">Alle</button>
                            <button onclick="filterModulStatus('standort')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="standort">Standort-Module</button>
                            <button onclick="filterModulStatus('hq')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hq">HQ-Module</button>
                            <button onclick="filterModulStatus('widgets')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="widgets">Dashboard-Widgets</button>
                            <span class="border-l border-gray-300 h-5 mx-1"></span>
                            <button onclick="filterModulStatus('kiPrio')" class="ms-filter entw-hq-tab text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="kiPrio" style="display:none">ðŸ¤– PrioritÃ¤t KI</button>
                            <button onclick="filterModulStatus('hqPrio')" class="ms-filter entw-hq-tab text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hqPrio" style="display:none">ðŸ¢ Prio HQ</button>
                        </div>
                        <div id="entwModulContent"></div>
                    </div>

                    <!-- ===== TAB: Releases ===== -->
                    <div id="entwTabReleases" class="entw-tab-content" style="display:none;">
                        <div id="entwReleasesContent"></div>
                    </div>

                    <!-- ===== TAB: Steuerung (HQ only) ===== -->
                    <div id="entwTabSteuerung" class="entw-tab-content" style="display:none;">
                        <div id="entwSteuerungContent"></div>
                    </div>

                    <!-- ===== TAB: Feature Flags (HQ only) ===== -->
                    <div id="entwTabFlags" class="entw-tab-content" style="display:none;">
                        <div id="entwFlagsContent"></div>
                    </div>

                    <!-- ===== TAB: Nutzung (HQ only) ===== -->
                    <div id="entwTabNutzung" class="entw-tab-content" style="display:none;">
                        <div id="entwNutzungContent"></div>
                    </div>

                    <!-- ===== TAB: System (HQ only) ===== -->
                    <div id="entwTabSystem" class="entw-tab-content" style="display:none;">
                        <div id="entwSystemContent"></div>
                    </div>

                    <!-- Detail Modal -->
                    <div id="devDetailModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-start justify-center pt-10 overflow-y-auto" onclick="if(event.target===this)closeDevDetail()">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 mb-10" onclick="event.stopPropagation()">
                            <div id="devDetailContent" class="p-6"></div>
                        </div>
                    </div>
                </div>

                <div id="kommunikationView" class="view" style="display: none;">
                    <!-- Top Tab Navigation (compact) -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex space-x-1 bg-gray-100 rounded-lg p-1">
                            <button onclick="showKommTab('chat')" class="komm-tab-btn px-4 py-2 rounded-md text-sm font-semibold bg-white text-gray-800 shadow-sm" data-tab="chat">ðŸ’¬ Chat</button>
                            <button onclick="showKommTab('community')" class="komm-tab-btn px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700" data-tab="community">ðŸ‘¥ Community</button>
                        </div>
                    </div>

                    <!-- ===== TAB: Chat (Teams-Style 2-Column) ===== -->
                    <div id="kommTabChat" class="komm-tab-content">
                        <div class="flex h-[calc(100vh-180px)] min-h-[500px] bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            
                            <!-- LEFT: Conversation Sidebar -->
                            <div class="w-80 flex-shrink-0 border-r border-gray-200 flex flex-col bg-gray-50">
                                <!-- Search -->
                                <div class="p-3 border-b border-gray-200">
                                    <div class="relative">
                                        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                        <input type="text" id="kommSearchInput" placeholder="Suchen..." class="w-full pl-9 pr-3 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-vit-orange" oninput="filterKommSidebar(this.value)">
                                    </div>
                                </div>

                                <!-- New Message Button -->
                                <div class="p-3 border-b border-gray-200">
                                    <button onclick="kommStartNewChat()" class="w-full flex items-center space-x-2 px-3 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                        <span>Neue Nachricht</span>
                                    </button>
                                </div>

                                <!-- Conversation List -->
                                <div id="kommConvList" class="flex-1 overflow-y-auto">
                                    <!-- Filled by JS: sections for KanÃ¤le, Inbox, AnkÃ¼ndigungen -->
                                </div>
                            </div>

                            <!-- RIGHT: Message/Chat Area -->
                            <div class="flex-1 flex flex-col min-w-0">
                                <!-- Chat Header -->
                                <div id="kommChatHeader" class="px-5 py-3 border-b border-gray-200 flex items-center justify-between bg-white">
                                    <div class="flex items-center space-x-3">
                                        <div id="kommChatAvatar" class="w-9 h-9 bg-vit-orange rounded-lg flex items-center justify-center text-white font-bold text-sm">#</div>
                                        <div>
                                            <h3 id="kommChatTitle" class="font-bold text-gray-800 text-sm">WÃ¤hle eine Konversation</h3>
                                            <p id="kommChatSubtitle" class="text-xs text-gray-500"></p>
                                        </div>
                                    </div>
                                    <div id="kommChatHeaderActions" class="flex items-center space-x-2"></div>
                                </div>

                                <!-- Messages Area -->
                                <div id="kommChatMessages" class="flex-1 overflow-y-auto p-5 space-y-1" style="scroll-behavior:smooth;">
                                    <div class="flex items-center justify-center h-full text-gray-400 text-sm">
                                        <div class="text-center">
                                            <div class="text-4xl mb-3">ðŸ’¬</div>
                                            <p class="font-semibold">Willkommen in der Kommunikation</p>
                                            <p class="text-xs mt-1">WÃ¤hle links eine Konversation oder starte eine neue Nachricht</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Message Input (fixed bottom) -->
                                <div id="kommChatInput" class="border-t border-gray-200 p-4 bg-white" style="display:none;">
                                    <!-- Reply indicator -->
                                    <div id="kommReplyBar" class="hidden mb-2 p-2 bg-orange-50 border-l-4 border-vit-orange rounded flex items-center justify-between">
                                        <div class="text-xs text-gray-600"><span class="font-semibold" id="kommReplyTo"></span>: <span id="kommReplyPreview" class="text-gray-400"></span></div>
                                        <button onclick="cancelReply()" class="text-gray-400 hover:text-gray-600 text-sm">&times;</button>
                                    </div>
                                    <div class="flex items-end space-x-3">
                                        <div class="flex-1">
                                            <textarea id="kommMsgInput" placeholder="Nachricht schreiben..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-vit-orange resize-none" rows="1" onkeydown="kommInputKeydown(event)" oninput="kommAutoResize(this)"></textarea>
                                        </div>
                                        <button onclick="kommSendMessage()" class="px-4 py-2.5 bg-vit-orange text-white rounded-xl text-sm font-semibold hover:opacity-90 flex-shrink-0">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== TAB: Forum ===== -->
                    <!-- ===== TAB: Community (Forum + Marktplatz vereint) ===== -->
                    <div id="kommTabCommunity" class="komm-tab-content" style="display:none;">
                        <div id="forumListView">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex space-x-2 flex-wrap gap-y-2">
                                    <button onclick="filterCommunity('all')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-vit-orange text-white" data-cat="all">Alle</button>
                                    <span class="text-gray-300 self-center">|</span>
                                    <button onclick="filterCommunity('allgemein')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="allgemein">ðŸ’¬ Allgemein</button>
                                    <button onclick="filterCommunity('verkauf')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="verkauf">ðŸ›’ Verkauf</button>
                                    <button onclick="filterCommunity('werkstatt')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="werkstatt">ðŸ”§ Werkstatt</button>
                                    <button onclick="filterCommunity('einkauf')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="einkauf">ðŸ“¦ Einkauf</button>
                                    <span class="text-gray-300 self-center">|</span>
                                    <button onclick="filterCommunity('suche')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="suche">ðŸ” Gesucht</button>
                                    <button onclick="filterCommunity('biete')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="biete">ðŸ·ï¸ Biete</button>
                                    <button onclick="filterCommunity('tipp')" class="comm-cat-btn px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200" data-cat="tipp">ðŸ’¡ Tipp</button>
                                </div>
                                <button onclick="document.getElementById('forumNewPost').classList.toggle('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 flex-shrink-0">+ Neuer Beitrag</button>
                            </div>
                            <div id="forumNewPost" class="hidden vit-card p-5 mb-4">
                                <input type="text" id="forumNewTitle" placeholder="Betreff..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange">
                                <textarea id="forumNewBody" placeholder="Deine Nachricht an das Netzwerk..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-vit-orange" rows="3"></textarea>
                                <div class="flex items-center justify-between">
                                    <select id="forumNewCat" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <optgroup label="Diskussion">
                                            <option value="allgemein">ðŸ’¬ Allgemein</option>
                                            <option value="verkauf">ðŸ›’ Verkauf &amp; Beratung</option>
                                            <option value="werkstatt">ðŸ”§ Werkstatt</option>
                                            <option value="einkauf">ðŸ“¦ Einkauf &amp; Lager</option>
                                        </optgroup>
                                        <optgroup label="Marktplatz">
                                            <option value="suche">ðŸ” Rad gesucht</option>
                                            <option value="biete">ðŸ·ï¸ Rad abzugeben</option>
                                            <option value="tipp">ðŸ’¡ Tipp</option>
                                        </optgroup>
                                    </select>
                                    <div class="flex space-x-2">
                                        <button onclick="document.getElementById('forumNewPost').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Abbrechen</button>
                                        <button onclick="createCommunityPost()" class="px-5 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Posten</button>
                                    </div>
                                </div>
                            </div>
                            <div id="forumPosts" class="space-y-3"></div>
                        </div>
                        <div id="forumDetailView" class="hidden">
                            <button onclick="closeForumDetail()" class="mb-4 text-sm text-vit-orange hover:underline font-semibold">â† ZurÃ¼ck zur Ãœbersicht</button>
                            <div id="forumDetailContent" class="vit-card p-6 mb-4"></div>
                            <div class="vit-card p-5">
                                <h4 class="font-semibold text-gray-800 mb-3">Kommentare</h4>
                                <div id="forumComments" class="space-y-3 mb-4"></div>
                                <div class="flex space-x-3">
                                    <textarea id="forumCommentInput" placeholder="Dein Kommentar..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-vit-orange" rows="2"></textarea>
                                    <button onclick="postForumComment()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 self-end">Senden</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div id="forumView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_forum">FORUM</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="vit-card p-6 mb-4">
                                <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema erstellen</button>
                            </div>

                            <div class="space-y-4">
                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Neue Marketing-Kampagne fÃ¼r FrÃ¼hjahr 2026</h3>
                                                <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Hallo zusammen! Wir haben eine neue Kampagne fÃ¼r das FrÃ¼hjahr vorbereitet. 
                                                Alle Materialien sind jetzt im Bereich "Marketing" verfÃ¼gbar. WÃ¼rde mich Ã¼ber 
                                                euer Feedback freuen!
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>8 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>42 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                <span class="text-xs text-gray-500">vor 5 Stunden</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                MÃ¶chte gerne Erfahrungen austauschen zur 3D-KÃ¶rpervermessung. Wie integriert 
                                                ihr das in euren Beratungsprozess? Bei uns dauert das aktuell ca. 15-20 Minuten...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>12 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>67 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vit-card p-6 forum-post">
                                    <div class="flex items-start space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h3 class="font-semibold text-gray-800">Erfolg: Firmenkunden-Akquise</h3>
                                                <span class="text-xs text-gray-500">gestern</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mb-3">
                                                Wollte mal berichten: Wir haben gerade einen Deal mit einem lokalen Unternehmen 
                                                (50 Mitarbeiter) fÃ¼r Bike-Leasing abgeschlossen! ðŸŽ‰ Kann gerne Tipps teilen...
                                            </p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                                    </svg>
                                                    <span>15 Antworten</span>
                                                </span>
                                                <span class="flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                    <span>89 Views</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="vit-card p-6 mb-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                <div class="space-y-2">
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ”§ Technik & Service</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">45</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                    </a>
                                    <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                        <span class="text-sm text-gray-700">â“ Fragen</span>
                                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">67</span>
                                    </a>
                                </div>
                            </div>

                            <div class="vit-card p-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Aktive Mitglieder</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Markus Unger</p>
                                            <p class="text-xs text-gray-500">HQ - Marketing</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Stefan Meyer</p>
                                            <p class="text-xs text-gray-500">Partner MÃ¼nchen</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <p class="text-sm font-semibold text-gray-800">Julia Fischer</p>
                                            <p class="text-xs text-gray-500">Partner Berlin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kommunikation View (Chat + Forum kombiniert) -->
                <div id="communicationView" class="view premium-feature" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_communication">KOMMUNIKATION</h1>
                    
                    <!-- Tab Navigation -->
                    <div class="flex space-x-4 mb-6">
                        <button onclick="switchCommunicationTab('chat')" id="chatTab" class="px-6 py-3 bg-vit-orange text-white rounded-lg font-semibold">
                            ðŸ’¬ Chat
                        </button>
                        <button onclick="switchCommunicationTab('forum')" id="forumTab" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                            ðŸ—¨ï¸ Forum
                        </button>
                    </div>

                    <!-- Chat Section -->
                    <div id="chatSection">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="vit-card p-4">
                                <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                                <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                                
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">HQ Team</p>
                                            <p class="text-xs text-gray-500 truncate">Neue Schulung verfÃ¼gbar</p>
                                        </div>
                                        <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                    </div>

                                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                        <div class="relative">
                                            <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-800 text-sm">Thomas Schmidt</p>
                                            <p class="text-xs text-gray-500 truncate">Kunde wartet auf RÃ¼ckruf...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                                <div class="border-b p-4 flex items-center space-x-3">
                                    <img src="https://ui-avatars.com/api/?name=HQ+Team&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                    <div>
                                        <p class="font-semibold text-gray-800">HQ Team</p>
                                        <p class="text-xs text-green-500">â— Online</p>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto p-4">
                                    <div class="space-y-4">
                                        <div class="chat-message received">
                                            <p class="text-sm">Hey! Die neuen Marketing-Materialien sind online ðŸŽ‰</p>
                                            <p class="text-xs text-gray-500 mt-1">10:23</p>
                                        </div>

                                        <div class="chat-message sent">
                                            <p class="text-sm">Super, danke! Schaue ich mir gleich an.</p>
                                            <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                        </div>

                                        <div class="chat-message received">
                                            <p class="text-sm">Die Schulung am 22.02. - habt ihr euch schon angemeldet?</p>
                                            <p class="text-xs text-gray-500 mt-1">10:30</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-t p-4">
                                    <div class="flex space-x-2">
                                        <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                        <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                            Senden
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Section (hidden by default) -->
                    <div id="forumSection" class="view-hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="vit-card p-6 mb-4">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">+ Neues Thema</button>
                                </div>

                                <div class="space-y-4">
                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=HQ+Marketing&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">FrÃ¼hjahrs-Kampagne 2026 ist live!</h3>
                                                    <span class="text-xs text-gray-500">vor 2 Stunden</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Die Materialien sind jetzt verfÃ¼gbar! WÃ¼rde mich Ã¼ber euer Feedback freuen...
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 8 Antworten</span>
                                                    <span>ðŸ‘ï¸ 42 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vit-card p-6 forum-post">
                                        <div class="flex items-start space-x-4">
                                            <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="font-semibold text-gray-800">Best Practice: 3D-Vermessung</h3>
                                                    <span class="text-xs text-gray-500">gestern</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">
                                                    Wie integriert ihr die 3D-Vermessung in den Beratungsprozess?
                                                </p>
                                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                                    <span>ðŸ’¬ 12 Antworten</span>
                                                    <span>ðŸ‘ï¸ 67 Views</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="vit-card p-6 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-4">Kategorien</h3>
                                    <div class="space-y-2">
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“¢ AnkÃ¼ndigungen</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">8</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ’¡ Best Practices</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">23</span>
                                        </a>
                                        <a href="#" class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">ðŸ“Š Marketing</span>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">31</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="chatView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_chat">CHAT</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-4">
                            <h3 class="font-semibold text-gray-800 mb-4">Kontakte</h3>
                            <input type="text" placeholder="Suchen..." class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-vit-orange">
                            
                            <div class="space-y-2">
                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer bg-gray-100">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Markus Unger</p>
                                        <p class="text-xs text-gray-500 truncate">Super, danke fÃ¼r die Info!</p>
                                    </div>
                                    <span class="bg-vit-orange text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">2</span>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Stefan+Meyer&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Stefan Meyer</p>
                                        <p class="text-xs text-gray-500 truncate">Kannst du mir das Dokument...</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Julia+Fischer&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Julia Fischer</p>
                                        <p class="text-xs text-gray-500 truncate">Gerne! Schicke ich dir gleich</p>
                                    </div>
                                </div>

                                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <div class="relative">
                                        <img src="https://ui-avatars.com/api/?name=Team+HQ&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800 text-sm">Team HQ</p>
                                        <p class="text-xs text-gray-500 truncate">Neue Schulung nÃ¤chste Woche</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 vit-card flex flex-col" style="height: 600px;">
                            <div class="border-b p-4 flex items-center space-x-3">
                                <img src="https://ui-avatars.com/api/?name=Markus+Unger&background=EF7D00&color=fff" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-semibold text-gray-800">Markus Unger</p>
                                    <p class="text-xs text-green-500">â— Online</p>
                                </div>
                            </div>

                            <div class="flex-1 overflow-y-auto p-4">
                                <div class="space-y-4">
                                    <div class="chat-message received">
                                        <p class="text-sm">Hey! Hast du schon die neuen Marketing-Materialien gesehen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:23</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Ja, sehen super aus! Vor allem die neue FrÃ¼hjahrs-Kampagne.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:25</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Freut mich! Kannst du die gleich bei euch im Laden einsetzen?</p>
                                        <p class="text-xs text-gray-500 mt-1">10:26</p>
                                    </div>

                                    <div class="chat-message sent">
                                        <p class="text-sm">Auf jeden Fall! Wir planen das ab nÃ¤chster Woche.</p>
                                        <p class="text-xs text-white text-opacity-80 mt-1">10:28</p>
                                    </div>

                                    <div class="chat-message received">
                                        <p class="text-sm">Super, danke fÃ¼r die Info! ðŸ‘</p>
                                        <p class="text-xs text-gray-500 mt-1">10:30</p>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t p-4">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Nachricht schreiben..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-vit-orange">
                                    <button class="bg-vit-orange text-white px-6 py-2 rounded-lg hover:opacity-90">
                                        Senden
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other views placeholders -->

                <div id="todosView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6" data-i18n="h_todos">TODOS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Todo-Liste wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="financesView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">FILIAL-PERFORMANCE COCKPIT</h1>
                    
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-sm text-gray-500">Unternehmen / Standort: <strong id="bwaStandortLabel">â€”</strong></p>
                            <p class="text-sm text-gray-500">Jahr: <strong>2026</strong></p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm">2026</button>
                            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">2026-01</button>
                        </div>
                    </div>

                    <!-- Top KPI Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <!-- Umsatz -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz</p>
                            <p class="text-3xl font-bold text-gray-800">55 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag</p>
                            <p class="text-3xl font-bold text-gray-800">21 Tsd â‚¬</p>
                        </div>

                        <!-- Rohertrag Marge % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Rohertrag Marge %</p>
                            <p class="text-3xl font-bold text-gray-800">38,88%</p>
                        </div>

                        <!-- Gesamtkosten -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Gesamtkosten</p>
                            <p class="text-3xl font-bold text-gray-800">25 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT</p>
                            <p class="text-3xl font-bold text-red-600">-4 Tsd â‚¬</p>
                        </div>

                        <!-- EBIT-Marge % -->
                        <div class="vit-card p-6 bg-red-50">
                            <p class="text-xs text-gray-500 uppercase mb-2">EBIT-Marge %</p>
                            <p class="text-3xl font-bold text-red-600">-7,16%</p>
                        </div>

                        <!-- Kostenquote % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Kostenquote %</p>
                            <p class="text-3xl font-bold text-gray-800">46,13%</p>
                        </div>

                        <!-- Umsatz YoY % -->
                        <div class="vit-card p-6">
                            <p class="text-xs text-gray-500 uppercase mb-2">Umsatz YoY %</p>
                            <p class="text-3xl font-bold text-green-600">78,54%</p>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Umsatz vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">UMSATZ VS PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-32 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                55k
                                            </div>
                                            <div class="bg-gray-300 h-24 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                40k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Umsatz</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rohertrag vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">ROHERTRAG VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end space-x-4">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-500 mb-1">Januar</div>
                                        <div class="flex space-x-2">
                                            <div class="bg-vit-orange h-28 rounded-t flex items-end justify-center pb-2 text-white text-xs font-semibold" style="width: 60%">
                                                21k
                                            </div>
                                            <div class="bg-gray-300 h-20 rounded-t flex items-end justify-center pb-2 text-gray-700 text-xs font-semibold" style="width: 40%">
                                                18k
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Rohertrag</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Plan</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EBIT vs Plan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">EBIT VS. PLAN</h2>
                            <div class="space-y-3">
                                <div class="flex items-end justify-center space-x-4 h-32">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-vit-orange w-16 h-16 rounded flex items-center justify-center text-white text-xs font-semibold">
                                            -4k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">EBIT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-gray-300 w-16 h-24 rounded flex items-center justify-center text-gray-700 text-xs font-semibold">
                                            -7k
                                        </div>
                                        <div class="text-xs text-gray-500 mt-2">Plan</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YTD Metrics -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">Umsatz YTD vs VJ%</p>
                            <p class="text-4xl font-bold text-green-600">â†‘ 78,5%</p>
                        </div>

                        <div class="vit-card p-6 bg-red-50 border border-red-200">
                            <p class="text-sm text-gray-600 mb-2">Kosten YTD vs VJ %</p>
                            <p class="text-4xl font-bold text-red-600">â†‘ 62,0%</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <p class="text-sm text-gray-600 mb-2">EBIT-Marge Î” (%-Pkt.)</p>
                            <p class="text-4xl font-bold text-green-600">4,3 pp</p>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Kostenstruktur Pie Chart -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTENSTRUKTUR (% DER GESAMTKOSTEN)</h2>
                            <div class="flex items-center justify-center">
                                <div class="relative w-48 h-48">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <!-- Personalkosten 53% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#EF7D00" stroke-width="80" stroke-dasharray="167 335" stroke-dashoffset="0"></circle>
                                        <!-- Werbe-/Reisekosten 17% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#F59E0B" stroke-width="80" stroke-dasharray="54 335" stroke-dashoffset="-167"></circle>
                                        <!-- Raummieten 8% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FCD34D" stroke-width="80" stroke-dasharray="25 335" stroke-dashoffset="-221"></circle>
                                        <!-- Sonstige 22% -->
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#FEF3C7" stroke-width="80" stroke-dasharray="69 335" stroke-dashoffset="-246"></circle>
                                    </svg>
                                </div>
                                <div class="ml-6 space-y-2 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-vit-orange rounded"></div>
                                        <span>Personalkosten</span>
                                        <span class="font-semibold">53%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-500 rounded"></div>
                                        <span>Werbe-/Reisekosten</span>
                                        <span class="font-semibold">17%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-300 rounded"></div>
                                        <span>Raummieten</span>
                                        <span class="font-semibold">8%</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-amber-100 rounded"></div>
                                        <span>Sonstige</span>
                                        <span class="font-semibold">22%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kosten vs Plan Trend -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">KOSTEN VS PLAN - TREND</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Personalkosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-12 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">25% / 32%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Raummieten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-8 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-10 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">8% / 10%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Werbe-/Reisekosten</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-4 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-6 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">4% / 7%</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Sonstige</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="flex items-end space-x-1">
                                            <div class="bg-vit-orange w-2 h-10 rounded-t"></div>
                                            <div class="bg-gray-300 w-2 h-14 rounded-t"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 w-16">10% / 13%</span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 text-xs pt-2 border-t">
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-vit-orange rounded"></div>
                                        <span>Kosten Anteil am Umsatz %</span>
                                    </div>
                                    <div class="flex items-center space-x-1">
                                        <div class="w-3 h-3 bg-gray-300 rounded"></div>
                                        <span>Kosten Anteil am Plan-Umsatz %</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Benchmarking -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">ABWEICHUNG ROHERTRAGSMARGE ZUM STANDORT-BENCHMARK (%-PKT.)</h2>
                            <p class="text-5xl font-bold text-green-600">29,6 pp</p>
                            <p class="text-sm text-gray-600 mt-2">Ãœberdurchschnittliche Leistung</p>
                        </div>

                        <div class="vit-card p-6 bg-green-50 border border-green-200">
                            <h2 class="h2-headline text-gray-800 mb-4">BENCHMARK IM VERGLEICH ZUR UMSATZKLASSE</h2>
                            <p class="text-5xl font-bold text-green-600">â†‘ 107,7%</p>
                            <p class="text-sm text-gray-600 mt-2">Weit Ã¼ber dem Durchschnitt der Umsatzklasse</p>
                        </div>
                    </div>

                    <!-- Marketing -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ZU UMSATZ (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">4%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN ANTEIL AN GESAMTKOSTEN (%)</h2>
                            <p class="text-4xl font-bold text-gray-800">8%</p>
                        </div>

                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MARKETINGKOSTEN STANDORT (â‚¬)</h2>
                            <p class="text-4xl font-bold text-vit-orange">2.039,00 â‚¬</p>
                        </div>
                    </div>
                </div>
                <div id="teamView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">TEAM</h1>
                    
                    <!-- Team Ãœbersicht -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Mitarbeiter</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">8</p>
                                </div>
                                <div class="bg-blue-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                5 Vollzeit, 3 Teilzeit
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Ã˜ Zufriedenheit</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">4.6/5</p>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Letzte Team-Umfrage
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Krankheitstage</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">12</p>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Dieses Quartal
                            </div>
                        </div>

                        <div class="vit-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Schulungen</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-2">23</p>
                                </div>
                                <div class="bg-vit-orange bg-opacity-10 p-3 rounded-full">
                                    <svg class="w-8 h-8 text-vit-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-gray-500">
                                Abgeschlossen 2026
                            </div>
                        </div>
                    </div>

                    <!-- Mitarbeiter Liste -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">MITARBEITER</h2>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Thomas+Schmidt&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Thomas Schmidt</h3>
                                            <p class="text-sm text-gray-500">Verkaufsleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">32 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Sarah+Mueller&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Sarah MÃ¼ller</h3>
                                            <p class="text-sm text-gray-500">Verkauf & Beratung</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">28 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Michael+Weber&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Michael Weber</h3>
                                            <p class="text-sm text-gray-500">Werkstattleiter</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">98% Auslastung</p>
                                        <p class="text-xs text-gray-500">Werkstatt</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Lisa+Klein&background=626062&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Lisa Klein</h3>
                                            <p class="text-sm text-gray-500">Zweiradmechatronikerin</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-green-600">142 AuftrÃ¤ge</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        <img src="https://ui-avatars.com/api/?name=Jan+Hoffmann&background=EF7D00&color=fff" class="w-12 h-12 rounded-full">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">Jan Hoffmann</h3>
                                            <p class="text-sm text-gray-500">Verkauf (Teilzeit)</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold text-vit-orange">15 VerkÃ¤ufe</p>
                                        <p class="text-xs text-gray-500">Diesen Monat</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schichtplan -->
                        <div class="vit-card p-6">
                            <h2 class="h2-headline text-gray-800 mb-4">SCHICHTPLAN DIESE WOCHE</h2>
                            <div class="space-y-2">
                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Montag, 10.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Dienstag, 11.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Mittwoch, 12.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Donnerstag, 13.02.</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange bg-opacity-10 text-vit-orange px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="border-b pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-vit-orange">Freitag, 14.02. (Heute)</span>
                                        <span class="text-xs text-gray-500">5 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-vit-orange text-white px-2 py-1 rounded">Thomas (9-18h)</span>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-18h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (8-17h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (8-17h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (14-20h)</span>
                                    </div>
                                </div>

                                <div class="pb-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Samstag, 15.02.</span>
                                        <span class="text-xs text-gray-500">4 Mitarbeiter</span>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Sarah (9-16h)</span>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Michael (9-16h)</span>
                                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Lisa (9-16h)</span>
                                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Jan (9-16h)</span>
                                    </div>
                                </div>
                            </div>

                            <button class="mt-4 w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90 text-sm">
                                Schichtplan bearbeiten
                            </button>
                        </div>
                    </div>

                    <!-- Anstehende Schulungen -->
                    <div class="vit-card p-6">
                        <h2 class="h2-headline text-gray-800 mb-4">ANSTEHENDE SCHULUNGEN</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-vit-orange bg-opacity-5 border border-vit-orange rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">E-Bike Antriebstechnik 2026</h4>
                                <p class="text-sm text-gray-600 mb-3">Bosch & Shimano Updates</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 22.02.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 3 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Verkaufstraining Premium</h4>
                                <p class="text-sm text-gray-600 mb-3">Hochpreisige RÃ¤der verkaufen</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 05.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ 4 Teilnehmer</span>
                                </div>
                            </div>

                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-2">Kundenservice Excellence</h4>
                                <p class="text-sm text-gray-600 mb-3">Kundenzufriedenheit steigern</p>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">ðŸ“… 12.03.2026</span>
                                    <span class="text-gray-500">ðŸ‘¥ Alle</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="partnersView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">STANDORTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Partner-Ãœbersicht wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="analyticsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">ANALYTICS</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Analytics-Dashboard wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="documentsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">DOKUMENTE</h1>
                    <div class="vit-card p-6">
                        <p class="text-gray-600">Dokumentenverwaltung wird hier angezeigt...</p>
                    </div>
                </div>

                <div id="knowledgeView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">INFOS (WISSEN)</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Produkt-HandbÃ¼cher</h3>
                            <p class="text-sm text-gray-600 mb-4">Technische Dokumentation aller E-Bike Hersteller</p>
                            <span class="text-xs text-gray-500">142 Dokumente</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-blue-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Schulungsvideos</h3>
                            <p class="text-sm text-gray-600 mb-4">Video-Tutorials zu Verkauf, Service und Technik</p>
                            <span class="text-xs text-gray-500">67 Videos</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-green-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-green-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">FAQ</h3>
                            <p class="text-sm text-gray-600 mb-4">HÃ¤ufig gestellte Fragen zu allen Themen</p>
                            <span class="text-xs text-gray-500">89 EintrÃ¤ge</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-purple-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-purple-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Werkstatt-Guides</h3>
                            <p class="text-sm text-gray-600 mb-4">Reparatur-Anleitungen und Wartungs-Tipps</p>
                            <span class="text-xs text-gray-500">54 Guides</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer premium-feature">
                            <div class="bg-vit-orange bg-opacity-10 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-vit-orange mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">vit:bikes Akademie</h3>
                            <p class="text-sm text-gray-600 mb-4">Exklusive Schulungen fÃ¼r Partner</p>
                            <span class="premium-badge text-[8px] px-2 py-1">PREMIUM</span>
                        </div>

                        <div class="vit-card p-6 hover:shadow-lg cursor-pointer">
                            <div class="bg-yellow-100 p-4 rounded-lg mb-4">
                                <svg class="w-12 h-12 text-yellow-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-gray-800 mb-2">Vorlagen & Checklisten</h3>
                            <p class="text-sm text-gray-600 mb-4">Beratungs-Checklisten, VerkaufsleitfÃ¤den</p>
                            <span class="text-xs text-gray-500">28 Vorlagen</span>
                        </div>
                    </div>
                </div>

                <!-- ===== WISSEN (Zentrale Wissensdatenbank) ===== -->
                <div id="wissenView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ“š WISSENSDATENBANK</h1>
                            <p class="text-sm text-gray-500">Alle Schulungen, Handbuecher, Best Practices und FAQs an einem Ort.</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="wissenSearch" placeholder="Suchen..." oninput="filterWissenGlobal()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm w-48">
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="wissenKpis"></div>

                    <!-- Bereich-Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterWissenBereich('all')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-wbf="all">ðŸ“š Alle Bereiche</button>
                        <button onclick="filterWissenBereich('allgemein')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="allgemein">ðŸ¢ Allgemein</button>
                        <button onclick="filterWissenBereich('verkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="verkauf">ðŸ’° Verkauf</button>
                        <button onclick="filterWissenBereich('einkauf')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="einkauf">ðŸ›’ Einkauf</button>
                        <button onclick="filterWissenBereich('marketing')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="marketing">ðŸ“£ Marketing</button>
                        <button onclick="filterWissenBereich('controlling')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="controlling">ðŸ“Š Controlling</button>
                        <button onclick="filterWissenBereich('werkstatt')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="werkstatt">ðŸ”§ Werkstatt</button>
                        <button onclick="filterWissenBereich('portal')" class="wissen-bereich-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-wbf="portal">ðŸ“± Portal</button>
                    </div>

                    <!-- Typ-Tabs -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button onclick="switchWissenTyp('akademie')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-wtt="akademie">ðŸŽ“ Akademie</button>
                            <button onclick="switchWissenTyp('portal')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="portal">ðŸ“± Portal-Guide</button>
                            <button onclick="switchWissenTyp('kurse')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="kurse">ðŸŽ¬ Kurse & Videos</button>
                            <button onclick="switchWissenTyp('handbuecher')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="handbuecher">ðŸ“– HandbÃ¼cher</button>
                            <button onclick="switchWissenTyp('bestpractices')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="bestpractices">ðŸ’¡ Best Practices</button>
                            <button onclick="switchWissenTyp('faq')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="faq">â“ FAQ</button>
                            <button onclick="switchWissenTyp('onboarding')" class="wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-wtt="onboarding">ðŸš€ Onboarding</button>

                        </nav>
                    </div>

                    <!-- Content -->
                    <div id="wissenGlobalContent" class="space-y-3"></div>
                </div>

                <!-- ===== WERBEMITTEL-SHOP ===== -->
                <div id="shopView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="h1-headline text-gray-800">ðŸ›ï¸ SHOP</h1>
                            <p class="text-sm text-gray-500">Bestelle Textilien, Drucksachen und mehr fÃ¼r deinen Standort.</p>
                        </div>
                        <button onclick="document.getElementById('shopCart').classList.toggle('hidden')" class="relative bg-vit-orange text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90">
                            ðŸ›’ Warenkorb <span id="shopCartCount" class="ml-1 bg-white text-vit-orange rounded-full px-1.5 text-xs font-bold">0</span>
                        </button>
                    </div>

                    <!-- Shop Tabs -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showShopTab('products')" class="shop-main-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="products">ðŸ›ï¸ Sortiment</button>
                        <button onclick="showShopTab('orders')" class="shop-main-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="orders">ðŸ“¦ Meine Bestellungen</button>
                    </div>

                    <!-- Tab: Products -->
                    <div id="shopTabProducts" class="shop-main-tabcontent">
                    <!-- Cart Overlay -->
                    <div id="shopCart" class="hidden mb-6 vit-card p-5 border-2 border-vit-orange">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ›’ Dein Warenkorb</h3>
                        <div id="shopCartItems" class="space-y-2 mb-4"></div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                            <span class="font-bold text-gray-800">Gesamt: <span id="shopCartTotal">0,00</span> â‚¬</span>
                            <button onclick="submitShopOrder()" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">Bestellen</button>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterShop('all')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-sf="all">Alle</button>
                        <button onclick="filterShop('print')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="print">ðŸ–¨ï¸ Drucksachen</button>
                        <button onclick="filterShop('textil')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="textil">ðŸ‘• Textilien</button>
                        <button onclick="filterShop('display')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="display">ðŸª Displays</button>
                        <button onclick="filterShop('digital')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="digital">ðŸ’» Digital</button>
                        <button onclick="filterShop('give')" class="shop-filter-btn text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-sf="give">ðŸŽ Giveaways</button>
                    </div>

                    <!-- Product Grid -->
                    <div id="shopGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
                    </div><!-- end shopTabProducts -->

                    <!-- Tab: Meine Bestellungen -->
                    <div id="shopTabOrders" class="shop-main-tabcontent" style="display:none">
                        <div id="myShopOrders" class="space-y-3"></div>
                    </div>

                    <!-- Order Confirmation Modal -->
                    <div id="shopOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                            <div id="shopOrderModalContent">
                                <div class="text-center">
                                    <div class="text-5xl mb-4">âœ…</div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">Bestellung eingegangen!</h3>
                                    <p class="text-sm text-gray-500 mb-2">Deine Bestellung wird bearbeitet und an deinen Standort geliefert.</p>
                                </div>
                            </div>
                            <div class="text-center mt-4">
                                <button onclick="document.getElementById('shopOrderModal').classList.add('hidden')" class="bg-vit-orange text-white px-6 py-2 rounded-lg text-sm font-semibold hover:opacity-90">OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• EXTERN HOME VIEW (BikeEngine Dashboard) â•â•â• -->
                <div id="externHomeView" class="view" style="display: none;">
                    <div class="mb-6">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="text-3xl">âš¡</span>
                            <div>
                                <h1 class="h1-headline text-gray-800" style="font-size:22px">BIKEENGINE DASHBOARD</h1>
                                <p class="text-sm text-gray-500">Dein Einstieg in die vit:bikes Welt</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stage Banner -->
                    <div id="externStageBanner" class="vit-card p-5 mb-6" style="background: linear-gradient(135deg, #1a1a1a, #2a2a2a); color: white;">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style="background: rgba(239,125,0,0.2);">ðŸš€</div>
                                <div>
                                    <p class="text-xs text-gray-400 uppercase tracking-wider">Aktueller Status</p>
                                    <p class="text-lg font-bold text-vit-orange" id="externStageLabel">Phase 0 â€“ Kostenloser Akademiezugang</p>
                                    <p class="text-xs text-gray-400 mt-1" id="externStageDesc">Einstieg ohne Verpflichtung â€“ lerne vit:bikes kennen</p>
                                </div>
                            </div>
                            <div id="externStageAction">
                                <button onclick="showView('onboarding')" class="px-5 py-2.5 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 transition">
                                    NÃ¤chster Schritt â†’
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <button onclick="showView('onboarding')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                            <p class="text-2xl mb-1">ðŸ—ºï¸</p>
                            <p class="text-xs font-semibold text-gray-700">Dein Weg</p>
                            <p class="text-[10px] text-gray-400">Roadmap & Status</p>
                        </button>
                        <button onclick="showView('wissen')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                            <p class="text-2xl mb-1">ðŸ“š</p>
                            <p class="text-xs font-semibold text-gray-700">Akademie</p>
                            <p class="text-[10px] text-gray-400">Lerninhalte & Kurse</p>
                        </button>
                        <button onclick="showView('kommunikation')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                            <p class="text-2xl mb-1">ðŸ’¬</p>
                            <p class="text-xs font-semibold text-gray-700">Community</p>
                            <p class="text-[10px] text-gray-400">Forum (nur lesen)</p>
                        </button>
                        <button onclick="showView('support')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center">
                            <p class="text-2xl mb-1">ðŸ†˜</p>
                            <p class="text-xs font-semibold text-gray-700">Support</p>
                            <p class="text-[10px] text-gray-400">Fragen & Hilfe</p>
                        </button>
                    </div>

                    <!-- Phase Roadmap Visual -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="h2-headline text-gray-800 mb-6">Dein Weg zum vit:bikes Partner</h2>
                        <div class="flex items-center justify-between mb-4 mt-8" id="externRoadmap">
                            <!-- Will be rendered dynamically -->
                        </div>
                    </div>

                    <!-- What's included -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6 vit-card-watermark">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                                <span class="text-xl">ðŸŽ“</span><span>Dein Zugang umfasst</span>
                            </h3>
                            <div class="space-y-3" id="externIncluded">
                                <!-- Rendered dynamically based on stage -->
                            </div>
                        </div>
                        <div class="vit-card p-6 vit-card-watermark">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                                <span class="text-xl">ðŸ“°</span><span>Neuigkeiten aus dem Netzwerk</span>
                            </h3>
                            <div class="space-y-3">
                                <div class="p-3 bg-orange-50 rounded-lg border-l-3 border-vit-orange">
                                    <p class="text-xs font-semibold text-gray-800">Neues Trainingsmodul verfÃ¼gbar</p>
                                    <p class="text-[10px] text-gray-500 mt-1">Verkaufsstrategie 2025 â€“ jetzt in der Akademie</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs font-semibold text-gray-800">Community Update</p>
                                    <p class="text-[10px] text-gray-500 mt-1">3 neue BeitrÃ¤ge im Partnerforum diese Woche</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs font-semibold text-gray-800">vit:bikes wÃ¤chst</p>
                                    <p class="text-[10px] text-gray-500 mt-1">2 neue Partner im Februar begrÃ¼ÃŸt ðŸŽ‰</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• ONBOARDING VIEW (Stage-aware, all levels) â•â•â• -->
                <div id="onboardingView" class="view" style="display: none;">
                    <div id="onboardingContent">
                        <!-- Wird dynamisch durch renderOnboardingView() befÃ¼llt -->
                    </div>
                </div>

                <!-- MITARBEITER VIEW (Partner/GF) -->
                <div id="mitarbeiterView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ‘¥ MITARBEITER</h1>
                    <p class="text-sm text-gray-500 mb-6">Mitarbeiter verwalten, Tools zuweisen und AbrechnungsÃ¼bersicht.</p>

                    <!-- Tabs -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showMaTab('liste')" class="ma-tab-btn py-3 px-4 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-matab="liste">ðŸ‘¥ Mitarbeiter</button>
                        <button onclick="showMaTab('tools')" class="ma-tab-btn py-3 px-4 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-matab="tools">ðŸ”§ Tools &amp; Lizenzen</button>
                        <button onclick="showMaTab('kosten')" class="ma-tab-btn py-3 px-4 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-matab="kosten">ðŸ’° KostenÃ¼bersicht</button>
                    </div>

                    <!-- TAB 1: Mitarbeiter Liste -->
                    <div id="maTabListe">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-gray-800" id="pMaGesamt">0</div><div class="text-xs text-gray-500">Mitarbeiter</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="pMaAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600" id="pMaTools">0</div><div class="text-xs text-gray-500">Aktive Lizenzen</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="pMaMonatl">0 â‚¬</div><div class="text-xs text-gray-500">Toolkosten/Monat</div></div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterPartnerMa('all')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-pmf="all">Alle</button>
                                <button onclick="filterPartnerMa('aktiv')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterPartnerMa('gekÃ¼ndigt')" class="p-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-pmf="gekÃ¼ndigt">ðŸ”´ GekÃ¼ndigt</button>
                            </div>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                        </div>
                        <div id="maCardList" class="space-y-3"></div>
                    </div>

                    <!-- TAB 2: Tools Matrix -->
                    <div id="maTabTools" style="display:none;">
                        <div class="vit-card overflow-hidden">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-700">Tool-Zuordnung pro Mitarbeiter</h3>
                                <span class="text-xs text-gray-400">âœ… = aktiv Â· â³ = gekÃ¼ndigt (Frist lÃ¤uft) Â· âž– = inaktiv</span>
                            </div>
                            <div class="overflow-x-auto" id="maToolsMatrix"></div>
                        </div>
                    </div>

                    <!-- TAB 3: KostenÃ¼bersicht -->
                    <div id="maTabKosten" style="display:none;">
                        <div id="maKostenContent"></div>
                    </div>
                </div>

                <div id="notificationsView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">BENACHRICHTIGUNGEN</h1>

                    <!-- Filter -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterNotif('all')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-nf="all">Alle</button>
                        <button onclick="filterNotif('unread')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="unread">Ungelesen</button>
                        <button onclick="filterNotif('system')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="system">System</button>
                        <button onclick="filterNotif('hq')" class="notif-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-nf="hq">HQ</button>
                        <button class="ml-auto text-xs text-vit-orange font-semibold hover:underline" onclick="document.querySelectorAll('.notif-dot').forEach(function(d){d.remove();}); document.querySelector('.absolute.-top-1.-right-1').textContent='0';">Alle als gelesen markieren</button>
                    </div>

                    <div id="notifList" class="space-y-2"></div>
                </div>

                <!-- ===== KALENDER VIEW ===== -->
                <div id="kalenderView" class="view" style="display: none;">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5 gap-3">
                        <h1 class="h1-headline text-gray-800">KALENDER</h1>
                        <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                            <select id="kalFilterUser" onchange="kalRenderActive()" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <option value="all">Alle Termine (Standort)</option>
                                <option value="me">Nur meine Termine</option>
                            </select>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90 whitespace-nowrap" onclick="openKalDayModal(new Date().toISOString().slice(0,10))">+ Neuer Termin</button>
                        </div>
                    </div>

                    <!-- View Toggle + Navigation -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-1">
                            <button onclick="kalNav(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <button onclick="kalGoToday()" class="px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-200 hover:bg-gray-50 text-gray-700">Heute</button>
                            <button onclick="kalNav(1)" class="p-2 hover:bg-gray-100 rounded-lg"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                            <h2 class="text-lg font-bold text-gray-800 ml-2" id="kalNavTitle">Februar 2026</h2>
                        </div>
                        <div class="flex bg-gray-100 rounded-lg p-0.5">
                            <button onclick="switchKalView('month')" id="kalViewBtnMonth" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md bg-white text-gray-800 shadow-sm">Monat</button>
                            <button onclick="switchKalView('week')" id="kalViewBtnWeek" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500">Woche</button>
                            <button onclick="switchKalView('day')" id="kalViewBtnDay" class="kal-view-btn px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500">Tag</button>
                        </div>
                    </div>

                    <!-- ===== MONTH VIEW ===== -->
                    <div id="kalMonthContainer">
                        <div class="vit-card overflow-hidden">
                            <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Mo</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Di</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Mi</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Do</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500">Fr</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">Sa</div>
                                <div class="py-2 text-center text-xs font-semibold text-gray-500 text-orange-400">So</div>
                            </div>
                            <div id="kalGrid" class="grid grid-cols-7"></div>
                        </div>
                        <h3 class="font-bold text-gray-800 mt-6 mb-3">Anstehende Termine</h3>
                        <div id="kalUpcoming" class="space-y-2"></div>
                    </div>

                    <!-- ===== WEEK VIEW ===== -->
                    <div id="kalWeekContainer" style="display:none;">
                        <!-- GanztÃ¤gig row -->
                        <div id="kalWeekAllDay" class="vit-card mb-2 p-0 overflow-hidden" style="display:none;">
                            <div class="grid grid-cols-8 text-xs">
                                <div class="p-2 bg-gray-50 border-r border-b border-gray-200 text-gray-400 font-semibold text-center">GanztÃ¤gig</div>
                                <div id="kalWeekAllDay0" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay1" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay2" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay3" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay4" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay5" class="p-1.5 border-r border-b border-gray-100 min-h-[32px]"></div>
                                <div id="kalWeekAllDay6" class="p-1.5 border-b border-gray-100 min-h-[32px]"></div>
                            </div>
                        </div>
                        <!-- Week time grid -->
                        <div class="vit-card overflow-hidden">
                            <!-- Day headers -->
                            <div class="grid grid-cols-8 bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
                                <div class="py-2 text-center text-[10px] font-semibold text-gray-400">Uhrzeit</div>
                                <div id="kalWeekHead0" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead1" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead2" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead3" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead4" class="py-2 text-center text-xs font-semibold text-gray-600"></div>
                                <div id="kalWeekHead5" class="py-2 text-center text-xs font-semibold text-gray-600 text-orange-400"></div>
                                <div id="kalWeekHead6" class="py-2 text-center text-xs font-semibold text-gray-600 text-orange-400"></div>
                            </div>
                            <!-- Scrollable time grid -->
                            <div id="kalWeekGrid" class="overflow-y-auto" style="max-height:calc(100vh - 320px); min-height:500px;"></div>
                        </div>
                    </div>

                    <!-- ===== DAY VIEW ===== -->
                    <div id="kalDayContainer" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Day timeline (left 2/3) -->
                            <div class="lg:col-span-2">
                                <!-- GanztÃ¤gig -->
                                <div id="kalDayAllDay" class="vit-card mb-3 p-3" style="display:none;">
                                    <p class="text-[10px] text-gray-400 font-semibold uppercase mb-1">GanztÃ¤gig</p>
                                    <div id="kalDayAllDayList" class="space-y-1"></div>
                                </div>
                                <!-- Hour grid -->
                                <div class="vit-card overflow-hidden">
                                    <div id="kalDayGrid" class="overflow-y-auto" style="max-height:calc(100vh - 320px); min-height:500px;"></div>
                                </div>
                            </div>
                            <!-- Day sidebar (right 1/3) -->
                            <div>
                                <div class="vit-card p-5 mb-4">
                                    <h3 class="font-semibold text-gray-800 mb-3" id="kalDaySideTitle">Termine am Tag</h3>
                                    <div id="kalDaySideList" class="space-y-2"></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h3 class="font-semibold text-gray-800 mb-3">Zusammenfassung</h3>
                                    <div id="kalDayStats" class="space-y-2 text-sm text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Termin Modal (New + Edit) -->
                    <div id="kalNewModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
                            <h3 id="kalModalTitle" class="font-bold text-gray-800 text-lg mb-4">Neuen Termin anlegen</h3>
                            <div class="space-y-3">
                                <input type="text" id="kalNewTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="date" id="kalNewDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="kalNewGanztaegig" onchange="document.getElementById('kalTimeFields').style.display=this.checked?'none':''">
                                        <label for="kalNewGanztaegig" class="text-xs text-gray-600">GanztÃ¤gig</label>
                                    </div>
                                </div>
                                <div id="kalTimeFields" class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] text-gray-500">Von</label><input type="time" id="kalNewTime" value="09:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <div><label class="text-[10px] text-gray-500">Bis</label><input type="time" id="kalNewEndTime" value="10:00" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                </div>
                                <input type="text" id="kalNewOrt" placeholder="Ort (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                <select id="kalNewType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <option value="beratung">Beratung</option>
                                    <option value="probefahrt">Probefahrt</option>
                                    <option value="werkstatt">Werkstatt-Abholung</option>
                                    <option value="meeting">Team-Meeting</option>
                                    <option value="schulung">Schulung</option>
                                    <option value="event">Event</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="sonstig">Sonstiges</option>
                                </select>
                                <!-- Wiederholung -->
                                <div>
                                    <label class="text-[10px] text-gray-500 font-semibold">Wiederholung</label>
                                    <select id="kalNewRepeat" onchange="kalToggleRepeatEnd()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="">Keine Wiederholung</option>
                                        <option value="taeglich">TÃ¤glich</option>
                                        <option value="woechentlich">WÃ¶chentlich</option>
                                        <option value="2wochen">Alle 2 Wochen</option>
                                        <option value="monatlich">Monatlich</option>
                                    </select>
                                    <div id="kalRepeatEndRow" class="mt-2 flex items-center space-x-2" style="display:none;">
                                        <label class="text-[10px] text-gray-500 whitespace-nowrap">Bis</label>
                                        <input type="date" id="kalNewRepeatEnd" onchange="kalUpdateRepeatInfo()" class="flex-1 px-3 py-1.5 border border-gray-200 rounded-lg text-sm">
                                        <span class="text-[10px] text-gray-400" id="kalRepeatInfo"></span>
                                    </div>
                                </div>
                                <!-- Teilnehmer -->
                                <div>
                                    <label class="text-[10px] text-gray-500 font-semibold">Teilnehmer</label>
                                    <div id="kalTeilnehmerList" class="flex flex-wrap gap-1 mb-1.5"></div>
                                    <select id="kalNewTeilnehmer" onchange="kalAddTeilnehmer()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="">+ Teilnehmer hinzufÃ¼gen...</option>
                                    </select>
                                </div>
                                <textarea id="kalNewNotes" placeholder="Notizen (optional)" rows="2" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button id="kalSaveBtn" onclick="saveKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                <button onclick="document.getElementById('kalNewModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                <button id="kalDeleteBtn" onclick="deleteKalTermin()" style="display:none" class="py-2 px-4 bg-red-50 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-100 border border-red-200">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== TODO VIEW ===== -->
                <div id="todoView" class="view" style="display: none;">
                    <div class="flex flex-col h-[calc(100vh-100px)] min-h-[600px] overflow-hidden">

                        <!-- Main Content (no sidebar) -->
                        <div class="flex-1 flex flex-col min-w-0">
                            <!-- Header -->
                            <div class="flex-shrink-0 border-b border-gray-200 bg-white px-5 py-3">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h1 class="font-bold text-gray-900 text-lg" id="todoHeaderTitle">Alle Aufgaben</h1>
                                        <p class="text-gray-400 text-[11px]" id="todoHeaderSub">0 offen Â· 0 heute Â· 0 Ã¼berfÃ¤llig</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="relative">
                                            <svg class="w-3.5 h-3.5 absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                            <input type="text" id="todoSearchInput" placeholder="Suchen..." class="pl-7 pr-3 py-1 border border-gray-200 rounded-lg bg-gray-50 text-xs focus:outline-none focus:border-vit-orange" style="width:160px" oninput="todoSearchChanged()">
                                        </div>
                                        <div class="flex bg-gray-100 rounded-lg p-0.5">
                                            <button onclick="todoSetView('list')" id="todoViewListBtn" class="px-2 py-1 rounded-md text-[11px] bg-white text-gray-900 shadow-sm">â˜° Liste</button>
                                            <button onclick="todoSetView('board')" id="todoViewBoardBtn" class="px-2 py-1 rounded-md text-[11px] text-gray-500 hover:text-gray-700">â–¦ Board</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI Bar -->
                            <div class="flex-shrink-0 px-5 py-2 bg-white border-b border-gray-100">
                                <div class="flex space-x-2">
                                    <button onclick="todoSetFilter('all')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="all">
                                        <span class="font-bold text-xl text-gray-800" id="kpiOpen2">0</span><span class="text-gray-500 text-[11px]">Offen</span>
                                    </button>
                                    <button onclick="todoSetFilter('heute')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="heute">
                                        <span class="font-bold text-xl text-vit-orange" id="kpiToday2">0</span><span class="text-gray-500 text-[11px]">Heute</span>
                                    </button>
                                    <button onclick="todoSetFilter('ueberfaellig')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="ueberfaellig">
                                        <span class="font-bold text-xl text-red-500" id="kpiOverdue2">0</span><span class="text-gray-500 text-[11px]">ÃœberfÃ¤llig</span>
                                    </button>
                                    <button onclick="todoSetFilter('done')" class="todo-kpi flex-1 flex items-center space-x-2 px-3 py-2 rounded-xl" data-kpi="done">
                                        <span class="font-bold text-xl text-green-600" id="kpiDone2">0</span><span class="text-gray-500 text-[11px]">Erledigt</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Content: List or Board + Detail Panel -->
                            <div class="flex-1 flex overflow-hidden">
                                <div class="flex-1 overflow-y-auto px-5 py-3" id="todoMainContent">
                                    <!-- Quick Add -->
                                    <div id="todoQuickAddArea" class="mb-3"></div>
                                    <!-- Tasks -->
                                    <div id="todoListArea"></div>
                                </div>
                                <!-- Detail Panel (hidden by default) -->
                                <div id="todoDetailPanel" class="hidden flex-shrink-0 border-l border-gray-200 bg-white flex flex-col overflow-hidden" style="width:360px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== ALLGEMEIN VIEW ===== -->
                <div id="allgemeinView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                
                        <div class="mb-6">
                            <p class="h2-headline text-vit-gray mb-1">MEIN STANDORT</p>
                            <h1 class="h1-headline">Allgemein</h1>
                        </div>
                
                        <!-- Tab Navigation -->
                        <div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1 overflow-x-auto" id="allgemeinTabs">
                            <button onclick="showAllgemeinTab('uebersicht')" id="allgemeinTab-uebersicht" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition bg-white text-vit-orange shadow-sm">Ãœbersicht</button>
                            <button onclick="showAllgemeinTab('jahresziele')" id="allgemeinTab-jahresziele" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸŽ¯ Jahresziele</button>
                            <button onclick="showAllgemeinTab('monatsplan')" id="allgemeinTab-monatsplan" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸ“… Monatsplan</button>
                            <button onclick="showAllgemeinTab('journal')" id="allgemeinTab-journal" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">ðŸ“ Partner-Journal</button>
                            <button onclick="showAllgemeinTab('strategie')" id="allgemeinTab-strategie" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">Strategie</button>
                            <button onclick="showAllgemeinTab('wissen')" id="allgemeinTab-wissen" class="px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap transition text-gray-500 hover:text-gray-700">Wissen</button>
                        </div>
                
                        <!-- TAB: Ãœbersicht -->
                        <div id="allgemeinTabContent-uebersicht">
                            <!-- Stimmung -->
                            <div class="vit-card p-5 mb-6">
                                <div class="flex items-center justify-between">
                                    <div><h3 class="font-bold text-gray-800 mb-1">Wie lÃ¤uft der Monat?</h3><p class="text-sm text-gray-500">Setze dein Stimmungsbild</p></div>
                                    <div class="flex space-x-2" id="stimmungSelector">
                                        <button onclick="setStimmung('positiv')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="positiv">ðŸ˜Š</button>
                                        <button onclick="setStimmung('neutral')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="neutral">ðŸ˜</button>
                                        <button onclick="setStimmung('besorgt')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="besorgt">ðŸ˜Ÿ</button>
                                        <button onclick="setStimmung('kritisch')" class="stimmung-btn text-3xl hover:scale-125 transition-transform cursor-pointer opacity-40" data-stimmung="kritisch">ðŸ˜¤</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Dashboard -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                                <div class="vit-card p-5 md:col-span-2 lg:col-span-2 border-l-4 border-vit-orange">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ“… Aktueller Monatsfokus</h3><span class="text-xs font-semibold px-2 py-1 rounded-full bg-orange-100 text-vit-orange" id="uebersichtAktuellerMonat"></span></div>
                                    <div id="uebersichtMonatsfokus"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h3 class="font-bold text-gray-800 mb-3">ðŸ“ž NÃ¤chstes HQ-Meeting</h3>
                                    <div id="uebersichtNaechstesMeeting"><p class="text-gray-400 text-sm">Kein Termin</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸŽ¯ Jahresziele</h3><button onclick="showAllgemeinTab('jahresziele')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button></div>
                                    <div id="uebersichtJahresziele"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">âš¡ Offene MaÃŸnahmen</h3><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="uebersichtMassnahmenBadge">0</span></div>
                                    <div id="uebersichtMassnahmen"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                                <div class="vit-card p-5">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ“ Letztes GesprÃ¤ch</h3><button onclick="showAllgemeinTab('journal')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button></div>
                                    <div id="uebersichtLetztesJournal"><p class="text-gray-400 text-sm">Lade...</p></div>
                                </div>
                            </div>
                            <!-- Quick Actions -->
                            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onclick="showAllgemeinTab('jahresziele');setTimeout(openJahreszielModal,100)" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸŽ¯</p><p class="text-xs font-semibold text-gray-700">Neues Ziel</p></button>
                                <button onclick="showAllgemeinTab('monatsplan')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“…</p><p class="text-xs font-semibold text-gray-700">Monatsplan</p></button>
                                <button onclick="showAllgemeinTab('journal');setTimeout(openJournalModal,100)" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“</p><p class="text-xs font-semibold text-gray-700">GesprÃ¤ch protokollieren</p></button>
                                <button onclick="showView('controlling')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">ðŸ“Š</p><p class="text-xs font-semibold text-gray-700">BWA & Controlling</p></button>
                            </div>
                        </div>
                
                        <!-- TAB: Jahresziele -->
                        <div id="allgemeinTabContent-jahresziele" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Jahresziele <span id="jahreszieleJahr"></span></h2><p class="text-sm text-gray-500">SMART-Ziele, Soft Targets und Umsatzziele</p></div>
                                <button onclick="openJahreszielModal()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">+ Neues Ziel</button>
                            </div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-vit-orange"></span><span>Harte Ziele (Umsatz & Ertrag)</span></h3><div id="jahreszieleHart" class="space-y-3"></div></div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span>SMART Ziele</span></h3><div id="jahreszieleSmart" class="space-y-3"></div></div>
                            <div class="mb-6"><h3 class="font-semibold text-gray-700 mb-3 flex items-center space-x-2"><span class="w-2 h-2 rounded-full bg-green-500"></span><span>Soft Targets</span></h3><div id="jahreszieleSoft" class="space-y-2"></div></div>
                        </div>
                
                        <!-- TAB: Monatsplan -->
                        <div id="allgemeinTabContent-monatsplan" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Monatsplan <span id="monatsplanJahr"></span></h2><p class="text-sm text-gray-500">12 Monate â€“ 12 Fokusthemen</p></div>
                            </div>
                            <div id="monatsplanContent" class="space-y-3"></div>
                            <!-- Inline Detail Panel -->
                            <div id="monatsDetailPanel" class="mt-6" style="display:none">
                                <div class="vit-card p-6 border-l-4 border-vit-orange">
                                    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-800" id="monatsDetailTitel"></h3><button onclick="closeMonatsDetail()" class="text-gray-400 hover:text-gray-600 text-lg">âœ•</button></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Fokus-Thema</label><input id="monatsDetailFokus" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Fokus-Thema..."></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Beschreibung</label><textarea id="monatsDetailBeschreibung" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Details..."></textarea></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">MaÃŸnahmen</label><div id="monatsDetailMassnahmen" class="space-y-2 mb-2"></div><button onclick="addMonatsMassnahme()" class="text-sm text-vit-orange hover:text-orange-600 font-semibold">+ MaÃŸnahme</button></div>
                                    <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Zahlt ein auf Jahresziel</label><div id="monatsDetailZiele" class="space-y-1"></div></div>
                                    <div class="mb-4" id="monatsDetailReflexionWrap" style="display:none"><label class="block text-sm font-semibold text-gray-700 mb-1">Monats-Reflexion</label><textarea id="monatsDetailReflexion" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Was lief gut?"></textarea></div>
                                    <div class="flex justify-end space-x-3 mt-4 pt-4 border-t"><button onclick="closeMonatsDetail()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveMonatsDetail()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- TAB: Journal -->
                        <div id="allgemeinTabContent-journal" style="display:none">
                            <div class="flex items-center justify-between mb-5">
                                <div><h2 class="text-lg font-bold text-gray-800">Partner-Journal</h2><p class="text-sm text-gray-500">Protokolle der PartnergesprÃ¤che</p></div>
                                <button onclick="openJournalModal()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">+ Neues GesprÃ¤ch</button>
                            </div>
                            <div id="journalContent" class="space-y-4"></div>
                        </div>
                
                        <!-- TAB: Strategie -->
                        <div id="allgemeinTabContent-strategie" style="display:none">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="vit-card p-5 border-l-4 border-vit-orange"><h3 class="font-bold text-gray-800 mb-2">ðŸ“… Dein Monatsplan</h3><p class="text-sm text-gray-500 mb-3">12 Fokusthemen fÃ¼r dieses Jahr</p><button onclick="showAllgemeinTab('monatsplan')" class="text-sm text-vit-orange font-semibold">Ã–ffnen â†’</button></div>
                                <div class="vit-card p-5 border-l-4 border-blue-500"><h3 class="font-bold text-gray-800 mb-2">ðŸŽ¯ Deine Jahresziele</h3><p class="text-sm text-gray-500 mb-3">SMART-Ziele und Soft Targets</p><button onclick="showAllgemeinTab('jahresziele')" class="text-sm text-blue-600 font-semibold">Ã–ffnen â†’</button></div>
                                <button onclick="showView('marketing')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“¢</p><h3 class="font-bold text-gray-800 mb-1">Marketing-Strategie</h3><p class="text-xs text-gray-500">Kampagnen, Social Media</p></button>
                                <button onclick="showView('einkauf')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ›’</p><h3 class="font-bold text-gray-800 mb-1">Einkaufsstrategie</h3><p class="text-xs text-gray-500">Lieferanten, Konditionen</p></button>
                                <button onclick="showView('controlling')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“Š</p><h3 class="font-bold text-gray-800 mb-1">BWA & Controlling</h3><p class="text-xs text-gray-500">Finanzkennzahlen</p></button>
                                <button onclick="showView('aktenschrank')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“</p><h3 class="font-bold text-gray-800 mb-1">Aktenschrank</h3><p class="text-xs text-gray-500">Dokumente und Vorlagen</p></button>
                            </div>
                        </div>
                
                        <!-- TAB: Wissen -->
                        <div id="allgemeinTabContent-wissen" style="display:none">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="showView('wissen')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ“š</p><h3 class="font-bold text-gray-800 mb-1">Wissensdatenbank</h3><p class="text-xs text-gray-500">Artikel und Schulungen</p></button>
                                <button onclick="showView('onboarding')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸš€</p><h3 class="font-bold text-gray-800 mb-1">Onboarding</h3><p class="text-xs text-gray-500">Checklisten</p></button>
                                <button onclick="showView('support')" class="vit-card p-5 text-left hover:shadow-lg transition"><p class="text-2xl mb-2">ðŸ†˜</p><h3 class="font-bold text-gray-800 mb-1">Support</h3><p class="text-xs text-gray-500">Tickets und Kontakte</p></button>
                            </div>
                        </div>
                
                    </div>
                </div>


                <!-- â•â•â• HQ ONBOARDING MANAGEMENT VIEW â•â•â• -->
                <div id="hqOnboardingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸš€ ONBOARDING â€“ PIPELINE & MANAGEMENT</h1>
                    <p class="text-sm text-gray-500 mb-6">Bewerbungen, Trainingsphasen und ÃœbergÃ¤nge aller Standorte steuern.</p>

                    <!-- Tab Nav -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showHqOnbTab('pipeline')" class="hq-onb-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="pipeline">ðŸ“Š Pipeline</button>
                        <button onclick="showHqOnbTab('bewerbungen')" class="hq-onb-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="bewerbungen">ðŸ“¬ Bewerbungen</button>
                        <button onclick="showHqOnbTab('log')" class="hq-onb-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="log">ðŸ“‹ Aktionslog</button>
                    </div>

                    <!-- Pipeline Tab -->
                    <div id="hqOnbTabPipeline" class="hq-onb-tab-content">
                        <div id="hqOnbPipelineContent">
                            <!-- Rendered by renderHqOnboarding() -->
                        </div>
                    </div>

                    <!-- Bewerbungen Tab -->
                    <div id="hqOnbTabBewerbungen" class="hq-onb-tab-content" style="display:none;">
                        <div id="hqOnbBewerbungenContent">
                            <!-- Rendered by renderHqOnboarding() -->
                        </div>
                    </div>

                    <!-- Aktionslog Tab -->
                    <div id="hqOnbTabLog" class="hq-onb-tab-content" style="display:none;">
                        <div id="hqOnbLogContent">
                            <!-- Rendered by renderHqOnboarding() -->
                        </div>
                    </div>
                </div>

                <div id="devStatusView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">MODULÃœBERSICHT</h1>
                            <p class="text-sm text-gray-500">Entwicklungsstand aller Module â€“ Stand: 17. Februar 2026</p>
                        </div>
                        <div class="flex items-center space-x-2" id="modulStatusSummary"></div>
                    </div>

                    <!-- Dev-Status Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4 -mb-px">
                            <button onclick="showDevTab('modules')" class="dev-tab whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-dtab="modules">ðŸ“¦ Module</button>
                            <button onclick="showDevTab('releases')" class="dev-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-dtab="releases">ðŸš€ Release-Updates</button>
                            <button onclick="showDevTab('nutzung')" class="dev-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-dtab="nutzung" id="devStatusNutzungTab">ðŸ“Š Portal-Nutzung</button>
                        </nav>
                    </div>

                    <div id="devTabModules" class="dev-tab-content">
                    <!-- Filter -->
                    <div class="flex flex-wrap items-center gap-2 mb-6">
                        <button onclick="filterModulStatus('alle')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="alle">Alle</button>
                        <button onclick="filterModulStatus('standort')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="standort">Standort-Module</button>
                        <button onclick="filterModulStatus('hq')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hq">HQ-Module</button>
                        <button onclick="filterModulStatus('widgets')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="widgets">Dashboard-Widgets</button>
                        <span class="border-l border-gray-300 h-5 mx-1"></span>
                        <button onclick="filterModulStatus('kiPrio')" class="ms-filter entw-hq-tab text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="kiPrio" style="display:none">ðŸ¤– PrioritÃ¤t KI</button>
                        <button onclick="filterModulStatus('hqPrio')" class="ms-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="hqPrio">ðŸ¢ Prio HQ</button>
                    </div>
                    <div id="modulStatusContent"></div>
                    </div><!-- /devTabModules -->

                    <div id="devTabReleases" class="dev-tab-content" style="display:none;">
                        <div id="releaseUpdatesContent"></div>
                    </div>

                    <div id="devTabNutzung" class="dev-tab-content" style="display:none;">
                        <div id="devNutzungContent"></div>
                    </div>
                </div>

                <!-- ==================== HQ VIEWS ================================== -->
                <!-- ================================================================= -->

                <!-- ===== HQ NETZWERK-COCKPIT ===== -->
                <!-- â•â•â• OFFICE VIEW (HQ only) â•â•â• -->
                <!-- Office View (HQ only) -->
                <div id="hqOfficeView" class="view" style="display: none;">
                    <div id="officeReactRoot" style="min-height:400px"></div>
                </div>

                <div id="hqCockpitView" class="view" style="display: none;">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="h1-headline text-gray-800">NETZWERK-COCKPIT ðŸ‘‹</h1>
                            <p class="text-sm text-gray-500" id="hqWelcomeDate">Willkommen zurueck</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-gray-400">Stand: 14.02.2026</span>
                            <select id="hqPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqCockpit()">
                                <option value="ytd">YTD 2026</option>
                                <option value="jan">Januar 2026</option>
                                <option value="feb">Februar 2026</option>
                            </select>
                        </div>
                    </div>

                    <!-- Schnellzugriffe HQ -->
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6">
                        <button onclick="showView('hqAktionen')" data-hq-module="hqHandlungsbedarf" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸš¨</p><p class="text-[10px] font-semibold text-gray-700">Handlungsbedarf</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kampagnen')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸŽ¯</p><p class="text-[10px] font-semibold text-gray-700">Kampagnen</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('kommunikation')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“¢</p><p class="text-[10px] font-semibold text-gray-700">Kommunikation</p></button>
                        <button onclick="showView('hqKommando');setTimeout(function(){showKommandoTab('aufgaben')},50)" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“‹</p><p class="text-[10px] font-semibold text-gray-700">Aufgaben</p></button>
                        <button onclick="showView('hqKommando')" data-hq-module="hqKommandozentrale" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">âš™ï¸</p><p class="text-[10px] font-semibold text-gray-700">Kommandozentrale</p></button>
                        <button onclick="showView('hqAuswertung')" class="vit-card p-3 hover:shadow-md transition text-center"><p class="text-xl mb-1">ðŸ“Š</p><p class="text-[10px] font-semibold text-gray-700">Auswertung</p></button>
                    </div>

                    <!-- ðŸ¥ Netzwerk Health Score Dashboard -->
                    <div class="vit-card p-5 mb-6" id="hqHealthDashboard">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-sm font-bold text-gray-800">ðŸ¥ Netzwerk Health Score<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-health')">i</button></h2><div class="widget-info-popup" id="info-hq-health">Aggregierter Health Score aller 21 Standorte. ðŸŸ¢ Gesund (â‰¥75), ðŸŸ¡ Beobachtung (50â€“74), ðŸ”´ Kritisch (&lt;50). Der Netzwerk-Durchschnitt zeigt die Gesamtperformance. Klicke auf einen Standort fÃ¼r Details.</div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-semibold" id="hqHealthGreen">ðŸŸ¢ â€”</span>
                                <span class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 font-semibold" id="hqHealthYellow">ðŸŸ¡ â€”</span>
                                <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-semibold" id="hqHealthRed">ðŸ”´ â€”</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <div style="text-align:center"><p class="text-3xl font-black text-gray-800" id="hqHealthAvg">â€”</p><p class="text-[10px] text-gray-400">Netzwerk Ã˜</p></div>
                            <div style="flex:1"><div class="bg-gray-200 rounded-full h-3"><div id="hqHealthBar" class="h-3 rounded-full transition-all" style="width:0%;background:linear-gradient(90deg,#16a34a,#22c55e)"></div></div></div>
                        </div>
                        <div id="hqHealthGrid" class="grid grid-cols-3 lg:grid-cols-7 gap-2"></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                        <div class="vit-card p-4"><h3 class="text-xs font-bold text-gray-800 mb-2">ðŸŽ“ Aktive Trainer im Netzwerk<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-trainer')">i</button></h3><div class="widget-info-popup" id="info-hq-trainer">Zeigt alle aktuell laufenden Trainer-Sessions im Netzwerk. Status: aktiv = Standort arbeitet daran, gestartet = gerade begonnen, ignoriert = keine Reaktion seit 48h. Max 1 Trainer pro Modul pro Standort.</div><div id="hqTrainerList" class="space-y-1"></div></div>
                        <div class="vit-card p-4"><h3 class="text-xs font-bold text-gray-800 mb-2">ðŸ“ž NÃ¤chste Gruppencalls<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-calls')">i</button></h3><div class="widget-info-popup" id="info-hq-calls">RegelmÃ¤ÃŸige Netzwerk-Calls: 1. Mittwoch = Inhaber, Freitags = VerkÃ¤ufer, 2. Donnerstag = Werkstatt. Vor jedem Call werden automatisch KPI-Snapshots und offene MaÃŸnahmen pro Standort vorbereitet.</div><div id="hqGroupcallList" class="space-y-1"></div></div>
                    </div>


                    <!-- E-Mail-Aktionen (HQ) -->
                    <div class="vit-card p-4 mb-6">
                        <h3 class="text-xs font-bold text-gray-800 mb-2">ðŸ“§ E-Mail-Aktionen<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-email')">i</button></h3>
                        <div class="widget-info-popup" id="info-hq-email">Manuelles AuslÃ¶sen von E-Mail-Triggern. In Produktion laufen diese automatisch Ã¼ber Cron-Jobs und Event-Trigger via Supabase Edge Functions + Resend.</div>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                            <button onclick="checkStaleLeads()" class="p-2 text-xs font-semibold rounded-lg border border-gray-200 hover:border-vit-orange hover:text-vit-orange transition">ðŸ“ˆ Stale Leads prÃ¼fen</button>
                            <button onclick="triggerBwaEscalation('Demo','demo@vitbikes.de','2026-01')" class="p-2 text-xs font-semibold rounded-lg border border-gray-200 hover:border-vit-orange hover:text-vit-orange transition">âš ï¸ BWA-Eskalation testen</button>
                            <button onclick="triggerGroupcallReminder('Inhaber-Call','05.03.2026','10:00','https://zoom.us/j/123',[{email:'demo@vitbikes.de'}])" class="p-2 text-xs font-semibold rounded-lg border border-gray-200 hover:border-vit-orange hover:text-vit-orange transition">ðŸ“ž Call-Reminder testen</button>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2">Demo-Modus: Mails werden geloggt, nicht versendet (Supabase Edge Function + Resend API-Key nÃ¶tig)</p>
                    </div>

                    <!-- Netzwerk KPIs -->
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKpiCards"></div>

                    <!-- Handlungsbedarf Ticker -->
                    <div class="vit-card p-4 mb-6 border-l-4 border-red-500" id="hqAlertBox"></div>

                    <!-- 3-Column Layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- LEFT 2/3: Rankings + Kampagnen + Grid -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Top 5 Standorte<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-top5')">i</button></h2><div class="widget-info-popup" id="info-hq-top5">Die 5 Standorte mit der besten Lead-Performance diesen Monat, gemessen an Anzahl neuer Leads und Abschlussquote.</div>
                                    <div id="hqTop5" class="space-y-2"></div>
                                </div>
                                <div class="vit-card p-5">
                                    <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Bottom 5 â€“ Handlungsbedarf</h2>
                                    <div id="hqBottom5" class="space-y-2"></div>
                                </div>
                            </div>

                            <!-- Kampagnen Kompakt -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸŽ¯ Aktive Kampagnen</h2>
                                    <button onclick="showView('hqKampagnen')" class="text-xs text-vit-orange font-semibold hover:underline">Alle anzeigen â†’</button>
                                </div>
                                <div id="hqHomeKampagnen" class="space-y-2"></div>
                            </div>

                            <!-- Standort-Grid -->
                            <div class="vit-card p-5">
                                <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“Š Alle Standorte â€“ Lead-Performance<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-leads')">i</button></h2><div class="widget-info-popup" id="info-hq-leads">Ranking aller Standorte nach Lead-AktivitÃ¤t: neue Leads, Angebote, AbschlÃ¼sse und Abschlussquote. Standorte mit rotem Trend brauchen ggf. einen Verkaufs-Trainer.</div>
                                <div class="flex items-center space-x-4 mb-3 text-[10px] text-gray-500">
                                    <span>ðŸ”´ &lt; 50%</span><span>ðŸŸ  50-75%</span><span>ðŸŸ¢ 75-100%</span><span>ðŸŸ¡ â‰¥ 100%</span>
                                </div>
                                <div id="hqStandortGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
                            </div>
                        </div>

                        <!-- RIGHT 1/3: Live-Feed -->
                        <div class="space-y-6">
                            <!-- Offene Aufgaben -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“‹ Offene Aufgaben</h2>
                                    <button onclick="showView('hqAufgaben')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAufgaben" class="space-y-2"></div>
                            </div>

                            <!-- Naechste Termine -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“… Naechste Termine</h2>
                                    <button onclick="showView('hqKalender')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeTermine" class="space-y-2"></div>
                            </div>

                            <!-- Letzte Ankuendigungen -->
                            <div class="vit-card p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <h2 class="text-sm font-bold text-gray-800">ðŸ“¢ Letzte Ankuendigungen</h2>
                                    <button onclick="showView('hqKomm')" class="text-xs text-vit-orange font-semibold hover:underline">Alle â†’</button>
                                </div>
                                <div id="hqHomeAnnounce" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ===== HQ STANDORTE ===== -->
                <div id="hqStandorteView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="h1-headline text-gray-800">STANDORTE</h1>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="hqStandortSearch" placeholder="Standort suchen..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" oninput="renderHqStandorte()">
                            <select id="hqStandortFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderHqStandorte()">
                                <option value="all">Alle</option>
                                <option value="kritisch">ðŸ”´ Kritisch (&lt;50%)</option>
                                <option value="achtung">ðŸŸ  Achtung (50-75%)</option>
                                <option value="gut">ðŸŸ¢ Gut (75-100%)</option>
                                <option value="top">ðŸŸ¡ Top (â‰¥100%)</option>
                            </select>
                        </div>
                    </div>
                    <div id="hqStandorteList" class="space-y-3"></div>
                </div>

                <!-- ===== HQ FINANZEN ===== -->
                <div id="hqFinanzenView" class="view" style="display: none;">
                    <!-- BWA Network Status Dashboard (Spec Section 5) -->
                    <div id="hqBwaStatusDashboard" class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="h2-headline text-vit-gray mb-1">NETZWERK</p>
                                <h1 class="h1-headline">BWA-Status Ãœbersicht<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-bwa')">i</button></h1><div class="widget-info-popup" id="info-hq-bwa">Ãœberblick Ã¼ber BWA-Einreichungen aller Standorte. Gold = vor dem 8. eingereicht, OK = bis zum 15., ÃœberfÃ¤llig = nach Deadline. Bei Stufe 3 werden automatisch Eskalationsmails an Inhaber versendet. Sortierung: Gold â†’ OK â†’ Ausstehend â†’ ÃœberfÃ¤llig.</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">Aktueller Monat</p>
                                    <p id="hqBwaMonth" class="text-sm font-bold text-gray-800">â€”</p>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Eingereicht</p><p id="hqBwaSubmitted" class="text-2xl font-bold text-green-600">â€”</p><p class="text-xs text-gray-400">von <span id="hqBwaTotal">â€”</span></p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">ðŸ¥‡ Gold</p><p id="hqBwaGold" class="text-2xl font-bold text-yellow-500">â€”</p><p class="text-xs text-gray-400">vor dem 8.</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">âœ… OK</p><p id="hqBwaOk" class="text-2xl font-bold text-green-600">â€”</p><p class="text-xs text-gray-400">bis zum 15.</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">â³ Ausstehend</p><p id="hqBwaMissing" class="text-2xl font-bold text-gray-400">â€”</p><p class="text-xs text-gray-400">noch Zeit</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">ðŸš¨ ÃœberfÃ¤llig</p><p id="hqBwaOverdue" class="text-2xl font-bold text-red-500">â€”</p><p class="text-xs text-gray-400">Stufe 3</p></div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="vit-card p-4 mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-gray-600">Netzwerk-Fortschritt<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-progress')">i</button></span><div class="widget-info-popup" id="info-hq-progress">Prozentualer Anteil der Standorte, die ihre BWA fÃ¼r den aktuellen Monat eingereicht haben. Ziel: 100% bis zum 15. des Folgemonats.</div>
                                <span id="hqBwaPct" class="text-xs font-bold text-vit-orange">â€”%</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-3"><div id="hqBwaBar" class="h-3 rounded-full transition-all" style="width:0%;background:linear-gradient(90deg,#EF7D00,#F59E0B)"></div></div>
                        </div>

                        <!-- Standort-Tabelle -->
                        <div class="vit-card p-4">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-left text-xs text-gray-400 border-b border-gray-200">
                                        <th class="pb-2 font-semibold">Standort</th>
                                        <th class="pb-2 font-semibold">Status</th>
                                        <th class="pb-2 font-semibold">Rating</th>
                                        <th class="pb-2 font-semibold">Eingereicht</th>
                                        <th class="pb-2 font-semibold">Eskalation</th>
                                        <th class="pb-2 font-semibold">Tage</th>
                                    </tr>
                                </thead>
                                <tbody id="hqBwaTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <h1 class="h1-headline text-gray-800 mb-6">FINANZEN â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqFinKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Umsatz & Rohertrag pro Standort</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="hqFinTable"></table>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ BWA-Auffaelligkeiten</h2>
                            <div id="hqFinAlerts" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“ˆ Rohertrag-Ranking</h2>
                            <div id="hqFinRohertrag" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- ===== HQ MARKETING ===== -->
                <div id="hqMarketingView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">MARKETING â€“ NETZWERK</h1>

                    <!-- HQ Marketing Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto">
                            <button onclick="showHqMktTab('uebersicht')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-hqmkt="uebersicht">ðŸ  Ãœbersicht</button>
                            <button onclick="showHqMktTab('budgetsteuerung')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="budgetsteuerung">ðŸ’° Budget-Steuerung</button>
                            <button onclick="showHqMktTab('leadreport')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="leadreport">ðŸ“Š Lead Reporting</button>
                            <button onclick="showHqMktTab('jahresgespraeche')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="jahresgespraeche">ðŸ“‹ JahresgesprÃ¤che</button>
                            <button onclick="showHqMktTab('handlungsbedarf')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="handlungsbedarf">âš ï¸ Handlungsbedarf</button>
                            <button onclick="showHqMktTab('videoFreigabe')" class="hqmkt-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqmkt="videoFreigabe">ðŸŽ¬ Video-Freigabe <span id="hqVpReviewBadge" class="ml-1 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full" style="display:none">0</span></button>
                        </nav>
                    </div>

                    <!-- HQ MKT TAB 1: Ãœbersicht -->
                    <div id="hqMktTabUebersicht" class="hqmkt-tab-content">
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqMktKpis"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Lead-Performance pro Standort</h2><div id="hqMktLeads" class="space-y-2"></div></div>
                            <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸŽ¯ Strategie-Status</h2><div id="hqMktStrategie" class="space-y-2"></div></div>
                        </div>
                        <div class="vit-card p-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Schnell-Alerts</h2><div id="hqMktAlerts" class="space-y-2"></div></div>
                    </div>

                    <!-- HQ MKT TAB 2: Budget-Steuerung -->
                    <div id="hqMktTabBudgetsteuerung" class="hqmkt-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">ðŸ’°</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Budget-Steuerung</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Die Netzwerk-Budget-Steuerung wird vorbereitet. Hier werden Jahresbudgets, Kanal-Splits und Standort-Budgets verwaltet.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 3: Lead Reporting -->
                    <div id="hqMktTabLeadreport" class="hqmkt-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">ðŸ“Š</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Lead Reporting</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Das Netzwerk-Lead-Reporting wird vorbereitet. Hier werden Lead-Performance, Conversion-Raten und Standort-Vergleiche angezeigt.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 4: JahresgesprÃ¤che -->
                    <div id="hqMktTabJahresgespraeche" class="hqmkt-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">ðŸ¤</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">JahresgesprÃ¤che</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Die JahresgesprÃ¤ch-Ãœbersicht wird vorbereitet. Hier werden Budget-Vereinbarungen und GesprÃ¤chs-Status pro Standort verwaltet.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- HQ MKT TAB 5: Handlungsbedarf -->
                    <div id="hqMktTabHandlungsbedarf" class="hqmkt-tab-content" style="display:none;">
                        <div class="text-center py-16">
                            <div class="text-5xl mb-4">âš ï¸</div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Handlungsbedarf</h3>
                            <p class="text-sm text-gray-500 max-w-md mx-auto">Die Handlungsbedarf-Ãœbersicht wird vorbereitet. Hier werden kritische Punkte und Warnungen aus dem Marketing-Netzwerk konsolidiert.</p>
                            <span class="inline-block mt-4 text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ðŸ”§ In Vorbereitung</span>
                        </div>
                    </div>

                    <!-- HQ MKT TAB: Video-Freigabe -->
                    <div id="hqMktTabVideoFreigabe" class="hqmkt-tab-content" style="display:none;">
                        <div id="hqVpReviewContent"></div>
                    </div>
                </div>

                <!-- ===== HQ EINKAUF ===== -->
                <div id="hqEinkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">EINKAUF â€“ NETZWERK</h1>
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="showHqEkTab('dash')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-hqek="dash">ðŸ“Š Ãœbersicht</button>
                            <button onclick="showHqEkTab('lief')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqek="lief">ðŸ“‹ Lieferanten</button>
                            <button onclick="showHqEkTab('strat')" class="hqek-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-hqek="strat">ðŸŽ¯ Strategien</button>
                        </nav>
                    </div>
                    <div id="hqEkTabDash" class="hqek-tab-content"></div>
                    <div id="hqEkTabLief" class="hqek-tab-content" style="display:none;"></div>
                    <div id="hqEkTabStrat" class="hqek-tab-content" style="display:none;"></div>
                </div>

                <div id="hqVerkaufView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">VERKAUF â€“ NETZWERK</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqVkKpis"></div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Verkaufsleistung pro Standort (KW 7)</h2>
                        <div class="overflow-x-auto"><table class="w-full text-sm" id="hqVkTable"></table></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âš ï¸ Handlungsbedarf Verkauf</h2>
                        <div id="hqVkAlerts" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ HANDLUNGSBEDARF ===== -->
                <div id="hqAktionenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">HANDLUNGSBEDARF â€“ ALLE BEREICHE</h1>
                    <p class="text-sm text-gray-500 mb-6">Konsolidierte Uebersicht aller offenen Punkte, die Aufmerksamkeit der Zentrale erfordern. Sortiert nach Prioritaet.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqAktKpis"></div>
                    <div id="hqAktionenList" class="space-y-3"></div>
                </div>

                <!-- HQ KOMMUNIKATION -->
                <!-- HQ KAMPAGNEN -->
                <!-- HQ DOKUMENTE -->
                <!-- HQ KALENDER -->
                <!-- HQ AUFGABEN -->
                <!-- KOMMANDOZENTRALE -->
                <div id="hqKommandoView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-6">âš™ï¸ KOMMANDOZENTRALE</h1>

                    <!-- Tab Navigation -->
                    <div class="mb-6 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" id="kommandoTabNav">
                            <button onclick="showKommandoTab('standorte')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-ktab="standorte" data-hq-action="edit_standort">ðŸ¢ Standorte</button>
                            <button onclick="showKommandoTab('mitarbeiter')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="mitarbeiter" data-hq-action="edit_user">ðŸ‘¥ Mitarbeiter</button>
                            <button onclick="showKommandoTab('kommunikation')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kommunikation" data-hq-action="send_announcement">ðŸ“¢ Kommunikation</button>
                            <button onclick="showKommandoTab('kampagnen')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kampagnen" data-hq-action="manage_campaigns">ðŸŽ¯ Kampagnen</button>
                            <button onclick="showKommandoTab('dokumente')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="dokumente" data-hq-action="manage_documents">ðŸ“ Dokumente</button>
                            <button onclick="showKommandoTab('kalender')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="kalender">ðŸ“… Kalender</button>
                            <button onclick="showKommandoTab('aufgaben')" class="kommando-tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-semibold text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-ktab="aufgaben">ðŸ“‹ Aufgaben</button>
                        </nav>
                    </div>

                    <!-- STANDORTE TAB -->
                    <div id="kommandoTabStandorte" class="kommando-tab-content">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzStandorteGesamt">21</p><p class="text-xs text-gray-500">Standorte gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzStandorteAktiv">18</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzStandorteOnb">2</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzStandorteOff">1</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRegionen">4</p><p class="text-xs text-gray-500">Regionen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2">
                                <button onclick="filterKzStandorte('all')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzf="all">Alle</button>
                                <button onclick="filterKzStandorte('aktiv')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzStandorte('onboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzStandorte('offboarding')" class="kz-std-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <button id="kzBtnNeuerStandort" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerStandortModal()">+ Neuer Standort</button>
                        </div>

                        <!-- Standorte Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Adresse</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">WaWi</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">MA</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzStandorteBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- MITARBEITER TAB -->
                    <div id="kommandoTabMitarbeiter" class="kommando-tab-content" style="display:none;">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-800" id="kzMaGesamt">67</p><p class="text-xs text-gray-500">Mitarbeiter gesamt</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600" id="kzMaAktiv">61</p><p class="text-xs text-gray-500">Aktiv</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600" id="kzMaOnb">4</p><p class="text-xs text-gray-500">Im Onboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-red-500" id="kzMaOff">2</p><p class="text-xs text-gray-500">Offboarding</p></div>
                            <div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange" id="kzRollen">5</p><p class="text-xs text-gray-500">Rollen</p></div>
                        </div>

                        <!-- Action Bar -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex space-x-2 flex-wrap gap-y-2">
                                <button onclick="filterKzMa('all')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-kzmf="all">Alle</button>
                                <button onclick="filterKzMa('aktiv')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="aktiv">ðŸŸ¢ Aktiv</button>
                                <button onclick="filterKzMa('onboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="onboarding">ðŸ”µ Onboarding</button>
                                <button onclick="filterKzMa('offboarding')" class="kz-ma-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-kzmf="offboarding">ðŸ”´ Offboarding</button>
                            </div>
                            <div class="flex space-x-2">
                                <select id="kzMaStandortFilter" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs" onchange="filterKzMa(currentKzMaFilter)">
                                    <option value="all">Alle Standorte</option>
                                </select>
                                <button id="kzBtnNeuerMa" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openNeuerMaModal()">+ Neuer Mitarbeiter</button>
                            </div>
                        </div>

                        <!-- Mitarbeiter Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Name</th>
                                            <th class="px-4 py-3 text-left font-semibold text-gray-600">Standort</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Rolle</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Status</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Eintritt</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Onboarding</th>
                                            <th class="px-4 py-3 text-center font-semibold text-gray-600">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kzMaBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- KOMMUNIKATION TAB -->
                    <div id="kommandoTabKommunikation" class="kommando-tab-content" style="display:none;">
                        <!-- Sub-tabs -->
                        <div class="border-b border-gray-100 mb-4">
                            <nav class="flex space-x-4">
                                <button onclick="showHqKommTab('announce')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-vit-orange font-semibold text-vit-orange" data-hkt="announce">ðŸ“¢ Ankuendigungen</button>
                                <button onclick="showHqKommTab('rundmail')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="rundmail">âœ‰ï¸ Rundmail</button>
                                <button onclick="showHqKommTab('forum')" class="hqkomm-tab-btn text-xs py-2 px-2 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-hkt="forum">ðŸ’¬ Netzwerk-Forum</button>
                            </nav>
                        </div>
                        <div id="hqKommContent"></div>
                    </div>

                    <!-- KAMPAGNEN TAB -->
                    <div id="kommandoTabKampagnen" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Kampagnen erstellen, steuern und Umsetzung ueber alle Standorte tracken.</p>
                            <button onclick="document.getElementById('hqKampModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Neue Kampagne</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqKampKpis"></div>
                        <div id="hqKampList" class="space-y-4"></div>
                        <!-- Modal -->
                        <div id="hqKampModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Neue Kampagne erstellen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKampName" placeholder="Kampagnen-Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3">
                                        <input type="date" id="hqKampStart" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <input type="date" id="hqKampEnd" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    </div>
                                    <select id="hqKampType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                        <option value="saisonal">Saisonkampagne</option><option value="produkt">Produktkampagne</option><option value="event">Event/Aktionstag</option><option value="social">Social Media Push</option>
                                    </select>
                                    <textarea id="hqKampDesc" rows="2" placeholder="Beschreibung / Ziel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKampagne()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Erstellen</button>
                                    <button onclick="document.getElementById('hqKampModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DOKUMENTE TAB -->
                    <div id="kommandoTabDokumente" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-weite Dokumente: Richtlinien, Vorlagen, Schulungen, Vertraege.</p>
                            <button class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90" onclick="openDokUploadModal()">+ Dokument hochladen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqDokKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqDok('all')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hdf="all">Alle</button>
                            <button onclick="filterHqDok('richtlinie')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="richtlinie">ðŸ“‹ Richtlinien</button>
                            <button onclick="filterHqDok('vorlage')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vorlage">ðŸ“„ Vorlagen</button>
                            <button onclick="filterHqDok('schulung')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqDok('vertrag')" class="hqdok-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hdf="vertrag">ðŸ“‘ Vertraege</button>
                        </div>
                        <div id="hqDokList" class="space-y-2"></div>
                    </div>

                    <!-- KALENDER TAB -->
                    <div id="kommandoTabKalender" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Netzwerk-Termine: Schulungen, Events, Deadlines und Meetings fuer alle Standorte.</p>
                            <button onclick="document.getElementById('hqKalModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Netzwerk-Termin</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="hqKalKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqKal('all')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-hkf="all">Alle</button>
                            <button onclick="filterHqKal('schulung')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="schulung">ðŸŽ“ Schulungen</button>
                            <button onclick="filterHqKal('event')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="event">ðŸŽª Events</button>
                            <button onclick="filterHqKal('deadline')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="deadline">â° Deadlines</button>
                            <button onclick="filterHqKal('meeting')" class="hqkal-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-hkf="meeting">ðŸ¤ Meetings</button>
                        </div>
                        <div id="hqKalList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqKalModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Netzwerk-Termin anlegen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqKalTitle" placeholder="Titel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <div class="grid grid-cols-2 gap-3"><input type="date" id="hqKalDate" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"><input type="time" id="hqKalTime" class="px-3 py-2 border border-gray-200 rounded-lg text-sm"></div>
                                    <select id="hqKalType" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="schulung">ðŸŽ“ Schulung</option><option value="event">ðŸŽª Event</option><option value="deadline">â° Deadline</option><option value="meeting">ðŸ¤ Meeting</option></select>
                                    <select id="hqKalTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte</option><option value="region_sued">Region Sued</option><option value="region_nord">Region Nord</option><option value="region_west">Region West</option><option value="region_ost">Region Ost</option></select>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqKalTermin()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Speichern</button>
                                    <button onclick="document.getElementById('hqKalModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AUFGABEN TAB -->
                    <div id="kommandoTabAufgaben" class="kommando-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">Aufgaben an Standorte verteilen und Umsetzung tracken.</p>
                            <button onclick="document.getElementById('hqTaskModal').classList.remove('hidden')" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">+ Aufgabe verteilen</button>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-4" id="hqTaskKpis"></div>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="filterHqTasks('all')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-htf="all">Alle</button>
                            <button onclick="filterHqTasks('offen')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="offen">ðŸ”´ Offen</button>
                            <button onclick="filterHqTasks('inprogress')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="inprogress">ðŸ”µ In Arbeit</button>
                            <button onclick="filterHqTasks('done')" class="hqtask-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-htf="done">âœ… Erledigt</button>
                        </div>
                        <div id="hqTaskList" class="space-y-2"></div>
                        <!-- Modal -->
                        <div id="hqTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                                <h3 class="font-bold text-lg mb-4">Aufgabe an Standort(e) verteilen</h3>
                                <div class="space-y-3">
                                    <input type="text" id="hqTaskTitle" placeholder="Aufgabentitel" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <input type="date" id="hqTaskDeadline" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                                    <select id="hqTaskPrio" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="hoch">ðŸ”´ Hoch</option><option value="mittel" selected>ðŸŸ¡ Mittel</option><option value="niedrig">ðŸŸ¢ Niedrig</option></select>
                                    <select id="hqTaskTarget" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"><option value="alle">Alle Standorte (21)</option><option value="region_sued">Region Sued (8)</option><option value="region_nord">Region Nord (5)</option><option value="region_west">Region West (5)</option><option value="region_ost">Region Ost (3)</option></select>
                                    <textarea id="hqTaskDesc" rows="2" placeholder="Beschreibung" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"></textarea>
                                </div>
                                <div class="flex space-x-3 mt-4">
                                    <button onclick="addHqTask()" class="flex-1 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">Verteilen</button>
                                    <button onclick="document.getElementById('hqTaskModal').classList.add('hidden')" class="flex-1 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">Abbrechen</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- HQ AUSWERTUNG: Portal-Nutzung -->
                <!-- ===== HQ BILLING / ABRECHNUNG ===== -->
                <div id="hqBillingView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ðŸ’° Abrechnung</h1>
                            <p class="text-sm text-gray-500">Franchise-Abrechnungen, Quartals-Settlements, Jahresstrategien</p>
                        </div>
                        <div class="flex space-x-2">
                            <select id="billingMonthSelect" onchange="loadBillingOverview()" class="text-sm border border-gray-300 rounded-lg px-3 py-2"></select>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4 overflow-x-auto -mb-px">
                            <button onclick="showBillingTab('approval')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500 hover:text-gray-700" data-tab="approval">âœ… Freigabe <span id="approvalBadge" class="hidden ml-1 px-1.5 py-0.5 text-[10px] bg-red-500 text-white rounded-full font-bold">0</span></button>
                            <button onclick="showBillingTab('overview')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="overview">ðŸ“Š Ãœbersicht</button>
                            <button onclick="showBillingTab('invoices')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500 hover:text-gray-700" data-tab="invoices">ðŸ“„ Rechnungen</button>
                            <button onclick="showBillingTab('strategies')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500 hover:text-gray-700" data-tab="strategies">ðŸŽ¯ Strategien</button>
                            <button onclick="showBillingTab('products')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500 hover:text-gray-700" data-tab="products">ðŸ“¦ Produkte</button>
                            <button onclick="showBillingTab('tools')" class="billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500 hover:text-gray-700" data-tab="tools">ðŸ”§ Tools</button>
                        </nav>
                    </div>

                    <!-- Tab: Overview -->
                    <!-- Tab: Freigabe / Approval -->
                    <div id="billingTabApproval" class="billing-tab-content" style="display:none;">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-600" id="appPending">0</div><div class="text-xs text-gray-500">Warten auf PrÃ¼fung</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600" id="appReview">0</div><div class="text-xs text-gray-500">In PrÃ¼fung</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="appApproved">0</div><div class="text-xs text-gray-500">Freigegeben (heute)</div></div>
                            <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-500" id="appRejected">0</div><div class="text-xs text-gray-500">ZurÃ¼ckgewiesen</div></div>
                        </div>

                        <!-- Abrechnungsmodus ErklÃ¤rung -->
                        <div id="approvalModeCard" class="vit-card mb-5 overflow-hidden">
                            <div id="approvalModeHeader" class="p-4 bg-amber-50 border-b-2 border-amber-300">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div id="approvalModeIcon" class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-xl">ðŸ›¡ï¸</div>
                                        <div>
                                            <div class="font-bold text-gray-800" id="approvalModeTitle">Manueller Freigabemodus aktiv</div>
                                            <div class="text-xs text-gray-500" id="approvalModeSubtitle">Jede Rechnung muss einzeln geprÃ¼ft und freigegeben werden</div>
                                        </div>
                                    </div>
                                    <button onclick="toggleApprovalMode()" id="approvalModeBtn" class="px-4 py-2 rounded-lg text-sm font-semibold border-2 border-amber-400 text-amber-700 bg-white hover:bg-amber-50 transition">
                                        Zu Automatik wechseln â†’
                                    </button>
                                </div>
                            </div>
                            <div class="p-4">
                                <div id="approvalModeManualInfo">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">So funktioniert der aktuelle Ablauf:</div>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-center">
                                        <div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                                            <div class="text-lg mb-1">ðŸ“</div>
                                            <div class="text-xs font-bold text-yellow-700">1. Entwurf</div>
                                            <div class="text-[10px] text-gray-500">Rechnungen werden als Entwurf erstellt</div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                                            <div class="text-lg mb-1">ðŸ”</div>
                                            <div class="text-xs font-bold text-blue-700">2. PrÃ¼fen</div>
                                            <div class="text-[10px] text-gray-500">Positionen & BetrÃ¤ge kontrollieren</div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                                            <div class="text-lg mb-1">âœ…</div>
                                            <div class="text-xs font-bold text-green-700">3. Freigeben</div>
                                            <div class="text-[10px] text-gray-500">Rechnung bestÃ¤tigen</div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-orange-50 border border-orange-200">
                                            <div class="text-lg mb-1">ðŸ“¨</div>
                                            <div class="text-xs font-bold text-orange-700">4. Versenden</div>
                                            <div class="text-[10px] text-gray-500">Manuell an LexOffice senden</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 p-2 bg-amber-50 rounded text-[11px] text-amber-700 border border-amber-200">
                                        ðŸ’¡ <strong>Empfehlung:</strong> Bleibt im manuellen Modus, bis ihr sicher seid, dass alle Positionen und BetrÃ¤ge stimmen. Ihr kÃ¶nnt jederzeit auf Automatik wechseln.
                                    </div>
                                </div>
                                <div id="approvalModeAutoInfo" style="display:none;">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">Automatischer Ablauf:</div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-center">
                                        <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                                            <div class="text-lg mb-1">âš¡</div>
                                            <div class="text-xs font-bold text-green-700">1. Generieren</div>
                                            <div class="text-[10px] text-gray-500">Rechnungen werden automatisch berechnet</div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                                            <div class="text-lg mb-1">âœ…</div>
                                            <div class="text-xs font-bold text-green-700">2. Auto-Freigabe</div>
                                            <div class="text-[10px] text-gray-500">Sofort freigegeben wenn Validierung OK</div>
                                        </div>
                                        <div class="p-3 rounded-lg bg-green-50 border border-green-200">
                                            <div class="text-lg mb-1">ðŸ“¨</div>
                                            <div class="text-xs font-bold text-green-700">3. Auto-Versand</div>
                                            <div class="text-[10px] text-gray-500">Direkt an LexOffice gesendet</div>
                                        </div>
                                    </div>
                                    <div class="mt-3 p-2 bg-red-50 rounded text-[11px] text-red-700 border border-red-200">
                                        âš ï¸ <strong>Achtung:</strong> Rechnungen werden ohne manuelle PrÃ¼fung versendet. Nur aktivieren wenn das Abrechnungssystem zuverlÃ¤ssig lÃ¤uft!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aktionen -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm text-gray-500">
                                <span id="approvalListCount">0</span> Rechnungen in der Warteschlange
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approvalBulkAction('approveAll')" id="bulkApproveBtn" class="hidden px-3 py-2 bg-green-50 text-green-700 rounded-lg text-xs font-semibold hover:bg-green-100 border border-green-200">âœ… Alle freigeben</button>
                                <button onclick="generateAllDrafts()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:opacity-90">ðŸ“ Monatsrechnungen generieren</button>
                            </div>
                        </div>

                        <!-- Pending Invoices List -->
                        <div id="approvalList" class="space-y-3"></div>
                    </div>

                    <!-- Tab: Overview -->
                    <div id="billingTabOverview" class="billing-tab-content">
                        <!-- KPIs -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="billingKpis"></div>

                        <!-- Actions -->
                        <div class="vit-card p-4 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-3">âš¡ Aktionen</h3>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="generateMonthlyDrafts()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ“ Monats-Drafts generieren</button>
                                <button onclick="showQuarterlySettlementDialog()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700">ðŸ“Š Quartals-Settlement</button>
                                <button onclick="finalizeAllReady()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">âœ… Alle Drafts finalisieren</button>
                            </div>
                        </div>

                        <!-- Standort Overview Table -->
                        <div class="vit-card overflow-hidden">
                            <div class="p-4 border-b bg-gray-50">
                                <h3 class="font-semibold text-gray-800">Standort-Ãœbersicht</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                        <tr>
                                            <th class="text-left p-3">Standort</th>
                                            <th class="text-center p-3">Strategie</th>
                                            <th class="text-center p-3">SEPA</th>
                                            <th class="text-right p-3">Rechnung</th>
                                            <th class="text-center p-3">Status</th>
                                            <th class="text-center p-3">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billingOverviewTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Invoices -->
                    <div id="billingTabInvoices" class="billing-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-800">Alle Rechnungen</h3>
                            <div class="flex space-x-2">
                                <select id="billingInvoiceFilter" onchange="loadAllInvoices()" class="text-xs border rounded px-2 py-1">
                                    <option value="">Alle Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="finalized">Finalisiert</option>
                                    <option value="paid">Bezahlt</option>
                                    <option value="failed">Fehlgeschlagen</option>
                                </select>
                            </div>
                        </div>
                        <div id="billingInvoicesList" class="space-y-2"></div>
                    </div>

                    <!-- Tab: Strategies -->
                    <div id="billingTabStrategies" class="billing-tab-content" style="display:none;">
                        <div id="billingStrategiesList" class="space-y-3"></div>
                    </div>

                    <!-- Tab: Products -->
                    <div id="billingTabProducts" class="billing-tab-content" style="display:none;">
                        <div id="billingProductsList" class="space-y-2"></div>
                    </div>

                    <!-- Tab: Tools -->
                    <div id="billingTabTools" class="billing-tab-content" style="display:none;">
                        <div id="billingToolsList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ BILLING INVOICE DETAIL (Modal/Overlay) ===== -->
                <div id="hqBillingDetailView" class="view" style="display: none;">
                    <div class="flex items-center mb-6">
                        <button onclick="showView('hqBilling')" data-hq-module="hqBilling" class="mr-3 p-2 rounded-lg hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800" id="billingDetailTitle">Rechnung</h1>
                            <p class="text-sm text-gray-500" id="billingDetailSubtitle"></p>
                        </div>
                        <div class="ml-auto flex space-x-2" id="billingDetailActions"></div>
                    </div>
                    <div id="billingDetailContent"></div>
                </div>

                <!-- ===== STANDORT BILLING VIEW ===== -->
                <div id="standortBillingView" class="view" style="display: none;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ðŸ’° Meine Buchhaltung</h1>
                            <p class="text-sm text-gray-500">Rechnungen, Zahlungsstatus, Downloads</p>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4 -mb-px">
                            <button onclick="showStBillingTab('invoices')" class="st-billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-vit-orange font-semibold text-sm text-vit-orange" data-tab="invoices">ðŸ“„ Rechnungen</button>
                            <button onclick="showStBillingTab('payments')" class="st-billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-tab="payments">ðŸ’³ Zahlungsstatus</button>
                            <button onclick="showStBillingTab('strategy')" class="st-billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-tab="strategy">ðŸŽ¯ Jahresstrategie</button>
                            <button onclick="showStBillingTab('costs')" class="st-billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-tab="costs">ðŸ” KostenaufschlÃ¼sselung</button>
                            <button onclick="showStBillingTab('wawi')" class="st-billing-tab whitespace-nowrap py-3 px-1 border-b-2 border-transparent text-sm text-gray-500" data-tab="wawi">ðŸ“„ WaWi Belege</button>
                        </nav>
                    </div>

                    <div id="stBillingTabInvoices" class="st-billing-tab-content">
                        <div id="stBillingInvoicesList" class="space-y-3"></div>
                    </div>
                    <div id="stBillingTabPayments" class="st-billing-tab-content" style="display:none;">
                        <div id="stBillingPaymentsContent"></div>
                    </div>
                    <div id="stBillingTabStrategy" class="st-billing-tab-content" style="display:none;">
                        <div id="stBillingStrategyContent"></div>
                    </div>
                    <div id="stBillingTabCosts" class="st-billing-tab-content" style="display:none;">
                        <div id="stBillingCostsContent"></div>
                    </div>
                    <div id="stBillingTabWawi" class="st-billing-tab-content" style="display:none;">
                        <div class="flex items-center justify-between mb-5 flex-wrap gap-3">
                            <p class="text-sm text-gray-500">Belege aus der WaWi importieren & auswerten</p>
                            <button onclick="document.getElementById('wawiFileInput').click()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600 transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                PDF hochladen
                            </button>
                            <input type="file" id="wawiFileInput" accept=".pdf" multiple style="display:none" onchange="wawiHandleFiles(this.files)">
                        </div>

                        <!-- WaWi Sub-Tabs -->
                        <div class="flex space-x-1 mb-5 bg-gray-100 rounded-lg p-1">
                            <button onclick="showWawiSubTab('api')" class="wawi-sub-btn flex-1 py-2 rounded-md text-xs font-semibold transition bg-white text-gray-800 shadow-sm" data-sub="api">ðŸ”Œ API</button>
                            <button onclick="showWawiSubTab('upload')" class="wawi-sub-btn flex-1 py-2 rounded-md text-xs font-semibold transition text-gray-500" data-sub="upload">ðŸ“„ Upload</button>
                            <button onclick="showWawiSubTab('belege')" class="wawi-sub-btn flex-1 py-2 rounded-md text-xs font-semibold transition text-gray-500" data-sub="belege">ðŸ“‹ Belege</button>
                            <button onclick="showWawiSubTab('dashboard')" class="wawi-sub-btn flex-1 py-2 rounded-md text-xs font-semibold transition text-gray-500" data-sub="dashboard">ðŸ“Š Auswertung</button>
                            <button onclick="showWawiSubTab('leasing')" class="wawi-sub-btn flex-1 py-2 rounded-md text-xs font-semibold transition text-gray-500" data-sub="leasing">ðŸš² Leasing</button>
                        </div>

                        <div id="wawiSubApi" class="wawi-sub-content">
                            <div class="vit-card p-6 mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 class="font-bold text-gray-800">ðŸ”Œ WaWi API-Anbindung</h3>
                                        <p class="text-xs text-gray-500 mt-1">Verbinde deine Warenwirtschaft fÃ¼r automatischen Datenaustausch</p>
                                    </div>
                                    <div id="wawiConnectionStatus"></div>
                                </div>
                                <div id="wawiConnectionForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">WaWi-System</label>
                                            <select id="wawiSystemTyp" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2" onchange="wawiSystemChanged()">
                                                <option value="approom">app-room / CYCLE</option>
                                                <option value="velodata">velodata</option>
                                                <option value="velo_plus">Velo Plus</option>
                                                <option value="bc">Business Central</option>
                                                <option value="custom">Andere (Custom)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">API-URL</label>
                                            <input type="text" id="wawiApiUrl" placeholder="https://erp.app-room.ch/api" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">API-Key <span class="text-gray-400">(cycle-api-key)</span></label>
                                            <input type="password" id="wawiApiKey" placeholder="Dein API-SchlÃ¼ssel" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">Anzeigename <span class="text-gray-400">(optional)</span></label>
                                            <input type="text" id="wawiLabel" placeholder="z.B. CYCLE Filiale Grafrath" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-xs font-semibold text-gray-600 mb-2">Sync-Module</label>
                                        <div class="flex flex-wrap gap-3">
                                            <label class="flex items-center gap-1.5 text-sm"><input type="checkbox" id="wawiSyncContacts" checked class="rounded"> ðŸ‘¥ Kontakte</label>
                                            <label class="flex items-center gap-1.5 text-sm"><input type="checkbox" id="wawiSyncProducts" checked class="rounded"> ðŸ“¦ Produkte</label>
                                            <label class="flex items-center gap-1.5 text-sm"><input type="checkbox" id="wawiSyncOrders" checked class="rounded"> ðŸ“‹ AuftrÃ¤ge</label>
                                            <label class="flex items-center gap-1.5 text-sm"><input type="checkbox" id="wawiSyncStock" checked class="rounded"> ðŸ“Š Bestand</label>
                                            <label class="flex items-center gap-1.5 text-sm"><input type="checkbox" id="wawiSyncBills" class="rounded"> ðŸ§¾ Rechnungen</label>
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button onclick="wawiTestConnection()" class="px-5 py-2.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200 transition" id="wawiTestBtn">ðŸ” Verbindung testen</button>
                                        <button onclick="wawiSaveConnection()" class="px-5 py-2.5 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600 transition" id="wawiSaveBtn">ðŸ’¾ Speichern & Aktivieren</button>
                                    </div>
                                    <div id="wawiTestResult" class="mt-3"></div>
                                </div>
                            </div>

                            <!-- Sync Status & Controls (shown when connected) -->
                            <div id="wawiSyncPanel" style="display:none;">
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="wawiApiKpis"></div>
                                <div class="vit-card p-5 mb-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-sm font-bold text-gray-700">ðŸ”„ Sync-Verlauf</h3>
                                        <div class="flex gap-2">
                                            <button onclick="wawiTriggerSync('contacts')" class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-xs font-semibold hover:bg-blue-100">ðŸ‘¥ Kontakte</button>
                                            <button onclick="wawiTriggerSync('products')" class="px-3 py-1.5 bg-green-50 text-green-700 rounded-lg text-xs font-semibold hover:bg-green-100">ðŸ“¦ Produkte</button>
                                            <button onclick="wawiTriggerSync('orders')" class="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-lg text-xs font-semibold hover:bg-purple-100">ðŸ“‹ AuftrÃ¤ge</button>
                                            <button onclick="wawiSyncAll()" class="px-3 py-1.5 bg-vit-orange text-white rounded-lg text-xs font-semibold hover:bg-orange-600">âš¡ Alle syncen</button>
                                        </div>
                                    </div>
                                    <div id="wawiSyncLog" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="vit-card p-5">
                                        <h3 class="text-sm font-bold text-gray-700 mb-3">ðŸ‘¥ Kontakte <span id="wawiContactCount" class="text-gray-400 font-normal">(0)</span></h3>
                                        <div id="wawiContactPreview" class="space-y-1 max-h-[250px] overflow-y-auto text-sm"></div>
                                    </div>
                                    <div class="vit-card p-5">
                                        <h3 class="text-sm font-bold text-gray-700 mb-3">ðŸ“¦ Produkte <span id="wawiProductCount" class="text-gray-400 font-normal">(0)</span></h3>
                                        <div id="wawiProductPreview" class="space-y-1 max-h-[250px] overflow-y-auto text-sm"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="wawiSubUpload" class="wawi-sub-content" style="display:none;">
                            <div id="wawiDropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center hover:border-vit-orange hover:bg-orange-50/30 transition cursor-pointer mb-6" onclick="document.getElementById('wawiFileInput').click()" ondragover="event.preventDefault();this.classList.add('border-vit-orange','bg-orange-50')" ondragleave="this.classList.remove('border-vit-orange','bg-orange-50')" ondrop="event.preventDefault();this.classList.remove('border-vit-orange','bg-orange-50');wawiHandleFiles(event.dataTransfer.files)">
                                <div class="text-4xl mb-3">ðŸ“„</div>
                                <p class="text-gray-600 font-semibold">PDF-Belege hierher ziehen</p>
                                <p class="text-gray-400 text-sm mt-1">oder klicken zum AuswÃ¤hlen â€¢ Angebote, AuftrÃ¤ge, Rechnungen</p>
                            </div>
                            <div id="wawiParseResults" class="space-y-3"></div>
                        </div>
                        <div id="wawiSubBelege" class="wawi-sub-content" style="display:none;">
                            <div class="flex gap-3 mb-4 flex-wrap">
                                <select id="wawiFilterTyp" onchange="loadWawiBelege()" class="text-sm border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Alle Typen</option><option value="Angebot">Angebote</option><option value="Auftrag">AuftrÃ¤ge</option><option value="Rechnung">Rechnungen</option>
                                </select>
                                <select id="wawiFilterLeasing" onchange="loadWawiBelege()" class="text-sm border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Alle</option><option value="true">Nur Leasing</option><option value="false">Ohne Leasing</option>
                                </select>
                                <input type="text" id="wawiFilterSearch" onkeyup="loadWawiBelege()" placeholder="Suche (Beleg-Nr, Kunde...)" class="text-sm border border-gray-300 rounded-lg px-3 py-2 flex-1 min-w-[200px]">
                            </div>
                            <div id="wawiListContainer" class="vit-card overflow-hidden"><div class="p-8 text-center text-gray-400">Wird geladen...</div></div>
                        </div>
                        <div id="wawiSubDashboard" class="wawi-sub-content" style="display:none;">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="wawiKpiCards"></div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="vit-card p-5"><h3 class="text-sm font-bold text-gray-700 mb-3">ðŸ“ˆ Umsatz nach Belegtyp</h3><div id="wawiChartTyp" class="min-h-[200px]"></div></div>
                                <div class="vit-card p-5"><h3 class="text-sm font-bold text-gray-700 mb-3">ðŸ† Top-Produkte</h3><div id="wawiTopProducts" class="min-h-[200px]"></div></div>
                            </div>
                        </div>
                        <div id="wawiSubLeasing" class="wawi-sub-content" style="display:none;">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="wawiLeasingKpis"></div>
                            <div class="vit-card p-5"><h3 class="text-sm font-bold text-gray-700 mb-3">ðŸš² Leasing-VorgÃ¤nge nach Anbieter</h3><div id="wawiLeasingTable"></div></div>
                        </div>
                    </div>

                    <!-- Beleg Detail Modal -->
                    <div id="wawiBelegModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style="display:none" onclick="if(event.target===this)this.style.display='none'">
                        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[85vh] overflow-y-auto p-6"><div id="wawiBelegDetail"></div></div>
                    </div>
                </div>

                <div id="hqAuswertungView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“Š AUSWERTUNG â€“ PORTAL-NUTZUNG<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-usage')">i</button></h1><div class="widget-info-popup" id="info-hq-usage">Wie aktiv nutzen die Standorte das Portal? Score basiert auf: Team-Logins, Modul-Nutzung, Aufgaben-Erledigung und BWA-PÃ¼nktlichkeit. Niedrige Scores deuten auf Onboarding-Bedarf oder fehlende Gewohnheitsbildung hin.</div>
                    <p class="text-sm text-gray-500 mb-6">Wie aktiv nutzen die Standorte das vit:bikes cockpit?</p>
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6" id="hqAuswKpis"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ† Aktivste Standorte<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-active')">i</button></h2><div class="widget-info-popup" id="info-hq-active">Standorte mit dem hÃ¶chsten Portal-Nutzungs-Score. BerÃ¼cksichtigt werden Login-Frequenz, Feature-Nutzung, Aufgaben und Kommunikation.</div>
                            <div id="hqAuswTop" class="space-y-2"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h2 class="text-sm font-bold text-gray-800 mb-3">âš ï¸ Geringste Nutzung<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-inactive')">i</button></h2><div class="widget-info-popup" id="info-hq-inactive">Standorte mit niedrigster AktivitÃ¤t. Diese Standorte benÃ¶tigen mÃ¶glicherweise gezielte Ansprache, Onboarding-Trainer oder einen Anruf zur KlÃ¤rung von HÃ¼rden.</div>
                            <div id="hqAuswBottom" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="vit-card p-5 mb-6">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“‹ Modul-Nutzung im Netzwerk<button class="widget-info-btn" onclick="toggleWidgetInfo(event,'info-hq-modules')">i</button></h2><div class="widget-info-popup" id="info-hq-modules">Welche Module werden am meisten genutzt? Niedrige Nutzung bei wichtigen Modulen (z.B. Controlling, Verkauf) kann auf fehlendes Training oder unklaren Nutzen hinweisen.</div>
                        <div id="hqAuswModules" class="space-y-2"></div>
                    </div>
                    <div class="vit-card p-5">
                        <h2 class="text-sm font-bold text-gray-800 mb-3">ðŸ“ˆ Alle Standorte â€“ Nutzungs-Score</h2>
                        <div id="hqAuswAll" class="space-y-1"></div>
                    </div>
                </div>

                <!-- ===== HQ WISSEN-VERWALTUNG ===== -->
                <div id="hqWissenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ“š WISSEN â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Wissensinhalte fuer alle Partner bereitstellen und verwalten.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange">24</div><div class="text-xs text-gray-500">Akademie-Kurse</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">18</div><div class="text-xs text-gray-500">Handbuecher</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">12</div><div class="text-xs text-gray-500">Best Practices</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-purple-600">45</div><div class="text-xs text-gray-500">FAQ-Eintraege</div></div>
                    </div>
                    <!-- Neuen Inhalt anlegen -->
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neuen Wissensinhalt erstellen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Titel</label>
                                <input type="text" id="hqWissenTitel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Leitfaden E-Bike Beratung">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                <select id="hqWissenKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="akademie">ðŸŽ“ Akademie-Kurs</option>
                                    <option value="handbuch">ðŸ“– Handbuch</option>
                                    <option value="bestpractice">â­ Best Practice</option>
                                    <option value="faq">â“ FAQ</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bereich</label>
                            <select id="hqWissenBereich" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="verkauf">Verkauf</option>
                                <option value="werkstatt">Werkstatt</option>
                                <option value="marketing">Marketing</option>
                                <option value="betrieb">Betrieb &amp; Organisation</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Inhalt / Beschreibung</label>
                            <textarea id="hqWissenInhalt" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Inhalt des Wissensartikels..."></textarea>
                        </div>
                        <button onclick="addHqWissen()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ“š Veroeffentlichen</button>
                    </div>
                    <!-- Bestehende Inhalte -->
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“‹ Bestehende Inhalte</h2>
                        <div id="hqWissenList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ SUPPORT-ÃœBERSICHT ===== -->
                <div id="hqSupportView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸŽ« SUPPORT â€“ UEBERSICHT</h1>
                    <p class="text-sm text-gray-500 mb-6">Alle Support-Anfragen der Partner im Blick.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-red-500">7</div><div class="text-xs text-gray-500">Offene Tickets</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-500">3</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600">48</div><div class="text-xs text-gray-500">Geloest (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600">4.2h</div><div class="text-xs text-gray-500">âŒ€ Reaktionszeit</div></div>
                    </div>
                    <div class="vit-card p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ”´ Offene Support-Tickets</h2>
                        <div id="hqSupportTickets" class="space-y-3"></div>
                    </div>
                    <div class="vit-card p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š Tickets nach Standort</h2>
                        <div id="hqSupportStats" class="space-y-2"></div>
                    </div>
                </div>

                <!-- ===== HQ IDEENBOARD â†’ Redirect zum neuen Ideenboard ===== -->
                <div id="hqIdeenView" class="view" style="display: none;">
                    <div class="text-center py-12 text-gray-400">Weiterleitung zum Ideenboard...</div>
                </div>

                <!-- ===== HQ SHOP-VERWALTUNG ===== -->
                <div id="hqShopView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">ðŸ›ï¸ SHOP â€“ VERWALTUNG</h1>
                    <p class="text-sm text-gray-500 mb-6">Bestellungen bearbeiten, Packlisten drucken, Versand tracken.</p>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="hqShopKpis">
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-vit-orange" id="hqShopKpiProducts">-</div><div class="text-xs text-gray-500">Produkte aktiv</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-yellow-600" id="hqShopKpiPending">-</div><div class="text-xs text-gray-500">Offen / zu packen</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-blue-600" id="hqShopKpiShipped">-</div><div class="text-xs text-gray-500">Versendet (Monat)</div></div>
                        <div class="vit-card p-4 text-center"><div class="text-2xl font-bold text-green-600" id="hqShopKpiRevenue">-</div><div class="text-xs text-gray-500">Umsatz (Monat)</div></div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showHqShopTab('orders')" class="hq-shop-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="orders">ðŸ“¦ Bestellungen</button>
                        <button onclick="showHqShopTab('products')" class="hq-shop-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="products">ðŸ“‹ Produkte & Bestand</button>
                        <button onclick="showHqShopTab('addproduct')" class="hq-shop-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="addproduct">âž• Neues Produkt</button>
                    </div>

                    <!-- Tab: Bestellungen -->
                    <div id="hqShopTabOrders" class="hq-shop-tabcontent">
                        <div class="flex items-center space-x-2 mb-4">
                            <button onclick="filterHqShopOrders('all')" class="hq-order-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="all">Alle</button>
                            <button onclick="filterHqShopOrders('pending')" class="hq-order-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="pending">ðŸ”´ Offen</button>
                            <button onclick="filterHqShopOrders('confirmed')" class="hq-order-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="confirmed">ðŸŸ¡ BestÃ¤tigt</button>
                            <button onclick="filterHqShopOrders('shipped')" class="hq-order-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="shipped">ðŸ”µ Versendet</button>
                            <button onclick="filterHqShopOrders('delivered')" class="hq-order-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="delivered">ðŸŸ¢ Geliefert</button>
                        </div>
                        <div id="hqShopOrders" class="space-y-3"></div>
                    </div>

                    <!-- Tab: Produkte -->
                    <div id="hqShopTabProducts" class="hq-shop-tabcontent" style="display:none">
                        <div id="hqShopProducts" class="space-y-2"></div>
                    </div>

                    <!-- Tab: Neues Produkt -->
                    <div id="hqShopTabAddproduct" class="hq-shop-tabcontent" style="display:none">
                        <div class="vit-card p-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">âž• Neues Produkt anlegen</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Produktname</label>
                                    <input type="text" id="hqShopName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. Regenjacke">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                                    <select id="hqShopKat" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="print">ðŸ–¨ï¸ Print</option>
                                        <option value="textil">ðŸ‘• Textilien</option>
                                        <option value="display">ðŸª§ Displays</option>
                                        <option value="digital">ðŸ’» Digital</option>
                                        <option value="give">ðŸŽ Giveaways</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Preis (â‚¬)</label>
                                    <input type="number" id="hqShopPreis" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="0.00" step="0.01">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Beschreibung</label>
                                <input type="text" id="hqShopDesc" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Kurze Produktbeschreibung">
                            </div>
                            <button onclick="addHqShopProduct()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ›ï¸ Produkt anlegen</button>
                        </div>
                    </div>

                    <!-- Packliste Modal -->
                    <div id="packingListModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-auto">
                            <div id="packingListContent"></div>
                            <div class="flex space-x-3 mt-4 print:hidden">
                                <button onclick="window.print()" class="flex-1 px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ–¨ï¸ Drucken</button>
                                <button onclick="document.getElementById('packingListModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300">SchlieÃŸen</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tracking Modal -->
                    <div id="trackingModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
                            <h3 class="font-bold text-lg mb-4">ðŸ“¦ Sendungsverfolgung eintragen</h3>
                            <input type="hidden" id="trackingOrderId">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Versanddienstleister</label>
                                    <select id="trackingCarrier" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="DHL">DHL</option>
                                        <option value="DPD">DPD</option>
                                        <option value="Hermes">Hermes</option>
                                        <option value="UPS">UPS</option>
                                        <option value="GLS">GLS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tracking-Nummer</label>
                                    <input type="text" id="trackingNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="z.B. 00340434161094042557">
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-4">
                                <button onclick="saveTracking()" class="flex-1 px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ’¾ Speichern & Versenden</button>
                                <button onclick="document.getElementById('trackingModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300">Abbrechen</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HQ EINSTELLUNGEN VIEW -->
                <div id="hqEinstellungenView" class="view" style="display: none;">
                    <h1 class="h1-headline text-gray-800 mb-2">âš™ï¸ EINSTELLUNGEN</h1>
                    <p class="text-sm text-gray-500 mb-6">Modul-Verwaltung und Rollen-Rechte fÃ¼r das gesamte Netzwerk.</p>

                    <!-- Tab-Navigation -->
                    <div class="flex space-x-1 mb-6 border-b border-gray-200">
                        <button onclick="showSettingsTab('modulstatus')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-vit-orange text-vit-orange" data-tab="modulstatus">ðŸª Partner-Module</button>
                        <button onclick="showSettingsTab('hqmodule')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="hqmodule">ðŸ¢ HQ-Module</button>
                        <button onclick="showSettingsTab('demo')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="demo">ðŸŽ­ Demo-Modus</button>
                        <button onclick="showSettingsTab('rechte')" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="rechte">ðŸ” Rollen & Rechte</button>
                        <button onclick="showSettingsTab('office');setTimeout(function(){if(typeof officeRenderAdminDots==='function')officeRenderAdminDots()},200)" class="settings-tab px-4 py-2.5 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="office">ðŸ¢ Office-RÃ¤ume</button>
                    </div>

                    <!-- TAB 1: Modul-Status -->
                    <div id="settingsTabModulstatus" class="settings-tab-content">
                        <div class="vit-card p-4 mb-6 border-l-4 border-orange-500">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">ðŸª</span>
                                <div>
                                    <h3 class="font-bold text-gray-800">Partner-Module (Standort-Ebene)</h3>
                                    <p class="text-xs text-gray-500 mt-0.5">Diese Module sind fÃ¼r Franchise-Partner sichtbar. Status-Ã„nderungen wirken sich auf alle Standorte aus.</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                            <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="countAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-orange-400"><div class="text-2xl font-bold text-orange-500" id="countDemo">0</div><div class="text-xs text-gray-500">Demo</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-yellow-500"><div class="text-2xl font-bold text-yellow-600" id="countWip">0</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-gray-400"><div class="text-2xl font-bold text-gray-400" id="countDeaktiviert">0</div><div class="text-xs text-gray-500">Deaktiviert</div></div>
                        </div>
                        <div class="vit-card overflow-hidden mb-6">
                            <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                <h2 class="font-bold text-gray-800">ðŸª Partner-Module</h2>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span><span>Aktiv</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-orange-400 inline-block"></span><span>Demo</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block"></span><span>In Bearbeitung</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 inline-block"></span><span>Deaktiviert</span></span>
                                </div>
                            </div>
                            <div id="modulStatusList" class="divide-y divide-gray-100"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-2">â„¹ï¸ So funktioniert es</h3>
                            <div class="space-y-1.5 text-xs text-gray-600">
                                <p><span class="font-bold text-green-600">Aktiv:</span> Das Modul ist fÃ¼r alle Nutzer sichtbar und voll nutzbar (sofern ihre Rolle es erlaubt).</p>
                                <p><span class="font-bold text-orange-500">Demo:</span> Das Modul ist sichtbar und klickbar, zeigt aber Demo-Daten. Ein oranges Demo-Banner ist prominent sichtbar. Ideal fÃ¼r Module in Vorbereitung.</p>
                                <p><span class="font-bold text-yellow-600">In Bearbeitung:</span> Das Modul erscheint ausgegraut in der Sidebar mit einem â€žBALD"-Badge. Nutzer kÃ¶nnen es nicht Ã¶ffnen.</p>
                                <p><span class="font-bold text-gray-500">Deaktiviert:</span> Das Modul ist komplett unsichtbar â€“ kein MenÃ¼punkt, kein Zugang.</p>
                                <hr class="my-3 border-gray-200">
                                <p><strong>Tabs & Widgets:</strong> Klicke auf â–¶ bei einem Modul, um einzelne Tabs und Dashboard-Widgets zu konfigurieren. Jeder Tab/Widget kann separat auf Aktiv, Demo oder Deaktiviert gesetzt werden.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: HQ-Module -->
                    <div id="settingsTabHqmodule" class="settings-tab-content" style="display:none;">
                        <div class="vit-card p-4 mb-6 border-l-4 border-blue-500">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">ðŸ¢</span>
                                <div>
                                    <h3 class="font-bold text-gray-800">HQ-Module (Zentrale)</h3>
                                    <p class="text-xs text-gray-500 mt-0.5">Diese Module sind nur fÃ¼r HQ-Mitarbeiter sichtbar. Partner sehen diese Module nicht.</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                            <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="countHqAktiv">0</div><div class="text-xs text-gray-500">Aktiv</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-orange-400"><div class="text-2xl font-bold text-orange-500" id="countHqDemo">0</div><div class="text-xs text-gray-500">Demo</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-yellow-500"><div class="text-2xl font-bold text-yellow-600" id="countHqWip">0</div><div class="text-xs text-gray-500">In Bearbeitung</div></div>
                            <div class="vit-card p-4 text-center border-l-4 border-gray-400"><div class="text-2xl font-bold text-gray-400" id="countHqDeaktiviert">0</div><div class="text-xs text-gray-500">Deaktiviert</div></div>
                        </div>
                        <div class="vit-card overflow-hidden mb-6">
                            <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                <h2 class="font-bold text-gray-800">ðŸ¢ HQ-Module</h2>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-green-500 inline-block"></span><span>Aktiv</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-orange-400 inline-block"></span><span>Demo</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block"></span><span>In Bearbeitung</span></span>
                                    <span class="flex items-center space-x-1"><span class="w-2.5 h-2.5 rounded-full bg-gray-300 inline-block"></span><span>Deaktiviert</span></span>
                                </div>
                            </div>
                            <div id="hqModulStatusList" class="divide-y divide-gray-100"></div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-2">â„¹ï¸ HQ-Module</h3>
                            <div class="space-y-1.5 text-xs text-gray-600">
                                <p>HQ-Module sind <strong>nur fÃ¼r die Zentrale</strong> sichtbar und werden unabhÃ¤ngig von den Partner-Modulen gesteuert.</p>
                                <p>Module mit Ebene â€žBeide" (Kalender, Aufgaben, Kommunikation) erscheinen hier unter <strong>Basis</strong> â€” ihr HQ-Status ist separat steuerbar.</p>
                                <p>Neue HQ-Module (z.B. Office, Abrechnung) werden hier hinzugefÃ¼gt und sind automatisch nur fÃ¼r HQ-User verfÃ¼gbar.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB DEMO: Demo-Modus Konfiguration -->
                    <div id="settingsTabDemo" class="settings-tab-content" style="display:none;">
                        <div class="vit-card p-5 mb-6 border-l-4 border-orange-400">
                            <h3 class="font-bold text-gray-800 mb-2">ðŸŽ­ Demo-Modus Konfiguration</h3>
                            <p class="text-sm text-gray-600 mb-3">Steuere welche Module im Demo-Modus (Login-Demo auf der Startseite) sichtbar und nutzbar sind. Diese Einstellungen sind unabhÃ¤ngig vom normalen Modul-Status.</p>
                            <p class="text-xs text-gray-400">Demo-User sehen nur die hier konfigurierten Status. â€žAktiv" = mit Demo-Daten nutzbar, â€žDemo" = sichtbar mit Demo-Banner, â€žAus" = nicht sichtbar.</p>
                        </div>
                        <div class="vit-card overflow-hidden">
                            <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                                <h2 class="font-bold text-gray-800">Demo Module</h2>
                                <div class="flex items-center space-x-3 text-xs text-gray-500">
                                    <button onclick="setAllDemoStatus('demo')" class="px-2 py-1 rounded bg-orange-100 text-orange-700 hover:bg-orange-200 font-semibold transition">Alle Demo</button>
                                    <button onclick="setAllDemoStatus('deaktiviert')" class="px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold transition">Alle Aus</button>
                                </div>
                            </div>
                            <div id="demoModulStatusList" class="divide-y divide-gray-100"></div>
                        </div>
                    </div>

                    <!-- TAB 2: Rollen & Rechte (bestehend) -->
                    <div id="settingsTabRechte" class="settings-tab-content" style="display:none;">

                    <!-- Rollen-Ãœbersicht -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="vit-card p-4 text-center border-l-4 border-orange-500"><div class="text-2xl font-bold text-vit-orange">4 + 8</div><div class="text-xs text-gray-500">Standort + HQ Rollen</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-blue-500"><div class="text-2xl font-bold text-blue-600">16 + 18</div><div class="text-xs text-gray-500">Standort + HQ Module</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-green-500"><div class="text-2xl font-bold text-green-600" id="settingsMaCount">26</div><div class="text-xs text-gray-500">Mitarbeiter gesamt</div></div>
                        <div class="vit-card p-4 text-center border-l-4 border-purple-500"><div class="text-2xl font-bold text-purple-600">âœ“</div><div class="text-xs text-gray-500">Multi-Rollen aktiv</div></div>
                    </div>

                    <!-- Rechte-Matrix PARTNER -->
                    <div class="vit-card overflow-hidden mb-6">
                        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
                            <h2 class="font-bold text-gray-800">ðŸª Standort-Rechte: Module Ã— Rollen</h2>
                            <span class="text-xs text-gray-400">Klicken zum Aktivieren/Deaktivieren</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="rechteMatrixTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600 min-w-[180px]">Modul</th>
                                        <th class="px-4 py-3 text-center font-semibold text-orange-600 min-w-[100px]">GeschÃ¤ftsleitung</th>
                                        <th class="px-4 py-3 text-center font-semibold text-blue-600 min-w-[100px]">Verkauf</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600 min-w-[100px]">Werkstatt</th>
                                        <th class="px-4 py-3 text-center font-semibold text-purple-600 min-w-[100px]">Buchhaltung</th>
                                    </tr>
                                </thead>
                                <tbody id="rechteMatrixBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rechte-Matrix HQ -->
                    <div class="vit-card overflow-hidden mb-6">
                        <div class="p-4 border-b bg-red-50 flex items-center justify-between">
                            <h2 class="font-bold text-gray-800">ðŸ¢ HQ-Rechte: Module Ã— Rollen</h2>
                            <span class="text-xs text-gray-400">Klicken zum Aktivieren/Deaktivieren</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="hqRechteMatrixTable">
                                <thead class="bg-red-50/50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-gray-600 min-w-[160px]">HQ-Modul</th>
                                        <th class="px-4 py-3 text-center font-semibold text-red-600 min-w-[70px]">ðŸ‘‘ GF</th>
                                        <th class="px-4 py-3 text-center font-semibold text-blue-600 min-w-[70px]">ðŸ“Š Sales</th>
                                        <th class="px-4 py-3 text-center font-semibold text-pink-600 min-w-[70px]">ðŸ“£ Mktg</th>
                                        <th class="px-4 py-3 text-center font-semibold text-green-600 min-w-[70px]">ðŸ›’ Eink.</th>
                                        <th class="px-4 py-3 text-center font-semibold text-yellow-600 min-w-[70px]">ðŸŽ§ Supp.</th>
                                        <th class="px-4 py-3 text-center font-semibold text-indigo-600 min-w-[70px]">ðŸŽ“ Akad.</th>
                                        <th class="px-4 py-3 text-center font-semibold text-purple-600 min-w-[70px]">ðŸ‘¥ HR</th>
                                        <th class="px-4 py-3 text-center font-semibold text-gray-600 min-w-[70px]">ðŸ–¥ï¸ IT</th>
                                    </tr>
                                </thead>
                                <tbody id="hqRechteMatrixBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Rollen-Beschreibungen -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸª Standort-Rollen</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-vit-orange text-white mt-0.5">GeschÃ¤ftsleitung</span><p class="text-xs text-gray-600">Vollzugriff auf alle Standort-Module inkl. Dashboards, Shop, Onboarding und Controlling.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700 mt-0.5">Verkauf</span><p class="text-xs text-gray-600">Zugang zu Verkauf, Marketing und allgemeinen Tools. Fokus auf Kundenberatung und Vertrieb.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-gray-200 text-gray-700 mt-0.5">Werkstatt</span><p class="text-xs text-gray-600">Zugang zu Einkauf und allgemeinen Tools. Fokus auf Werkstatt, Teile und Service.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-purple-100 text-purple-700 mt-0.5">Buchhaltung</span><p class="text-xs text-gray-600">Zugang zu Allgemein, Verkauf, Einkauf, Controlling und Aktenschrank. Finanz- und Dokumentenfokus.</p></div>
                            </div>
                        </div>
                        <div class="vit-card p-5">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸ¢ HQ-Rollen</h3>
                            <div class="space-y-3">
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-red-500 text-white mt-0.5">GF</span><p class="text-xs text-gray-600">Vollzugriff auf alle HQ-Module inkl. Einstellungen, Feature Flags und Entwicklung.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-blue-500 text-white mt-0.5">Sales</span><p class="text-xs text-gray-600">StandortÃ¼bersicht, Pipeline, Handlungsbedarf. Fokus auf Partnernetzwerk-Vertrieb.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-pink-500 text-white mt-0.5">Marketing</span><p class="text-xs text-gray-600">Kampagnen, Budgetsteuerung, Social Media, Video-Freigabe.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-green-500 text-white mt-0.5">Einkauf</span><p class="text-xs text-gray-600">Lieferanten, Bestellungen, Standort-Dokumente.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-yellow-500 text-white mt-0.5">Support</span><p class="text-xs text-gray-600">Ticketsystem, Trainermanagement, Partner-Support, Handlungsbedarf.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-indigo-500 text-white mt-0.5">Akademie</span><p class="text-xs text-gray-600">Wissensdatenbank, Schulungen, Onboarding-Inhalte verwalten.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-purple-500 text-white mt-0.5">HR</span><p class="text-xs text-gray-600">Mitarbeiterverwaltung, Tools & Lizenzen, Abrechnung. Optional aktivierbar.</p></div>
                                <div class="flex items-start space-x-3"><span class="px-2 py-1 rounded-full text-[10px] font-semibold bg-gray-600 text-white mt-0.5">IT</span><p class="text-xs text-gray-600">Systemadministration, Feature Flags, Backups. Rechte individuell konfigurierbar.</p></div>
                            </div>
                        </div>
                    </div>
                    <div class="vit-card p-5 mt-4">
                        <h3 class="font-bold text-gray-800 mb-3">â„¹ï¸ Hinweise</h3>
                        <div class="space-y-2 text-xs text-gray-600">
                            <p>â€¢ <strong>Basis-Module</strong> (Kalender, Aufgaben, Kommunikation, Office) sind fÃ¼r alle Rollen verfÃ¼gbar.</p>
                            <p>â€¢ <strong>Mehrfach-Rollen:</strong> Ein Mitarbeiter kann mehrere Rollen gleichzeitig haben â€“ die Rechte werden addiert.</p>
                            <p>â€¢ <strong>GF</strong> hat automatisch Vollzugriff auf alle HQ-Module (nicht einschrÃ¤nkbar). IT und alle anderen Rollen sind konfigurierbar.</p>
                            <p>â€¢ Ã„nderungen an der Rechte-Matrix werden sofort fÃ¼r alle betroffenen Nutzer wirksam.</p>
                        </div>
                    </div>
                    </div><!-- /settingsTabRechte -->

                    <!-- TAB 5: Office-RÃ¤ume -->
                    <div id="settingsTabOffice" class="settings-tab-content" style="display:none;">
                        <div class="vit-card p-4 mb-4 border-l-4 border-blue-500">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">ðŸ¢</span>
                                <div>
                                    <h3 class="font-bold text-gray-800">Office-RÃ¤ume & PlÃ¤tze verwalten</h3>
                                    <p class="text-xs text-gray-500 mt-0.5">Grundriss hochladen, RÃ¤ume anlegen, PlÃ¤tze per Drag & Drop positionieren.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Floor plan with interactive desk positioning -->
                        <div class="vit-card p-4 mb-4">
                            <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
                                <div class="text-sm font-bold text-gray-700">ðŸ“ Grundriss</div>
                                <div class="flex items-center gap-3">
                                    <button onclick="if(typeof officeUploadGrundriss==='function')officeUploadGrundriss()" class="text-xs px-3 py-1.5 bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 font-semibold transition">ðŸ“¤ Grundriss hochladen</button>
                                    <label class="flex items-center gap-2 text-[11px] cursor-pointer"><input type="checkbox" id="officeAdminDragMode" onchange="if(typeof officeToggleDragMode==='function')officeToggleDragMode()" class="accent-orange-500"> <span style="color:#EF7D00;font-weight:700">PlÃ¤tze verschieben</span></label>
                                </div>
                            </div>
                            <div id="officeFloorplanContainer" style="position:relative;overflow:auto">
                                <img id="officeGrundrissImg" src="grundriss_og.png" style="width:100%;min-width:700px;display:block;border-radius:8px;opacity:0.92"
                                     onload="this.dataset.loaded='1';if(typeof officeRenderAdminDots==='function')officeRenderAdminDots()"
                                     onerror="this.style.display='none';document.getElementById('officeGrundrissPlaceholder').style.display='flex'">
                                <div id="officeGrundrissPlaceholder" style="display:none;width:100%;min-height:400px;background:#f3f4f6;border-radius:8px;align-items:center;justify-content:center;flex-direction:column;gap:12px;border:2px dashed #d1d5db">
                                    <span style="font-size:48px">ðŸ¢</span>
                                    <p class="text-sm text-gray-400 font-semibold">Kein Grundriss vorhanden</p>
                                    <button onclick="if(typeof officeUploadGrundriss==='function')officeUploadGrundriss()" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸ“¤ Grundriss hochladen</button>
                                </div>
                                <div id="officeAdminDots" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none"></div>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3" id="officeRoomLegend"></div>
                            <div class="text-[10px] text-gray-400 mt-1" id="officeAdminDragHint">Aktiviere "PlÃ¤tze verschieben" um Dots per Drag & Drop auf dem Grundriss zu positionieren.</div>
                        </div>
                        
                        <!-- Room & desk management below -->
                        <div id="officeRoomsAdmin"></div>
                    </div>

                </div>

                <div id="hqAllgemeinView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                        <div class="mb-6"><p class="h2-headline text-vit-gray mb-1">HQ STEUERUNG</p><h1 class="h1-headline">Partner-Ãœbersicht</h1></div>
                
                        <!-- Stimmung -->
                        <div class="vit-card p-5 mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ðŸŒ¡ï¸ Netzwerk-Stimmung</h3>
                            <div class="flex items-center space-x-6">
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜Š</span><div><span class="text-lg font-bold text-green-600" id="hqStimmungPositiv">0</span><span class="text-xs text-gray-500 ml-1">positiv</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜</span><div><span class="text-lg font-bold text-yellow-600" id="hqStimmungNeutral">0</span><span class="text-xs text-gray-500 ml-1">neutral</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜Ÿ</span><div><span class="text-lg font-bold text-orange-600" id="hqStimmungBesorgt">0</span><span class="text-xs text-gray-500 ml-1">besorgt</span></div></div>
                                <div class="flex items-center space-x-2"><span class="text-2xl">ðŸ˜¤</span><div><span class="text-lg font-bold text-red-600" id="hqStimmungKritisch">0</span><span class="text-xs text-gray-500 ml-1">kritisch</span></div></div>
                            </div>
                        </div>
                
                        <!-- HQ-Aufgaben -->
                        <div class="vit-card p-5 mb-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-800">ðŸ”´ Offene HQ-Aufgaben aus Partner-Journals</h3><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-600" id="hqAufgabenBadge">0</span></div>
                            <div id="hqJournalAufgaben"><p class="text-gray-400 text-sm">Lade...</p></div>
                        </div>
                
                        <!-- Tabelle -->
                        <div class="vit-card overflow-hidden">
                            <div class="p-5 border-b"><h3 class="font-bold text-gray-800">ðŸ“‹ Alle Standorte</h3></div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50"><tr>
                                        <th class="text-left p-3 font-semibold text-gray-600">Standort</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Stimmung</th>
                                        <th class="text-left p-3 font-semibold text-gray-600">Monatsfokus</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Ziele</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Offene MaÃŸn.</th>
                                        <th class="text-center p-3 font-semibold text-gray-600">Letztes GesprÃ¤ch</th>
                                    </tr></thead>
                                    <tbody id="hqPartnerTabelle"><tr><td colspan="6" class="p-4 text-center text-gray-400">Lade...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- HQ FEATURE FLAGS MANAGEMENT VIEW             -->
                <!-- ============================================ -->
                <div id="hqFeatureFlagsView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p class="h2-headline text-vit-gray mb-1">HQ STEUERUNG</p>
                                <h1 class="h1-headline">ðŸš© Feature Flags</h1>
                                <p class="text-sm text-gray-500 mt-1">Beta-Features kontrolliert an Nutzer, Standorte oder Rollen ausrollen</p>
                            </div>
                            <button onclick="ffShowCreate()" class="px-4 py-2 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90 flex items-center space-x-2">
                                <span>+</span><span>Neuer Flag</span>
                            </button>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="vit-card p-4 text-center">
                                <p class="text-2xl font-bold text-gray-800" id="ffStatTotal">0</p>
                                <p class="text-xs text-gray-500">Gesamt</p>
                            </div>
                            <div class="vit-card p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" id="ffStatActive">0</p>
                                <p class="text-xs text-gray-500">Aktiv</p>
                            </div>
                            <div class="vit-card p-4 text-center">
                                <p class="text-2xl font-bold text-yellow-600" id="ffStatBeta">0</p>
                                <p class="text-xs text-gray-500">Beta (mit Targeting)</p>
                            </div>
                            <div class="vit-card p-4 text-center">
                                <p class="text-2xl font-bold text-gray-400" id="ffStatDisabled">0</p>
                                <p class="text-xs text-gray-500">Deaktiviert</p>
                            </div>
                        </div>

                        <!-- Flags List -->
                        <div class="vit-card overflow-hidden">
                            <div class="p-4 border-b flex items-center justify-between">
                                <h3 class="font-bold text-gray-800">Alle Feature Flags</h3>
                                <div class="flex items-center space-x-2">
                                    <button onclick="ffFilter('all')" class="ff-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-vit-orange text-white" data-f="all">Alle</button>
                                    <button onclick="ffFilter('active')" class="ff-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="active">Aktiv</button>
                                    <button onclick="ffFilter('beta')" class="ff-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="beta">Beta</button>
                                    <button onclick="ffFilter('disabled')" class="ff-filter text-xs px-3 py-1.5 rounded-full font-semibold bg-gray-100 text-gray-600" data-f="disabled">Aus</button>
                                </div>
                            </div>
                            <div id="ffFlagsList" class="divide-y">
                                <p class="p-6 text-center text-gray-400">Lade Feature Flags...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feature Flag Create/Edit Modal -->
                <div id="ffModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none;">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800" id="ffModalTitle">Neuer Feature Flag</h3>
                            <button onclick="ffCloseModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <input type="hidden" id="ffEditId" value="">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Flag Key *</label>
                                    <input type="text" id="ffKey" placeholder="z.B. bwa_ai_insights" class="w-full border rounded-lg px-3 py-2 text-sm" pattern="[a-z0-9_]+">
                                    <p class="text-[10px] text-gray-400 mt-1">Nur Kleinbuchstaben, Zahlen, Unterstriche</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Name *</label>
                                    <input type="text" id="ffName" placeholder="z.B. BWA KI-Analyse" class="w-full border rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Beschreibung</label>
                                <textarea id="ffDesc" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Was macht dieses Feature?"></textarea>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Scope</label>
                                    <select id="ffScope" class="w-full border rounded-lg px-3 py-2 text-sm">
                                        <option value="feature">Feature</option>
                                        <option value="modul">Modul</option>
                                        <option value="tab">Tab</option>
                                        <option value="widget">Widget</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Modul-Zuordnung</label>
                                    <input type="text" id="ffModul" placeholder="z.B. controlling" class="w-full border rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Rollout %</label>
                                    <input type="number" id="ffRollout" value="100" min="0" max="100" class="w-full border rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="ffEnabled" class="w-4 h-4 text-vit-orange rounded">
                                    <span class="text-sm font-semibold text-gray-700">Aktiviert</span>
                                </label>
                                <div class="flex-1">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Ablaufdatum (optional)</label>
                                    <input type="date" id="ffExpires" class="w-full border rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                            <hr>
                            <h4 class="font-semibold text-gray-700 text-sm">ðŸŽ¯ Targeting (leer = fÃ¼r alle)</h4>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Bestimmte Rollen</label>
                                <div id="ffRolesSelector" class="flex flex-wrap gap-2">
                                    <!-- populated dynamically -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Bestimmte Standorte</label>
                                <select id="ffStandorte" multiple class="w-full border rounded-lg px-3 py-2 text-sm" size="4">
                                    <!-- populated dynamically -->
                                </select>
                                <p class="text-[10px] text-gray-400 mt-1">Ctrl/Cmd+Klick fÃ¼r Mehrfachauswahl</p>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Bestimmte Nutzer (Beta-Tester)</label>
                                <select id="ffUsers" multiple class="w-full border rounded-lg px-3 py-2 text-sm" size="4">
                                    <!-- populated dynamically -->
                                </select>
                                <p class="text-[10px] text-gray-400 mt-1">Ctrl/Cmd+Klick fÃ¼r Mehrfachauswahl</p>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-between">
                            <button onclick="ffCloseModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-semibold text-sm">Abbrechen</button>
                            <button onclick="ffSave()" class="px-6 py-2 bg-vit-orange text-white rounded-lg font-semibold text-sm hover:opacity-90">Speichern</button>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- HQ BACKUP DASHBOARD VIEW                   -->
                <!-- ============================================ -->
                <div id="hqBackupsView" class="view" style="display:none">
                    <div class="p-6 md:p-8 max-w-7xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <p class="h2-headline text-vit-gray mb-1">HQ STEUERUNG</p>
                                <h1 class="h1-headline">ðŸ’¾ Backup Dashboard</h1>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="bkTriggerBackup()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                    Backup jetzt starten
                                </button>
                            </div>
                        </div>

                        <!-- KPIs -->
                        <div id="bkStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Letztes Backup</p>
                                <p id="bkLastTime" class="text-lg font-bold text-gray-900 mt-1">-</p>
                                <p id="bkLastStatus" class="text-xs mt-0.5">-</p>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Backups (24h)</p>
                                <p id="bkCount24h" class="text-lg font-bold text-gray-900 mt-1">-</p>
                                <p class="text-xs text-gray-400 mt-0.5">Erwartet: 24</p>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Tabellen gesichert</p>
                                <p id="bkTableCount" class="text-lg font-bold text-gray-900 mt-1">-</p>
                                <p class="text-xs text-gray-400 mt-0.5">von 15</p>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Datenvolumen (24h)</p>
                                <p id="bkSizeTotal" class="text-lg font-bold text-gray-900 mt-1">-</p>
                                <p class="text-xs text-gray-400 mt-0.5">Supabase + R2</p>
                            </div>
                        </div>

                        <!-- Health indicator -->
                        <div id="bkHealth" class="mb-6 p-4 rounded-xl border flex items-center gap-3">
                            <div id="bkHealthDot" class="w-3 h-3 rounded-full bg-gray-300"></div>
                            <span id="bkHealthText" class="text-sm font-medium text-gray-600">Status wird geladen...</span>
                        </div>

                        <!-- Backup History Table -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-4 border-b flex items-center justify-between">
                                <h3 class="font-semibold text-gray-800">Backup-Verlauf</h3>
                                <select id="bkFilterDays" onchange="loadBkView()" class="text-sm border rounded-lg px-3 py-1.5">
                                    <option value="1">Letzte 24h</option>
                                    <option value="3">Letzte 3 Tage</option>
                                    <option value="7" selected>Letzte 7 Tage</option>
                                    <option value="30">Letzte 30 Tage</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-left text-xs text-gray-500 uppercase">
                                        <tr>
                                            <th class="px-4 py-3">Zeitpunkt</th>
                                            <th class="px-4 py-3">Typ</th>
                                            <th class="px-4 py-3">Status</th>
                                            <th class="px-4 py-3">Tabellen</th>
                                            <th class="px-4 py-3">Rows</th>
                                            <th class="px-4 py-3">Groesse</th>
                                            <th class="px-4 py-3">Dauer</th>
                                            <th class="px-4 py-3">Fehler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bkTableBody" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                            <div id="bkNoData" class="p-8 text-center text-gray-400 hidden">Keine Backups im gewaehlten Zeitraum</div>
                        </div>
                    </div>
                </div>

            <!-- Video-Pipeline Modal (global) -->
            <div id="vpModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none;">
                <div id="vpModalContent" class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto p-6"></div>
            </div>
            </main>
        </div>
    </div><!-- /mainApp -->

    <script>
        // === Portal Bootstrap (legacy inline script removed) ===
        // All module code now loaded via /portal/app.js (38 ES modules)
        // Removed ~20,400 lines of duplicated inline JavaScript
        // Date: 2026-02-21
    </script>


<!-- React Pipeline Component (Babel-compiled JSX) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel" data-type="module">
/* â”€â”€ vit:bikes Deal Flow Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const { useState, useRef, useCallback, useEffect } = React;

const STAGES = [
  { id: "lead", label: "ðŸŽ¯ Leads", color: "#FF6B35", bg: "#FFF3ED", emoji: "ðŸŽ£" },
  { id: "angebot", label: "ðŸ“ Angebot", color: "#667EEA", bg: "#EBF4FF", emoji: "ðŸ’Œ" },
  { id: "schwebend", label: "â³ Schwebend", color: "#F7C948", bg: "#FFFBEA", emoji: "ðŸŽˆ" },
  { id: "verkauft", label: "ðŸŽ‰ Verkauft", color: "#38B2AC", bg: "#E6FFFA", emoji: "ðŸ†" },
  { id: "gold", label: "ðŸ—„ï¸ Schrank der Hoffnung", color: "#D69E2E", bg: "#FFFFF0", emoji: "âœ¨" },
  { id: "lost", label: "ðŸ’€ Verloren", color: "#E53E3E", bg: "#FFF5F5", emoji: "ðŸ˜­" },
];
const PIPELINE = ["lead", "angebot", "schwebend", "verkauft"];
const AGING = { lead: 3, angebot: 5, schwebend: 7 };
const AVATARS = ["ðŸ‘¤","ðŸ‘©","ðŸ‘¨","ðŸ‘©â€ðŸ’¼","ðŸ‘¨â€ðŸ’¼","ðŸ‘©â€ðŸŽ¨","ðŸ‘¨â€ðŸ”§","ðŸ‘©â€âš•ï¸","ðŸ‘¨â€ðŸ³","ðŸ‘©â€ðŸ’»","ðŸ§‘â€ðŸŽ“","ðŸ‘´"];
const ACT_TYPES = [
  { id: "call", label: "ðŸ“ž Anruf", color: "#667EEA" },
  { id: "email", label: "ðŸ“§ E-Mail", color: "#38B2AC" },
  { id: "meeting", label: "â˜• Meeting", color: "#F7C948" },
  { id: "note", label: "ðŸ“ Notiz", color: "#A0AEC0" },
  { id: "whatsapp", label: "ðŸ’¬ WhatsApp", color: "#25D366" },
];
const ACHIEVEMENTS = [
  { id: "first_sale", label: "Erster Verkauf", icon: "ðŸŒŸ", desc: "Dein erster Deal", check: s => s.sold >= 1 },
  { id: "streak3", label: "3er Streak", icon: "ðŸ”¥", desc: "3x hintereinander", check: s => s.streak >= 3 },
  { id: "streak5", label: "5er Streak", icon: "ðŸ’¥", desc: "Unstoppable!", check: s => s.streak >= 5 },
  { id: "10k", label: "10K Club", icon: "ðŸ’°", desc: "â‚¬10k Umsatz", check: s => s.rev >= 10000 },
  { id: "50k", label: "50K Club", icon: "ðŸ’Ž", desc: "â‚¬50k Umsatz", check: s => s.rev >= 50000 },
  { id: "100k", label: "100K Club", icon: "ðŸ‘‘", desc: "Legende!", check: s => s.rev >= 100000 },
  { id: "machine", label: "Deal Machine", icon: "âš™ï¸", desc: "10 Deals erstellt", check: s => s.total >= 10 },
  { id: "hot", label: "Heisse Hand", icon: "âœ‹", desc: "5x Heat 5", check: s => s.hot >= 5 },
  { id: "golddig", label: "HoffnungstrÃ¤ger", icon: "â›ï¸", desc: "3 Hoffnungs-Kontakte", check: s => s.gold >= 3 },
  { id: "active", label: "Aktiver Seller", icon: "ðŸƒ", desc: "20 AktivitÃ¤ten", check: s => s.acts >= 20 },
];
const LOCATIONS = [
  { id: "hq", label: "ðŸ¢ HQ (Alle)", isHQ: true },
  { id: "berlin", label: "ðŸ“ Berlin" },
  { id: "muenchen", label: "ðŸ“ MÃ¼nchen" },
  { id: "hamburg", label: "ðŸ“ Hamburg" },
];

const SELLERS = [
  { id: "max", name: "Max Weber", short: "MW", color: "#667EEA", loc: "berlin" },
  { id: "julia", name: "Julia Braun", short: "JB", color: "#E1306C", loc: "berlin" },
  { id: "alex", name: "Alex KrÃ¼ger", short: "AK", color: "#38B2AC", loc: "muenchen" },
  { id: "nina", name: "Nina Hoffmann", short: "NH", color: "#F7C948", loc: "muenchen" },
  { id: "tom", name: "Tom Richter", short: "TR", color: "#FF6B35", loc: "hamburg" },
];

const CELEB = ["ðŸŽ‰","ðŸ¥³","ðŸ†","ðŸ’°","ðŸ”¥","â­","ðŸŽŠ","ðŸ’Ž","ðŸ‘‘","ðŸš€"];
const GOAL = 15000;
const NOW = Date.now();
const ago = d => NOW - d * 864e5;
const fmt = v => new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(v);
const dSince = ts => Math.floor((NOW - ts) / 864e5);
const tAgo = ts => { const d = dSince(ts); return d === 0 ? "Heute" : d === 1 ? "Gestern" : `vor ${d}d`; };

const DEFAULT_RULES = [
  { id: "r1", from: "lead", to: "angebot", action: "todo", text: "Angebot nachfassen", days: 3, enabled: true, scope: "hq" },
  { id: "r2", from: "angebot", to: "schwebend", action: "todo", text: "Nachfragen ob Entscheidung gefallen", days: 5, enabled: true, scope: "hq" },
  { id: "r3", from: "lead", to: "angebot", action: "activity", actType: "note", text: "Angebot wurde erstellt", enabled: true, scope: "hq" },
  { id: "r4", from: "*", to: "verkauft", action: "todo", text: "Willkommens-Mail senden", days: 0, enabled: true, scope: "hq" },
  { id: "r5", from: "*", to: "gold", action: "todo", text: "In 30 Tagen erneut kontaktieren", days: 30, enabled: true, scope: "hq" },
  { id: "r6", from: "lead", to: "angebot", action: "activity", actType: "call", text: "Beratungstermin vereinbaren", enabled: true, scope: "berlin" },
];

const INIT = [
  { id:1, name:"Anna MÃ¼ller", value:2400, stage:"lead", avatar:"ðŸ‘©", heat:3, note:"Interesse Premium-Paket", phone:"0176 123 4567", email:"anna.mueller@mail.de", acts:[{type:"call",text:"ErstgesprÃ¤ch gefÃ¼hrt",time:ago(1)}], todos:[{text:"Angebot vorbereiten",due:ago(-1),done:false,id:"t1"}], created:ago(2), changed:ago(2), loc:"berlin", seller:"max" },
  { id:2, name:"Thomas Schmidt", value:4500, stage:"angebot", avatar:"ðŸ‘¨", heat:5, note:"Jahresabo Angebot gesendet", phone:"0151 234 5678", email:"t.schmidt@web.de", acts:[{type:"email",text:"Angebot versendet",time:ago(0)},{type:"call",text:"Nachgefasst",time:ago(2)}], todos:[{text:"Angebot nachfassen",due:ago(-2),done:false,id:"t2"}], created:ago(5), changed:ago(1), loc:"berlin", seller:"julia" },
  { id:3, name:"Sarah Weber", value:1800, stage:"schwebend", avatar:"ðŸ‘©â€ðŸ’¼", heat:4, note:"Wartet auf Partner-RÃ¼ckmeldung", phone:"0171 345 6789", email:"sarah.weber@gmail.com", acts:[{type:"meeting",text:"Beratung vor Ort",time:ago(3)}], todos:[], created:ago(8), changed:ago(3), loc:"muenchen", seller:"alex" },
  { id:4, name:"Marco Fischer", value:3200, stage:"angebot", avatar:"ðŸ‘¨â€ðŸ’¼", heat:4, note:"Vergleicht Angebote", phone:"0162 456 7890", email:"marco.fischer@outlook.de", acts:[{type:"whatsapp",text:"Nachricht gesendet",time:ago(6)}], todos:[{text:"Konkurrenzvergleich senden",due:ago(1),done:true,id:"t3"}], created:ago(10), changed:ago(6), loc:"muenchen", seller:"nina" },
  { id:5, name:"Lisa Bauer", value:950, stage:"lead", avatar:"ðŸ‘©â€ðŸŽ¨", heat:2, note:"Via Empfehlung", phone:"0157 567 8901", email:"lisa.bauer@mail.de", acts:[], todos:[], created:ago(1), changed:ago(1), loc:"hamburg", seller:"tom" },
  { id:6, name:"Peter Klein", value:5000, stage:"gold", avatar:"ðŸ‘¨â€ðŸ”§", heat:3, note:"Budget erst Q2", phone:"0173 678 9012", email:"peter.klein@gmx.de", acts:[{type:"note",text:"Meldet sich MÃ¤rz",time:ago(4)}], todos:[{text:"In 30 Tagen erneut kontaktieren",due:ago(-26),done:false,id:"t4"}], created:ago(15), changed:ago(4), loc:"hamburg", seller:"tom" },
];

/* â”€â”€ Tiny Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Particle({x,y,emoji,delay}){return <div style={{position:"fixed",left:x,top:y,fontSize:"2rem",pointerEvents:"none",zIndex:9999,animation:`fly 1.2s ease-out ${delay}s forwards`,opacity:0}}>{emoji}</div>}
function Heat({heat}){return <div style={{display:"flex",gap:2,alignItems:"center"}}>{[1,2,3,4,5].map(i=><div key={i} style={{width:7,height:7,borderRadius:"50%",background:i<=heat?(heat>=4?"#FF6B35":heat>=3?"#F7C948":"#CBD5E0"):"#E2E8F0",transition:"all .3s"}}/>)}<span style={{fontSize:9,marginLeft:3,color:"#999"}}>{heat>=4?"ðŸ”¥":heat>=3?"â˜€ï¸":"â„ï¸"}</span></div>}

function TodoBadge({todos}){
  const open = todos.filter(t => !t.done);
  if(!open.length) return null;
  const overdue = open.some(t => t.due < NOW);
  return <div style={{display:"inline-flex",alignItems:"center",gap:3,background:overdue?"#FED7D7":"#EBF4FF",color:overdue?"#C53030":"#667EEA",fontSize:10,fontWeight:700,padding:"2px 7px",borderRadius:8,fontFamily:"'Outfit',sans-serif",animation:overdue?"pulse 1.5s infinite":"none"}}>
    {overdue?"â—":"â˜‘ï¸"} {open.length}
  </div>
}

function AgingBadge({deal}){
  if(["verkauft","lost","gold"].includes(deal.stage))return null;
  const d=dSince(deal.changed),w=AGING[deal.stage]||5;
  if(d<w)return null;
  const u=d>=w*2;
  return <div style={{display:"inline-flex",alignItems:"center",gap:3,background:u?"#FED7D7":"#FEFCBF",color:u?"#C53030":"#B7791F",fontSize:10,fontWeight:700,padding:"2px 8px",borderRadius:8,animation:u?"pulse 1s infinite":"none",fontFamily:"'Outfit',sans-serif"}}>{u?"ðŸš¨":"â°"} {d}d</div>
}


/* â”€â”€ Deal Card (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Card({deal,onDrag,onClick,isNew}){
  const st=STAGES.find(s=>s.id===deal.stage);
  const d=dSince(deal.changed),w=AGING[deal.stage]||999,aging=d>=w&&!["verkauft","lost","gold"].includes(deal.stage);
  const urgent=d>=w*2;
  const openT=deal.todos.filter(t=>!t.done).length;
  const overdue=deal.todos.some(t=>!t.done&&t.due<NOW);
  const seller=SELLERS.find(s=>s.id===deal.seller);
  return <div draggable onDragStart={e=>{e.dataTransfer.setData("id",deal.id);e.dataTransfer.effectAllowed="move";onDrag(deal.id)}} onClick={()=>onClick(deal)} style={{background:"var(--c-bg)",borderRadius:12,padding:"11px 13px",cursor:"grab",borderLeft:`3px solid ${aging?(urgent?"#E53E3E":"#ECC94B"):st.color}`,boxShadow:"0 1px 3px rgba(0,0,0,.04)",transition:"all .15s",animation:isNew?"appear .4s ease":"none",userSelect:"none"}}>
    <div style={{display:"flex",alignItems:"center",gap:9,marginBottom:5}}>
      <div style={{width:30,height:30,borderRadius:9,background:st.bg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,flexShrink:0}}>{deal.avatar}</div>
      <div style={{flex:1,minWidth:0}}>
        <div style={{fontWeight:700,fontSize:13,color:"#1a202c",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{deal.name}</div>
        <div style={{fontSize:10,color:"#A0AEC0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{deal.note}</div>
      </div>
    </div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <span style={{fontWeight:800,fontSize:14,color:st.color}}>{fmt(deal.value)}</span>
      <div style={{display:"flex",alignItems:"center",gap:4}}>
        {seller&&<span style={{fontSize:9,fontWeight:700,color:seller.color,background:seller.color+"10",padding:"1px 5px",borderRadius:4}}>{seller.short}</span>}
        {openT>0&&<span style={{fontSize:9,fontWeight:700,color:overdue?"#E53E3E":"#667EEA",background:overdue?"#FED7D7":"#EBF4FF",padding:"1px 5px",borderRadius:4}}>{overdue?"â—":"â˜‘"}{openT}</span>}
        {aging&&<span style={{fontSize:9,fontWeight:700,color:urgent?"#E53E3E":"#B7791F",background:urgent?"#FED7D7":"#FEFCBF",padding:"1px 5px",borderRadius:4}}>{urgent?"ðŸš¨":"â°"}{d}d</span>}
        <div style={{display:"flex",gap:1}}>{[1,2,3,4,5].map(i=><div key={i} style={{width:5,height:5,borderRadius:"50%",background:i<=deal.heat?(deal.heat>=4?"#FF6B35":deal.heat>=2?"#F7C948":"#CBD5E0"):"#EDF2F7"}}/>)}</div>
      </div>
    </div>
  </div>
}

/* â”€â”€ Column (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Col({stage,deals,onDrop,onDrag,onClick,newId}){
  const[dg,setDg]=useState(false);
  const tv=deals.reduce((s,d)=>s+d.value,0);
  return <div onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={e=>{e.preventDefault();setDg(false);onDrop(+e.dataTransfer.getData("id"),stage.id)}} style={{flex:"1 1 0",minWidth:180,display:"flex",flexDirection:"column",gap:6,background:dg?`${stage.color}08`:"transparent",borderRadius:14,padding:8,transition:"all .2s",border:`2px dashed ${dg?stage.color:"transparent"}`}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 4px 2px"}}>
      <div style={{display:"flex",alignItems:"center",gap:6}}>
        <div style={{width:8,height:8,borderRadius:"50%",background:stage.color}}/>
        <span style={{fontWeight:700,fontSize:12,color:"#2D3748"}}>{stage.label}</span>
        <span style={{fontSize:10,fontWeight:600,color:"#A0AEC0"}}>{deals.length}</span>
      </div>
      <span style={{fontWeight:700,fontSize:11,color:stage.color}}>{fmt(tv)}</span>
    </div>
    <div style={{display:"flex",flexDirection:"column",gap:5,flex:1,minHeight:80}}>
      {deals.map(d=><Card key={d.id} deal={d} onDrag={onDrag} onClick={onClick} isNew={d.id===newId}/>)}
      {!deals.length&&<div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"#E2E8F0",fontSize:24,opacity:dg?1:.3}}>{stage.emoji}</div>}
    </div>
  </div>
}

/* â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AddModal({onClose,onAdd,currentLoc}){
  const[n,setN]=useState("");const[v,setV]=useState("");const[no,setNo]=useState("");const[ph,setPh]=useState("");const[em,setEm]=useState("");const[av,setAv]=useState("ðŸ‘¤");const[loc,setLoc]=useState(currentLoc==="hq"?"berlin":currentLoc);const[seller,setSeller]=useState("");
  const availSellers=SELLERS.filter(s=>s.loc===loc);
  const go=()=>{if(!n||!v)return;onAdd({name:n,value:+v,note:no||"Neuer Kontakt",avatar:av,heat:3,stage:"lead",phone:ph,email:em,acts:[],todos:[],created:Date.now(),changed:Date.now(),loc,seller:seller||availSellers[0]?.id||""})};
  const ip={width:"100%",padding:"10px 14px",borderRadius:12,border:"2px solid #E2E8F0",fontSize:14,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"};
  const locs=LOCATIONS.filter(l=>!l.isHQ);
  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .2s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"var(--c-bg)",borderRadius:24,padding:28,width:420,maxWidth:"92vw",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 25px 60px rgba(0,0,0,.15)",animation:"pop .3s cubic-bezier(.34,1.56,.64,1)"}}>
      <h2 style={{margin:"0 0 20px",fontFamily:"'Outfit',sans-serif",fontWeight:800,fontSize:22}}>ðŸš€ Neuer Kontakt</h2>
      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Name *</label><input style={ip} placeholder="z.B. Anna MÃ¼ller" value={n} onChange={e=>setN(e.target.value)} autoFocus/></div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Wert (â‚¬) *</label><input style={ip} type="number" placeholder="2500" value={v} onChange={e=>setV(e.target.value)}/></div>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Standort</label>
            <select value={loc} onChange={e=>{setLoc(e.target.value);setSeller("")}} style={{...ip,cursor:"pointer",background:"var(--c-bg)"}}>{locs.map(l=><option key={l.id} value={l.id}>{l.label}</option>)}</select>
          </div>
        </div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>VerkÃ¤ufer</label>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{availSellers.map(s=><div key={s.id} onClick={()=>setSeller(s.id)} style={{padding:"6px 12px",borderRadius:10,fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",background:seller===s.id?s.color+"20":"#F7FAFC",color:seller===s.id?s.color:"#A0AEC0",border:`2px solid ${seller===s.id?s.color:"transparent"}`,transition:"all .2s",display:"flex",alignItems:"center",gap:5}}>
              <span style={{width:22,height:22,borderRadius:7,background:s.color,color:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",fontSize:9,fontWeight:900}}>{s.short}</span>{s.name}
            </div>)}{!availSellers.length&&<span style={{fontSize:12,color:"#CBD5E0"}}>Kein VerkÃ¤ufer fÃ¼r diesen Standort</span>}</div>
          </div>
        </div>
        <div style={{display:"flex",gap:12}}>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Telefon</label><input style={ip} placeholder="0176 ..." value={ph} onChange={e=>setPh(e.target.value)}/></div>
          <div style={{flex:1}}><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>E-Mail</label><input style={{...ip}} type="email" placeholder="anna@mail.de" value={em} onChange={e=>setEm(e.target.value)}/></div>
        </div>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Notiz</label><input style={ip} placeholder="Interesse an..." value={no} onChange={e=>setNo(e.target.value)}/></div>
        <div><label style={{fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",display:"block",marginBottom:4}}>Avatar</label>
          <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{AVATARS.map(a=><div key={a} onClick={()=>setAv(a)} style={{width:38,height:38,borderRadius:10,border:`2px solid ${av===a?"#667EEA":"#E2E8F0"}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:19,cursor:"pointer",background:av===a?"#EBF4FF":"#fff",transform:av===a?"scale(1.1)":"scale(1)",transition:"all .2s"}}>{a}</div>)}</div>
        </div>
        <div style={{display:"flex",gap:12,marginTop:4}}>
          <button onClick={onClose} style={{flex:1,padding:"11px 18px",borderRadius:12,border:"2px solid #E2E8F0",background:"var(--c-bg)",fontSize:14,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
          <button onClick={go} style={{flex:2,padding:"11px 18px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#667EEA,#764BA2)",fontSize:14,fontWeight:700,color:"#fff",cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(102,126,234,.4)",opacity:n&&v?1:.5}}>ðŸš€ HinzufÃ¼gen</button>
        </div>
      </div>
    </div>
  </div>
}

/* â”€â”€ Verkaufsformular, Detail Modal, Auto Modal, Scores, Funnel, Badges, DropZone, App â”€â”€ */
/* â”€â”€ Verkaufsformular (2 Modi) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function SalesForm({deal,sales,seller,onClose,onUpdateDeal,mode}){
  const[form,setForm]=useState({...sales});
  const u=(k,v)=>{
    setForm(p=>({...p,[k]:v}));
    // Budget-Range â†’ Deal-Wert automatisch setzen
    if(k==="budgetRange"){
      const map={"<2k":1500,"2-3k":2500,"3-5k":4000,"5k+":6000};
      if(map[v]) onUpdateDeal(deal.id,"value",map[v]);
    }
  };
  const saveAndClose=()=>{
    // Merge: bestehende sales + form (damit Upload-Daten nicht Ã¼berschrieben werden)
    const merged = {...(deal.sales||{}), ...form};
    onUpdateDeal(deal.id,"sales",merged);
    onClose();
  };
  const isInt=mode==="interactive";

  const payOpts=["JobRad","BLS","BusinessBike","Finanzierung","Leasing/Divers","Bar/EC"];
  const bedarfFields=[
    {k:"nutzung",l:"Was machst du mit dem Fahrrad?",p:"Pendeln, Sport, Freizeit..."},
    {k:"ziel",l:"Welches Ziel verfolgst du?",p:"Fitness, MobilitÃ¤t, Spass..."},
    {k:"distanz",l:"Distanzen",p:"km pro Fahrt",half:1},
    {k:"haeufigkeit",l:"Wie oft / Woche",p:"3x / 5h",half:1},
    {k:"erfahrung",l:"E-Bike Erfahrung",p:"Noch nie, ab und zu, regelmÃ¤ssig..."},
    {k:"lagerung",l:"Lagerung & Transport",p:"Garage, Keller...",half:1},
    {k:"aufladen",l:"Wo aufladen?",p:"Zuhause, Arbeit...",half:1},
    {k:"wichtig",l:"Was ist dir am Rad wichtig?",p:"Komfort, Design, Reichweite..."},
    {k:"dreiPunkte",l:"3 Punkte damit du heute kaufst?",p:"1. ... 2. ... 3. ...",big:1},
    {k:"budget",l:"Budget",p:"â‚¬ â€“ Wie kam es zustande?",half:1},
    {k:"zeitrahmen",l:"Wann einsatzfÃ¤hig?",p:"Sofort, nÃ¤chste Woche...",half:1},
  ];
  const ergoFields=[{k:"sattelhoehe",l:"SattelhÃ¶he"},{k:"sattelversatz",l:"Sattelversatz"},{k:"abstandLenker",l:"Sattel-Lenker"},{k:"lenkerhoehe",l:"LenkerhÃ¶he"},{k:"sitzknochen",l:"Sitzknochen"},{k:"griffgroesse",l:"GriffgrÃ¶sse"}];
  const checkFields=[{k:"todoZubehoer",l:"ZubehÃ¶rteile bestellt"},{k:"todoRadBestellt",l:"Fahrrad bestellt / lagernd"},{k:"todoKiste",l:"Kiste gepackt"},{k:"todoLeasing",l:"Leasing-Anfrage gestellt"},{k:"todoFinanzierung",l:"Finanzierung: Unterlagen kopiert"},{k:"todoWertgarantie",l:"Wertgarantie"}];

  // â”€â”€ Print version: open in new window â”€â”€
  const doPrint=()=>{
    const w=window.open("","_blank","width=800,height=1100");
    w.document.write(`<html><head><title>Fahrradberatung â€“ ${deal.name}</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;color:#1a1a1a}
      body{padding:36px 44px;max-width:780px;margin:0 auto}
      .hdr{border-bottom:3px solid #f60;padding-bottom:10px;margin-bottom:16px}
      .hdr h1{font-size:20px;font-weight:700}
      .hdr .sub{font-size:10px;color:#999;margin-top:2px}
      .meta{display:flex;gap:24px;margin-bottom:14px;font-size:11px}
      .meta b{font-weight:700}
      .pay-row{display:flex;gap:5px;margin-bottom:16px;flex-wrap:wrap}
      .pill{padding:3px 12px;border:1.5px solid #ccc;border-radius:5px;font-size:10px;font-weight:600}
      .pill.on{background:#333;color:#fff;border-color:#333}
      .sec{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#f60;margin:16px 0 8px;padding-bottom:3px;border-bottom:2px solid #f60}
      .f{margin-bottom:8px}
      .fl{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:#999;margin-bottom:1px}
      .fv{min-height:22px;border-bottom:1px solid #ccc;padding:2px 0;font-size:11px;line-height:1.6}
      .fv:empty::after{content:' ';white-space:pre}
      .g2{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px}
      .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px 16px}
      .chk{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:10px}
      .box{width:11px;height:11px;border:1.5px solid #888;border-radius:2px;display:inline-block}
      .ft{margin-top:24px;text-align:center;font-size:8px;color:#bbb;border-top:1px solid #eee;padding-top:6px}
      @media print{.np{display:none!important}body{padding:20px 28px}}

        
    </style></head><body>
    <div class="hdr"><h1>FAHRRADBERATUNG</h1><div class="sub">vit:bikes Â· ${new Date().toLocaleDateString("de-DE")}</div></div>
    <div class="meta"><span><b>Kunde:</b> ________________________________</span><span><b>Datum:</b> ___________</span><span><b>VerkÃ¤ufer:</b> ____________________</span></div>
    <div class="pay-row">${payOpts.map(p=>`<span class="pill">${p}</span>`).join("")}</div>
    <div class="sec">Bedarfsanalyse</div>
    ${bedarfFields.map(f=>`<div class="f"><div class="fl">${f.l}</div><div class="fv"></div></div>`).join("")}
    <div class="sec">Ergodaten</div>
    <div style="margin-bottom:6px"><span class="pill">Bodyscanner</span> <span class="pill">Smartfit</span></div>
    <div class="g3">${ergoFields.map(f=>`<div class="f"><div class="fl">${f.l}</div><div class="fv"></div></div>`).join("")}</div>
    <div class="sec">Gekauftes Rad</div>
    <div class="f"><div class="fv" style="min-height:28px"></div></div>
    <div class="g2"><div class="f"><div class="fl">Nr. Teilekiste</div><div class="fv"></div></div><div class="f"><div class="fl">Nr. Auftrag</div><div class="fv"></div></div></div>
    <div class="sec">Nach dem Kauf</div>
    ${checkFields.map(c=>`<div class="chk"><span class="box"></span> ${c.l}</div>`).join("")}
    <div class="ft">vit:bikes Â· Fahrradberatung</div>
    <div class="np" style="text-align:center;margin-top:20px"><button onclick="window.print()" style="padding:12px 40px;font-size:14px;font-weight:700;cursor:pointer;border:none;background:#f60;color:#fff;border-radius:8px">Drucken</button></div>

</body></html>`);w.document.close()};

  // â”€â”€ Print mode: just trigger print and close â”€â”€
  if(!isInt){doPrint();onClose();return null}

  // â”€â”€ Interactive mode: minimal clean â”€â”€
  const ip={width:"100%",padding:"10px 14px",borderRadius:12,border:"1.5px solid #E8E8E8",fontSize:14,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",background:"var(--c-bg)"};
  const T=({on,onClick,children,c})=><div onClick={onClick} style={{padding:"11px 18px",borderRadius:12,fontSize:14,fontWeight:600,cursor:"pointer",background:on?(c||"#1a202c"):"#fff",color:on?"#fff":"#666",border:`1.5px solid ${on?(c||"#1a202c"):"#E8E8E8"}`,transition:"all .12s",userSelect:"none"}}>{children}</div>;
  const Sin=({k,opts,c})=><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{opts.map(o=><T key={o.id||o} on={form[k]===(o.id||o)} c={c} onClick={()=>u(k,form[k]===(o.id||o)?"":(o.id||o))}>{o.label||o}</T>)}</div>;
  const Mul=({k,opts,c})=><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{opts.map(o=>{const id=o.id||o;const cur=form[k]||[];const on=Array.isArray(cur)&&cur.includes(id);return <T key={id} on={on} c={c} onClick={()=>u(k,on?cur.filter(x=>x!==id):[...(Array.isArray(cur)?cur:[]),id])}>{o.label||o}</T>})}</div>;
  const Q=({q,sub,children})=><div style={{marginBottom:32}}><div style={{fontSize:16,fontWeight:700,color:"#1a202c",marginBottom:sub?4:10}}>{q}</div>{sub&&<div style={{fontSize:12,color:"#999",marginBottom:10}}>{sub}</div>}{children}</div>;

  return <div onClick={e=>{e.stopPropagation();saveAndClose()}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,animation:"fadeIn .1s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"#FAFAFA",borderRadius:24,width:540,maxWidth:"96vw",maxHeight:"94vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 24px 80px rgba(0,0,0,.1)",animation:"pop .2s ease"}}>

      <div style={{padding:"20px 28px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0}}>
        <div><div style={{fontWeight:800,fontSize:20,color:"#1a202c"}}>Beratung</div><div style={{fontSize:12,color:"#999",marginTop:2}}>{deal.name}</div></div>
        <button onClick={e=>{e.stopPropagation();saveAndClose()}} style={{width:36,height:36,borderRadius:10,border:"none",background:"#EFEFEF",fontSize:16,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#999"}}>âœ•</button>
      </div>

      <div style={{padding:"0 28px 28px",overflowY:"auto",flex:1}}>

        <Q q="Bezahlart"><Sin k="payment" opts={payOpts}/></Q>

        <Q q="WofÃ¼r brauchst du das Rad?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="nutzungTags" opts={[{id:"pendeln",label:"Pendeln"},{id:"sport",label:"Sport"},{id:"freizeit",label:"Freizeit"},{id:"transport",label:"Transport"},{id:"kinder",label:"Kinder"},{id:"offroad",label:"Offroad"},{id:"stadt",label:"Stadt"},{id:"reisen",label:"Reisen"}]}/>
        </Q>

        <Q q="Welche Strecken?"><Sin k="distanz" opts={[{id:"kurz",label:"< 5 km"},{id:"mittel",label:"5â€“15 km"},{id:"weit",label:"15â€“30 km"},{id:"lang",label:"30+ km"}]}/></Q>

        <Q q="Wie oft pro Woche?"><Sin k="haeufigkeit" opts={[{id:"selten",label:"Selten"},{id:"1-2x",label:"1â€“2Ã—"},{id:"3-5x",label:"3â€“5Ã—"},{id:"tÃ¤glich",label:"TÃ¤glich"}]}/></Q>

        <Q q="E-Bike Erfahrung?"><Sin k="erfahrung" opts={[{id:"keine",label:"Keine"},{id:"wenig",label:"Mal getestet"},{id:"mittel",label:"Gelegentlich"},{id:"viel",label:"RegelmÃ¤ssig"}]}/></Q>

        <Q q="Wo steht das Rad?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="lagerungTags" opts={[{id:"garage",label:"Garage"},{id:"keller",label:"Keller"},{id:"wohnung",label:"Wohnung"},{id:"draussen",label:"Draussen"},{id:"arbeit",label:"Arbeit"}]}/>
        </Q>

        <Q q="Was ist dir wichtig?" sub="Mehrfachauswahl mÃ¶glich">
          <Mul k="wichtigTags" opts={[{id:"komfort",label:"Komfort"},{id:"reichweite",label:"Reichweite"},{id:"speed",label:"Speed"},{id:"design",label:"Design"},{id:"leicht",label:"Leicht"},{id:"robust",label:"Robust"},{id:"preis",label:"Preis-Leistung"},{id:"motor",label:"Starker Motor"},{id:"leise",label:"Leiser Motor"}]} c="#667EEA"/>
        </Q>

        <Q q="3 Dinge, damit du heute kaufst?">
          {(()=>{const[v,setV]=useState("");const items=form.dreiPunkteList||[];const add=()=>{if(!v.trim()||items.length>=3)return;u("dreiPunkteList",[...items,v.trim()]);setV("")};
          return <div>
            {items.map((t,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:12,background:"#1a202c",color:"#fff",fontSize:14,fontWeight:600,marginBottom:6}}>
              <span style={{width:24,height:24,borderRadius:8,background:"rgba(255,255,255,.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:800,flexShrink:0}}>{i+1}</span>
              <span style={{flex:1}}>{t}</span>
              <span onClick={()=>u("dreiPunkteList",items.filter((_,j)=>j!==i))} style={{cursor:"pointer",opacity:.5}}>âœ•</span>
            </div>)}
            {items.length<3&&<input value={v} onChange={e=>setV(e.target.value)} placeholder={`Punkt ${items.length+1} eingeben...`} onKeyDown={e=>{if(e.key==="Enter")add()}} style={ip}/>}
          </div>})()}
        </Q>

        <Q q="Budget">
          <Sin k="budgetRange" opts={[{id:"<2k",label:"< 2.000 â‚¬"},{id:"2-3k",label:"2â€“3.000 â‚¬"},{id:"3-5k",label:"3â€“5.000 â‚¬"},{id:"5k+",label:"5.000+ â‚¬"}]}/>
          <input value={form.budget||""} onChange={e=>u("budget",e.target.value)} placeholder="Details..." style={{...ip,marginTop:8}}/>
        </Q>

        <Q q="Wann brauchst du es?"><Sin k="zeitrahmen" opts={[{id:"sofort",label:"Sofort"},{id:"2-4w",label:"2â€“4 Wochen"},{id:"flexibel",label:"Flexibel"}]}/></Q>

        <Q q="Ergonomie">
          <div style={{display:"flex",gap:8,marginBottom:12}}>{["Bodyscanner","Smartfit"].map(m=><T key={m} on={form.ergoMethod===m} onClick={()=>u("ergoMethod",form.ergoMethod===m?"":m)}>{m}</T>)}</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
            {ergoFields.map(f=><input key={f.k} value={form[f.k]||""} onChange={e=>u(f.k,e.target.value)} placeholder={f.l} style={{...ip,fontSize:12,padding:"8px 10px",textAlign:"center"}}/>)}
          </div>
        </Q>

        <Q q="Abschluss">
          <input value={form.gekauftesRad||""} onChange={e=>u("gekauftesRad",e.target.value)} placeholder="Gekauftes Rad" style={{...ip,marginBottom:8,fontWeight:600}}/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}}>
            <input value={form.nrTeilekiste||""} onChange={e=>u("nrTeilekiste",e.target.value)} placeholder="Nr. Teilekiste" style={{...ip,fontSize:12}}/>
            <input value={form.nrAuftrag||""} onChange={e=>u("nrAuftrag",e.target.value)} placeholder="Nr. Auftrag" style={{...ip,fontSize:12}}/>
          </div>
          {checkFields.map(c=><div key={c.k} onClick={()=>u(c.k,!form[c.k])} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:12,background:form[c.k]?"#E6FFFA":"#fff",border:`1.5px solid ${form[c.k]?"#38B2AC":"#E8E8E8"}`,cursor:"pointer",marginBottom:6}}>
            <div style={{width:22,height:22,borderRadius:7,border:`2px solid ${form[c.k]?"#38B2AC":"#ccc"}`,background:form[c.k]?"#38B2AC":"#fff",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all .1s"}}>{form[c.k]&&<span style={{color:"#fff",fontSize:12,fontWeight:900}}>âœ“</span>}</div>
            <span style={{fontSize:13,fontWeight:600,color:form[c.k]?"#1a202c":"#888"}}>{c.l}</span>
          </div>)}
        </Q>
      </div>

      <div style={{padding:"14px 28px",borderTop:"1px solid #EFEFEF",flexShrink:0}}>
        <button onClick={e=>{e.stopPropagation();saveAndClose()}} style={{width:"100%",padding:"12px",borderRadius:12,border:"none",background:"#1a202c",color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer"}}>Speichern</button>
      </div>
    </div>
  </div>
}

/* â”€â”€ Detail Modal (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SOURCES=["Empfehlung","Google","Instagram","Facebook","Messe","Walk-In","Website","Flyer","TikTok","Andere"];
const LEASING_PROVIDERS=["JobRad","BLS (Bikeleasing-Service)","BusinessBike","Leasing/Divers"];
const PAY_METHODS=[{id:"Bar/EC",icon:"ðŸ’¶"},{id:"Finanzierung",icon:"ðŸ¦"},{id:"Leasing",icon:"ðŸ“‹"}];

/* â”€â”€ Scan Upload Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function ScanUploadModal({deal,sales,onClose,onUpdateDeal}){
  const[file,setFile]=useState(null);
  const[preview,setPreview]=useState(null);
  const[loading,setLoading]=useState(false);
  const[error,setError]=useState(null);
  const[parsed,setParsed]=useState(null); // KI-erkannte Werte
  const[editData,setEditData]=useState(null); // Bearbeitbare Felder
  const fileRef=useRef(null);

  const FIELD_LABELS={
    payment:"Bezahlart",nutzung:"Nutzung",ziel:"Ziel",distanz:"Distanzen",haeufigkeit:"HÃ¤ufigkeit",
    erfahrung:"E-Bike Erfahrung",lagerung:"Lagerung",aufladen:"Aufladen",zeitrahmen:"Zeitrahmen",
    wichtig:"Wichtig am Rad",budget:"Budget",akku:"Akku-Ladezeit",dreiPunkte:"3 Kaufkriterien",
    einwaende:"EinwÃ¤nde",next:"NÃ¤chster Schritt",notizen:"Notizen",
    ergoMethod:"Ergonomie-Methode",sattelhoehe:"SattelhÃ¶he",sattelversatz:"Sattelversatz",
    abstandLenker:"Abstand Sattel-Lenker",lenkerhoehe:"LenkerhÃ¶he",sitzknochen:"Sitzknochen",griffgroesse:"GriffgrÃ¶sse",
    gekauftesRad:"Gekauftes Rad",nrTeilekiste:"Nr. Teilekiste",nrAuftrag:"Nr. Auftrag",
    todoZubehoer:"ZubehÃ¶rteile bestellt",todoRadBestellt:"Rad bestellt/lagernd",todoKiste:"Kiste gepackt",
    todoLeasing:"Leasing-Anfrage gestellt",todoFinanzierung:"Finanzierung: Unterlagen",todoWertgarantie:"Wertgarantie",
    nutzungTags:"Nutzungs-Tags",lagerungTags:"Lagerungs-Tags",wichtigTags:"Wichtig-Tags",
    budgetRange:"Budget-Bereich",dreiPunkteList:"3-Punkte-Liste"
  };

  const handleFile=(f)=>{
    if(!f)return;
    setFile(f);setError(null);setParsed(null);setEditData(null);
    const reader=new FileReader();
    reader.onload=e=>setPreview(e.target.result);
    reader.readAsDataURL(f);
  };

  const handleDrop=(e)=>{e.preventDefault();e.stopPropagation();const f=e.dataTransfer?.files?.[0];if(f)handleFile(f)};

  const analyze=async()=>{
    if(!preview)return;
    setLoading(true);setError(null);
    try{
      const base64=preview.split(",")[1];
      const mediaType=file.type||"image/jpeg";

      // Scan-Analyse via Supabase Edge Function (API-Key liegt sicher auf dem Server)
      const session=await window.sb.auth.getSession();
      const token=session?.data?.session?.access_token;
      const supabaseUrl=window.sb?.supabaseUrl||SUPABASE_URL||"";
      const supabaseKey=window.sb?.supabaseKey||SUPABASE_ANON_KEY||"";

      const resp=await fetch(supabaseUrl+"/functions/v1/analyze-scan",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+(token||""),
          "apikey":supabaseKey
        },
        body:JSON.stringify({
          image_base64:base64,
          media_type:mediaType
        })
      });

      if(!resp.ok){
        const errBody=await resp.json().catch(()=>({}));
        throw new Error(errBody.error||`Fehler ${resp.status}`);
      }

      const data=await resp.json();
      const result=data.fields||{};
      setParsed(result);

      // Merge: bestehende sales haben Vorrang, gescannte Werte fÃ¼llen LÃ¼cken
      const existing=deal.sales||{};
      const merged={};
      for(const[k,v] of Object.entries(result)){
        if(v===null||v===undefined||v==="")continue;
        merged[k]=v;
      }
      // Overlay: bestehende Werte Ã¼berschreiben gescannte (digitale Eingaben haben Vorrang)
      for(const[k,v] of Object.entries(existing)){
        if(v!==null&&v!==undefined&&v!==""&&v!==false&&!(Array.isArray(v)&&v.length===0)){
          merged[k]=v;
        }
      }
      setEditData(merged);

    }catch(err){
      console.error("Scan analysis error:",err);
      setError(err.message||"Analyse fehlgeschlagen");
    }finally{
      setLoading(false);
    }
  };

  const updateField=(k,v)=>setEditData(p=>({...p,[k]:v}));

  const saveAll=()=>{
    if(!editData)return;
    // Merge with whatever is already saved
    const current=deal.sales||{};
    const final={...current,...editData};
    onUpdateDeal(deal.id,"sales",final);
    // Update deal value from budgetRange if present
    if(editData.budgetRange){
      const map={"<2k":1500,"2-3k":2500,"3-5k":4000,"5k+":6000};
      if(map[editData.budgetRange])onUpdateDeal(deal.id,"value",map[editData.budgetRange]);
    }
    onClose();
  };

  const ip={width:"100%",padding:"8px 12px",borderRadius:10,border:"1.5px solid #E2E8F0",fontSize:13,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",background:"var(--c-bg)"};

  return <div onClick={e=>{e.stopPropagation();onClose()}} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.5)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2000,animation:"fadeIn .15s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"var(--c-bg)",borderRadius:24,width:560,maxWidth:"96vw",maxHeight:"94vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 24px 80px rgba(0,0,0,.12)",animation:"pop .25s ease"}}>

      {/* Header */}
      <div style={{padding:"20px 28px 14px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #F0F0F0"}}>
        <div>
          <div style={{fontWeight:800,fontSize:18,color:"#1a202c"}}>ðŸ“· Formular-Scan</div>
          <div style={{fontSize:11,color:"#A0AEC0",marginTop:2}}>{deal.name} â€“ Beratungsformular einscannen & analysieren</div>
        </div>
        <button onClick={onClose} style={{width:34,height:34,borderRadius:10,border:"none",background:"#F5F5F5",fontSize:15,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#999"}}>âœ•</button>
      </div>

      {/* Content */}
      <div style={{padding:"20px 28px",overflowY:"auto",flex:1}}>

        {/* Step 1: Upload */}
        {!editData&&<>
          <input ref={fileRef} type="file" accept="image/*,.pdf" style={{display:"none"}} onChange={e=>handleFile(e.target.files[0])}/>

          {!preview&&<div
            onClick={()=>fileRef.current?.click()}
            onDragOver={e=>{e.preventDefault();e.stopPropagation()}}
            onDrop={handleDrop}
            style={{border:"2px dashed #E2E8F0",borderRadius:16,padding:"48px 24px",textAlign:"center",cursor:"pointer",transition:"all .2s",background:"#FAFAFA"}}
            onMouseOver={e=>e.currentTarget.style.borderColor="#FF6B35"}
            onMouseOut={e=>e.currentTarget.style.borderColor="#E2E8F0"}
          >
            <div style={{fontSize:48,marginBottom:12}}>ðŸ“„</div>
            <div style={{fontWeight:700,fontSize:15,color:"#2D3748",marginBottom:4}}>Formular hochladen</div>
            <div style={{fontSize:12,color:"#A0AEC0"}}>Foto oder Scan per Klick oder Drag & Drop</div>
            <div style={{fontSize:11,color:"#CBD5E0",marginTop:8}}>JPG, PNG, PDF</div>
          </div>}

          {preview&&<div style={{marginBottom:20}}>
            <div style={{position:"relative",borderRadius:14,overflow:"hidden",border:"1px solid #E2E8F0",marginBottom:14}}>
              <img src={preview} alt="Scan" style={{width:"100%",maxHeight:300,objectFit:"contain",background:"#F9FAFB"}}/>
              <button onClick={()=>{setFile(null);setPreview(null);setError(null)}} style={{position:"absolute",top:8,right:8,width:28,height:28,borderRadius:8,border:"none",background:"rgba(0,0,0,.6)",color:"#fff",fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
            </div>
            <div style={{fontSize:11,color:"#A0AEC0",marginBottom:12}}>ðŸ“ {file?.name} ({(file?.size/1024).toFixed(0)} KB)</div>

            {error&&<div style={{padding:"10px 14px",borderRadius:10,background:"#FFF5F5",border:"1px solid #FED7D7",color:"#C53030",fontSize:12,fontWeight:600,marginBottom:12}}>âš ï¸ {error}</div>}

            <button onClick={analyze} disabled={loading} style={{width:"100%",padding:"14px",borderRadius:12,border:"none",background:loading?"#A0AEC0":"linear-gradient(135deg,#FF6B35,#E55D2B)",color:"#fff",fontSize:14,fontWeight:700,cursor:loading?"wait":"pointer",fontFamily:"'Outfit',sans-serif",opacity:loading?.7:1,boxShadow:"0 4px 15px rgba(255,107,53,.3)"}}>
              {loading?<span>â³ KI analysiert Formular...</span>:<span>ðŸ¤– Mit KI analysieren</span>}
            </button>
          </div>}

          {loading&&<div style={{padding:20,textAlign:"center"}}>
            <div style={{display:"inline-flex",gap:6,marginBottom:10}}>{[0,1,2].map(i=><div key={i} style={{width:10,height:10,borderRadius:"50%",background:"#FF6B35",animation:`pulse 1s infinite ${i*.2}s`}}/>)}</div>
            <div style={{fontSize:13,color:"#718096",fontWeight:600}}>Handschrift wird erkannt...</div>
            <div style={{fontSize:11,color:"#A0AEC0",marginTop:4}}>Dies kann einige Sekunden dauern</div>
          </div>}
        </>}

        {/* Step 2: Voransicht & Bearbeiten */}
        {editData&&<div>
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:16,padding:"10px 14px",borderRadius:10,background:"#F0FFF4",border:"1px solid #C6F6D5"}}>
            <span style={{fontSize:20}}>âœ…</span>
            <div>
              <div style={{fontWeight:700,fontSize:13,color:"#22543D"}}>Analyse abgeschlossen</div>
              <div style={{fontSize:11,color:"#48BB78"}}>{Object.keys(editData).filter(k=>editData[k]!==null&&editData[k]!==undefined&&editData[k]!=="").length} Felder erkannt â€“ prÃ¼fe & ergÃ¤nze die Werte</div>
            </div>
          </div>

          {/* Show which fields came from existing digital data */}
          {Object.keys(deal.sales||{}).length>0&&<div style={{padding:"8px 12px",borderRadius:8,background:"#EBF4FF",border:"1px solid #BEE3F8",fontSize:11,color:"#2B6CB0",fontWeight:600,marginBottom:14}}>
            â„¹ï¸ Bestehende Daten aus der digitalen Beratung wurden beibehalten
          </div>}

          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            {Object.entries(editData).filter(([k,v])=>v!==null&&v!==undefined).map(([k,v])=>{
              const label=FIELD_LABELS[k]||k;
              const isFromExisting=sales[k]!==undefined&&sales[k]!==null&&sales[k]!==""&&sales[k]!==false;
              const isBoolean=typeof v==="boolean";
              const isArray=Array.isArray(v);

              return <div key={k} style={{padding:"10px 14px",borderRadius:12,background:isFromExisting?"#F0F7FF":"#FAFAFA",border:`1px solid ${isFromExisting?"#BEE3F8":"#EDF2F7"}`}}>
                <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}>
                  <span style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em"}}>{label}</span>
                  {isFromExisting&&<span style={{fontSize:8,fontWeight:700,background:"#667EEA",color:"#fff",padding:"1px 5px",borderRadius:4}}>DIGITAL</span>}
                  {!isFromExisting&&parsed?.[k]&&<span style={{fontSize:8,fontWeight:700,background:"#FF6B35",color:"#fff",padding:"1px 5px",borderRadius:4}}>SCAN</span>}
                </div>
                {isBoolean?
                  <div onClick={()=>updateField(k,!v)} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer"}}>
                    <div style={{width:20,height:20,borderRadius:6,border:`2px solid ${v?"#38B2AC":"#CBD5E0"}`,background:v?"#38B2AC":"#fff",display:"flex",alignItems:"center",justifyContent:"center"}}>{v&&<span style={{color:"#fff",fontSize:11,fontWeight:900}}>âœ“</span>}</div>
                    <span style={{fontSize:12,fontWeight:600,color:v?"#2D3748":"#A0AEC0"}}>{v?"Ja":"Nein"}</span>
                  </div>
                :isArray?
                  <input value={v.join(", ")} onChange={e=>updateField(k,e.target.value.split(",").map(s=>s.trim()).filter(Boolean))} style={ip}/>
                :
                  <input value={v||""} onChange={e=>updateField(k,e.target.value)} style={ip}/>
                }
              </div>
            })}
          </div>

          {/* Option to re-scan */}
          <button onClick={()=>{setParsed(null);setEditData(null);setFile(null);setPreview(null)}} style={{marginTop:14,padding:"8px 14px",borderRadius:8,border:"1px solid #E2E8F0",background:"var(--c-bg)",fontSize:11,fontWeight:600,color:"#718096",cursor:"pointer",width:"100%"}}>
            ðŸ“· Anderen Scan hochladen
          </button>
        </div>}
      </div>

      {/* Footer */}
      <div style={{padding:"14px 28px",borderTop:"1px solid #F0F0F0",display:"flex",gap:10}}>
        <button onClick={onClose} style={{flex:1,padding:"12px",borderRadius:12,border:"2px solid #E2E8F0",background:"var(--c-bg)",fontSize:13,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
        {editData&&<button onClick={saveAll} style={{flex:2,padding:"12px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#FF6B35,#E55D2B)",color:"#fff",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(255,107,53,.3)"}}>âœ… Werte Ã¼bernehmen</button>}
      </div>
    </div>
  </div>
}

function DetailModal({deal,onClose,onAct,onHeat,onToggleTodo,onAddTodo,onUpdateDeal,onChangeStage}){
  const[tab,setTab]=useState("overview");
  const[at,setAt]=useState("call");const[tx,setTx]=useState("");
  const[todoTx,setTodoTx]=useState("");const[todoDays,setTodoDays]=useState(3);
  const[ef,setEf]=useState(null);const[ev,setEv]=useState("");
  const[showForm,setShowForm]=useState(null); // null | "interactive" | "print"
  const st=STAGES.find(s=>s.id===deal.stage);
  const sales=deal.sales||{};const seller=SELLERS.find(s=>s.id===deal.seller);
  const openT=deal.todos.filter(t=>!t.done).length;

  const sav=(f,v)=>{onUpdateDeal(deal.id,f,v);setEf(null)};
  const uS=(k,v)=>onUpdateDeal(deal.id,"sales",{...sales,[k]:v});
  const goAct=()=>{if(!tx.trim())return;onAct(deal.id,{type:at,text:tx.trim(),time:Date.now()});setTx("")};
  const goTodo=()=>{if(!todoTx.trim())return;onAddTodo(deal.id,{text:todoTx.trim(),due:Date.now()+todoDays*864e5,done:false,id:"t"+Date.now()});setTodoTx("")};

  const Edt=({f,v,ph,tp,sx})=>{
    if(ef===f)return <input value={ev} onChange={e=>setEv(e.target.value)} type={tp||"text"} autoFocus
      onKeyDown={e=>{if(e.key==="Enter")sav(f,tp==="number"?+ev:ev);if(e.key==="Escape")setEf(null)}}
      onBlur={()=>sav(f,tp==="number"?+ev:ev)}
      style={{padding:"4px 8px",borderRadius:6,border:"1.5px solid #667EEA",fontSize:"inherit",fontFamily:"inherit",outline:"none",background:"#EBF4FF",width:"100%",boxSizing:"border-box",...sx}}/>;
    return <span onClick={()=>{setEf(f);setEv(v||"")}} style={{cursor:"pointer",borderBottom:"1px dashed #E2E8F0",...sx}}>{v||<span style={{color:"#CBD5E0"}}>{ph}</span>}</span>
  };

  const Lbl=({children})=><div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".06em",marginBottom:6}}>{children}</div>;
  const Chip=({on,color,onClick,children})=><div onClick={onClick} style={{padding:"5px 11px",borderRadius:8,fontSize:11,fontWeight:600,cursor:"pointer",background:on?(color||"#667EEA"):on===false?"#F7FAFC":"#F7FAFC",color:on?"#fff":"#718096",transition:"all .12s"}}>{children}</div>;

  const tabList=[{id:"overview",l:"Ãœbersicht"},{id:"sales",l:"GesprÃ¤ch"},{id:"log",l:"Log",n:deal.acts.length},{id:"todos",l:"Todos",n:openT}];

  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.3)",backdropFilter:"blur(5px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .15s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"var(--c-bg)",borderRadius:18,width:560,maxWidth:"94vw",maxHeight:"88vh",display:"flex",flexDirection:"column",boxShadow:"0 16px 48px rgba(0,0,0,.1)",animation:"pop .2s cubic-bezier(.34,1.56,.64,1)",overflow:"hidden"}}>

      {/* â”€â”€ Header â”€â”€ */}
      <div style={{padding:"20px 24px 14px",background:`linear-gradient(135deg,${st.color}08,${st.color}03)`}}>
        <div style={{display:"flex",gap:12,alignItems:"flex-start"}}>
          <div style={{width:44,height:44,borderRadius:12,background:"var(--c-bg)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0,boxShadow:"0 1px 4px rgba(0,0,0,.06)"}}>{deal.avatar}</div>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontWeight:800,fontSize:17,color:"#1a202c"}}><Edt f="name" v={deal.name} ph="Name"/></div>
            <div style={{fontSize:12,color:"#718096",marginTop:1}}><Edt f="note" v={deal.note} ph="Notiz..."/></div>
          </div>
          <div style={{textAlign:"right",flexShrink:0}}>
            <div style={{fontWeight:800,fontSize:18,color:st.color}}><Edt f="value" v={String(deal.value)} tp="number" sx={{textAlign:"right",fontWeight:800,fontSize:16,width:100}}/>{ef!=="value"&&" â‚¬"}</div>
            <select value={deal.stage} onChange={e=>onChangeStage(deal.id,deal.stage,e.target.value)} style={{marginTop:3,padding:"3px 8px",borderRadius:7,border:"none",fontSize:10,fontWeight:700,color:st.color,background:st.bg,cursor:"pointer",outline:"none"}}>{STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
          </div>
        </div>
        <div style={{display:"flex",gap:6,marginTop:10,flexWrap:"wrap",alignItems:"center",fontSize:11,color:"#718096"}}>
          <span style={{background:"var(--c-bg)",borderRadius:6,padding:"3px 8px",border:"1px solid #F0F0F0"}}>ðŸ“ž <Edt f="phone" v={deal.phone} ph="Telefon" sx={{fontSize:11}}/></span>
          <span style={{background:"var(--c-bg)",borderRadius:6,padding:"3px 8px",border:"1px solid #F0F0F0"}}>ðŸ“§ <Edt f="email" v={deal.email} ph="E-Mail" sx={{fontSize:11}}/></span>
          {seller&&<span style={{background:seller.color+"10",color:seller.color,borderRadius:6,padding:"3px 8px",fontWeight:700,fontSize:10}}>{seller.short} {seller.name.split(" ")[0]}</span>}
          <span style={{marginLeft:"auto",fontSize:10,color:"#CBD5E0"}}>{tAgo(deal.created)}</span>
        </div>
      </div>

      {/* â”€â”€ Tabs â”€â”€ */}
      <div style={{display:"flex",borderBottom:"1px solid #F0F0F0",padding:"0 24px"}}>
        {tabList.map(t=><div key={t.id} onClick={()=>setTab(t.id)} style={{padding:"10px 14px",fontSize:12,fontWeight:tab===t.id?700:600,cursor:"pointer",color:tab===t.id?"#667EEA":"#A0AEC0",borderBottom:tab===t.id?"2px solid #667EEA":"2px solid transparent",transition:"all .12s"}}>{t.l}{t.n>0?<span style={{marginLeft:4,fontSize:9,background:tab===t.id?"#667EEA":"#EDF2F7",color:tab===t.id?"#fff":"#A0AEC0",padding:"1px 5px",borderRadius:8,fontWeight:700}}>{t.n}</span>:""}</div>)}
      </div>

      {/* â”€â”€ Content â”€â”€ */}
      <div style={{padding:24,overflowY:"auto",flex:1}}>

        {tab==="overview"&&<div style={{display:"grid",gap:20}}>

          {/* Beratungs-Summary â€“ das Wichtigste zuerst */}
          <div style={{background:"#F8F9FB",borderRadius:10,padding:14}}>
            <Lbl>Beratung auf einen Blick</Lbl>
            <div style={{display:"grid",gap:8}}>
              {[{k:"nutzung",l:"ðŸš² Nutzung",ph:"Was macht der Kunde mit dem Rad?"},{k:"ziel",l:"ðŸŽ¯ Ziel",ph:"Welches Ziel?"},{k:"budget",l:"ðŸ’¶ Budget",ph:"Was kann investiert werden?"},{k:"next",l:"ðŸ‘£ NÃ¤chster Schritt",ph:"Was wurde vereinbart?"},{k:"einwaende",l:"âš ï¸ EinwÃ¤nde",ph:"Bedenken?"}].map(f=>{
                const val=sales[f.k];
                return <div key={f.k} style={{display:"flex",gap:8,alignItems:"flex-start"}}>
                  <span style={{fontSize:11,fontWeight:700,color:"#718096",minWidth:110,paddingTop:2}}>{f.l}</span>
                  <div style={{flex:1,fontSize:12,color:val?"#2D3748":"#CBD5E0",fontWeight:val?600:400,lineHeight:1.4,cursor:"pointer",borderBottom:"1px dashed #EDF2F7",padding:"2px 0"}} onClick={()=>setTab("sales")}>{val||f.ph}</div>
                </div>
              })}
              {sales.gekauftesRad&&<div style={{display:"flex",gap:8,alignItems:"flex-start"}}>
                <span style={{fontSize:11,fontWeight:700,color:"#718096",minWidth:110,paddingTop:2}}>ðŸš² Rad</span>
                <span style={{fontSize:12,fontWeight:600,color:"#2D3748"}}>{sales.gekauftesRad}</span>
              </div>}
              {(sales.distanz||sales.haeufigkeit||sales.zeitrahmen)&&<div style={{display:"flex",gap:12,flexWrap:"wrap",marginTop:2}}>
                {sales.distanz&&<span style={{fontSize:10,color:"#718096"}}>ðŸ“ {sales.distanz}</span>}
                {sales.haeufigkeit&&<span style={{fontSize:10,color:"#718096"}}>ðŸ”„ {sales.haeufigkeit}</span>}
                {sales.zeitrahmen&&<span style={{fontSize:10,color:"#718096"}}>â° {sales.zeitrahmen}</span>}
              </div>}
            </div>
            <div style={{marginTop:8,textAlign:"right"}}><span onClick={()=>setTab("sales")} style={{fontSize:10,color:"#667EEA",fontWeight:600,cursor:"pointer"}}>Alle Felder bearbeiten â†’</span></div>
          </div>

          {/* Bezahlart */}
          <div><Lbl>Bezahlart</Lbl>
            <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
              {PAY_METHODS.map(p=><Chip key={p.id} on={sales.payment===p.id} onClick={()=>uS("payment",sales.payment===p.id?"":p.id)}>{p.icon} {p.id}</Chip>)}
            </div>
            {sales.payment==="Leasing"&&<div style={{marginTop:10}}>
              <div style={{fontSize:10,fontWeight:600,color:"#A0AEC0",marginBottom:5}}>Anbieter</div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                {LEASING_PROVIDERS.map(lp=><Chip key={lp} on={sales.leasingProvider===lp} color="#D69E2E" onClick={()=>uS("leasingProvider",lp)}>{lp}</Chip>)}
              </div>
              {sales.leasingProvider&&<input value={sales.leasingRef||""} onChange={e=>uS("leasingRef",e.target.value)} placeholder="Vorgangsnr..." style={{marginTop:8,width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#D69E2E"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>}
            </div>}
          </div>

          {/* Interesse + VerkÃ¤ufer in einer Zeile */}
          <div style={{display:"flex",gap:20,flexWrap:"wrap"}}>
            <div style={{flex:"1 1 120px"}}><Lbl>Interesse</Lbl>
              <div style={{display:"flex",gap:3}}>{[1,2,3,4,5].map(h=><div key={h} onClick={()=>onHeat(deal.id,h)} style={{width:34,height:26,borderRadius:7,background:h<=deal.heat?(deal.heat>=4?"#FF6B3520":deal.heat>=2?"#F7C94820":"#EDF2F7"):"#FAFAFA",border:`1.5px solid ${h<=deal.heat?"transparent":"#F0F0F0"}`,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .12s",fontSize:12}}>{h<=deal.heat?"ðŸ”¥":""}</div>)}</div>
            </div>
            <div style={{flex:"1 1 200px"}}><Lbl>VerkÃ¤ufer</Lbl>
              <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>{SELLERS.filter(s=>s.loc===deal.loc).map(s=><Chip key={s.id} on={deal.seller===s.id} color={s.color} onClick={()=>onUpdateDeal(deal.id,"seller",s.id)}>{s.name}</Chip>)}</div>
            </div>
          </div>

          {/* Quelle */}
          <div><Lbl>Quelle</Lbl>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{SOURCES.map(src=><Chip key={src} on={deal.source===src} onClick={()=>onUpdateDeal(deal.id,"source",src)}>{src}</Chip>)}</div>
          </div>

          {/* Social Quick */}
          {deal.email&&<div><Lbl>Social finden</Lbl>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
              {[{l:"LinkedIn",u:`https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(deal.name)}`,c:"#0077B5"},{l:"Instagram",u:`https://www.instagram.com/${(deal.email.split("@")[0]||"").replace(/[._]/g,"")}`,c:"#E1306C"},{l:"Facebook",u:`https://www.facebook.com/search/top?q=${encodeURIComponent(deal.name)}`,c:"#1877F2"},{l:"XING",u:`https://www.xing.com/search/members?keywords=${encodeURIComponent(deal.name)}`,c:"#00605E"},{l:"Google",u:`https://www.google.com/search?q="${encodeURIComponent(deal.name)}"`,c:"#4285F4"}].map(s=><a key={s.l} href={s.u} target="_blank" rel="noopener" style={{fontSize:11,background:s.c+"10",color:s.c,padding:"5px 10px",borderRadius:7,textDecoration:"none",fontWeight:600}}>{s.l}</a>)}
            </div>
          </div>}
        </div>}

        {tab==="sales"&&<div style={{display:"grid",gap:20}}>
          {/* Bedarfsanalyse */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸŽ¯ Bedarfsanalyse</div>
            {[
              {k:"nutzung",l:"Nutzung",p:"Was machst du mit dem Fahrrad?"},
              {k:"ziel",l:"Ziel",p:"Welches Ziel verfolgst du mit dem Radfahren?"},
              {k:"distanz",l:"Distanzen",p:"Welche Distanzen willst du zurÃ¼cklegen?"},
              {k:"haeufigkeit",l:"HÃ¤ufigkeit",p:"Wie oft / wie viel Zeit pro Woche?"},
              {k:"erfahrung",l:"E-Bike Erfahrung",p:"Welche Erfahrungen mit E-Bike?"},
              {k:"lagerung",l:"Lagerung & Transport",p:"Wo wird das Rad gelagert / transportiert?"},
              {k:"aufladen",l:"Aufladen",p:"Wo kannst du das Rad aufladen?"},
              {k:"zeitrahmen",l:"Wann einsatzfÃ¤hig",p:"Wann muss das Rad einsatzfÃ¤hig sein?"},
              {k:"wichtig",l:"Wichtig am Rad",p:"Was ist dir an deinem Rad wichtig?"},
              {k:"budget",l:"Budget",p:"Was kannst du investieren? (Wie kam das Budget zustande?)"},
              {k:"akku",l:"Akku-Ladezeit",p:"Ist schnelle Akku-Ladezeit wichtig?"},
              {k:"dreiPunkte",l:"3 Kaufkriterien",p:"Welche 3 Punkte muss das Rad haben, damit du es heute kaufst?"},
            ].map(f=><div key={f.k} style={{marginBottom:8}}>
              <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>{f.l}</div>
              <input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
            </div>)}
          </div>

          {/* EinwÃ¤nde & NÃ¤chster Schritt */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸ’¬ GesprÃ¤ch</div>
            {[
              {k:"einwaende",l:"EinwÃ¤nde / Bedenken",p:"Welche Bedenken hat der Kunde?",big:1},
              {k:"next",l:"NÃ¤chster Schritt",p:"Was wurde vereinbart?"},
              {k:"notizen",l:"Sonstige Notizen",p:"Weitere Infos zum GesprÃ¤ch...",big:1},
            ].map(f=><div key={f.k} style={{marginBottom:8}}>
              <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>{f.l}</div>
              {f.big?<textarea value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} rows={2} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",resize:"vertical"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              :<input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder={f.p} style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>}
            </div>)}
          </div>

          {/* Ergodaten */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸ“ Ergodaten</div>
            <div style={{display:"flex",gap:5,marginBottom:10}}>
              {["Bodyscanner","Smartfit"].map(m=><Chip key={m} on={sales.ergoMethod===m} onClick={()=>uS("ergoMethod",sales.ergoMethod===m?"":m)}>{m}</Chip>)}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              {[{k:"sattelhoehe",l:"SattelhÃ¶he"},{k:"sattelversatz",l:"Sattelversatz"},{k:"abstandLenker",l:"Abstand Sattel-Lenker"},{k:"lenkerhoehe",l:"LenkerhÃ¶he"},{k:"sitzknochen",l:"Sitzknochen"},{k:"griffgroesse",l:"GriffgrÃ¶sse"}].map(f=><div key={f.k}>
                <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>{f.l}</div>
                <input value={sales[f.k]||""} onChange={e=>uS(f.k,e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              </div>)}
            </div>
          </div>

          {/* Gekauftes Rad */}
          <div>
            <div style={{fontSize:13,fontWeight:700,color:"#2D3748",marginBottom:10}}>ðŸš² Rad & Auftrag</div>
            <div style={{display:"grid",gap:8}}>
              <div>
                <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:3}}>Gekauftes Rad</div>
                <input value={sales.gekauftesRad||""} onChange={e=>uS("gekauftesRad",e.target.value)} placeholder="Modell / Marke / Farbe / GrÃ¶sse" style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <div>
                  <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>Nr. Teilekiste</div>
                  <input value={sales.nrTeilekiste||""} onChange={e=>uS("nrTeilekiste",e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
                </div>
                <div>
                  <div style={{fontSize:9,fontWeight:600,color:"#A0AEC0",marginBottom:2}}>Nr. Auftrag</div>
                  <input value={sales.nrAuftrag||""} onChange={e=>uS("nrAuftrag",e.target.value)} placeholder="â€”" style={{width:"100%",padding:"5px 8px",borderRadius:6,border:"1.5px solid #EDF2F7",fontSize:11,fontFamily:"monospace",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/>
                </div>
              </div>
              <div>
                <div style={{fontSize:10,fontWeight:700,color:"#A0AEC0",textTransform:"uppercase",letterSpacing:".04em",marginBottom:5}}>Nach dem Kauf</div>
                <div style={{display:"grid",gap:4}}>
                  {[{k:"todoZubehoer",l:"ZubehÃ¶rteile bestellt"},{k:"todoRadBestellt",l:"Fahrrad bestellt / ist lagernd"},{k:"todoKiste",l:"Kiste gepackt"},{k:"todoLeasing",l:"Leasing-Anfrage gestellt"},{k:"todoFinanzierung",l:"Finanzierung: Unterlagen angefordert & kopiert"},{k:"todoWertgarantie",l:"Wertgarantie"}].map(c=><div key={c.k} onClick={()=>uS(c.k,!sales[c.k])} style={{display:"flex",alignItems:"center",gap:8,padding:"6px 8px",borderRadius:7,background:sales[c.k]?"#E6FFFA":"#FAFAFA",cursor:"pointer",transition:"all .12s"}}>
                    <div style={{width:16,height:16,borderRadius:4,border:`1.5px solid ${sales[c.k]?"#38B2AC":"#CBD5E0"}`,background:sales[c.k]?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{sales[c.k]&&<span style={{color:"#fff",fontSize:9,fontWeight:900}}>âœ“</span>}</div>
                    <span style={{fontSize:11,fontWeight:600,color:sales[c.k]?"#2D3748":"#718096"}}>{c.l}</span>
                  </div>)}
                </div>
              </div>
            </div>
          </div>
        </div>}

        {tab==="log"&&<div>
          <div style={{display:"flex",gap:5,marginBottom:8}}>{ACT_TYPES.map(a=><div key={a.id} onClick={()=>setAt(a.id)} style={{padding:"5px 10px",borderRadius:7,fontSize:11,fontWeight:600,cursor:"pointer",background:at===a.id?a.color+"15":"#FAFAFA",color:at===a.id?a.color:"#A0AEC0",transition:"all .12s"}}>{a.label}</div>)}</div>
          <div style={{display:"flex",gap:6,marginBottom:16}}><input value={tx} onChange={e=>setTx(e.target.value)} placeholder="Was wurde besprochen?" onKeyDown={e=>e.key==="Enter"&&goAct()} style={{flex:1,padding:"8px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/><button onClick={goAct} style={{padding:"8px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,fontSize:12,cursor:"pointer",opacity:tx.trim()?1:.35}}>+</button></div>
          {!deal.acts.length&&<div style={{color:"#CBD5E0",fontSize:12,textAlign:"center",padding:20}}>Noch keine EintrÃ¤ge</div>}
          {deal.acts.map((a,i)=>{const t=ACT_TYPES.find(x=>x.id===a.type);return <div key={i} style={{display:"flex",gap:10,padding:"9px 0",borderBottom:i<deal.acts.length-1?"1px solid #F7FAFC":"none"}}>
            <div style={{width:26,height:26,borderRadius:7,background:(t?.color||"#aaa")+"10",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,flexShrink:0}}>{t?.label.split(" ")[0]}</div>
            <div><div style={{fontSize:12,color:"#2D3748",fontWeight:600}}>{a.text}</div><div style={{fontSize:10,color:"#A0AEC0",marginTop:1}}>{tAgo(a.time)}</div></div>
          </div>})}
        </div>}

        {tab==="todos"&&<div>
          <div style={{display:"flex",gap:5,marginBottom:14}}><input value={todoTx} onChange={e=>setTodoTx(e.target.value)} placeholder="Neues Todo..." onKeyDown={e=>e.key==="Enter"&&goTodo()} style={{flex:1,padding:"8px 10px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:12,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}} onFocus={e=>e.target.style.borderColor="#667EEA"} onBlur={e=>e.target.style.borderColor="#EDF2F7"}/><select value={todoDays} onChange={e=>setTodoDays(+e.target.value)} style={{padding:"8px 8px",borderRadius:8,border:"1.5px solid #EDF2F7",fontSize:11,background:"var(--c-bg)",cursor:"pointer",outline:"none"}}><option value={0}>Heute</option><option value={1}>Morgen</option><option value={3}>3d</option><option value={7}>1W</option><option value={14}>2W</option><option value={30}>30d</option></select><button onClick={goTodo} style={{padding:"8px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,fontSize:12,cursor:"pointer",opacity:todoTx.trim()?1:.35}}>+</button></div>
          {!deal.todos.length&&<div style={{color:"#CBD5E0",fontSize:12,textAlign:"center",padding:20}}>Alles erledigt âœ¨</div>}
          {[...deal.todos].sort((a,b)=>a.done-b.done||a.due-b.due).map(t=>{const ov=!t.done&&t.due<NOW;return <div key={t.id} onClick={()=>onToggleTodo(deal.id,t.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 10px",marginBottom:3,borderRadius:8,background:t.done?"#FAFAFA":ov?"#FFF5F5":"#fff",border:`1px solid ${ov?"#FEB2B2":"#F0F0F0"}`,cursor:"pointer",transition:"all .12s"}}>
            <div style={{width:18,height:18,borderRadius:5,border:`2px solid ${t.done?"#38B2AC":ov?"#E53E3E":"#CBD5E0"}`,background:t.done?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{t.done&&<span style={{color:"#fff",fontSize:9,fontWeight:900}}>âœ“</span>}</div>
            <div style={{flex:1}}><div style={{fontSize:12,fontWeight:600,color:t.done?"#A0AEC0":"#2D3748",textDecoration:t.done?"line-through":"none"}}>{t.text}</div><div style={{fontSize:10,color:ov?"#E53E3E":"#A0AEC0"}}>{ov?"âš ï¸ ÃœberfÃ¤llig Â· ":""}FÃ¤llig {tAgo(t.due)}</div></div>
          </div>})}
        </div>}

      </div>

      {/* â”€â”€ Footer â”€â”€ */}
      <div style={{padding:"10px 24px",borderTop:"1px solid #F0F0F0",display:"flex",gap:6,justifyContent:"space-between",flexWrap:"wrap"}}>
        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
          <button onClick={()=>setShowForm("interactive")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #667EEA",background:"var(--c-bg)",fontSize:11,fontWeight:700,color:"#667EEA",cursor:"pointer"}}>ðŸ“‹ Beratung digital</button>
          <button onClick={()=>setShowForm("print")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #A0AEC0",background:"var(--c-bg)",fontSize:11,fontWeight:700,color:"#718096",cursor:"pointer"}}>ðŸ–¨ï¸ Druckformular</button>
          <button onClick={()=>setShowForm("scan")} style={{padding:"9px 14px",borderRadius:8,border:"1.5px solid #FF6B35",background:"var(--c-bg)",fontSize:11,fontWeight:700,color:"#FF6B35",cursor:"pointer"}}>ðŸ“· Scan hochladen</button>
        </div>
        <button onClick={onClose} style={{padding:"9px 24px",borderRadius:8,border:"none",background:"#F7FAFC",fontSize:12,fontWeight:700,color:"#718096",cursor:"pointer"}}>Schliessen</button>
      </div>

      {showForm&&showForm!=="scan"&&<SalesForm deal={deal} sales={sales} seller={seller} onClose={()=>setShowForm(null)} onUpdateDeal={onUpdateDeal} mode={showForm}/>}
      {showForm==="scan"&&<ScanUploadModal deal={deal} sales={sales} onClose={()=>setShowForm(null)} onUpdateDeal={onUpdateDeal}/>}
    </div>
  </div>
}
/* â”€â”€ Automations Settings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AutoModal({rules,onUpdate,onClose}){
  const[rs,setRs]=useState(rules);
  const[nFrom,setNFrom]=useState("*");const[nTo,setNTo]=useState("angebot");const[nAct,setNAct]=useState("todo");const[nTx,setNTx]=useState("");const[nDays,setNDays]=useState(3);const[nActType,setNActType]=useState("note");const[nScope,setNScope]=useState("hq");
  const[filterScope,setFilterScope]=useState("all");
  const addRule=()=>{if(!nTx.trim())return;setRs(p=>[...p,{id:"r"+Date.now(),from:nFrom,to:nTo,action:nAct,text:nTx.trim(),days:nDays,actType:nActType,enabled:true,scope:nScope}]);setNTx("")};
  const toggle=(id)=>setRs(p=>p.map(r=>r.id===id?{...r,enabled:!r.enabled}:r));
  const remove=(id)=>setRs(p=>p.filter(r=>r.id!==id));
  const save=()=>{onUpdate(rs);onClose()};
  const allStages=[{id:"*",label:"Beliebig"},...STAGES];
  const scopes=[{id:"hq",label:"ðŸ¢ HQ (Alle)"},...LOCATIONS.filter(l=>!l.isHQ)];
  const filtered=filterScope==="all"?rs:rs.filter(r=>r.scope===filterScope);
  return <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,animation:"fadeIn .2s"}}>
    <div onClick={e=>e.stopPropagation()} style={{background:"var(--c-bg)",borderRadius:24,padding:28,width:620,maxWidth:"94vw",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 25px 60px rgba(0,0,0,.15)",animation:"pop .3s cubic-bezier(.34,1.56,.64,1)"}}>
      <h2 style={{margin:"0 0 6px",fontFamily:"'Outfit',sans-serif",fontWeight:800,fontSize:22}}>âš¡ Automationen</h2>
      <p style={{margin:"0 0 16px",fontSize:13,color:"#A0AEC0",fontFamily:"'Outfit',sans-serif"}}>ðŸ¢ HQ-Regeln gelten Ã¼berall. ðŸ“ Standort-Regeln nur lokal.</p>

      {/* Scope Filter */}
      <div style={{display:"flex",gap:4,marginBottom:16,background:"#F7FAFC",borderRadius:12,padding:4}}>
        {[{id:"all",label:"Alle"},...scopes].map(s=><div key={s.id} onClick={()=>setFilterScope(s.id)} style={{flex:1,padding:"7px 10px",borderRadius:10,textAlign:"center",fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"'Outfit',sans-serif",background:filterScope===s.id?"#fff":"transparent",color:filterScope===s.id?"#2D3748":"#A0AEC0",boxShadow:filterScope===s.id?"0 2px 8px rgba(0,0,0,.06)":"none",transition:"all .2s"}}>{s.label}</div>)}
      </div>

      {/* Existing rules */}
      <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:20}}>
        {filtered.map(r=>{const fromSt=allStages.find(s=>s.id===r.from);const toSt=STAGES.find(s=>s.id===r.to);const sc=scopes.find(s=>s.id===r.scope);const isHQ=r.scope==="hq";return <div key={r.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:14,background:r.enabled?"#fff":"#F7FAFC",border:`1.5px solid ${r.enabled?(isHQ?"#667EEA30":"#D69E2E30"):"#EDF2F7"}`,opacity:r.enabled?1:.55,transition:"all .2s"}}>
          <div onClick={()=>toggle(r.id)} style={{width:22,height:22,borderRadius:6,border:`2px solid ${r.enabled?"#38B2AC":"#CBD5E0"}`,background:r.enabled?"#38B2AC":"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0}}>{r.enabled&&<span style={{color:"#fff",fontSize:11,fontWeight:800}}>âœ“</span>}</div>
          <div style={{flex:1}}>
            <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",fontSize:12,fontWeight:700,fontFamily:"'Outfit',sans-serif",color:"#2D3748"}}>
              <span style={{background:isHQ?"#EBF4FF":"#FFFFF0",color:isHQ?"#667EEA":"#B7791F",padding:"2px 6px",borderRadius:6,fontSize:10,fontWeight:800}}>{isHQ?"ðŸ¢ HQ":"ðŸ“ "+(sc?.label?.replace("ðŸ“ ","")||r.scope)}</span>
              <span style={{background:"#EBF4FF",color:"#667EEA",padding:"2px 6px",borderRadius:6,fontSize:11}}>{fromSt?.label||"?"}</span>
              <span style={{color:"#A0AEC0"}}>â†’</span>
              <span style={{background:toSt?.bg||"#eee",color:toSt?.color||"#666",padding:"2px 6px",borderRadius:6,fontSize:11}}>{toSt?.label||"?"}</span>
              <span style={{color:"#A0AEC0"}}>dann</span>
              <span style={{background:r.action==="todo"?"#FEFCBF":"#E6FFFA",color:r.action==="todo"?"#B7791F":"#38B2AC",padding:"2px 6px",borderRadius:6,fontSize:11}}>{r.action==="todo"?"â˜‘ï¸ Todo":"ðŸ“‹ AktivitÃ¤t"}</span>
            </div>
            <div style={{fontSize:11,color:"#718096",fontFamily:"monospace",marginTop:3}}>"{r.text}"{r.action==="todo"&&r.days!==undefined?` (in ${r.days}d fÃ¤llig)`:""}</div>
          </div>
          <div onClick={()=>remove(r.id)} style={{width:24,height:24,borderRadius:6,background:"#FFF5F5",color:"#E53E3E",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:12,fontWeight:800,flexShrink:0}}>Ã—</div>
        </div>})}
        {!filtered.length&&<div style={{textAlign:"center",color:"#CBD5E0",fontSize:13,padding:16}}>Keine Regeln fÃ¼r diesen Filter</div>}
      </div>

      {/* New Rule */}
      <div style={{background:"#F7FAFC",borderRadius:16,padding:16,marginBottom:20}}>
        <div style={{fontSize:12,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",marginBottom:10}}>âž• Neue Regel</div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Geltung</span>
          <select value={nScope} onChange={e=>setNScope(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}>{scopes.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Wenn</span>
          <select value={nFrom} onChange={e=>setNFrom(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}>{allStages.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>â†’</span>
          <select value={nTo} onChange={e=>setNTo(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}>{STAGES.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}</select>
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center",marginBottom:10}}>
          <span style={{fontSize:12,fontWeight:700,color:"#718096"}}>Dann</span>
          <select value={nAct} onChange={e=>setNAct(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}><option value="todo">â˜‘ï¸ Todo erstellen</option><option value="activity">ðŸ“‹ AktivitÃ¤t loggen</option></select>
          {nAct==="activity"&&<select value={nActType} onChange={e=>setNActType(e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}>{ACT_TYPES.map(a=><option key={a.id} value={a.id}>{a.label}</option>)}</select>}
          {nAct==="todo"&&<select value={nDays} onChange={e=>setNDays(+e.target.value)} style={{padding:"6px 10px",borderRadius:8,border:"2px solid #E2E8F0",fontSize:12,fontFamily:"'Outfit',sans-serif",background:"var(--c-bg)",cursor:"pointer"}}><option value={0}>Heute</option><option value={1}>1 Tag</option><option value={3}>3 Tage</option><option value={7}>1 Woche</option><option value={14}>2 Wochen</option><option value={30}>30 Tage</option></select>}
        </div>
        <div style={{display:"flex",gap:8}}>
          <input value={nTx} onChange={e=>setNTx(e.target.value)} placeholder="Text der Aktion..." onKeyDown={e=>e.key==="Enter"&&addRule()} style={{flex:1,padding:"10px 14px",borderRadius:12,border:"2px solid #E2E8F0",fontSize:13,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box"}}/>
          <button onClick={addRule} style={{padding:"10px 18px",borderRadius:12,border:"none",background:"#667EEA",color:"#fff",fontWeight:700,cursor:"pointer",opacity:nTx.trim()?1:.5}}>+</button>
        </div>
      </div>

      <div style={{display:"flex",gap:12}}>
        <button onClick={onClose} style={{flex:1,padding:"11px 18px",borderRadius:12,border:"2px solid #E2E8F0",background:"var(--c-bg)",fontSize:14,fontWeight:700,color:"#718096",cursor:"pointer",fontFamily:"'Outfit',sans-serif"}}>Abbrechen</button>
        <button onClick={save} style={{flex:2,padding:"11px 18px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#667EEA,#764BA2)",fontSize:14,fontWeight:700,color:"#fff",cursor:"pointer",fontFamily:"'Outfit',sans-serif",boxShadow:"0 4px 15px rgba(102,126,234,.4)"}}>ðŸ’¾ Speichern</button>
      </div>
    </div>
  </div>
}

/* â”€â”€ Scoreboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Scores({deals,streak}){
  const sold=deals.filter(d=>d.stage==="verkauft"),tSold=sold.reduce((s,d)=>s+d.value,0);
  const pipe=deals.filter(d=>!["verkauft","lost","gold"].includes(d.stage)).reduce((s,d)=>s+d.value,0);
  const closed=deals.filter(d=>["verkauft","lost"].includes(d.stage));
  const wr=closed.length?Math.round(sold.length/closed.length*100):0;
  const gp=Math.min(100,Math.round(tSold/GOAL*100));
  const items=[{l:"Pipeline",v:fmt(pipe),c:"#667EEA"},{l:"Verkauft",v:fmt(tSold),c:"#38B2AC"},{l:"Win-Rate",v:wr+"%",c:"#F7C948"},{l:"Streak",v:streak+"x",c:"#FF6B35"}];
  return <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"stretch"}}>
    {items.map(s=><div key={s.l} style={{flex:"1 1 100px",background:"var(--c-bg)",borderRadius:12,padding:"10px 14px",border:"1px solid #F0F0F0"}}>
      <div style={{fontSize:10,color:"#A0AEC0",fontWeight:600,textTransform:"uppercase",letterSpacing:".04em"}}>{s.l}</div>
      <div style={{fontSize:17,fontWeight:800,color:s.c,marginTop:2}}>{s.v}</div>
    </div>)}
    <div style={{flex:"1 1 180px",background:"var(--c-bg)",borderRadius:12,padding:"10px 14px",border:"1px solid #F0F0F0"}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{fontSize:10,color:"#A0AEC0",fontWeight:600,textTransform:"uppercase"}}>Monatsziel</span><span style={{fontSize:12,fontWeight:800,color:gp>=100?"#38B2AC":"#667EEA"}}>{gp}%</span></div>
      <div style={{height:6,borderRadius:3,background:"#EDF2F7",overflow:"hidden"}}><div style={{height:"100%",borderRadius:3,width:gp+"%",background:gp>=100?"#38B2AC":"#667EEA",transition:"width .6s"}}/></div>
      <div style={{display:"flex",justifyContent:"space-between",marginTop:3}}><span style={{fontSize:9,color:"#CBD5E0"}}>{fmt(tSold)}</span><span style={{fontSize:9,color:"#CBD5E0"}}>{fmt(GOAL)}</span></div>
    </div>
  </div>
}

/* â”€â”€ Funnel + Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Funnel({deals}){
  const c={};PIPELINE.forEach(s=>c[s]=deals.filter(d=>d.stage===s).length);
  const data=PIPELINE.map((sid,i)=>{const st=STAGES.find(s=>s.id===sid);const cnt=c[sid]+PIPELINE.slice(i+1).reduce((s,l)=>s+c[l],0);return{...st,count:cnt,cur:c[sid]}});
  const mx=Math.max(...data.map(f=>f.count),1);
  return <div style={{background:"var(--c-bg)",borderRadius:18,padding:20,boxShadow:"0 2px 10px rgba(0,0,0,.04)",border:"1px solid #F0F0F0"}}>
    <div style={{fontSize:14,fontWeight:800,color:"#2D3748",fontFamily:"'Outfit',sans-serif",marginBottom:14}}>ðŸ“Š Conversion Funnel</div>
    {data.map((item,i)=>{const w=Math.max(15,item.count/mx*100);const prev=i>0?data[i-1].count:null;const cr=prev?Math.round(item.count/prev*100):null;
      return <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,marginBottom:6}}>
        <div style={{width:90,fontSize:11,fontWeight:700,color:"#718096",fontFamily:"'Outfit',sans-serif",textAlign:"right"}}>{item.label}</div>
        <div style={{flex:1}}><div style={{height:28,borderRadius:8,width:w+"%",background:`linear-gradient(90deg,${item.color},${item.color}88)`,display:"flex",alignItems:"center",justifyContent:"center",transition:"width .6s",minWidth:40}}><span style={{fontSize:12,fontWeight:800,color:"#fff"}}>{item.cur}</span></div></div>
        {cr!==null&&<div style={{width:50,fontSize:11,fontWeight:700,color:cr>=50?"#38B2AC":cr>=25?"#F7C948":"#E53E3E",fontFamily:"monospace"}}>{cr}%</div>}
      </div>
    })}
  </div>
}
function Badges({deals,streak,unlocked}){
  const s={sold:deals.filter(d=>d.stage==="verkauft").length,rev:deals.filter(d=>d.stage==="verkauft").reduce((a,d)=>a+d.value,0),streak,total:deals.length,hot:deals.filter(d=>d.heat>=5).length,gold:deals.filter(d=>d.stage==="gold").length,acts:deals.reduce((a,d)=>a+d.acts.length,0)};
  return <div style={{background:"var(--c-bg)",borderRadius:18,padding:20,boxShadow:"0 2px 10px rgba(0,0,0,.04)",border:"1px solid #F0F0F0"}}>
    <div style={{fontSize:14,fontWeight:800,color:"#2D3748",fontFamily:"'Outfit',sans-serif",marginBottom:14}}>ðŸ… Achievements</div>
    <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
      {ACHIEVEMENTS.map(a=>{const ok=a.check(s)||unlocked.includes(a.id);return <div key={a.id} title={a.desc} style={{padding:"8px 12px",borderRadius:12,display:"flex",alignItems:"center",gap:6,background:ok?"linear-gradient(135deg,#FFFFF0,#FEFCBF)":"#F7FAFC",border:`1.5px solid ${ok?"#D69E2E":"#E2E8F0"}`,opacity:ok?1:.45,cursor:"default",transform:ok?"scale(1)":"scale(.95)",transition:"all .3s"}}>
        <span style={{fontSize:18}}>{ok?a.icon:"ðŸ”’"}</span>
        <div><div style={{fontSize:11,fontWeight:700,color:ok?"#B7791F":"#A0AEC0",fontFamily:"'Outfit',sans-serif"}}>{a.label}</div><div style={{fontSize:9,color:ok?"#D69E2E":"#CBD5E0",fontFamily:"monospace"}}>{a.desc}</div></div>
      </div>})}
    </div>
  </div>
}

/* â”€â”€ Drop Zone (Clean) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function DropZone({sid,label,sub,bc,tc,cc,deals,onDrop,onDrag}){
  const[dg,setDg]=useState(false);
  if(!deals.length&&!dg)return null;
  return <div style={{padding:"0 0 8px"}}><div onDragOver={e=>{e.preventDefault();setDg(true)}} onDragLeave={()=>setDg(false)} onDrop={e=>{e.preventDefault();setDg(false);onDrop(+e.dataTransfer.getData("id"),sid)}} style={{background:"var(--c-bg)",borderRadius:12,padding:12,border:`1.5px dashed ${dg?bc:bc+"50"}`,transition:"all .2s"}}>
    <div style={{fontSize:11,fontWeight:700,color:tc,marginBottom:6}}>{label} <span style={{fontWeight:500,color:"#A0AEC0",fontSize:10}}>â€“ {sub}</span></div>
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{deals.map(d=><div key={d.id} draggable onDragStart={e=>{e.dataTransfer.setData("id",d.id);onDrag(d.id)}} style={{background:"#F8F9FB",borderRadius:8,padding:"5px 10px",fontSize:11,fontWeight:600,color:cc,cursor:"grab",border:`1px solid ${bc}30`,display:"flex",alignItems:"center",gap:4}}>
      {d.avatar} {d.name} <span style={{color:"#A0AEC0",fontSize:10}}>{fmt(d.value)}</span>
    </div>)}</div>
  </div></div>
}

/* â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function PipelineApp(){
  const[deals,setDeals]=useState(INIT);
  const[dragId,setDragId]=useState(null);
  const[showAdd,setShowAdd]=useState(false);
  const[sel,setSel]=useState(null);
  const[parts,setParts]=useState([]);
  const[streak,setStreak]=useState(0);
  const[newId,setNewId]=useState(null);
  const[toast,setToast]=useState(null);
  const[unlocked,setUnlocked]=useState([]);
  const[showIn,setShowIn]=useState(false);
  const[showAuto,setShowAuto]=useState(false);
  const[rules,setRules]=useState(DEFAULT_RULES);
  // Determine location from logged-in user profile
  const isHqUser = window.sbProfile && window.sbProfile.is_hq;
  const userStandortSlug = (function() {
    // Map standort_id to a loc slug - for now use demo mapping
    // TODO: Replace with real standort lookup from DB
    if(!window.sbProfile || window.sbProfile.is_hq) return "hq";
    return "berlin"; // Default for non-HQ users until DB mapping exists
  })();
  const[curLoc,setCurLoc]=useState(isHqUser ? "hq" : userStandortSlug);
  const nid=useRef(100);

  const filteredDeals = curLoc === "hq" ? deals : deals.filter(d => d.loc === curLoc);

  const msg=useCallback(m=>{setToast(m);setTimeout(()=>setToast(null),2500)},[]);
  const pop=useCallback((x,y)=>{const np=Array.from({length:14},(_,i)=>({id:Date.now()+i,x:x+(Math.random()-.5)*120,y:y+(Math.random()-.5)*80,emoji:CELEB[Math.floor(Math.random()*CELEB.length)],delay:i*.04}));setParts(p=>[...p,...np]);setTimeout(()=>setParts(p=>p.filter(pp=>!np.find(n=>n.id===pp.id))),2000)},[]);

  useEffect(()=>{
    const s={sold:deals.filter(d=>d.stage==="verkauft").length,rev:deals.filter(d=>d.stage==="verkauft").reduce((a,d)=>a+d.value,0),streak,total:deals.length,hot:deals.filter(d=>d.heat>=5).length,gold:deals.filter(d=>d.stage==="gold").length,acts:deals.reduce((a,d)=>a+d.acts.length,0)};
    const nu=ACHIEVEMENTS.filter(a=>a.check(s)&&!unlocked.includes(a.id));
    if(nu.length){setUnlocked(p=>[...p,...nu.map(a=>a.id)]);nu.forEach((a,i)=>setTimeout(()=>msg(`ðŸ… ${a.icon} ${a.label}!`),i*800))}
  },[deals,streak]);

  // Apply automation rules on stage change
  const applyRules=useCallback((dealId,fromStage,toStage)=>{
    const deal=deals.find(d=>d.id===dealId);
    const dealLoc=deal?.loc||"";
    const active=rules.filter(r=>r.enabled&&(r.from==="*"||r.from===fromStage)&&r.to===toStage&&(r.scope==="hq"||r.scope===dealLoc));
    if(!active.length)return;
    setDeals(prev=>prev.map(d=>{
      if(d.id!==dealId)return d;
      let updated={...d,todos:[...d.todos],acts:[...d.acts]};
      active.forEach(r=>{
        if(r.action==="todo"){updated.todos=[{text:r.text,due:Date.now()+(r.days||0)*864e5,done:false,id:"t"+Date.now()+Math.random()},...updated.todos]}
        else{updated.acts=[{type:r.actType||"note",text:r.text,time:Date.now()},...updated.acts]}
      });
      return updated;
    }));
    active.forEach((r,i)=>setTimeout(()=>msg(`âš¡ Auto: ${r.action==="todo"?"â˜‘ï¸":"ðŸ“‹"} "${r.text}"`),300+i*600));
  },[rules,msg]);

  const drop=useCallback((id,ns)=>{
    const deal=deals.find(x=>x.id===id);
    if(!deal||deal.stage===ns)return;
    const oldStage=deal.stage;
    setDeals(p=>p.map(x=>x.id===id?{...x,stage:ns,changed:Date.now()}:x));
    // Trigger automations
    setTimeout(()=>applyRules(id,oldStage,ns),100);
    if(ns==="verkauft"){setStreak(s=>s+1);msg(`ðŸ† ${deal.name} verkauft! ${fmt(deal.value)}`);pop(innerWidth/2,innerHeight/2)}
    else if(ns==="lost"){setStreak(0);msg(`ðŸ’€ ${deal.name} verloren...`)}
    else if(ns==="gold"){msg(`ðŸ’Ž ${deal.name} â†’ Schrank der Hoffnung`)}
    setDragId(null);
  },[deals,pop,msg,applyRules]);

  const addDeal=useCallback(d=>{const id=nid.current++;setDeals(p=>[...p,{...d,id}]);setNewId(id);setShowAdd(false);msg(`ðŸŽ¯ ${d.name} hinzugefÃ¼gt!`);setTimeout(()=>setNewId(null),600)},[msg]);
  const addAct=useCallback((id,a)=>{setDeals(p=>p.map(d=>d.id===id?{...d,acts:[a,...d.acts]}:d));setSel(p=>p&&p.id===id?{...p,acts:[a,...p.acts]}:p)},[]);
  const setHeat=useCallback((id,h)=>{setDeals(p=>p.map(d=>d.id===id?{...d,heat:h}:d));setSel(p=>p&&p.id===id?{...p,heat:h}:p)},[]);
  const toggleTodo=useCallback((did,tid)=>{setDeals(p=>p.map(d=>d.id===did?{...d,todos:d.todos.map(t=>t.id===tid?{...t,done:!t.done}:t)}:d));setSel(p=>p&&p.id===did?{...p,todos:p.todos.map(t=>t.id===tid?{...t,done:!t.done}:t)}:p)},[]);
  const addTodo=useCallback((did,todo)=>{setDeals(p=>p.map(d=>d.id===did?{...d,todos:[todo,...d.todos]}:d));setSel(p=>p&&p.id===did?{...p,todos:[todo,...p.todos]}:p)},[]);
  const updateDeal=useCallback((did,field,val)=>{setDeals(p=>p.map(d=>d.id===did?{...d,[field]:val}:d));setSel(p=>p&&p.id===did?{...p,[field]:val}:p)},[]);
  const changeStage=useCallback((did,fromStage,toStage)=>{
    if(fromStage===toStage)return;
    const deal=deals.find(d=>d.id===did);
    setDeals(p=>p.map(d=>d.id===did?{...d,stage:toStage,changed:Date.now()}:d));
    setSel(p=>p&&p.id===did?{...p,stage:toStage,changed:Date.now()}:p);
    setTimeout(()=>applyRules(did,fromStage,toStage),100);
    if(toStage==="verkauft"){setStreak(s=>s+1);msg(`ðŸ† ${deal?.name} verkauft! ${fmt(deal?.value||0)}`);pop(innerWidth/2,innerHeight/2)}
    else if(toStage==="lost"){setStreak(0);msg(`ðŸ’€ ${deal?.name} verloren...`)}
    else if(toStage==="gold"){msg(`ðŸ—„ï¸ ${deal?.name} â†’ Schrank der Hoffnung`)}
  },[deals,applyRules,msg,pop]);

  const main=STAGES.filter(s=>!["lost","gold"].includes(s.id));
  const aging=filteredDeals.filter(d=>!["verkauft","lost","gold"].includes(d.stage)&&dSince(d.changed)>=(AGING[d.stage]||5)).length;
  const openTodos=filteredDeals.reduce((s,d)=>s+d.todos.filter(t=>!t.done).length,0);

  return <div style={{fontFamily:"'Outfit',sans-serif"}}>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>{`
      @keyframes appear{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
      @keyframes fly{0%{opacity:1;transform:translateY(0) scale(1) rotate(0)}100%{opacity:0;transform:translateY(-100px) scale(.3) rotate(360deg)}}
      @keyframes fadeIn{from{opacity:0}to{opacity:1}}
      @keyframes pop{0%{opacity:0;transform:scale(.9) translateY(12px)}100%{opacity:1;transform:scale(1) translateY(0)}}
      @keyframes toastIn{0%{opacity:0;transform:translateY(-16px)}100%{opacity:1;transform:translateY(0)}}
      @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
      *{box-sizing:border-box}
    `}</style>
    {parts.map(p=><Particle key={p.id} {...p}/>)}
    {toast&&<div style={{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",background:"#1a202c",color:"#fff",padding:"10px 20px",borderRadius:10,fontWeight:700,fontSize:13,zIndex:9999,boxShadow:"0 4px 20px rgba(0,0,0,.15)",animation:"toastIn .2s ease"}}>{toast}</div>}

    {/* Header */}
    <div style={{padding:"0 0 10px",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10}}>
      <div>
        <h1 style={{margin:0,fontSize:22,fontWeight:800,color:"#1a202c",letterSpacing:"-.02em"}}>Deal Flow</h1>
        <div style={{fontSize:11,color:"#A0AEC0",fontWeight:600,marginTop:2}}>
          {aging>0&&<span style={{color:"#E53E3E"}}>âš  {aging} Follow-Up  </span>}{openTodos>0&&<span style={{color:"#667EEA"}}>â˜‘ {openTodos} Todos  </span>}{!aging&&!openTodos&&"Alles im Griff"}
        </div>
      </div>
      <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
        {isHqUser&&<div style={{display:"flex",background:"var(--c-bg)",borderRadius:8,border:"1px solid #EDF2F7",overflow:"hidden"}}>
          {LOCATIONS.map(l=><div key={l.id} onClick={()=>setCurLoc(l.id)} style={{padding:"6px 12px",fontSize:11,fontWeight:600,cursor:"pointer",background:curLoc===l.id?"#667EEA":"transparent",color:curLoc===l.id?"#fff":"#718096",transition:"all .15s",whiteSpace:"nowrap"}}>{l.label}</div>)}
        </div>}
        <button onClick={()=>setShowAuto(true)} style={{padding:"7px 12px",borderRadius:8,border:"1px solid #EDF2F7",background:"var(--c-bg)",fontSize:12,fontWeight:600,color:"#718096",cursor:"pointer"}}>âš¡</button>
        <button onClick={()=>setShowIn(v=>!v)} style={{padding:"7px 12px",borderRadius:8,border:"1px solid #EDF2F7",background:showIn?"#EBF4FF":"#fff",fontSize:12,fontWeight:600,color:showIn?"#667EEA":"#718096",cursor:"pointer"}}>ðŸ“Š</button>
        <button onClick={()=>setShowAdd(true)} style={{padding:"7px 16px",borderRadius:8,border:"none",background:"#667EEA",color:"#fff",fontSize:12,fontWeight:700,cursor:"pointer"}}>+ Kontakt</button>
      </div>
    </div>

    <div style={{padding:"0 0 12px"}}><Scores deals={filteredDeals} streak={streak}/></div>

    {showIn&&<div style={{padding:"0 0 12px",display:"flex",gap:12,flexWrap:"wrap",animation:"appear .3s"}}>
      <div style={{flex:"1 1 300px"}}><Funnel deals={filteredDeals}/></div>
      <div style={{flex:"1 1 380px"}}><Badges deals={filteredDeals} streak={streak} unlocked={unlocked}/></div>
    </div>}

    <div style={{padding:"0 0 12px",display:"flex",gap:4,overflowX:"auto",minHeight:320}}>
      {main.map(s=><Col key={s.id} stage={s} deals={filteredDeals.filter(d=>d.stage===s.id)} onDrop={drop} onDrag={setDragId} onClick={setSel} newId={newId}/>)}
    </div>

    <DropZone sid="gold" label="ðŸ—„ï¸ Schrank der Hoffnung" sub="Wertvolle Kontakte, die noch reifen" bc="#D69E2E" tc="#B7791F" cc="#B7791F" deals={filteredDeals.filter(d=>d.stage==="gold")} onDrop={drop} onDrag={setDragId}/>
    <DropZone sid="lost" label="ðŸ’€ Verloren" sub="Jederzeit wiederbelebbar" bc="#FEB2B2" tc="#E53E3E" cc="#A0AEC0" deals={filteredDeals.filter(d=>d.stage==="lost")} onDrop={drop} onDrag={setDragId}/>
    <div style={{height:32}}/>

    {showAdd&&<AddModal onClose={()=>setShowAdd(false)} onAdd={addDeal} currentLoc={curLoc}/>}
    {sel&&<DetailModal deal={sel} onClose={()=>setSel(null)} onAct={addAct} onHeat={setHeat} onToggleTodo={toggleTodo} onAddTodo={addTodo} onUpdateDeal={updateDeal} onChangeStage={changeStage}/>}
    {showAuto&&<AutoModal rules={rules} onUpdate={setRules} onClose={()=>setShowAuto(false)}/>}
  </div>
}

// Register globally so mountReactPipeline() can find it
window.__PIPELINE_APP = PipelineApp;

// Auto-mount if already visible (deferred until module exports mountReactPipeline)
window.addEventListener('vit:modules-ready', function() {
    if(document.getElementById('react-pipeline-root') && typeof window.mountReactPipeline === 'function') {
        mountReactPipeline();
    }
});
</script>

<!-- Jahresziel Modal -->
<div id="jahreszielModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none" onclick="if(event.target===this)closeJahreszielModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold" id="jahreszielModalTitle">Neues Jahresziel</h3><button onclick="closeJahreszielModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>
            <input type="hidden" id="jahreszielEditId" value="">
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Typ</label>
                <select id="jahreszielTyp" onchange="toggleJahreszielFelder()" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400">
                    <option value="umsatz">ðŸ’° Umsatzziel</option><option value="deckungsbeitrag">ðŸ“Š Deckungsbeitrag</option><option value="smart">ðŸŽ¯ SMART-Ziel</option><option value="soft_target">âœ… Soft Target</option>
                </select></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Titel</label><input id="jahreszielTitel" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="z.B. Jahresumsatz â‚¬850.000"></div>
            <div class="mb-4" id="jahreszielBeschreibungWrap"><label class="block text-sm font-semibold text-gray-700 mb-1">Beschreibung / SMART-Details</label><textarea id="jahreszielBeschreibung" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="S: M: A: R: T:"></textarea></div>
            <div class="grid grid-cols-3 gap-3 mb-4" id="jahreszielWerteWrap">
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Zielwert</label><input id="jahreszielZielwert" type="number" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Aktueller Wert</label><input id="jahreszielAktuellerWert" type="number" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Einheit</label><select id="jahreszielEinheit" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"><option value="â‚¬">â‚¬</option><option value="StÃ¼ck">StÃ¼ck</option><option value="Bewertungen">Bewertungen</option><option value="%">%</option></select></div>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t"><button onclick="closeJahreszielModal()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveJahresziel()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
        </div>
    </div>
</div>

<!-- Journal Modal -->
<div id="journalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display:none" onclick="if(event.target===this)closeJournalModal()">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">GesprÃ¤ch protokollieren</h3><button onclick="closeJournalModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button></div>
            <input type="hidden" id="journalEditId" value="">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Datum</label><input id="journalDatum" type="date" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Stimmung</label>
                    <div class="flex space-x-3 mt-1">
                        <button type="button" onclick="setJournalStimmung('positiv')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="positiv">ðŸ˜Š</button>
                        <button type="button" onclick="setJournalStimmung('neutral')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="neutral">ðŸ˜</button>
                        <button type="button" onclick="setJournalStimmung('besorgt')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="besorgt">ðŸ˜Ÿ</button>
                        <button type="button" onclick="setJournalStimmung('kritisch')" class="journal-stimmung-btn text-2xl opacity-40 hover:opacity-100 transition" data-val="kritisch">ðŸ˜¤</button>
                    </div><input type="hidden" id="journalStimmung" value=""></div>
            </div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Teilnehmer</label><input id="journalTeilnehmer" type="text" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="z.B. Matthias, Sascha (HQ)"></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Themen</label>
                <div class="flex flex-wrap gap-2" id="journalThemenTags">
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Umsatz/Zahlen" class="journal-thema-cb hidden"><span>ðŸ’° Umsatz</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Personal" class="journal-thema-cb hidden"><span>ðŸ‘¥ Personal</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Marketing" class="journal-thema-cb hidden"><span>ðŸ“¢ Marketing</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Werkstatt" class="journal-thema-cb hidden"><span>ðŸ”§ Werkstatt</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Einkauf" class="journal-thema-cb hidden"><span>ðŸ›’ Einkauf</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Ziele" class="journal-thema-cb hidden"><span>ðŸŽ¯ Ziele</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Work-Life-Balance" class="journal-thema-cb hidden"><span>âš–ï¸ WLB</span></label>
                    <label class="flex items-center px-3 py-1.5 bg-gray-100 rounded-full text-xs font-semibold cursor-pointer hover:bg-orange-50"><input type="checkbox" value="Sonstiges" class="journal-thema-cb hidden"><span>ðŸ“Œ Sonstiges</span></label>
                </div></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Aktuelle Lage</label><textarea id="journalLage" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Wie steht der Partner da?"></textarea></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">WÃ¼nsche an HQ</label><div id="journalWuensche" class="space-y-2 mb-2"></div><button onclick="addJournalWunsch()" class="text-sm text-vit-orange font-semibold">+ Wunsch</button></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Vereinbarte MaÃŸnahmen</label><div id="journalMassnahmen" class="space-y-2 mb-2"></div><button onclick="addJournalMassnahme()" class="text-sm text-vit-orange font-semibold">+ MaÃŸnahme</button></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">Notizen</label><textarea id="journalNotizen" rows="2" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400" placeholder="Sonstiges..."></textarea></div>
            <div class="mb-4"><label class="block text-sm font-semibold text-gray-700 mb-1">NÃ¤chster Termin</label><input id="journalNaechsterTermin" type="date" class="w-full border rounded-lg px-3 py-2 text-sm focus:border-orange-400 focus:ring-1 focus:ring-orange-400"></div>
            <div class="flex justify-end space-x-3 pt-4 border-t"><button onclick="closeJournalModal()" class="px-4 py-2 text-sm text-gray-600">Abbrechen</button><button onclick="saveJournalEntry()" class="px-4 py-2 bg-vit-orange text-white text-sm font-semibold rounded-lg hover:opacity-90">Speichern</button></div>
        </div>
    </div>
</div>


<!-- vit:bikes Marketing Module React Components (Cockpit, Budget, Kampagnen, Reichweite) -->
<script type="text/babel">
(function(){
const{useState,useReducer,useEffect,createContext,useContext}=React;
const uid=()=>Math.random().toString(36).slice(2,9);
const fmt=v=>v.toLocaleString("de-DE");
const fmtE=v=>fmt(v)+" \u20ac";
const pct=(a,b)=>b?Math.round(a/b*100):0;
const clp=(v,a,b)=>Math.max(a,Math.min(b,v));
const ST=(function(){var dm=window.isDemoMode||(window.sbProfile&&(window.sbProfile.status==='demo'||window.sbProfile.status==='demo_active'));return{name:dm?'Muster-Filiale':(window.sbProfile&&window.sbProfile.standort_name?window.sbProfile.standort_name:'Mein Standort'),plz:dm?'12345':(window.sbProfile&&window.sbProfile.standort_plz?window.sbProfile.standort_plz:'')};})(),YR=2026,UZ=838000,OBM=1500,LBM=600;
const MO=["Jan","Feb","M\u00e4r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];

const SCORE={total:72,parts:[{n:"Google My Business",s:78,w:30,i:"\ud83d\udccd",c:"#2563eb"},{n:"Paid Reichweite",s:65,w:25,i:"\ud83c\udfaf",c:"#EF7D00"},{n:"Bewertungen",s:82,w:20,i:"\u2b50",c:"#ca8a04"},{n:"Organische Pr\u00e4senz",s:60,w:15,i:"\ud83d\udce1",c:"#9333ea"},{n:"Lokales Marketing",s:70,w:10,i:"\ud83c\udfea",c:"#16a34a"}],trend:[58,61,64,63,67,69,68,72],rank:12,ts:28,tips:[{a:"GMB Antwortrate auf 100%",p:4,e:"Einfach"},{a:"5 neue GMB-Fotos",p:3,e:"Einfach"},{a:"Lokales Event Q1",p:5,e:"Mittel"},{a:"Local Hero Video",p:4,e:"Mittel"}]};
const FN=[{l:"Budget",i:"\ud83d\udcb0",ist:3155,soll:3000,f:fmtE},{l:"Reichweite",i:"\ud83d\udc41",ist:192350,soll:200000,f:fmt},{l:"Klicks",i:"\ud83d\udc46",ist:1620,soll:1600,f:fmt},{l:"Leads",i:"\ud83c\udfaf",ist:10,soll:12,f:fmt},{l:"Termine",i:"\ud83d\udcc5",ist:7,soll:10,f:fmt},{l:"Abschl\u00fcsse",i:"\ud83e\udd1d",ist:4,soll:7,f:fmt},{l:"Umsatz",i:"\ud83d\udcb6",ist:19200,soll:100560,f:fmtE}];
const OL={ch:[{name:"Google Ads",icon:"\ud83d\udd0d",color:"#f59e0b",split:.8,k:{ko:1445,im:43541,cl:1049,le:4}},{name:"Meta Ads",icon:"\ud83d\udcd8",color:"#3b82f6",split:.2,k:{ko:279,im:148809,cl:571,le:2}}],mo:[{m:"Jan",g:1152,me:279,le:4,te:3,u:6800},{m:"Feb",g:1445,me:279,le:6,te:4,u:12400}],nw:{cpt:163,lm:9,sv:22,bm:1436}};
const LK=[{id:"e",n:"Events",i:"\ud83c\udfea",c:"#EF7D00"},{id:"f",n:"Print",i:"\ud83d\udcc4",c:"#9333ea"},{id:"o",n:"OOH",i:"\ud83e\udea7",c:"#2563eb"},{id:"s",n:"Sponsoring",i:"\ud83e\udd1d",c:"#16a34a"},{id:"x",n:"Sonstiges",i:"\ud83d\udce6",c:"#9ca3af"}];
const DL=[{id:"la1",kat:"e",t:"Fr\u00fchlings-Probefahrt-Tag",b:350,mo:2,s:"geplant"},{id:"la2",kat:"f",t:"Flyer Fr\u00fchjahrsaktion",b:180,mo:2,s:"bezahlt"},{id:"la3",kat:"o",t:"Banner Hauptstra\u00dfe",b:450,mo:0,s:"laufend"},{id:"la4",kat:"s",t:"TSV Trikots",b:200,mo:1,s:"bezahlt"},{id:"la5",kat:"e",t:"E-Bike Testevent",b:500,mo:3,s:"geplant"}];
const DKA=[{id:"k1",t:"Fr\u00fchjahrs-kampagne",typ:"hq",ch:"Google+Meta",st:"2026-02-15",en:"2026-04-30",s:"aktiv",b:4500,d:"Performance-Max"},{id:"k2",t:"E-Bike Leasing",typ:"hq",ch:"Meta",st:"2026-03-01",en:"2026-05-31",s:"geplant",b:2000,d:"Pendler"},{id:"k3",t:"Awareness Ganzjahr",typ:"hq",ch:"Google",st:"2026-01-01",en:"2026-12-31",s:"aktiv",b:12000,d:"Brand"},{id:"k4",t:"Probefahrt-Tag",typ:"lokal",ch:"Lokal",st:"2026-03-15",en:"2026-03-15",s:"geplant",b:350,d:"Testtag"},{id:"k5",t:"Stadtradeln",typ:"lokal",ch:"Lokal",st:"2026-05-01",en:"2026-05-21",s:"geplant",b:300,d:"Teamsponsor"}];
const ADS=[{n:"PerformanceMax",ch:"Google",sp:1162,im:39296,cl:848,le:3,cpc:1.37,ctr:2.16,co:"#f59e0b",bu:1162},{n:"Search Service",ch:"Google",sp:142,im:1944,cl:129,le:1,cpc:1.10,ctr:6.63,co:"#f59e0b",bu:150},{n:"Search Marken",ch:"Google",sp:141,im:2301,cl:72,le:0,cpc:1.96,ctr:3.13,co:"#f59e0b",bu:150},{n:"Awareness Lokal",ch:"Meta",sp:140,im:120730,cl:153,le:0,cpc:0.92,ctr:0.13,co:"#3b82f6",bu:140},{n:"Conversion E-Bike",ch:"Meta",sp:139,im:28079,cl:418,le:2,cpc:0.33,ctr:1.49,co:"#3b82f6",bu:140}];
const GMB={ra:4.7,rv:142,rr:87,kpis:[{l:"Aufrufe",v:1847,c:12,i:"\ud83d\udc41"},{l:"Anrufe",v:34,c:8,i:"\ud83d\udcde"},{l:"Routen",v:89,c:15,i:"\ud83d\uddfa"},{l:"Website",v:156,c:-3,i:"\ud83c\udf10"},{l:"Fotos",v:2340,c:22,i:"\ud83d\udcf8"},{l:"Nachrichten",v:12,c:50,i:"\ud83d\udcac"}],revs:[{a:"Sandra M.",r:5,t:"Super Beratung!",d:"12.02",ok:true},{a:"Thomas K.",r:5,t:"Top Service.",d:"08.02",ok:true},{a:"Julia W.",r:4,t:"Etwas Wartezeit.",d:"03.02",ok:false},{a:"Peter H.",r:3,t:"Mehr Leasing-Infos.",d:"28.01",ok:true}],di:[87,32,14,5,4]};
const ORG=[{n:"YouTube",i:"\ud83c\udfa5",co:"#ef4444",kp:[{l:"Subs",v:"12.4k",c:"+1.1k"},{l:"Views",v:"745k",c:"+12%"},{l:"Watch",v:"41.7kh",c:"+8%"},{l:"Likes",v:"11.6k",c:"+15%"}],no:"3 Videos"},{n:"Instagram",i:"\ud83d\udcf8",co:"#c026d3",kp:[{l:"Follower",v:"10.2k",c:"+340"},{l:"Engage",v:"4.2%",c:"+0.3%"},{l:"Posts",v:"847",c:"+12"},{l:"Reach",v:"3.4k",c:"+18%"}],no:"2 Posts+4 Stories"},{n:"TikTok",i:"\ud83c\udfb5",co:"#6b7280",kp:[{l:"Follower",v:"2.8k",c:"+210"},{l:"Videos",v:"124",c:"+6"},{l:"Likes",v:"89k",c:"+4.2k"},{l:"Views",v:"18.2k",c:"+22%"}],no:"1 Reel (8.4k)"}];

// State
function reducer(s,a){switch(a.type){case"AL":return{...s,lo:[...s.lo,{id:uid(),...a.d}]};case"DL":return{...s,lo:s.lo.filter(x=>x.id!==a.id)};case"AK":return{...s,ka:[...s.ka,{id:uid(),...a.d}]};case"DK":return{...s,ka:s.ka.filter(x=>x.id!==a.id)};default:return s;}}
const Ctx=createContext(null);
const useApp=()=>useContext(Ctx);

// Shared
const cs={card:"bg-white rounded-xl border border-gray-200 shadow-sm p-5 mb-4 hover:shadow-md transition-shadow",mono:"font-mono",lbl:"text-[9px] text-gray-400 font-semibold uppercase tracking-wider mb-1"};
function Bar({value,max,color="#EF7D00",h=4}){const p=max?clp(Math.round(value/max*100),0,100):0;return<div style={{height:h,background:"var(--c-bg3)",borderRadius:h,overflow:"hidden",width:"100%"}}><div style={{height:"100%",width:p+"%",background:color,borderRadius:h,transition:"width .8s ease"}}/></div>;}
function Bdg({text,color="#EF7D00"}){return<span className={cs.mono} style={{fontSize:9,fontWeight:600,color,background:color+"15",padding:"3px 8px",borderRadius:6}}>{text}</span>;}
function SBdg({s}){const m={aktiv:{t:"LIVE",c:"#16a34a"},geplant:{t:"GEPLANT",c:"#2563eb"},bezahlt:{t:"BEZAHLT",c:"#9ca3af"},laufend:{t:"LAUFEND",c:"#EF7D00"}};const x=m[s]||m.geplant;return<Bdg text={x.t} color={x.c}/>;}
function Ring({score,size=140,sw=7}){const r=(size-sw)/2,ci=2*Math.PI*r,of=ci-(score/100)*ci;return<svg width={size} height={size} style={{transform:"rotate(-90deg)"}}><circle cx={size/2} cy={size/2} r={r} fill="none" stroke="var(--c-bg3)" strokeWidth={sw}/><circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#EF7D00" strokeWidth={sw} strokeDasharray={ci} strokeDashoffset={of} strokeLinecap="round" style={{transition:"stroke-dashoffset 1.2s ease"}}/></svg>;}

// â•â• COCKPIT â•â•
function Cockpit(){
  const up=pct(FN[6].ist,UZ),usp=pct(FN[6].ist,FN[6].soll);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
      <div className={cs.card} style={{boxShadow:"0 0 20px rgba(239,125,0,0.12)"}}>
        <div style={{display:"flex",alignItems:"center",gap:20}}>
          <div style={{position:"relative",flexShrink:0}}><Ring score={SCORE.total}/><div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}><span style={{fontSize:40,fontWeight:900,color:"#EF7D00"}}>{SCORE.total}</span><span style={{fontSize:10,color:"var(--c-muted)"}}>von 100</span></div></div>
          <div style={{flex:1}}><h2 style={{fontSize:16,fontWeight:800,color:"var(--c-text)",marginBottom:2}}>Sichtbarkeitsscore</h2><p style={{fontSize:11,color:"var(--c-sub)",marginBottom:10}}>Deine lokale Sichtbarkeit</p>
            {SCORE.parts.map((p,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:6,marginBottom:5}}><span style={{fontSize:11,width:14}}>{p.i}</span><span style={{fontSize:10,color:"var(--c-sub)",flex:1}}>{p.n}</span><div style={{width:70}}><Bar value={p.s} max={100} color={p.c} h={3}/></div><span className={cs.mono} style={{fontSize:10,color:p.c,width:24,textAlign:"right"}}>{p.s}</span></div>)}
            <div style={{display:"flex",alignItems:"center",gap:10,marginTop:10,padding:"7px 10px",background:"var(--c-bg2)",borderRadius:8}}><span style={{fontSize:10,color:"var(--c-muted)"}}>Rang</span><span className={cs.mono} style={{fontSize:15,fontWeight:800,color:"#EF7D00"}}>{SCORE.rank}</span><span style={{fontSize:10,color:"var(--c-muted)"}}>/ {SCORE.ts}</span><div style={{flex:1}}/><svg width={56} height={16}>{SCORE.trend.map((v,i)=>i>0?<line key={i} x1={(i-1)*8} y1={16-((SCORE.trend[i-1]-50)/40)*16} x2={i*8} y2={16-((v-50)/40)*16} stroke="#EF7D00" strokeWidth={1.5}/>:null)}</svg></div>
          </div>
        </div>
      </div>
      <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:16,fontWeight:800,color:"var(--c-text)"}}>Umsatzziel {YR}</h2><p style={{fontSize:11,color:"var(--c-muted)"}}>{ST.name}</p></div><span style={{fontSize:26,fontWeight:900,color:"#EF7D00"}}>{fmtE(UZ)}</span></div><div style={{marginBottom:10}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:11,color:"var(--c-sub)"}}>{fmtE(FN[6].ist)} erreicht</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:up>=10?"#16a34a":"#dc2626"}}>{up}%</span></div><Bar value={FN[6].ist} max={UZ} h={7}/></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginTop:14}}>{[["YTD Soll",fmtE(FN[6].soll)],["Zielerr.",usp+"%",usp>=90?"#16a34a":"#dc2626"],["Ã˜ Bon",fmtE(Math.round(FN[6].ist/(FN[5].ist||1)))]].map(([l,v,c],i)=><div key={i} style={{padding:10,background:"var(--c-bg2)",borderRadius:10,textAlign:"center"}}><p className={cs.lbl}>{l}</p><p className={cs.mono} style={{fontSize:15,fontWeight:700,color:c||"#111827"}}>{v}</p></div>)}</div>
      </div>
    </div>
    {/* Funnel */}
    <div className={cs.card} style={{padding:24}}><h2 style={{fontSize:15,fontWeight:800,color:"var(--c-text)",marginBottom:3}}>Marketing-Funnel</h2><p style={{fontSize:10,color:"var(--c-muted)",marginBottom:16}}>Budget \u2192 Reichweite \u2192 Klicks \u2192 Leads \u2192 Termine \u2192 Abschl\u00fcsse \u2192 Umsatz</p>
      <div style={{display:"flex",alignItems:"stretch",gap:0}}>{FN.map((s,i)=>{const r=s.soll?s.ist/s.soll:1;const col=r>=.9?"#16a34a":r>=.7?"#ca8a04":"#dc2626";const bg=r>=.9?"rgba(22,163,74,0.06)":r>=.7?"rgba(202,138,4,0.06)":"rgba(220,38,38,0.06)";const cv=i>0&&i<6?(FN[i].ist/(FN[i-1].ist||1)*100):null;return<React.Fragment key={i}><div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",padding:"14px 6px",background:bg,borderRadius:10,border:"1px solid "+col+"25"}}><span style={{fontSize:20,marginBottom:4}}>{s.i}</span><span className={cs.mono} style={{fontSize:15,fontWeight:800,color:col}}>{s.f(s.ist)}</span><span style={{fontSize:8,color:"var(--c-muted)",marginTop:3}}>{s.l}</span><div style={{width:"100%",margin:"6px 0 3px"}}><Bar value={s.ist} max={s.soll} color={col} h={3}/></div><span className={cs.mono} style={{fontSize:8,color:"var(--c-muted)"}}>{Math.round(r*100)}%</span></div>{i<FN.length-1&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:28,flexShrink:0}}><svg width="14" height="10" viewBox="0 0 14 10"><path d="M0 5h10M8 1l4 4-4 4" fill="none" stroke="#d1d5db" strokeWidth="1.2"/></svg>{cv!==null&&<span className={cs.mono} style={{fontSize:7,color:"var(--c-muted)",marginTop:1}}>{cv<1?cv.toFixed(2):cv.toFixed(0)}%</span>}</div>}</React.Fragment>;})}</div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}><div className={cs.card}><h2 style={{fontSize:13,fontWeight:800,color:"var(--c-text)",marginBottom:10}}>\ud83d\ude80 Score verbessern</h2>{SCORE.tips.map((t,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:i<SCORE.tips.length-1?"1px solid var(--c-border2)":"none"}}><div style={{width:32,height:32,borderRadius:8,background:"rgba(239,125,0,0.08)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><span className={cs.mono} style={{fontSize:12,fontWeight:800,color:"#EF7D00"}}>+{t.p}</span></div><div><p style={{fontSize:11,fontWeight:600,color:"var(--c-text)"}}>{t.a}</p><p style={{fontSize:9,color:"var(--c-muted)"}}>{t.e}</p></div></div>)}</div>
      <div className={cs.card}><h2 style={{fontSize:13,fontWeight:800,color:"var(--c-text)",marginBottom:10}}>\ud83d\udcc8 vs. Netzwerk</h2>{[["Budget/Mo",fmtE(OBM),fmtE(OL.nw.bm),null],["Leads/Mo","5.0","9.0",true],["CPT",fmtE(Math.round(3155/7)),fmtE(163),true],["Store Visits","39","22",false]].map(([l,mi,nw,nb],i)=><div key={i} style={{display:"flex",alignItems:"center",gap:6,padding:"8px 0",borderBottom:i<3?"1px solid var(--c-border2)":"none"}}><span style={{fontSize:11,color:"var(--c-muted)",flex:1}}>{l}</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:70,textAlign:"right",color:"var(--c-text)"}}>{mi}</span><span style={{fontSize:9,color:"var(--c-muted)"}}>vs</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:70,textAlign:"right",color:nb?"#16a34a":"#6b7280"}}>{nw}{nb&&" \u2713"}</span></div>)}</div>
    </div>
  </div>;
}

// â•â• BUDGET â•â•
function Budget(){
  const{state:st,dispatch:dp}=useApp();const[sa,setSa]=useState(false);const[fm,sFm]=useState({t:"",k:"e",b:"",m:2,s:"geplant"});
  const ad=()=>{if(!fm.t||!fm.b)return;dp({type:"AL",d:{kat:fm.k,t:fm.t,b:Number(fm.b),mo:fm.m,s:fm.s}});setSa(false);};
  const lt=st.lo.reduce((s,a)=>s+a.b,0),lj=LBM*12,oY=OL.mo.reduce((s,m)=>s+m.g+m.me,0);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:16}}>{[{l:"Gesamtbudget",v:fmtE(OBM*12+lj),s:fmtE(OBM+LBM)+"/Mo"},{l:"Online (HQ)",v:fmtE(OBM*12),s:"HQ steuert",c:"#2563eb"},{l:"Lokal (Du)",v:fmtE(lj),s:"Du steuerst",c:"#EF7D00"},{l:"Ausgegeben YTD",v:fmtE(oY+lt),s:pct(oY+lt,OBM*12+lj)+"% v. Jahr"}].map((k,i)=><div key={i} className={cs.card} style={{textAlign:"center",padding:14}}><p className={cs.lbl}>{k.l}</p><p className={cs.mono} style={{fontSize:20,fontWeight:800,color:k.c||"#111827"}}>{k.v}</p><p style={{fontSize:9,color:"var(--c-muted)",marginTop:2}}>{k.s}</p></div>)}</div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"var(--c-text)"}}>Online-Marketing</h2><p style={{fontSize:10,color:"var(--c-muted)"}}>HQ steuert die Aufteilung</p></div><Bdg text="HQ-GESTEUERT" color="#2563eb"/></div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>{OL.ch.map(ch=><div key={ch.name} style={{padding:14,background:"var(--c-bg2)",borderRadius:10,borderLeft:"3px solid "+ch.color}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><span style={{fontWeight:700,fontSize:12,color:"var(--c-text)"}}>{ch.icon} {ch.name}</span><span className={cs.mono} style={{fontSize:10,color:"var(--c-muted)"}}>{Math.round(ch.split*100)}%</span></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}}>{[["Kosten",fmtE(ch.k.ko)],["Klicks",fmt(ch.k.cl)],["Leads",""+ch.k.le]].map(([l,v],j)=><div key={j}><p style={{fontSize:8,color:"var(--c-muted)"}}>{l}</p><p className={cs.mono} style={{fontSize:13,fontWeight:700,color:"var(--c-text)"}}>{v}</p></div>)}</div></div>)}</div>
    </div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"var(--c-text)"}}>Lokales Marketing</h2><p style={{fontSize:10,color:"var(--c-muted)"}}>Dein Budget, deine Entscheidung</p></div><div style={{display:"flex",gap:6}}><Bdg text="DU STEUERST" color="#EF7D00"/><button onClick={()=>setSa(!sa)} style={{padding:"6px 14px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>+ Ausgabe</button></div></div>
      <div style={{padding:14,background:"var(--c-bg2)",borderRadius:10,marginBottom:14}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:11,color:"var(--c-sub)"}}>{fmtE(lt)} von {fmtE(lj)}</span><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:"#EF7D00"}}>{pct(lt,lj)}%</span></div><Bar value={lt} max={lj} h={5}/></div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:6,marginBottom:14}}>{LK.map(k=>{const sm=st.lo.filter(a=>a.kat===k.id).reduce((s,a)=>s+a.b,0);return<div key={k.id} style={{padding:10,background:"var(--c-bg2)",borderRadius:8,textAlign:"center"}}><span style={{fontSize:16}}>{k.i}</span><p className={cs.mono} style={{fontSize:13,fontWeight:700,color:k.c,marginTop:2}}>{fmtE(sm)}</p><p style={{fontSize:8,color:"var(--c-muted)"}}>{k.n}</p></div>;})}</div>
      {sa&&<div style={{padding:14,background:"#fff7ed",borderRadius:10,marginBottom:14,border:"1px solid #fed7aa"}}><div style={{display:"flex",gap:6,flexWrap:"wrap"}}><input value={fm.t} onChange={e=>sFm({...fm,t:e.target.value})} placeholder="Titel..." style={{flex:1,minWidth:140,padding:"6px 10px",border:"1px solid var(--c-border)",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}/><select value={fm.k} onChange={e=>sFm({...fm,k:e.target.value})} style={{padding:"6px 10px",border:"1px solid var(--c-border)",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}>{LK.map(k=><option key={k.id} value={k.id}>{k.i} {k.n}</option>)}</select><input type="number" value={fm.b} onChange={e=>sFm({...fm,b:e.target.value})} placeholder="\u20ac" style={{width:70,padding:"6px 10px",border:"1px solid var(--c-border)",borderRadius:8,fontSize:12,fontFamily:"Outfit"}}/><button onClick={ad} style={{padding:"6px 16px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>Speichern</button></div></div>}
      {st.lo.map(a=>{const k=LK.find(x=>x.id===a.kat)||LK[4];return<div key={a.id} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0",borderBottom:"1px solid var(--c-border2)"}}><span style={{fontSize:14}}>{k.i}</span><div style={{flex:1}}><span style={{fontSize:11,fontWeight:600,color:"var(--c-text)"}}>{a.t}</span><span style={{fontSize:9,color:"var(--c-muted)",marginLeft:6}}>{MO[a.mo]}</span></div><SBdg s={a.s}/><span className={cs.mono} style={{fontSize:12,fontWeight:700,width:60,textAlign:"right",color:"var(--c-text)"}}>{fmtE(a.b)}</span><button onClick={()=>dp({type:"DL",id:a.id})} style={{background:"none",border:"none",color:"var(--c-muted)",cursor:"pointer",fontSize:12}}>\u2715</button></div>;})}
    </div>
  </div>;
}

// â•â• KAMPAGNEN â•â•
function Kampagnen(){
  const{state:st,dispatch:dp}=useApp();const[fi,sFi]=useState("alle");const[sa,setSa]=useState(false);const[fm,sFm]=useState({t:"",ch:"Lokal",st:"",en:"",b:"",d:"",typ:"lokal",s:"geplant"});
  const ak=()=>{if(!fm.t)return;dp({type:"AK",d:{...fm,b:Number(fm.b)||0}});setSa(false);};
  const fl=st.ka.filter(k=>fi==="hq"?k.typ==="hq":fi==="lokal"?k.typ==="lokal":fi==="aktiv"?k.s==="aktiv":true).sort((a,b)=>(a.st||"").localeCompare(b.st||""));
  const tM=MO.slice(0,6);
  return<div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:16}}>{[{l:"Gesamt",v:st.ka.length},{l:"Aktiv",v:st.ka.filter(k=>k.s==="aktiv").length,c:"#16a34a"},{l:"HQ",v:st.ka.filter(k=>k.typ==="hq").length,c:"#2563eb"},{l:"Eigene",v:st.ka.filter(k=>k.typ==="lokal").length,c:"#EF7D00"}].map((k,i)=><div key={i} className={cs.card} style={{textAlign:"center",padding:14}}><p className={cs.lbl}>{k.l}</p><p className={cs.mono} style={{fontSize:26,fontWeight:800,color:k.c||"#111827"}}>{k.v}</p></div>)}</div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div style={{display:"flex",gap:4}}>{[{k:"alle",l:"Alle"},{k:"aktiv",l:"Aktiv"},{k:"hq",l:"\ud83c\udfe2 HQ"},{k:"lokal",l:"\ud83d\udccd Eigene"}].map(f=><button key={f.k} onClick={()=>sFi(f.k)} style={{padding:"4px 10px",borderRadius:7,border:"1px solid "+(fi===f.k?"#EF7D00":"#e5e7eb"),background:fi===f.k?"rgba(239,125,0,0.08)":"transparent",color:fi===f.k?"#EF7D00":"#9ca3af",fontSize:10,fontWeight:600,cursor:"pointer",fontFamily:"Outfit"}}>{f.l}</button>)}</div><button onClick={()=>setSa(!sa)} style={{padding:"6px 14px",background:"#EF7D00",color:"#fff",border:"none",borderRadius:8,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"Outfit"}}>+ Eigene Aktion</button></div>
      {fl.map(k=><div key={k.id} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 0",borderBottom:"1px solid var(--c-border2)"}}><div style={{width:3,height:28,borderRadius:2,background:k.typ==="hq"?"#2563eb":"#EF7D00",flexShrink:0}}/><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:1}}><span style={{fontSize:12,fontWeight:700,color:"var(--c-text)"}}>{k.t}</span><SBdg s={k.s}/>{k.typ==="hq"&&<Bdg text="HQ" color="#2563eb"/>}</div><div style={{display:"flex",gap:10,fontSize:9,color:"var(--c-muted)"}}><span>{k.ch}</span>{k.st&&<span>{k.st.slice(5)}\u2192{k.en?.slice(5)||"?"}</span>}<span className={cs.mono}>{fmtE(k.b)}</span></div></div>{k.typ==="lokal"&&<button onClick={()=>dp({type:"DK",id:k.id})} style={{background:"none",border:"none",color:"var(--c-muted)",cursor:"pointer",fontSize:12}}>\u2715</button>}</div>)}
    </div>
  </div>;
}

// â•â• REICHWEITE â•â•
function Reichweite(){
  const[rf,sRf]=useState("alle");const fr=GMB.revs.filter(r=>rf==="offen"?!r.ok:rf==="kritisch"?r.r<=3:true);
  return<div>
    <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:14}}><div><h2 style={{fontSize:15,fontWeight:800,color:"var(--c-text)"}}>Aktive Kampagnen</h2><p style={{fontSize:10,color:"var(--c-muted)"}}>Was das HQ f\u00fcr dich schaltet</p></div><Bdg text="\u25cf LIVE" color="#16a34a"/></div>
      {ADS.map((c,i)=><div key={i} style={{padding:12,background:"var(--c-bg2)",borderRadius:10,marginBottom:6,borderLeft:"3px solid "+c.co}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}><div style={{display:"flex",gap:6,alignItems:"center"}}><span style={{fontSize:11,fontWeight:700,color:"var(--c-text)"}}>{c.n}</span><Bdg text={c.ch} color={c.co}/></div><span className={cs.mono} style={{fontSize:12,fontWeight:700,color:"var(--c-text)"}}>{fmtE(c.sp)}</span></div><div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr) 1.2fr",gap:8}}>{[["Impr.",fmt(c.im)],["Klicks",fmt(c.cl)],["CTR",c.ctr+"%"],["CPC",c.cpc.toFixed(2)+"\u20ac"],["Leads",""+c.le]].map(([l,v],j)=><div key={j}><p style={{fontSize:7,color:"var(--c-muted)",textTransform:"uppercase"}}>{l}</p><p className={cs.mono} style={{fontSize:12,fontWeight:700,color:l==="Leads"&&c.le>0?"#16a34a":"#111827"}}>{v}</p></div>)}<div><p style={{fontSize:7,color:"var(--c-muted)",textTransform:"uppercase"}}>Budget</p><Bar value={c.sp} max={c.bu} color={c.co} h={3}/></div></div></div>)}
    </div>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
      <div className={cs.card}><div style={{display:"flex",alignItems:"center",gap:8,marginBottom:14}}><div style={{width:32,height:32,borderRadius:8,background:"linear-gradient(135deg,#4285F4,#34A853)",display:"flex",alignItems:"center",justifyContent:"center"}}><span style={{color:"#fff",fontSize:14,fontWeight:900}}>G</span></div><div><h2 style={{fontSize:13,fontWeight:800,color:"var(--c-text)"}}>Google My Business</h2><div style={{display:"flex",alignItems:"center",gap:3}}><span style={{color:"#fbbf24",fontSize:12}}>\u2605</span><span className={cs.mono} style={{fontSize:13,fontWeight:700,color:"var(--c-text)"}}>{GMB.ra}</span><span style={{fontSize:9,color:"var(--c-muted)"}}>({GMB.rv})</span></div></div></div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:6}}>{GMB.kpis.map((k,i)=><div key={i} style={{padding:8,background:"var(--c-bg2)",borderRadius:8,textAlign:"center"}}><span style={{fontSize:12}}>{k.i}</span><p className={cs.mono} style={{fontSize:14,fontWeight:700,color:"var(--c-text)",marginTop:1}}>{fmt(k.v)}</p><p style={{fontSize:7,color:"var(--c-muted)"}}>{k.l}</p><p className={cs.mono} style={{fontSize:8,color:k.c>0?"#16a34a":"#dc2626"}}>{k.c>0?"+":""}{k.c}%</p></div>)}</div>
      </div>
      <div className={cs.card}><div style={{display:"flex",justifyContent:"space-between",marginBottom:10}}><h2 style={{fontSize:13,fontWeight:800,color:"var(--c-text)"}}>\u2b50 Bewertungen</h2><div style={{display:"flex",gap:3}}>{[{k:"alle",l:"Alle"},{k:"offen",l:"Offen"},{k:"kritisch",l:"\u26a0 1-3"}].map(f=><button key={f.k} onClick={()=>sRf(f.k)} style={{padding:"2px 7px",borderRadius:5,border:"1px solid "+(rf===f.k?"#EF7D00":"#e5e7eb"),background:rf===f.k?"rgba(239,125,0,0.06)":"transparent",color:rf===f.k?"#EF7D00":"#9ca3af",fontSize:9,fontWeight:600,cursor:"pointer",fontFamily:"Outfit"}}>{f.l}</button>)}</div></div>
        {fr.map((r,i)=><div key={i} style={{padding:8,borderRadius:8,marginBottom:3,background:!r.ok?"#fefce8":"#f9fafb",border:"1px solid "+(r.ok?"#f3f4f6":"#fde68a")}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:1}}><div style={{display:"flex",alignItems:"center",gap:4}}><span style={{fontSize:10,fontWeight:600,color:"var(--c-text)"}}>{r.a}</span><span style={{fontSize:8,color:"var(--c-muted)"}}>{r.d}</span></div><div style={{display:"flex",alignItems:"center",gap:3}}>{[1,2,3,4,5].map(s=><span key={s} style={{color:s<=r.r?"#fbbf24":"#e5e7eb",fontSize:8}}>\u2605</span>)}{r.ok?<Bdg text="\u2713" color="#16a34a"/>:<Bdg text="OFFEN" color="#ca8a04"/>}</div></div><p style={{fontSize:10,color:"var(--c-sub)",marginLeft:0}}>{r.t}</p></div>)}
      </div>
    </div>
    <div className={cs.card}><h2 style={{fontSize:15,fontWeight:800,color:"var(--c-text)",marginBottom:3}}>\ud83d\udce1 Organische Reichweite</h2><p style={{fontSize:10,color:"var(--c-muted)",marginBottom:14}}>vit:bikes Brand inkl. deiner Sichtbarkeit</p>
      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>{ORG.map(ch=><div key={ch.n} style={{padding:14,background:"var(--c-bg2)",borderRadius:10,borderTop:"2px solid "+ch.co}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:10}}><span style={{fontSize:18}}>{ch.i}</span><span style={{fontSize:13,fontWeight:800,color:"var(--c-text)"}}>{ch.n}</span></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>{ch.kp.map((k,i)=><div key={i}><p style={{fontSize:7,color:"var(--c-muted)",textTransform:"uppercase"}}>{k.l}</p><p className={cs.mono} style={{fontSize:14,fontWeight:700,color:"var(--c-text)"}}>{k.v}</p><p className={cs.mono} style={{fontSize:8,color:"#16a34a"}}>{k.c}</p></div>)}</div><div style={{marginTop:10,padding:6,background:"var(--c-bg)",borderRadius:6,border:"1px solid var(--c-border2)"}}><p style={{fontSize:9,color:"var(--c-sub)"}}>\ud83d\udccd {ch.no}</p></div></div>)}</div>
    </div>
  </div>;
}

// â•â• APP WRAPPER (shared state) â•â•
function MktApp({tab}){
  const[state,dispatch]=useReducer(reducer,{lo:DL,ka:DKA});
  const comps={cockpit:Cockpit,budget:Budget,kampagnen:Kampagnen,reichweite:Reichweite};
  const C=comps[tab]||Cockpit;
  return<Ctx.Provider value={{state,dispatch}}><C/></Ctx.Provider>;
}

// Mount into portal containers
const mktState={lo:DL,ka:DKA};
function mountMktTab(tab,elId){
  const el=document.getElementById(elId);
  if(el&&!el._mounted){el._mounted=true;ReactDOM.createRoot(el).render(<MktApp tab={tab}/>);}
}

// Observe tab visibility to mount on first show
const mktObs=new MutationObserver(()=>{
  const tabs={mktReactCockpit:"cockpit",mktReactBudget:"budget",mktReactKampagnen:"kampagnen",mktReactReichweite:"reichweite"};
  Object.entries(tabs).forEach(([elId,tab])=>{
    const el=document.getElementById(elId);
    if(el&&el.offsetParent!==null) mountMktTab(tab,elId);
  });
});

// Start observing when marketing view becomes visible
const initMkt=()=>{
  const mv=document.getElementById("marketingView");
  if(mv){mktObs.observe(mv,{attributes:true,subtree:true,attributeFilter:["style"]});}
  // Mount cockpit immediately if visible
  setTimeout(()=>mountMktTab("cockpit","mktReactCockpit"),100);
};

// Hook into existing showMarketingTab
const _origMktTab=window.showMarketingTab;
if(_origMktTab){
  window.showMarketingTab=function(t){
    _origMktTab(t);
    setTimeout(()=>{
      const tabs={cockpit:"mktReactCockpit",budget:"mktReactBudget",kampagnen:"mktReactKampagnen",reichweite:"mktReactReichweite"};
      if(tabs[t]) mountMktTab(t,tabs[t]);
    },50);
  };
}

// Init on DOM ready
if(document.readyState==="complete") initMkt();
else window.addEventListener("load",initMkt);
})();
</script>

<!-- Theme Switching -->
<script>
// â•â•â• GLOBAL TOAST NOTIFICATION â•â•â•
window.showToast = function(message, type) {
    type = type || 'info';
    var colors = {success:'#16a34a',error:'#ef4444',warning:'#f59e0b',info:'#3b82f6'};
    var icons = {success:'âœ…',error:'âŒ',warning:'âš ï¸',info:'â„¹ï¸'};
    var bg = colors[type] || colors.info;
    var icon = icons[type] || '';
    var t = document.createElement('div');
    t.style.cssText = 'position:fixed;top:16px;right:16px;z-index:99999;padding:12px 20px;border-radius:10px;background:'+bg+';color:white;font-size:13px;font-weight:600;font-family:Outfit,sans-serif;box-shadow:0 4px 16px rgba(0,0,0,0.2);opacity:0;transition:opacity 0.3s;max-width:400px;';
    t.textContent = icon + ' ' + message;
    document.body.appendChild(t);
    requestAnimationFrame(function(){t.style.opacity='1';});
    setTimeout(function(){t.style.opacity='0';setTimeout(function(){t.remove();},300);},3500);
};
function toggleTheme() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
}
function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if(theme === 'dark') {
        document.body.classList.add('dark');
    } else {
        document.body.classList.remove('dark');
    }
    try { localStorage.setItem('vit-theme', theme); } catch(e){}
    var track = document.getElementById('themeToggleTrack');
    if(track) {
        if(theme === 'dark') track.classList.add('active');
        else track.classList.remove('active');
    }
    // Update profile panel bg
    var ps = document.getElementById('profileSlider');
    if(ps) ps.style.background = theme === 'dark' ? 'var(--dm-surface)' : '#fff';
}
// Init on load - respect saved preference
(function(){
    var saved = 'light';
    try { saved = localStorage.getItem('vit-theme') || 'light'; } catch(e){}
    setTheme(saved);
})();
</script>


<!-- â•â•â• NUTZERPROFIL SLIDE-OVER PANEL â•â•â• -->
<div id="profilePanel" style="display:none;position:fixed;inset:0;z-index:9999;">
    <!-- Backdrop -->
    <div onclick="closeProfilePanel()" style="position:absolute;inset:0;background:rgba(0,0,0,0.4);transition:opacity 0.3s;" id="profileBackdrop"></div>
    <!-- Panel -->
    <div id="profileSlider" style="position:absolute;top:0;right:0;bottom:0;width:380px;max-width:100vw;background:var(--c-bg);box-shadow:-8px 0 30px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.16,1,0.3,1);overflow-y:auto;">

        <!-- Header -->
        <div style="padding:24px 24px 0;padding-top:max(24px, env(safe-area-inset-top, 24px));position:relative;">
            <button onclick="closeProfilePanel()" style="position:absolute;top:max(16px, env(safe-area-inset-top, 16px));right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--c-muted);padding:8px;z-index:10;">âœ•</button>
            <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:16px;">Mein Profil</p>

            <!-- Avatar + Name -->
            <div style="text-align:center;margin-bottom:24px;">
                <div style="position:relative;display:inline-block;">
                    <img id="profileAvatarImg" src="https://ui-avatars.com/api/?name=Demo+User&background=EF7D00&color=fff" style="width:80px;height:80px;border-radius:50%;border:3px solid #EF7D00;">
                    <label for="profilePhotoUpload" style="position:absolute;bottom:0;right:0;width:26px;height:26px;border-radius:50%;background:#EF7D00;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid white;font-size:12px;" title="Foto Ã¤ndern">ðŸ“·</label>
                    <input type="file" id="profilePhotoUpload" accept="image/*" style="display:none;" onchange="handleProfilePhoto(this)">
                </div>
                <h2 id="profileNameDisplay" style="font-size:20px;font-weight:800;margin-top:10px;color:var(--c-text);">Demo User</h2>
                <p id="profileRoleDisplay" style="font-size:12px;color:var(--c-muted);">Inhaber</p>
                <p id="profileStandortDisplay" style="font-size:11px;color:var(--c-muted);margin-top:2px;">ðŸ“ Grafrath</p>
            </div>
        </div>

        <!-- PersÃ¶nliche Daten -->
        <div style="padding:0 24px 24px;">
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:12px;">PersÃ¶nliche Daten</p>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:var(--c-sub);font-weight:600;display:block;margin-bottom:3px;">Vorname</label>
                    <input id="profileVorname" type="text" value="Max" style="width:100%;padding:8px 12px;border:1px solid var(--c-border);border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='var(--c-border)'">
                </div>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:var(--c-sub);font-weight:600;display:block;margin-bottom:3px;">Nachname</label>
                    <input id="profileNachname" type="text" value="Bauer" style="width:100%;padding:8px 12px;border:1px solid var(--c-border);border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='var(--c-border)'">
                </div>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:var(--c-sub);font-weight:600;display:block;margin-bottom:3px;">E-Mail</label>
                    <input id="profileEmail" type="email"  disabled style="width:100%;padding:8px 12px;border:1px solid var(--c-border);border-radius:8px;font-size:13px;background:var(--c-bg3);color:var(--c-sub);font-family:Outfit,sans-serif;">
                    <p style="font-size:9px;color:var(--c-muted);margin-top:2px;">Wird vom HQ verwaltet</p>
                </div>

                <div style="margin-bottom:12px;">
                    <label style="font-size:11px;color:var(--c-sub);font-weight:600;display:block;margin-bottom:3px;">Telefon</label>
                    <input id="profileTelefon" type="tel" value="" placeholder="+49 ..." style="width:100%;padding:8px 12px;border:1px solid var(--c-border);border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='var(--c-border)'">
                </div>

                <div style="margin-bottom:0;">
                    <label style="font-size:11px;color:var(--c-sub);font-weight:600;display:block;margin-bottom:3px;">Position / Rolle</label>
                    <input id="profilePosition" type="text" value="" placeholder="z.B. GeschÃ¤ftsfÃ¼hrer, Werkstattleiter..." style="width:100%;padding:8px 12px;border:1px solid var(--c-border);border-radius:8px;font-size:13px;font-family:Outfit,sans-serif;outline:none;" onfocus="this.style.borderColor='#EF7D00'" onblur="this.style.borderColor='var(--c-border)'">
                </div>
            </div>

            <!-- Erscheinungsbild -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;" class="bg-gray-50">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:12px;">Erscheinungsbild</p>
                <div style="display:flex;gap:8px;">
                    <button onclick="setTheme('light')" id="profileThemeLight" style="flex:1;padding:12px;border-radius:10px;border:2px solid #EF7D00;background:var(--c-bg2);cursor:pointer;text-align:center;">
                        <span style="font-size:20px;">â˜€ï¸</span>
                        <p style="font-size:11px;font-weight:600;color:var(--c-text);margin-top:4px;">Light</p>
                    </button>
                    <button onclick="setTheme('dark')" id="profileThemeDark" style="flex:1;padding:12px;border-radius:10px;border:2px solid transparent;background:var(--c-border);cursor:pointer;text-align:center;">
                        <span style="font-size:20px;">ðŸŒ™</span>
                        <p style="font-size:11px;font-weight:600;color:var(--c-muted);margin-top:4px;">Dark</p>
                    </button>
                </div>
            </div>

            <!-- Speichern -->
            <button onclick="saveProfile()" style="width:100%;padding:12px;background:#EF7D00;color:white;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:Outfit,sans-serif;margin-bottom:12px;transition:opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                Ã„nderungen speichern
            </button>

            <!-- Passwort / Abmelden -->
            <div style="display:flex;gap:8px;">
                <button onclick="changePassword()" style="flex:1;padding:8px;background:none;border:1px solid var(--c-border);border-radius:8px;font-size:11px;color:var(--c-sub);cursor:pointer;font-family:Outfit,sans-serif;">ðŸ”’ Passwort Ã¤ndern</button>
                <button onclick="handleLogout()" style="flex:1;padding:8px;background:none;border:1px solid #fecaca;border-radius:8px;font-size:11px;color:#dc2626;cursor:pointer;font-family:Outfit,sans-serif;">ðŸšª Abmelden</button>
            </div>

            <!-- Meta -->
            <!-- E-Mail-Einstellungen -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:12px;">E-Mail-Benachrichtigungen</p>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                    <span>ðŸ“Š BWA-Erinnerungen</span>
                    <input type="checkbox" checked id="prefBwa" style="accent-color:#EF7D00;width:16px;height:16px;">
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                    <span>ðŸ“ˆ Lead-Benachrichtigungen</span>
                    <input type="checkbox" checked id="prefLeads" style="accent-color:#EF7D00;width:16px;height:16px;">
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                    <span>ðŸŽ“ Trainer-Erinnerungen</span>
                    <input type="checkbox" checked id="prefTrainer" style="accent-color:#EF7D00;width:16px;height:16px;">
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                    <span>ðŸ“ž Gruppencall-Erinnerungen</span>
                    <input type="checkbox" checked id="prefCalls" style="accent-color:#EF7D00;width:16px;height:16px;">
                </label>
                <div style="border-top:1px solid var(--c-border);margin-top:8px;padding-top:8px;">
                    <div id="pushSettingsSection">
                        <div id="pushActivateArea">
                            <button id="pushToggleBtn" onclick="setupPushNotifications()" style="width:100%;padding:10px;background:#EF7D00;color:white;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;">
                                ðŸ”” Push-Benachrichtigungen aktivieren
                            </button>
                            <p style="font-size:9px;color:var(--c-muted);margin-top:4px;text-align:center">Erhalte Benachrichtigungen direkt auf dein GerÃ¤t</p>
                        </div>
                        <div id="pushActiveArea" style="display:none;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                                <span style="font-size:11px;font-weight:700;color:#059669;">âœ… Push aktiv</span>
                                <button onclick="unsubscribePush()" style="font-size:10px;color:#ef4444;background:none;border:none;cursor:pointer;text-decoration:underline;">Deaktivieren</button>
                            </div>
                            <p style="font-size:10px;font-weight:600;color:var(--c-sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Push-Benachrichtigungen</p>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸ’¬ Neue Nachrichten</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_neue_nachricht" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸ“‹ Aufgabe zugewiesen</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_aufgabe_zugewiesen" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸ“… Termin-Erinnerungen</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_termin_erinnerung" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸŽ¯ Lead-AktivitÃ¤ten</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_lead_aktivitaet" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸ“¢ AnkÃ¼ndigungen</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_ankuendigung" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <label class="notif-toggle-wrap" style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;cursor:pointer;font-size:12px;color:var(--c-sub);">
                                <span>ðŸ†˜ Support-Updates</span>
                                <input type="checkbox" checked class="notif-toggle" data-pref="push_support_update" style="accent-color:#EF7D00;width:16px;height:16px;">
                            </label>
                            <button onclick="saveNotificationPrefs()" style="width:100%;margin-top:8px;padding:7px;background:var(--c-bg3);border:1px solid #d1d5db;border-radius:6px;font-size:11px;font-weight:600;color:var(--c-text2);cursor:pointer;">ðŸ’¾ Push-Einstellungen speichern</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top:16px;padding:12px;background:var(--c-bg2);border-radius:8px;text-align:center;">
                <p style="font-size:9px;color:var(--c-muted);">vit:bikes cockpit v7.0 Â· Mitglied seit Jan 2025</p>
            </div>
        </div>
    </div>
</div>

<!-- Profile Panel JS -->
<script>
function openProfilePanel() {
    var panel = document.getElementById('profilePanel');
    var slider = document.getElementById('profileSlider');
    panel.style.display = 'block';
    // Force dark mode background
    if(document.body.classList.contains('dark')) {
        slider.style.background = '#1A1A1F';
    }
    // Populate from sbProfile if available
    if(typeof sbProfile !== 'undefined' && sbProfile) {
        var nameParts = (sbProfile.name || 'Demo User').split(' ');
        document.getElementById('profileVorname').value = nameParts[0] || '';
        document.getElementById('profileNachname').value = nameParts.slice(1).join(' ') || '';
        document.getElementById('profileEmail').value = sbProfile.email || '';
        document.getElementById('profileTelefon').value = sbProfile.telefon || '';
        document.getElementById('profilePosition').value = sbProfile.position || '';
        document.getElementById('profileNameDisplay').textContent = sbProfile.name || 'Demo User';
        document.getElementById('profileRoleDisplay').textContent = (typeof currentRole !== 'undefined' ? currentRole : 'Inhaber');
        var stdName = (typeof sbStandort !== 'undefined' && sbStandort) ? sbStandort.name : '';
        document.getElementById('profileStandortDisplay').textContent = stdName ? 'ðŸ“ ' + stdName : '';
        // Avatar
        var avatarUrl = sbProfile.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(sbProfile.name||'User') + '&background=EF7D00&color=fff';
        document.getElementById('profileAvatarImg').src = avatarUrl;
    }
    // Theme buttons
    updateProfileThemeButtons();
    // Animate in
    requestAnimationFrame(function(){
        slider.style.transform = 'translateX(0)';
    });
    // Check push status & load prefs
    setTimeout(function() { checkPushStatus(); loadNotificationPrefs(); }, 200);
}

function closeProfilePanel() {
    var slider = document.getElementById('profileSlider');
    slider.style.transform = 'translateX(100%)';
    setTimeout(function(){
        document.getElementById('profilePanel').style.display = 'none';
    }, 350);
}

function updateProfileThemeButtons() {
    var current = document.documentElement.getAttribute('data-theme') || 'light';
    var lightBtn = document.getElementById('profileThemeLight');
    var darkBtn = document.getElementById('profileThemeDark');
    if(lightBtn) lightBtn.style.borderColor = current === 'light' ? '#EF7D00' : 'transparent';
    if(darkBtn) darkBtn.style.borderColor = current === 'dark' ? '#EF7D00' : 'transparent';
}

// Override setTheme to also update profile buttons
var _origSetTheme = typeof setTheme === 'function' ? setTheme : null;
setTheme = function(theme) {
    if(_origSetTheme) _origSetTheme(theme);
    else {
        document.documentElement.setAttribute('data-theme', theme);
        if(theme === 'dark') document.body.classList.add('dark');
        else document.body.classList.remove('dark');
        try { localStorage.setItem('vit-theme', theme); } catch(e){}
    }
    updateProfileThemeButtons();
    // Update profile panel background
    var ps = document.getElementById('profileSlider');
    if(ps) ps.style.background = theme === 'dark' ? '#1A1A1F' : '#fff';
    // Update CSS variables for theme
    var r = document.documentElement;
    if(theme === 'dark') {
        r.style.setProperty('--c-bg','#1A1A1F');
        r.style.setProperty('--c-bg2','#222228');
        r.style.setProperty('--c-bg3','#2A2A30');
        r.style.setProperty('--c-text','#EAEAEC');
        r.style.setProperty('--c-text2','#C8C8CE');
        r.style.setProperty('--c-sub','#87878F');
        r.style.setProperty('--c-muted','#55555C');
        r.style.setProperty('--c-border','#2A2A30');
        r.style.setProperty('--c-border2','#2A2A30');
        r.style.setProperty('--c-ring','#2A2A30');
        r.style.setProperty('--c-orange-tint','rgba(239,125,0,0.1)');
        r.style.setProperty('--c-yellow-tint','rgba(250,204,21,0.08)');
        r.style.setProperty('--c-blue-tint','rgba(59,130,246,0.08)');
    } else {
        r.style.setProperty('--c-bg','#FFFFFF');
        r.style.setProperty('--c-bg2','#f9fafb');
        r.style.setProperty('--c-bg3','#f3f4f6');
        r.style.setProperty('--c-text','#111827');
        r.style.setProperty('--c-text2','#374151');
        r.style.setProperty('--c-sub','#6b7280');
        r.style.setProperty('--c-muted','#9ca3af');
        r.style.setProperty('--c-border','#e5e7eb');
        r.style.setProperty('--c-border2','#f3f4f6');
        r.style.setProperty('--c-ring','#f3f4f6');
        r.style.setProperty('--c-orange-tint','#fff7ed');
        r.style.setProperty('--c-yellow-tint','#fffbeb');
        r.style.setProperty('--c-blue-tint','#eff6ff');
    }
    // Walk DOM and fix inline styles for dark mode
    applyDarkModeInlineStyles(theme === 'dark');
};

function applyDarkModeInlineStyles(isDark) {
    if(!isDark) {
        // Restore originals
        document.querySelectorAll('[data-dm-orig]').forEach(function(el){
            el.setAttribute('style', el.getAttribute('data-dm-orig'));
            el.removeAttribute('data-dm-orig');
        });
        return;
    }
    
    // Direct style property manipulation - much more reliable than regex
    var bgMap = {
        'rgb(255, 255, 255)':'#1A1A1F','rgb(249, 250, 251)':'#222228',
        'rgb(243, 244, 246)':'#2A2A30','rgb(250, 250, 250)':'#222228',
        'rgb(229, 231, 235)':'#2A2A30','rgb(209, 213, 219)':'#3A3A42',
        'rgb(240, 253, 244)':'rgba(34,197,94,0.1)','rgb(254, 242, 242)':'rgba(248,113,113,0.1)',
        'rgb(239, 246, 255)':'rgba(59,130,246,0.1)','rgb(255, 247, 237)':'rgba(239,125,0,0.1)',
        'rgb(254, 252, 232)':'rgba(250,204,21,0.08)','rgb(250, 245, 255)':'rgba(139,92,246,0.1)',
        'rgb(236, 253, 245)':'rgba(34,197,94,0.1)','rgb(254, 243, 199)':'rgba(245,158,11,0.1)',
        'rgb(255, 251, 235)':'rgba(250,204,21,0.08)',
    };
    var colorMap = {
        'rgb(17, 24, 39)':'#EAEAEC','rgb(31, 41, 55)':'#EAEAEC',
        'rgb(55, 65, 81)':'#C8C8CE','rgb(75, 85, 99)':'#87878F',
        'rgb(107, 114, 128)':'#87878F','rgb(156, 163, 175)':'#55555C',
        'rgb(51, 51, 51)':'#EAEAEC','rgb(0, 0, 0)':'#EAEAEC',
    };
    var borderColorMap = {
        'rgb(229, 231, 235)':'#2A2A30','rgb(243, 244, 246)':'#2A2A30',
        'rgb(209, 213, 219)':'#2A2A30','rgb(238, 238, 238)':'#2A2A30',
        'rgb(221, 221, 221)':'#2A2A30',
    };
    
    document.querySelectorAll('[style]').forEach(function(el) {
        if(el.tagName === 'SCRIPT' || el.tagName === 'STYLE') return;
        var origStyle = el.getAttribute('style');
        if(!origStyle || el.hasAttribute('data-dm-skip')) return;
        
        // Store original before any changes
        if(!el.hasAttribute('data-dm-orig')) el.setAttribute('data-dm-orig', origStyle);
        
        var cs = el.style;
        var changed = false;
        
        // Background
        var bg = cs.backgroundColor || cs.background;
        if(bg) {
            // Handle solid colors
            Object.keys(bgMap).forEach(function(from) {
                if(bg.indexOf(from) !== -1) {
                    if(cs.backgroundColor) cs.backgroundColor = bgMap[from];
                    else cs.background = cs.background.replace(from, bgMap[from]);
                    changed = true;
                }
            });
            // Handle rgba with low alpha (tinted backgrounds)
            if(bg.indexOf('rgba(22, 163, 74') !== -1 && bg.indexOf('0.06') !== -1) { cs.background = bg.replace('0.06','0.12'); changed = true; }
            if(bg.indexOf('rgba(202, 138, 4') !== -1 && bg.indexOf('0.06') !== -1) { cs.background = bg.replace('0.06','0.12'); changed = true; }
            if(bg.indexOf('rgba(220, 38, 38') !== -1 && bg.indexOf('0.06') !== -1) { cs.background = bg.replace('0.06','0.12'); changed = true; }
            if(bg.indexOf('rgba(239, 125, 0') !== -1 && bg.indexOf('0.08') !== -1) { cs.background = bg.replace('0.08','0.15'); changed = true; }
        }
        
        // Text color (only if not an icon/badge with intentional color)
        var col = cs.color;
        if(col && colorMap[col]) {
            // Don't override status colors (green/red/blue/orange/purple)
            if(col.indexOf('34, 197') === -1 && col.indexOf('248, 113') === -1 && 
               col.indexOf('59, 130') === -1 && col.indexOf('239, 125') === -1 &&
               col.indexOf('139, 92') === -1 && col.indexOf('22, 163') === -1 &&
               col.indexOf('220, 38') === -1 && col.indexOf('202, 138') === -1 &&
               col.indexOf('37, 99') === -1 && col.indexOf('147, 51') === -1) {
                cs.color = colorMap[col];
                changed = true;
            }
        }
        
        // Border color
        var bc = cs.borderColor || cs.borderBottom || cs.borderTop;
        if(cs.borderColor && borderColorMap[cs.borderColor]) { cs.borderColor = borderColorMap[cs.borderColor]; changed = true; }
        // Handle border shorthand  
        ['borderBottom','borderTop','borderLeft','borderRight','border'].forEach(function(prop) {
            var val = cs[prop];
            if(val) {
                Object.keys(borderColorMap).forEach(function(from) {
                    if(val.indexOf(from) !== -1) { cs[prop] = val.replace(from, borderColorMap[from]); changed = true; }
                });
            }
        });
    });
}

// MutationObserver: auto-apply dark mode to dynamically inserted content
(function() {
    var dmTimer = null;
    var observer = new MutationObserver(function(mutations) {
        if(!document.body.classList.contains('dark')) return;
        // Debounce - don't fire too often
        if(dmTimer) clearTimeout(dmTimer);
        dmTimer = setTimeout(function() {
            applyDarkModeInlineStyles(true);
        }, 100);
    });
    // Start observing once DOM is ready
    if(document.body) {
        observer.observe(document.body, { childList: true, subtree: true });
    } else {
        document.addEventListener('DOMContentLoaded', function() {
            observer.observe(document.body, { childList: true, subtree: true });
        });
    }
})();

async function saveProfile() {
    var vorname = document.getElementById('profileVorname').value.trim();
    var nachname = document.getElementById('profileNachname').value.trim();
    var fullName = (vorname + ' ' + nachname).trim();
    var telefon = document.getElementById('profileTelefon').value.trim();
    var position = document.getElementById('profilePosition').value.trim();

    if(typeof sb !== 'undefined' && typeof sbProfile !== 'undefined' && sbProfile) {
        try {
            var upd = { name: fullName, vorname: vorname, nachname: nachname, telefon: telefon, position: position };
            var resp = await sb.from('users').update(upd).eq('id', sbProfile.id);
            if(resp.error) throw resp.error;
            // Update local state
            sbProfile.name = fullName;
            sbProfile.telefon = telefon;
            sbProfile.position = position;
            // Update UI
            document.querySelectorAll('[data-user-name]').forEach(function(el){ el.textContent = fullName; });
            document.getElementById('profileNameDisplay').textContent = fullName;
            var avatarUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(fullName) + '&background=EF7D00&color=fff';
            document.getElementById('profileAvatarImg').src = avatarUrl;
            var topAvatar = document.getElementById('userAvatarImg');
            if(topAvatar) topAvatar.src = avatarUrl;
            var mobileAvatar = document.getElementById('userAvatarImgMobile');
            if(mobileAvatar) mobileAvatar.src = avatarUrl;
            alert('âœ… Profil gespeichert!');
        } catch(e) {
            console.error('Profile save error:', e);
            alert('Fehler beim Speichern: ' + (e.message||e));
        }
    } else {
        alert('âœ… Profil gespeichert! (Demo-Modus)');
    }
}

function handleProfilePhoto(input) {
    if(input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profileAvatarImg').src = e.target.result;
            var topAvatar = document.getElementById('userAvatarImg');
            if(topAvatar) topAvatar.src = e.target.result;
            var mobileAvatar = document.getElementById('userAvatarImgMobile');
            if(mobileAvatar) mobileAvatar.src = e.target.result;
            // TODO: Upload to Supabase Storage
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function changePassword() {
    var newPw = prompt('Neues Passwort eingeben (min. 8 Zeichen):');
    if(!newPw || newPw.length < 8) { if(newPw !== null) alert('Passwort muss mindestens 8 Zeichen haben.'); return; }
    if(typeof sb !== 'undefined') {
        sb.auth.updateUser({ password: newPw }).then(function(res){
            if(res.error) alert('Fehler: ' + res.error.message);
            else alert(t('alert_pw_changed'));
        });
    } else {
        alert(t('alert_pw_changed'));
    }
}
</script>


<!-- â•â•â• BWA MOTIVATION + ESKALATION SYSTEM â•â•â• -->
<script>
(function(){
    // â”€â”€â”€â”€ CONFIG â”€â”€â”€â”€
    var MO_NAMES = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    var STANDORTE_DEMO = [
        {id:'s1',name:'MÃ¼nchen City',submitted:'2026-02-03',rating:'gold'},
        {id:'s2',name:'Berlin Mitte',submitted:'2026-02-05',rating:'gold'},
        {id:'s3',name:'Hamburg Altona',submitted:'2026-02-07',rating:'gold'},
        {id:'s4',name:'Frankfurt Main',submitted:'2026-02-10',rating:'ok'},
        {id:'s5',name:'KÃ¶ln Ehrenfeld',submitted:'2026-02-11',rating:'ok'},
        {id:'s6',name:'Stuttgart West',submitted:'2026-02-14',rating:'ok'},
        {id:'s7',name:'DÃ¼sseldorf',submitted:'2026-02-15',rating:'ok'},
        {id:'s8',name:'Leipzig',submitted:null,rating:'missing'},
        {id:'s9',name:'Dresden',submitted:null,rating:'missing'},
        {id:'s10',name:'NÃ¼rnberg',submitted:null,rating:'missing'},
        {id:'s11',name:'Hannover',submitted:null,rating:'missing'},
        {id:'s12',name:'Grafrath',submitted:null,rating:'missing'},
        {id:'s13',name:'MÃ¼nster',submitted:null,rating:'missing'},
        {id:'s14',name:'Freiburg',submitted:null,rating:'missing'},
        {id:'s15',name:'Augsburg',submitted:null,rating:'missing'},
        {id:'s16',name:'Bonn',submitted:null,rating:'overdue'},
        {id:'s17',name:'Mannheim',submitted:null,rating:'overdue'},
        {id:'s18',name:'Karlsruhe',submitted:'2026-02-18',rating:'overdue'},
        {id:'s19',name:'Dortmund',submitted:null,rating:'missing'},
        {id:'s20',name:'Essen',submitted:null,rating:'missing'},
        {id:'s21',name:'Bremen',submitted:'2026-02-12',rating:'ok'}
    ];

    // â”€â”€â”€â”€ HELPERS â”€â”€â”€â”€
    function getBwaMonth(today) {
        var d = today || new Date();
        var m = d.getMonth(); // 0-based
        var y = d.getFullYear();
        // BWA bezieht sich auf Vormonat
        if(m === 0) return {y:y-1, m:11};
        return {y:y, m:m-1};
    }

    function getDeadline(bwaMonth) {
        // Deadline = 15. des Folgemonats
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        return new Date(fy, fm, 15, 23, 59, 59);
    }

    function getEskalationsStufe(today, bwaMonth) {
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        // Are we in the follow month?
        if(today.getFullYear() < fy || (today.getFullYear() === fy && today.getMonth() < fm)) return -1; // not yet
        if(today.getFullYear() > fy || today.getMonth() > fm) return 3; // way past
        var day = today.getDate();
        if(day <= 7) return 0;
        if(day <= 12) return 1;
        if(day <= 15) return 2;
        return 3;
    }

    function getRating(submittedDate, bwaMonth) {
        if(!submittedDate) return 'missing';
        var fm = bwaMonth.m + 1;
        var fy = bwaMonth.y;
        if(fm > 11) { fm = 0; fy++; }
        var d8 = new Date(fy, fm, 8, 23, 59, 59);
        var d15 = new Date(fy, fm, 15, 23, 59, 59);
        var sd = new Date(submittedDate);
        if(sd <= d8) return 'gold';
        if(sd <= d15) return 'ok';
        return 'overdue';
    }

    function daysUntil(deadline) {
        var now = new Date();
        return Math.ceil((deadline - now) / (1000*60*60*24));
    }

    function ratingBadge(rating) {
        var map = {
            gold: {t:'ðŸ¥‡ GOLD', c:'#ca8a04', bg:'rgba(202,138,4,0.1)'},
            ok: {t:'âœ… OK', c:'#16a34a', bg:'rgba(22,163,74,0.1)'},
            overdue: {t:'ðŸš¨ ÃœBERFÃ„LLIG', c:'#dc2626', bg:'rgba(220,38,38,0.1)'},
            missing: {t:'â³ AUSSTEHEND', c:'#9ca3af', bg:'rgba(156,163,175,0.1)'}
        };
        var m = map[rating] || map.missing;
        return '<span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;color:'+m.c+';background:'+m.bg+'">'+m.t+'</span>';
    }

    function eskalationBadge(stufe) {
        var cols = ['#9ca3af','#ca8a04','#ea580c','#dc2626'];
        var c = cols[Math.min(stufe,3)] || cols[0];
        return '<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;color:'+c+';background:'+c+'18">Stufe '+stufe+'</span>';
    }

    // â”€â”€â”€â”€ STANDORT-SICHT: Cockpit Widget â”€â”€â”€â”€
    window.updateBwaDeadlineWidget = updateBwaDeadlineWidget;
    async function updateBwaDeadlineWidget() {
        var today = new Date();
        var bwaMo = getBwaMonth(today);
        var deadline = getDeadline(bwaMo);
        var stufe = getEskalationsStufe(today, bwaMo);
        var days = daysUntil(deadline);
        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;

        var submitted = null;
        var rating = 'missing';
        if(typeof sb !== 'undefined' && typeof sbProfile !== 'undefined' && sbProfile && sbProfile.standort_id) {
            try {
                var bwaResp = await sb.from('bwa_daten').select('created_at').eq('standort_id', sbProfile.standort_id).eq('monat', bwaMo.m + 1).eq('jahr', bwaMo.y).limit(1);
                if(bwaResp.data && bwaResp.data.length > 0) {
                    submitted = bwaResp.data[0].created_at.slice(0,10);
                    var subDay = new Date(bwaResp.data[0].created_at).getDate();
                    if(subDay <= 8) rating = 'gold';
                    else if(subDay <= 15) rating = 'ok';
                    else rating = 'overdue';
                }
            } catch(e) { console.warn('BWA check:', e); }
        }

        var titleEl = document.getElementById('bwaDeadlineTitle');
        var subEl = document.getElementById('bwaDeadlineSubtext');
        var daysEl = document.getElementById('bwaCountdownDays');
        var ringEl = document.getElementById('bwaRingCircle');
        var ctaEl = document.getElementById('bwaUploadCTA');
        var badgeEl = document.getElementById('bwaRatingBadge');
        var eskBanner = document.getElementById('bwaEskalationBanner');

        if(!titleEl) return;

        if(submitted && rating !== 'missing') {
            // Already submitted
            titleEl.textContent = 'BWA fÃ¼r ' + moName + ' eingereicht';
            subEl.textContent = 'Eingereicht am ' + submitted.split('-').reverse().join('.');
            badgeEl.innerHTML = ratingBadge(rating);
            badgeEl.style.display = '';
            ctaEl.style.display = 'none';
            daysEl.textContent = 'âœ“';
            daysEl.style.color = '#16a34a';
            daysEl.style.fontSize = '20px';
            ringEl.style.stroke = '#16a34a';
            ringEl.setAttribute('stroke-dashoffset', '0');
            eskBanner.style.display = 'none';
            // Show KPI report
            showKpiReport(bwaMo, rating);
            // Unlock benchmark
            setBenchmarkLock(false);
        } else {
            // Not submitted
            ctaEl.style.display = '';
            badgeEl.style.display = 'none';
            setBenchmarkLock(true);
            document.getElementById('bwaKpiReport').style.display = 'none';

            if(days > 0) {
                titleEl.textContent = 'Noch ' + days + ' Tage bis zur BWA-Deadline';
                subEl.textContent = 'BWA fÃ¼r ' + moName + ' Â· Frist: 15. ' + MO_NAMES[bwaMo.m+1 > 11 ? 0 : bwaMo.m+1];
                daysEl.textContent = days;
                daysEl.style.color = days <= 3 ? '#dc2626' : days <= 7 ? '#ca8a04' : '#EF7D00';
                ringEl.style.stroke = days <= 3 ? '#dc2626' : days <= 7 ? '#ca8a04' : '#EF7D00';
                var pct = Math.max(0, 1 - days/15);
                ringEl.setAttribute('stroke-dashoffset', (175.9 * (1-pct)).toFixed(1));

                // CTA subtext
                if(days > 7) {
                    ctaEl.textContent = 'ðŸ¥‡ FrÃ¼habgabe = Gold-Status!';
                } else {
                    ctaEl.textContent = 'ðŸ“¤ BWA jetzt einreichen';
                }
            } else {
                var overdueDays = Math.abs(days);
                titleEl.textContent = 'BWA ist seit ' + overdueDays + ' Tag' + (overdueDays>1?'en':'') + ' Ã¼berfÃ¤llig';
                subEl.textContent = 'BWA fÃ¼r ' + moName + ' Â· Deadline war der 15.';
                daysEl.textContent = '!';
                daysEl.style.color = '#dc2626';
                daysEl.style.fontSize = '24px';
                ringEl.style.stroke = '#dc2626';
                ringEl.setAttribute('stroke-dashoffset', '0');
                ctaEl.textContent = 'ðŸš¨ BWA sofort einreichen';
                ctaEl.style.background = '#dc2626';
            }

            // Eskalation Banner
            if(stufe >= 2) {
                eskBanner.style.display = '';
                var eskText = document.getElementById('bwaEskText');
                var eskSub = document.getElementById('bwaEskSub');
                if(stufe === 2) {
                    eskText.textContent = 'Eskalationsstufe 2 â€“ Nur noch ' + Math.max(0,days) + ' Tage!';
                    eskSub.textContent = 'Reiche jetzt ein, um Stufe 3 und HQ-Benachrichtigung zu vermeiden.';
                } else {
                    eskText.textContent = 'Eskalationsstufe 3 â€“ BWA Ã¼berfÃ¤llig!';
                    eskSub.textContent = 'Ohne aktuelle Zahlen kÃ¶nnen wir dich nicht gezielt bei Einkauf, Marketing und Controlling unterstÃ¼tzen.';
                    eskBanner.style.background = '#fef2f2';
                    eskBanner.style.borderColor = '#fca5a5';
                }
            } else {
                eskBanner.style.display = 'none';
            }
        }

        // Netzwerk-Widget
        updateNetzwerkWidget();
    }

    // â”€â”€â”€â”€ NETZWERK WIDGET (Standort-Sicht) â”€â”€â”€â”€
    async function updateNetzwerkWidget() {
        var gold = 0, ok = 0, missing = 0, overdue = 0, total = 21;
        if(typeof sb !== 'undefined') {
            try {
                var bwaMo = getBwaMonth(new Date());
                var stdResp = await sb.from('standorte').select('id,name').eq('aktiv', true);
                total = (stdResp.data || []).length || 21;
                var bwaResp = await sb.from('bwa_daten').select('standort_id,created_at').eq('monat', bwaMo.m + 1).eq('jahr', bwaMo.y);
                (bwaResp.data || []).forEach(function(b) {
                    var subDay = new Date(b.created_at).getDate();
                    if(subDay <= 8) gold++; else if(subDay <= 15) ok++; else overdue++;
                });
                missing = total - gold - ok - overdue;
            } catch(e) { console.warn('Netzwerk widget:', e); missing = total; }
        } else { missing = total; }
        var submitted = gold + ok + overdue;
        var pct = Math.round(submitted / total * 100);

        var el = function(id) { return document.getElementById(id); };
        if(el('bwaNetzwerkProgress')) el('bwaNetzwerkProgress').textContent = submitted + ' von ' + total + ' eingereicht';
        if(el('bwaNetzwerkBar')) el('bwaNetzwerkBar').style.width = pct + '%';
        if(el('bwaNwGold')) el('bwaNwGold').textContent = 'ðŸ¥‡ Gold: ' + gold;
        if(el('bwaNwOk')) el('bwaNwOk').textContent = 'âœ… OK: ' + ok;
        if(el('bwaNwMissing')) el('bwaNwMissing').textContent = 'â³ Ausstehend: ' + missing;
        if(el('bwaNwOverdue')) el('bwaNwOverdue').textContent = 'ðŸš¨ ÃœberfÃ¤llig: ' + overdue;
    }

    // â”€â”€â”€â”€ KPI REPORT (Sofort-Nutzen nach Upload) â”€â”€â”€â”€
    function showKpiReport(bwaMo, rating) {
        var report = document.getElementById('bwaKpiReport');
        if(!report) return;
        report.style.display = '';

        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;
        document.getElementById('bwaKpiReportMonth').textContent = moName;
        document.getElementById('bwaKpiRating').innerHTML = ratingBadge(rating);

        // Demo KPIs
        var kpis = [
            {l:'Umsatz', v:'68.400 â‚¬', c:'+4.2%', co:'#16a34a'},
            {l:'Rohertrag', v:'24.100 â‚¬', c:'36.7%', co:'#2563eb'},
            {l:'Personalkosten', v:'13.600 â‚¬', c:'19.9%', co:'#ca8a04'},
            {l:'Ergebnis', v:'3.200 â‚¬', c:'+12%', co:'#16a34a'}
        ];
        var grid = document.getElementById('bwaKpiReportGrid');
        grid.innerHTML = kpis.map(function(k){
            return '<div style="padding:12px;background:var(--c-bg2);border-radius:10px;text-align:center"><p style="font-size:9px;color:var(--c-muted);text-transform:uppercase">'+k.l+'</p><p style="font-size:18px;font-weight:800;color:var(--c-text);margin-top:2px">'+k.v+'</p><p style="font-size:10px;font-weight:600;color:'+k.co+'">'+k.c+'</p></div>';
        }).join('');

        // Insights
        var recs = [
            'Rohertragsmarge +2.5 Pp Ã¼ber Netzwerk-Durchschnitt â€“ starke Performance! ðŸ’ª',
            'Personalkosten leicht Ã¼ber Schnitt (19.9% vs. 18.5%) â€“ Arbeitszeitplanung prÃ¼fen.',
            'Werkstatt-Umsatz +8% ggÃ¼. Vorjahr â€“ Trend beibehalten mit proaktiver Service-Ansprache.'
        ];
        document.getElementById('bwaKpiRecList').innerHTML = recs.map(function(r){return '<li>â†’ '+r+'</li>';}).join('');
    }

    // â”€â”€â”€â”€ BENCHMARK LOCK â”€â”€â”€â”€
    function setBenchmarkLock(locked) {
        var overlay = document.getElementById('benchmarkLockOverlay');
        var content = document.getElementById('benchmarkContent');
        if(!overlay || !content) return;
        if(locked) {
            overlay.style.display = '';
            content.style.display = 'none';
        } else {
            overlay.style.display = 'none';
            content.style.display = '';
        }
    }

    // â”€â”€â”€â”€ HQ-SICHT: BWA Netzwerk-Status â”€â”€â”€â”€
    window.renderHqBwaStatus = renderHqBwaStatus;
    function renderHqBwaStatus() {
        var bwaMo = getBwaMonth(new Date());
        var moName = MO_NAMES[bwaMo.m] + ' ' + bwaMo.y;
        var deadline = getDeadline(bwaMo);
        var today = new Date();

        var el = function(id){return document.getElementById(id);};
        if(el('hqBwaMonth')) el('hqBwaMonth').textContent = moName;

        // Sort: gold first, then ok, then overdue, then missing
        var order = {gold:0, ok:1, overdue:2, missing:3};
        var sorted = STANDORTE_DEMO.slice().sort(function(a,b){return (order[a.rating]||3) - (order[b.rating]||3);});

        var gold=0, ok=0, overdue=0, missing=0;
        sorted.forEach(function(s){
            if(s.rating==='gold') gold++;
            else if(s.rating==='ok') ok++;
            else if(s.rating==='overdue') overdue++;
            else missing++;
        });

        var total = sorted.length;
        var submitted = gold + ok + overdue;
        var pct = Math.round(submitted/total*100);

        if(el('hqBwaSubmitted')) el('hqBwaSubmitted').textContent = submitted;
        if(el('hqBwaTotal')) el('hqBwaTotal').textContent = total;
        if(el('hqBwaGold')) el('hqBwaGold').textContent = gold;
        if(el('hqBwaOk')) el('hqBwaOk').textContent = ok;
        if(el('hqBwaMissing')) el('hqBwaMissing').textContent = missing;
        if(el('hqBwaOverdue')) el('hqBwaOverdue').textContent = overdue;
        if(el('hqBwaPct')) el('hqBwaPct').textContent = pct + '%';
        if(el('hqBwaBar')) el('hqBwaBar').style.width = pct + '%';

        // Table
        var tbody = el('hqBwaTableBody');
        if(!tbody) return;

        tbody.innerHTML = sorted.map(function(s){
            var stufe = s.rating === 'missing' ? getEskalationsStufe(today, bwaMo) : (s.rating==='overdue'?3:0);
            var dl = daysUntil(deadline);
            var daysText = s.submitted ? s.submitted.split('-').reverse().join('.') : (dl>0 ? 'noch '+dl+' Tage' : Math.abs(dl)+' Tage Ã¼berfÃ¤llig');
            var daysColor = s.submitted ? '#16a34a' : (dl>0 ? '#9ca3af' : '#dc2626');
            return '<tr class="text-sm">'+
                '<td class="py-2.5 font-semibold text-gray-800">'+s.name+'</td>'+
                '<td class="py-2.5">'+(s.submitted ? '<span class="text-green-600 text-xs font-semibold">âœ“ Eingereicht</span>' : '<span class="text-gray-400 text-xs">Ausstehend</span>')+'</td>'+
                '<td class="py-2.5">'+ratingBadge(s.rating)+'</td>'+
                '<td class="py-2.5 text-xs text-gray-500">'+(s.submitted||'â€”')+'</td>'+
                '<td class="py-2.5">'+(s.rating==='missing'||s.rating==='overdue' ? eskalationBadge(stufe) : '<span class="text-xs text-gray-300">â€”</span>')+'</td>'+
                '<td class="py-2.5 text-xs" style="color:'+daysColor+'">'+daysText+'</td>'+
                '</tr>';
        }).join('');
    }

    // â”€â”€â”€â”€ INIT â”€â”€â”€â”€
    // Hook into controlling view activation
    var _origShowCtrl = window.showControllingTab;
    if(_origShowCtrl) {
        window.showControllingTab = function(t) {
            _origShowCtrl(t);
            if(t === 'cockpit') setTimeout(updateBwaDeadlineWidget, 100);
        };
    }

// [Hook 1 moved to unified dispatcher]

// [Init moved to unified dispatcher]
})();
</script>


<!-- â•â•â• TAGES-COCKPIT + VERKAUFS-STREAK SYSTEM â•â•â• -->
<script>
(function(){
    var MO = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    var WOCHENTAGE = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    var IMPULSE = [
        'Du hast 2 Angebote, die seit 5+ Tagen offen sind. Ein kurzer Follow-Up-Anruf kÃ¶nnte den Unterschied machen!',
        'Kunden, die am Wochenende Probefahrt hatten, sind jetzt kaufbereit. Heute anrufen!',
        'Werkstatt ist zu 78% ausgelastet â€“ perfekte Gelegenheit fÃ¼r Service-Angebote an Bestandskunden.',
        'Tipp: E-Bike-Leasing-Anfragen steigen im FrÃ¼hjahr um 40%. Sprich aktiv Pendler an!',
        'Dein Standort liegt 12% Ã¼ber dem Netzwerk-Durchschnitt bei ZubehÃ¶r-Attach-Rate. Weiter so! ðŸ’ª',
        '3 Leads sind im "Schwebend"-Status. Schick heute ein kurzes "Noch Fragen?"-Follow-Up.',
        'Diese Woche sind 2 Events im Kalender. Nutze die Chance fÃ¼r spontane Leads!',
        'Top-Performer im Netzwerk machen 30% ihres Umsatzes mit Service. Wie siehts bei dir aus?'
    ];

    // â”€â”€â”€â”€ TAGES-COCKPIT â”€â”€â”€â”€
    window.renderDailyFocus = renderDailyFocus;
    function renderDailyFocus() {
        var now = new Date();
        var dateEl = document.getElementById('dailyFocusDate');
        if(dateEl) dateEl.textContent = WOCHENTAGE[now.getDay()] + ', ' + now.getDate() + '. ' + MO[now.getMonth()];

        // BWA Status
        var bwaMo = now.getMonth() === 0 ? {y:now.getFullYear()-1,m:11} : {y:now.getFullYear(),m:now.getMonth()-1};
        var fm = bwaMo.m+1 > 11 ? 0 : bwaMo.m+1;
        var fy = bwaMo.m+1 > 11 ? bwaMo.y+1 : bwaMo.y;
        var deadline = new Date(fy, fm, 15, 23, 59, 59);
        var daysLeft = Math.ceil((deadline - now) / (1000*60*60*24));

        var bwaEl = document.getElementById('dfBwa');
        var bwaSubEl = document.getElementById('dfBwaSub');
        if(bwaEl && bwaSubEl) {
            if(daysLeft > 7) {
                bwaEl.textContent = 'âœ…';
                bwaSubEl.textContent = daysLeft + ' Tage Zeit';
                bwaSubEl.style.color = '#16a34a';
            } else if(daysLeft > 0) {
                bwaEl.textContent = 'âš ï¸';
                bwaSubEl.textContent = 'Noch ' + daysLeft + ' Tage!';
                bwaSubEl.style.color = '#ca8a04';
            } else {
                bwaEl.textContent = 'ðŸš¨';
                bwaSubEl.textContent = Math.abs(daysLeft) + ' Tage Ã¼berfÃ¤llig';
                bwaSubEl.style.color = '#dc2626';
            }
        }

        // Random Impulse
        var impulseEl = document.getElementById('dfImpulseText');
        if(impulseEl) {
            var idx = now.getDate() % IMPULSE.length;
            impulseEl.textContent = IMPULSE[idx];
        }
    }

    // â”€â”€â”€â”€ VERKAUFS-STREAK â”€â”€â”€â”€
    window.renderSalesMomentum = renderSalesMomentum;
    function renderSalesMomentum() {
        // Demo data - in prod, fetch from Supabase
        var streak = 12;
        var bestStreak = 18;
        var goalIst = 86400;
        var goalSoll = 120000;
        var closeRate = 34;
        var closeRatePrev = 30;
        var avgDeal = 4320;
        var nwAvgDeal = 3890;

        // Update streak emoji
        var emojiEl = document.getElementById('streakEmoji');
        if(emojiEl) {
            if(streak >= 14) emojiEl.textContent = 'ðŸ”¥ðŸ”¥';
            else if(streak >= 7) emojiEl.textContent = 'ðŸ”¥';
            else if(streak >= 3) emojiEl.textContent = 'âœ¨';
            else emojiEl.textContent = 'ðŸ’¤';
        }

        // Goal bar
        var pct = Math.min(Math.round(goalIst / goalSoll * 100), 100);
        var goalPctEl = document.getElementById('goalPct');
        var goalBarEl = document.getElementById('goalBar');
        if(goalPctEl) {
            goalPctEl.textContent = pct + '%';
            goalPctEl.style.color = pct >= 90 ? '#16a34a' : pct >= 60 ? '#ca8a04' : '#dc2626';
        }
        if(goalBarEl) {
            goalBarEl.style.width = pct + '%';
            goalBarEl.style.backgroundColor = pct >= 90 ? '#16a34a' : pct >= 60 ? '#EF7D00' : '#dc2626';
        }

        // Close rate change
        var crDiff = closeRate - closeRatePrev;
        var crEl = document.querySelector('#closeRate + p');
        if(crEl && crDiff !== 0) {
            crEl.textContent = (crDiff > 0 ? 'â†‘ +' : 'â†“ ') + crDiff + '% ggÃ¼. Vormonat';
            crEl.style.color = crDiff > 0 ? '#16a34a' : '#dc2626';
        }
    }

    // â”€â”€â”€â”€ INIT â”€â”€â”€â”€
// [Hook 2 moved to unified dispatcher]

// [Init moved to unified dispatcher]
})();
</script>


<!-- â•â•â• FLOATING TRAINER CARD â•â•â• -->
<div id="trainerCardOverlay" style="display:none;position:fixed;bottom:24px;right:24px;z-index:9000;width:360px;">
    <div class="vit-card p-0" style="box-shadow:0 8px 32px rgba(0,0,0,0.15);border:1px solid #fed7aa;overflow:visible;">
        <div style="padding:14px 16px;background:linear-gradient(135deg,#EF7D00,#F59E0B);border-radius:8px 8px 0 0;color:white;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span style="font-size:20px">ðŸŽ“</span>
                    <div><p class="text-xs font-bold" style="opacity:0.8" id="trainerModuleTag">VERKAUF</p><p class="text-sm font-bold" id="trainerTitle">â€”</p></div>
                </div>
                <div class="flex gap-1">
                    <button onclick="snoozeTrainer()" style="background:rgba(255,255,255,0.2);border:none;border-radius:6px;padding:4px 8px;color:white;font-size:10px;cursor:pointer">â° SpÃ¤ter</button>
                    <button onclick="closeTrainer()" style="background:rgba(255,255,255,0.2);border:none;border-radius:6px;padding:4px 8px;color:white;font-size:10px;cursor:pointer">âœ•</button>
                </div>
            </div>
        </div>
        <div style="padding:16px;">
            <p id="trainerDesc" class="text-xs text-gray-600 mb-3"></p>
            <div id="trainerSteps" class="space-y-2 mb-3"></div>
            <div class="flex gap-2">
                <button onclick="startTrainer()" id="trainerCTA" class="flex-1 px-3 py-2.5 bg-vit-orange text-white text-xs font-bold rounded-lg hover:opacity-90">â–¶ Jetzt starten</button>
                <button onclick="createTrainerTask()" class="px-3 py-2.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-lg hover:bg-gray-200">ðŸ“‹ Als Aufgabe</button>
            </div>
            <div id="trainerImpact" class="mt-2 p-2 bg-green-50 rounded-lg text-xs text-green-700" style="display:none"></div>
        </div>
        <div style="padding:8px 16px;background:var(--c-bg2);border-radius:0 0 8px 8px;border-top:1px solid #f3f4f6;">
            <div class="flex items-center justify-between">
                <span class="text-[10px] text-gray-400" id="trainerTriggerInfo"></span>
                <span class="text-[10px] text-gray-400" id="trainerProgress"></span>
            </div>
        </div>
    </div>
</div>
<!-- â•â•â• GRUPPENCALL PREP BANNER â•â•â• -->
<div id="groupcallBanner" style="display:none;position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:8999;width:500px;">
    <div class="vit-card p-4" style="box-shadow:0 8px 24px rgba(0,0,0,0.12);border:2px solid #3b82f6;">
        <div class="flex items-center gap-3">
            <span style="font-size:24px">ðŸ“ž</span>
            <div style="flex:1"><p class="text-sm font-bold text-gray-800" id="gcBannerTitle">Inhaber-Call in 2 Stunden</p><p class="text-xs text-gray-500" id="gcBannerSub">Deine Zahlen sind vorbereitet</p></div>
            <button onclick="showGroupcallPrep()" class="px-3 py-2 bg-blue-500 text-white text-xs font-bold rounded-lg hover:bg-blue-600">ðŸ“Š Vorbereitung</button>
            <button onclick="document.getElementById('groupcallBanner').style.display='none'" style="background:none;border:none;color:var(--c-muted);cursor:pointer">âœ•</button>
        </div>
    </div>
</div>

<!-- === PERFORMANCE GOVERNANCE SYSTEM === -->
<script>
(function(){
var HEALTH_CATS=[
{id:'controlling',n:'Controlling',w:25,icon:'ðŸ“Š',color:'#2563eb'},
{id:'verkauf',n:'Verkauf',w:25,icon:'ðŸ’°',color:'#16a34a'},
{id:'marketing',n:'Marketing',w:15,icon:'ðŸ“£',color:'#EF7D00'},
{id:'werkstatt',n:'Werkstatt',w:15,icon:'ðŸ”§',color:'#9333ea'},
{id:'engagement',n:'Engagement',w:10,icon:'ðŸ”¥',color:'#f59e0b'},
{id:'disziplin',n:'Disziplin',w:10,icon:'âœ…',color:'#6b7280'}
];

var DEMO_STD=[
{name:'MÃ¼nchen City',score:92,s:{controlling:95,verkauf:90,marketing:88,werkstatt:92,engagement:90,disziplin:95}},
{name:'Berlin Mitte',score:85,s:{controlling:90,verkauf:82,marketing:80,werkstatt:88,engagement:85,disziplin:82}},
{name:'Hamburg Altona',score:81,s:{controlling:85,verkauf:78,marketing:76,werkstatt:85,engagement:80,disziplin:80}},
{name:'Frankfurt Main',score:78,s:{controlling:80,verkauf:75,marketing:78,werkstatt:80,engagement:75,disziplin:78}},
{name:'KÃ¶ln Ehrenfeld',score:74,s:{controlling:72,verkauf:80,marketing:70,werkstatt:74,engagement:72,disziplin:75}},
{name:'Stuttgart West',score:71,s:{controlling:75,verkauf:68,marketing:72,werkstatt:70,engagement:70,disziplin:72}},
{name:'DÃ¼sseldorf',score:68,s:{controlling:70,verkauf:65,marketing:68,werkstatt:72,engagement:66,disziplin:68}},
{name:'Grafrath',score:78,s:{controlling:72,verkauf:82,marketing:75,werkstatt:80,engagement:78,disziplin:80}},
{name:'Leipzig',score:62,s:{controlling:55,verkauf:70,marketing:60,werkstatt:65,engagement:62,disziplin:60}},
{name:'Dresden',score:58,s:{controlling:50,verkauf:62,marketing:55,werkstatt:60,engagement:58,disziplin:58}},
{name:'NÃ¼rnberg',score:54,s:{controlling:48,verkauf:60,marketing:50,werkstatt:58,engagement:54,disziplin:55}},
{name:'Freiburg',score:82,s:{controlling:88,verkauf:78,marketing:82,werkstatt:80,engagement:80,disziplin:82}},
{name:'MÃ¼nster',score:76,s:{controlling:78,verkauf:74,marketing:76,werkstatt:78,engagement:72,disziplin:76}},
{name:'Augsburg',score:65,s:{controlling:60,verkauf:68,marketing:65,werkstatt:66,engagement:64,disziplin:62}},
{name:'Bonn',score:44,s:{controlling:35,verkauf:52,marketing:40,werkstatt:48,engagement:42,disziplin:45}},
{name:'Mannheim',score:48,s:{controlling:42,verkauf:55,marketing:45,werkstatt:50,engagement:48,disziplin:46}},
{name:'Dortmund',score:72,s:{controlling:74,verkauf:70,marketing:72,werkstatt:74,engagement:70,disziplin:72}},
{name:'Essen',score:66,s:{controlling:62,verkauf:68,marketing:65,werkstatt:70,engagement:64,disziplin:66}},
{name:'Bremen',score:79,s:{controlling:82,verkauf:76,marketing:78,werkstatt:80,engagement:76,disziplin:80}},
{name:'Karlsruhe',score:42,s:{controlling:38,verkauf:48,marketing:40,werkstatt:44,engagement:40,disziplin:42}},
{name:'Hannover',score:60,s:{controlling:58,verkauf:62,marketing:58,werkstatt:62,engagement:58,disziplin:60}}
];

var MY=DEMO_STD.find(function(s){return s.name==='Grafrath';});
var MY_TREND=[72,74,73,76,78];

function sc(v){return v>=75?'#16a34a':v>=50?'#ca8a04':'#dc2626';}
function se(v){return v>=75?'ðŸŸ¢':v>=50?'ðŸŸ¡':'ðŸ”´';}
function sl(v){return v>=75?'Gesund':v>=50?'Beobachtung':'Kritisch';}

// â”€â”€ TRAINERS â”€â”€
var TRAINERS=[
{id:'t1',module:'verkauf',title:'Nachfass-Systematik',desc:'Offene Angebote systematisch nachfassen. Abschlussquote +10-15%.',trigger:'Abschlussquote unter Netzwerk-Ã˜',dur:'5 Min',steps:['Offene Angebote prÃ¼fen','Follow-Up-Template wÃ¤hlen','Innerhalb 48h anrufen'],task:'3 Ã¤lteste Angebote heute nachfassen'},
{id:'t2',module:'controlling',title:'BWA richtig lesen',desc:'Wichtigste BWA-Kennzahlen verstehen und MaÃŸnahmen ableiten.',trigger:'BWA hochgeladen',dur:'7 Min',steps:['Rohertragsmarge prÃ¼fen (>35%)','Personalkostenquote checken','1 MaÃŸnahme ableiten'],task:'1 MaÃŸnahme aus BWA-Analyse eintragen'},
{id:'t3',module:'marketing',title:'Content in 10 Minuten',desc:'Local-Hero-Video in unter 10 Minuten erstellen.',trigger:'Kein Content seit 14+ Tagen',dur:'3 Min',steps:['Thema wÃ¤hlen','30-Sek-Video aufnehmen','Im Portal hochladen'],task:'1 Local Hero Video diese Woche'},
{id:'t4',module:'werkstatt',title:'Durchlaufzeit optimieren',desc:'Durchlaufzeit reduzieren, Kundenzufriedenheit steigern.',trigger:'Durchlaufzeit Ã¼ber Schwellwert',dur:'5 Min',steps:['EngpÃ¤sse identifizieren','Vorab-Diagnose einfÃ¼hren','Teile-VerfÃ¼gbarkeit prÃ¼fen'],task:'Vorab-Diagnose bei Terminkunden testen'},
{id:'t5',module:'verkauf',title:'Lead-Qualifizierung',desc:'Leads systematisch bewerten und priorisieren. Fokus auf kaufbereite Kunden.',trigger:'Leads/Woche unter Mindestwert',dur:'4 Min',steps:['Lead-Scoring verstehen (A/B/C)','Bestehende Leads bewerten','Top-3 priorisieren'],task:'Top-3 A-Leads heute anrufen'},
{id:'t6',module:'einkauf',title:'Rohertrag steigern',desc:'ZubehÃ¶r-Attach-Rate erhÃ¶hen. 2-3% mehr Rohertrag mÃ¶glich.',trigger:'Rohertrag unter Netzwerk-Ã˜',dur:'5 Min',steps:['Aktuelle Attach-Rate prÃ¼fen','Top-5 ZubehÃ¶r-Combos lernen','Bei nÃ¤chstem Verkauf aktiv anbieten'],task:'3 Kunden heute ZubehÃ¶r aktiv anbieten'},
{id:'t7',module:'controlling',title:'LiquiditÃ¤tsplanung',desc:'Cashflow vorausplanen, EngpÃ¤sse vermeiden.',trigger:'LiquiditÃ¤t unter Schwelle',dur:'6 Min',steps:['NÃ¤chste 30 Tage Zahlungen prÃ¼fen','Erwartete EingÃ¤nge planen','Puffer identifizieren'],task:'30-Tage-Cashflow-Plan erstellen'},
{id:'t8',module:'marketing',title:'Google My Business optimieren',desc:'GMB-Profil vollstÃ¤ndig pflegen. Mehr lokale Sichtbarkeit.',trigger:'GMB Score unter 80%',dur:'7 Min',steps:['Alle Felder prÃ¼fen und ausfÃ¼llen','5 aktuelle Fotos hochladen','2 Bewertungen beantworten'],task:'GMB-Profil heute vervollstÃ¤ndigen'}
];
var activeTrainers=[TRAINERS[0]];
window.activeTrainers = activeTrainers;
var currentTrainer=null;

// â”€â”€ INTERCEPTOR DATA â”€â”€
var SOLUTIONS={
'it':{title:'IT-Probleme? Probier zuerst:',items:['Browser-Cache leeren (Strg+Shift+Del)','Anderen Browser testen (Chrome empfohlen)','Portal abmelden und neu anmelden']},
'einkauf':{title:'Einkauf â€“ HÃ¤ufige LÃ¶sung:',items:['Konditionen findest du unter Einkauf â†’ Lieferanten','Bestellformulare im Wissen â†’ Downloads','Vororder-Infos unter Einkauf â†’ Kalender']},
'buchhaltung':{title:'Buchhaltung â€“ Schnellhilfe:',items:['BWA hochladen: Controlling â†’ BWAs â†’ Upload','Trainer "BWA richtig lesen" starten','BWA-Vorlage im Wissen â†’ Downloads']},
'marketing':{title:'Marketing â€“ Sofort-Hilfe:',items:['Content-Vorlagen unter Marketing â†’ Wissen','Posting-Kalender unter Marketing â†’ Kampagnen','Trainer "Content in 10 Min" verfÃ¼gbar']},
'allgemein':{title:'Allgemein â€“ MÃ¶gliche LÃ¶sung:',items:['Wissensdatenbank durchsuchen','FAQ im Support-Bereich prÃ¼fen','NÃ¤chster Gruppencall: Frage dort stellen?']}
};

// â•â•â• HEALTH SCORE RENDER (Standort) â•â•â•
window.renderHealthScore = renderHealthScore;
function renderHealthScore(){
if(!MY)return;
var v=MY.score,col=sc(v);
var b=document.getElementById('healthBadge');
if(b){
var rank=DEMO_STD.slice().sort(function(a,b){return b.score-a.score;}).findIndex(function(s){return s.name==='Grafrath';})+1;
b.innerHTML='<span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;color:'+col+';background:'+col+'18">'+se(v)+' '+sl(v)+' Â· Rang '+rank+'/'+DEMO_STD.length+'</span>';
}
var ring=document.getElementById('healthRing');
if(ring){ring.setAttribute('stroke-dashoffset',(213.6*(1-v/100)).toFixed(1));ring.style.stroke=col;}
var num=document.getElementById('healthScoreNum');
if(num){num.textContent=v;num.style.color=col;}
var cats=document.getElementById('healthCategories');
if(cats){
cats.innerHTML=HEALTH_CATS.map(function(c){
var cv=MY.s[c.id]||0,cc=sc(cv);
return '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:11px;width:14px">'+c.icon+'</span><span style="font-size:10px;color:var(--c-muted);width:70px">'+c.n+'</span><div style="flex:1;height:4px;background:var(--c-bg3);border-radius:2px"><div style="height:100%;width:'+cv+'%;background:'+cc+';border-radius:2px;transition:width 1s"></div></div><span style="font-size:10px;font-weight:700;color:'+cc+';width:24px;text-align:right">'+cv+'</span></div>';
}).join('');
}
// Trend sparkline
var svg=document.getElementById('healthTrendSvg');
if(svg&&MY_TREND.length>1){
var pts=MY_TREND.map(function(v,i){return (i*(80/(MY_TREND.length-1)))+','+(32-((v-40)/60)*32);});
var h='';for(var i=1;i<pts.length;i++)h+='<line x1="'+pts[i-1].split(',')[0]+'" y1="'+pts[i-1].split(',')[1]+'" x2="'+pts[i].split(',')[0]+'" y2="'+pts[i].split(',')[1]+'" stroke="'+col+'" stroke-width="2"/>';
pts.forEach(function(p,i){h+='<circle cx="'+p.split(',')[0]+'" cy="'+p.split(',')[1]+'" r="'+(i===pts.length-1?3:1.5)+'" fill="'+col+'"/>';});
svg.innerHTML=h;
}
var tt=document.getElementById('healthTrendText');
if(tt){var d=MY_TREND[MY_TREND.length-1]-MY_TREND[MY_TREND.length-2];tt.textContent=(d>=0?'â†‘ +':'â†“ ')+d;tt.style.color=d>=0?'#16a34a':'#dc2626';}
// Trainer hint
var th=document.getElementById('healthTrainerHint'),thT=document.getElementById('healthTrainerText');
if(th&&activeTrainers.length>0){th.style.display='';thT.textContent=activeTrainers.length+' Trainer aktiv: '+activeTrainers.map(function(t){return t.title;}).join(', ');}
}

// â•â•â• HQ HEALTH RENDER â•â•â•
window.renderHqHealth = renderHqHealth;
function renderHqHealth(){
var g=0,y=0,r=0,tot=0;
DEMO_STD.forEach(function(s){tot+=s.score;if(s.score>=75)g++;else if(s.score>=50)y++;else r++;});
var avg=Math.round(tot/DEMO_STD.length);
var $=function(id){return document.getElementById(id);};
if($('hqHealthGreen'))$('hqHealthGreen').textContent='ðŸŸ¢ '+g;
if($('hqHealthYellow'))$('hqHealthYellow').textContent='ðŸŸ¡ '+y;
if($('hqHealthRed'))$('hqHealthRed').textContent='ðŸ”´ '+r;
if($('hqHealthAvg'))$('hqHealthAvg').textContent=avg;
if($('hqHealthBar'))$('hqHealthBar').style.width=avg+'%';
var gr=$('hqHealthGrid');
if(gr){
var sorted=DEMO_STD.slice().sort(function(a,b){return b.score-a.score;});
gr.innerHTML=sorted.map(function(s){var c=sc(s.score);return '<div style="padding:8px;border-radius:8px;text-align:center;background:'+c+'08;border:1px solid '+c+'20;cursor:pointer" title="'+s.name+': '+s.score+'"><p style="font-size:9px;color:var(--c-sub);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+s.name.split(' ')[0]+'</p><p style="font-size:16px;font-weight:800;color:'+c+'">'+s.score+'</p></div>';}).join('');
}
// Trainer list
var tl=$('hqTrainerList');
if(tl){tl.innerHTML=[
{s:'Bonn',m:'Controlling',t:'BWA pÃ¼nktlich',st:'aktiv'},
{s:'Karlsruhe',m:'Verkauf',t:'Nachfass-System',st:'aktiv'},
{s:'Mannheim',m:'Marketing',t:'Content-Routine',st:'gestartet'},
{s:'NÃ¼rnberg',m:'Controlling',t:'BWA hochladen',st:'ignoriert'},
{s:'Dresden',m:'Werkstatt',t:'Auslastung',st:'aktiv'}
].map(function(t){var c={aktiv:'#16a34a',gestartet:'#2563eb',ignoriert:'#dc2626'}[t.st]||'#9ca3af';return '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--c-border2)"><span style="font-size:10px;font-weight:600;color:#111;flex:1">'+t.s+'</span><span style="font-size:9px;color:var(--c-muted)">'+t.m+' â†’ '+t.t+'</span><span style="font-size:9px;padding:1px 6px;border-radius:4px;color:'+c+';background:'+c+'12;font-weight:600">'+t.st+'</span></div>';}).join('');}
// Gruppencall list
var gl=$('hqGroupcallList');
if(gl){gl.innerHTML=[
{t:'Inhaber-Call',d:'Mi 05.03 Â· 10:00',p:18},{t:'VerkÃ¤ufer-Call',d:'Fr 07.03 Â· 09:00',p:24},{t:'Werkstatt-Call',d:'Do 13.03 Â· 14:00',p:15}
].map(function(c){return '<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--c-border2)"><span style="font-size:14px">ðŸ“ž</span><div style="flex:1"><p style="font-size:11px;font-weight:600;color:#111">'+c.t+'</p><p style="font-size:9px;color:var(--c-muted)">'+c.d+'</p></div><span style="font-size:9px;color:var(--c-sub)">'+c.p+' TN</span></div>';}).join('');}
}

// â•â•â• TRAINER CARD â•â•â•
window.showTrainerCard=function(tr){
currentTrainer=tr;
var el=document.getElementById('trainerCardOverlay');if(!el)return;
document.getElementById('trainerModuleTag').textContent=tr.module.toUpperCase();
document.getElementById('trainerTitle').textContent=tr.title;
document.getElementById('trainerDesc').textContent=tr.desc;
document.getElementById('trainerTriggerInfo').textContent=t('tr_triggered')+tr.trigger;
document.getElementById('trainerCTA').textContent='â–¶ Starten ('+tr.dur+')';
var st=document.getElementById('trainerSteps');
if(st)st.innerHTML=tr.steps.map(function(s,i){return '<div style="display:flex;align-items:flex-start;gap:6px"><span style="width:18px;height:18px;border-radius:50%;background:var(--c-bg3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--c-muted);flex-shrink:0">'+(i+1)+'</span><span style="font-size:11px;color:var(--c-sub)">'+s+'</span></div>';}).join('');
el.style.display='';
};
window.closeTrainer=function(){document.getElementById('trainerCardOverlay').style.display='none';};
window.snoozeTrainer=function(){closeTrainer();};
window.startTrainer=function(){
if(!currentTrainer)return;
alert('ðŸŽ“ Trainer "'+currentTrainer.title+'" gestartet!\n\nIn Produktion: Micro-Learning ('+currentTrainer.dur+') mit konkreter Handlung.');
var imp=document.getElementById('trainerImpact');
if(imp){imp.style.display='';imp.innerHTML='âœ… Trainer gestartet! Aufgabe: <strong>'+currentTrainer.task+'</strong>';}
};
window.createTrainerTask=function(){
if(!currentTrainer)return;
alert('ðŸ“‹ Aufgabe erstellt: "'+currentTrainer.task+'"');
closeTrainer();
};

// â•â•â• TICKET INTERCEPTOR â•â•â•
window.checkTicketInterceptor=function(){
var catEl=document.getElementById('ticketCatInput');
if(!catEl)return;
var cat=catEl.value;
var sol=SOLUTIONS[cat];
var ic=document.getElementById('ticketInterceptor');
var icC=document.getElementById('interceptorContent');
if(!sol||!ic||!icC){if(ic)ic.style.display='none';return;}
ic.style.display='';
icC.innerHTML='<p class="text-xs font-semibold text-gray-700 mb-1">'+sol.title+'</p>'+sol.items.map(function(i){return '<div style="display:flex;align-items:flex-start;gap:6px;padding:4px 8px;background:var(--c-bg);border-radius:6px"><span style="color:#EF7D00;font-size:12px">â†’</span><span style="font-size:11px;color:var(--c-sub)">'+i+'</span></div>';}).join('');
};
window.acceptInterceptor=function(){
document.getElementById('ticketInterceptor').style.display='none';
document.getElementById('ticketCreate').classList.add('hidden');
alert(t('misc_solution_try'));
};
window.skipInterceptor=function(){
document.getElementById('ticketInterceptor').style.display='none';
};
// Hook category select
setTimeout(function(){
var catSel=document.getElementById('ticketCatInput');
if(catSel)catSel.addEventListener('change',function(){checkTicketInterceptor();});
},500);

// â•â•â• GRUPPENCALL PREP â•â•â•
window.showGroupcallPrep=function(){
var p=document.getElementById('groupcallPrepPanel');if(!p)return;
document.getElementById('gcpScore').textContent=MY.score;
document.getElementById('gcpScore').style.color=sc(MY.score);
document.getElementById('gcpStatus').innerHTML=se(MY.score)+' '+sl(MY.score);
document.getElementById('gcpRank').textContent=DEMO_STD.slice().sort(function(a,b){return b.score-a.score;}).findIndex(function(s){return s.name==='Grafrath';})+1+'/'+DEMO_STD.length;
// Categories
var cats=document.getElementById('gcpCategories');
if(cats)cats.innerHTML=HEALTH_CATS.map(function(c){var v=MY.s[c.id]||0;return '<div style="display:flex;align-items:center;justify-content:between;gap:6px;padding:4px 0"><span style="font-size:12px">'+c.icon+'</span><span style="flex:1;font-size:11px;color:var(--c-sub)">'+c.n+'</span><span style="font-size:12px;font-weight:700;color:'+sc(v)+'">'+v+'</span></div>';}).join('');
// Trainers
var tl=document.getElementById('gcpTrainers');
if(tl)tl.innerHTML=activeTrainers.length>0?activeTrainers.map(function(t){return '<div style="font-size:11px;padding:3px 0;border-bottom:1px solid var(--c-border2)">ðŸŽ“ '+t.title+' <span style="color:var(--c-muted)">('+t.module+')</span></div>';}).join(''):'<p style="font-size:11px;color:var(--c-muted)">Keine aktiven Trainer</p>';
p.style.display='';
p.querySelector('.gc-prep-slider').style.transform='translateX(0)';
};
window.closeGroupcallPrep=function(){
var s=document.querySelector('.gc-prep-slider');
if(s)s.style.transform='translateX(100%)';
setTimeout(function(){document.getElementById('groupcallPrepPanel').style.display='none';},350);
};

// [Hook 3 moved to unified dispatcher]

// [Init moved to unified dispatcher]

})();
</script>


<!-- â•â•â• GRUPPENCALL PREP PANEL â•â•â• -->
<div id="groupcallPrepPanel" style="display:none;position:fixed;inset:0;z-index:9998;">
    <div onclick="closeGroupcallPrep()" style="position:absolute;inset:0;background:rgba(0,0,0,0.4)"></div>
    <div class="gc-prep-slider" style="position:absolute;top:0;right:0;bottom:0;width:380px;background:var(--c-bg);box-shadow:-8px 0 30px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.16,1,0.3,1);overflow-y:auto;">
        <div style="padding:24px;">
            <button onclick="closeGroupcallPrep()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:18px;cursor:pointer;color:var(--c-muted)">âœ•</button>
            <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:4px;">Gruppencall</p>
            <h2 style="font-size:16px;font-weight:800;color:var(--c-text);margin-bottom:16px;">ðŸ“Š Deine Zahlen fÃ¼r den Call</h2>

            <!-- Score Card -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                <p style="font-size:10px;color:var(--c-muted);">Health Score</p>
                <p id="gcpScore" style="font-size:36px;font-weight:900;color:#16a34a">â€”</p>
                <p id="gcpStatus" style="font-size:11px;font-weight:600;margin-top:2px;"></p>
                <p style="font-size:10px;color:var(--c-muted);margin-top:4px;">Rang: <span id="gcpRank" style="font-weight:700;">â€”</span></p>
            </div>

            <!-- Categories -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:8px;">KPI-Ãœbersicht</p>
                <div id="gcpCategories"></div>
            </div>

            <!-- Key Metrics -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:8px;">Wichtige Kennzahlen</p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="padding:8px;background:var(--c-bg);border-radius:8px;text-align:center"><p style="font-size:9px;color:var(--c-muted)">Abschlussquote</p><p style="font-size:16px;font-weight:800;color:var(--c-text)">34%</p></div>
                    <div style="padding:8px;background:var(--c-bg);border-radius:8px;text-align:center"><p style="font-size:9px;color:var(--c-muted)">BWA-Status</p><p style="font-size:16px;font-weight:800;color:#ca8a04">â³</p></div>
                    <div style="padding:8px;background:var(--c-bg);border-radius:8px;text-align:center"><p style="font-size:9px;color:var(--c-muted)">Offene Aufgaben</p><p style="font-size:16px;font-weight:800;color:var(--c-text)">4</p></div>
                    <div style="padding:8px;background:var(--c-bg);border-radius:8px;text-align:center"><p style="font-size:9px;color:var(--c-muted)">Content letzte 14d</p><p style="font-size:16px;font-weight:800;color:#16a34a">2</p></div>
                </div>
            </div>

            <!-- Active Trainers -->
            <div style="background:var(--c-bg2);border-radius:12px;padding:16px;margin-bottom:16px;">
                <p style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-muted);font-weight:600;margin-bottom:8px;">Aktive Trainer</p>
                <div id="gcpTrainers"></div>
            </div>

            <!-- Actions -->
            <div style="display:flex;flex-direction:column;gap:8px;">
                <button onclick="alert(t('misc_group_call'))" style="width:100%;padding:10px;background:#EF7D00;color:white;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">Frage fÃ¼r den Call einreichen</button>
                <button onclick="closeGroupcallPrep()" style="width:100%;padding:10px;background:var(--c-bg3);color:var(--c-sub);border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">SchlieÃŸen</button>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• GOVERNANCE EXTENSIONS: KPI Triggers, Support Levels, Impact Checks â•â•â• -->
<script>
(function(){
    // â”€â”€â”€â”€ KPI TRIGGER ENGINE â”€â”€â”€â”€
    // Checks metrics and auto-assigns trainers
    window.kpiTriggerEngine = function() {
        if(typeof MY === 'undefined' || !MY) return;
        var triggers = [];

        // Controlling: BWA pÃ¼nktlich?
        if(MY.s.controlling < 60) triggers.push({module:'controlling', trainerId:'t2', reason:'Controlling-Score unter 60'});

        // Verkauf: Abschlussquote?
        if(MY.s.verkauf < 65) triggers.push({module:'verkauf', trainerId:'t1', reason:'Verkaufs-Score unter 65'});

        // Marketing: Content-Frequenz?
        if(MY.s.marketing < 60) triggers.push({module:'marketing', trainerId:'t3', reason:'Marketing-Score unter 60'});

        // Werkstatt: Auslastung?
        if(MY.s.werkstatt < 60) triggers.push({module:'werkstatt', trainerId:'t4', reason:'Werkstatt-Score unter 60'});

        // Einkauf: Rohertrag?
        if(MY.s.controlling < 50 || MY.s.verkauf < 50) triggers.push({module:'einkauf', trainerId:'t6', reason:'Rohertrag potentiell unter Schnitt'});

        console.log('[KPI Trigger Engine] '+triggers.length+' triggers found:', triggers.map(function(t){return t.module;}).join(', '));
        return triggers;
    };

    // â”€â”€â”€â”€ SUPPORT LEVEL SYSTEM â”€â”€â”€â”€
    window.getSupportLevel = function() {
        if(typeof MY === 'undefined' || !MY) return 'A';
        var score = MY.score;
        var hasTrainer = typeof activeTrainers !== 'undefined' && activeTrainers.length > 0;

        // Level A: Quick Ping (async, for healthy scores)
        // Level B: Review (for observation scores)
        // Level C: 15 Min Call (only for critical or post-trainer)
        if(score < 50) return 'C'; // Critical -> direct HQ access
        if(score < 75 && !hasTrainer) return 'A'; // Observation, try trainer first
        if(score < 75 && hasTrainer) return 'B'; // Observation + trainer tried
        return 'A'; // Healthy
    };

    window.canBookHqCall = function() {
        var level = getSupportLevel();
        // Can only book call at Level B or C
        return level === 'B' || level === 'C';
    };

    // â”€â”€â”€â”€ IMPACT CHECK (7-day follow-up) â”€â”€â”€â”€
    window.scheduleImpactCheck = function(trainerId, startDate) {
        // In production: store in Supabase, cron checks after 7 days
        var checkDate = new Date(startDate);
        checkDate.setDate(checkDate.getDate() + 7);
        console.log('[Impact Check] Scheduled for trainer '+trainerId+' on '+checkDate.toISOString().split('T')[0]);
        // Store locally for demo
        try {
            var checks = JSON.parse(localStorage.getItem('vit_impact_checks') || '[]');
            checks.push({trainerId: trainerId, checkDate: checkDate.toISOString(), resolved: false});
            localStorage.setItem('vit_impact_checks', JSON.stringify(checks));
        } catch(e){}
    };

    window.checkPendingImpacts = function() {
        try {
            var checks = JSON.parse(localStorage.getItem('vit_impact_checks') || '[]');
            var today = new Date();
            var due = checks.filter(function(c) { return !c.resolved && new Date(c.checkDate) <= today; });
            if(due.length > 0) {
                console.log('[Impact Check] '+due.length+' checks due!');
                // In production: compare KPI before/after, show result
            }
        } catch(e){}
    };

    // â”€â”€â”€â”€ ONBOARDING PHASE TRACKING â”€â”€â”€â”€
    window.getOnboardingPhase = function() {
        try {
            var phase = localStorage.getItem('vit_onb_phase');
            if(phase === 'done') return {phase: 4, label: 'Abgeschlossen'};
            if(phase) return JSON.parse(phase);
        } catch(e){}
        // Default: check if onboarding view has been shown
        return {phase: 2, label: 'Woche 1', progress: 65};
    };

    window.completeOnboardingPhase = function(phaseNum) {
        if(phaseNum >= 3) {
            try { localStorage.setItem('vit_onb_phase', 'done'); } catch(e){}
            console.log('[Onboarding] Completed! Switching to Performance trainers.');
        } else {
            try { localStorage.setItem('vit_onb_phase', JSON.stringify({phase: phaseNum+1, label: phaseNum===1?'Woche 1':'Woche 2-3', progress: phaseNum*33})); } catch(e){}
        }
    };

    // â”€â”€â”€â”€ SOFT LOCK CONTROLLER â”€â”€â”€â”€
    window.checkSoftLocks = function() {
        if(typeof MY === 'undefined' || !MY) return;

        // Pipeline Insights: locked if close rate low AND no trainer completed
        var pLock = document.getElementById('pipelineInsightLock');
        if(pLock) {
            // Demo: lock if verkauf < 70
            pLock.style.display = MY.s.verkauf < 70 ? '' : 'none';
        }

        // HQ Booking: only available after trainer attempt or critical score
        // (This is checked by canBookHqCall())
    };

    // â”€â”€â”€â”€ Dark mode for new panels â”€â”€â”€â”€
    // Handled by existing [data-theme="dark"] rules for .gc-prep-slider via white bg override

    // â”€â”€â”€â”€ INIT â”€â”€â”€â”€
    setTimeout(function(){
        if(typeof kpiTriggerEngine === 'function') kpiTriggerEngine();
        if(typeof checkPendingImpacts === 'function') checkPendingImpacts();
        if(typeof checkSoftLocks === 'function') checkSoftLocks();
    }, 1000);
})();
</script>


<!-- â•â•â• AUTO-INIT on enterApp â•â•â• -->
<script>
(function(){
    // showView render triggers now handled by view-router.js module
    
    // Auto-init for initial page load (homeView is display:block by default)
    // Wait for enterApp() to finish, then render everything
    var _baseEnterApp = window.enterApp;
    if(_baseEnterApp) {
        window.enterApp = function() {
            _baseEnterApp();
            setTimeout(function(){
                if(typeof renderDailyFocus === 'function') renderDailyFocus();
                if(typeof renderHealthScore === 'function') renderHealthScore();
                if(typeof renderSalesMomentum === 'function') renderSalesMomentum();
                if(typeof updateBwaDeadlineWidget === 'function') updateBwaDeadlineWidget();
                if(typeof renderHqBwaStatus === 'function') renderHqBwaStatus();
                if(typeof renderHqHealth === 'function') renderHqHealth();
                // Trainer card after 4s (only for Standort users, not HQ)
                if(typeof showTrainerCard === 'function' && typeof activeTrainers !== 'undefined' && activeTrainers.length > 0 && currentRole !== 'hq') {
                    setTimeout(function(){ showTrainerCard(activeTrainers[0]); }, 4000);
                }
            }, 500);
        };
    }

    // Fallback: also init after 1s in case enterApp is not called (direct page load)
    setTimeout(function(){
        if(typeof renderDailyFocus === 'function') renderDailyFocus();
        if(typeof renderHealthScore === 'function') renderHealthScore();
    }, 1000);
})();
</script>


<!-- Widget Info Toggle -->
<script>
function toggleWidgetInfo(e, id) {
    e.stopPropagation();
    e.preventDefault();
    var el = document.getElementById(id);
    if(!el) return;
    
    // Close all others
    document.querySelectorAll('.widget-info-popup.active').forEach(function(p){
        if(p.id !== id) p.classList.remove('active');
    });
    
    // Remove existing overlay
    var oldOv = document.getElementById('widgetInfoOverlay');
    if(oldOv) oldOv.remove();
    
    var isOpen = el.classList.contains('active');
    if(isOpen) {
        el.classList.remove('active');
        return;
    }
    
    // Create overlay
    var ov = document.createElement('div');
    ov.id = 'widgetInfoOverlay';
    ov.className = 'widget-info-overlay active';
    ov.onclick = function(){ el.classList.remove('active'); ov.remove(); };
    document.body.appendChild(ov);
    
    el.classList.add('active');
}
</script>


<!-- â•â•â• RESEND E-MAIL INTEGRATION â•â•â• -->
<script>
(function(){
    // â”€â”€ Config â”€â”€
    var RESEND_EDGE_URL = ''; // Set: sb.functions.invoke('send-email', ...)
    var EMAIL_LOG = []; // In-memory log (prod: notifications_log table)

    // â”€â”€ Central send function â”€â”€
    window.sendEmail = async function(template, to, data) {
        // Anti-spam check
        var key = template + '|' + to + '|' + (data.context_id || '');
        var cooldowns = {welcome:Infinity, employee_welcome:Infinity, employee_invite:Infinity, bwa_escalation:30*86400000, lead_stale:7*86400000, deal_status:0, trainer_ignored:48*3600000, groupcall_reminder:24*3600000};
        var cd = cooldowns[template] || 86400000;
        if(cd > 0) {
            var existing = EMAIL_LOG.find(function(l){return l.key===key && (Date.now()-l.ts)<cd;});
            if(existing) { console.log('[Email] Cooldown active for', key); return null; }
        }

        // Log
        var logEntry = {key:key, template:template, to:to, ts:Date.now(), status:'sent'};
        EMAIL_LOG.push(logEntry);

        // In production: call Supabase Edge Function
        if(typeof sb !== 'undefined' && sb.functions) {
            try {
                var res = await sb.functions.invoke('send-email', {body:{template:template, to:to, data:data}});
                if(res.error) { logEntry.status = 'failed'; console.error('[Email] Error:', res.error); }
                else { console.log('[Email] Sent:', template, 'to', to); }
                // Log to DB
                if(sb.from) {
                    await sb.from('notifications_log').insert({
                        location_id: data.location_id || null,
                        user_id: data.user_id || null,
                        template: template,
                        recipient_email: to,
                        context_json: data,
                        status: logEntry.status,
                        resend_id: res.data ? res.data.id : null
                    });
                }
                return res;
            } catch(e) { logEntry.status = 'failed'; console.error('[Email]', e); }
        } else {
            console.log('[Email][Demo] Would send:', template, 'to', to, data);
        }

        // Show notification in portal
        showEmailNotification(template, to);
        return logEntry;
    };

    // â”€â”€ Visual notification â”€â”€
    function showEmailNotification(template, to) {
        var names = {
            welcome: 'ðŸ“§ Willkommens-Mail gesendet',
            employee_welcome: 'ðŸ“§ Willkommens-Mail an Mitarbeiter gesendet',
            employee_invite: 'âœ‰ï¸ Einladungs-Mail an Mitarbeiter gesendet',
            bwa_escalation: 'âš ï¸ BWA-Eskalationsmail gesendet',
            lead_stale: 'ðŸ“§ Lead-Erinnerung gesendet',
            deal_status: 'ðŸ“§ Deal-Status-Mail gesendet',
            trainer_ignored: 'ðŸ“§ Trainer-Erinnerung gesendet',
            groupcall_reminder: 'ðŸ“§ Gruppencall-Erinnerung gesendet'
        };
        var msg = names[template] || 'ðŸ“§ E-Mail gesendet';
        var toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:16px;right:16px;z-index:10000;padding:12px 20px;border-radius:10px;background:#16a34a;color:white;font-size:13px;font-weight:600;font-family:Outfit,sans-serif;box-shadow:0 4px 16px rgba(0,0,0,0.15);opacity:0;transition:opacity 0.3s;';
        toast.innerHTML = msg + '<span style="font-size:11px;opacity:0.8;margin-left:8px;">â†’ ' + to + '</span>';
        document.body.appendChild(toast);
        requestAnimationFrame(function(){toast.style.opacity='1';});
        setTimeout(function(){toast.style.opacity='0';setTimeout(function(){toast.remove();},300);},3500);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 1: Welcome bei Anmeldung
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Hook into enterApp for first-login detection
    var _origEnterApp2 = window.enterApp;
    if(_origEnterApp2) {
        window.enterApp = function() {
            _origEnterApp2();
            // Check if first login (no previous session)
            setTimeout(function(){
                if(typeof sbProfile !== 'undefined' && sbProfile) {
                    var isFirst = !localStorage.getItem('vit-welcomed-' + sbProfile.id);
                    if(isFirst) {
                        sendEmail('welcome', sbProfile.email || '', {
                            name: sbProfile.name || 'Partner',
                            portalUrl: window.location.href,
                            standort: (typeof sbStandort !== 'undefined' && sbStandort) ? sbStandort.name : '',
                            location_id: sbProfile.standort_id,
                            user_id: sbProfile.id
                        });
                        try { localStorage.setItem('vit-welcomed-' + sbProfile.id, '1'); } catch(e){}
                    }
                }
            }, 2000);
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 2: BWA Eskalation (Stufe 3)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.triggerBwaEscalation = function(standortName, ownerEmail, bwaMonth) {
        sendEmail('bwa_escalation', ownerEmail, {
            month: bwaMonth,
            standort: standortName,
            uploadUrl: window.location.href + '#controlling',
            context_id: 'bwa_' + bwaMonth
        });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 3: Lead Ã¤lter als X Tage
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.checkStaleLeads = function() {
        // In prod: query leads table
        // Demo: simulate
        var staleLeads = [
            {name:'Thomas MÃ¼ller', age:7, seller:'max@vitbikes-grafrath.de', id:'l1'},
            {name:'Anna Schmidt', age:12, seller:'max@vitbikes-grafrath.de', id:'l2'}
        ];
        staleLeads.forEach(function(lead){
            if(lead.age >= 5) {
                sendEmail('lead_stale', lead.seller, {
                    leadName: lead.name,
                    daysSinceContact: lead.age,
                    context_id: 'lead_' + lead.id
                });
            }
        });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 4: Pipeline â€“ Angebot angenommen/abgelehnt
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.triggerDealStatusEmail = function(dealName, dealValue, status, sellerEmail, kundeEmail) {
        sendEmail('deal_status', sellerEmail, {
            deal: dealName,
            value: dealValue,
            status: status, // 'gewonnen' oder 'verloren'
            context_id: 'deal_' + dealName
        });
        // Optional: Auch Kunden benachrichtigen bei Gewonnen
        if(status === 'gewonnen' && kundeEmail) {
            sendEmail('deal_status', kundeEmail, {
                deal: dealName,
                value: dealValue,
                status: 'bestaetigung'
            });
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 5: Trainer ignoriert (48h)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    var _origSnooze = window.snoozeTrainer;
    var snoozeCount = {};
    window.snoozeTrainer = function() {
        if(typeof currentTrainer !== 'undefined' && currentTrainer) {
            var tid = currentTrainer.id;
            snoozeCount[tid] = (snoozeCount[tid] || 0) + 1;
            if(snoozeCount[tid] >= 2) {
                // 2x ignoriert â†’ E-Mail
                var email = (typeof sbProfile !== 'undefined' && sbProfile) ? sbProfile.email : 'demo@vitbikes.de';
                sendEmail('trainer_ignored', email, {
                    trainerTitle: currentTrainer.title,
                    module: currentTrainer.module,
                    context_id: 'trainer_' + tid
                });
            }
        }
        if(_origSnooze) _origSnooze();
        else if(document.getElementById('trainerCardOverlay')) document.getElementById('trainerCardOverlay').style.display='none';
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TRIGGER 6: Gruppencall-Erinnerung (24h vorher)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.triggerGroupcallReminder = function(callTitle, callDate, callTime, zoomLink, participants) {
        participants.forEach(function(p){
            sendEmail('groupcall_reminder', p.email, {
                callTitle: callTitle,
                date: callDate,
                time: callTime,
                link: zoomLink,
                context_id: 'call_' + callDate + '_' + callTitle
            });
        });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EMAIL LOG VIEWER (HQ feature)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.getEmailLog = function(){ return EMAIL_LOG; };

})();
</script>


<!-- === DB-BACKED SMART TRIGGER ENGINE === -->
<script>
(function(){
    function renderTrainerCard(a, c) {
        var t=a.trainer;if(!t)return;var d=document.createElement('div');d.className='vit-card p-0 mb-3';
        d.style.cssText='border:1px solid #fed7aa;overflow:hidden;';d.id='trainerCard_'+a.id;
        d.innerHTML='<div style="padding:12px 16px;background:linear-gradient(135deg,rgba(239,125,0,0.08),rgba(245,158,11,0.04));border-bottom:1px solid #fed7aa;"><div class="flex items-center justify-between"><div class="flex items-center gap-2"><span style="font-size:18px">ðŸŽ“</span><div><p class="text-[10px] font-bold text-vit-orange uppercase">'+(t.area_key||'').toUpperCase()+'</p><p class="text-sm font-bold text-gray-800">'+t.title+'</p></div></div><span class="text-[10px] text-gray-400">'+(t.duration_minutes||5)+' Min</span></div></div><div style="padding:12px 16px;"><p class="text-xs text-gray-600 mb-2">'+(t.summary||'')+'</p><div class="flex gap-2"><button onclick="window._startDbTrainer&&window._startDbTrainer(\''+a.id+'\')" class="flex-1 px-3 py-2 bg-vit-orange text-white text-xs font-bold rounded-lg hover:opacity-90">â–¶ Starten</button><button onclick="window._snoozeDbTrainer&&window._snoozeDbTrainer(\''+a.id+'\')" class="px-3 py-2 bg-gray-100 text-gray-500 text-xs font-bold rounded-lg hover:bg-gray-200">â° SpÃ¤ter</button></div></div>';
        c.appendChild(d);
    }
    async function loadTrainersForArea(k){if(typeof sb==='undefined'||!sbProfile)return[];try{var r=await sb.from('trainer_assignments').select('*,trainer:trainer_id(*)').eq('standort_id',sbProfile.standort_id).eq('status','active');return(r.data||[]).filter(function(a){return a.trainer&&a.trainer.is_active&&(!k||a.trainer.area_key===k)&&(!a.cooldown_until||new Date(a.cooldown_until)<=new Date());}).sort(function(a,b){return(a.trainer.priority||3)-(b.trainer.priority||3);}).slice(0,1);}catch(e){return[];}}
    async function _smartTriggerCheck(k){if(typeof sb==='undefined'||!sbProfile||!sbProfile.standort_id)return;var sid=sbProfile.standort_id;try{var t=(await sb.from('trainers').select('*').eq('area_key',k).eq('is_active',true)).data||[];if(!t.length)return;var ex=((await sb.from('trainer_assignments').select('trainer_id').eq('standort_id',sid).eq('status','active')).data||[]).map(function(a){return a.trainer_id;});var cm={};((await sb.from('trainer_completions').select('trainer_id,completed_at').eq('standort_id',sid).order('completed_at',{ascending:false}).limit(50)).data||[]).forEach(function(c){cm[c.trainer_id]=c.completed_at;});for(var i=0;i<t.length;i++){var tr=t[i];if(ex.indexOf(tr.id)>=0)continue;if(cm[tr.id]&&(Date.now()-new Date(cm[tr.id]).getTime())/86400000<14)continue;var fire=await _evaluateTrigger(tr,sid);if(fire)await sb.from('trainer_assignments').upsert({trainer_id:tr.id,standort_id:sid,status:'active'},{onConflict:'trainer_id,standort_id'});}}catch(e){console.warn('SmartTrigger:',e);}}
    async function _evaluateTrigger(tr,sid){var k=tr.trigger_key;if(k==='open_offers_no_followup'){var r=await sb.from('leads').select('id,letzter_kontakt,status').eq('standort_id',sid).not('status','in','("gewonnen","verloren")');var l=r.data||[];return l.filter(function(x){return!x.letzter_kontakt||(Date.now()-new Date(x.letzter_kontakt).getTime())/86400000>7;}).length>=5||l.length===0;}if(k==='bwa_missing'){var m=typeof getBwaMonth==='function'?getBwaMonth(new Date()):null;if(!m)return false;var r=await sb.from('bwa_daten').select('id').eq('standort_id',sid).eq('monat',m.m+1).eq('jahr',m.y).limit(1);return!(r.data&&r.data.length>0);}if(k==='no_content_14d'){var s=new Date(Date.now()-14*86400000).toISOString();var r=await sb.from('portal_events').select('id').eq('standort_id',sid).eq('event_type','content_uploaded').gte('created_at',s).limit(1);return!(r.data&&r.data.length>0);}return false;}
    window.showTrainerForArea=async function(k,cid){var c=document.getElementById(cid);if(!c)return;c.innerHTML='';await _smartTriggerCheck(k);var a=await loadTrainersForArea(k);if(a.length>0)renderTrainerCard(a[0],c);};
    window._snoozeDbTrainer=async function(id){if(typeof sb==='undefined')return;await sb.from('trainer_assignments').update({cooldown_until:new Date(Date.now()+48*3600000).toISOString()}).eq('id',id);var c=document.getElementById('trainerCard_'+id);if(c)c.remove();};
    window._startDbTrainer=function(){alert(t('tr_started'));};
})();
</script>
<!-- === WISSEN MODULE: MEMBERSPOT-STYLE LEARNING PLATFORM === -->
<script>
(function(){

// â•â•â• PORTAL GUIDE DATA (auto-generated from module registry) â•â•â•
var PORTAL_GUIDES = [
    {id:'pg1',bereich:'portal',title:'Startseite & Tages-Cockpit',icon:'ðŸ ',
     desc:'Deine Zentrale: Tages-KPIs, Health Score, Umsatz vs. Plan und Schnellzugriffe.',
     steps:['Nach Login siehst du das Tages-Cockpit mit 5 KPIs','Klicke auf eine Kachel um ins Modul zu springen','Der Health Score zeigt deine Gesamtperformance','Widgets kannst du Ã¼ber das Zahnrad-Icon anpassen'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg2',bereich:'portal',title:'Verkauf & Pipeline',icon:'ðŸ’°',
     desc:'Lead-Management, Pipeline-Stages, Angebote, Wochenauswertung und KI-Training.',
     steps:['Pipeline zeigt alle Leads in Kanban-Ansicht','Ziehe Leads zwischen den Stages','Streak-Anzeige motiviert zur tÃ¤glichen AktivitÃ¤t','Monatsziel-Fortschritt oben immer sichtbar','KI-Training simuliert VerkaufsgesprÃ¤che'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg3',bereich:'portal',title:'Controlling & BWA',icon:'ðŸ“Š',
     desc:'BWA hochladen, KPI-Report erhalten, Benchmarks freischalten, Plan/Ist vergleichen.',
     steps:['Cockpit zeigt BWA-Deadline Countdown','BWA hochladen unter "BWAs" Tab','Nach Upload: sofortiges KPI-Feedback','Benchmark wird freigeschaltet nach Einreichung','Gold-Status bei Abgabe vor dem 8.'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg4',bereich:'portal',title:'Marketing',icon:'ðŸ“£',
     desc:'Kampagnen-Cockpit, Social Media Ranking, Content-Upload, Budget-Ãœbersicht.',
     steps:['Cockpit zeigt aktive Kampagnen und KPIs','Content hochladen im "Mein Content" Tab','Ranking zeigt deine Position im Netzwerk','Badge-System belohnt regelmÃ¤ÃŸige AktivitÃ¤t'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg5',bereich:'portal',title:'Einkauf',icon:'ðŸ›’',
     desc:'Sortiment, Lieferanten-Konditionen, Vororder-Planung, Bestandsmanagement.',
     steps:['Sortiment-Tab zeigt aktuelle VerfÃ¼gbarkeit','Lieferanten-Tab mit Konditionen und Kontakten','Vororder-Planung mit Countdown-Timer'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg6',bereich:'portal',title:'Support & Tickets',icon:'ðŸŽ«',
     desc:'Tickets erstellen, Auto-Support nutzen, HQ-Kontakte finden.',
     steps:['Neues Ticket: Kategorie wÃ¤hlen','Auto-Support schlÃ¤gt sofortige LÃ¶sungen vor','Nur bei Bedarf geht Ticket an HQ','Kontakte-Tab zeigt alle Ansprechpartner'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg7',bereich:'portal',title:'Kalender & Aufgaben',icon:'ðŸ“…',
     desc:'Termine verwalten, Aufgaben tracken, Gruppencall-Vorbereitung.',
     steps:['Monats/Wochen/Tagesansicht wÃ¤hlbar','Termine mit Typ und Teilnehmern anlegen','Aufgaben-Board mit Status-Spalten','Gruppencall-Vorbereitung vor jedem Call'],
     version:'7.0',updated:'Feb 2026'},
    {id:'pg8',bereich:'portal',title:'Nutzerprofil & Einstellungen',icon:'âš™ï¸',
     desc:'PersÃ¶nliche Daten, Theme, E-Mail-Benachrichtigungen anpassen.',
     steps:['Klick auf Avatar oben rechts Ã¶ffnet Profil','Name, Telefon, Position editierbar','Dark/Light Mode umschalten','E-Mail-Benachrichtigungen ein/ausschalten'],
     version:'7.0',updated:'Feb 2026'}
];

// â•â•â• KURSE (Memberspot-Style) â•â•â•
var KURSE = [
    {id:'k1',bereich:'verkauf',title:'Verkaufsprofi in 5 Tagen',
     desc:'Der komplette Verkaufskurs: Vom Erstkontakt bis zum Abschluss. Mit PraxisÃ¼bungen und KI-Rollenspielen.',
     instructor:'vit:bikes Akademie',duration:'5 Tage Â· 3h Gesamt',level:'Einsteiger',
     thumbnail:'ðŸŽ¯',progress:35,enrolled:true,
     chapters:[
         {title:'Tag 1: Bedarfsanalyse',lessons:[
             {title:'Warum Fragen wichtiger sind als Antworten',type:'video',duration:'8:30',done:true},
             {title:'Die 5 SchlÃ¼sselfragen',type:'text',duration:'5 min',done:true},
             {title:'Ãœbung: Bedarfsanalyse simulieren',type:'exercise',duration:'10 min',done:false}
         ]},
         {title:'Tag 2: Probefahrt & Erlebnis',lessons:[
             {title:'Die perfekte Probefahrt gestalten',type:'video',duration:'6:15',done:false},
             {title:'Emotionen wecken: Storytelling',type:'text',duration:'4 min',done:false},
             {title:'Checkliste: Probefahrt-Setup',type:'download',duration:'â€”',done:false}
         ]},
         {title:'Tag 3: Einwandbehandlung',lessons:[
             {title:'Top 5 EinwÃ¤nde und wie du sie lÃ¶st',type:'video',duration:'12:00',done:false},
             {title:'Preis-Einwand: "Im Internet gÃ¼nstiger"',type:'text',duration:'6 min',done:false},
             {title:'KI-Rollenspiel: Einwand-Training',type:'ai',duration:'15 min',done:false}
         ]},
         {title:'Tag 4: Abschluss & Finanzierung',lessons:[
             {title:'Kaufsignale erkennen',type:'video',duration:'7:45',done:false},
             {title:'Leasing richtig erklÃ¤ren',type:'text',duration:'8 min',done:false}
         ]},
         {title:'Tag 5: Nachbetreuung',lessons:[
             {title:'Follow-Up das begeistert',type:'video',duration:'5:30',done:false},
             {title:'Empfehlungsmarketing aktivieren',type:'text',duration:'4 min',done:false},
             {title:'Abschlussquiz',type:'quiz',duration:'5 min',done:false}
         ]}
     ]},
    {id:'k2',bereich:'controlling',title:'BWA verstehen & handeln',
     desc:'In 3 Lektionen lernst du, deine BWA zu lesen, KPIs zu interpretieren und MaÃŸnahmen abzuleiten.',
     instructor:'vit:bikes Controlling',duration:'3 Lektionen Â· 90 Min',level:'Einsteiger',
     thumbnail:'ðŸ“Š',progress:0,enrolled:false,
     chapters:[
         {title:'Lektion 1: BWA-Grundlagen',lessons:[
             {title:'Was ist eine BWA?',type:'video',duration:'10:00',done:false},
             {title:'Die wichtigsten Positionen',type:'text',duration:'8 min',done:false},
             {title:'Deine erste BWA analysieren',type:'exercise',duration:'15 min',done:false}
         ]},
         {title:'Lektion 2: KPIs ableiten',lessons:[
             {title:'Rohertrag, Marge, Kostenquoten',type:'video',duration:'12:00',done:false},
             {title:'Benchmark: Du vs. Netzwerk',type:'text',duration:'6 min',done:false}
         ]},
         {title:'Lektion 3: MaÃŸnahmen definieren',lessons:[
             {title:'Von der Zahl zur Aktion',type:'video',duration:'8:00',done:false},
             {title:'MaÃŸnahmenplan erstellen',type:'exercise',duration:'20 min',done:false}
         ]}
     ]},
    {id:'k3',bereich:'marketing',title:'Social Media Meisterklasse',
     desc:'Von Null auf Content-Pro: Reels, Stories, Ads â€“ alles fÃ¼r lokale FahrradhÃ¤ndler.',
     instructor:'vit:bikes Marketing',duration:'4 Module Â· 2h',level:'Mittel',
     thumbnail:'ðŸ“±',progress:60,enrolled:true,
     chapters:[
         {title:'Modul 1: Content-Strategie',lessons:[
             {title:'Dein Content-Kalender',type:'video',duration:'10:00',done:true},
             {title:'Was funktioniert lokal?',type:'text',duration:'5 min',done:true},
             {title:'10 Posting-Ideen',type:'download',duration:'â€”',done:true}
         ]},
         {title:'Modul 2: Reels & Videos',lessons:[
             {title:'Reel in 60 Sekunden',type:'video',duration:'8:00',done:true},
             {title:'Schnitt mit CapCut',type:'video',duration:'12:00',done:true},
             {title:'Ãœbung: Dein erstes Reel',type:'exercise',duration:'20 min',done:false}
         ]},
         {title:'Modul 3: Meta Ads',lessons:[
             {title:'Ads Manager Basics',type:'video',duration:'15:00',done:false},
             {title:'Zielgruppen definieren',type:'text',duration:'8 min',done:false}
         ]},
         {title:'Modul 4: Analyse & Optimierung',lessons:[
             {title:'KPIs die zÃ¤hlen',type:'video',duration:'7:00',done:false},
             {title:'A/B Testing',type:'text',duration:'5 min',done:false}
         ]}
     ]},
    {id:'k4',bereich:'einkauf',title:'Einkauf & Rohertrag optimieren',
     desc:'Konditionen verhandeln, Dreingaben statt Rabatte, Lagerumschlag steigern.',
     instructor:'vit:bikes Einkauf',duration:'3 Module Â· 2h',level:'Fortgeschritten',
     thumbnail:'ðŸ›’',progress:0,enrolled:false,
     chapters:[
         {title:'Modul 1: Konditionsmodelle',lessons:[
             {title:'Block- vs. Vororder',type:'video',duration:'10:00',done:false},
             {title:'Rabatt-Staffeln verstehen',type:'text',duration:'6 min',done:false}
         ]},
         {title:'Modul 2: Rohertrag schÃ¼tzen',lessons:[
             {title:'Dreingaben statt Rabatte',type:'video',duration:'8:00',done:false},
             {title:'Sqlab & Co als Alternative',type:'text',duration:'5 min',done:false}
         ]},
         {title:'Modul 3: Bestandsmanagement',lessons:[
             {title:'Umschlag & LadenhÃ¼ter',type:'video',duration:'12:00',done:false},
             {title:'Saisonplanung Praxis',type:'exercise',duration:'15 min',done:false}
         ]}
     ]}
];

// â•â•â• ONBOARDING STEPS â•â•â•
var ONBOARDING = [
    {phase:'Phase 1 â€“ Tag 1',title:'Portal verstehen',icon:'ðŸš€',steps:[
        {title:'Einloggen & Startseite erkunden',done:true,action:'Portal Ã¶ffnen und alle Schnellzugriffe testen'},
        {title:'Profil einrichten',done:true,action:'Name, Telefon, Position im Profil-Panel eintragen'},
        {title:'1 Modul Ã¶ffnen (Verkauf oder Controlling)',done:false,action:'Klicke in der Sidebar auf ein Modul deiner Wahl'}
    ]},
    {phase:'Phase 2 â€“ Woche 1',title:'Kernprozesse lernen',icon:'ðŸ“š',steps:[
        {title:'BWA hochladen',done:false,action:'Controlling â†’ BWAs â†’ Hochladen'},
        {title:'Ersten Lead anlegen',done:false,action:'Verkauf â†’ Pipeline â†’ Neuer Lead'},
        {title:'3 Schulungen abschlieÃŸen',done:false,action:'Wissen â†’ Akademie â†’ Pflicht-Kurse starten'},
        {title:'Support-Ticket erstellen (Test)',done:false,action:'Support â†’ Neues Ticket â†’ Auto-Support testen'},
        {title:'Kalender-Termin anlegen',done:false,action:'Kalender â†’ + Termin â†’ Typ wÃ¤hlen'}
    ]},
    {phase:'Phase 3 â€“ Woche 2-3',title:'Performance verstehen',icon:'ðŸ“Š',steps:[
        {title:'Health Score prÃ¼fen & verstehen',done:false,action:'Startseite â†’ Health Score Widget â†’ â“˜ klicken'},
        {title:'Benchmark-Vergleich ansehen',done:false,action:'Controlling â†’ Benchmarks (BWA muss eingereicht sein)'},
        {title:'Am Gruppencall teilnehmen',done:false,action:'Kalender â†’ NÃ¤chster Rollen-Call â†’ Beitreten'},
        {title:'1 Trainer abschlieÃŸen',done:false,action:'Trainer-Card â†’ Starten â†’ Aufgabe erledigen'}
    ]}
];

// â•â•â• RENDER: Portal Guide â•â•â•
window.renderPortalGuide = function() {
    var el = document.getElementById('wissenGlobalContent');
    if(!el) return;
    var search = (document.getElementById('wissenSearch')||{}).value||'';
    var items = PORTAL_GUIDES;
    if(currentWissenBereich && currentWissenBereich !== 'all') items = items.filter(function(g){return g.bereich===currentWissenBereich;});
    if(search) { var s=search.toLowerCase(); items=items.filter(function(g){return g.title.toLowerCase().indexOf(s)>-1||g.desc.toLowerCase().indexOf(s)>-1;}); }
    
    el.innerHTML = '<div class="mb-4 p-4 rounded-xl" style="background:linear-gradient(135deg,rgba(239,125,0,0.06),rgba(245,158,11,0.04))"><div class="flex items-center gap-2 mb-1"><span style="font-size:16px">ðŸ“±</span><span class="text-sm font-bold text-gray-800">Portal-Anleitungen</span></div><p class="text-xs text-gray-500">Automatisch generiert aus der aktuellen Portal-Version. Wird bei Modul-Ã„nderungen aktualisiert.</p></div>' +
    '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">' +
    items.map(function(g){
        return '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer" onclick="showGuideDetail(\''+g.id+'\')"><div class="flex items-center gap-3 mb-2"><span style="font-size:28px">'+g.icon+'</span><div><p class="text-sm font-bold text-gray-800">'+g.title+'</p><p class="text-[10px] text-gray-400">v'+g.version+' Â· '+g.updated+'</p></div></div><p class="text-xs text-gray-500">'+g.desc+'</p><p class="text-[10px] text-vit-orange font-semibold mt-2">'+g.steps.length+' Schritte â†’</p></div>';
    }).join('') + '</div>';
};

window.showGuideDetail = function(id) {
    var g = PORTAL_GUIDES.find(function(p){return p.id===id;});
    if(!g) return;
    var el = document.getElementById('wissenGlobalContent');
    el.innerHTML = '<button onclick="switchWissenTyp(\'portal\')" class="text-xs text-vit-orange font-semibold mb-3 inline-block hover:underline">â† ZurÃ¼ck zu allen Anleitungen</button>' +
    '<div class="vit-card p-6"><div class="flex items-center gap-4 mb-4"><span style="font-size:40px">'+g.icon+'</span><div><h2 class="text-lg font-bold text-gray-800">'+g.title+'</h2><p class="text-sm text-gray-500">'+g.desc+'</p><p class="text-xs text-gray-400 mt-1">Version '+g.version+' Â· Aktualisiert '+g.updated+'</p></div></div>' +
    '<div class="space-y-3">' + g.steps.map(function(s,i){
        return '<div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg"><span style="width:28px;height:28px;border-radius:50%;background:#EF7D00;color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">'+(i+1)+'</span><p class="text-sm text-gray-700">'+s+'</p></div>';
    }).join('') + '</div></div>';
};

// â•â•â• RENDER: Kurse (Memberspot-Style) â•â•â•
window.renderKurse = function() {
    var el = document.getElementById('wissenGlobalContent');
    if(!el) return;
    var items = KURSE;
    if(currentWissenBereich && currentWissenBereich !== 'all') items = items.filter(function(k){return k.bereich===currentWissenBereich;});
    
    el.innerHTML = items.map(function(k){
        var totalLessons=0, doneLessons=0;
        k.chapters.forEach(function(ch){ch.lessons.forEach(function(l){totalLessons++;if(l.done)doneLessons++;});});
        var pct = totalLessons>0?Math.round(doneLessons/totalLessons*100):0;
        return '<div class="vit-card p-0 mb-4 overflow-hidden hover:shadow-md transition cursor-pointer" onclick="showKursDetail(\''+k.id+'\')">' +
        '<div class="flex">' +
        '<div style="width:100px;background:linear-gradient(135deg,#EF7D00,#F59E0B);display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:36px">'+k.thumbnail+'</span></div>' +
        '<div class="p-4 flex-1"><div class="flex items-center justify-between mb-1"><h3 class="text-sm font-bold text-gray-800">'+k.title+'</h3>'+(k.enrolled?'<span class="text-[10px] px-2 py-0.5 bg-green-100 text-green-600 rounded-full font-bold">Eingeschrieben</span>':'<span class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full font-bold">Nicht gestartet</span>')+'</div>' +
        '<p class="text-xs text-gray-500 mb-2">'+k.desc+'</p>' +
        '<div class="flex items-center gap-4 text-[10px] text-gray-400 mb-2"><span>ðŸ‘¤ '+k.instructor+'</span><span>â± '+k.duration+'</span><span>ðŸ“Š '+k.level+'</span><span>'+k.chapters.length+' Kapitel Â· '+totalLessons+' Lektionen</span></div>' +
        '<div class="flex items-center gap-2"><div class="flex-1 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full transition-all" style="width:'+pct+'%;background:'+(pct===100?'#16a34a':'#EF7D00')+'"></div></div><span class="text-xs font-bold '+(pct===100?'text-green-600':'text-gray-500')+'">'+pct+'%</span></div>' +
        '</div></div></div>';
    }).join('');
};

window.showKursDetail = function(id) {
    var k = KURSE.find(function(x){return x.id===id;});
    if(!k) return;
    var el = document.getElementById('wissenGlobalContent');
    var h = '<button onclick="switchWissenTyp(\'kurse\')" class="text-xs text-vit-orange font-semibold mb-3 inline-block hover:underline">â† ZurÃ¼ck zu allen Kursen</button>';
    h += '<div class="vit-card p-6 mb-4"><div class="flex items-center gap-4 mb-3"><span style="font-size:48px">'+k.thumbnail+'</span><div><h2 class="text-lg font-bold text-gray-800">'+k.title+'</h2><p class="text-sm text-gray-500">'+k.desc+'</p><p class="text-xs text-gray-400 mt-1">'+k.instructor+' Â· '+k.duration+' Â· '+k.level+'</p></div></div>';
    if(!k.enrolled) h += '<button onclick="enrollKurs(\''+k.id+'\')" class="px-5 py-2.5 bg-vit-orange text-white font-bold text-sm rounded-lg hover:opacity-90">â–¶ Kurs starten</button>';
    h += '</div>';
    
    // Chapters
    k.chapters.forEach(function(ch,ci){
        var chDone = ch.lessons.filter(function(l){return l.done;}).length;
        var chTotal = ch.lessons.length;
        var chPct = chTotal>0?Math.round(chDone/chTotal*100):0;
        h += '<div class="vit-card p-0 mb-3 overflow-hidden">';
        h += '<div class="p-4 cursor-pointer flex items-center justify-between" onclick="var b=this.nextElementSibling;b.style.display=b.style.display===\'none\'?\'block\':\'none\'" style="background:'+(chPct===100?'#f0fdf4':'#f9fafb')+'">';
        h += '<div class="flex items-center gap-3"><span style="width:28px;height:28px;border-radius:50%;background:'+(chPct===100?'#16a34a':'#EF7D00')+';color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">'+(chPct===100?'âœ“':(ci+1))+'</span><div><p class="text-sm font-bold text-gray-800">'+ch.title+'</p><p class="text-[10px] text-gray-400">'+chDone+'/'+chTotal+' Lektionen</p></div></div>';
        h += '<span class="text-xs text-gray-400">â–¼</span></div>';
        h += '<div style="display:'+(ci===0?'block':'none')+'">';
        ch.lessons.forEach(function(l){
            var icons = {video:'â–¶ï¸',text:'ðŸ“„',exercise:'âœï¸',download:'ðŸ“¥',quiz:'â“',ai:'ðŸ¤–'};
            var ic = icons[l.type]||'ðŸ“„';
            h += '<div class="flex items-center gap-3 p-3 border-t border-gray-100 hover:bg-gray-50 transition cursor-pointer">';
            h += '<span style="width:22px;height:22px;border-radius:50%;border:2px solid '+(l.done?'#16a34a':'#d1d5db')+';display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0">'+(l.done?'<span style="color:#16a34a">âœ“</span>':'')+'</span>';
            h += '<span style="font-size:14px">'+ic+'</span>';
            h += '<div class="flex-1"><p class="text-xs font-semibold text-gray-700">'+l.title+'</p></div>';
            h += '<span class="text-[10px] text-gray-400">'+l.duration+'</span>';
            h += '</div>';
        });
        h += '</div></div>';
    });

    // KI-Aufbereitung Button
    h += '<div class="vit-card p-4 mt-4 text-center" style="border:2px dashed var(--c-border)"><p class="text-xs text-gray-400 mb-2">Inhalte erweitern?</p><button onclick="requestKiContent(\''+k.id+'\')" class="px-4 py-2 bg-purple-500 text-white text-xs font-bold rounded-lg hover:bg-purple-600">ðŸ¤– KI-Aufbereitung: Kurs erweitern</button><p class="text-[10px] text-gray-300 mt-1">KI erstellt zusÃ¤tzliche Lektionen, Quizze und Zusammenfassungen</p></div>';
    
    el.innerHTML = h;
};

window.enrollKurs = function(id) {
    var k = KURSE.find(function(x){return x.id===id;});
    if(k) { k.enrolled=true; k.progress=0; showKursDetail(id); }
};

window.requestKiContent = function(kursId) {
    alert('ðŸ¤– KI-Aufbereitung gestartet!\n\nIn Produktion: Die Anthropic API generiert automatisch:\nâ€¢ Zusammenfassungen pro Kapitel\nâ€¢ Quiz-Fragen zur WissensÃ¼berprÃ¼fung\nâ€¢ Praxis-Aufgaben aus euren echten Daten\nâ€¢ Handouts als PDF\n\nDies wird Ã¼ber die Claude API (Sonnet) realisiert.');
};

// â•â•â• RENDER: Onboarding â•â•â•
window.renderOnboarding = function() {
    var el = document.getElementById('wissenGlobalContent');
    if(!el) return;
    var totalSteps=0,doneSteps=0;
    ONBOARDING.forEach(function(p){p.steps.forEach(function(s){totalSteps++;if(s.done)doneSteps++;});});
    var pct = Math.round(doneSteps/totalSteps*100);
    
    var h = '<div class="vit-card p-5 mb-4" style="border-left:4px solid #EF7D00"><div class="flex items-center justify-between mb-3"><div><h2 class="text-base font-bold text-gray-800">ðŸš€ Dein Onboarding-Fortschritt</h2><p class="text-xs text-gray-500">'+doneSteps+' von '+totalSteps+' Schritten abgeschlossen</p></div><span class="text-2xl font-black" style="color:'+(pct===100?'#16a34a':'#EF7D00')+'">'+pct+'%</span></div>';
    h += '<div class="bg-gray-200 rounded-full h-3 mb-1"><div class="h-3 rounded-full transition-all" style="width:'+pct+'%;background:linear-gradient(90deg,#EF7D00,#F59E0B)"></div></div></div>';
    
    ONBOARDING.forEach(function(phase){
        var pDone = phase.steps.filter(function(s){return s.done;}).length;
        var pTotal = phase.steps.length;
        h += '<div class="vit-card p-4 mb-3"><div class="flex items-center gap-3 mb-3"><span style="font-size:24px">'+phase.icon+'</span><div><p class="text-sm font-bold text-gray-800">'+phase.phase+'</p><p class="text-xs text-gray-500">'+phase.title+' Â· '+pDone+'/'+pTotal+'</p></div></div>';
        phase.steps.forEach(function(s,i){
            h += '<div class="flex items-center gap-3 p-2.5 rounded-lg mb-1 '+(s.done?'bg-green-50':'hover:bg-gray-50')+' cursor-pointer" onclick="toggleOnboardingStep(\''+phase.phase+'\','+i+')">';
            h += '<span style="width:22px;height:22px;border-radius:50%;border:2px solid '+(s.done?'#16a34a':'#d1d5db')+';display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0">'+(s.done?'<span style="color:#16a34a">âœ“</span>':'')+'</span>';
            h += '<div class="flex-1"><p class="text-xs font-semibold '+(s.done?'text-green-700 line-through':'text-gray-700')+'">'+s.title+'</p><p class="text-[10px] text-gray-400">'+s.action+'</p></div></div>';
        });
        h += '</div>';
    });
    el.innerHTML = h;
};

window.toggleOnboardingStep = function(phase,idx) {
    var p = ONBOARDING.find(function(o){return o.phase===phase;});
    if(p && p.steps[idx]) { p.steps[idx].done = !p.steps[idx].done; renderOnboarding(); }
};



// â•â•â• HOOK: extend switchWissenTyp â•â•â•
var _origSwitch = window.switchWissenTyp;
window.switchWissenTyp = function(typ) {
    if(typeof currentWissenTyp !== 'undefined') currentWissenTyp = typ;
    // Update tab buttons
    document.querySelectorAll('.wissen-typ-btn').forEach(function(b){
        var isActive = b.getAttribute('data-wtt') === typ;
        b.className = 'wissen-typ-btn whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm ' + (isActive ? 'border-vit-orange text-vit-orange' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
    });
    // Render new types
    if(typ === 'portal') { renderPortalGuide(); return; }
    if(typ === 'kurse') { renderKurse(); return; }
    if(typ === 'onboarding') { renderOnboarding(); return; }

    // Fallback to original for akademie/handbuecher/bestpractices/faq
    if(_origSwitch) _origSwitch(typ);
    else if(typeof renderWissenGlobal === 'function') renderWissenGlobal();
};

})();
</script>

<!-- â•â•â• BILLING MODULE â•â•â• -->
<script>
(function(){
    const BILLING_FN = 'https://lwwagbkxeofahhwebkab.supabase.co/functions/v1/billing';
    
    // â”€â”€ Helpers â”€â”€
    function fmtEur(n) { return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(n || 0); }
    function fmtDate(d) { if (!d) return 'â€“'; return new Date(d).toLocaleDateString('de-DE'); }
    function statusBadge(s) {
        const map = {
            draft: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">Draft</span>',
            ready: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Bereit</span>',
            finalized: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-700">Finalisiert</span>',
            sent: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">Versendet</span>',
            paid: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">Bezahlt</span>',
            failed: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">Fehlgeschl.</span>',
            void: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">Storniert</span>',
            credited: '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-teal-100 text-teal-700">Gutschrift</span>',
        };
        return map[s] || '<span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">'+s+'</span>';
    }
    async function billingCall(action, params) {
        const res = await fetch(BILLING_FN, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, ...params })
        });
        return res.json();
    }

    // â”€â”€ Month Selector â”€â”€
    function initBillingMonthSelect() {
        var sel = document.getElementById('billingMonthSelect');
        if (!sel || sel.options.length > 0) return;
        var now = new Date();
        for (var i = -2; i <= 3; i++) {
            var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            var val = d.toISOString().substring(0, 10);
            var label = d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            var opt = new Option(label, val);
            if (i === 0) opt.selected = true;
            sel.appendChild(opt);
        }
    }

    // â”€â”€ Tab Switching â”€â”€
    window.showBillingTab = function(tab) {
        document.querySelectorAll('.billing-tab').forEach(function(b) {
            b.classList.remove('border-vit-orange', 'text-vit-orange', 'font-semibold');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        document.querySelectorAll('.billing-tab-content').forEach(function(c) { c.style.display = 'none'; });
        var btn = document.querySelector('.billing-tab[data-tab="'+tab+'"]');
        if (btn) { btn.classList.add('border-vit-orange', 'text-vit-orange', 'font-semibold'); btn.classList.remove('border-transparent', 'text-gray-500'); }
        var el = document.getElementById('billingTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
        if (el) el.style.display = 'block';
        if (tab === 'overview') loadBillingOverview();
        if (tab === 'invoices') loadAllInvoices();
        if (tab === 'strategies') loadStrategies();
        if (tab === 'products') loadProducts();
        if (tab === 'tools') loadToolPackages();
    };

    window.showStBillingTab = function(tab) {
        document.querySelectorAll('.st-billing-tab').forEach(function(b) {
            b.classList.remove('border-vit-orange', 'text-vit-orange', 'font-semibold');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        document.querySelectorAll('.st-billing-tab-content').forEach(function(c) { c.style.display = 'none'; });
        var btn = document.querySelector('.st-billing-tab[data-tab="'+tab+'"]');
        if (btn) { btn.classList.add('border-vit-orange', 'text-vit-orange', 'font-semibold'); btn.classList.remove('border-transparent', 'text-gray-500'); }
        var el = document.getElementById('stBillingTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
        if (el) el.style.display = 'block';
        if (tab === 'invoices') loadStandortInvoices();
        if (tab === 'payments') loadStandortPayments();
        if (tab === 'strategy') loadStandortStrategy();
        if (tab === 'costs') loadStandortCosts();
    };

    // â”€â”€ HQ: Load Billing Overview â”€â”€
    window.loadBillingOverview = async function() {
        initBillingMonthSelect();
        var month = document.getElementById('billingMonthSelect')?.value;
        if (!month) return;

        var data = await billingCall('billing-overview', { month: month });
        if (data.error) { console.error('Billing overview error:', data.error); return; }

        var standorte = data.standorte || [];
        var drafts = standorte.filter(function(s) { return s.invoice && s.invoice.status === 'draft'; }).length;
        var finalized = standorte.filter(function(s) { return s.invoice && s.invoice.status === 'finalized'; }).length;
        var paid = standorte.filter(function(s) { return s.invoice && s.invoice.status === 'paid'; }).length;
        var totalRevenue = standorte.reduce(function(sum, s) { return sum + (s.invoice ? s.invoice.total : 0); }, 0);

        var kpiEl = document.getElementById('billingKpis');
        if (kpiEl) kpiEl.innerHTML = 
            '<div class="vit-card p-4"><p class="text-xs text-gray-400 uppercase">Standorte</p><p class="text-2xl font-bold">'+standorte.length+'</p></div>'
            +'<div class="vit-card p-4"><p class="text-xs text-gray-400 uppercase">Drafts</p><p class="text-2xl font-bold text-yellow-600">'+drafts+'</p></div>'
            +'<div class="vit-card p-4"><p class="text-xs text-gray-400 uppercase">Bezahlt</p><p class="text-2xl font-bold text-green-600">'+paid+'</p></div>'
            +'<div class="vit-card p-4"><p class="text-xs text-gray-400 uppercase">Volumen</p><p class="text-2xl font-bold text-vit-orange">'+fmtEur(totalRevenue)+'</p></div>';

        var tbody = document.getElementById('billingOverviewTable');
        if (!tbody) return;
        var h = '';
        standorte.forEach(function(s) {
            var stratBadge = !s.strategy ? '<span class="text-xs text-red-500">âŒ Fehlt</span>' : s.strategy.locked ? '<span class="text-xs text-green-600">ðŸ”’ Locked</span>' : s.strategy.approved_at ? '<span class="text-xs text-blue-500">âœ“ Approved</span>' : '<span class="text-xs text-yellow-500">â³ Offen</span>';
            var sepaBadge = s.billing_account?.sepa_active ? '<span class="text-xs text-green-600">âœ…</span>' : '<span class="text-xs text-gray-400">â€“</span>';
            var invTotal = s.invoice ? fmtEur(s.invoice.total) : '<span class="text-xs text-gray-400">â€“</span>';
            var invStatus = s.invoice ? statusBadge(s.invoice.status) : '<span class="text-xs text-gray-400">Kein Draft</span>';
            var action = '';
            if (s.invoice && s.invoice.status === 'draft') {
                action = '<button onclick="openBillingDetail(\''+s.invoice.id+'\')" class="text-xs px-2 py-1 bg-vit-orange text-white rounded hover:bg-orange-600">Bearbeiten</button>';
            } else if (!s.invoice && s.strategy?.locked) {
                action = '<span class="text-xs text-gray-400">Warte auf Draft</span>';
            }
            h += '<tr class="border-b hover:bg-gray-50">'
                +'<td class="p-3"><p class="font-semibold text-sm">'+s.name+'</p><p class="text-xs text-gray-400">'+(s.inhaber_name||'')+'</p></td>'
                +'<td class="p-3 text-center">'+stratBadge+'</td>'
                +'<td class="p-3 text-center">'+sepaBadge+'</td>'
                +'<td class="p-3 text-right font-mono text-sm">'+invTotal+'</td>'
                +'<td class="p-3 text-center">'+invStatus+'</td>'
                +'<td class="p-3 text-center">'+action+'</td>'
                +'</tr>';
        });
        tbody.innerHTML = h || '<tr><td colspan="6" class="p-8 text-center text-gray-400">Keine aktiven Standorte</td></tr>';
    };

    // â”€â”€ HQ: Generate Monthly Drafts â”€â”€
    window.generateMonthlyDrafts = async function() {
        var month = document.getElementById('billingMonthSelect')?.value;
        if (!confirm('Monats-Drafts fÃ¼r ' + month + ' generieren?')) return;
        var btn = event.target; btn.disabled = true; btn.textContent = 'â³ Wird generiert...';
        var data = await billingCall('generate-monthly-drafts', { month: month });
        btn.disabled = false; btn.textContent = t('bill_generate_drafts');
        if (data.error) { alert('Fehler: ' + data.error); return; }
        alert('âœ… ' + data.created + ' Drafts erstellt, ' + data.skipped + ' Ã¼bersprungen');
        loadBillingOverview();
    };

    // â”€â”€ HQ: Quarterly Settlement Dialog â”€â”€
    window.showQuarterlySettlementDialog = function() {
        var year = new Date().getFullYear();
        var quarter = Math.ceil((new Date().getMonth() + 1) / 3);
        var q = prompt('Quartal eingeben (z.B. ' + quarter + ' fÃ¼r Q' + quarter + '/' + year + '):', quarter);
        if (!q) return;
        var y = prompt('Jahr:', year);
        if (!y) return;
        generateSettlement(parseInt(y), parseInt(q));
    };
    async function generateSettlement(year, quarter) {
        var data = await billingCall('generate-quarterly-settlement', { year: year, quarter: quarter });
        if (data.error) { alert('Fehler: ' + data.error); return; }
        alert('âœ… ' + data.created + ' Settlements erstellt');
        loadBillingOverview();
    }

    // â”€â”€ HQ: Finalize all drafts â”€â”€
    window.finalizeAllReady = async function() {
        if (!confirm('Alle Drafts des aktuellen Monats finalisieren?')) return;
        var month = document.getElementById('billingMonthSelect')?.value;
        var { data: invoices } = await sb.from('billing_invoices')
            .select('id').eq('status', 'draft').eq('period_start', month);
        if (!invoices?.length) { alert('Keine Drafts zum Finalisieren'); return; }
        var count = 0;
        for (var inv of invoices) {
            await billingCall('finalize-invoice', { invoice_id: inv.id, user_id: sbUser.id });
            count++;
        }
        alert('âœ… ' + count + ' Rechnungen finalisiert');
        loadBillingOverview();
    };

    // â”€â”€ HQ: Invoice Detail â”€â”€
    window.openBillingDetail = async function(invoiceId) {
        showView('hqBillingDetail');
        var { data: inv } = await sb.from('billing_invoices')
            .select('*, standort:standorte(name)').eq('id', invoiceId).single();
        if (!inv) return;
        var { data: lines } = await sb.from('billing_invoice_line_items')
            .select('*, product:billing_products(key, name)').eq('invoice_id', invoiceId).order('sort_index');
        var { data: audits } = await sb.from('billing_audit_log')
            .select('*, user:users(name)').eq('invoice_id', invoiceId).order('created_at', { ascending: false });

        document.getElementById('billingDetailTitle').textContent = (inv.invoice_number || 'Rechnung') + ' â€“ ' + (inv.standort?.name || '');
        document.getElementById('billingDetailSubtitle').textContent = fmtDate(inv.period_start) + ' â€“ ' + fmtDate(inv.period_end) + ' Â· ' + statusBadge(inv.status);
        document.getElementById('billingDetailSubtitle').innerHTML = fmtDate(inv.period_start) + ' â€“ ' + fmtDate(inv.period_end) + ' Â· ' + statusBadge(inv.status);

        // Action buttons
        var actionsHtml = '';
        if (inv.status === 'draft') {
            actionsHtml += '<button onclick="finalizeInvoice(\''+inv.id+'\')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">âœ… Finalisieren</button>';
        }
        if (inv.status === 'finalized') {
            actionsHtml += '<button onclick="markInvoicePaid(\''+inv.id+'\')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700">ðŸ’° Als bezahlt markieren</button>';
        }
        if (inv.stripe_invoice_pdf) {
            actionsHtml += '<a href="'+inv.stripe_invoice_pdf+'" target="_blank" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-semibold hover:bg-gray-700">ðŸ“¥ PDF</a>';
        }
        document.getElementById('billingDetailActions').innerHTML = actionsHtml;

        // Content
        var h = '';

        // Snapshot / Transparency
        if (inv.calculated_snapshot?.formulas) {
            h += '<div class="vit-card p-4 mb-4 bg-blue-50 border-l-4 border-blue-400">';
            h += '<h4 class="font-semibold text-blue-800 mb-2">ðŸ“ Berechnungsgrundlage</h4>';
            h += '<ul class="text-sm text-blue-700 space-y-1">';
            inv.calculated_snapshot.formulas.forEach(function(f) { h += '<li>â€¢ ' + f + '</li>'; });
            h += '</ul></div>';
        }

        // Line Items Table
        h += '<div class="vit-card overflow-hidden mb-4">';
        h += '<div class="p-4 border-b bg-gray-50 flex justify-between items-center">';
        h += '<h4 class="font-semibold text-gray-800">Positionen</h4>';
        if (inv.status === 'draft') {
            h += '<button onclick="addManualLine(\''+inv.id+'\')" class="text-xs px-3 py-1 bg-vit-orange text-white rounded hover:bg-orange-600">+ Position</button>';
        }
        h += '</div><table class="w-full text-sm">';
        h += '<thead class="bg-gray-50 text-gray-500 text-xs uppercase"><tr><th class="text-left p-3">#</th><th class="text-left p-3">Beschreibung</th><th class="text-right p-3">Betrag</th>';
        if (inv.status === 'draft') h += '<th class="text-center p-3">Aktion</th>';
        h += '</tr></thead><tbody>';
        (lines || []).forEach(function(li, idx) {
            h += '<tr class="border-b">';
            h += '<td class="p-3 text-gray-400">' + (idx+1) + '</td>';
            h += '<td class="p-3">' + li.description;
            if (li.meta?.formula) h += '<br><span class="text-xs text-gray-400">' + li.meta.formula + '</span>';
            h += '</td>';
            h += '<td class="p-3 text-right font-mono">' + fmtEur(li.amount) + '</td>';
            if (inv.status === 'draft') {
                h += '<td class="p-3 text-center">';
                if (li.editable) {
                    h += '<button onclick="editLineItem(\''+li.id+'\', '+li.amount+', \''+li.description.replace(/'/g,"\\'")+'\')" class="text-xs text-blue-600 hover:underline mr-2">âœï¸</button>';
                    h += '<button onclick="removeLineItem(\''+li.id+'\', \''+inv.id+'\')" class="text-xs text-red-500 hover:underline">ðŸ—‘ï¸</button>';
                }
                h += '</td>';
            }
            h += '</tr>';
        });
        h += '</tbody>';
        h += '<tfoot class="bg-gray-50 font-semibold">';
        h += '<tr><td class="p-3" colspan="' + (inv.status === 'draft' ? 2 : 2) + '">Netto</td><td class="p-3 text-right font-mono">' + fmtEur(inv.subtotal) + '</td>'+(inv.status==='draft'?'<td></td>':'')+'</tr>';
        h += '<tr><td class="p-3" colspan="' + (inv.status === 'draft' ? 2 : 2) + '">MwSt. ('+inv.tax_rate+'%)</td><td class="p-3 text-right font-mono">' + fmtEur(inv.tax_amount) + '</td>'+(inv.status==='draft'?'<td></td>':'')+'</tr>';
        h += '<tr class="text-lg"><td class="p-3" colspan="' + (inv.status === 'draft' ? 2 : 2) + '">Gesamt</td><td class="p-3 text-right font-mono text-vit-orange">' + fmtEur(inv.total) + '</td>'+(inv.status==='draft'?'<td></td>':'')+'</tr>';
        h += '</tfoot></table></div>';

        // Audit Log
        if (audits?.length) {
            h += '<div class="vit-card p-4"><h4 class="font-semibold text-gray-800 mb-3">ðŸ“‹ Ã„nderungsprotokoll</h4>';
            h += '<div class="space-y-2">';
            audits.forEach(function(a) {
                h += '<div class="flex items-start text-xs text-gray-500"><span class="mr-2">' + fmtDate(a.created_at) + '</span>';
                h += '<span class="font-semibold mr-1">' + (a.user?.name || 'System') + '</span>';
                h += '<span>' + a.action + (a.note ? ': ' + a.note : '') + '</span></div>';
            });
            h += '</div></div>';
        }

        document.getElementById('billingDetailContent').innerHTML = h;
    };

    // â”€â”€ HQ: Line Item Actions â”€â”€
    window.editLineItem = async function(lineId, currentAmount, currentDesc) {
        var newAmt = prompt('Neuer Betrag:', currentAmount);
        if (newAmt === null) return;
        await billingCall('update-line-item', { line_item_id: lineId, amount: parseFloat(newAmt), user_id: sbUser.id });
        // Reload the current invoice detail
        var invId = document.querySelector('[onclick*="finalizeInvoice"]')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
        if (invId) openBillingDetail(invId);
    };

    window.removeLineItem = async function(lineId, invoiceId) {
        if (!confirm(t('bill_remove_line'))) return;
        await billingCall('remove-line-item', { line_item_id: lineId, user_id: sbUser.id });
        openBillingDetail(invoiceId);
    };

    window.addManualLine = async function(invoiceId) {
        var desc = prompt(t('bill_new_desc'));
        if (!desc) return;
        var amt = prompt('Betrag (â‚¬):', '0');
        if (amt === null) return;
        await billingCall('add-line-item', { invoice_id: invoiceId, description: desc, amount: parseFloat(amt), user_id: sbUser.id });
        openBillingDetail(invoiceId);
    };

    window.finalizeInvoice = async function(invoiceId) {
        if (!confirm(t('bill_finalize'))) return;
        var data = await billingCall('finalize-invoice', { invoice_id: invoiceId, user_id: sbUser.id });
        if (data.error) { alert('Fehler: ' + data.error); return; }
        alert('âœ… Rechnung finalisiert' + (data.message ? '\n' + data.message : ''));
        openBillingDetail(invoiceId);
    };

    window.markInvoicePaid = async function(invoiceId) {
        if (!confirm(t('bill_mark_paid'))) return;
        await billingCall('mark-paid', { invoice_id: invoiceId, user_id: sbUser.id });
        openBillingDetail(invoiceId);
    };

    // â”€â”€ HQ: Load All Invoices â”€â”€
    window.loadAllInvoices = async function() {
        var filter = document.getElementById('billingInvoiceFilter')?.value;
        var query = sb.from('billing_invoices')
            .select('*, standort:standorte(name)').order('created_at', { ascending: false }).limit(50);
        if (filter) query = query.eq('status', filter);
        var { data: invoices } = await query;

        var el = document.getElementById('billingInvoicesList');
        if (!el) return;
        if (!invoices?.length) { el.innerHTML = '<p class="text-center text-gray-400 py-8">Keine Rechnungen</p>'; return; }

        var h = '';
        invoices.forEach(function(inv) {
            h += '<div class="vit-card p-4 flex items-center justify-between cursor-pointer hover:shadow-md" onclick="openBillingDetail(\''+inv.id+'\')">';
            h += '<div><p class="font-semibold text-sm">' + (inv.invoice_number || 'â€“') + '</p>';
            h += '<p class="text-xs text-gray-500">' + (inv.standort?.name || '') + ' Â· ' + fmtDate(inv.period_start) + '</p></div>';
            h += '<div class="text-right">';
            h += '<p class="font-mono font-semibold">' + fmtEur(inv.total) + '</p>';
            h += statusBadge(inv.status);
            h += '</div></div>';
        });
        el.innerHTML = h;
    };

    // â”€â”€ HQ: Load Strategies â”€â”€
    window.loadStrategies = async function() {
        var { data: strategies } = await sb.from('billing_annual_strategy')
            .select('*, standort:standorte(name)').order('year', { ascending: false });
        var el = document.getElementById('billingStrategiesList');
        if (!el) return;
        if (!strategies?.length) {
            el.innerHTML = '<p class="text-center text-gray-400 py-8">Keine Jahresstrategien vorhanden</p>';
            return;
        }
        var h = '';
        strategies.forEach(function(s) {
            var lockBadge = s.locked ? 'ðŸ”’ Locked' : s.approved_at ? 'âœ“ Approved' : 'â³ Offen';
            var lockClass = s.locked ? 'text-green-600' : s.approved_at ? 'text-blue-500' : 'text-yellow-500';
            h += '<div class="vit-card p-4 flex items-center justify-between">';
            h += '<div><p class="font-semibold text-sm">' + (s.standort?.name || '') + ' â€“ ' + s.year + ' (v' + s.version + ')</p>';
            h += '<p class="text-xs text-gray-500">Plan-Umsatz: ' + fmtEur(s.planned_revenue_year) + ' Â· Marketing: ' + fmtEur(s.planned_marketing_year) + '</p></div>';
            h += '<div class="flex items-center space-x-3">';
            h += '<span class="text-xs font-semibold ' + lockClass + '">' + lockBadge + '</span>';
            if (!s.approved_at) h += '<button onclick="approveStrategy(\''+s.id+'\')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Approve</button>';
            if (s.approved_at && !s.locked) h += '<button onclick="lockStrategy(\''+s.id+'\')" class="text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700">Lock</button>';
            h += '</div></div>';
        });
        el.innerHTML = h;
    };

    window.approveStrategy = async function(id) {
        await billingCall('approve-strategy', { strategy_id: id, user_id: sbUser.id });
        loadStrategies();
    };
    window.lockStrategy = async function(id) {
        if (!confirm(t('bill_strategy_lock'))) return;
        await billingCall('lock-strategy', { strategy_id: id, user_id: sbUser.id });
        loadStrategies();
    };

    // â”€â”€ HQ: Products â”€â”€
    window.loadProducts = async function() {
        var { data: products } = await sb.from('billing_products').select('*').order('key');
        var el = document.getElementById('billingProductsList');
        if (!el) return;
        var h = '<div class="vit-card overflow-hidden"><table class="w-full text-sm">';
        h += '<thead class="bg-gray-50 text-xs text-gray-500 uppercase"><tr><th class="p-3 text-left">Key</th><th class="p-3 text-left">Name</th><th class="p-3 text-left">Typ</th><th class="p-3 text-right">Betrag</th><th class="p-3 text-right">%</th></tr></thead><tbody>';
        (products || []).forEach(function(p) {
            h += '<tr class="border-b"><td class="p-3 font-mono text-xs">'+p.key+'</td><td class="p-3">'+p.name+'</td><td class="p-3 text-xs text-gray-500">'+p.product_type+'</td>';
            h += '<td class="p-3 text-right">'+(p.default_amount ? fmtEur(p.default_amount) : 'â€“')+'</td>';
            h += '<td class="p-3 text-right">'+(p.default_percent ? (p.default_percent*100).toFixed(1)+'%' : 'â€“')+'</td></tr>';
        });
        h += '</tbody></table></div>';
        el.innerHTML = h;
    };

    // â”€â”€ HQ: Tool Packages â”€â”€
    window.loadToolPackages = async function() {
        var { data: tools } = await sb.from('billing_tool_packages').select('*').order('monthly_cost');
        var el = document.getElementById('billingToolsList');
        if (!el) return;
        var h = '<div class="vit-card overflow-hidden"><table class="w-full text-sm">';
        h += '<thead class="bg-gray-50 text-xs text-gray-500 uppercase"><tr><th class="p-3 text-left">Paket</th><th class="p-3 text-left">Beschreibung</th><th class="p-3 text-right">Preis/Monat</th><th class="p-3 text-center">Status</th></tr></thead><tbody>';
        (tools || []).forEach(function(t) {
            h += '<tr class="border-b"><td class="p-3 font-semibold">'+t.name+'</td><td class="p-3 text-sm text-gray-500">'+(t.description||'')+'</td>';
            h += '<td class="p-3 text-right font-mono">'+fmtEur(t.monthly_cost)+'</td>';
            h += '<td class="p-3 text-center">'+(t.active?'<span class="text-green-600">âœ…</span>':'<span class="text-gray-400">â€“</span>')+'</td></tr>';
        });
        h += '</tbody></table></div>';
        el.innerHTML = h;
    };

    // â”€â”€ PDF Download via Proxy â”€â”€
    window.downloadLexofficePdf = async function(invoiceId, invoiceNumber) {
        try {
            var session = (await sb.auth.getSession()).data.session;
            if (!session) { alert('Bitte erneut einloggen.'); return; }
            var btn = event.target;
            btn.textContent = 'â³ Lade...';
            btn.disabled = true;
            
            var resp = await fetch(SUPABASE_URL + '/functions/v1/lexoffice-pdf?invoice_id=' + invoiceId, {
                headers: {
                    'Authorization': 'Bearer ' + session.access_token,
                    'apikey': SUPABASE_ANON
                }
            });
            
            if (!resp.ok) {
                var errData = await resp.json().catch(function(){ return {error:'Download fehlgeschlagen'}; });
                throw new Error(errData.error || 'HTTP ' + resp.status);
            }
            
            var blob = await resp.blob();
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = (invoiceNumber || 'Rechnung') + '.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            btn.textContent = 'âœ… Heruntergeladen';
            setTimeout(function(){ btn.textContent = 'ðŸ“¥ PDF herunterladen'; btn.disabled = false; }, 2000);
        } catch(err) {
            alert('PDF Download fehlgeschlagen: ' + err.message);
            if(event.target) { event.target.textContent = 'ðŸ“¥ PDF herunterladen'; event.target.disabled = false; }
        }
    };

    // â”€â”€ Standort: Load My Invoices â”€â”€
    window.loadStandortInvoices = async function() {
        var stId = sbProfile.standort_id;
        if (!stId) return;
        var { data: invoices } = await sb.from('billing_invoices')
            .select('*').eq('standort_id', stId).order('period_start', { ascending: false });
        var el = document.getElementById('stBillingInvoicesList');
        if (!el) return;
        if (!invoices?.length) { el.innerHTML = '<p class="text-center text-gray-400 py-8">Noch keine Rechnungen</p>'; return; }
        var h = '';
        invoices.forEach(function(inv) {
            h += '<div class="vit-card p-4">';
            h += '<div class="flex items-center justify-between mb-2">';
            h += '<div><p class="font-semibold">' + (inv.invoice_number || 'Rechnung') + '</p>';
            h += '<p class="text-xs text-gray-500">' + fmtDate(inv.period_start) + ' â€“ ' + fmtDate(inv.period_end) + '</p></div>';
            h += '<div class="text-right"><p class="font-mono text-lg font-bold">' + fmtEur(inv.total) + '</p>' + statusBadge(inv.status) + '</div></div>';
            // Transparency
            if (inv.calculated_snapshot?.formulas) {
                h += '<details class="mt-2"><summary class="text-xs text-blue-600 cursor-pointer hover:underline">ðŸ“ Berechnung anzeigen</summary>';
                h += '<ul class="mt-1 text-xs text-gray-600 space-y-1">';
                inv.calculated_snapshot.formulas.forEach(function(f) { h += '<li>â€¢ ' + f + '</li>'; });
                h += '</ul></details>';
            }
            // PDF Download
            if (inv.stripe_invoice_pdf || inv.lexoffice_invoice_id) {
                h += '<div class="mt-2 flex space-x-2">';
                if (inv.stripe_invoice_pdf) h += '<a href="'+inv.stripe_invoice_pdf+'" target="_blank" class="text-xs px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">ðŸ“¥ PDF (Stripe)</a>';
                if (inv.lexoffice_invoice_id) h += '<button onclick="downloadLexofficePdf(\x27'+inv.id+'\x27,\x27'+(inv.invoice_number||'Rechnung')+'\x27)" class="text-xs px-3 py-1 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 font-semibold">ðŸ“¥ PDF herunterladen</button>';
                h += '</div>';
            }
            h += '</div>';
        });
        el.innerHTML = h;
    };

    // â”€â”€ Standort: Strategy â”€â”€
    window.loadStandortStrategy = async function() {
        var stId = sbProfile.standort_id;
        if (!stId) return;
        var year = new Date().getFullYear();
        var { data: strategies } = await sb.from('billing_annual_strategy')
            .select('*').eq('standort_id', stId).eq('year', year).order('version', { ascending: false });
        var el = document.getElementById('stBillingStrategyContent');
        if (!el) return;
        var s = strategies?.[0];
        var h = '';
        if (s) {
            var lockBadge = s.locked ? 'ðŸ”’ Gesperrt (verbindlich)' : s.approved_at ? 'âœ… Genehmigt von HQ' : 'â³ Warte auf HQ-Genehmigung';
            h += '<div class="vit-card p-6">';
            h += '<div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">Jahresstrategie ' + year + '</h3><span class="text-sm font-semibold">' + lockBadge + '</span></div>';
            h += '<div class="grid grid-cols-2 gap-4">';
            h += '<div class="p-4 bg-orange-50 rounded-lg"><p class="text-xs text-gray-400">Plan-Umsatz</p><p class="text-xl font-bold text-vit-orange">' + fmtEur(s.planned_revenue_year) + '</p><p class="text-xs text-gray-500">' + fmtEur(s.planned_revenue_year/12) + ' / Monat</p></div>';
            h += '<div class="p-4 bg-blue-50 rounded-lg"><p class="text-xs text-gray-400">Marketing-Budget</p><p class="text-xl font-bold text-blue-600">' + fmtEur(s.planned_marketing_year) + '</p><p class="text-xs text-gray-500">' + fmtEur(s.planned_marketing_year/12) + ' / Monat</p></div>';
            h += '</div></div>';
        }
        if (!s || !s.locked) {
            h += '<div class="vit-card p-6 mt-4">';
            h += '<h3 class="font-semibold mb-3">' + (s ? 'Neue Version einreichen' : 'Jahresstrategie einreichen') + '</h3>';
            h += '<div class="grid grid-cols-2 gap-4 mb-4">';
            h += '<div><label class="block text-xs text-gray-500 mb-1">Plan-Umsatz (Jahr)</label><input type="number" id="stStratRevenue" class="w-full border rounded-lg p-2" value="' + (s?.planned_revenue_year || '') + '"></div>';
            h += '<div><label class="block text-xs text-gray-500 mb-1">Marketing-Budget (Jahr)</label><input type="number" id="stStratMarketing" class="w-full border rounded-lg p-2" value="' + (s?.planned_marketing_year || '') + '"></div>';
            h += '</div>';
            h += '<button onclick="submitStrategy()" class="px-4 py-2 bg-vit-orange text-white rounded-lg text-sm font-semibold hover:bg-orange-600">ðŸŽ¯ Strategie einreichen</button>';
            h += '</div>';
        }
        el.innerHTML = h;
    };

    window.submitStrategy = async function() {
        var stId = sbProfile.standort_id;
        var rev = parseFloat(document.getElementById('stStratRevenue')?.value);
        var mkt = parseFloat(document.getElementById('stStratMarketing')?.value);
        if (!rev || isNaN(rev)) { alert(t('misc_enter_revenue')); return; }
        // Get current max version
        var { data: existing } = await sb.from('billing_annual_strategy')
            .select('version').eq('standort_id', stId).eq('year', new Date().getFullYear())
            .order('version', { ascending: false }).limit(1);
        var newVersion = (existing?.[0]?.version || 0) + 1;
        await sb.from('billing_annual_strategy').insert({
            standort_id: stId, year: new Date().getFullYear(),
            planned_revenue_year: rev, planned_marketing_year: mkt || 0,
            submitted_at: new Date().toISOString(), submitted_by: sbUser.id,
            version: newVersion
        });
        alert('âœ… Jahresstrategie eingereicht (v' + newVersion + ')');
        loadStandortStrategy();
    };

    // â”€â”€ Standort: Cost Breakdown â”€â”€
    window.loadStandortCosts = async function() {
        var stId = sbProfile.standort_id;
        if (!stId) return;
        var el = document.getElementById('stBillingCostsContent');
        if (!el) return;
        // Load strategy + tools
        var year = new Date().getFullYear();
        var { data: strats } = await sb.from('billing_annual_strategy')
            .select('*').eq('standort_id', stId).eq('year', year).eq('locked', true).order('version', { ascending: false }).limit(1);
        var { data: tools } = await sb.from('billing_user_tool_assignments')
            .select('*, tool:billing_tool_packages(name, monthly_cost), user:users(name)')
            .eq('standort_id', stId).eq('is_active', true);
        var s = strats?.[0];
        var h = '';
        if (s) {
            var planMonth = s.planned_revenue_year / 12;
            var revShare = 0.02 * planMonth;
            var advance = 0.80 * revShare;
            var mktMonth = s.planned_marketing_year / 12;
            var toolTotal = (tools||[]).reduce(function(sum, t) { return sum + (t.cost_override || t.tool?.monthly_cost || 0); }, 0);
            h += '<div class="vit-card p-6">';
            h += '<h3 class="font-bold text-lg mb-4">Monatliche KostenaufschlÃ¼sselung</h3>';
            h += '<table class="w-full text-sm"><tbody>';
            h += '<tr class="border-b"><td class="py-2">GrundgebÃ¼hr</td><td class="py-2 text-right font-mono">'+fmtEur(800)+'</td></tr>';
            h += '<tr class="border-b"><td class="py-2">Umsatzbeteiligung (80% Ã— 2% Ã— '+fmtEur(planMonth)+')</td><td class="py-2 text-right font-mono">'+fmtEur(advance)+'</td></tr>';
            h += '<tr class="border-b"><td class="py-2">Online-Werbebudget <span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-semibold">Durchlaufposten</span><br><span class="text-[10px] text-gray-400">'+fmtEur(s.planned_marketing_year)+' / 12 â€“ flieÃŸt 100% in Google/Meta Ads</span></td><td class="py-2 text-right font-mono">'+fmtEur(mktMonth)+'</td></tr>';
            h += '<tr class="border-b"><td class="py-2">Toolkosten ('+(tools?.length||0)+' Nutzer)</td><td class="py-2 text-right font-mono">'+fmtEur(toolTotal)+'</td></tr>';
            var nettoSum = 800 + advance + mktMonth + toolTotal;
            h += '<tr class="font-bold text-lg"><td class="pt-3">Netto gesamt</td><td class="pt-3 text-right font-mono text-vit-orange">'+fmtEur(nettoSum)+'</td></tr>';
            h += '<tr><td class="py-1 text-gray-400">zzgl. 19% MwSt.</td><td class="py-1 text-right font-mono text-gray-400">'+fmtEur(nettoSum*0.19)+'</td></tr>';
            h += '<tr class="font-bold text-xl border-t"><td class="pt-2">Brutto</td><td class="pt-2 text-right font-mono text-vit-orange">'+fmtEur(nettoSum*1.19)+'</td></tr>';
            h += '</tbody></table>';
            // Tool breakdown
            if (tools?.length) {
                h += '<h4 class="font-semibold mt-6 mb-2">ðŸ”§ Tool-Zuweisungen</h4><div class="space-y-1">';
                tools.forEach(function(t) {
                    h += '<div class="flex justify-between text-sm"><span>'+((t.user?.name)||'â€“')+' â€“ '+(t.tool?.name||'â€“')+'</span><span class="font-mono">'+fmtEur(t.cost_override||t.tool?.monthly_cost)+'</span></div>';
                });
                h += '</div>';
            }
            h += '</div>';
        } else {
            h = '<div class="text-center py-8 text-gray-400">Keine gesperrte Jahresstrategie vorhanden â€“ Kostenberechnung nicht mÃ¶glich.</div>';
        }
        el.innerHTML = h;
    };

    // â”€â”€ Standort: Payment Status â”€â”€
    window.loadStandortPayments = async function() {
        var stId = sbProfile.standort_id;
        if (!stId) return;
        var container = document.getElementById('stBillingPaymentsContent');
        if (!container) return;
        container.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-vit-orange"></div></div>';

        var { data: invoices } = await sb.from('billing_invoices')
            .select('id, invoice_number, period_start, period_end, total, status, finalized_at, paid_at, created_at')
            .eq('standort_id', stId)
            .order('period_start', { ascending: false });

        var totalPaid = 0, totalOpen = 0, countPaid = 0, countOpen = 0;
        (invoices || []).forEach(function(inv) {
            if (inv.status === 'paid') { totalPaid += parseFloat(inv.total)||0; countPaid++; }
            else if (['finalized','sent'].indexOf(inv.status) >= 0) { totalOpen += parseFloat(inv.total)||0; countOpen++; }
        });

        var h = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">';
        h += '<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Bezahlt</p><p class="text-2xl font-bold text-green-600">' + fmtEur(totalPaid) + '</p><p class="text-xs text-gray-400">' + countPaid + ' Rechnungen</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Offen</p><p class="text-2xl font-bold text-amber-500">' + fmtEur(totalOpen) + '</p><p class="text-xs text-gray-400">' + countOpen + ' Rechnungen</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Gesamt ' + new Date().getFullYear() + '</p><p class="text-2xl font-bold text-gray-800">' + fmtEur(totalPaid + totalOpen) + '</p><p class="text-xs text-gray-400">' + (invoices || []).length + ' Rechnungen</p></div>';
        h += '</div>';

        h += '<div class="vit-card p-6"><h3 class="font-bold text-sm mb-4">ðŸ“‹ Zahlungsverlauf</h3>';
        if (!invoices || invoices.length === 0) {
            h += '<p class="text-gray-400 text-center py-4">Noch keine Zahlungsdaten vorhanden</p>';
        } else {
            h += '<div class="space-y-3">';
            (invoices || []).forEach(function(inv) {
                var sc = inv.status === 'paid' ? 'green' : inv.status === 'finalized' || inv.status === 'sent' ? 'amber' : 'gray';
                var si = inv.status === 'paid' ? 'âœ…' : inv.status === 'finalized' ? 'ðŸ“¬' : inv.status === 'sent' ? 'ðŸ“¨' : inv.status === 'draft' ? 'ðŸ“' : 'â³';
                var st = inv.status === 'paid' ? 'Bezahlt' : inv.status === 'finalized' ? 'Finalisiert' : inv.status === 'sent' ? 'Versendet' : inv.status === 'draft' ? 'Entwurf' : inv.status;
                h += '<div class="flex items-center gap-4 p-3 rounded-lg bg-'+sc+'-50 border border-'+sc+'-100">';
                h += '<div class="text-xl">'+si+'</div>';
                h += '<div class="flex-1 min-w-0">';
                h += '<div class="flex items-center justify-between"><span class="font-mono text-xs font-semibold text-gray-700">'+(inv.invoice_number||'â€”')+'</span><span class="font-bold text-'+sc+'-700">'+fmtEur(inv.total)+'</span></div>';
                h += '<div class="flex items-center justify-between mt-1"><span class="text-xs text-gray-500">'+(inv.period_start||'')+' â€“ '+(inv.period_end||'')+'</span>';
                h += '<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-'+sc+'-100 text-'+sc+'-700">'+st+'</span>';
                h += '</div></div></div>';
            });
            h += '</div>';
        }
        h += '</div>';
        container.innerHTML = h;
    };

    // Billing auto-init now handled by view-router.js

})();
</script>

<!-- â•â•â• WaWi Beleg-Pipeline Modul â•â•â• -->
<script>
(function(){

    // â”€â”€ pdf.js worker â”€â”€
    if(typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // â”€â”€ State â”€â”€
    var wawiInitDone = false;
    var parsedQueue = []; // pending parsed docs awaiting save

    // â”€â”€ Sub-Tab Switching (inside Controlling â†’ WaWi tab) â”€â”€
    window.showWawiSubTab = function(tab) {
        document.querySelectorAll('.wawi-sub-content').forEach(function(el){ el.style.display='none'; });
        document.querySelectorAll('.wawi-sub-btn').forEach(function(b){
            b.classList.remove('bg-white','text-gray-800','shadow-sm');
            b.classList.add('text-gray-500');
        });
        var tabEl = document.getElementById('wawiSub'+tab.charAt(0).toUpperCase()+tab.slice(1));
        if(tabEl) tabEl.style.display='block';
        var btn = document.querySelector('.wawi-sub-btn[data-sub="'+tab+'"]');
        if(btn){ btn.classList.add('bg-white','text-gray-800','shadow-sm'); btn.classList.remove('text-gray-500'); }
        if(tab==='belege') loadWawiBelege();
        if(tab==='dashboard') loadWawiDashboard();
        if(tab==='leasing') loadWawiLeasing();
        if(tab==='api') loadWawiApiTab();
    };

    // â”€â”€ Init (called when Controlling WaWi tab opens) â”€â”€
    window.initWawiTab = function() {
        if(wawiInitDone) return;
        wawiInitDone = true;
    };

    // â•â•â• WaWi API Connection Management â•â•â•
    var _wawiConnection = null;

    window.loadWawiApiTab = async function() {
        var stdId = SESSION && SESSION.standort_id ? SESSION.standort_id : null;
        if(!stdId) { document.getElementById('wawiConnectionForm').innerHTML = '<p class="text-sm text-gray-400">Kein Standort zugeordnet</p>'; return; }

        // Load existing connection
        try {
            var r = await sb.from('wawi_connections').select('*').eq('standort_id', stdId).maybeSingle();
            if(r.data) {
                _wawiConnection = r.data;
                wawiPopulateForm(r.data);
                if(r.data.ist_aktiv) {
                    document.getElementById('wawiSyncPanel').style.display = 'block';
                    loadWawiSyncLog();
                    loadWawiDataPreview();
                }
                wawiRenderStatus(r.data);
            }
        } catch(e) { console.error('loadWawiApiTab:', e); }
    };

    function wawiPopulateForm(conn) {
        var s = document.getElementById('wawiSystemTyp'); if(s) s.value = conn.system_typ || 'approom';
        var u = document.getElementById('wawiApiUrl'); if(u) u.value = conn.api_url || '';
        var k = document.getElementById('wawiApiKey'); if(k) k.value = conn.api_key_encrypted ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
        var l = document.getElementById('wawiLabel'); if(l) l.value = conn.system_label || '';
        // Sync module checkboxes
        var mods = conn.sync_module || {};
        var cb = document.getElementById('wawiSyncContacts'); if(cb) cb.checked = mods.contacts !== false;
        cb = document.getElementById('wawiSyncProducts'); if(cb) cb.checked = mods.products !== false;
        cb = document.getElementById('wawiSyncOrders'); if(cb) cb.checked = mods.orders !== false;
        cb = document.getElementById('wawiSyncStock'); if(cb) cb.checked = mods.stock !== false;
        cb = document.getElementById('wawiSyncBills'); if(cb) cb.checked = !!mods.bills;
    }

    function wawiRenderStatus(conn) {
        var el = document.getElementById('wawiConnectionStatus');
        if(!el) return;
        if(conn && conn.ist_aktiv) {
            var ago = conn.letzter_sync ? timeAgo(new Date(conn.letzter_sync)) : 'Nie';
            el.innerHTML = '<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">âœ… Verbunden' +
                (conn.letzter_sync ? ' â€¢ Letzter Sync: ' + ago : '') + '</span>';
        } else if(conn && conn.fehler_count > 0) {
            el.innerHTML = '<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">âŒ Fehler: ' + (conn.letzter_fehler || 'Unbekannt').substring(0,50) + '</span>';
        } else {
            el.innerHTML = '<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-500">âšª Nicht verbunden</span>';
        }
    }

    function timeAgo(d) {
        var s = Math.floor((Date.now() - d.getTime()) / 1000);
        if(s < 60) return 'gerade eben';
        if(s < 3600) return Math.floor(s/60) + ' Min.';
        if(s < 86400) return Math.floor(s/3600) + ' Std.';
        return Math.floor(s/86400) + ' Tage';
    }

    window.wawiSystemChanged = function() {
        var typ = document.getElementById('wawiSystemTyp').value;
        var urlEl = document.getElementById('wawiApiUrl');
        if(typ === 'approom' && !urlEl.value) urlEl.placeholder = 'https://erp.app-room.ch/api';
        else if(typ === 'velo_plus') urlEl.placeholder = 'https://api.veloplus.ch';
        else if(typ === 'bc') urlEl.placeholder = 'https://api.businesscentral.dynamics.com/...';
        else urlEl.placeholder = 'https://your-erp.com/api';
    };

    window.wawiTestConnection = async function() {
        var btn = document.getElementById('wawiTestBtn');
        var resEl = document.getElementById('wawiTestResult');
        var apiUrl = document.getElementById('wawiApiUrl').value.trim();
        var apiKey = document.getElementById('wawiApiKey').value.trim();
        if(!apiUrl || !apiKey || apiKey === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
            resEl.innerHTML = '<p class="text-sm text-red-600">âš ï¸ Bitte API-URL und API-Key eingeben</p>';
            return;
        }
        btn.disabled = true; btn.textContent = 'â³ Teste...';
        resEl.innerHTML = '<p class="text-sm text-gray-500">Verbindung wird getestet...</p>';

        try {
            var r = await sb.functions.invoke('wawi-sync', { body: {
                action: 'test_connection',
                api_url: apiUrl,
                api_key: apiKey,
                system_typ: document.getElementById('wawiSystemTyp').value,
                standort_id: SESSION.standort_id
            }});
            var data = r.data;
            if(data && data.success) {
                resEl.innerHTML = '<div class="p-3 bg-green-50 border border-green-200 rounded-lg"><p class="text-sm text-green-700 font-semibold">âœ… ' + (data.message || 'Verbindung erfolgreich!') + '</p></div>';
            } else {
                resEl.innerHTML = '<div class="p-3 bg-red-50 border border-red-200 rounded-lg"><p class="text-sm text-red-700">âŒ ' + (data && data.error ? data.error : 'Unbekannter Fehler') + '</p></div>';
            }
        } catch(e) {
            resEl.innerHTML = '<div class="p-3 bg-red-50 border border-red-200 rounded-lg"><p class="text-sm text-red-700">âŒ Fehler: ' + e.message + '</p></div>';
        }
        btn.disabled = false; btn.textContent = 'ðŸ” Verbindung testen';
    };

    window.wawiSaveConnection = async function() {
        var stdId = SESSION && SESSION.standort_id;
        if(!stdId) { showToast('Kein Standort', 'error'); return; }
        var apiUrl = document.getElementById('wawiApiUrl').value.trim();
        var apiKey = document.getElementById('wawiApiKey').value.trim();
        if(!apiUrl) { showToast('API-URL fehlt', 'error'); return; }
        if(!apiKey || apiKey === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
            if(!_wawiConnection) { showToast('API-Key fehlt', 'error'); return; }
            // Keep existing key if user didn't change it
        }

        var syncMods = {
            contacts: document.getElementById('wawiSyncContacts').checked,
            products: document.getElementById('wawiSyncProducts').checked,
            orders: document.getElementById('wawiSyncOrders').checked,
            stock: document.getElementById('wawiSyncStock').checked,
            bills: document.getElementById('wawiSyncBills').checked
        };

        var payload = {
            standort_id: stdId,
            system_typ: document.getElementById('wawiSystemTyp').value,
            system_label: document.getElementById('wawiLabel').value.trim() || null,
            api_url: apiUrl,
            sync_module: syncMods,
            ist_aktiv: true
        };
        if(apiKey && apiKey !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
            payload.api_key_encrypted = apiKey; // TODO: real encryption
        }

        try {
            var r;
            if(_wawiConnection) {
                r = await sb.from('wawi_connections').update(payload).eq('id', _wawiConnection.id).select().single();
            } else {
                if(apiKey && apiKey !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') payload.api_key_encrypted = apiKey;
                r = await sb.from('wawi_connections').insert(payload).select().single();
            }
            if(r.error) throw r.error;
            _wawiConnection = r.data;
            showToast('WaWi-Verbindung gespeichert âœ…', 'success');
            wawiRenderStatus(r.data);
            document.getElementById('wawiSyncPanel').style.display = 'block';
            loadWawiSyncLog();
        } catch(e) {
            showToast('Fehler: ' + e.message, 'error');
        }
    };

    window.wawiTriggerSync = async function(module) {
        if(!_wawiConnection) { showToast('Keine Verbindung', 'error'); return; }
        showToast('Sync ' + module + ' gestartet...', 'info');
        try {
            var r = await sb.functions.invoke('wawi-sync', { body: {
                action: 'sync',
                connection_id: _wawiConnection.id,
                standort_id: SESSION.standort_id,
                module: module
            }});
            var data = r.data;
            if(data && data.success) {
                showToast('âœ… ' + module + ': ' + (data.total || 0) + ' DatensÃ¤tze in ' + (data.dauer_ms || 0) + 'ms', 'success');
                loadWawiSyncLog();
                loadWawiDataPreview();
            } else {
                showToast('âŒ ' + (data && data.error ? data.error : 'Fehler'), 'error');
            }
        } catch(e) { showToast('Sync-Fehler: ' + e.message, 'error'); }
    };

    window.wawiSyncAll = async function() {
        if(!_wawiConnection) { showToast('Keine Verbindung', 'error'); return; }
        showToast('Komplett-Sync gestartet...', 'info');
        try {
            var r = await sb.functions.invoke('wawi-sync', { body: {
                action: 'sync_all',
                connection_id: _wawiConnection.id,
                standort_id: SESSION.standort_id
            }});
            var data = r.data;
            if(data && data.success) {
                showToast('âœ… Sync abgeschlossen', 'success');
                loadWawiSyncLog();
                loadWawiDataPreview();
            } else {
                showToast('âŒ ' + (data && data.error ? data.error : 'Fehler'), 'error');
            }
        } catch(e) { showToast('Sync-Fehler: ' + e.message, 'error'); }
    };

    async function loadWawiSyncLog() {
        if(!_wawiConnection) return;
        var r = await sb.from('wawi_sync_log').select('*').eq('connection_id', _wawiConnection.id).order('created_at', {ascending:false}).limit(15);
        var el = document.getElementById('wawiSyncLog');
        if(!el) return;
        if(!r.data || !r.data.length) { el.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Noch keine Syncs durchgefÃ¼hrt</p>'; return; }
        el.innerHTML = r.data.map(function(l) {
            var icon = l.status === 'erfolgreich' ? 'âœ…' : l.status === 'fehler' ? 'âŒ' : 'â³';
            var color = l.status === 'erfolgreich' ? 'green' : l.status === 'fehler' ? 'red' : 'gray';
            var d = new Date(l.created_at);
            var zeit = d.toLocaleDateString('de') + ' ' + d.toLocaleTimeString('de', {hour:'2-digit',minute:'2-digit'});
            return '<div class="flex items-center justify-between py-2 px-3 rounded-lg bg-' + color + '-50">' +
                '<div class="flex items-center gap-2"><span>' + icon + '</span><span class="text-xs font-semibold text-gray-700">' + (l.modul || '').toUpperCase() + '</span></div>' +
                '<div class="text-xs text-gray-500">' + (l.datensaetze_total || 0) + ' DatensÃ¤tze â€¢ ' + (l.dauer_ms || 0) + 'ms</div>' +
                '<div class="text-xs text-gray-400">' + zeit + '</div></div>';
        }).join('');
    }

    async function loadWawiDataPreview() {
        if(!_wawiConnection) return;
        var stdId = SESSION.standort_id;

        // Contacts count & preview
        var cr = await sb.from('wawi_kontakte').select('id,name,vorname,email,ort', {count:'exact'}).eq('standort_id', stdId).limit(10);
        var cntEl = document.getElementById('wawiContactCount');
        if(cntEl) cntEl.textContent = '(' + (cr.count || 0) + ')';
        var cpEl = document.getElementById('wawiContactPreview');
        if(cpEl && cr.data) {
            cpEl.innerHTML = cr.data.map(function(c) {
                return '<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-gray-700">' + 
                    (c.vorname ? c.vorname + ' ' : '') + (c.name || 'â€“') + '</span><span class="text-gray-400">' + (c.ort || '') + '</span></div>';
            }).join('') || '<p class="text-gray-400">Keine Kontakte</p>';
        }

        // Products count & preview
        var pr = await sb.from('wawi_produkte').select('id,name,hersteller,preis_vk,bestand', {count:'exact'}).eq('standort_id', stdId).limit(10);
        var pCntEl = document.getElementById('wawiProductCount');
        if(pCntEl) pCntEl.textContent = '(' + (pr.count || 0) + ')';
        var ppEl = document.getElementById('wawiProductPreview');
        if(ppEl && pr.data) {
            ppEl.innerHTML = pr.data.map(function(p) {
                return '<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-gray-700 truncate mr-2">' + (p.name || 'â€“') + 
                    '</span><span class="text-gray-400 whitespace-nowrap">' + (p.preis_vk ? p.preis_vk.toFixed(2) + ' â‚¬' : '') + 
                    (p.bestand != null ? ' â€¢ ' + p.bestand + ' Stk.' : '') + '</span></div>';
            }).join('') || '<p class="text-gray-400">Keine Produkte</p>';
        }

        // KPIs
        var kpiEl = document.getElementById('wawiApiKpis');
        if(kpiEl) {
            kpiEl.innerHTML = [
                {label:'Kontakte', val: cr.count || 0, icon:'ðŸ‘¥', color:'blue'},
                {label:'Produkte', val: pr.count || 0, icon:'ðŸ“¦', color:'green'},
                {label:'Letzter Sync', val: _wawiConnection.letzter_sync ? timeAgo(new Date(_wawiConnection.letzter_sync)) : 'Nie', icon:'ðŸ”„', color:'orange'},
                {label:'Fehler', val: _wawiConnection.fehler_count || 0, icon: (_wawiConnection.fehler_count || 0) > 0 ? 'âš ï¸' : 'âœ…', color: (_wawiConnection.fehler_count || 0) > 0 ? 'red' : 'green'}
            ].map(function(k) {
                return '<div class="vit-card p-4 text-center"><div class="text-2xl mb-1">' + k.icon + '</div><div class="text-xl font-bold text-gray-800">' + k.val + '</div><div class="text-xs text-gray-500">' + k.label + '</div></div>';
            }).join('');
        }
    }

    // â”€â”€ PDF Text Extraction â”€â”€
    async function extractPdfText(file) {
        var buf = await file.arrayBuffer();
        var pdf = await pdfjsLib.getDocument({data: buf}).promise;
        var fullText = '';
        for(var p = 1; p <= pdf.numPages; p++) {
            var page = await pdf.getPage(p);
            var content = await page.getTextContent();
            var lastY = null;
            content.items.forEach(function(item) {
                if(lastY !== null && Math.abs(item.transform[5] - lastY) > 3) fullText += '\n';
                else if(lastY !== null) fullText += ' ';
                fullText += item.str;
                lastY = item.transform[5];
            });
            fullText += '\n';
        }
        return fullText;
    }

    // â”€â”€ Parser â”€â”€
    function parseEur(s) {
        if(!s) return 0;
        return parseFloat(s.replace(/\./g,'').replace(',','.'));
    }

    function parseWawiText(text, fileName) {
        var lines = text.split('\n');
        var result = { source_file:fileName, header:{}, customer:{}, items:[], totals:{}, meta:{}, raw_text: text.substring(0, 2000) };
        var m;
        var textLower = text.toLowerCase();

        // â”€â”€ Belegtyp: 1) Text scan, 2) Filename fallback â”€â”€
        // Broad text scan â€“ check first 30 lines and full text
        var headerText = lines.slice(0, 30).join('\n');
        if(!result.header.beleg_typ) {
            // Direct word matches (case-insensitive, various positions)
            if(/\brechnung\b/i.test(headerText)) result.header.beleg_typ = 'Rechnung';
            else if(/\bauftrag\b/i.test(headerText)) result.header.beleg_typ = 'Auftrag';
            else if(/\bangebot\b/i.test(headerText)) result.header.beleg_typ = 'Angebot';
            else if(/\bgutschrift\b/i.test(headerText)) result.header.beleg_typ = 'Gutschrift';
            else if(/\blieferschein\b/i.test(headerText)) result.header.beleg_typ = 'Lieferschein';
            // Full text fallback
            else if(/\brechnung\b/i.test(text)) result.header.beleg_typ = 'Rechnung';
            else if(/\bauftrag\b/i.test(text)) result.header.beleg_typ = 'Auftrag';
            else if(/\bangebot\b/i.test(text)) result.header.beleg_typ = 'Angebot';
        }

        // Filename fallback: "Auftrag_939313_...", "Rechnung_939329_..."
        if(!result.header.beleg_typ) {
            var fnLower = fileName.toLowerCase();
            if(fnLower.indexOf('rechnung') >= 0) result.header.beleg_typ = 'Rechnung';
            else if(fnLower.indexOf('auftrag') >= 0) result.header.beleg_typ = 'Auftrag';
            else if(fnLower.indexOf('angebot') >= 0) result.header.beleg_typ = 'Angebot';
            else if(fnLower.indexOf('gutschrift') >= 0) result.header.beleg_typ = 'Gutschrift';
            else if(fnLower.indexOf('lieferschein') >= 0) result.header.beleg_typ = 'Lieferschein';
        }

        // â”€â”€ Belegnummer: Multiple patterns â”€â”€
        // Pattern 1: "Belegnummer: 939313"
        m = text.match(/Belegnummer[:\s]+(\d+)/i); if(m) result.header.beleg_nr = m[1];
        // Pattern 2: "Beleg-Nr.: 939313" or "Beleg-Nr: 939313"
        if(!result.header.beleg_nr) { m = text.match(/Beleg[\-\s]?Nr\.?[:\s]+(\d+)/i); if(m) result.header.beleg_nr = m[1]; }
        // Pattern 3: "Rechnungsnummer: 939329" / "Auftragsnummer: 939313"
        if(!result.header.beleg_nr) { m = text.match(/(?:Rechnungs?|Auftrags?|Angebots?)[\-\s]?(?:nummer|nr)\.?[:\s]+(\d+)/i); if(m) result.header.beleg_nr = m[1]; }
        // Pattern 4: "Nr.: 939313" or "Nr: 939313"
        if(!result.header.beleg_nr) { m = text.match(/\bNr\.?[:\s]+(\d{5,})/); if(m) result.header.beleg_nr = m[1]; }
        // Pattern 5: "Beleg 939313" (just the word Beleg followed by number)
        if(!result.header.beleg_nr) { m = text.match(/\bBeleg\s+(\d{5,})/i); if(m) result.header.beleg_nr = m[1]; }
        // Filename fallback: "Auftrag_939313_20260217..."
        if(!result.header.beleg_nr) { m = fileName.match(/(\d{5,7})/); if(m) result.header.beleg_nr = m[1]; }

        // â”€â”€ Datum: Multiple patterns â”€â”€
        m = text.match(/Datum[:\s]+(\d{2})\.(\d{2})\.(\d{4})/i);
        if(m) result.header.datum = m[3]+'-'+m[2]+'-'+m[1];
        if(!result.header.datum) { m = text.match(/(\d{2})\.(\d{2})\.(\d{4})/); if(m) result.header.datum = m[3]+'-'+m[2]+'-'+m[1]; }
        // Filename date: "..._202602171339" = 2026-02-17
        if(!result.header.datum) { m = fileName.match(/(\d{4})(\d{2})(\d{2})\d{4,6}/); if(m) result.header.datum = m[1]+'-'+m[2]+'-'+m[3]; }

        // â”€â”€ Kunden-Nr â”€â”€
        m = text.match(/Kunden[\-\s]?Nr\.?[:\s]+(\d+)/i); if(m) result.header.kunden_nr = m[1];
        if(!result.header.kunden_nr) { m = text.match(/Kdnr\.?[:\s]+(\d+)/i); if(m) result.header.kunden_nr = m[1]; }

        // â”€â”€ VerkÃ¤ufer â”€â”€
        m = text.match(/VerkÃ¤ufer[:\s]+(.+)/i); if(m) result.header.verkaeufer = m[1].trim();
        if(!result.header.verkaeufer) { m = text.match(/Berater[:\s]+(.+)/i); if(m) result.header.verkaeufer = m[1].trim(); }
        if(!result.header.verkaeufer) { m = text.match(/Sachbearbeiter[:\s]+(.+)/i); if(m) result.header.verkaeufer = m[1].trim(); }

        // â”€â”€ Zahlungsbedingung â”€â”€
        m = text.match(/Zahlungsbedingung[:\s]+(.+)/i); if(m) result.header.zahlungsbedingung = m[1].trim();
        if(!result.header.zahlungsbedingung) { m = text.match(/Zahlungsart[:\s]+(.+)/i); if(m) result.header.zahlungsbedingung = m[1].trim(); }

        // Standort (first lines)
        for(var li=0;li<Math.min(8,lines.length);li++){
            m=lines[li].match(/^(.+?)\s*\|\s*(.+?)\s*\|\s*(\d{5})\s+(.+?)(?:\s+Bezahlen|$)/);
            if(m){ result.meta.standort_name=m[1].trim(); result.meta.standort_plz=m[3]; result.meta.standort_ort=m[4].trim(); break; }
        }
        m=text.match(/Email[:\s]+([\w@.\-]+)/i); if(m) result.meta.standort_email=m[1];

        // Kunde
        var kundeLines=[], inKunde=false;
        lines.forEach(function(line){
            var ls=line.trim();
            if(['Herr','Frau','Firma'].indexOf(ls)>=0){ inKunde=true; result.customer.anrede=ls; return; }
            if(inKunde){
                if(['Datum:','Kunden-Nr','VerkÃ¤ufer','Zahlungs','Auftrag','Angebot','Rechnung','Belegnummer','Kunde ','Abweichende','Art.-Nr'].some(function(k){return ls.startsWith(k);})){ inKunde=false; return; }
                if(ls && ls!=='Girocode:' && ls!=='Bezahlen per App' && ls.length < 80) kundeLines.push(ls);
            }
        });
        for(var j=kundeLines.length-1;j>=0;j--){
            var plzM=kundeLines[j].match(/^(?:DE\s*)?(\d{5})\s+(.+)/);
            if(plzM){
                result.customer.plz=plzM[1]; result.customer.ort=plzM[2];
                if(j>0 && /\d/.test(kundeLines[j-1])){
                    result.customer.strasse=kundeLines[j-1];
                    result.customer.name=kundeLines.slice(0,j-1).join(' ').replace(/\s*\. \.\s*/,' ').trim();
                } else {
                    result.customer.name=kundeLines.slice(0,j).join(' ').replace(/\s*\. \.\s*/,' ').trim();
                }
                break;
            }
        }
        if(!result.customer.name && kundeLines.length) result.customer.name=kundeLines.join(' ').replace(/\s*\. \.\s*/,' ').trim();
        m=text.match(/Kunde Telefon[:\s]+(.+)/i); if(m) result.customer.telefon=m[1].trim();
        m=text.match(/Kunde Mobil[:\s]+(.+)/i); if(m) result.customer.mobil=m[1].trim();
        m=text.match(/(?:Tel|Telefon)\.?[:\s]+([\d\s\+\-\/]+)/i); if(m && !result.customer.telefon) result.customer.telefon=m[1].trim();

        // â”€â”€ Positionen: Multiple patterns â”€â”€
        var itemRe=/^(\d{4,7})\s+(.+?)\s+(\d+)\s+([\d.,]+)\s*â‚¬\s*(?:([\d.,]+)\s*â‚¬\s*)?([\d.,]+)\s*â‚¬/;
        // Alternative: without â‚¬ sign, just numbers at end
        var itemRe2=/^(\d{4,7})\s+(.+?)\s+(\d+)\s+([\d.,]+)\s+([\d.,]+)$/;
        // Alternative: Pos | ArtNr | Bezeichnung | Menge | Preis
        var itemRe3=/^\d+\s+(\d{4,7})\s+(.+?)\s+(\d+)\s+([\d.,]+)\s+([\d.,]+)/;
        var inItems=false, i=0;
        while(i<lines.length){
            var line=lines[i].trim();
            if(line.indexOf('Art.-Nr.')>=0 || line.indexOf('Artikelbezeichnung')>=0 || line.indexOf('Artikelnr')>=0 || (line.indexOf('Pos')>=0 && line.indexOf('Bezeichnung')>=0)){ inItems=true; i++; continue; }
            if(inItems && (line.startsWith('Belegrabatt')||line.startsWith('MwSt')||line.startsWith('Summe')||line.startsWith('Gesamt'))){
                if(line.startsWith('Belegrabatt')){ var rabM=line.match(/-?([\d.,]+)\s*â‚¬?/); if(rabM) result.totals.belegrabatt=-parseEur(rabM[1]); }
                inItems=false; i++; continue;
            }
            if(!inItems){ i++; continue; }
            var mI=line.match(itemRe);
            if(!mI) mI = line.match(itemRe2);
            if(!mI) { var mI3 = line.match(itemRe3); if(mI3) mI = [null, mI3[1], mI3[2], mI3[3], mI3[4], null, mI3[5]]; }
            if(mI){
                var itm={art_nr:mI[1],bezeichnung:mI[2].trim(),menge:parseInt(mI[3]),einzelpreis:parseEur(mI[4]),gesamtpreis:parseEur(mI[6]||mI[5])};
                if(mI[5] && mI[6]) itm.rabatt=parseEur(mI[5]);
                var extra=[];var k=i+1;
                while(k<lines.length){ var nl=lines[k].trim(); if(!nl||itemRe.test(nl)||itemRe2.test(nl)||nl.startsWith('Belegrabatt')||nl.startsWith('MwSt')||nl.startsWith('Summe')||/^\d{4,7}\s+/.test(nl))break; extra.push(nl);k++; }
                if(extra.length){ itm.zusatzinfo=extra.join(' | '); var snrM=extra.join(' ').match(/(?:SNr|Seriennr|S\/N)[:\s]*(\S+)/i); if(snrM) itm.seriennummer=snrM[1]; }
                result.items.push(itm); i=k; continue;
            }
            var mZ=line.match(/^(\d{4,7})\s+(.+)$/);
            if(mZ && !/\d+\s+[\d.,]+\s*â‚¬/.test(line)){
                result.items.push({art_nr:mZ[1],bezeichnung:mZ[2].trim(),menge:0,einzelpreis:0,gesamtpreis:0,hinweis:true});
            }
            i++;
        }

        // â”€â”€ Totals: Multiple patterns â”€â”€
        m=text.match(/MwSt\s+([\d,]+)%\s+auf\s+([\d.,]+)\s*â‚¬\s*=\s*([\d.,]+)\s*â‚¬\s*Endbetrag\s*([\d.,]+)\s*â‚¬/);
        if(m){ result.totals.mwst_satz=parseFloat(m[1].replace(',','.')); result.totals.netto=parseEur(m[2]); result.totals.mwst_betrag=parseEur(m[3]); result.totals.endbetrag=parseEur(m[4]); }
        // Alternative: "Netto: 1.234,56 â‚¬" + "MwSt: 234,56 â‚¬" + "Brutto: 1.469,12 â‚¬"
        if(!result.totals.endbetrag) { m=text.match(/(?:Endbetrag|Brutto|Gesamtbetrag|Rechnungsbetrag)[:\s]*([\d.,]+)\s*â‚¬/i); if(m) result.totals.endbetrag=parseEur(m[1]); }
        if(!result.totals.netto) { m=text.match(/(?:Netto(?:betrag)?|Zwischensumme)[:\s]*([\d.,]+)\s*â‚¬/i); if(m) result.totals.netto=parseEur(m[1]); }
        if(!result.totals.mwst_betrag) { m=text.match(/MwSt\.?\s*(?:\d+[,%]?\s*)?[:\s]*([\d.,]+)\s*â‚¬/i); if(m) result.totals.mwst_betrag=parseEur(m[1]); }
        // If still no endbetrag, sum items
        if(!result.totals.endbetrag && result.items.length) {
            result.totals.endbetrag = result.items.reduce(function(s,it){ return s + (it.gesamtpreis||0); }, 0);
        }

        if(text.indexOf('Skonto')>=0){ var skM=text.match(/(\d+)%\s*Skonto/i); if(skM) result.totals.skonto_prozent=parseInt(skM[1]); }

        // Leasing
        var zb=(result.header.zahlungsbedingung||'').toLowerCase();
        if(/leasing/i.test(text) || /leasing/i.test(zb)){
            result.meta.ist_leasing=true;
            var lm=text.match(/[Ll]easing\s*[-â€“]\s*(.+?)(?:\n|$)/); if(lm) result.meta.leasing_anbieter=lm[1].trim();
            if(!result.meta.leasing_anbieter) { lm=text.match(/(JobRad|BusinessBike|Bikeleasing|eurorad|Lease\s*a\s*bike|mein[\-\s]?dienstrad)/i); if(lm) result.meta.leasing_anbieter=lm[1]; }
        }
        else result.meta.ist_leasing=false;

        // Debug log for development
        if(!result.header.beleg_nr && !result.header.beleg_typ) {
            console.warn('[WaWi Parser] Konnte Beleg nicht erkennen:', fileName, '\nErste 500 Zeichen:\n', text.substring(0,500));
        }

        return result;
    }

    // â”€â”€ File Handler â”€â”€
    window.wawiHandleFiles = async function(files) {
        console.log('[WaWi Parser v2.0] Processing', files.length, 'files');
        var container = document.getElementById('wawiParseResults');
        if(!container) return;
        parsedQueue = [];

        for(var f = 0; f < files.length; f++) {
            var file = files[f];
            if(!file.name.toLowerCase().endsWith('.pdf')){ continue; }

            var card = document.createElement('div');
            card.className = 'vit-card p-4';
            card.innerHTML = '<div class="flex items-center gap-3"><div class="animate-pulse w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-vit-orange">â³</div><div><p class="font-semibold text-sm text-gray-800">'+file.name+'</p><p class="text-xs text-gray-400">Wird verarbeitet...</p></div></div>';
            container.appendChild(card);

            try {
                var text = await extractPdfText(file);
                console.log('[WaWi] Extracted text from', file.name, 'â€“ length:', text.length, 'â€“ first 200:', text.substring(0,200));
                var parsed = parseWawiText(text, file.name);
                console.log('[WaWi] Parsed result:', JSON.stringify(parsed.header), 'items:', parsed.items.length);

                if(!parsed.header.beleg_nr && !parsed.header.beleg_typ) {
                    card.innerHTML = renderParseCard(file.name, null, 'Beleg konnte nicht erkannt werden');
                    // Debug: show first 500 chars of extracted text
                    var dbg = document.createElement('details');
                    dbg.style.cssText = 'padding:8px 12px';
                    dbg.innerHTML = '<summary style="cursor:pointer;font-size:11px;color:#EF7D00;margin-top:4px;font-weight:600">ðŸ” Extrahierten Text anzeigen (Debug)</summary><pre style="font-size:10px;color:var(--c-sub);background:var(--c-bg2);padding:10px;border-radius:8px;max-height:250px;overflow:auto;white-space:pre-wrap;margin-top:6px;border:1px solid var(--c-border)">'+(text||'(leer)').substring(0,800).replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</pre>';
                    card.appendChild(dbg);
                    continue;
                }
                parsedQueue.push(parsed);
                card.innerHTML = renderParseCard(file.name, parsed, null);
            } catch(err) {
                console.error('[WaWi] PDF parse error for', file.name, err);
                card.innerHTML = renderParseCard(file.name, null, 'Fehler: ' + (err.message || String(err)));
                // Also show debug for errors
                var dbgErr = document.createElement('details');
                dbgErr.style.cssText = 'padding:8px 12px';
                dbgErr.innerHTML = '<summary style="cursor:pointer;font-size:11px;color:#ef4444;margin-top:4px;font-weight:600">ðŸ” Fehlerdetails anzeigen</summary><pre style="font-size:10px;color:#991b1b;background:#fef2f2;padding:10px;border-radius:8px;max-height:200px;overflow:auto;white-space:pre-wrap;margin-top:6px;border:1px solid #fecaca">'+(err.stack||err.message||String(err)).replace(/</g,'&lt;')+'</pre>';
                card.appendChild(dbgErr);
            }
        }

        // Add save-all button if there are results
        if(parsedQueue.length > 0) {
            var btnDiv = document.createElement('div');
            btnDiv.className = 'flex justify-end mt-4 gap-3';
            btnDiv.innerHTML = '<button onclick="wawiSaveAll()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'+parsedQueue.length+' Beleg'+(parsedQueue.length>1?'e':'')+' importieren</button>';
            container.appendChild(btnDiv);
        }

        // Reset file input
        document.getElementById('wawiFileInput').value = '';
    };

    function renderParseCard(fileName, parsed, error) {
        if(error) {
            return '<div class="flex items-center gap-3"><div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center text-red-500">âœ—</div><div><p class="font-semibold text-sm text-gray-800">'+fileName+'</p><p class="text-xs text-red-500">'+error+'</p></div></div>';
        }
        var typColors = {Angebot:'blue',Auftrag:'orange',Rechnung:'green'};
        var tc = typColors[parsed.header.beleg_typ]||'gray';
        var leasing = parsed.meta.ist_leasing ? '<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-purple-100 text-purple-700 font-semibold">ðŸš² '+escH(parsed.meta.leasing_anbieter||'Leasing')+'</span>' : '';
        return '<div class="flex items-start gap-3"><div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600 flex-shrink-0 mt-0.5">âœ“</div>'
            +'<div class="flex-1 min-w-0">'
            +'<div class="flex items-center gap-2 flex-wrap"><p class="font-semibold text-sm text-gray-800">'+escH(fileName)+'</p>'
            +'<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-'+tc+'-100 text-'+tc+'-700 font-semibold">'+parsed.header.beleg_typ+'</span>'
            +leasing+'</div>'
            +'<div class="flex gap-4 mt-1 text-xs text-gray-500">'
            +'<span>Nr. <strong>'+parsed.header.beleg_nr+'</strong></span>'
            +'<span>'+escH(parsed.customer.name||'â€“')+'</span>'
            +'<span>'+parsed.items.filter(function(x){return !x.hinweis}).length+' Positionen</span>'
            +'<span class="font-bold text-gray-800">'+(parsed.totals.endbetrag||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</span>'
            +'</div>'
            +'<div class="flex gap-1 mt-1.5 flex-wrap">'
            +parsed.items.filter(function(x){return !x.hinweis && x.einzelpreis>100}).map(function(x){
                return '<span class="text-[9px] px-1 py-0.5 rounded bg-gray-100 text-gray-600 truncate max-w-[200px]">'+escH(x.bezeichnung.substring(0,40))+'</span>';
            }).join('')
            +'</div></div></div>';
    }

    function escH(s) { var d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }

    // â”€â”€ Save All â”€â”€
    window.wawiSaveAll = async function() {
        var container = document.getElementById('wawiParseResults');
        var saved = 0, errors = 0;
        var standortId = typeof currentUser !== 'undefined' && currentUser ? currentUser.standort_id : null;

        for(var i = 0; i < parsedQueue.length; i++) {
            var p = parsedQueue[i];
            p.standort_id = standortId;
            p.quelle = 'upload';
            p.quell_datei_name = p.source_file;

            try {
                var resp = await sb.rpc('upsert_wawi_beleg', { p_data: p });
                if(resp.error) { errors++; console.error('WaWi save error:', resp.error); }
                else saved++;
            } catch(e) { errors++; console.error('WaWi save exception:', e); }
        }

        container.innerHTML = '<div class="vit-card p-5 text-center">'
            +'<div class="text-3xl mb-2">'+(errors===0?'ðŸŽ‰':'âš ï¸')+'</div>'
            +'<p class="font-bold text-gray-800">'+saved+' Beleg'+(saved!==1?'e':'')+' importiert'+(errors>0?', '+errors+' Fehler':'')+'</p>'
            +'<button onclick="showWawiTab(\'belege\')" class="mt-3 text-sm text-vit-orange font-semibold hover:underline">â†’ Zur BelegÃ¼bersicht</button>'
            +'</div>';
        parsedQueue = [];
    };

    // â”€â”€ Load Belege List â”€â”€
    window.loadWawiBelege = async function() {
        var container = document.getElementById('wawiListContainer');
        if(!container) return;
        container.innerHTML = '<div class="p-6 text-center text-gray-400"><div class="animate-pulse">Lade Belege...</div></div>';

        var q = sb.from('wawi_belege').select('id,beleg_typ,beleg_nr,datum,kunde_name,verkaeufer,endbetrag,ist_leasing,leasing_anbieter,status,kunden_nr').order('datum',{ascending:false}).limit(100);

        var fTyp = document.getElementById('wawiFilterTyp');
        if(fTyp && fTyp.value) q = q.eq('beleg_typ', fTyp.value);
        var fL = document.getElementById('wawiFilterLeasing');
        if(fL && fL.value) q = q.eq('ist_leasing', fL.value==='true');
        var fS = document.getElementById('wawiFilterSearch');
        if(fS && fS.value.length >= 2) q = q.or('beleg_nr.ilike.%'+fS.value+'%,kunde_name.ilike.%'+fS.value+'%');

        var {data, error} = await q;
        if(error){ container.innerHTML='<div class="p-4 text-red-500 text-sm">Fehler: '+error.message+'</div>'; return; }
        if(!data || data.length===0){ container.innerHTML='<div class="p-8 text-center text-gray-400"><div class="text-3xl mb-2">ðŸ“­</div><p>Noch keine Belege importiert</p><p class="text-xs mt-1">Lade PDFs im Upload-Tab hoch</p></div>'; return; }

        var typColors = {Angebot:'blue',Auftrag:'orange',Rechnung:'green'};
        var h = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-50 text-left text-xs text-gray-500 uppercase">'
            +'<th class="px-4 py-3">Typ</th><th class="px-4 py-3">Nr.</th><th class="px-4 py-3">Datum</th><th class="px-4 py-3">Kunde</th>'
            +'<th class="px-4 py-3">VerkÃ¤ufer</th><th class="px-4 py-3 text-right">Betrag</th><th class="px-4 py-3">Leasing</th>'
            +'</tr></thead><tbody>';

        data.forEach(function(b) {
            var tc = typColors[b.beleg_typ]||'gray';
            var datum = b.datum ? new Date(b.datum).toLocaleDateString('de-DE') : 'â€“';
            h += '<tr class="border-t border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="showWawiBelegDetail(\''+b.id+'\')">';
            h += '<td class="px-4 py-3"><span class="text-[10px] px-2 py-0.5 rounded-full bg-'+tc+'-100 text-'+tc+'-700 font-bold">'+b.beleg_typ+'</span></td>';
            h += '<td class="px-4 py-3 font-mono font-bold text-gray-800">'+escH(b.beleg_nr)+'</td>';
            h += '<td class="px-4 py-3 text-gray-600">'+datum+'</td>';
            h += '<td class="px-4 py-3 text-gray-800 font-medium truncate max-w-[200px]">'+escH(b.kunde_name||'â€“')+'</td>';
            h += '<td class="px-4 py-3 text-gray-600">'+escH(b.verkaeufer||'â€“')+'</td>';
            h += '<td class="px-4 py-3 text-right font-bold text-gray-800">'+(b.endbetrag||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</td>';
            h += '<td class="px-4 py-3">'+(b.ist_leasing?'<span class="text-[10px] px-1.5 py-0.5 rounded-full bg-purple-100 text-purple-700 font-semibold">'+escH(b.leasing_anbieter||'Ja')+'</span>':'<span class="text-xs text-gray-300">â€“</span>')+'</td>';
            h += '</tr>';
        });
        h += '</tbody></table></div>';
        container.innerHTML = h;
    };

    // â”€â”€ Beleg Detail â”€â”€
    window.showWawiBelegDetail = async function(id) {
        var modal = document.getElementById('wawiBelegModal');
        var detail = document.getElementById('wawiBelegDetail');
        modal.style.display = 'flex';
        detail.innerHTML = '<div class="text-center p-6"><div class="animate-pulse text-gray-400">Lade Beleg...</div></div>';

        var {data:b} = await sb.from('wawi_belege').select('*').eq('id',id).single();
        if(!b){ detail.innerHTML='<p class="text-red-500">Beleg nicht gefunden</p>'; return; }
        var {data:pos} = await sb.from('wawi_beleg_positionen').select('*').eq('beleg_id',id).order('sortierung');
        pos = pos || [];

        var typColors = {Angebot:'blue',Auftrag:'orange',Rechnung:'green'};
        var tc = typColors[b.beleg_typ]||'gray';
        var datum = b.datum ? new Date(b.datum).toLocaleDateString('de-DE') : 'â€“';

        var h = '<div class="flex items-center justify-between mb-4">';
        h += '<div class="flex items-center gap-3"><span class="text-[11px] px-2.5 py-1 rounded-full bg-'+tc+'-100 text-'+tc+'-700 font-bold">'+b.beleg_typ+'</span>';
        h += '<span class="text-xl font-bold text-gray-800">#'+escH(b.beleg_nr)+'</span></div>';
        h += '<button onclick="document.getElementById(\'wawiBelegModal\').style.display=\'none\'" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button></div>';

        // Info Grid
        h += '<div class="grid grid-cols-2 gap-4 mb-5 text-sm">';
        h += '<div><span class="text-gray-400 text-xs block">Datum</span><strong>'+datum+'</strong></div>';
        h += '<div><span class="text-gray-400 text-xs block">Kunde</span><strong>'+escH(b.kunde_name||'â€“')+'</strong>'+(b.kunde_ort?'<br><span class="text-xs text-gray-500">'+escH(b.kunde_plz||'')+' '+escH(b.kunde_ort)+'</span>':'')+'</div>';
        h += '<div><span class="text-gray-400 text-xs block">VerkÃ¤ufer</span><strong>'+escH(b.verkaeufer||'â€“')+'</strong></div>';
        h += '<div><span class="text-gray-400 text-xs block">Zahlung</span><strong>'+escH(b.zahlungsbedingung||'â€“')+'</strong></div>';
        if(b.ist_leasing) h += '<div class="col-span-2"><span class="text-[10px] px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 font-bold">ðŸš² Leasing: '+escH(b.leasing_anbieter||'Ja')+'</span></div>';
        h += '</div>';

        // Positionen
        h += '<h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Positionen</h3>';
        h += '<div class="overflow-x-auto mb-4"><table class="w-full text-sm"><thead><tr class="text-left text-xs text-gray-400 border-b">';
        h += '<th class="pb-2">Art.-Nr.</th><th class="pb-2">Bezeichnung</th><th class="pb-2 text-center">Mg.</th><th class="pb-2 text-right">Einzel</th><th class="pb-2 text-right">Gesamt</th></tr></thead><tbody>';
        pos.forEach(function(p){
            var isMain = (p.einzelpreis||0) > 500;
            h += '<tr class="border-t border-gray-50'+(isMain?' bg-orange-50/50':'')+(p.ist_hinweis?' text-gray-400 italic':'')+'">';
            h += '<td class="py-1.5 pr-2 font-mono text-xs text-gray-500">'+escH(p.art_nr||'â€“')+'</td>';
            h += '<td class="py-1.5 pr-2 '+(isMain?'font-semibold text-gray-800':'text-gray-700')+'">'+escH(p.bezeichnung)+(p.seriennummer?'<br><span class="text-[10px] text-gray-400">SN: '+escH(p.seriennummer)+'</span>':'')+'</td>';
            h += '<td class="py-1.5 text-center">'+(p.menge||'â€“')+'</td>';
            h += '<td class="py-1.5 text-right">'+(p.einzelpreis?p.einzelpreis.toLocaleString('de-DE',{style:'currency',currency:'EUR'}):'â€“')+'</td>';
            h += '<td class="py-1.5 text-right font-semibold">'+(p.gesamtpreis?p.gesamtpreis.toLocaleString('de-DE',{style:'currency',currency:'EUR'}):'â€“')+'</td>';
            h += '</tr>';
            if(p.zusatzinfo){ h += '<tr class="text-[10px] text-gray-400"><td></td><td colspan="4" class="pb-1">'+escH(p.zusatzinfo)+'</td></tr>'; }
        });
        h += '</tbody></table></div>';

        // Totals
        h += '<div class="border-t-2 border-gray-200 pt-3 space-y-1 text-sm">';
        if(b.belegrabatt && b.belegrabatt!==0) h += '<div class="flex justify-between text-red-600"><span>Belegrabatt</span><span>'+b.belegrabatt.toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</span></div>';
        h += '<div class="flex justify-between text-gray-600"><span>Netto</span><span>'+(b.netto||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</span></div>';
        h += '<div class="flex justify-between text-gray-600"><span>MwSt '+(b.mwst_satz||19)+'%</span><span>'+(b.mwst_betrag||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</span></div>';
        h += '<div class="flex justify-between text-lg font-bold text-gray-800 pt-1 border-t"><span>Endbetrag</span><span>'+(b.endbetrag||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'})+'</span></div>';
        if(b.skonto_prozent) h += '<div class="text-xs text-green-600 text-right">'+b.skonto_prozent+'% Skonto mÃ¶glich</div>';
        h += '</div>';

        detail.innerHTML = h;
    };

    // â”€â”€ Dashboard â”€â”€
    window.loadWawiDashboard = async function() {
        var kpiEl = document.getElementById('wawiKpiCards');
        var typEl = document.getElementById('wawiChartTyp');
        var topEl = document.getElementById('wawiTopProducts');
        if(!kpiEl) return;

        // Summary query
        var {data:belege} = await sb.from('wawi_belege').select('beleg_typ,endbetrag,ist_leasing,datum').eq('status','neu');
        belege = belege || [];

        var total=0, countA=0, countR=0, countAng=0, leasingSum=0;
        belege.forEach(function(b){
            total += (b.endbetrag||0);
            if(b.beleg_typ==='Auftrag') countA++;
            if(b.beleg_typ==='Rechnung') countR++;
            if(b.beleg_typ==='Angebot') countAng++;
            if(b.ist_leasing) leasingSum += (b.endbetrag||0);
        });

        function kpiCard(icon, label, value, color) {
            return '<div class="vit-card p-4 text-center"><div class="text-2xl mb-1">'+icon+'</div><div class="text-xl font-bold text-'+color+'-700">'+value+'</div><div class="text-[10px] text-gray-500 uppercase font-semibold mt-1">'+label+'</div></div>';
        }
        kpiEl.innerHTML = kpiCard('ðŸ“„','Belege gesamt', belege.length, 'gray')
            + kpiCard('ðŸ’°','Umsatz gesamt', total.toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}), 'green')
            + kpiCard('ðŸš²','Davon Leasing', leasingSum.toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}), 'purple')
            + kpiCard('ðŸ“Š','Ã˜ Belegwert', belege.length>0?(total/belege.length).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}):'â€“', 'blue');

        // Typ breakdown
        var typData = [
            {typ:'Angebote', count:countAng, color:'#3B82F6'},
            {typ:'AuftrÃ¤ge', count:countA, color:'#EF7D00'},
            {typ:'Rechnungen', count:countR, color:'#22C55E'}
        ];
        var maxCount = Math.max(countAng, countA, countR, 1);
        typEl.innerHTML = typData.map(function(t){
            var pct = Math.round(t.count/maxCount*100);
            return '<div class="flex items-center gap-3 mb-3"><span class="text-xs w-24 text-gray-600 font-semibold">'+t.typ+'</span><div class="flex-1 bg-gray-100 rounded-full h-6 overflow-hidden"><div class="h-full rounded-full flex items-center px-2 text-xs text-white font-bold" style="width:'+Math.max(pct,8)+'%;background:'+t.color+'">'+t.count+'</div></div></div>';
        }).join('');

        // Top Products
        var {data:top} = await sb.from('v_wawi_top_produkte').select('*').order('gesamt_umsatz',{ascending:false}).limit(8);
        top = top || [];
        if(top.length===0){ topEl.innerHTML='<p class="text-gray-400 text-sm text-center py-6">Noch keine Daten</p>'; return; }
        topEl.innerHTML = '<div class="space-y-2">'+top.map(function(p,i){
            return '<div class="flex items-center gap-2 text-sm"><span class="w-5 text-center font-bold text-gray-400">'+(i+1)+'</span><span class="flex-1 truncate text-gray-800">'+escH(p.bezeichnung)+'</span><span class="font-bold text-gray-800 whitespace-nowrap">'+(p.gesamt_umsatz||0).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0})+'</span></div>';
        }).join('')+'</div>';
    };

    // â”€â”€ Leasing â”€â”€
    window.loadWawiLeasing = async function() {
        var kpiEl = document.getElementById('wawiLeasingKpis');
        var tableEl = document.getElementById('wawiLeasingTable');
        if(!kpiEl) return;

        var {data} = await sb.from('v_wawi_leasing_uebersicht').select('*');
        data = data || [];

        var totalCount=0, totalSum=0, providers={};
        data.forEach(function(r){
            totalCount += (r.anzahl||0);
            totalSum += (r.summe_brutto||0);
            var p = r.leasing_anbieter||'Sonstige';
            if(!providers[p]) providers[p]={count:0,sum:0};
            providers[p].count += (r.anzahl||0);
            providers[p].sum += (r.summe_brutto||0);
        });

        function kpiCard(icon, label, value, color) {
            return '<div class="vit-card p-4 text-center"><div class="text-2xl mb-1">'+icon+'</div><div class="text-xl font-bold text-'+color+'-700">'+value+'</div><div class="text-[10px] text-gray-500 uppercase font-semibold mt-1">'+label+'</div></div>';
        }
        kpiEl.innerHTML = kpiCard('ðŸš²','Leasing-VorgÃ¤nge',totalCount,'purple')
            + kpiCard('ðŸ’°','Leasing-Volumen',totalSum.toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}),'green')
            + kpiCard('ðŸ“Š','Ã˜ Leasing-Wert',totalCount>0?(totalSum/totalCount).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}):'â€“','blue')
            + kpiCard('ðŸ¢','Anbieter',Object.keys(providers).length,'gray');

        if(Object.keys(providers).length===0){ tableEl.innerHTML='<p class="text-gray-400 text-sm text-center py-6">Noch keine Leasing-Daten</p>'; return; }

        var sortedProviders = Object.entries(providers).sort(function(a,b){return b[1].sum-a[1].sum;});
        var h = '<table class="w-full text-sm mt-3"><thead><tr class="text-left text-xs text-gray-400 border-b"><th class="pb-2">Anbieter</th><th class="pb-2 text-center">Anzahl</th><th class="pb-2 text-right">Volumen</th><th class="pb-2 text-right">Ã˜ Wert</th></tr></thead><tbody>';
        sortedProviders.forEach(function(e){
            var name=e[0], d=e[1];
            h += '<tr class="border-t border-gray-100"><td class="py-2 font-semibold text-gray-800">'+escH(name)+'</td>';
            h += '<td class="py-2 text-center">'+d.count+'</td>';
            h += '<td class="py-2 text-right font-bold">'+d.sum.toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0})+'</td>';
            h += '<td class="py-2 text-right text-gray-600">'+(d.count>0?(d.sum/d.count).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:0}):'â€“')+'</td></tr>';
        });
        h += '</tbody></table>';
        tableEl.innerHTML = h;
    };

})();
</script>


<!-- â•â•â• PWA: Service Worker + Install Prompt + Push Notifications â•â•â• -->
<script>
(function(){
    // â”€â”€ Service Worker Registration â”€â”€
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
                .then(function(reg) {
                    console.log('[PWA] Service Worker registered, scope:', reg.scope);
                    // Check for updates periodically
                    setInterval(function(){ reg.update(); }, 60 * 60 * 1000); // hourly
                })
                .catch(function(err) {
                    console.log('[PWA] SW registration failed:', err);
                });
        });

        // Listen for push navigation messages from SW
        navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'PUSH_NAVIGATE') {
                var url = event.data.url || '/';
                var params = new URLSearchParams(url.split('?')[1] || '');
                var view = params.get('view');
                if (view && typeof showView === 'function') {
                    showView(view);
                }
            }
            if (event.data && event.data.type === 'PUSH_SUBSCRIPTION_CHANGED') {
                console.log('[Push] Subscription changed, re-subscribing...');
                if (typeof setupPushNotifications === 'function') setupPushNotifications();
            }
        });
    }

    // â”€â”€ Install Prompt â”€â”€
    var deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        showInstallBanner();
    });

    // â”€â”€ Push Notification Trigger Helper â”€â”€
    async function triggerPush(userIds, title, body, url, prefKey) {
        if (!userIds || userIds.length === 0) return;
        try {
            var sb = window._supabase;
            if (!sb) return;
            if (prefKey) {
                var { data: prefs } = await sb.from('notification_preferences').select('user_id, ' + prefKey).in('user_id', userIds);
                if (prefs) userIds = prefs.filter(function(p) { return p[prefKey] !== false; }).map(function(p) { return p.user_id; });
                if (userIds.length === 0) return;
            }
            var { data: session } = await sb.auth.getSession();
            var token = session?.session?.access_token;
            if (!token) return;
            await fetch('https://lwwagbkxeofahhwebkab.supabase.co/functions/v1/send-push', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_ids: userIds, title: title, body: body, url: url || '/', icon: '/icon-192.png' })
            });
        } catch(e) { console.log('[Push] trigger error:', e.message); }
    }

    async function triggerPushStandort(title, body, url, prefKey) {
        try {
            var sb = window._supabase;
            var me = (await sb.auth.getUser()).data.user?.id;
            var sid = sbProfile ? sbProfile.standort_id : null;
            if (!sid || !me) return;
            var { data: users } = await sb.from('user_profiles').select('user_id').eq('standort_id', sid);
            if (!users) return;
            var ids = users.map(function(u) { return u.user_id; }).filter(function(id) { return id !== me; });
            await triggerPush(ids, title, body, url, prefKey);
        } catch(e) { console.log('[Push] standort trigger:', e.message); }
    }

    async function triggerPushHQ(title, body, url, prefKey) {
        try {
            var sb = window._supabase;
            var me = (await sb.auth.getUser()).data.user?.id;
            var { data: hqUsers } = await sb.from('user_profiles').select('user_id').eq('is_hq', true);
            if (!hqUsers) return;
            var ids = hqUsers.map(function(u) { return u.user_id; }).filter(function(id) { return id !== me; });
            await triggerPush(ids, title, body, url, prefKey);
        } catch(e) { console.log('[Push] HQ trigger:', e.message); }
    }

    function showInstallBanner() {
        // Don't show if already installed or dismissed
        if (window.matchMedia('(display-mode: standalone)').matches) return;
        try { if (localStorage.getItem('vit-pwa-dismissed')) return; } catch(e){}

        var banner = document.createElement('div');
        banner.id = 'pwaInstallBanner';
        banner.style.cssText = 'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:10001;width:calc(100% - 32px);max-width:420px;';
        banner.innerHTML = '<div style="background:var(--c-bg);border-radius:14px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.25);border:1px solid var(--c-border);display:flex;align-items:center;gap:12px">' +
            '<div style="width:44px;height:44px;border-radius:10px;background:#EF7D00;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:20px;color:white;font-weight:900">v</span></div>' +
            '<div style="flex:1"><p style="font-size:13px;font-weight:700;color:var(--c-text);margin:0">vit:bikes als App installieren</p><p style="font-size:11px;color:var(--c-sub);margin:2px 0 0">Schnellzugriff auf Pipeline, Kalender & mehr</p></div>' +
            '<button onclick="installPWA()" style="background:#EF7D00;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">Installieren</button>' +
            '<button onclick="dismissInstall()" style="background:none;border:none;color:var(--c-muted);font-size:16px;cursor:pointer;padding:4px">âœ•</button>' +
            '</div>';
        document.body.appendChild(banner);
    }

    window.installPWA = function() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(result) {
            if (result.outcome === 'accepted') {
                console.log('[PWA] App installed');
            }
            deferredPrompt = null;
            var b = document.getElementById('pwaInstallBanner');
            if (b) b.remove();
        });
    };

    window.dismissInstall = function() {
        var b = document.getElementById('pwaInstallBanner');
        if (b) b.remove();
        try { localStorage.setItem('vit-pwa-dismissed', '1'); } catch(e){}
    };

    // â”€â”€ Push Notifications Setup â”€â”€
    window.setupPushNotifications = async function() {
        if (!('Notification' in window) || !('serviceWorker' in navigator)) {
            alert(t('alert_push_unsupported'));
            return;
        }
        
        var permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert(t('alert_push_denied'));
            return;
        }

        try {
            var reg = await navigator.serviceWorker.ready;
            var VAPID_PUBLIC_KEY = 'BFjv8qdfhEPXyWvz8Ite8laCH0XMaLtzTXvRBRq7XIa4FELmOz2RA3fUh7me1LIAh0JsKQVd-Pl8Dlxg_8mFc3c';
            
            // Convert VAPID key to Uint8Array
            var padding = '='.repeat((4 - VAPID_PUBLIC_KEY.length % 4) % 4);
            var base64 = (VAPID_PUBLIC_KEY + padding).replace(/-/g, '+').replace(/_/g, '/');
            var rawData = atob(base64);
            var outputArray = new Uint8Array(rawData.length);
            for (var i = 0; i < rawData.length; i++) outputArray[i] = rawData.charCodeAt(i);

            var subscription = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: outputArray
            });

            var sub = subscription.toJSON();
            var sba = window._supabase || window.sb;
            var user = (await sba.auth.getUser()).data.user;
            if (!user) { alert('Nicht eingeloggt'); return; }

            var deviceName = navigator.userAgent.indexOf('Mobile') > -1 ? 'MobilgerÃ¤t' : 'Desktop';
            deviceName += ' â€“ ' + (navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)[\/\s](\d+)/)||[])[0] || 'Browser';

            var { error } = await sba.from('push_subscriptions').upsert({
                user_id: user.id,
                endpoint: sub.endpoint,
                p256dh: sub.keys.p256dh,
                auth_key: sub.keys.auth,
                device_name: deviceName
            }, { onConflict: 'endpoint' });

            if (error) throw error;

            console.log('[Push] Subscription saved successfully');
            updatePushUI(true, deviceName);
            showLocalNotification('ðŸ”” Push aktiviert!', 'Du erhÃ¤ltst jetzt Benachrichtigungen fÃ¼r Nachrichten, Leads, Aufgaben & mehr.');
        } catch(err) {
            console.error('[Push] Setup error:', err);
            alert('Push-Aktivierung fehlgeschlagen: ' + err.message);
        }
    };

    window.showLocalNotification = function(title, body, url) {
        if (!('serviceWorker' in navigator)) return;
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification(title, {
                body: body,
                icon: '/icons/icon-192.png',
                badge: '/icons/icon-72.png',
                vibrate: [100, 50, 100],
                data: { url: url || '/' },
                tag: 'local-' + Date.now()
            });
        });
    };

    function updatePushUI(active, deviceName) {
        var activateArea = document.getElementById('pushActivateArea');
        var activeArea = document.getElementById('pushActiveArea');
        if (activateArea) activateArea.style.display = active ? 'none' : 'block';
        if (activeArea) activeArea.style.display = active ? 'block' : 'none';
    }

    window.checkPushStatus = async function() {
        try {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
            var reg = await navigator.serviceWorker.ready;
            var sub = await reg.pushManager.getSubscription();
            updatePushUI(!!sub, sub ? 'Aktives GerÃ¤t' : null);
            if (sub) loadNotificationPrefs();
        } catch(e) { console.log('[Push] Status check:', e.message); }
    }

    window.loadNotificationPrefs = async function() {
        try {
            var sba = window._supabase || window.sb;
            var userId = (await sba.auth.getUser()).data.user?.id;
            if (!userId) return;
            var { data } = await sba.from('notification_preferences').select('*').eq('user_id', userId).single();
            if (!data) return;
            document.querySelectorAll('.notif-toggle').forEach(function(cb) {
                var key = cb.dataset.pref;
                if (key && data[key] !== undefined) cb.checked = data[key];
            });
        } catch(e) { console.log('[Prefs] load:', e.message); }
    }

    window.saveNotificationPrefs = async function() {
        try {
            var sba = window._supabase || window.sb;
            var userId = (await sba.auth.getUser()).data.user?.id;
            if (!userId) { alert('Nicht eingeloggt'); return; }
            var prefs = { user_id: userId, updated_at: new Date().toISOString() };
            document.querySelectorAll('.notif-toggle').forEach(function(cb) {
                var key = cb.dataset.pref;
                if (key) prefs[key] = cb.checked;
            });
            var { error } = await sba.from('notification_preferences').upsert(prefs, { onConflict: 'user_id' });
            if (error) throw error;
            alert('âœ… Push-Einstellungen gespeichert!');
        } catch(e) { alert('Fehler: ' + e.message); }
    }

    window.unsubscribePush = async function() {
        try {
            var reg = await navigator.serviceWorker.ready;
            var sub = await reg.pushManager.getSubscription();
            if (sub) {
                var endpoint = sub.endpoint;
                await sub.unsubscribe();
                var sba = window._supabase || window.sb;
                await sba.from('push_subscriptions').delete().eq('endpoint', endpoint);
                console.log('[Push] Unsubscribed');
            }
            updatePushUI(false);
        } catch(e) { console.error('[Push] Unsubscribe error:', e); }
    }

    // â”€â”€ Camera Access for Content Upload â”€â”€
    window.openCamera = function(callback) {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,video/*';
        input.capture = 'environment'; // rear camera
        input.onchange = function(e) {
            var file = e.target.files[0];
            if (file && callback) callback(file);
        };
        input.click();
    };

    // â”€â”€ App-installed detection â”€â”€
    window.addEventListener('appinstalled', function() {
        console.log('[PWA] App was installed');
        var b = document.getElementById('pwaInstallBanner');
        if (b) b.remove();
    });

    // â”€â”€ Detect standalone mode â”€â”€
    if (window.matchMedia('(display-mode: standalone)').matches) {
        document.body.classList.add('pwa-standalone');
        console.log('[PWA] Running as installed app');
    }
})();
</script>

<style>
/* PWA Standalone mode adjustments */
.pwa-standalone .top-navigation-bar {
    padding-top: env(safe-area-inset-top, 0px);
}
.pwa-standalone .sidebar-container {
    padding-top: env(safe-area-inset-top, 0px);
    padding-bottom: env(safe-area-inset-bottom, 0px);
}
/* iPhone Notch/Dynamic Island: push header below safe area */
@media (max-width: 768px) {
    #mainApp > nav {
        padding-top: env(safe-area-inset-top, 0px);
    }
    .sidebar-container {
        padding-top: env(safe-area-inset-top, 0px);
    }
    #pwaInstallBanner { bottom: 80px !important; }
}
</style>

<script>
// â•â•â• 3-EBENEN SYSTEM: RENDER FUNCTIONS â•â•â•

function renderExternHome() {
    var stage = SESSION.stage;
    var stageLabels = {
        phase0: { label: 'Phase 0 â€“ Kostenloser Akademiezugang', desc: 'Einstieg ohne Verpflichtung â€“ lerne vit:bikes kennen' },
        part1: { label: 'Trainingsphase Part 1 â€“ Strategie & Qualifizierung', desc: '3 Monate strategisches Fundament' },
        part2: { label: 'Trainingsphase Part 2 â€“ Integration & Umsetzung', desc: '9 Monate operative Systemintegration' },
        partner: { label: 'Partnerphase â€“ Voller Standort', desc: 'Willkommen im vit:bikes Netzwerk!' }
    };
    var info = stageLabels[stage] || stageLabels.phase0;
    var el = document.getElementById('externStageLabel');
    if(el) el.textContent = info.label;
    var descEl = document.getElementById('externStageDesc');
    if(descEl) descEl.textContent = info.desc;

    // Roadmap
    var roadmapEl = document.getElementById('externRoadmap');
    if(roadmapEl) {
        var stages = ['phase0','part1','part2','partner'];
        var labels = ['Phase 0','Part 1','Part 2','Partner'];
        var icons = ['\u{1F193}','\u{1F4CB}','\u{26A1}','\u{1F3C6}'];
        var currentIdx = stages.indexOf(stage);
        var h = '';
        stages.forEach(function(s, i) {
            var isCurrent = i === currentIdx;
            var isDone = i < currentIdx;
            var bgColor = isDone ? '#15803d' : isCurrent ? '#EF7D00' : 'var(--c-border)';
            var textColor = isDone || isCurrent ? 'white' : '#6b7280';
            h += '<div class="flex-1 text-center">';
            h += '<div class="mx-auto w-12 h-12 rounded-full flex items-center justify-center text-xl mb-2" style="background:'+bgColor+';color:'+textColor+';">'+(isDone?'\u2713':icons[i])+'</div>';
            h += '<p class="text-xs font-semibold '+(isCurrent?'text-vit-orange':isDone?'text-green-600':'text-gray-400')+'">'+labels[i]+'</p>';
            h += '</div>';
            if(i < stages.length - 1) {
                h += '<div class="flex-shrink-0 w-8 lg:w-16 flex items-center justify-center" style="margin-top:-20px"><div style="height:2px;width:100%;background:'+(isDone?'#15803d':'#e5e7eb')+';"></div></div>';
            }
        });
        roadmapEl.innerHTML = h;
    }

    // Included features
    var includedEl = document.getElementById('externIncluded');
    if(includedEl) {
        var features = {
            phase0: [
                { icon: '\u{1F4DA}', text: 'Akademie-Zugang (Grundkurse)', active: true },
                { icon: '\u{1F4AC}', text: 'Community lesen', active: true },
                { icon: '\u{1F198}', text: 'Basis-Support', active: true },
                { icon: '\u{1F5FA}', text: 'Onboarding-Roadmap', active: true },
                { icon: '\u{1F512}', text: 'Strategiemodule', active: false },
                { icon: '\u{1F512}', text: 'Einkaufskonditionen', active: false }
            ],
            part1: [
                { icon: '\u{1F4DA}', text: 'Alle Akademie-Inhalte', active: true },
                { icon: '\u{1F4CA}', text: 'Strategiemodule', active: true },
                { icon: '\u{1F465}', text: 'Begleitung durch vit:bikes Team', active: true },
                { icon: '\u{1F512}', text: 'Einkaufskonditionen', active: false }
            ],
            part2: [
                { icon: '\u{1F6D2}', text: 'Einkaufs- & Leasingkonditionen', active: true },
                { icon: '\u{1F393}', text: 'Workshops', active: true },
                { icon: '\u{1F4DE}', text: 'Vollstaendiger Support', active: true },
                { icon: '\u{1F512}', text: 'Volle Markenfuehrung', active: false }
            ]
        };
        var list = features[stage] || features.phase0;
        var fh = '';
        list.forEach(function(f) {
            fh += '<div class="flex items-center space-x-3 p-2.5 rounded-lg '+(f.active?'bg-green-50':'bg-gray-50 opacity-60')+'">';
            fh += '<span class="text-lg">'+f.icon+'</span>';
            fh += '<span class="text-sm '+(f.active?'text-gray-700':'text-gray-400')+'">'+f.text+'</span>';
            if(f.active) fh += '<span class="ml-auto text-green-500 text-xs">\u2713</span>';
            fh += '</div>';
        });
        includedEl.innerHTML = fh;
    }
}

function renderOnboardingView() {
    var container = document.getElementById('onboardingContent');
    if(!container) return;
    var stage = SESSION.stage;
    var level = SESSION.account_level;
    var isHQUser = currentRole === 'hq';
    var h = '';

    var stageColors = {phase0:'#EF7D00',part1:'#6d28d9',part2:'#1d4ed8',partner:'#15803d'};
    var stageNames = {phase0:'Phase 0 \u2013 Akademiezugang',part1:'Trainingsphase Part 1',part2:'Trainingsphase Part 2',partner:'Partnerphase'};
    var stageIcons = {phase0:'\u{1F680}',part1:'\u{1F4CB}',part2:'\u{26A1}',partner:'\u{1F3C6}'};

    // Header
    h += '<div class="flex items-center justify-between flex-wrap gap-4 mb-6"><div>';
    h += '<h1 class="h1-headline text-gray-800 mb-1" style="font-size:22px">ONBOARDING & WEG</h1>';
    h += '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white" style="background:'+stageColors[stage]+'">'+stageIcons[stage]+' '+stageNames[stage]+'</span>';
    if(SESSION.stage_status === 'extended') h += ' <span class="inline-flex items-center px-2 py-1 rounded-full text-[10px] font-bold bg-red-100 text-red-600">\u26A0\uFE0F Verlaengerung aktiv</span>';
    h += '</div>';
    if(SESSION.stage_due_at) {
        var due = new Date(SESSION.stage_due_at);
        var daysLeft = Math.ceil((due - new Date()) / (1000*60*60*24));
        var dueColor = daysLeft < 0 ? 'text-red-600' : daysLeft < 30 ? 'text-orange-500' : 'text-green-600';
        h += '<div class="text-right"><p class="text-xs text-gray-500">Zieldatum</p><p class="text-sm font-bold '+dueColor+'">'+due.toLocaleDateString('de-DE')+'</p>';
        h += '<p class="text-xs '+dueColor+'">'+(daysLeft<0?Math.abs(daysLeft)+' Tage ueberfaellig':daysLeft+' Tage verbleibend')+'</p></div>';
    }
    h += '</div>';

    // PHASE 0
    if(stage === 'phase0') {
        h += '<div class="vit-card p-6 mb-6" style="background:linear-gradient(135deg,#1a1a1a,#2a2a2a);color:white;">';
        h += '<div class="flex items-start space-x-4"><div class="w-16 h-16 rounded-xl flex items-center justify-center text-3xl flex-shrink-0" style="background:rgba(239,125,0,0.2);">\u{1F680}</div>';
        h += '<div><h2 class="text-lg font-bold text-vit-orange mb-2">Willkommen bei BikeEngine!</h2>';
        h += '<p class="text-sm text-gray-300 mb-3">Du bist im kostenlosen Akademiezugang. Lerne vit:bikes kennen und entscheide in deinem Tempo.</p>';
        h += '<div class="grid grid-cols-2 gap-3 mt-4">';
        h += '<div class="p-3 rounded-lg" style="background:rgba(255,255,255,0.05);"><p class="text-xs text-gray-400">Kosten</p><p class="text-sm font-bold text-white">Kostenlos</p></div>';
        h += '<div class="p-3 rounded-lg" style="background:rgba(255,255,255,0.05);"><p class="text-xs text-gray-400">Verpflichtung</p><p class="text-sm font-bold text-white">Keine</p></div>';
        h += '</div></div></div></div>';

        var hasApplied = onboardingActionsLog.some(function(a){ return a.action_type === 'apply_part1'; });
        h += '<div class="vit-card p-6 mb-6 border-2 border-dashed border-vit-orange">';
        h += '<h3 class="font-bold text-gray-800 mb-3">\u{1F3AF} Naechster Schritt: Trainingsphase Part 1</h3>';
        h += '<p class="text-sm text-gray-600 mb-4">Bewirb dich fuer die Trainingsphase Part 1 (Strategie & Qualifizierung). 3 Monate, 7.000\u20AC netto (BAFA moeglich).</p>';
        h += '<div class="grid grid-cols-3 gap-3 mb-4">';
        h += '<div class="p-3 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Dauer</p><p class="text-sm font-bold">3 Monate</p></div>';
        h += '<div class="p-3 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">Kosten</p><p class="text-sm font-bold">7.000\u20AC</p></div>';
        h += '<div class="p-3 bg-orange-50 rounded-lg text-center"><p class="text-xs text-gray-500">BAFA</p><p class="text-sm font-bold text-green-600">Moeglich \u2713</p></div>';
        h += '</div>';
        if(hasApplied) {
            h += '<div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center"><span class="text-green-600 font-semibold text-sm">\u2705 Bewerbung eingereicht \u2013 wir melden uns!</span></div>';
        } else {
            h += '<button onclick="applyForPart1()" class="w-full py-3 bg-vit-orange text-white rounded-lg font-bold text-sm hover:opacity-90 transition">Jetzt fuer Trainingsphase Part 1 bewerben \u2192</button>';
        }
        h += '</div>';
    }

    // PART 1 / PART 2
    if(stage === 'part1' || stage === 'part2') {
        var milestones = ONBOARDING_MILESTONES[stage] || [];
        var doneCount = 0;
        milestones.forEach(function(m) { if(getMilestoneStatus(m.key) === 'done') doneCount++; });
        var progress = milestones.length > 0 ? Math.round(doneCount / milestones.length * 100) : 0;

        h += '<div class="vit-card p-6 mb-6" style="background:linear-gradient(135deg,#1a1a1a,#2a2a2a);color:white;">';
        h += '<div class="flex items-center justify-between flex-wrap gap-4">';
        h += '<div class="flex items-center space-x-4"><div class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl" style="background:rgba(239,125,0,0.2);">'+stageIcons[stage]+'</div>';
        h += '<div><h2 class="text-lg font-bold text-vit-orange">'+stageNames[stage]+'</h2>';
        if(stage==='part1') h += '<p class="text-xs text-gray-400">Strategisches Fundament \u00B7 7.000\u20AC netto \u00B7 3 Monate</p>';
        else h += '<p class="text-xs text-gray-400">Operative Integration \u00B7 2% + 800\u20AC/Monat \u00B7 9 Monate</p>';
        h += '</div></div>';
        h += '<div class="text-center"><div class="relative w-16 h-16"><svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#EF7D00" stroke-width="3" stroke-dasharray="'+progress+', 100"/></svg><div class="absolute inset-0 flex items-center justify-center"><span class="text-sm font-bold text-white">'+progress+'%</span></div></div>';
        h += '<p class="text-[10px] text-gray-400 mt-1">'+doneCount+'/'+milestones.length+'</p></div>';
        h += '</div></div>';

        if(SESSION.stage_status === 'extended' && stage === 'part1') {
            h += '<div class="vit-card p-4 mb-4 border-l-4 border-red-500 bg-red-50"><p class="text-sm font-bold text-red-700">\u26A0\uFE0F Verlaengerung aktiv \u2013 2.000\u20AC netto/Monat</p></div>';
        }

        // Milestones
        h += '<div class="vit-card p-6 mb-6"><div class="flex items-center justify-between mb-4"><h2 class="h2-headline text-gray-800">Meilensteine</h2>';
        h += '<span class="text-xs text-gray-500">'+doneCount+'/'+milestones.length+'</span></div>';
        h += '<div class="w-full bg-gray-200 rounded-full h-2 mb-6"><div class="bg-vit-orange h-2 rounded-full" style="width:'+progress+'%"></div></div>';
        h += '<div class="space-y-3">';
        milestones.forEach(function(m) {
            var status = getMilestoneStatus(m.key);
            var isDone = status === 'done';
            var isIP = status === 'in_progress';
            var bgClass = isDone ? 'bg-green-50' : isIP ? 'bg-white border-2 border-vit-orange' : 'bg-gray-50';
            h += '<div class="flex items-center space-x-3 p-3 rounded-lg '+bgClass+'">';
            h += '<button onclick="toggleMilestone(\''+m.key+'\')" class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 cursor-pointer '+(isDone?'bg-green-500 border-green-500 text-white':'border-gray-300 hover:border-vit-orange')+'">'+(isDone?'\u2713':'')+'</button>';
            h += '<div class="flex-1"><span class="text-sm '+(isDone?'text-gray-500 line-through':'text-gray-700')+' font-medium">'+m.title+'</span>';
            h += '<p class="text-xs text-gray-400">'+m.description+'</p></div>';
            if(isDone) h += '<span class="text-xs text-green-600 font-semibold">Erledigt</span>';
            else if(isIP) h += '<span class="px-2 py-1 bg-vit-orange text-white text-[10px] rounded font-semibold">In Arbeit</span>';
            else if(m.required) h += '<span class="text-[10px] text-red-400 font-semibold">Pflicht</span>';
            h += '</div>';
        });
        h += '</div></div>';

        var transition = evaluateTransitions();
        if(transition.canAdvance) {
            h += '<div class="vit-card p-6 mb-6 border-2 border-green-400 bg-green-50">';
            h += '<h3 class="font-bold text-green-700 mb-2">\u{1F389} Alle Meilensteine erreicht!</h3>';
            h += '<p class="text-sm text-green-600 mb-4">Uebergang zu '+(stage==='part1'?'Part 2':'Partner')+' kann freigegeben werden.</p>';
            if(isHQUser) {
                h += '<button onclick="executeTransition(\''+transition.nextStage+'\')" class="px-6 py-2.5 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700">'+(stage==='part1'?'Part 2 freigeben':'Partner freischalten')+' \u2192</button>';
            } else {
                h += '<p class="text-xs text-gray-500 italic">\u23F3 Warte auf HQ-Freigabe</p>';
            }
            h += '</div>';
        }
    }

    // PARTNER
    if(stage === 'partner') {
        h += '<div class="vit-card p-6 mb-6" style="background:linear-gradient(135deg,#065f46,#047857);color:white;">';
        h += '<div class="flex items-center space-x-4"><div class="w-16 h-16 rounded-xl flex items-center justify-center text-3xl" style="background:rgba(255,255,255,0.15);">\u{1F3C6}</div>';
        h += '<div><h2 class="text-xl font-bold">Voller Partnerstandort</h2>';
        h += '<p class="text-sm text-green-200">Alle Module und Features sind freigeschaltet.</p></div></div></div>';
        h += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
        [['verkauf','\u{1F4C8}','Verkauf'],['controlling','\u{1F4CA}','Controlling'],['marketing','\u{1F4E2}','Marketing'],['wissen','\u{1F4DA}','Wissen']].forEach(function(v) {
            h += '<button onclick="showView(\''+v[0]+'\')" class="vit-card p-4 hover:shadow-lg transition-shadow text-center"><p class="text-2xl mb-1">'+v[1]+'</p><p class="text-xs font-semibold text-gray-700">'+v[2]+'</p></button>';
        });
        h += '</div>';
    }

    // Help
    h += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">';
    h += '<div class="vit-card p-6"><h3 class="font-semibold text-gray-800 mb-4">\u{1F4DE} Brauchst du Hilfe?</h3>';
    h += '<button onclick="showView(\'support\')" class="w-full bg-vit-orange text-white py-2 rounded-lg hover:opacity-90 font-semibold text-sm">Support kontaktieren</button></div>';
    h += '<div class="vit-card p-6"><h3 class="font-semibold text-gray-800 mb-4">\u{1F4DA} Ressourcen</h3>';
    h += '<div class="space-y-2 text-sm"><a href="#" class="block text-vit-orange hover:underline" onclick="showView(\'wissen\');return false;">\u2192 Akademie</a>';
    h += '<a href="#" class="block text-vit-orange hover:underline">\u2192 FAQ</a></div></div></div>';

    container.innerHTML = h;
}

function toggleMilestone(key) {
    var current = getMilestoneStatus(key);
    var next = current === 'todo' ? 'in_progress' : current === 'in_progress' ? 'done' : 'todo';
    setMilestoneStatus(key, next);
    renderOnboardingView();
}

// HQ Onboarding Management
var hqOnboardingAccounts = [
    { id:'ext-001', name:'Radhaus Koeln', stage:'phase0', stage_status:'active', contact:'Thomas Mueller', email:'mueller@radhaus.de', applied:false },
    { id:'ext-002', name:'BikeShop Dresden', stage:'phase0', stage_status:'active', contact:'Sabine Weber', email:'weber@bikeshop-dd.de', applied:true, applied_at:'2025-02-10' },
    { id:'ext-003', name:'Zweirad Frank', stage:'part1', stage_status:'active', contact:'Peter Frank', email:'frank@zweirad-frank.de', started:'2025-01-15', due:'2025-04-15', progress:50 },
    { id:'ext-004', name:'Fahrradland Stuttgart', stage:'part1', stage_status:'extended', contact:'Lisa Schmidt', email:'schmidt@fahrradland.de', started:'2024-10-01', due:'2025-01-01', progress:83 },
    { id:'ext-005', name:'VeloPlus Hamburg', stage:'part2', stage_status:'active', contact:'Jan Hansen', email:'hansen@veloplus.de', started:'2025-01-01', due:'2025-10-01', progress:29 }
];

function showHqOnbTab(tab) {
    document.querySelectorAll('.hq-onb-tab').forEach(function(t) {
        t.classList.remove('border-vit-orange','text-vit-orange');
        t.classList.add('border-transparent','text-gray-500');
    });
    document.querySelectorAll('.hq-onb-tab-content').forEach(function(c) { c.style.display = 'none'; });
    var activeTab = document.querySelector('.hq-onb-tab[data-tab="'+tab+'"]');
    if(activeTab) { activeTab.classList.add('border-vit-orange','text-vit-orange'); activeTab.classList.remove('border-transparent','text-gray-500'); }
    var content = document.getElementById('hqOnbTab'+tab.charAt(0).toUpperCase()+tab.slice(1));
    if(content) content.style.display = 'block';
}

function renderHqOnboarding() {
    var pipelineEl = document.getElementById('hqOnbPipelineContent');
    if(pipelineEl) {
        var h = '';
        var counts = {phase0:0,part1:0,part2:0,partner:0,applied:0};
        hqOnboardingAccounts.forEach(function(a) { counts[a.stage]++; if(a.applied) counts.applied++; });

        h += '<div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">';
        h += '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-gray-600">'+counts.phase0+'</p><p class="text-xs text-gray-500">Phase 0</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-vit-orange">'+counts.applied+'</p><p class="text-xs text-gray-500">Bewerbungen</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold" style="color:#6d28d9">'+counts.part1+'</p><p class="text-xs text-gray-500">Part 1</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-blue-600">'+counts.part2+'</p><p class="text-xs text-gray-500">Part 2</p></div>';
        h += '<div class="vit-card p-4 text-center"><p class="text-2xl font-bold text-green-600">'+counts.partner+'</p><p class="text-xs text-gray-500">Partner</p></div>';
        h += '</div>';

        h += '<div class="vit-card overflow-hidden"><table class="w-full text-sm"><thead><tr class="bg-gray-50 border-b">';
        h += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Standort</th>';
        h += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Kontakt</th>';
        h += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Stage</th>';
        h += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Status</th>';
        h += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Fortschritt</th>';
        h += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Aktion</th>';
        h += '</tr></thead><tbody>';

        var stC = {phase0:'bg-gray-100 text-gray-600',part1:'bg-purple-100 text-purple-700',part2:'bg-blue-100 text-blue-700',partner:'bg-green-100 text-green-700'};
        var stL = {phase0:'Phase 0',part1:'Part 1',part2:'Part 2',partner:'Partner'};
        var ssC = {active:'bg-green-100 text-green-700',paused:'bg-yellow-100 text-yellow-700',extended:'bg-red-100 text-red-700'};

        hqOnboardingAccounts.forEach(function(a) {
            h += '<tr class="border-b hover:bg-gray-50">';
            h += '<td class="px-4 py-3 font-semibold text-gray-800">'+a.name+'</td>';
            h += '<td class="px-4 py-3 text-gray-600">'+a.contact+'<br><span class="text-xs text-gray-400">'+a.email+'</span></td>';
            h += '<td class="px-4 py-3 text-center"><span class="inline-block px-2 py-1 rounded text-[10px] font-bold '+(stC[a.stage]||'')+'">'+stL[a.stage]+'</span></td>';
            h += '<td class="px-4 py-3 text-center"><span class="inline-block px-2 py-1 rounded text-[10px] font-bold '+(ssC[a.stage_status]||'bg-gray-100 text-gray-600')+'">'+a.stage_status+'</span></td>';
            h += '<td class="px-4 py-3 text-center">';
            if(a.progress !== undefined) {
                h += '<div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-vit-orange h-2 rounded-full" style="width:'+a.progress+'%"></div></div><span class="text-[10px] text-gray-500">'+a.progress+'%</span>';
            } else { h += '<span class="text-xs text-gray-400">\u2013</span>'; }
            h += '</td><td class="px-4 py-3 text-center">';
            if(a.applied && a.stage === 'phase0') {
                h += '<button onclick="hqApprovePart1(\''+a.id+'\')" class="px-3 py-1 bg-vit-orange text-white rounded text-xs font-semibold hover:opacity-90">Einladen</button>';
            } else if(a.stage === 'part1' || a.stage === 'part2') {
                h += '<button class="px-3 py-1 bg-gray-100 text-gray-600 rounded text-xs font-semibold hover:bg-gray-200">Details</button>';
            } else { h += '<span class="text-xs text-gray-400">\u2013</span>'; }
            h += '</td></tr>';
        });
        h += '</tbody></table></div>';
        pipelineEl.innerHTML = h;
    }

    // Bewerbungen
    var bewEl = document.getElementById('hqOnbBewerbungenContent');
    if(bewEl) {
        var apps = hqOnboardingAccounts.filter(function(a) { return a.applied && a.stage === 'phase0'; });
        var bh = '';
        if(apps.length === 0) { bh = '<div class="vit-card p-8 text-center text-gray-400 text-sm">Keine offenen Bewerbungen</div>'; }
        else apps.forEach(function(a) {
            bh += '<div class="vit-card p-6 mb-4 border-l-4 border-vit-orange"><div class="flex items-center justify-between flex-wrap gap-4"><div>';
            bh += '<h3 class="font-bold text-gray-800">'+a.name+'</h3><p class="text-sm text-gray-500">'+a.contact+' \u00B7 '+a.email+'</p>';
            bh += '<p class="text-xs text-gray-400 mt-1">Beworben: '+(a.applied_at||'?')+'</p></div>';
            bh += '<div class="flex space-x-2"><button onclick="hqApprovePart1(\''+a.id+'\')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700">\u2713 Einladen</button>';
            bh += '<button class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200">\u2717 Ablehnen</button></div></div></div>';
        });
        bewEl.innerHTML = bh;
    }

    // Log
    var logEl = document.getElementById('hqOnbLogContent');
    if(logEl) {
        var lh = '<div class="vit-card overflow-hidden">';
        if(onboardingActionsLog.length === 0) { lh += '<div class="p-8 text-center text-gray-400 text-sm">Noch keine Aktionen</div>'; }
        else {
            lh += '<table class="w-full text-sm"><thead><tr class="bg-gray-50 border-b"><th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Zeit</th><th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Aktion</th><th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Akteur</th><th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Details</th></tr></thead><tbody>';
            onboardingActionsLog.slice().reverse().forEach(function(a) {
                lh += '<tr class="border-b"><td class="px-4 py-3 text-xs text-gray-500">'+new Date(a.created_at).toLocaleString('de-DE')+'</td><td class="px-4 py-3 font-semibold">'+a.action_type+'</td><td class="px-4 py-3 text-gray-600">'+a.actor+'</td><td class="px-4 py-3 text-xs text-gray-500">'+JSON.stringify(a.payload)+'</td></tr>';
            });
            lh += '</tbody></table>';
        }
        lh += '</div>';
        logEl.innerHTML = lh;
    }
}

function hqApprovePart1(accountId) {
    var account = hqOnboardingAccounts.find(function(a) { return a.id === accountId; });
    if(!account) return;
    if(!confirm('\"'+account.name+'\" zur Trainingsphase Part 1 einladen?')) return;
    account.stage = 'part1';
    account.stage_status = 'active';
    account.applied = false;
    account.started = new Date().toISOString().split('T')[0];
    var d = new Date(); d.setDate(d.getDate()+90);
    account.due = d.toISOString().split('T')[0];
    account.progress = 0;
    logOnboardingAction('invite_part1', { account: account.name });
    renderHqOnboarding();
    alert('\u2705 ' + account.name + ' wurde zur Trainingsphase Part 1 eingeladen!');
}

// â•â•â• DEMO SYSTEM: Password Protection + Frontend Demo Data â•â•â•
var _demoPendingLevel = null;
var _demoPendingStage = null;
var _demoAuthenticated = false;
var DEMO_ACTIVE = false;

// Quick-switch demo function for testing all account levels
async function switchDemoAccount(level, stage) {
    var ls = document.getElementById('loginScreen');
    var ma = document.getElementById('mainApp');
    if(ls) ls.style.display = 'none';
    if(ma) ma.style.display = 'block';

    DEMO_ACTIVE = true;
    SESSION.account_level = level;
    SESSION.stage = stage || 'partner';
    SESSION.stage_status = 'active';
    SESSION.account_id = 'demo-'+level;
    SESSION.account_name = 'Demo '+level;

    // Set sbUser so DB operations (feedback, etc.) work
    var demoUserId = level === 'hq' ? 'dd000000-0000-0000-0000-000000000001' : 'dd000000-0000-0000-0000-000000000002';
    var demoEmail = level === 'hq' ? 'demo-hq@vitbikes.de' : 'demo-standort@vitbikes.de';
    window.sbUser = { id: demoUserId, email: demoEmail };
    window.sbProfile = { id: demoUserId, email: demoEmail, name: 'Demo User', is_hq: level === 'hq', status: 'demo' };

    if(level === 'extern') {
        currentRole = 'external_owner';
        currentRoles = ['external_owner'];
        SESSION.stage = stage || 'phase0';
    } else if(level === 'hq') {
        currentRole = 'hq';
        currentRoles = ['hq'];
    } else {
        currentRole = 'inhaber';
        currentRoles = ['inhaber'];
    }

    if(stage === 'part1') {
        SESSION.stage_started_at = new Date(Date.now() - 30*24*60*60*1000).toISOString();
        SESSION.stage_due_at = new Date(Date.now() + 60*24*60*60*1000).toISOString();
        initMilestonesForStage('part1');
    } else if(stage === 'part2') {
        SESSION.stage_started_at = new Date(Date.now() - 60*24*60*60*1000).toISOString();
        SESSION.stage_due_at = new Date(Date.now() + 210*24*60*60*1000).toISOString();
        initMilestonesForStage('part2');
    }

    // Inject demo banner
    injectDemoBanner(level, stage);
    // Fill demo data into widgets
    fillDemoWidgets(level, stage);

    updateUIForRole();
    try { await loadModulStatus(); } catch(e) { try { applyModulStatus(); } catch(e2) {} }
    if(level === 'extern') showView('externHome');
    else if(level === 'hq') { switchViewMode('hq'); fillDemoHQ(); }
    else showView('home');

    // Safety: re-fill demo data after any async DB calls settle
    if(level !== 'extern') {
        setTimeout(function() { fillDemoWidgets(level, stage); }, 500);
    }
}

function injectDemoBanner(level, stage) {
    var existing = document.getElementById('demoBannerTop');
    if (existing) existing.remove();
    var labels = {'extern':'Extern Â· Phase 0','hq':'HQ-Modus'};
    if(level==='standort') labels.standort = 'Standort Â· ' + (stage==='part1'?'Part 1':stage==='part2'?'Part 2':'Partner');
    var label = labels[level] || level;
    var banner = document.createElement('div');
    banner.id = 'demoBannerTop';
    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(90deg,#EF7D00,#F59E0B);color:white;text-align:center;padding:6px 16px;font-size:12px;font-weight:700;letter-spacing:0.5px;display:flex;align-items:center;justify-content:center;gap:12px;';
    banner.innerHTML = 'ðŸŽ­ DEMO-MODUS: ' + label + ' <span style="font-weight:400;opacity:0.85">â€“ Alle Daten sind fiktiv</span> <button onclick="exitDemoMode()" style="margin-left:12px;background:rgba(255,255,255,0.25);border:none;color:white;padding:2px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">âœ• Demo beenden</button>';
    document.body.prepend(banner);
    // Shift main content down
    var app = document.getElementById('mainApp');
    if(app) app.style.marginTop = '34px';
}

function exitDemoMode() {
    DEMO_ACTIVE = false;
    var banner = document.getElementById('demoBannerTop');
    if(banner) banner.remove();
    var app = document.getElementById('mainApp');
    if(app) app.style.marginTop = '0';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

// â•â•â• DEMO DATA: Fill all dashboard widgets with realistic fake data â•â•â•
function fillDemoWidgets(level, stage) {
    // Demo widget data removed for production - widgets load real data from DB via loadWidget* functions
    setTimeout(function() {
        var wt2 = document.getElementById('welcomeText');
        if(wt2) wt2.textContent = level === 'hq' ? 'Willkommen im HQ! ðŸ‘‹' : 'Willkommen! ðŸ‘‹';
    }, 200);
}

// â•â•â• DEMO: HQ-specific data â•â•â•
function fillDemoHQ() {
    // HQ demo data removed for production
}

// â•â•â• DEMO: Override billing module for demo mode â•â•â•
function fillDemoBilling() {
    // Invoices tab
    var inv = document.getElementById('stBillingInvoicesList');
    if(inv) inv.innerHTML = ''
        +'<div class="vit-card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="showDemoInvoiceDetail(1)">'
        +'<div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2">'
        +'<span class="font-mono text-xs text-gray-400">VB-2026-001</span>'
        +'<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-semibold">Bezahlt</span>'
        +'</div><span class="font-bold text-lg">2.618,00 â‚¬</span></div>'
        +'<p class="text-sm text-gray-600">Zeitraum: 2026-01-01 bis 2026-01-31</p>'
        +'</div>'
        +'<div class="vit-card p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="showDemoInvoiceDetail(2)">'
        +'<div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2">'
        +'<span class="font-mono text-xs text-gray-400">VB-2026-002</span>'
        +'<span class="text-xs px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 font-semibold">Finalisiert</span>'
        +'</div><span class="font-bold text-lg">2.754,20 â‚¬</span></div>'
        +'<p class="text-sm text-gray-600">Zeitraum: 2026-02-01 bis 2026-02-28</p>'
        +'</div>'
        +'<div class="vit-card p-4 cursor-pointer hover:shadow-md transition-shadow">'
        +'<div class="flex items-center justify-between mb-2"><div class="flex items-center space-x-2">'
        +'<span class="font-mono text-xs text-gray-400">VB-2025-012</span>'
        +'<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-semibold">Bezahlt</span>'
        +'</div><span class="font-bold text-lg">2.489,50 â‚¬</span></div>'
        +'<p class="text-sm text-gray-600">Zeitraum: 2025-12-01 bis 2025-12-31</p>'
        +'</div>';

    // Payments tab
    var pay = document.getElementById('stBillingPaymentsContent');
    if(pay) pay.innerHTML = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Bezahlt</p><p class="text-2xl font-bold text-green-600">28.734,00 â‚¬</p><p class="text-xs text-gray-400">11 Rechnungen</p></div>'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Offen</p><p class="text-2xl font-bold text-amber-500">2.754,20 â‚¬</p><p class="text-xs text-gray-400">1 Rechnung</p></div>'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400 uppercase font-semibold">Gesamt 2026</p><p class="text-2xl font-bold text-gray-800">5.372,20 â‚¬</p><p class="text-xs text-gray-400">2 Rechnungen</p></div>'
        +'</div>'
        +'<div class="vit-card p-6"><h3 class="font-bold text-sm mb-4">ðŸ“‹ Zahlungsverlauf</h3><div class="space-y-3">'
        +'<div class="flex items-center gap-4 p-3 rounded-lg bg-amber-50 border border-amber-100"><div class="text-xl">ðŸ“¬</div><div class="flex-1"><div class="flex items-center justify-between"><span class="font-mono text-xs font-semibold text-gray-700">VB-2026-002</span><span class="font-bold text-amber-700">2.754,20 â‚¬</span></div><div class="flex items-center justify-between mt-1"><span class="text-xs text-gray-500">2026-02-01 â€“ 2026-02-28</span><span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">Finalisiert</span></div></div></div>'
        +'<div class="flex items-center gap-4 p-3 rounded-lg bg-green-50 border border-green-100"><div class="text-xl">âœ…</div><div class="flex-1"><div class="flex items-center justify-between"><span class="font-mono text-xs font-semibold text-gray-700">VB-2026-001</span><span class="font-bold text-green-700">2.618,00 â‚¬</span></div><div class="flex items-center justify-between mt-1"><span class="text-xs text-gray-500">2026-01-01 â€“ 2026-01-31</span><span class="text-xs text-green-600">Bezahlt am 05.02.2026</span></div></div></div>'
        +'<div class="flex items-center gap-4 p-3 rounded-lg bg-green-50 border border-green-100"><div class="text-xl">âœ…</div><div class="flex-1"><div class="flex items-center justify-between"><span class="font-mono text-xs font-semibold text-gray-700">VB-2025-012</span><span class="font-bold text-green-700">2.489,50 â‚¬</span></div><div class="flex items-center justify-between mt-1"><span class="text-xs text-gray-500">2025-12-01 â€“ 2025-12-31</span><span class="text-xs text-green-600">Bezahlt am 08.01.2026</span></div></div></div>'
        +'</div></div>';

    // Strategy tab
    var str = document.getElementById('stBillingStrategyContent');
    if(str) str.innerHTML = '<div class="vit-card p-6">'
        +'<div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">Jahresstrategie 2026</h3><span class="text-sm font-semibold">ðŸ”’ Gesperrt (verbindlich)</span></div>'
        +'<div class="grid grid-cols-2 gap-4">'
        +'<div class="p-4 bg-orange-50 rounded-lg"><p class="text-xs text-gray-400">Plan-Umsatz</p><p class="text-xl font-bold text-vit-orange">2.400.000 â‚¬</p><p class="text-xs text-gray-500">200.000 â‚¬ / Monat</p></div>'
        +'<div class="p-4 bg-blue-50 rounded-lg"><p class="text-xs text-gray-400">Marketing-Budget</p><p class="text-xl font-bold text-blue-600">24.000 â‚¬</p><p class="text-xs text-gray-500">2.000 â‚¬ / Monat</p></div>'
        +'</div></div>';

    // Costs tab
    var costs = document.getElementById('stBillingCostsContent');
    if(costs) costs.innerHTML = '<div class="vit-card p-6">'
        +'<h3 class="font-bold text-lg mb-4">Monatliche KostenaufschlÃ¼sselung</h3>'
        +'<table class="w-full text-sm"><tbody>'
        +'<tr class="border-b"><td class="py-2">GrundgebÃ¼hr</td><td class="py-2 text-right font-mono">800,00 â‚¬</td></tr>'
        +'<tr class="border-b"><td class="py-2">Umsatzbeteiligung (80% Ã— 2% Ã— 200.000 â‚¬)</td><td class="py-2 text-right font-mono">3.200,00 â‚¬</td></tr>'
        +'<tr class="border-b"><td class="py-2">Online-Werbebudget <span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-semibold">Durchlaufposten</span><br><span class="text-[10px] text-gray-400">24.000 â‚¬ / 12 â€“ flieÃŸt 100% in Google/Meta Ads</span></td><td class="py-2 text-right font-mono">2.000,00 â‚¬</td></tr>'
        +'<tr class="border-b"><td class="py-2">Toolkosten (3 Nutzer)</td><td class="py-2 text-right font-mono">147,00 â‚¬</td></tr>'
        +'<tr class="font-bold text-lg"><td class="pt-3">Netto gesamt</td><td class="pt-3 text-right font-mono text-vit-orange">6.147,00 â‚¬</td></tr>'
        +'<tr><td class="py-1 text-gray-400">zzgl. 19% MwSt.</td><td class="py-1 text-right font-mono text-gray-400">1.167,93 â‚¬</td></tr>'
        +'<tr class="font-bold text-xl border-t"><td class="pt-2">Brutto</td><td class="pt-2 text-right font-mono text-vit-orange">7.314,93 â‚¬</td></tr>'
        +'</tbody></table>'
        +'<h4 class="font-semibold mt-6 mb-2">ðŸ”§ Tool-Zuweisungen</h4><div class="space-y-1">'
        +'<div class="flex justify-between text-sm"><span>Sandra E. â€“ Portal Premium</span><span class="font-mono">49,00 â‚¬</span></div>'
        +'<div class="flex justify-between text-sm"><span>Dirk G. â€“ Portal Standard</span><span class="font-mono">49,00 â‚¬</span></div>'
        +'<div class="flex justify-between text-sm"><span>Lisa M. â€“ Portal Standard</span><span class="font-mono">49,00 â‚¬</span></div>'
        +'</div></div>';
}

function showDemoInvoiceDetail(nr) {
    var el = document.getElementById('stBillingInvoicesList');
    if(!el) return;
    var invoices = {
        1: {num:'VB-2026-001',status:'Bezahlt',period:'01.01.2026 â€“ 31.01.2026',netto:'2.200,00',mwst:'418,00',total:'2.618,00',
            lines:[{desc:'GrundgebÃ¼hr Januar 2026',amount:'800,00'},{desc:'Umsatzbeteiligung (80% Ã— 2% Ã— 187.420 â‚¬)',amount:'2.998,72',formula:'0.80 Ã— 0.02 Ã— 187.420 = 2.998,72'},{desc:'Marketing-Umlage',amount:'2.000,00'},{desc:'Abzgl. Quartalsverrechnung Q4/2025',amount:'-1.598,72'}]},
        2: {num:'VB-2026-002',status:'Finalisiert',period:'01.02.2026 â€“ 28.02.2026',netto:'2.314,45',mwst:'439,75',total:'2.754,20',
            lines:[{desc:'GrundgebÃ¼hr Februar 2026',amount:'800,00'},{desc:'Umsatzbeteiligung Vorauszahlung',amount:'3.200,00',formula:'0.80 Ã— 0.02 Ã— 200.000 (Plan) = 3.200'},{desc:'Marketing-Umlage',amount:'2.000,00'},{desc:'Portal-Tools (3 Nutzer)',amount:'147,00'},{desc:'Abzgl. FrÃ¼hbucher-Rabatt',amount:'-832,55'}]}
    };
    var inv = invoices[nr]; if(!inv) return;
    var h = '<button onclick="fillDemoBilling()" class="text-xs text-vit-orange hover:underline mb-4 inline-block">â† ZurÃ¼ck zur Ãœbersicht</button>';
    h += '<div class="vit-card p-6 mb-4"><div class="flex items-center justify-between mb-4">';
    h += '<div><h3 class="font-bold text-lg">'+inv.num+'</h3><p class="text-xs text-gray-400">'+inv.period+'</p></div>';
    h += '<div class="text-right"><span class="text-xs px-2 py-0.5 rounded-full '+(inv.status==='Bezahlt'?'bg-green-100 text-green-700':'bg-amber-100 text-amber-700')+' font-semibold">'+inv.status+'</span>';
    h += '<p class="text-2xl font-bold text-vit-orange mt-2">'+inv.total+' â‚¬</p></div></div>';
    h += '<table class="w-full text-sm mb-4"><thead class="text-xs text-gray-500 uppercase border-b"><tr><th class="text-left py-2">Position</th><th class="text-right py-2">Betrag</th></tr></thead><tbody>';
    inv.lines.forEach(function(li){
        h += '<tr class="border-b border-gray-100"><td class="py-2"><p class="font-medium">'+li.desc+'</p>';
        if(li.formula) h += '<p class="text-xs text-blue-600 mt-0.5">ðŸ“ '+li.formula+'</p>';
        h += '</td><td class="py-2 text-right font-semibold">'+li.amount+' â‚¬</td></tr>';
    });
    h += '<tr class="border-t-2"><td class="py-2 font-semibold">Netto</td><td class="py-2 text-right font-semibold">'+inv.netto+' â‚¬</td></tr>';
    h += '<tr><td class="py-1 text-gray-500 text-xs">MwSt (19%)</td><td class="py-1 text-right text-xs text-gray-500">'+inv.mwst+' â‚¬</td></tr>';
    h += '<tr class="border-t-2"><td class="py-2 font-bold text-lg">Gesamt</td><td class="py-2 text-right font-bold text-lg text-vit-orange">'+inv.total+' â‚¬</td></tr>';
    h += '</tbody></table></div>';
    el.innerHTML = h;
}

// Override billing load functions to use demo data when in demo mode
var _origLoadStInvoices = window.loadStandortInvoices;
var _origLoadStPayments = window.loadStandortPayments;
var _origLoadStStrategy = window.loadStandortStrategy;
var _origLoadStCosts = window.loadStandortCosts;
window.loadStandortInvoices = function() { if(DEMO_ACTIVE) { fillDemoBilling(); return; } if(_origLoadStInvoices) return _origLoadStInvoices(); };
window.loadStandortPayments = function() { if(DEMO_ACTIVE) { fillDemoBilling(); return; } if(_origLoadStPayments) return _origLoadStPayments(); };
window.loadStandortStrategy = function() { if(DEMO_ACTIVE) { fillDemoBilling(); return; } if(_origLoadStStrategy) return _origLoadStStrategy(); };
window.loadStandortCosts = function() { if(DEMO_ACTIVE) { fillDemoBilling(); return; } if(_origLoadStCosts) return _origLoadStCosts(); };

// â•â•â• DEMO: HQ Billing Overrides â•â•â•
var _origLoadBillingOverview = window.loadBillingOverview;
var _origLoadAllInvoices = window.loadAllInvoices;
var _origLoadStrategies = window.loadStrategies;
var _origLoadProducts = window.loadProducts;
var _origLoadToolPackages = window.loadToolPackages;

window.loadBillingOverview = function() {
    if(!DEMO_ACTIVE) { if(_origLoadBillingOverview) return _origLoadBillingOverview(); return; }
    initBillingMonthSelect();
    // Use timeout to win race against async DB calls from local initBillingModule
    setTimeout(fillDemoHQBillingOverview, 150);
};
window.loadAllInvoices = function() { if(!DEMO_ACTIVE) { if(_origLoadAllInvoices) return _origLoadAllInvoices(); return; } fillDemoHQInvoices(); };
window.loadStrategies = function() { if(!DEMO_ACTIVE) { if(_origLoadStrategies) return _origLoadStrategies(); return; } fillDemoHQStrategies(); };
window.loadProducts = function() { if(!DEMO_ACTIVE) { if(_origLoadProducts) return _origLoadProducts(); return; } fillDemoHQProducts(); };
window.loadToolPackages = function() { if(!DEMO_ACTIVE) { if(_origLoadToolPackages) return _origLoadToolPackages(); return; } fillDemoHQTools(); };

function fillDemoHQBillingOverview() {
    // KPIs
    var kpis = document.getElementById('billingKpis');
    if(kpis) kpis.innerHTML = ''
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Drafts</p><p class="text-2xl font-bold text-blue-600">8</p></div>'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Finalisiert</p><p class="text-2xl font-bold text-amber-500">5</p></div>'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Bezahlt</p><p class="text-2xl font-bold text-green-600">10</p></div>'
        +'<div class="vit-card p-4 text-center"><p class="text-xs text-gray-400">Gesamtvolumen</p><p class="text-2xl font-bold text-vit-orange">56.830 â‚¬</p></div>';
    // Standort table
    var tbl = document.getElementById('billingOverviewTable');
    if(!tbl) return;
    var rows = [
        {name:'Grafrath',strat:'âœ… 2.4M',sepa:'âœ…',total:'2.754,20',status:'finalized',color:'amber'},
        {name:'Berlin-Brandenburg',strat:'âœ… 3.8M',sepa:'âœ…',total:'4.289,00',status:'paid',color:'green'},
        {name:'Witten',strat:'âœ… 1.8M',sepa:'âŒ',total:'1.987,60',status:'draft',color:'blue'},
        {name:'Rottweil',strat:'âœ… 2.0M',sepa:'âœ…',total:'2.156,40',status:'paid',color:'green'},
        {name:'Hamburg',strat:'âœ… 3.2M',sepa:'âœ…',total:'3.845,20',status:'paid',color:'green'},
        {name:'MÃ¼nchen BAL',strat:'âœ… 2.8M',sepa:'âœ…',total:'3.124,80',status:'finalized',color:'amber'},
        {name:'Holzkirchen',strat:'â³ Ausstehend',sepa:'âœ…',total:'â€”',status:'draft',color:'blue'},
        {name:'Lohmar',strat:'âœ… 2.1M',sepa:'âœ…',total:'2.398,00',status:'paid',color:'green'},
        {name:'MÃ¼nster',strat:'âœ… 2.5M',sepa:'âœ…',total:'2.812,50',status:'finalized',color:'amber'},
        {name:'Reutlingen',strat:'âœ… 1.9M',sepa:'âœ…',total:'2.067,30',status:'draft',color:'blue'}
    ];
    var statusLabels = {draft:'ðŸ“ Draft',finalized:'ðŸ“¬ Finalisiert',paid:'âœ… Bezahlt'};
    var statusColors = {draft:'bg-blue-100 text-blue-700',finalized:'bg-amber-100 text-amber-700',paid:'bg-green-100 text-green-700'};
    var h = '';
    rows.forEach(function(r){
        h += '<tr class="border-t hover:bg-gray-50">';
        h += '<td class="p-3 font-semibold">vit:bikes '+r.name+'</td>';
        h += '<td class="p-3 text-center text-xs">'+r.strat+'</td>';
        h += '<td class="p-3 text-center">'+r.sepa+'</td>';
        h += '<td class="p-3 text-right font-mono font-semibold">'+r.total+' â‚¬</td>';
        h += '<td class="p-3 text-center"><span class="text-xs px-2 py-0.5 rounded-full '+statusColors[r.status]+' font-semibold">'+statusLabels[r.status]+'</span></td>';
        h += '<td class="p-3 text-center"><button class="text-xs text-vit-orange hover:underline">Details â†’</button></td>';
        h += '</tr>';
    });
    tbl.innerHTML = h;
}

function fillDemoHQInvoices() {
    var el = document.getElementById('billingInvoicesList');
    if(!el) return;
    var invoices = [
        {num:'VB-2026-023',standort:'Berlin-Brandenburg',period:'Feb 2026',total:'4.289,00',status:'paid',statusLabel:'Bezahlt',sc:'green'},
        {num:'VB-2026-022',standort:'Hamburg',period:'Feb 2026',total:'3.845,20',status:'paid',statusLabel:'Bezahlt',sc:'green'},
        {num:'VB-2026-021',standort:'Grafrath',period:'Feb 2026',total:'2.754,20',status:'finalized',statusLabel:'Finalisiert',sc:'amber'},
        {num:'VB-2026-020',standort:'MÃ¼nchen BAL',period:'Feb 2026',total:'3.124,80',status:'finalized',statusLabel:'Finalisiert',sc:'amber'},
        {num:'VB-2026-019',standort:'MÃ¼nster',period:'Feb 2026',total:'2.812,50',status:'finalized',statusLabel:'Finalisiert',sc:'amber'},
        {num:'VB-2026-018',standort:'Rottweil',period:'Feb 2026',total:'2.156,40',status:'paid',statusLabel:'Bezahlt',sc:'green'},
        {num:'VB-2026-017',standort:'Lohmar',period:'Feb 2026',total:'2.398,00',status:'paid',statusLabel:'Bezahlt',sc:'green'},
        {num:'VB-2026-016',standort:'Witten',period:'Feb 2026',total:'1.987,60',status:'draft',statusLabel:'Draft',sc:'blue'},
        {num:'VB-2026-015',standort:'Reutlingen',period:'Feb 2026',total:'2.067,30',status:'draft',statusLabel:'Draft',sc:'blue'},
        {num:'VB-2026-014',standort:'Holzkirchen',period:'Feb 2026',total:'1.845,00',status:'draft',statusLabel:'Draft',sc:'blue'}
    ];
    el.innerHTML = '<div class="space-y-2">'+invoices.map(function(inv){
        return '<div class="vit-card p-4 hover:shadow-md transition cursor-pointer">'
            +'<div class="flex items-center justify-between mb-1">'
            +'<div class="flex items-center space-x-3"><span class="font-mono text-xs text-gray-400">'+inv.num+'</span>'
            +'<span class="text-xs px-2 py-0.5 rounded-full bg-'+inv.sc+'-100 text-'+inv.sc+'-700 font-semibold">'+inv.statusLabel+'</span></div>'
            +'<span class="font-bold text-lg">'+inv.total+' â‚¬</span></div>'
            +'<p class="text-sm text-gray-500">'+inv.standort+' Â· '+inv.period+'</p></div>';
    }).join('')+'</div>';
}

function fillDemoHQStrategies() {
    var el = document.getElementById('billingStrategiesList');
    if(!el) return;
    var strats = [
        {name:'Grafrath',revenue:'2.400.000',marketing:'24.000',status:'locked',v:2},
        {name:'Berlin-Brandenburg',revenue:'3.800.000',marketing:'36.000',status:'locked',v:1},
        {name:'Hamburg',revenue:'3.200.000',marketing:'30.000',status:'locked',v:1},
        {name:'MÃ¼nchen BAL',revenue:'2.800.000',marketing:'28.000',status:'approved',v:1},
        {name:'Rottweil',revenue:'2.000.000',marketing:'18.000',status:'locked',v:3},
        {name:'Lohmar',revenue:'2.100.000',marketing:'20.000',status:'locked',v:1},
        {name:'Witten',revenue:'1.800.000',marketing:'16.000',status:'locked',v:2},
        {name:'Holzkirchen',revenue:'â€”',marketing:'â€”',status:'missing',v:0}
    ];
    el.innerHTML = strats.map(function(s){
        var badge = s.status==='locked'?'ðŸ”’ Gesperrt':'<span class="text-amber-600">'+(s.status==='approved'?'âœ… Genehmigt':'â³ Ausstehend')+'</span>';
        return '<div class="vit-card p-4"><div class="flex items-center justify-between">'
            +'<div><p class="font-semibold">vit:bikes '+s.name+'</p><p class="text-xs text-gray-400">v'+s.v+' Â· 2026</p></div>'
            +'<div class="text-right"><p class="text-sm">'+badge+'</p></div></div>'
            +(s.revenue!=='â€”'?'<div class="grid grid-cols-2 gap-4 mt-3"><div class="p-2 bg-orange-50 rounded"><p class="text-[10px] text-gray-400">Plan-Umsatz</p><p class="text-sm font-bold text-vit-orange">'+s.revenue+' â‚¬</p></div>'
            +'<div class="p-2 bg-blue-50 rounded"><p class="text-[10px] text-gray-400">Marketing</p><p class="text-sm font-bold text-blue-600">'+s.marketing+' â‚¬</p></div></div>':'')
            +'</div>';
    }).join('');
}

function fillDemoHQProducts() {
    var el = document.getElementById('billingProductsList');
    if(!el) return;
    var products = [
        {name:'GrundgebÃ¼hr',key:'grundgebuehr',price:'800,00',type:'fix',desc:'Monatliche Franchise-GrundgebÃ¼hr'},
        {name:'Umsatzbeteiligung',key:'umsatzbeteiligung',price:'2%',type:'variabel',desc:'Revenue Share auf Basis Plan-Umsatz (80% Vorauszahlung)'},
        {name:'Online-Werbebudget (Durchlaufposten)',key:'marketing_umlage',price:'variabel',type:'variabel',desc:'100% Werbebudget fÃ¼r Google/Meta Ads â€“ kein Honorar an vit:bikes'},
        {name:'Portal Premium',key:'portal_premium',price:'49,00',type:'pro Nutzer',desc:'Vollzugang cockpit inkl. KI-Features'},
        {name:'Portal Standard',key:'portal_standard',price:'49,00',type:'pro Nutzer',desc:'Standard-Zugang cockpit'},
        {name:'Werkstatt-Software',key:'werkstatt_sw',price:'29,00',type:'pro Nutzer',desc:'Werkstatt-Management & Auftragsverwaltung'}
    ];
    el.innerHTML = '<div class="vit-card overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50 text-xs text-gray-500 uppercase"><tr><th class="text-left p-3">Produkt</th><th class="p-3">Key</th><th class="text-right p-3">Preis</th><th class="p-3">Typ</th><th class="p-3">Beschreibung</th></tr></thead><tbody>'
        +products.map(function(p){
            return '<tr class="border-t"><td class="p-3 font-semibold">'+p.name+'</td><td class="p-3 font-mono text-xs text-gray-400">'+p.key+'</td>'
                +'<td class="p-3 text-right font-mono font-semibold">'+p.price+' â‚¬</td><td class="p-3 text-center"><span class="text-xs px-2 py-0.5 rounded-full bg-gray-100">'+p.type+'</span></td>'
                +'<td class="p-3 text-xs text-gray-500">'+p.desc+'</td></tr>';
        }).join('')+'</tbody></table></div>';
}

function fillDemoHQTools() {
    var el = document.getElementById('billingToolsList');
    if(!el) return;
    el.innerHTML = '<div class="vit-card p-4 mb-4"><h3 class="font-semibold mb-3">ðŸ“¦ Tool-Pakete</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4">'
        +'<div class="p-4 border rounded-lg"><p class="font-bold">Portal Premium</p><p class="text-2xl font-bold text-vit-orange mt-1">49 â‚¬<span class="text-xs text-gray-400 font-normal">/Monat</span></p><p class="text-xs text-gray-500 mt-2">Vollzugang, KI-BWA, Sales-Training</p></div>'
        +'<div class="p-4 border rounded-lg"><p class="font-bold">Portal Standard</p><p class="text-2xl font-bold text-blue-600 mt-1">49 â‚¬<span class="text-xs text-gray-400 font-normal">/Monat</span></p><p class="text-xs text-gray-500 mt-2">Basis-Features, Dashboard, CRM</p></div>'
        +'<div class="p-4 border rounded-lg"><p class="font-bold">Werkstatt-Software</p><p class="text-2xl font-bold text-green-600 mt-1">29 â‚¬<span class="text-xs text-gray-400 font-normal">/Monat</span></p><p class="text-xs text-gray-500 mt-2">AuftrÃ¤ge, Lager, Zeiterfassung</p></div>'
        +'</div></div>'
        +'<div class="vit-card p-4"><h3 class="font-semibold mb-3">ðŸ‘¥ Aktive Zuweisungen</h3>'
        +'<table class="w-full text-sm"><thead class="text-xs text-gray-500 uppercase bg-gray-50"><tr><th class="text-left p-3">Nutzer</th><th class="p-3">Standort</th><th class="p-3">Paket</th><th class="text-right p-3">Kosten</th><th class="p-3">Seit</th></tr></thead><tbody>'
        +'<tr class="border-t"><td class="p-3">Sandra Engelmann</td><td class="p-3">Grafrath</td><td class="p-3">Portal Premium</td><td class="p-3 text-right font-semibold">49,00 â‚¬</td><td class="p-3 text-xs text-gray-400">01.01.2026</td></tr>'
        +'<tr class="border-t"><td class="p-3">Dirk Gromann</td><td class="p-3">Grafrath</td><td class="p-3">Portal Standard</td><td class="p-3 text-right font-semibold">49,00 â‚¬</td><td class="p-3 text-xs text-gray-400">01.01.2026</td></tr>'
        +'<tr class="border-t"><td class="p-3">Patrick Henkel</td><td class="p-3">Berlin-Brandenburg</td><td class="p-3">Portal Premium</td><td class="p-3 text-right font-semibold">49,00 â‚¬</td><td class="p-3 text-xs text-gray-400">15.01.2026</td></tr>'
        +'<tr class="border-t"><td class="p-3">Thorsten Guhr</td><td class="p-3">Witten</td><td class="p-3">Portal Premium</td><td class="p-3 text-right font-semibold">49,00 â‚¬</td><td class="p-3 text-xs text-gray-400">01.02.2026</td></tr>'
        +'<tr class="border-t"><td class="p-3">Volker Schipke</td><td class="p-3">Rottweil</td><td class="p-3">Portal Standard</td><td class="p-3 text-right font-semibold">49,00 â‚¬</td><td class="p-3 text-xs text-gray-400">15.12.2025</td></tr>'
        +'</tbody></table></div>';
}

console.log('[3-Ebenen] Demo-System with password protection loaded.');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HQ FEEDBACK INBOX + IDEENBOARD INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var hqFbCurrentFilter = 'alle';

window.showHqFeedbackTab = function(tab) {
    document.querySelectorAll('.ideen-tab').forEach(function(b){
        var t = b.getAttribute('data-itab');
        b.className = 'ideen-tab whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm ' + (t===tab ? 'border-vit-orange text-vit-orange' : 'border-transparent text-gray-500');
    });
    document.querySelectorAll('.hq-fb-tab-content').forEach(function(c){ c.style.display = 'none'; });
    var el = document.getElementById(tab === 'ideen' ? 'ideenTabIdeen' : 'ideenTabFeedback');
    if(el) el.style.display = 'block';
    if(tab === 'feedback') renderHqFeedbackInbox();
};

async function renderHqFeedbackInbox() {
    var list = document.getElementById('hqFbList');
    if(!list) return;
    list.innerHTML = '<div class="p-8 text-center text-gray-400">Wird geladen...</div>';

    try {
        var resp = await sb.from('portal_feedback')
            .select('*, users(name, email), standorte(name)')
            .order('created_at', { ascending: false })
            .limit(100);

        if(resp.error) throw resp.error;
        var items = resp.data || [];
        window._hqFbItems = items;

        // KPIs
        var el = function(id){ return document.getElementById(id); };
        if(el('hqFbTotal')) el('hqFbTotal').textContent = items.length;
        if(el('hqFbNeu')) el('hqFbNeu').textContent = items.filter(function(i){ return i.status==='neu'; }).length;
        if(el('hqFbBugs')) el('hqFbBugs').textContent = items.filter(function(i){ return i.kategorie==='bug'; }).length;
        if(el('hqFbWuensche')) el('hqFbWuensche').textContent = items.filter(function(i){ return i.kategorie==='wunsch'; }).length;
        if(el('hqFbIdeen')) el('hqFbIdeen').textContent = items.filter(function(i){ return i.kategorie==='idee'; }).length;

        // Badge (sidebar + tab)
        var badge = document.getElementById('hqFbBadge');
        var tabBadge = document.getElementById('hqFbTabBadge');
        var neuCount = items.filter(function(i){ return i.status==='neu'; }).length;
        if(badge) { badge.textContent = neuCount; badge.style.display = neuCount > 0 ? '' : 'none'; }
        if(tabBadge) { tabBadge.textContent = neuCount; tabBadge.style.display = neuCount > 0 ? '' : 'none'; }

        renderHqFbList(items);
    } catch(err) {
        list.innerHTML = '<div class="p-8 text-center text-red-400">Fehler: '+err.message+'</div>';
    }
}

function renderHqFbList(items) {
    var list = document.getElementById('hqFbList');
    if(!list) return;

    var filtered = items;
    if(hqFbCurrentFilter !== 'alle') {
        filtered = items.filter(function(i){ return i.status === hqFbCurrentFilter; });
    }

    if(!filtered.length) {
        list.innerHTML = '<div class="p-8 text-center text-gray-400">Keine Feedbacks mit diesem Filter.</div>';
        return;
    }

    var catIcons = {bug:'ðŸ›',wunsch:'âœ¨',ux:'ðŸŽ¨',performance:'âš¡',idee:'ðŸ’¡'};
    var catColors = {bug:'bg-red-100 text-red-700',wunsch:'bg-emerald-100 text-emerald-700',ux:'bg-blue-100 text-blue-700',performance:'bg-amber-100 text-amber-700',idee:'bg-purple-100 text-purple-700'};
    var statusLabels = {neu:'ðŸ†• Neu',gesehen:'ðŸ‘ï¸ Gesehen',in_arbeit:'ðŸ”§ In Arbeit',erledigt:'âœ… Erledigt',abgelehnt:'âŒ Abgelehnt'};
    var statusColors = {neu:'bg-amber-100 text-amber-700',gesehen:'bg-blue-100 text-blue-700',in_arbeit:'bg-orange-100 text-orange-700',erledigt:'bg-green-100 text-green-700',abgelehnt:'bg-red-100 text-red-700'};

    list.innerHTML = filtered.map(function(fb){
        var user = fb.users || {};
        var standort = fb.standorte || {};
        var cat = fb.kategorie || 'idee';
        var attachCount = (fb.attachments || []).length;
        var date = new Date(fb.created_at);
        var dateStr = date.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'}) + ' ' + date.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});

        return '<div class="p-4 hover:bg-gray-50 cursor-pointer transition" onclick="openHqFbDetail(\''+fb.id+'\')">'
            +'<div class="flex items-start gap-3">'
            +'<div class="text-2xl">'+(catIcons[cat]||'ðŸ’¬')+'</div>'
            +'<div class="flex-1 min-w-0">'
            +'<div class="flex items-center gap-2 mb-1 flex-wrap">'
            +'<span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(catColors[cat]||'bg-gray-100 text-gray-600')+'">'+cat.charAt(0).toUpperCase()+cat.slice(1)+'</span>'
            +'<span class="text-xs px-2 py-0.5 rounded-full font-semibold '+(statusColors[fb.status]||'bg-gray-100')+'">'+( statusLabels[fb.status]||fb.status)+'</span>'
            +(attachCount ? '<span class="text-xs text-gray-400">ðŸ“Ž '+attachCount+'</span>' : '')
            +'</div>'
            +'<p class="text-sm font-semibold text-gray-800 truncate">'+(fb.titel || fb.beschreibung || 'Kein Text').substring(0,80)+'</p>'
            +'<div class="flex items-center gap-3 mt-1 text-[11px] text-gray-400">'
            +'<span>ðŸ‘¤ '+(user.name||user.email||'Unbekannt')+'</span>'
            +(standort.name ? '<span>ðŸ“ '+standort.name+'</span>' : '')
            +(fb.route ? '<span>ðŸ“„ '+fb.route+'</span>' : '')
            +'<span>'+dateStr+'</span>'
            +'</div>'
            +'</div>'
            +'</div></div>';
    }).join('');
}

window.filterHqFb = function(filter) {
    hqFbCurrentFilter = filter;
    document.querySelectorAll('.hq-fb-filter').forEach(function(b){
        var f = b.getAttribute('data-fbf');
        b.className = 'hq-fb-filter px-3 py-1.5 rounded-full text-xs font-semibold ' + (f===filter ? 'bg-vit-orange text-white' : 'bg-gray-100 text-gray-600');
    });
    if(window._hqFbItems) renderHqFbList(window._hqFbItems);
};

window.openHqFbDetail = async function(id) {
    var fb = (window._hqFbItems||[]).find(function(i){ return i.id===id; });
    if(!fb) return;
    var modal = document.getElementById('hqFbDetailModal');
    var content = document.getElementById('hqFbDetailContent');
    if(!modal || !content) return;

    var catIcons = {bug:'ðŸ›',wunsch:'âœ¨',ux:'ðŸŽ¨',performance:'âš¡',idee:'ðŸ’¡'};
    var user = fb.users || {};
    var standort = fb.standorte || {};
    var bi = fb.browser_info || {};
    var date = new Date(fb.created_at).toLocaleString('de-DE');

    var h = '<div class="flex items-center justify-between mb-4">';
    h += '<div class="flex items-center gap-2"><span class="text-2xl">'+(catIcons[fb.kategorie]||'ðŸ’¬')+'</span><h2 class="text-lg font-bold text-gray-800">'+(fb.titel||'Portal-Feedback')+'</h2></div>';
    h += '<button onclick="document.getElementById(\'hqFbDetailModal\').style.display=\'none\'" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button></div>';

    h += '<div class="grid grid-cols-2 gap-3 mb-4 text-xs">';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Nutzer:</strong> '+(user.name||user.email||'-')+'</div>';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Standort:</strong> '+(standort.name||'HQ')+'</div>';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Route:</strong> '+(fb.route||'-')+'</div>';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Zeitpunkt:</strong> '+date+'</div>';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Browser:</strong> '+(bi.userAgent ? bi.userAgent.substring(0,50)+'â€¦' : '-')+'</div>';
    h += '<div class="bg-gray-50 rounded-lg p-3"><strong>Viewport:</strong> '+(bi.viewport||'-')+'</div>';
    h += '</div>';

    if(fb.beschreibung) {
        h += '<div class="bg-white border border-gray-200 rounded-lg p-4 mb-4"><p class="text-sm text-gray-700 whitespace-pre-wrap">'+fb.beschreibung+'</p></div>';
    }

    // Attachments
    var attachments = fb.attachments || [];
    if(attachments.length) {
        h += '<div class="mb-4"><p class="text-xs font-bold text-gray-500 uppercase mb-2">AnhÃ¤nge ('+attachments.length+')</p>';
        for(var i=0; i<attachments.length; i++) {
            var a = attachments[i];
            var url = sb.storage.from('feedback-attachments').getPublicUrl(a.path).data.publicUrl;
            var signedResp = await sb.storage.from('feedback-attachments').createSignedUrl(a.path, 3600);
            var signedUrl = signedResp.data ? signedResp.data.signedUrl : url;
            if(a.type === 'screenshot') {
                h += '<div class="mb-2"><img src="'+signedUrl+'" class="rounded-lg border max-h-[300px] w-auto" alt="Screenshot"></div>';
            } else if(a.type === 'audio') {
                h += '<div class="mb-2"><audio controls src="'+signedUrl+'" class="w-full"></audio><p class="text-[10px] text-gray-400 mt-1">'+a.name+' ('+formatFbSize(a.size)+')</p></div>';
            } else if(a.type === 'screen') {
                h += '<div class="mb-2"><video controls src="'+signedUrl+'" class="rounded-lg border w-full max-h-[300px]"></video><p class="text-[10px] text-gray-400 mt-1">'+a.name+' ('+formatFbSize(a.size)+')</p></div>';
            }
        }
        h += '</div>';
    }

    // Status changer
    h += '<div class="border-t pt-4 mt-4"><p class="text-xs font-bold text-gray-500 uppercase mb-2">Status Ã¤ndern</p>';
    h += '<div class="flex gap-2 flex-wrap">';
    ['neu','gesehen','in_arbeit','erledigt','abgelehnt'].forEach(function(s){
        var labels = {neu:'ðŸ†• Neu',gesehen:'ðŸ‘ï¸ Gesehen',in_arbeit:'ðŸ”§ In Arbeit',erledigt:'âœ… Erledigt',abgelehnt:'âŒ Abgelehnt'};
        var active = fb.status === s;
        h += '<button onclick="updateFbStatus(\''+id+'\',\''+s+'\')" class="px-3 py-1.5 rounded-lg text-xs font-semibold border transition '+(active?'bg-emerald-500 text-white border-emerald-500':'bg-white text-gray-600 border-gray-200 hover:border-emerald-400')+'">'+labels[s]+'</button>';
    });
    h += '</div></div>';

    // Ideenboard integration button
    h += '<div class="border-t pt-4 mt-4"><button onclick="fbCreateIdeenboardTicket(\''+id+'\')" class="w-full py-2.5 bg-gradient-to-r from-amber-400 to-orange-500 text-white rounded-lg text-sm font-bold hover:opacity-90 transition">ðŸ’¡ Als Idee ins Ideenboard Ã¼bernehmen</button></div>';

    content.innerHTML = h;
    modal.style.display = 'flex';
};

function formatFbSize(bytes) {
    if(!bytes) return '0 B';
    if(bytes < 1024) return bytes + ' B';
    if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1048576).toFixed(1) + ' MB';
}

window.updateFbStatus = async function(id, status) {
    try {
        await sb.from('portal_feedback').update({ status: status, updated_at: new Date().toISOString() }).eq('id', id);
        document.getElementById('hqFbDetailModal').style.display = 'none';
        renderHqFeedbackInbox();
    } catch(e) { alert('Fehler: '+e.message); }
};

// â”€â”€ Ideenboard Integration â”€â”€
window.fbCreateIdeenboardTicket = async function(fbId) {
    var fb = (window._hqFbItems||[]).find(function(i){ return i.id===fbId; });
    if(!fb) return;
    var catLabels = {bug:'Bug',wunsch:'Wunsch',ux:'UX',performance:'Performance',idee:'Idee'};
    var title = '[Portal-Feedback] ' + (catLabels[fb.kategorie]||fb.kategorie) + ' â€“ ' + (fb.route||'Allgemein');
    if(fb.titel) title += ': ' + fb.titel;

    var user = fb.users || {};
    var standort = fb.standorte || {};
    var desc = (fb.beschreibung||'Kein Text') + '\n\n---\n';
    desc += 'ðŸ“§ Von: ' + (user.name||user.email||'Unbekannt') + '\n';
    desc += 'ðŸ“ Standort: ' + (standort.name||'HQ') + '\n';
    desc += 'ðŸ“„ Route: ' + (fb.route||'-') + '\n';
    desc += 'ðŸ·ï¸ Kategorie: ' + (catLabels[fb.kategorie]||fb.kategorie) + '\n';
    desc += 'ðŸ“… Datum: ' + new Date(fb.created_at).toLocaleString('de-DE') + '\n';
    if((fb.attachments||[]).length) desc += 'ðŸ“Ž AnhÃ¤nge: ' + fb.attachments.length + ' Dateien\n';

    try {
        var resp = await sb.from('ideas').insert({
            standort_id: fb.standort_id,
            user_id: fb.user_id,
            titel: title.substring(0,200),
            beschreibung: desc,
            kategorie: fb.kategorie === 'bug' ? 'problem' : (fb.kategorie === 'wunsch' || fb.kategorie === 'idee' ? 'feature' : 'sonstiges'),
            status: 'neu',
            quelle: 'portal-feedback'
        });
        if(resp.error) throw resp.error;

        // Mark feedback as linked
        await sb.from('portal_feedback').update({ status: 'gesehen' }).eq('id', fbId);
        alert('âœ… Idee wurde ins Ideenboard Ã¼bernommen!');
        document.getElementById('hqFbDetailModal').style.display = 'none';
        renderHqFeedbackInbox();
    } catch(e) {
        // If ideas table doesn't exist yet, fall back gracefully
        if(e.message && e.message.indexOf('ideas') >= 0) {
            alert('ðŸ’¡ Ideenboard-Tabelle noch nicht vorhanden. Feedback wurde als "gesehen" markiert.');
            await sb.from('portal_feedback').update({ status: 'gesehen' }).eq('id', fbId);
            document.getElementById('hqFbDetailModal').style.display = 'none';
            renderHqFeedbackInbox();
        } else {
            alert('Fehler: ' + e.message);
        }
    }
};

// â”€â”€ Badge counter on load â”€â”€
(function(){
    var badgeInterval = setInterval(async function(){
        if(typeof sb === 'undefined' || typeof currentRole === 'undefined' || currentRole !== 'hq') return;
        if(typeof sbUser === 'undefined' || !sbUser) return;
        clearInterval(badgeInterval);
        try {
            var resp = await sb.from('portal_feedback').select('id', { count: 'exact', head: true }).eq('status','neu');
            var count = resp.count || 0;
            var badge = document.getElementById('hqFbBadge');
            if(badge) { badge.textContent = count; badge.style.display = count > 0 ? '' : 'none'; }
        } catch(e) { /* silent */ }
    }, 2000);
})();
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â• PORTAL FEEDBACK WIDGET â•â•â• -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â”€â”€ Feedback Widget Styles â”€â”€ */
@keyframes fbPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239,125,0,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(239,125,0,0); }
}
@keyframes fbSlideUp {
    from { opacity:0; transform:translateY(20px) scale(0.95); }
    to { opacity:1; transform:translateY(0) scale(1); }
}
@keyframes fbSlideDown {
    from { opacity:0; transform:translateY(-10px); }
    to { opacity:1; transform:translateY(0); }
}
@keyframes fbFadeIn {
    from { opacity:0; }
    to { opacity:1; }
}
@keyframes fbRecPulse {
    0%, 100% { opacity:1; }
    50% { opacity:0.3; }
}
#fbWidget {
    position:fixed; top:0; left:50%; transform:translateX(-50%); z-index:9999; font-family:'Open Sans',sans-serif;
}
@media (max-width: 768px) {
    #fbWidget { top:50%; left:auto; right:0; transform:translateY(-50%) translateX(0); }
    #fbTrigger { border-radius:14px 0 0 14px !important; padding:10px 10px 10px 12px !important; writing-mode:vertical-rl; text-orientation:mixed; gap:5px !important; font-size:11px !important; }
    #fbTrigger span { display:none; }
}
#fbTrigger {
    display:flex; align-items:center; gap:7px;
    background: linear-gradient(135deg, #EF7D00 0%, #f59e0b 100%);
    color:#fff; border:none; padding:8px 20px 8px 16px;
    border-radius:0 0 14px 14px;
    font-size:12px; font-weight:700; cursor:pointer;
    box-shadow: 0 4px 16px rgba(239,125,0,0.25), 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
    letter-spacing: 0.02em;
    animation: fbSlideDown 0.5s ease-out;
}
#fbTrigger:hover {
    transform: translateY(2px);
    box-shadow: 0 2px 12px rgba(239,125,0,0.35);
}
#fbTrigger.fb-pulse { animation: fbPulse 2s ease-in-out 3, fbSlideDown 0.5s ease-out; }
#fbTrigger svg { flex-shrink:0; }

/* Contextual mini-prompt */
#fbContextPrompt {
    position:fixed; top:44px; left:50%; transform:translateX(-50%); z-index:9998;
    background:var(--c-bg); border:1px solid var(--c-border); border-left:3px solid #EF7D00;
    border-radius:10px; padding:10px 16px; max-width:280px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    animation: fbSlideDown 0.3s ease-out;
    display:none; font-size:12px; color:var(--c-text2); line-height:1.5;
}
#fbContextPrompt .fb-ctx-close {
    position:absolute; top:4px; right:8px; background:none; border:none;
    color:var(--c-muted); cursor:pointer; font-size:16px; line-height:1;
}

/* Modal overlay */
#fbOverlay {
    position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);
    display:none; align-items:center; justify-content:center; padding:16px;
}
#fbOverlay.fb-open { display:flex; animation: fbFadeIn 0.2s ease-out; }

/* Modal */
#fbModal {
    background:var(--c-bg); border-radius:20px; width:100%; max-width:520px;
    max-height:90vh; overflow-y:auto; animation: fbSlideUp 0.35s ease-out;
    box-shadow: 0 24px 80px rgba(0,0,0,0.2);
}
#fbModal::-webkit-scrollbar { width:6px; }
#fbModal::-webkit-scrollbar-track { background:transparent; }
#fbModal::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:3px; }

.fb-header {
    background: linear-gradient(135deg, #EF7D00 0%, #f59e0b 50%, #fbbf24 100%);
    padding:28px 28px 24px; border-radius:20px 20px 0 0; position:relative; overflow:hidden;
}
.fb-header::before {
    content:''; position:absolute; top:-40%; right:-20%; width:200px; height:200px;
    background:radial-gradient(circle, rgba(255,255,255,0.12) 0%, transparent 70%);
    border-radius:50%;
}
.fb-header h2 { color:#fff; font-size:18px; font-weight:800; margin:0 0 6px; position:relative; }
.fb-header p { color:rgba(255,255,255,0.85); font-size:13px; margin:0; position:relative; line-height:1.5; }
.fb-close {
    position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.2);
    border:none; color:#fff; width:32px; height:32px; border-radius:50%;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition: background 0.2s; font-size:20px; line-height:1; z-index:10;
}
.fb-close:hover { background:rgba(255,255,255,0.35); }

.fb-body { padding:24px 28px 20px; }
.fb-body label { display:block; font-size:11px; font-weight:700; color:var(--c-sub); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:6px; }
.fb-body input[type="text"], .fb-body textarea, .fb-body select {
    width:100%; padding:10px 14px; border:1.5px solid var(--c-border); border-radius:10px;
    font-size:14px; color:var(--c-text); transition: border-color 0.2s, box-shadow 0.2s;
    font-family:'Open Sans',sans-serif; outline:none;
}
.fb-body input:focus, .fb-body textarea:focus, .fb-body select:focus {
    border-color:#EF7D00; box-shadow: 0 0 0 3px rgba(239,125,0,0.12);
}
.fb-body textarea { resize:vertical; min-height:90px; }
.fb-field { margin-bottom:16px; }

/* Category pills */
.fb-cats { display:flex; flex-wrap:wrap; gap:6px; }
.fb-cat {
    padding:7px 14px; border-radius:20px; border:1.5px solid var(--c-border);
    background:var(--c-bg); font-size:12px; font-weight:600; cursor:pointer;
    transition: all 0.2s; color:var(--c-sub);
}
.fb-cat:hover { border-color:#EF7D00; color:#EF7D00; }
.fb-cat.active { background:var(--c-orange-tint,#fff7ed); border-color:#EF7D00; color:#EF7D00; }

/* Media buttons */
.fb-media-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
.fb-media-btn {
    display:flex; align-items:center; gap:6px;
    padding:8px 14px; border-radius:10px; border:1.5px solid var(--c-border);
    background:var(--c-bg2); font-size:12px; font-weight:600; cursor:pointer;
    transition: all 0.2s; color:var(--c-sub);
}
.fb-media-btn:hover { border-color:#EF7D00; background:var(--c-orange-tint,#fff7ed); color:#EF7D00; }
.fb-media-btn.recording { border-color:#ef4444; background:#fef2f2; color:#ef4444; animation: fbRecPulse 1.2s infinite; }
.fb-media-btn svg { width:16px; height:16px; }

/* Recording indicator */
.fb-rec-info {
    display:flex; align-items:center; gap:12px; padding:10px 14px;
    background:#fef2f2; border:1px solid #fecaca; border-radius:10px;
    margin-bottom:12px; font-size:12px; color:#991b1b;
}
.fb-rec-dot { width:8px; height:8px; border-radius:50%; background:#ef4444; animation: fbRecPulse 1s infinite; flex-shrink:0; }

/* Attachments preview */
.fb-attachments { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
.fb-attachment {
    display:flex; align-items:center; gap:6px; padding:6px 12px;
    background:var(--c-bg3); border-radius:8px; font-size:11px; color:var(--c-sub);
}
.fb-attachment button { background:none; border:none; color:var(--c-muted); cursor:pointer; font-size:14px; }
.fb-attachment button:hover { color:#ef4444; }

/* Submit */
.fb-submit {
    width:100%; padding:14px; border:none; border-radius:12px;
    background: linear-gradient(135deg, #EF7D00, #f59e0b);
    color:#fff; font-size:14px; font-weight:700; cursor:pointer;
    transition: all 0.3s; letter-spacing:0.02em;
}
.fb-submit:hover { transform:translateY(-1px); box-shadow: 0 4px 16px rgba(239,125,0,0.35); }
.fb-submit:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

.fb-footer-note {
    text-align:center; font-size:10px; color:var(--c-muted); margin-top:12px; line-height:1.5;
}
.fb-success {
    text-align:center; padding:40px 28px;
}
.fb-success .fb-check { font-size:48px; margin-bottom:12px; }
.fb-success h3 { font-size:18px; font-weight:800; color:#EF7D00; margin:0 0 8px; }
.fb-success p { font-size:13px; color:var(--c-sub); margin:0; line-height:1.6; }

@media (max-width:640px) {
    #fbTrigger span.fb-label-full { display:none; }
    #fbTrigger span.fb-label-short { display:inline; }
    #fbTrigger { padding:6px 14px; font-size:11px; }
    #fbModal { max-width:100%; border-radius:16px 16px 0 0; max-height:95vh; }
    #fbOverlay { align-items:flex-end; padding:0; }
}
</style>

<!-- Feedback Widget HTML -->
<div id="fbWidget" style="display:none">
    <button id="fbTrigger" onclick="fbOpen()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="9" y1="10" x2="15" y2="10"/></svg>
        <span class="fb-label-full">Portal verbessern â€“ Feedback geben</span>
        <span class="fb-label-short" style="display:none">Feedback</span>
    </button>
</div>

<div id="fbContextPrompt">
    <button class="fb-ctx-close" onclick="fbHideCtx()">&times;</button>
    <span id="fbCtxText">Wie hilfreich war diese Seite fÃ¼r dich?</span>
</div>

<div id="fbOverlay" onclick="if(event.target===this)fbClose()">
    <div id="fbModal">
        <div class="fb-header">
            <button class="fb-close" onclick="fbClose()">&times;</button>
            <h2>ðŸ’¡ Hilf uns, das Portal besser zu machen</h2>
            <p>Sag uns, was gut ist, was fehlt oder was dich stÃ¶rt. Du gestaltest das Portal mit.</p>
        </div>
        <div class="fb-body" id="fbForm">
            <div class="fb-field">
                <label>Kategorie</label>
                <div class="fb-cats" id="fbCats">
                    <button class="fb-cat active" data-cat="wunsch" onclick="fbSetCat(this)">âœ¨ Wunsch</button>
                    <button class="fb-cat" data-cat="idee" onclick="fbSetCat(this)">ðŸ’¡ Idee</button>
                    <button class="fb-cat" data-cat="bug" onclick="fbSetCat(this)">ðŸ› Bug</button>
                    <button class="fb-cat" data-cat="ux" onclick="fbSetCat(this)">ðŸŽ¨ UX</button>
                    <button class="fb-cat" data-cat="performance" onclick="fbSetCat(this)">âš¡ Performance</button>
                </div>
            </div>
            <div class="fb-field">
                <label>Titel <span style="font-weight:400;text-transform:none;color:var(--c-muted)">(optional)</span></label>
                <input type="text" id="fbTitle" placeholder="Kurze Zusammenfassung...">
            </div>
            <div class="fb-field">
                <label>Beschreibung</label>
                <textarea id="fbDesc" placeholder="Beschreibe so konkret wie mÃ¶glich, was du dir wÃ¼nschst oder was nicht funktioniert..."></textarea>
            </div>

            <label>AnhÃ¤nge</label>
            <div class="fb-media-row">
                <button class="fb-media-btn" id="fbBtnAudio" onclick="fbToggleAudio()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
                    <span id="fbAudioLabel">Sprachaufnahme</span>
                </button>
                <button class="fb-media-btn" id="fbBtnScreen" onclick="fbToggleScreen()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                    <span id="fbScreenLabel">Bildschirm aufnehmen</span>
                </button>
                <button class="fb-media-btn" onclick="fbScreenshot()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    Screenshot
                </button>
                <button class="fb-media-btn" onclick="document.getElementById('fbFileInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                    Datei anhÃ¤ngen
                </button>
                <input type="file" id="fbFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt" style="display:none" onchange="fbHandleFiles(this)">
            </div>

            <div id="fbRecInfo" class="fb-rec-info" style="display:none">
                <div class="fb-rec-dot"></div>
                <span id="fbRecTime">00:00</span>
                <span style="color:var(--c-muted)">â€¢</span>
                <span id="fbRecSize">0 KB</span>
                <button onclick="fbStopRec()" style="margin-left:auto;background:#ef4444;color:#fff;border:none;padding:4px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">â¹ Stopp</button>
            </div>

            <div class="fb-attachments" id="fbAttachments"></div>

            <button class="fb-submit" id="fbSubmitBtn" onclick="fbSubmit()">
                Feedback senden
            </button>
            <p class="fb-footer-note">âš ï¸ Bitte keine sensiblen Daten wie PasswÃ¶rter aufnehmen.<br>Dein Feedback wird direkt vom Entwicklerteam gelesen.</p>
        </div>
        <div id="fbSuccess" class="fb-success" style="display:none">
            <div class="fb-check">ðŸŽ‰</div>
            <h3>Danke fÃ¼r dein Feedback!</h3>
            <p>Wir schauen uns das an und melden uns, wenn wir RÃ¼ckfragen haben. Dein Input hilft uns, das Portal fÃ¼r alle Partner besser zu machen.</p>
            <div style="margin-top:20px;padding:16px;background:var(--c-orange-tint,#fff7ed);border-radius:12px;text-align:left">
                <p style="font-size:11px;font-weight:700;color:#EF7D00;margin:0 0 8px;text-transform:uppercase;letter-spacing:0.05em">âœ… Letzte Verbesserungen dank Partner-Feedback</p>
                <ul style="font-size:12px;color:var(--c-text2);margin:0;padding:0 0 0 16px;line-height:1.8">
                    <li>BWA-Parser: 13+ DATEV-Formate erkannt</li>
                    <li>Mitarbeiter-Onboarding mit E-Mail-Einladung</li>
                    <li>WaWi Belege in Buchhaltung integriert</li>
                    <li>Dark Mode fÃ¼r alle Module</li>
                </ul>
            </div>
            <button onclick="fbClose()" style="margin-top:16px;padding:10px 28px;border:none;border-radius:10px;background:var(--c-bg3);color:var(--c-text2);font-weight:600;cursor:pointer;font-size:13px">SchlieÃŸen</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK WIDGET â€“ Production Module
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
    'use strict';

    // â”€â”€ State â”€â”€
    var fbState = {
        category: 'wunsch',
        attachments: [],       // [{name, type, blob, size}]
        mediaRecorder: null,
        recordingType: null,   // 'audio' | 'screen'
        recordingChunks: [],
        recordingStart: null,
        recTimer: null,
        stream: null
    };

    // â”€â”€ Init: show widget after login â”€â”€
    var fbInitInterval = setInterval(function(){
        if(typeof sbUser !== 'undefined' && sbUser && sbUser.id) {
            // Don't show on login screen
            var loginEl = document.getElementById('loginScreen');
            if(loginEl && loginEl.style.display !== 'none') return;
            clearInterval(fbInitInterval);
            var w = document.getElementById('fbWidget');
            if(w) w.style.display = 'block';
            // Pulse animation on first visit of the day
            var today = new Date().toDateString();
            var lastPulse = localStorage.getItem('fb_pulse_date');
            if(lastPulse !== today) {
                localStorage.setItem('fb_pulse_date', today);
                var btn = document.getElementById('fbTrigger');
                if(btn) btn.classList.add('fb-pulse');
                setTimeout(function(){ if(btn) btn.classList.remove('fb-pulse'); }, 7000);
            }
        }
    }, 1000);

    // â”€â”€ Contextual prompt on module switch â”€â”€
    var fbLastView = '';
    var fbCtxCount = 0;
    var fbCtxShownForView = {};
    setInterval(function(){
        if(typeof currentView === 'undefined') return;
        if(currentView !== fbLastView && currentView && fbCtxCount < 3) {
            fbLastView = currentView;
            if(!fbCtxShownForView[currentView] && Math.random() < 0.15) {
                fbCtxShownForView[currentView] = true;
                fbCtxCount++;
                var viewNames = {controlling:'Zahlen',verkauf:'Verkauf',marketing:'Marketing',einkauf:'Einkauf',standortBilling:'Buchhaltung'};
                var vn = viewNames[currentView] || currentView;
                document.getElementById('fbCtxText').textContent = 'Wie findest du den Bereich â€ž'+vn+'"? Feedback geben â†’';
                var cp = document.getElementById('fbContextPrompt');
                if(cp) { cp.style.display = 'block'; setTimeout(function(){ cp.style.display='none'; }, 8000); }
            }
        }
    }, 2000);

    window.fbHideCtx = function(){ document.getElementById('fbContextPrompt').style.display='none'; };

    // â”€â”€ Open / Close â”€â”€
    window.fbOpen = function(){
        // Zum neuen Ideenboard navigieren und Formular Ã¶ffnen
        showView('entwicklung');
        setTimeout(function(){
            var f = document.getElementById('devSubmitForm');
            if(f && f.classList.contains('hidden')) toggleDevSubmitForm();
        }, 200);
    };
    window.fbClose = function(){
        document.getElementById('fbOverlay').classList.remove('fb-open');
        fbStopRecIfActive();
    };

    // â”€â”€ Category selection â”€â”€
    window.fbSetCat = function(el){
        document.querySelectorAll('.fb-cat').forEach(function(b){ b.classList.remove('active'); });
        el.classList.add('active');
        fbState.category = el.getAttribute('data-cat');
    };

    // â”€â”€ Audio Recording â”€â”€
    window.fbToggleAudio = async function(){
        if(fbState.recordingType === 'audio') { fbStopRec(); return; }
        fbStopRecIfActive();
        try {
            var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            startRecording(stream, 'audio');
            document.getElementById('fbBtnAudio').classList.add('recording');
            document.getElementById('fbAudioLabel').textContent = 'â¹ Aufnahme stoppen';
        } catch(e) { alert('Mikrofon-Zugriff nicht mÃ¶glich: ' + e.message); }
    };

    // â”€â”€ Screen Recording â”€â”€
    window.fbToggleScreen = async function(){
        if(fbState.recordingType === 'screen') { fbStopRec(); return; }
        fbStopRecIfActive();
        try {
            var stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            startRecording(stream, 'screen');
            document.getElementById('fbBtnScreen').classList.add('recording');
            document.getElementById('fbScreenLabel').textContent = 'â¹ Aufnahme stoppen';
            // Handle user stopping share via browser UI
            stream.getVideoTracks()[0].onended = function(){ fbStopRec(); };
        } catch(e) { if(e.name !== 'AbortError') alert('Bildschirmaufnahme nicht mÃ¶glich: ' + e.message); }
    };

    function startRecording(stream, type) {
        fbState.stream = stream;
        fbState.recordingType = type;
        fbState.recordingChunks = [];
        fbState.recordingStart = Date.now();

        var mimeType = 'video/webm';
        if(type === 'audio') mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';

        fbState.mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
        fbState.mediaRecorder.ondataavailable = function(e){ if(e.data.size > 0) fbState.recordingChunks.push(e.data); };
        fbState.mediaRecorder.onstop = function(){ finalizeRecording(type, mimeType); };
        fbState.mediaRecorder.start(1000); // chunk every 1s for memory safety

        document.getElementById('fbRecInfo').style.display = 'flex';
        fbState.recTimer = setInterval(updateRecInfo, 500);
    }

    function updateRecInfo() {
        if(!fbState.recordingStart) return;
        var elapsed = Math.floor((Date.now() - fbState.recordingStart) / 1000);
        var mm = String(Math.floor(elapsed/60)).padStart(2,'0');
        var ss = String(elapsed%60).padStart(2,'0');
        document.getElementById('fbRecTime').textContent = mm + ':' + ss;
        var totalSize = fbState.recordingChunks.reduce(function(a,c){ return a + c.size; }, 0);
        document.getElementById('fbRecSize').textContent = formatSize(totalSize);
    }

    function formatSize(bytes) {
        if(bytes < 1024) return bytes + ' B';
        if(bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
        return (bytes/1048576).toFixed(1) + ' MB';
    }

    function finalizeRecording(type, mimeType) {
        var blob = new Blob(fbState.recordingChunks, { type: mimeType });
        var ext = type === 'audio' ? 'webm' : 'webm';
        var name = (type === 'audio' ? 'Sprachaufnahme' : 'Bildschirmaufnahme') + '.' + ext;
        fbState.attachments.push({ name:name, type:type, blob:blob, size:blob.size, mime:mimeType });
        renderAttachments();
        resetRecUI();
    }

    window.fbStopRec = function(){
        if(fbState.mediaRecorder && fbState.mediaRecorder.state !== 'inactive') {
            fbState.mediaRecorder.stop();
        }
        if(fbState.stream) {
            fbState.stream.getTracks().forEach(function(t){ t.stop(); });
            fbState.stream = null;
        }
    };

    function fbStopRecIfActive() {
        if(fbState.recordingType) fbStopRec();
    }

    function resetRecUI() {
        clearInterval(fbState.recTimer);
        fbState.recordingType = null;
        fbState.recordingStart = null;
        fbState.mediaRecorder = null;
        document.getElementById('fbRecInfo').style.display = 'none';
        document.getElementById('fbBtnAudio').classList.remove('recording');
        document.getElementById('fbBtnScreen').classList.remove('recording');
        document.getElementById('fbAudioLabel').textContent = 'Sprachaufnahme';
        document.getElementById('fbScreenLabel').textContent = 'Bildschirm aufnehmen';
    }

    // â”€â”€ Screenshot â”€â”€
    window.fbScreenshot = async function(){
        try {
            // Hide widget temporarily
            document.getElementById('fbOverlay').style.display = 'none';
            await new Promise(function(r){ setTimeout(r, 200); });

            if(typeof html2canvas !== 'undefined') {
                var canvas = await html2canvas(document.body, { scale: 1, useCORS: true });
                canvas.toBlob(function(blob){
                    fbState.attachments.push({ name:'Screenshot.png', type:'screenshot', blob:blob, size:blob.size, mime:'image/png' });
                    renderAttachments();
                    document.getElementById('fbOverlay').classList.add('fb-open');
                }, 'image/png');
            } else {
                // Fallback: use getDisplayMedia for single frame
                var stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                var track = stream.getVideoTracks()[0];
                var imageCapture = new ImageCapture(track);
                var bitmap = await imageCapture.grabFrame();
                track.stop();
                var canvas = document.createElement('canvas');
                canvas.width = bitmap.width; canvas.height = bitmap.height;
                canvas.getContext('2d').drawImage(bitmap, 0, 0);
                canvas.toBlob(function(blob){
                    fbState.attachments.push({ name:'Screenshot.png', type:'screenshot', blob:blob, size:blob.size, mime:'image/png' });
                    renderAttachments();
                }, 'image/png');
                document.getElementById('fbOverlay').classList.add('fb-open');
            }
        } catch(e) {
            document.getElementById('fbOverlay').classList.add('fb-open');
            if(e.name !== 'AbortError') console.warn('Screenshot failed:', e);
        }
    };

    // â”€â”€ File Upload â”€â”€
    window.fbHandleFiles = function(input) {
        if(!input.files) return;
        var maxSize = 10 * 1024 * 1024; // 10MB per file
        for(var i = 0; i < input.files.length; i++) {
            var file = input.files[i];
            if(file.size > maxSize) {
                alert('Datei "' + file.name + '" ist zu groÃŸ (max. 10 MB).');
                continue;
            }
            if(fbState.attachments.length >= 5) {
                alert('Maximal 5 AnhÃ¤nge mÃ¶glich.');
                break;
            }
            fbState.attachments.push({
                name: file.name,
                type: 'file',
                blob: file,
                size: file.size,
                mime: file.type || 'application/octet-stream'
            });
        }
        input.value = ''; // reset for re-selection
        renderAttachments();
    };

    // â”€â”€ Attachments UI â”€â”€
    function renderAttachments() {
        var el = document.getElementById('fbAttachments');
        if(!el) return;
        if(!fbState.attachments.length) { el.innerHTML = ''; return; }
        el.innerHTML = fbState.attachments.map(function(a, i){
            var icon = a.type==='audio' ? 'ðŸŽ™ï¸' : a.type==='screen' ? 'ðŸ–¥ï¸' : a.type==='file' ? 'ðŸ“Ž' : 'ðŸ“·';
            return '<div class="fb-attachment">' + icon + ' ' + a.name + ' <span style="color:var(--c-muted)">(' + formatSize(a.size) + ')</span>' +
                '<button onclick="fbRemoveAttachment('+i+')">&times;</button></div>';
        }).join('');
    }
    window.fbRemoveAttachment = function(i){
        fbState.attachments.splice(i, 1);
        renderAttachments();
    };

    // â”€â”€ Submit â”€â”€
    window.fbSubmit = async function(){
        var desc = (document.getElementById('fbDesc').value || '').trim();
        var title = (document.getElementById('fbTitle').value || '').trim();
        if(!desc && !fbState.attachments.length) {
            document.getElementById('fbDesc').style.borderColor = '#ef4444';
            document.getElementById('fbDesc').placeholder = 'Bitte beschreibe dein Feedback...';
            return;
        }
        document.getElementById('fbDesc').style.borderColor = '';

        var btn = document.getElementById('fbSubmitBtn');
        btn.disabled = true; btn.textContent = 'Wird gesendet...';

        try {
            // Upload attachments to Supabase Storage
            var uploadedFiles = [];
            for(var i = 0; i < fbState.attachments.length; i++) {
                var a = fbState.attachments[i];
                var ext = a.name.split('.').pop();
                var path = sbUser.id + '/' + Date.now() + '_' + i + '.' + ext;

                // Chunked upload for large files
                if(a.size > 5 * 1024 * 1024) {
                    // For very large files, upload directly (Supabase handles chunking)
                    var upResp = await sb.storage.from('feedback-attachments').upload(path, a.blob, {
                        contentType: a.mime,
                        upsert: false
                    });
                    if(upResp.error) { console.error('Upload failed:', upResp.error); continue; }
                } else {
                    var upResp = await sb.storage.from('feedback-attachments').upload(path, a.blob, {
                        contentType: a.mime
                    });
                    if(upResp.error) { console.error('Upload failed:', upResp.error); continue; }
                }
                uploadedFiles.push({
                    path: path,
                    name: a.name,
                    type: a.type,
                    size: a.size,
                    mime: a.mime
                });
            }

            // Browser info
            var browserInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screen: screen.width + 'x' + screen.height,
                viewport: window.innerWidth + 'x' + window.innerHeight
            };

            // Insert feedback record
            var fbRecord = {
                user_id: sbUser.id,
                standort_id: (typeof sbStandort !== 'undefined' && sbStandort) ? sbStandort.id : null,
                kategorie: fbState.category,
                titel: title || null,
                beschreibung: desc,
                route: fbState.currentRoute || null,
                browser_info: browserInfo,
                attachments: uploadedFiles
            };

            var resp = await sb.from('portal_feedback').insert(fbRecord);
            if(resp.error) throw resp.error;

            // Show success
            document.getElementById('fbForm').style.display = 'none';
            document.getElementById('fbSuccess').style.display = 'block';
            fbState.attachments = [];

        } catch(err) {
            console.error('Feedback submit error:', err);
            alert('Fehler beim Senden: ' + (err.message || err));
            btn.disabled = false; btn.textContent = 'Feedback senden';
        }
    };

})();
</script>

<!-- ===== VIDEO-PIPELINE MODULE (integriert in Marketing â†’ Social Media + HQ Freigabe) ===== -->
<script>
(function(){
    'use strict';

    // ==================== HELPERS ====================
    var vpStatusLabels = {
        uploaded:'Hochgeladen', analyzing:'Analyse...', consent_check:'Consent-Check',
        consent_blocked:'Consent fehlt', cutting:'Wird geschnitten', review:'Freigabe',
        approved:'Freigegeben', publishing:'Publishing...', published:'VerÃ¶ffentlicht',
        rejected:'Abgelehnt', failed:'Fehler'
    };
    var vpStatusColors = {
        uploaded:'bg-gray-100 text-gray-700', analyzing:'bg-blue-100 text-blue-700',
        consent_check:'bg-yellow-100 text-yellow-700', consent_blocked:'bg-red-100 text-red-700',
        cutting:'bg-purple-100 text-purple-700', review:'bg-orange-100 text-orange-700',
        approved:'bg-green-100 text-green-700', publishing:'bg-blue-100 text-blue-700',
        published:'bg-green-200 text-green-800', rejected:'bg-red-100 text-red-700',
        failed:'bg-red-200 text-red-800'
    };
    var vpCategoryLabels = {probefahrt:'Probefahrt',event:'Event',werkstatt:'Werkstatt',cargo_demo:'Cargo Demo',sonstiges:'Sonstiges'};
    var vpConsentTypeLabels = {employee_general:'Mitarbeiter (Generell)',customer_single:'Kunde (Einmalig)',customer_general:'Kunde (Generell)'};

    function vpBadge(status) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium '+(vpStatusColors[status]||'bg-gray-100 text-gray-700')+'">'+(vpStatusLabels[status]||status)+'</span>';
    }
    function vpDate(d) { if(!d) return 'â€“'; return new Date(d).toLocaleDateString('de-DE'); }
    function vpDateTime(d) { if(!d) return 'â€“'; return new Date(d).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}); }
    function vpFileSize(bytes) { if(!bytes) return 'â€“'; if(bytes<1024*1024) return (bytes/1024).toFixed(0)+' KB'; return (bytes/(1024*1024)).toFixed(1)+' MB'; }

    function vpModal(html) {
        document.getElementById('vpModalContent').innerHTML = html;
        document.getElementById('vpModal').style.display = 'flex';
    }
    window.vpCloseModal = function() { document.getElementById('vpModal').style.display = 'none'; };
    document.addEventListener('click', function(e){ if(e.target && e.target.id === 'vpModal') vpCloseModal(); });

    // ==================== UPLOAD (Standort â€“ Multi-File) ====================
    var vpSelectedFiles = [];

    window.vpInitUpload = function() {
        var dz = document.getElementById('vpDropZone');
        var fi = document.getElementById('vpFileInput');
        if(!dz || dz._vpInit) return;
        dz._vpInit = true;
        dz.addEventListener('click', function(){ fi.click(); });
        dz.addEventListener('dragover', function(e){ e.preventDefault(); dz.classList.add('border-vit-orange','bg-orange-50'); });
        dz.addEventListener('dragleave', function(){ dz.classList.remove('border-vit-orange','bg-orange-50'); });
        dz.addEventListener('drop', function(e){
            e.preventDefault(); dz.classList.remove('border-vit-orange','bg-orange-50');
            vpAddFiles(e.dataTransfer.files);
        });
        fi.addEventListener('change', function(){ vpAddFiles(this.files); this.value=''; });
    };

    function vpAddFiles(fileList) {
        for(var i=0; i<fileList.length; i++) {
            var f = fileList[i];
            if(!f.type.startsWith('video/')) continue;
            if(f.size > 2147483648) { alert(f.name + ': zu gross (max. 2 GB)'); continue; }
            if(vpSelectedFiles.some(function(sf){ return sf.name===f.name && sf.size===f.size; })) continue;
            vpSelectedFiles.push(f);
        }
        vpRenderFileQueue();
    }

    function vpRenderFileQueue() {
        var q = document.getElementById('vpFileQueue');
        var btn = document.getElementById('vpUploadBtn');
        if(!q) return;
        if(vpSelectedFiles.length === 0) { q.innerHTML = ''; btn.disabled = true; return; }
        btn.disabled = false;
        var html = '<div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">' + vpSelectedFiles.length + ' Video' + (vpSelectedFiles.length>1?'s':'') + ' ausgewaehlt' + (vpSelectedFiles.length>1?' (werden als Gruppe geschnitten)':'') + '</div>';
        vpSelectedFiles.forEach(function(f, idx) {
            var sizeMB = (f.size/(1024*1024)).toFixed(1);
            html += '<div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg" id="vpFileItem_'+idx+'">';
            html += '<div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-sm font-bold">'+(idx+1)+'</div>';
            html += '<div class="flex-1 min-w-0"><p class="text-sm font-medium text-gray-800 truncate">'+f.name+'</p><p class="text-xs text-gray-400">'+sizeMB+' MB</p></div>';
            html += '<div id="vpFileStatus_'+idx+'" class="text-xs text-gray-400">Bereit</div>';
            html += '<button onclick="vpRemoveFile('+idx+')" class="text-gray-300 hover:text-red-500 text-lg">&times;</button>';
            html += '</div>';
        });
        q.innerHTML = html;
    }

    window.vpRemoveFile = function(idx) {
        vpSelectedFiles.splice(idx, 1);
        vpRenderFileQueue();
    };

    window.vpDoMultiUpload = async function() {
        if(vpSelectedFiles.length === 0) return;
        var btn = document.getElementById('vpUploadBtn');
        var status = document.getElementById('vpUploadStatus');
        var statusText = document.getElementById('vpUploadStatusText');
        var bar = document.getElementById('vpUploadBar');
        var pct = document.getElementById('vpUploadPercent');
        btn.disabled = true;
        status.style.display = 'block';
        bar.className = 'bg-vit-orange h-2 rounded-full transition-all';

        var cat = document.getElementById('vpUploadCategory')?.value || 'sonstiges';
        var comment = document.getElementById('vpUploadComment')?.value?.trim() || null;
        var thema = document.getElementById('smUploadThema')?.value || null;
        var groupId = vpSelectedFiles.length > 1 ? crypto.randomUUID() : null;
        var groupLabel = thema || (vpSelectedFiles.length > 1 ? 'Gruppe vom ' + new Date().toLocaleDateString('de-DE') : null);

        var total = vpSelectedFiles.length;
        var done = 0;
        var errors = [];

        // Get session for auth token
        var sessionResp = await sb.auth.getSession();
        var accessToken = sessionResp?.data?.session?.access_token;
        if(!accessToken) { alert('Nicht eingeloggt!'); btn.disabled = false; return; }

        var projectId = 'lwwagbkxeofahhwebkab';

        for(var i=0; i<total; i++) {
            var file = vpSelectedFiles[i];
            var fStatus = document.getElementById('vpFileStatus_'+i);
            var storagePath = sbStandort.id + '/' + Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g,'_');

            pct.textContent = (i+1) + ' / ' + total;
            statusText.textContent = 'Hochladen: ' + file.name;
            if(fStatus) fStatus.innerHTML = '<span class="text-blue-500">â¬†ï¸ 0%</span>';

            try {
                await new Promise(function(resolve, reject) {
                    var upload = new tus.Upload(file, {
                        endpoint: 'https://' + projectId + '.storage.supabase.co/storage/v1/upload/resumable',
                        retryDelays: [0, 3000, 5000, 10000, 20000],
                        headers: {
                            authorization: 'Bearer ' + accessToken,
                            'x-upsert': 'true'
                        },
                        uploadDataDuringCreation: true,
                        removeFingerprintOnSuccess: true,
                        metadata: {
                            bucketName: 'videos',
                            objectName: storagePath,
                            contentType: file.type,
                            cacheControl: '3600'
                        },
                        chunkSize: 6 * 1024 * 1024,
                        onError: function(error) {
                            reject(error);
                        },
                        onProgress: function(bytesUploaded, bytesTotal) {
                            var filePct = Math.round((bytesUploaded / bytesTotal) * 100);
                            var totalPct = Math.round(((done + bytesUploaded/bytesTotal) / total) * 100);
                            bar.style.width = totalPct + '%';
                            if(fStatus) fStatus.innerHTML = '<span class="text-blue-500">â¬†ï¸ ' + filePct + '%</span>';
                            statusText.textContent = 'Hochladen: ' + file.name + ' (' + filePct + '%)';
                        },
                        onSuccess: function() {
                            resolve();
                        }
                    });
                    upload.findPreviousUploads().then(function(prev) {
                        if(prev.length) upload.resumeFromPreviousUpload(prev[0]);
                        upload.start();
                    });
                });

                if(fStatus) fStatus.innerHTML = '<span class="text-yellow-500">ðŸ’¾ Speichern...</span>';

                var insertData = {
                    standort_id: sbStandort.id,
                    uploaded_by: sbUser.id,
                    storage_path: storagePath,
                    filename: file.name,
                    file_size_bytes: file.size,
                    category: cat,
                    pipeline_status: 'uploaded',
                    pipeline_status_detail: comment,
                    sort_order: i
                };
                if(groupId) { insertData.group_id = groupId; insertData.group_label = groupLabel; }

                var {error:dbErr} = await sb.from('videos').insert(insertData);
                if(dbErr) throw dbErr;

                if(fStatus) fStatus.innerHTML = '<span class="text-green-600">âœ… Fertig</span>';
                done++;
            } catch(e) {
                var errMsg = e.message || e.toString();
                errors.push(file.name + ': ' + errMsg);
                if(fStatus) fStatus.innerHTML = '<span class="text-red-500">âŒ ' + errMsg.substring(0,40) + '</span>';
            }
        }

        bar.style.width = '100%';
        if(errors.length === 0) {
            statusText.textContent = 'âœ… Alle ' + total + ' Videos hochgeladen!';
            bar.className = 'bg-green-500 h-2 rounded-full transition-all';
            vpSelectedFiles = [];
            setTimeout(function(){ switchSmSub('pipeline'); }, 2000);
        } else {
            statusText.textContent = done + ' von ' + total + ' hochgeladen, ' + errors.length + ' Fehler';
            bar.className = 'bg-yellow-500 h-2 rounded-full transition-all';
        }
        btn.disabled = false;
    };

    // ==================== PIPELINE DASHBOARD (Standort: "Meine Videos") ====================
    window.vpRenderPipelineDashboard = async function() {
        var c = document.getElementById('vpDashboardContent');
        if(!c) return;
        c.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin w-8 h-8 border-4 border-vit-orange border-t-transparent rounded-full"></div></div>';

        try {
            var sid = sbStandort?.id;
            var {data:videos,error} = await sb.from('videos').select('*').eq('standort_id',sid).order('created_at',{ascending:false});
            if(error) throw error;
            videos = videos || [];

            var total = videos.length;
            var inPipeline = videos.filter(function(v){return !['published','rejected','failed'].includes(v.pipeline_status)}).length;
            var published = videos.filter(function(v){return v.pipeline_status==='published'}).length;
            var needReview = videos.filter(function(v){return v.pipeline_status==='review'}).length;

            var html = '';
            html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">';
            html += '<div class="vit-card p-4"><div class="text-2xl font-bold text-gray-800">'+total+'</div><div class="text-xs text-gray-500">Videos gesamt</div></div>';
            html += '<div class="vit-card p-4"><div class="text-2xl font-bold text-blue-600">'+inPipeline+'</div><div class="text-xs text-gray-500">In Pipeline</div></div>';
            html += '<div class="vit-card p-4"><div class="text-2xl font-bold text-green-600">'+published+'</div><div class="text-xs text-gray-500">VerÃ¶ffentlicht</div></div>';
            html += '<div class="vit-card p-4 '+(needReview>0?'ring-2 ring-orange-400':'')+'"><div class="text-2xl font-bold text-orange-600">'+needReview+'</div><div class="text-xs text-gray-500">Bei HQ zur Freigabe</div></div>';
            html += '</div>';

            // Pipeline visualization
            html += '<div class="vit-card p-4 mb-6"><h3 class="font-semibold text-gray-700 mb-3">Pipeline-Status</h3>';
            var stages = ['uploaded','analyzing','consent_check','cutting','review','publishing','published'];
            html += '<div class="flex items-center gap-1 text-xs">';
            stages.forEach(function(s){
                var count = videos.filter(function(v){return v.pipeline_status===s}).length;
                html += '<div class="flex-1 text-center"><div class="h-8 rounded flex items-center justify-center font-medium '+(vpStatusColors[s]||'')+'">'+(count||'')+'</div><div class="mt-1 text-gray-500 truncate">'+(vpStatusLabels[s]||s)+'</div></div>';
                if(s !== 'published') html += '<div class="text-gray-300">â†’</div>';
            });
            html += '</div></div>';

            if(videos.length === 0) {
                html += '<div class="vit-card p-8 text-center text-gray-400"><div class="text-4xl mb-2">ðŸŽ¬</div><p>Noch keine Videos hochgeladen.</p><button onclick="switchSmSub(\'upload\')" class="mt-3 text-vit-orange hover:underline font-medium">Erstes Video hochladen â†’</button></div>';
            } else {
                // Group videos by group_id
                var groups = {};
                var singles = [];
                videos.forEach(function(v){
                    if(v.group_id) {
                        if(!groups[v.group_id]) groups[v.group_id] = {label: v.group_label || 'Gruppe', videos: []};
                        groups[v.group_id].videos.push(v);
                    } else {
                        singles.push(v);
                    }
                });

                html += '<div class="vit-card overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="text-left p-3 font-medium text-gray-600">Video</th><th class="text-left p-3 font-medium text-gray-600">Kategorie</th><th class="text-left p-3 font-medium text-gray-600">Status</th><th class="text-left p-3 font-medium text-gray-600">Hochgeladen</th><th class="text-right p-3 font-medium text-gray-600">Groesse</th></tr></thead><tbody>';

                // Render groups first
                Object.keys(groups).forEach(function(gid){
                    var g = groups[gid];
                    var totalSize = g.videos.reduce(function(sum,v){return sum+v.file_size_bytes},0);
                    html += '<tr class="border-t-2 border-orange-200 bg-orange-50"><td class="p-3 font-medium text-gray-800" colspan="2">ðŸ“Ž '+g.label+' <span class="text-xs text-gray-400">('+g.videos.length+' Clips)</span></td><td class="p-3">'+vpBadge(g.videos[0].pipeline_status)+'</td><td class="p-3 text-gray-500">'+vpDateTime(g.videos[0].created_at)+'</td><td class="p-3 text-right text-gray-500">'+vpFileSize(totalSize)+'</td></tr>';
                    g.videos.sort(function(a,b){return (a.sort_order||0)-(b.sort_order||0)});
                    g.videos.forEach(function(v){
                        html += '<tr class="border-t border-gray-100 hover:bg-gray-50 cursor-pointer bg-orange-50/30" onclick="vpShowVideoDetail(\''+v.id+'\')">';
                        html += '<td class="p-3 pl-8 text-gray-600">â†³ '+v.filename+'</td>';
                        html += '<td class="p-3 text-gray-500">'+(vpCategoryLabels[v.category]||v.category)+'</td>';
                        html += '<td class="p-3">'+vpBadge(v.pipeline_status)+'</td>';
                        html += '<td class="p-3 text-gray-500">'+vpDateTime(v.created_at)+'</td>';
                        html += '<td class="p-3 text-right text-gray-500">'+vpFileSize(v.file_size_bytes)+'</td>';
                        html += '</tr>';
                    });
                });

                // Then singles
                singles.forEach(function(v){
                    html += '<tr class="border-t border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="vpShowVideoDetail(\''+v.id+'\')">';
                    html += '<td class="p-3 font-medium text-gray-800">'+v.filename+'</td>';
                    html += '<td class="p-3">'+(vpCategoryLabels[v.category]||v.category)+'</td>';
                    html += '<td class="p-3">'+vpBadge(v.pipeline_status)+'</td>';
                    html += '<td class="p-3 text-gray-500">'+vpDateTime(v.created_at)+'</td>';
                    html += '<td class="p-3 text-right text-gray-500">'+vpFileSize(v.file_size_bytes)+'</td>';
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            }
            c.innerHTML = html;
        } catch(e) {
            c.innerHTML = '<div class="vit-card p-6 text-red-600">Fehler beim Laden: '+e.message+'</div>';
        }
    };

    // ==================== VIDEO DETAIL MODAL ====================
    window.vpShowVideoDetail = async function(videoId) {
        vpModal('<div class="flex justify-center py-8"><div class="animate-spin w-8 h-8 border-4 border-vit-orange border-t-transparent rounded-full"></div></div>');
        try {
            var {data:v} = await sb.from('videos').select('*').eq('id',videoId).single();
            var {data:persons} = await sb.from('video_persons').select('*, consents(person_name,consent_type,valid_until,revoked_at)').eq('video_id',videoId);
            var {data:reels} = await sb.from('reels').select('*, reel_publications(*)').eq('video_id',videoId);
            var {data:logs} = await sb.from('pipeline_log').select('*').eq('video_id',videoId).order('created_at',{ascending:true});

            var html = '<div class="flex justify-between items-start mb-4"><div><h2 class="text-xl font-bold text-gray-800">'+v.filename+'</h2><p class="text-sm text-gray-500">'+(vpCategoryLabels[v.category]||v.category)+' Â· '+vpFileSize(v.file_size_bytes)+' Â· '+vpDateTime(v.created_at)+'</p></div><div class="flex items-center gap-2">'+vpBadge(v.pipeline_status)+'<button onclick="vpCloseModal()" class="text-gray-400 hover:text-gray-600 text-2xl ml-2">&times;</button></div></div>';

            var stages = ['uploaded','analyzing','consent_check','cutting','review','approved','published'];
            var currentIdx = stages.indexOf(v.pipeline_status);
            if(currentIdx===-1) currentIdx = stages.indexOf({consent_blocked:'consent_check',rejected:'review',failed:'uploaded'}[v.pipeline_status]||'uploaded');
            html += '<div class="flex items-center gap-0.5 mb-6">';
            stages.forEach(function(s,i){
                var cls = i<currentIdx?'bg-green-400':i===currentIdx?'bg-vit-orange':'bg-gray-200';
                html += '<div class="flex-1 h-2 rounded-full '+cls+'" title="'+(vpStatusLabels[s]||s)+'"></div>';
            });
            html += '</div>';

            if(v.pipeline_status_detail) html += '<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">â„¹ï¸ '+v.pipeline_status_detail+'</div>';

            if(persons && persons.length>0) {
                html += '<div class="mb-4"><h3 class="font-semibold text-gray-700 mb-2">ðŸ‘¥ Getaggte Personen ('+persons.length+')</h3><div class="space-y-1">';
                persons.forEach(function(p){
                    var statusCls = p.consent_status==='valid'?'text-green-600':p.consent_status==='missing'?'text-red-600':'text-yellow-600';
                    html += '<div class="flex items-center gap-2 text-sm"><span class="'+statusCls+'">'+(p.consent_status==='valid'?'âœ…':p.consent_status==='missing'?'âŒ':'âš ï¸')+'</span><span class="font-medium">'+p.person_label+'</span><span class="text-gray-400">'+(p.consent_status||'â€“')+'</span></div>';
                });
                html += '</div></div>';
            }

            if(reels && reels.length>0) {
                html += '<div class="mb-4"><h3 class="font-semibold text-gray-700 mb-2">ðŸŽžï¸ Reels ('+reels.length+')</h3><div class="grid gap-2">';
                reels.forEach(function(r){
                    html += '<div class="p-3 bg-gray-50 rounded-lg"><div class="flex justify-between items-center"><span class="font-medium text-sm">'+(r.caption?r.caption.substring(0,60)+'...':'Reel')+'</span>'+vpBadge(r.status)+'</div>';
                    if(r.reel_publications && r.reel_publications.length>0) {
                        html += '<div class="flex gap-2 mt-2">';
                        r.reel_publications.forEach(function(pub){ html += '<span class="text-xs px-2 py-1 rounded '+(pub.is_published?'bg-green-100 text-green-700':'bg-gray-100 text-gray-600')+'">'+pub.platform.replace('_',' ')+(pub.is_published?' âœ“':'')+'</span>'; });
                        html += '</div>';
                    }
                    html += '</div>';
                });
                html += '</div></div>';
            }

            if(logs && logs.length>0) {
                html += '<div class="mb-4"><h3 class="font-semibold text-gray-700 mb-2">ðŸ“‹ Pipeline-Log</h3><div class="space-y-1 max-h-48 overflow-y-auto">';
                logs.forEach(function(l){ html += '<div class="flex gap-2 text-xs text-gray-500"><span class="whitespace-nowrap">'+vpDateTime(l.created_at)+'</span><span class="font-medium text-gray-600">['+l.phase+']</span><span>'+l.action+'</span></div>'; });
                html += '</div></div>';
            }

            if(v.pipeline_status==='uploaded') {
                html += '<div class="mt-4 pt-4 border-t flex gap-2">';
                html += '<button onclick="vpTriggerAnalysis(\''+v.id+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 transition font-medium">ðŸ”¬ Analyse starten</button>';
                html += '<button onclick="vpManualAdvance(\''+v.id+'\',\'analyzing\')" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm">â© Manuell weiter</button>';
                html += '</div>';
            }

            if(v.pipeline_status==='consent_check' || v.pipeline_status==='consent_blocked') {
                html += '<div class="mt-4 pt-4 border-t flex gap-2">';
                html += '<button onclick="vpCloseModal();vpShowTagging(\''+v.id+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 transition font-medium">ðŸ‘¥ Personen taggen</button>';
                html += '<button onclick="vpTriggerConsent(\''+v.id+'\')" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm">ðŸ” Consent prÃ¼fen</button>';
                html += '<button onclick="vpManualAdvance(\''+v.id+'\',\'cutting\')" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm">â© Ãœberspringen</button>';
                html += '</div>';
            }

            if(v.pipeline_status==='cutting') {
                html += '<div class="mt-4 pt-4 border-t flex gap-2">';
                html += '<button onclick="vpTriggerReels(\''+v.id+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 transition font-medium">ðŸŽ¬ Reels generieren</button>';
                html += '<button onclick="vpManualAdvance(\''+v.id+'\',\'review\')" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm">â© Zur Freigabe</button>';
                html += '</div>';
            }

            if(v.pipeline_status==='review') {
                html += '<div class="mt-4 pt-4 border-t flex gap-2">';
                html += '<button onclick="vpApproveVideo(\''+v.id+'\')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium">âœ… Freigeben</button>';
                html += '<button onclick="vpRejectVideo(\''+v.id+'\')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition text-sm">âŒ Ablehnen</button>';
                html += '</div>';
            }

            if(v.pipeline_status==='approved') {
                html += '<div class="mt-4 pt-4 border-t"><button onclick="vpManualAdvance(\''+v.id+'\',\'publishing\')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition font-medium">ðŸš€ VerÃ¶ffentlichen</button></div>';
            }

            vpModal(html);
        } catch(e) {
            vpModal('<p class="text-red-600">Fehler: '+e.message+'</p><button onclick="vpCloseModal()" class="mt-4 text-gray-500">SchlieÃŸen</button>');
        }
    };

    // ==================== CONSENTS (Standort) ====================
    window.vpRenderConsents = async function() {
        var c = document.getElementById('vpConsentsContent');
        if(!c) return;
        c.innerHTML = '<div class="flex justify-center py-8"><div class="animate-spin w-8 h-8 border-4 border-vit-orange border-t-transparent rounded-full"></div></div>';

        try {
            var sid = sbStandort?.id;
            var {data:consents,error} = await sb.from('consents').select('*').eq('standort_id',sid).order('created_at',{ascending:false});
            if(error) throw error;
            consents = consents || [];

            var html = '<div class="flex justify-between items-center mb-4"><h3 class="font-semibold text-gray-700">EinverstÃ¤ndniserklÃ¤rungen ('+consents.length+')</h3><button onclick="vpShowConsentForm()" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 transition text-sm font-medium">+ Consent erfassen</button></div>';

            if(consents.length===0) {
                html += '<div class="vit-card p-8 text-center text-gray-400"><div class="text-4xl mb-2">âœ…</div><p>Noch keine EinverstÃ¤ndniserklÃ¤rungen erfasst.</p><p class="text-sm mt-1">Erfasse Consents bevor Videos mit Personen verarbeitet werden.</p></div>';
            } else {
                html += '<div class="vit-card overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="text-left p-3 font-medium text-gray-600">Person</th><th class="text-left p-3 font-medium text-gray-600">Typ</th><th class="text-left p-3 font-medium text-gray-600">GÃ¼ltig ab</th><th class="text-left p-3 font-medium text-gray-600">GÃ¼ltig bis</th><th class="text-left p-3 font-medium text-gray-600">Status</th><th class="text-right p-3 font-medium text-gray-600">Aktion</th></tr></thead><tbody>';
                consents.forEach(function(co){
                    var isActive = !co.revoked_at && (!co.valid_until || new Date(co.valid_until)>=new Date());
                    html += '<tr class="border-t border-gray-100"><td class="p-3 font-medium">'+co.person_name+(co.person_email?' <span class="text-gray-400 text-xs">('+co.person_email+')</span>':'')+'</td>';
                    html += '<td class="p-3 text-gray-600">'+(vpConsentTypeLabels[co.consent_type]||co.consent_type)+'</td>';
                    html += '<td class="p-3 text-gray-500">'+vpDate(co.valid_from)+'</td>';
                    html += '<td class="p-3 text-gray-500">'+(co.valid_until?vpDate(co.valid_until):'Unbefristet')+'</td>';
                    html += '<td class="p-3">'+(isActive?'<span class="text-green-600 font-medium">âœ… Aktiv</span>':co.revoked_at?'<span class="text-red-600 font-medium">ðŸš« Widerrufen</span>':'<span class="text-yellow-600 font-medium">â° Abgelaufen</span>')+'</td>';
                    html += '<td class="p-3 text-right">'+(isActive?'<button onclick="vpRevokeConsent(\''+co.id+'\')" class="text-xs text-red-500 hover:text-red-700">Widerrufen</button>':'')+'</td></tr>';
                });
                html += '</tbody></table></div>';
            }
            c.innerHTML = html;
        } catch(e) {
            c.innerHTML = '<div class="text-red-600 p-4">Fehler: '+e.message+'</div>';
        }
    };

    window.vpShowConsentForm = function() {
        vpModal(
            '<h2 class="text-lg font-bold text-gray-800 mb-4">âœ… Neuen Consent erfassen</h2>' +
            '<div class="space-y-3">' +
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">Name der Person *</label><input id="vpConsentName" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Max Mustermann"></div>' +
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">E-Mail (optional)</label><input id="vpConsentEmail" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="max@example.com"></div>' +
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">Consent-Typ *</label><select id="vpConsentType" class="w-full px-3 py-2 border rounded-lg text-sm"><option value="employee_general">Mitarbeiter (Generell)</option><option value="customer_single">Kunde (Einmalig)</option><option value="customer_general">Kunde (Generell)</option></select></div>' +
            '<div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium text-gray-700 mb-1">GÃ¼ltig ab</label><input type="date" id="vpConsentFrom" class="w-full px-3 py-2 border rounded-lg text-sm" value="'+new Date().toISOString().split('T')[0]+'"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">GÃ¼ltig bis (leer = unbefristet)</label><input type="date" id="vpConsentUntil" class="w-full px-3 py-2 border rounded-lg text-sm"></div></div>' +
            '<div><label class="block text-sm font-medium text-gray-700 mb-1">Notizen</label><textarea id="vpConsentNotes" class="w-full px-3 py-2 border rounded-lg text-sm" rows="2" placeholder="Optional..."></textarea></div></div>' +
            '<div class="flex justify-end gap-2 mt-4"><button onclick="vpCloseModal()" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">Abbrechen</button><button onclick="vpSaveConsent()" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 font-medium">Speichern</button></div>'
        );
    };

    window.vpSaveConsent = async function() {
        var name = document.getElementById('vpConsentName').value.trim();
        if(!name) { alert('Name ist erforderlich.'); return; }
        try {
            var {error} = await sb.from('consents').insert({
                person_name: name,
                person_email: document.getElementById('vpConsentEmail').value.trim()||null,
                standort_id: sbStandort.id,
                consent_type: document.getElementById('vpConsentType').value,
                valid_from: document.getElementById('vpConsentFrom').value,
                valid_until: document.getElementById('vpConsentUntil').value||null,
                notes: document.getElementById('vpConsentNotes').value.trim()||null,
                created_by: sbUser.id
            });
            if(error) throw error;
            vpCloseModal();
            vpRenderConsents();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    window.vpRevokeConsent = async function(id) {
        if(!confirm('Consent wirklich widerrufen?')) return;
        try {
            await sb.from('consents').update({revoked_at:new Date().toISOString()}).eq('id',id);
            vpRenderConsents();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    // ==================== TAGGING ====================
    window.vpShowTagging = async function(videoId) {
        vpModal('<div class="flex justify-center py-8"><div class="animate-spin w-8 h-8 border-4 border-vit-orange border-t-transparent rounded-full"></div></div>');
        try {
            var {data:v} = await sb.from('videos').select('*').eq('id',videoId).single();
            var {data:existingPersons} = await sb.from('video_persons').select('*').eq('video_id',videoId);
            var {data:consents} = await sb.from('consents').select('*').eq('standort_id',v.standort_id).is('revoked_at',null).order('person_name');

            var html = '<div class="flex justify-between items-start mb-4"><h2 class="text-lg font-bold text-gray-800">ðŸ‘¥ Personen taggen: '+v.filename+'</h2><button onclick="vpCloseModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>';
            html += '<div id="vpTaggingList" class="space-y-2 mb-4">';
            if(existingPersons&&existingPersons.length>0) {
                existingPersons.forEach(function(p,i){ html += vpTagRow(i,consents,p); });
            } else { html += vpTagRow(0,consents); }
            html += '</div>';
            html += '<button onclick="vpAddTagRow()" class="text-sm text-vit-orange hover:underline mb-4">+ Weitere Person</button>';
            html += '<div class="flex justify-end gap-2 mt-4 pt-4 border-t"><button onclick="vpCloseModal()" class="px-4 py-2 border rounded-lg text-gray-600">Abbrechen</button><button onclick="vpSaveTagsAndCheck(\''+videoId+'\')" class="px-4 py-2 bg-vit-orange text-white rounded-lg hover:bg-orange-600 font-medium">Speichern & Consent prÃ¼fen</button></div>';
            window._vpTagConsents = consents;
            window._vpTagRowCount = (existingPersons&&existingPersons.length)||1;
            vpModal(html);
        } catch(e) { vpModal('<p class="text-red-600">Fehler: '+e.message+'</p>'); }
    };

    function vpTagRow(idx,consents,existing) {
        var opts = '<option value="">â€“ Consent auswÃ¤hlen â€“</option>';
        if(consents) consents.forEach(function(co){
            var sel = existing&&existing.consent_id===co.id?' selected':'';
            opts += '<option value="'+co.id+'"'+sel+'>'+co.person_name+' ('+vpConsentTypeLabels[co.consent_type]+')</option>';
        });
        return '<div class="flex gap-2 items-center vp-tag-row"><input class="flex-1 px-3 py-2 border rounded-lg text-sm vp-tag-label" placeholder="Name/Beschreibung" value="'+(existing?existing.person_label:'')+'"><select class="flex-1 px-3 py-2 border rounded-lg text-sm vp-tag-consent">'+opts+'</select><label class="flex items-center gap-1 text-xs text-gray-500"><input type="checkbox" class="vp-tag-employee rounded" '+(existing&&existing.is_employee?'checked':'')+'>MA</label></div>';
    }

    window.vpAddTagRow = function() {
        var list = document.getElementById('vpTaggingList');
        if(!list) return;
        var div = document.createElement('div');
        div.innerHTML = vpTagRow(++window._vpTagRowCount, window._vpTagConsents);
        list.appendChild(div.firstChild);
    };

    window.vpSaveTagsAndCheck = async function(videoId) {
        var rows = document.querySelectorAll('.vp-tag-row');
        var tags = [];
        rows.forEach(function(row){
            var label = row.querySelector('.vp-tag-label').value.trim();
            if(!label) return;
            tags.push({ video_id:videoId, person_label:label, consent_id:row.querySelector('.vp-tag-consent').value||null, is_employee:row.querySelector('.vp-tag-employee').checked, tagged_by:sbUser.id });
        });
        if(tags.length===0) { alert('Mindestens eine Person taggen.'); return; }
        try {
            await sb.from('video_persons').delete().eq('video_id',videoId);
            var {error} = await sb.from('video_persons').insert(tags);
            if(error) throw error;
            await sb.from('videos').update({persons_tagged:true}).eq('id',videoId);
            var {data:result} = await sb.rpc('check_video_consent',{p_video_id:videoId});
            var check = result&&result[0]?result[0]:{all_cleared:false};
            if(check.all_cleared) {
                await sb.from('videos').update({pipeline_status:'cutting',consent_cleared:true,pipeline_status_detail:'Alle Consents gÃ¼ltig'}).eq('id',videoId);
                vpCloseModal(); alert('âœ… Alle Consents gÃ¼ltig! Video geht in den Schnitt.');
            } else {
                await sb.from('videos').update({pipeline_status:'consent_blocked',pipeline_status_detail:'Consent fehlt fÃ¼r '+(check.blocked_persons||[]).map(function(p){return p.person}).join(', ')}).eq('id',videoId);
                vpCloseModal(); alert('âš ï¸ Consent fehlt fÃ¼r: '+(check.blocked_persons||[]).map(function(p){return p.person+' ('+p.reason+')'}).join(', '));
            }
            vpRenderPipelineDashboard();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    // ==================== PIPELINE TRIGGERS ====================
    window.vpTriggerAnalysis = async function(videoId) {
        if(!confirm('ðŸ”¬ Video-Analyse starten?\n\nDas Video wird analysiert (Szenen, Personen, Highlights).\nDies kann 1-5 Minuten dauern.')) return;
        try {
            vpModal('<div class="text-center py-8"><div class="animate-spin w-10 h-10 border-4 border-vit-orange border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-gray-600 font-medium">Analyse wird gestartet...</p><p class="text-xs text-gray-400 mt-1">Edge Function: analyze-video</p></div>');
            var {data,error} = await sb.functions.invoke('analyze-video', {
                body: { video_id: videoId }
            });
            if(error) throw error;
            if(data && data.success) {
                var msg = 'âœ… Analyse abgeschlossen!\n\n';
                msg += 'ðŸ‘¥ Personen erkannt: ' + (data.analysis?.persons_detected || 0) + '\n';
                msg += 'ðŸŽ¬ Szenen: ' + (data.analysis?.scenes || 0) + '\n';
                msg += 'â­ Highlights: ' + (data.analysis?.highlights || 0) + '\n';
                msg += 'ðŸ“Š QualitÃ¤t: ' + (data.analysis?.quality_score || 'â€“') + '/100\n';
                msg += 'ðŸ“ Kategorie: ' + (data.analysis?.suggested_category || 'â€“');
                vpCloseModal();
                alert(msg);
            } else {
                throw new Error(data?.error || 'Unbekannter Fehler');
            }
            vpRenderPipelineDashboard();
        } catch(e) {
            vpCloseModal();
            alert('âŒ Analyse fehlgeschlagen: ' + e.message);
            vpRenderPipelineDashboard();
        }
    };

    window.vpTriggerConsent = async function(videoId) {
        try {
            vpModal('<div class="text-center py-8"><div class="animate-spin w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-gray-600 font-medium">Consent wird geprÃ¼ft...</p></div>');
            var {data,error} = await sb.functions.invoke('check-consent', {
                body: { video_id: videoId }
            });
            if(error) throw error;
            vpCloseModal();
            if(data && data.success) {
                if(data.consent_result === 'all_cleared' || data.consent_result === 'auto_cleared') {
                    alert('âœ… Consent OK! ' + (data.cleared||0) + ' Person(en) geprÃ¼ft.\nVideo geht in den Schnitt.');
                } else {
                    var missing = (data.details||[]).filter(function(d){return d.consent_status==='missing';});
                    alert('âš ï¸ Consent fehlt fÃ¼r ' + missing.length + ' Person(en):\n' + missing.map(function(m){return '- ' + m.person_label + ': ' + m.reason;}).join('\n'));
                }
            } else {
                throw new Error(data?.error || 'Unbekannter Fehler');
            }
            vpRenderPipelineDashboard();
        } catch(e) {
            vpCloseModal();
            alert('âŒ Consent-Check fehlgeschlagen: ' + e.message);
        }
    };

    window.vpTriggerReels = async function(videoId) {
        if(!confirm('ðŸŽ¬ Reels generieren?\n\nDas System wÃ¤hlt automatisch das passende Template\nund erstellt Reels basierend auf der Video-Analyse.')) return;
        try {
            vpModal('<div class="text-center py-8"><div class="animate-spin w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-gray-600 font-medium">Reels werden generiert...</p><p class="text-xs text-gray-400 mt-1">Edge Function: generate-reels</p></div>');
            var {data,error} = await sb.functions.invoke('generate-reels', {
                body: { video_id: videoId }
            });
            if(error) throw error;
            vpCloseModal();
            if(data && data.success) {
                var msg = 'âœ… ' + (data.reels?.length||0) + ' Reel(s) generiert!\n\n';
                msg += 'Template: ' + (data.template?.name || 'â€“') + '\n';
                msg += 'Clips: ' + (data.cut_list?.length || 0) + '\n\n';
                msg += 'Das Video steht jetzt zur Freigabe bereit.';
                alert(msg);
            } else {
                throw new Error(data?.error || 'Unbekannter Fehler');
            }
            vpRenderPipelineDashboard();
        } catch(e) {
            vpCloseModal();
            alert('âŒ Reel-Generierung fehlgeschlagen: ' + e.message);
        }
    };

    window.vpApproveVideo = async function(videoId) {
        if(!confirm('âœ… Video freigeben und zur VerÃ¶ffentlichung markieren?')) return;
        try {
            await sb.from('videos').update({
                pipeline_status:'approved',
                pipeline_status_detail:'Freigegeben am '+new Date().toLocaleDateString('de-DE'),
                approved_by:sbUser?.id||null,
                approved_at:new Date().toISOString(),
                updated_at:new Date().toISOString()
            }).eq('id',videoId);
            await sb.from('pipeline_log').insert({
                video_id:videoId, phase:'review', action:'approved',
                actor:sbUser?.id||'unknown', details:{approved_by:sbUser?.name||'â€“'}
            });
            vpCloseModal();
            alert('âœ… Video freigegeben!');
            vpRenderPipelineDashboard();
            if(window.vpRenderHqReview) vpRenderHqReview();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    window.vpRejectVideo = async function(videoId) {
        var reason = prompt('âŒ Grund fÃ¼r Ablehnung:');
        if(!reason) return;
        try {
            await sb.from('videos').update({
                pipeline_status:'rejected',
                pipeline_status_detail:'Abgelehnt: '+reason,
                updated_at:new Date().toISOString()
            }).eq('id',videoId);
            await sb.from('pipeline_log').insert({
                video_id:videoId, phase:'review', action:'rejected',
                actor:sbUser?.id||'unknown', details:{reason:reason}
            });
            vpCloseModal();
            alert('Video abgelehnt.');
            vpRenderPipelineDashboard();
            if(window.vpRenderHqReview) vpRenderHqReview();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    window.vpManualAdvance = async function(videoId, targetStatus) {
        var labels = {analyzing:'Analyse',consent_check:'Consent-Check',cutting:'Schnitt',review:'Freigabe',approved:'Freigegeben',publishing:'VerÃ¶ffentlichung',published:'VerÃ¶ffentlicht'};
        if(!confirm('â© Manuell weiter zu: '+(labels[targetStatus]||targetStatus)+'?')) return;
        try {
            await sb.from('videos').update({
                pipeline_status:targetStatus,
                pipeline_status_detail:'Manuell gesetzt am '+new Date().toLocaleDateString('de-DE'),
                updated_at:new Date().toISOString()
            }).eq('id',videoId);
            await sb.from('pipeline_log').insert({
                video_id:videoId, phase:targetStatus, action:'manual_advance',
                actor:sbUser?.id||'unknown', details:{from:'manual',to:targetStatus}
            });
            vpCloseModal();
            vpRenderPipelineDashboard();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    // ==================== HQ VIDEO-FREIGABE ====================
    window.vpRenderHqReview = async function() {
        var c = document.getElementById('hqVpReviewContent');
        if(!c) return;
        c.innerHTML = '<div class="flex justify-center py-12"><div class="animate-spin w-8 h-8 border-4 border-vit-orange border-t-transparent rounded-full"></div></div>';

        try {
            // HQ sieht Videos ALLER Standorte im Status review
            var {data:videos,error} = await sb.from('videos').select('*, standorte(name)').eq('pipeline_status','review').order('created_at',{ascending:true});
            if(error) throw error;
            videos = videos || [];

            // Also load all that need review but are approved already
            var {data:approved} = await sb.from('videos').select('*, standorte(name)').eq('pipeline_status','approved').order('updated_at',{ascending:false}).limit(10);
            var {data:reels} = await sb.from('reels').select('*').eq('status','generated');

            var html = '';

            // Stats
            html += '<div class="grid grid-cols-3 gap-4 mb-6">';
            html += '<div class="vit-card p-4 text-center '+(videos.length>0?'ring-2 ring-orange-400':'')+'"><div class="text-3xl font-bold text-orange-600">'+videos.length+'</div><div class="text-xs text-gray-500">Warten auf Freigabe</div></div>';
            html += '<div class="vit-card p-4 text-center"><div class="text-3xl font-bold text-green-600">'+(approved||[]).length+'</div><div class="text-xs text-gray-500">KÃ¼rzlich freigegeben</div></div>';
            html += '<div class="vit-card p-4 text-center"><div class="text-3xl font-bold text-blue-600">'+(reels||[]).length+'</div><div class="text-xs text-gray-500">Reels bereit</div></div>';
            html += '</div>';

            if(videos.length===0) {
                html += '<div class="vit-card p-8 text-center text-gray-400"><div class="text-4xl mb-2">âœ…</div><p>Keine Videos warten auf Freigabe.</p></div>';
            } else {
                html += '<div class="space-y-4">';
                videos.forEach(function(v){
                    var standortName = v.standorte?v.standorte.name:'Unbekannt';
                    var videoReels = (reels||[]).filter(function(r){return r.video_id===v.id;});

                    html += '<div class="vit-card p-5">';
                    html += '<div class="flex justify-between items-start mb-3"><div><div class="flex items-center gap-2"><h4 class="font-semibold text-gray-800">'+v.filename+'</h4><span class="text-xs px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full">ðŸ“ '+standortName+'</span></div><p class="text-xs text-gray-500 mt-1">'+(vpCategoryLabels[v.category]||v.category)+' Â· '+vpFileSize(v.file_size_bytes)+' Â· '+vpDateTime(v.created_at)+'</p></div>'+vpBadge('review')+'</div>';

                    if(v.pipeline_status_detail) html += '<div class="mb-3 p-2 bg-gray-50 rounded text-xs text-gray-600">ðŸ’¬ '+v.pipeline_status_detail+'</div>';

                    if(videoReels.length>0) {
                        html += '<div class="space-y-2 mb-3">';
                        videoReels.forEach(function(r){ html += '<div class="p-3 bg-gray-50 rounded-lg text-sm">ðŸŽžï¸ '+(r.caption||'Reel')+' <span class="text-xs text-gray-400">('+r.format+', '+(r.duration_seconds||'?')+'s)</span></div>'; });
                        html += '</div>';
                    }

                    // Checklist
                    html += '<div class="border-t pt-3 mt-3"><p class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wider">PrÃ¼fcheckliste</p>';
                    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm" id="vpChecklist_'+v.id+'">';
                    ['consent_ok:Datenschutz/Consent','legal_ok:Rechtlich ok','brand_ok:Markenkonform','quality_ok:QualitÃ¤t ok','platform_ok:Plattform-Regeln','music_ok:Musik lizenziert'].forEach(function(item){
                        var parts = item.split(':');
                        html += '<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" class="vp-check-item rounded text-vit-orange" data-key="'+parts[0]+'"><span>'+parts[1]+'</span></label>';
                    });
                    html += '</div></div>';

                    html += '<div class="flex gap-2 mt-3 pt-3 border-t">';
                    html += '<button onclick="vpHqApprove(\''+v.id+'\')" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium text-sm">âœ… Freigeben</button>';
                    html += '<button onclick="vpHqReject(\''+v.id+'\')" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium text-sm">âŒ Ablehnen</button>';
                    html += '<button onclick="vpShowVideoDetail(\''+v.id+'\')" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 text-sm">Details</button>';
                    html += '</div></div>';
                });
                html += '</div>';
            }

            // Recently approved
            if(approved && approved.length>0) {
                html += '<div class="mt-6"><h3 class="font-semibold text-gray-700 mb-3">KÃ¼rzlich freigegeben</h3><div class="vit-card overflow-hidden"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="text-left p-3">Video</th><th class="text-left p-3">Standort</th><th class="text-left p-3">Freigegeben</th></tr></thead><tbody>';
                approved.forEach(function(v){
                    html += '<tr class="border-t border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="vpShowVideoDetail(\''+v.id+'\')"><td class="p-3 font-medium">'+v.filename+'</td><td class="p-3 text-gray-500">'+(v.standorte?v.standorte.name:'â€“')+'</td><td class="p-3 text-gray-500">'+vpDateTime(v.updated_at)+'</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }

            c.innerHTML = html;
        } catch(e) {
            c.innerHTML = '<div class="vit-card p-6 text-red-600">Fehler: '+e.message+'</div>';
        }
    };

    window.vpHqApprove = async function(videoId) {
        var checks = {};
        var allChecked = true;
        document.querySelectorAll('#vpChecklist_'+videoId+' .vp-check-item').forEach(function(cb){ checks[cb.dataset.key]=cb.checked; if(!cb.checked) allChecked=false; });
        if(!allChecked && !confirm('Nicht alle PrÃ¼fpunkte abgehakt. Trotzdem freigeben?')) return;
        try {
            await sb.from('videos').update({pipeline_status:'approved',pipeline_status_detail:'Freigegeben von HQ'}).eq('id',videoId);
            await sb.from('review_tasks').update({completed_at:new Date().toISOString(),decision:'approved',checklist:checks}).eq('video_id',videoId).is('completed_at',null);
            await sb.from('reels').update({status:'approved',approved_by:sbUser.id,approved_at:new Date().toISOString()}).eq('video_id',videoId).eq('status','generated');
            vpRenderHqReview();
            vpUpdateHqBadge();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    window.vpHqReject = async function(videoId) {
        var reason = prompt('Ablehnungsgrund:');
        if(reason===null) return;
        try {
            await sb.from('videos').update({pipeline_status:'rejected',pipeline_status_detail:'HQ: '+reason}).eq('id',videoId);
            await sb.from('review_tasks').update({completed_at:new Date().toISOString(),decision:'rejected',checklist:{reason:reason}}).eq('video_id',videoId).is('completed_at',null);
            await sb.from('reels').update({status:'rejected',review_notes:reason}).eq('video_id',videoId).eq('status','generated');
            vpRenderHqReview();
            vpUpdateHqBadge();
        } catch(e) { alert('Fehler: '+e.message); }
    };

    // ==================== BADGE UPDATES ====================
    window.vpUpdateHqBadge = async function() {
        try {
            var {count} = await sb.from('videos').select('*',{count:'exact',head:true}).eq('pipeline_status','review');
            var b = document.getElementById('hqVpReviewBadge');
            if(b) { b.textContent = count||0; b.style.display = count>0?'inline':'none'; }
        } catch(e) {}
    };

    // ==================== REALTIME ====================
    function vpSetupRealtime() {
        sb.channel('video-pipeline-global')
            .on('postgres_changes',{event:'*',schema:'public',table:'videos'}, function(){
                vpUpdateHqBadge();
                // Refresh standort pipeline if visible
                var pipeEl = document.getElementById('smSubPipeline');
                if(pipeEl && pipeEl.style.display!=='none') vpRenderPipelineDashboard();
                // Refresh HQ review if visible
                var hqEl = document.getElementById('hqMktTabVideoFreigabe');
                if(hqEl && hqEl.style.display!=='none') vpRenderHqReview();
            })
            .subscribe();
    }

    // ==================== INIT ====================
    var vpInitInterval = setInterval(function(){
        if(window.sb) {
            clearInterval(vpInitInterval);
            vpUpdateHqBadge();
            vpSetupRealtime();
            setInterval(vpUpdateHqBadge, 60000);
        }
    }, 500);

})();
</script>



<!-- ==================== OFFICE MODUL v4 (VitSpace React) ==================== -->
<!-- Legacy Office v3 replaced by React-based VitSpace Office -->
<!-- Office React component removed - now loaded via /portal/views/office.js -->
<script src="/portal/views/office-admin.js"></script>

<script type="module" src="/portal/app.js"></script>
</body>
</html>
